{"codemirror/LICENSE-codemirror.md":"YGNvZGVtaXJyb3ItZXh0ZW5zaW9ucy5qc2AgaXMgY29weXJpZ2h0IDIwMTgtMjAyMCBieSBBbnRob255IFcuIEh1cnNoLCBhbmQgaXMgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIHNhbWUgTUlUIGxpY2Vuc2UgYXMgRnJvbmtlbnN0ZWVuIGFzIGEgd2hvbGUuCgpUaGUgZm9sbG93aW5nIGZpbGVzIGFyZSBjb3B5cmlnaHQgYnkgTWFyaWpuIEhhdmVyYmVrZSBhbmQgb3RoZXJzLCBhbmQgYXJlIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgZm9sbG93aW5nIE1JVCBsaWNlbnNlLgoKYGBgCmNvZGVtaXJyb3IuanMKY29kZW1pcnJvci5jc3MKY3NzLmpzCmh0bWxtaXhlZC5qcwpqYXZhc2NyaXB0LmpzCm1hcmtkb3duLmpzCm1hdGNoYnJhY2tldHMuanMsc2NoZW1lLmpzCnhtbC5qcyAKYGBgCgpQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5Cm9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsCmluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMKdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbApjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczoKClRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluCmFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgoKVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1IKSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksCkZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRQpBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSCkxJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sCk9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4KVEhFIFNPRlRXQVJFLgo=","codemirror/codemirror.css":"LyogQkFTSUNTICovCgouQ29kZU1pcnJvciB7CiAgLyogU2V0IGhlaWdodCwgd2lkdGgsIGJvcmRlcnMsIGFuZCBnbG9iYWwgZm9udCBwcm9wZXJ0aWVzIGhlcmUgKi8KICBmb250LWZhbWlseTogbW9ub3NwYWNlOwogIGhlaWdodDogMzAwcHg7CiAgY29sb3I6IGJsYWNrOwogIGRpcmVjdGlvbjogbHRyOwp9CgovKiBQQURESU5HICovCgouQ29kZU1pcnJvci1saW5lcyB7CiAgcGFkZGluZzogNHB4IDA7IC8qIFZlcnRpY2FsIHBhZGRpbmcgYXJvdW5kIGNvbnRlbnQgKi8KfQouQ29kZU1pcnJvciBwcmUuQ29kZU1pcnJvci1saW5lLAouQ29kZU1pcnJvciBwcmUuQ29kZU1pcnJvci1saW5lLWxpa2UgewogIHBhZGRpbmc6IDAgNHB4OyAvKiBIb3Jpem9udGFsIHBhZGRpbmcgb2YgY29udGVudCAqLwp9CgouQ29kZU1pcnJvci1zY3JvbGxiYXItZmlsbGVyLCAuQ29kZU1pcnJvci1ndXR0ZXItZmlsbGVyIHsKICBiYWNrZ3JvdW5kLWNvbG9yOiB3aGl0ZTsgLyogVGhlIGxpdHRsZSBzcXVhcmUgYmV0d2VlbiBIIGFuZCBWIHNjcm9sbGJhcnMgKi8KfQoKLyogR1VUVEVSICovCgouQ29kZU1pcnJvci1ndXR0ZXJzIHsKICBib3JkZXItcmlnaHQ6IDFweCBzb2xpZCAjZGRkOwogIGJhY2tncm91bmQtY29sb3I6ICNmN2Y3Zjc7CiAgd2hpdGUtc3BhY2U6IG5vd3JhcDsKfQouQ29kZU1pcnJvci1saW5lbnVtYmVycyB7fQouQ29kZU1pcnJvci1saW5lbnVtYmVyIHsKICBwYWRkaW5nOiAwIDNweCAwIDVweDsKICBtaW4td2lkdGg6IDIwcHg7CiAgdGV4dC1hbGlnbjogcmlnaHQ7CiAgY29sb3I6ICM5OTk7CiAgd2hpdGUtc3BhY2U6IG5vd3JhcDsKfQoKLkNvZGVNaXJyb3ItZ3V0dGVybWFya2VyIHsgY29sb3I6IGJsYWNrOyB9Ci5Db2RlTWlycm9yLWd1dHRlcm1hcmtlci1zdWJ0bGUgeyBjb2xvcjogIzk5OTsgfQoKLyogQ1VSU09SICovCgouQ29kZU1pcnJvci1jdXJzb3IgewogIGJvcmRlci1sZWZ0OiAxcHggc29saWQgYmxhY2s7CiAgYm9yZGVyLXJpZ2h0OiBub25lOwogIHdpZHRoOiAwOwp9Ci8qIFNob3duIHdoZW4gbW92aW5nIGluIGJpLWRpcmVjdGlvbmFsIHRleHQgKi8KLkNvZGVNaXJyb3IgZGl2LkNvZGVNaXJyb3Itc2Vjb25kYXJ5Y3Vyc29yIHsKICBib3JkZXItbGVmdDogMXB4IHNvbGlkIHNpbHZlcjsKfQouY20tZmF0LWN1cnNvciAuQ29kZU1pcnJvci1jdXJzb3IgewogIHdpZHRoOiBhdXRvOwogIGJvcmRlcjogMCAhaW1wb3J0YW50OwogIGJhY2tncm91bmQ6ICM3ZTc7Cn0KLmNtLWZhdC1jdXJzb3IgZGl2LkNvZGVNaXJyb3ItY3Vyc29ycyB7CiAgei1pbmRleDogMTsKfQouY20tZmF0LWN1cnNvci1tYXJrIHsKICBiYWNrZ3JvdW5kLWNvbG9yOiByZ2JhKDIwLCAyNTUsIDIwLCAwLjUpOwogIC13ZWJraXQtYW5pbWF0aW9uOiBibGluayAxLjA2cyBzdGVwcygxKSBpbmZpbml0ZTsKICAtbW96LWFuaW1hdGlvbjogYmxpbmsgMS4wNnMgc3RlcHMoMSkgaW5maW5pdGU7CiAgYW5pbWF0aW9uOiBibGluayAxLjA2cyBzdGVwcygxKSBpbmZpbml0ZTsKfQouY20tYW5pbWF0ZS1mYXQtY3Vyc29yIHsKICB3aWR0aDogYXV0bzsKICBib3JkZXI6IDA7CiAgLXdlYmtpdC1hbmltYXRpb246IGJsaW5rIDEuMDZzIHN0ZXBzKDEpIGluZmluaXRlOwogIC1tb3otYW5pbWF0aW9uOiBibGluayAxLjA2cyBzdGVwcygxKSBpbmZpbml0ZTsKICBhbmltYXRpb246IGJsaW5rIDEuMDZzIHN0ZXBzKDEpIGluZmluaXRlOwogIGJhY2tncm91bmQtY29sb3I6ICM3ZTc7Cn0KQC1tb3ota2V5ZnJhbWVzIGJsaW5rIHsKICAwJSB7fQogIDUwJSB7IGJhY2tncm91bmQtY29sb3I6IHRyYW5zcGFyZW50OyB9CiAgMTAwJSB7fQp9CkAtd2Via2l0LWtleWZyYW1lcyBibGluayB7CiAgMCUge30KICA1MCUgeyBiYWNrZ3JvdW5kLWNvbG9yOiB0cmFuc3BhcmVudDsgfQogIDEwMCUge30KfQpAa2V5ZnJhbWVzIGJsaW5rIHsKICAwJSB7fQogIDUwJSB7IGJhY2tncm91bmQtY29sb3I6IHRyYW5zcGFyZW50OyB9CiAgMTAwJSB7fQp9CgovKiBDYW4gc3R5bGUgY3Vyc29yIGRpZmZlcmVudCBpbiBvdmVyd3JpdGUgKG5vbi1pbnNlcnQpIG1vZGUgKi8KLkNvZGVNaXJyb3Itb3ZlcndyaXRlIC5Db2RlTWlycm9yLWN1cnNvciB7fQoKLmNtLXRhYiB7IGRpc3BsYXk6IGlubGluZS1ibG9jazsgdGV4dC1kZWNvcmF0aW9uOiBpbmhlcml0OyB9CgouQ29kZU1pcnJvci1ydWxlcnMgewogIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICBsZWZ0OiAwOyByaWdodDogMDsgdG9wOiAtNTBweDsgYm90dG9tOiAwOwogIG92ZXJmbG93OiBoaWRkZW47Cn0KLkNvZGVNaXJyb3ItcnVsZXIgewogIGJvcmRlci1sZWZ0OiAxcHggc29saWQgI2NjYzsKICB0b3A6IDA7IGJvdHRvbTogMDsKICBwb3NpdGlvbjogYWJzb2x1dGU7Cn0KCi8qIERFRkFVTFQgVEhFTUUgKi8KCi5jbS1zLWRlZmF1bHQgLmNtLWhlYWRlciB7Y29sb3I6IGJsdWU7fQouY20tcy1kZWZhdWx0IC5jbS1xdW90ZSB7Y29sb3I6ICMwOTA7fQouY20tbmVnYXRpdmUge2NvbG9yOiAjZDQ0O30KLmNtLXBvc2l0aXZlIHtjb2xvcjogIzI5Mjt9Ci5jbS1oZWFkZXIsIC5jbS1zdHJvbmcge2ZvbnQtd2VpZ2h0OiBib2xkO30KLmNtLWVtIHtmb250LXN0eWxlOiBpdGFsaWM7fQouY20tbGluayB7dGV4dC1kZWNvcmF0aW9uOiB1bmRlcmxpbmU7fQouY20tc3RyaWtldGhyb3VnaCB7dGV4dC1kZWNvcmF0aW9uOiBsaW5lLXRocm91Z2g7fQoKLmNtLXMtZGVmYXVsdCAuY20ta2V5d29yZCB7Y29sb3I6ICM3MDg7fQouY20tcy1kZWZhdWx0IC5jbS1hdG9tIHtjb2xvcjogIzIxOTt9Ci5jbS1zLWRlZmF1bHQgLmNtLW51bWJlciB7Y29sb3I6ICMxNjQ7fQouY20tcy1kZWZhdWx0IC5jbS1kZWYge2NvbG9yOiAjMDBmO30KLmNtLXMtZGVmYXVsdCAuY20tdmFyaWFibGUsCi5jbS1zLWRlZmF1bHQgLmNtLXB1bmN0dWF0aW9uLAouY20tcy1kZWZhdWx0IC5jbS1wcm9wZXJ0eSwKLmNtLXMtZGVmYXVsdCAuY20tb3BlcmF0b3Ige30KLmNtLXMtZGVmYXVsdCAuY20tdmFyaWFibGUtMiB7Y29sb3I6ICMwNWE7fQouY20tcy1kZWZhdWx0IC5jbS12YXJpYWJsZS0zLCAuY20tcy1kZWZhdWx0IC5jbS10eXBlIHtjb2xvcjogIzA4NTt9Ci5jbS1zLWRlZmF1bHQgLmNtLWNvbW1lbnQge2NvbG9yOiAjYTUwO30KLmNtLXMtZGVmYXVsdCAuY20tc3RyaW5nIHtjb2xvcjogI2ExMTt9Ci5jbS1zLWRlZmF1bHQgLmNtLXN0cmluZy0yIHtjb2xvcjogI2Y1MDt9Ci5jbS1zLWRlZmF1bHQgLmNtLW1ldGEge2NvbG9yOiAjNTU1O30KLmNtLXMtZGVmYXVsdCAuY20tcXVhbGlmaWVyIHtjb2xvcjogIzU1NTt9Ci5jbS1zLWRlZmF1bHQgLmNtLWJ1aWx0aW4ge2NvbG9yOiAjMzBhO30KLmNtLXMtZGVmYXVsdCAuY20tYnJhY2tldCB7Y29sb3I6ICM5OTc7fQouY20tcy1kZWZhdWx0IC5jbS10YWcge2NvbG9yOiAjMTcwO30KLmNtLXMtZGVmYXVsdCAuY20tYXR0cmlidXRlIHtjb2xvcjogIzAwYzt9Ci5jbS1zLWRlZmF1bHQgLmNtLWhyIHtjb2xvcjogIzk5OTt9Ci5jbS1zLWRlZmF1bHQgLmNtLWxpbmsge2NvbG9yOiAjMDBjO30KCi5jbS1zLWRlZmF1bHQgLmNtLWVycm9yIHtjb2xvcjogI2YwMDt9Ci5jbS1pbnZhbGlkY2hhciB7Y29sb3I6ICNmMDA7fQoKLkNvZGVNaXJyb3ItY29tcG9zaW5nIHsgYm9yZGVyLWJvdHRvbTogMnB4IHNvbGlkOyB9CgovKiBEZWZhdWx0IHN0eWxlcyBmb3IgY29tbW9uIGFkZG9ucyAqLwoKZGl2LkNvZGVNaXJyb3Igc3Bhbi5Db2RlTWlycm9yLW1hdGNoaW5nYnJhY2tldCB7Y29sb3I6ICMwYjA7fQpkaXYuQ29kZU1pcnJvciBzcGFuLkNvZGVNaXJyb3Itbm9ubWF0Y2hpbmdicmFja2V0IHtjb2xvcjogI2EyMjt9Ci5Db2RlTWlycm9yLW1hdGNoaW5ndGFnIHsgYmFja2dyb3VuZDogcmdiYSgyNTUsIDE1MCwgMCwgLjMpOyB9Ci5Db2RlTWlycm9yLWFjdGl2ZWxpbmUtYmFja2dyb3VuZCB7YmFja2dyb3VuZDogI2U4ZjJmZjt9CgovKiBTVE9QICovCgovKiBUaGUgcmVzdCBvZiB0aGlzIGZpbGUgY29udGFpbnMgc3R5bGVzIHJlbGF0ZWQgdG8gdGhlIG1lY2hhbmljcyBvZgogICB0aGUgZWRpdG9yLiBZb3UgcHJvYmFibHkgc2hvdWxkbid0IHRvdWNoIHRoZW0uICovCgouQ29kZU1pcnJvciB7CiAgcG9zaXRpb246IHJlbGF0aXZlOwogIG92ZXJmbG93OiBoaWRkZW47CiAgYmFja2dyb3VuZDogd2hpdGU7Cn0KCi5Db2RlTWlycm9yLXNjcm9sbCB7CiAgb3ZlcmZsb3c6IHNjcm9sbCAhaW1wb3J0YW50OyAvKiBUaGluZ3Mgd2lsbCBicmVhayBpZiB0aGlzIGlzIG92ZXJyaWRkZW4gKi8KICAvKiAzMHB4IGlzIHRoZSBtYWdpYyBtYXJnaW4gdXNlZCB0byBoaWRlIHRoZSBlbGVtZW50J3MgcmVhbCBzY3JvbGxiYXJzICovCiAgLyogU2VlIG92ZXJmbG93OiBoaWRkZW4gaW4gLkNvZGVNaXJyb3IgKi8KICBtYXJnaW4tYm90dG9tOiAtMzBweDsgbWFyZ2luLXJpZ2h0OiAtMzBweDsKICBwYWRkaW5nLWJvdHRvbTogMzBweDsKICBoZWlnaHQ6IDEwMCU7CiAgb3V0bGluZTogbm9uZTsgLyogUHJldmVudCBkcmFnZ2luZyBmcm9tIGhpZ2hsaWdodGluZyB0aGUgZWxlbWVudCAqLwogIHBvc2l0aW9uOiByZWxhdGl2ZTsKfQouQ29kZU1pcnJvci1zaXplciB7CiAgcG9zaXRpb246IHJlbGF0aXZlOwogIGJvcmRlci1yaWdodDogMzBweCBzb2xpZCB0cmFuc3BhcmVudDsKfQoKLyogVGhlIGZha2UsIHZpc2libGUgc2Nyb2xsYmFycy4gVXNlZCB0byBmb3JjZSByZWRyYXcgZHVyaW5nIHNjcm9sbGluZwogICBiZWZvcmUgYWN0dWFsIHNjcm9sbGluZyBoYXBwZW5zLCB0aHVzIHByZXZlbnRpbmcgc2hha2luZyBhbmQKICAgZmxpY2tlcmluZyBhcnRpZmFjdHMuICovCi5Db2RlTWlycm9yLXZzY3JvbGxiYXIsIC5Db2RlTWlycm9yLWhzY3JvbGxiYXIsIC5Db2RlTWlycm9yLXNjcm9sbGJhci1maWxsZXIsIC5Db2RlTWlycm9yLWd1dHRlci1maWxsZXIgewogIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICB6LWluZGV4OiA2OwogIGRpc3BsYXk6IG5vbmU7Cn0KLkNvZGVNaXJyb3ItdnNjcm9sbGJhciB7CiAgcmlnaHQ6IDA7IHRvcDogMDsKICBvdmVyZmxvdy14OiBoaWRkZW47CiAgb3ZlcmZsb3cteTogc2Nyb2xsOwp9Ci5Db2RlTWlycm9yLWhzY3JvbGxiYXIgewogIGJvdHRvbTogMDsgbGVmdDogMDsKICBvdmVyZmxvdy15OiBoaWRkZW47CiAgb3ZlcmZsb3cteDogc2Nyb2xsOwp9Ci5Db2RlTWlycm9yLXNjcm9sbGJhci1maWxsZXIgewogIHJpZ2h0OiAwOyBib3R0b206IDA7Cn0KLkNvZGVNaXJyb3ItZ3V0dGVyLWZpbGxlciB7CiAgbGVmdDogMDsgYm90dG9tOiAwOwp9CgouQ29kZU1pcnJvci1ndXR0ZXJzIHsKICBwb3NpdGlvbjogYWJzb2x1dGU7IGxlZnQ6IDA7IHRvcDogMDsKICBtaW4taGVpZ2h0OiAxMDAlOwogIHotaW5kZXg6IDM7Cn0KLkNvZGVNaXJyb3ItZ3V0dGVyIHsKICB3aGl0ZS1zcGFjZTogbm9ybWFsOwogIGhlaWdodDogMTAwJTsKICBkaXNwbGF5OiBpbmxpbmUtYmxvY2s7CiAgdmVydGljYWwtYWxpZ246IHRvcDsKICBtYXJnaW4tYm90dG9tOiAtMzBweDsKfQouQ29kZU1pcnJvci1ndXR0ZXItd3JhcHBlciB7CiAgcG9zaXRpb246IGFic29sdXRlOwogIHotaW5kZXg6IDQ7CiAgYmFja2dyb3VuZDogbm9uZSAhaW1wb3J0YW50OwogIGJvcmRlcjogbm9uZSAhaW1wb3J0YW50Owp9Ci5Db2RlTWlycm9yLWd1dHRlci1iYWNrZ3JvdW5kIHsKICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgdG9wOiAwOyBib3R0b206IDA7CiAgei1pbmRleDogNDsKfQouQ29kZU1pcnJvci1ndXR0ZXItZWx0IHsKICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgY3Vyc29yOiBkZWZhdWx0OwogIHotaW5kZXg6IDQ7Cn0KLkNvZGVNaXJyb3ItZ3V0dGVyLXdyYXBwZXIgOjpzZWxlY3Rpb24geyBiYWNrZ3JvdW5kLWNvbG9yOiB0cmFuc3BhcmVudCB9Ci5Db2RlTWlycm9yLWd1dHRlci13cmFwcGVyIDo6LW1vei1zZWxlY3Rpb24geyBiYWNrZ3JvdW5kLWNvbG9yOiB0cmFuc3BhcmVudCB9CgouQ29kZU1pcnJvci1saW5lcyB7CiAgY3Vyc29yOiB0ZXh0OwogIG1pbi1oZWlnaHQ6IDFweDsgLyogcHJldmVudHMgY29sbGFwc2luZyBiZWZvcmUgZmlyc3QgZHJhdyAqLwp9Ci5Db2RlTWlycm9yIHByZS5Db2RlTWlycm9yLWxpbmUsCi5Db2RlTWlycm9yIHByZS5Db2RlTWlycm9yLWxpbmUtbGlrZSB7CiAgLyogUmVzZXQgc29tZSBzdHlsZXMgdGhhdCB0aGUgcmVzdCBvZiB0aGUgcGFnZSBtaWdodCBoYXZlIHNldCAqLwogIC1tb3otYm9yZGVyLXJhZGl1czogMDsgLXdlYmtpdC1ib3JkZXItcmFkaXVzOiAwOyBib3JkZXItcmFkaXVzOiAwOwogIGJvcmRlci13aWR0aDogMDsKICBiYWNrZ3JvdW5kOiB0cmFuc3BhcmVudDsKICBmb250LWZhbWlseTogaW5oZXJpdDsKICBmb250LXNpemU6IGluaGVyaXQ7CiAgbWFyZ2luOiAwOwogIHdoaXRlLXNwYWNlOiBwcmU7CiAgd29yZC13cmFwOiBub3JtYWw7CiAgbGluZS1oZWlnaHQ6IGluaGVyaXQ7CiAgY29sb3I6IGluaGVyaXQ7CiAgei1pbmRleDogMjsKICBwb3NpdGlvbjogcmVsYXRpdmU7CiAgb3ZlcmZsb3c6IHZpc2libGU7CiAgLXdlYmtpdC10YXAtaGlnaGxpZ2h0LWNvbG9yOiB0cmFuc3BhcmVudDsKICAtd2Via2l0LWZvbnQtdmFyaWFudC1saWdhdHVyZXM6IGNvbnRleHR1YWw7CiAgZm9udC12YXJpYW50LWxpZ2F0dXJlczogY29udGV4dHVhbDsKfQouQ29kZU1pcnJvci13cmFwIHByZS5Db2RlTWlycm9yLWxpbmUsCi5Db2RlTWlycm9yLXdyYXAgcHJlLkNvZGVNaXJyb3ItbGluZS1saWtlIHsKICB3b3JkLXdyYXA6IGJyZWFrLXdvcmQ7CiAgd2hpdGUtc3BhY2U6IHByZS13cmFwOwogIHdvcmQtYnJlYWs6IG5vcm1hbDsKfQoKLkNvZGVNaXJyb3ItbGluZWJhY2tncm91bmQgewogIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICBsZWZ0OiAwOyByaWdodDogMDsgdG9wOiAwOyBib3R0b206IDA7CiAgei1pbmRleDogMDsKfQoKLkNvZGVNaXJyb3ItbGluZXdpZGdldCB7CiAgcG9zaXRpb246IHJlbGF0aXZlOwogIHotaW5kZXg6IDI7CiAgcGFkZGluZzogMC4xcHg7IC8qIEZvcmNlIHdpZGdldCBtYXJnaW5zIHRvIHN0YXkgaW5zaWRlIG9mIHRoZSBjb250YWluZXIgKi8KfQoKLkNvZGVNaXJyb3Itd2lkZ2V0IHt9CgouQ29kZU1pcnJvci1ydGwgcHJlIHsgZGlyZWN0aW9uOiBydGw7IH0KCi5Db2RlTWlycm9yLWNvZGUgewogIG91dGxpbmU6IG5vbmU7Cn0KCi8qIEZvcmNlIGNvbnRlbnQtYm94IHNpemluZyBmb3IgdGhlIGVsZW1lbnRzIHdoZXJlIHdlIGV4cGVjdCBpdCAqLwouQ29kZU1pcnJvci1zY3JvbGwsCi5Db2RlTWlycm9yLXNpemVyLAouQ29kZU1pcnJvci1ndXR0ZXIsCi5Db2RlTWlycm9yLWd1dHRlcnMsCi5Db2RlTWlycm9yLWxpbmVudW1iZXIgewogIC1tb3otYm94LXNpemluZzogY29udGVudC1ib3g7CiAgYm94LXNpemluZzogY29udGVudC1ib3g7Cn0KCi5Db2RlTWlycm9yLW1lYXN1cmUgewogIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICB3aWR0aDogMTAwJTsKICBoZWlnaHQ6IDA7CiAgb3ZlcmZsb3c6IGhpZGRlbjsKICB2aXNpYmlsaXR5OiBoaWRkZW47Cn0KCi5Db2RlTWlycm9yLWN1cnNvciB7CiAgcG9zaXRpb246IGFic29sdXRlOwogIHBvaW50ZXItZXZlbnRzOiBub25lOwp9Ci5Db2RlTWlycm9yLW1lYXN1cmUgcHJlIHsgcG9zaXRpb246IHN0YXRpYzsgfQoKZGl2LkNvZGVNaXJyb3ItY3Vyc29ycyB7CiAgdmlzaWJpbGl0eTogaGlkZGVuOwogIHBvc2l0aW9uOiByZWxhdGl2ZTsKICB6LWluZGV4OiAzOwp9CmRpdi5Db2RlTWlycm9yLWRyYWdjdXJzb3JzIHsKICB2aXNpYmlsaXR5OiB2aXNpYmxlOwp9CgouQ29kZU1pcnJvci1mb2N1c2VkIGRpdi5Db2RlTWlycm9yLWN1cnNvcnMgewogIHZpc2liaWxpdHk6IHZpc2libGU7Cn0KCi5Db2RlTWlycm9yLXNlbGVjdGVkIHsgYmFja2dyb3VuZDogI2Q5ZDlkOTsgfQouQ29kZU1pcnJvci1mb2N1c2VkIC5Db2RlTWlycm9yLXNlbGVjdGVkIHsgYmFja2dyb3VuZDogI2Q3ZDRmMDsgfQouQ29kZU1pcnJvci1jcm9zc2hhaXIgeyBjdXJzb3I6IGNyb3NzaGFpcjsgfQouQ29kZU1pcnJvci1saW5lOjpzZWxlY3Rpb24sIC5Db2RlTWlycm9yLWxpbmUgPiBzcGFuOjpzZWxlY3Rpb24sIC5Db2RlTWlycm9yLWxpbmUgPiBzcGFuID4gc3Bhbjo6c2VsZWN0aW9uIHsgYmFja2dyb3VuZDogI2Q3ZDRmMDsgfQouQ29kZU1pcnJvci1saW5lOjotbW96LXNlbGVjdGlvbiwgLkNvZGVNaXJyb3ItbGluZSA+IHNwYW46Oi1tb3otc2VsZWN0aW9uLCAuQ29kZU1pcnJvci1saW5lID4gc3BhbiA+IHNwYW46Oi1tb3otc2VsZWN0aW9uIHsgYmFja2dyb3VuZDogI2Q3ZDRmMDsgfQoKLmNtLXNlYXJjaGluZyB7CiAgYmFja2dyb3VuZC1jb2xvcjogI2ZmYTsKICBiYWNrZ3JvdW5kLWNvbG9yOiByZ2JhKDI1NSwgMjU1LCAwLCAuNCk7Cn0KCi8qIFVzZWQgdG8gZm9yY2UgYSBib3JkZXIgbW9kZWwgZm9yIGEgbm9kZSAqLwouY20tZm9yY2UtYm9yZGVyIHsgcGFkZGluZy1yaWdodDogLjFweDsgfQoKQG1lZGlhIHByaW50IHsKICAvKiBIaWRlIHRoZSBjdXJzb3Igd2hlbiBwcmludGluZyAqLwogIC5Db2RlTWlycm9yIGRpdi5Db2RlTWlycm9yLWN1cnNvcnMgewogICAgdmlzaWJpbGl0eTogaGlkZGVuOwogIH0KfQoKLyogU2VlIGlzc3VlICMyOTAxICovCi5jbS10YWItd3JhcC1oYWNrOmFmdGVyIHsgY29udGVudDogJyc7IH0KCi8qIEhlbHAgdXNlcnMgdXNlIG1hcmtzZWxlY3Rpb24gdG8gc2FmZWx5IHN0eWxlIHRleHQgYmFja2dyb3VuZCAqLwpzcGFuLkNvZGVNaXJyb3Itc2VsZWN0ZWR0ZXh0IHsgYmFja2dyb3VuZDogbm9uZTsgfQo=","codemirror/codemirror.js":"Ly8gQ29kZU1pcnJvciwgY29weXJpZ2h0IChjKSBieSBNYXJpam4gSGF2ZXJiZWtlIGFuZCBvdGhlcnMKLy8gRGlzdHJpYnV0ZWQgdW5kZXIgYW4gTUlUIGxpY2Vuc2U6IGh0dHBzOi8vY29kZW1pcnJvci5uZXQvTElDRU5TRQoKLy8gVGhpcyBpcyBDb2RlTWlycm9yIChodHRwczovL2NvZGVtaXJyb3IubmV0KSwgYSBjb2RlIGVkaXRvcgovLyBpbXBsZW1lbnRlZCBpbiBKYXZhU2NyaXB0IG9uIHRvcCBvZiB0aGUgYnJvd3NlcidzIERPTS4KLy8KLy8gWW91IGNhbiBmaW5kIHNvbWUgdGVjaG5pY2FsIGJhY2tncm91bmQgZm9yIHNvbWUgb2YgdGhlIGNvZGUgYmVsb3cKLy8gYXQgaHR0cDovL21hcmlqbmhhdmVyYmVrZS5ubC9ibG9nLyNjbS1pbnRlcm5hbHMgLgoKKGZ1bmN0aW9uIChnbG9iYWwsIGZhY3RvcnkpIHsKICB0eXBlb2YgZXhwb3J0cyA9PT0gJ29iamVjdCcgJiYgdHlwZW9mIG1vZHVsZSAhPT0gJ3VuZGVmaW5lZCcgPyBtb2R1bGUuZXhwb3J0cyA9IGZhY3RvcnkoKSA6CiAgdHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kID8gZGVmaW5lKGZhY3RvcnkpIDoKICAoZ2xvYmFsLkNvZGVNaXJyb3IgPSBmYWN0b3J5KCkpOwp9KHRoaXMsIChmdW5jdGlvbiAoKSB7ICd1c2Ugc3RyaWN0JzsKCiAgLy8gS2x1ZGdlcyBmb3IgYnVncyBhbmQgYmVoYXZpb3IgZGlmZmVyZW5jZXMgdGhhdCBjYW4ndCBiZSBmZWF0dXJlCiAgLy8gZGV0ZWN0ZWQgYXJlIGVuYWJsZWQgYmFzZWQgb24gdXNlckFnZW50IGV0YyBzbmlmZmluZy4KICB2YXIgdXNlckFnZW50ID0gbmF2aWdhdG9yLnVzZXJBZ2VudDsKICB2YXIgcGxhdGZvcm0gPSBuYXZpZ2F0b3IucGxhdGZvcm07CgogIHZhciBnZWNrbyA9IC9nZWNrb1wvXGQvaS50ZXN0KHVzZXJBZ2VudCk7CiAgdmFyIGllX3VwdG8xMCA9IC9NU0lFIFxkLy50ZXN0KHVzZXJBZ2VudCk7CiAgdmFyIGllXzExdXAgPSAvVHJpZGVudFwvKD86WzctOV18XGR7Mix9KVwuLipydjooXGQrKS8uZXhlYyh1c2VyQWdlbnQpOwogIHZhciBlZGdlID0gL0VkZ2VcLyhcZCspLy5leGVjKHVzZXJBZ2VudCk7CiAgdmFyIGllID0gaWVfdXB0bzEwIHx8IGllXzExdXAgfHwgZWRnZTsKICB2YXIgaWVfdmVyc2lvbiA9IGllICYmIChpZV91cHRvMTAgPyBkb2N1bWVudC5kb2N1bWVudE1vZGUgfHwgNiA6ICsoZWRnZSB8fCBpZV8xMXVwKVsxXSk7CiAgdmFyIHdlYmtpdCA9ICFlZGdlICYmIC9XZWJLaXRcLy8udGVzdCh1c2VyQWdlbnQpOwogIHZhciBxdHdlYmtpdCA9IHdlYmtpdCAmJiAvUXRcL1xkK1wuXGQrLy50ZXN0KHVzZXJBZ2VudCk7CiAgdmFyIGNocm9tZSA9ICFlZGdlICYmIC9DaHJvbWVcLy8udGVzdCh1c2VyQWdlbnQpOwogIHZhciBwcmVzdG8gPSAvT3BlcmFcLy8udGVzdCh1c2VyQWdlbnQpOwogIHZhciBzYWZhcmkgPSAvQXBwbGUgQ29tcHV0ZXIvLnRlc3QobmF2aWdhdG9yLnZlbmRvcik7CiAgdmFyIG1hY19nZU1vdW50YWluTGlvbiA9IC9NYWMgT1MgWCAxXGRcRChbOC05XXxcZFxkKVxELy50ZXN0KHVzZXJBZ2VudCk7CiAgdmFyIHBoYW50b20gPSAvUGhhbnRvbUpTLy50ZXN0KHVzZXJBZ2VudCk7CgogIHZhciBpb3MgPSAhZWRnZSAmJiAvQXBwbGVXZWJLaXQvLnRlc3QodXNlckFnZW50KSAmJiAvTW9iaWxlXC9cdysvLnRlc3QodXNlckFnZW50KTsKICB2YXIgYW5kcm9pZCA9IC9BbmRyb2lkLy50ZXN0KHVzZXJBZ2VudCk7CiAgLy8gVGhpcyBpcyB3b2VmdWxseSBpbmNvbXBsZXRlLiBTdWdnZXN0aW9ucyBmb3IgYWx0ZXJuYXRpdmUgbWV0aG9kcyB3ZWxjb21lLgogIHZhciBtb2JpbGUgPSBpb3MgfHwgYW5kcm9pZCB8fCAvd2ViT1N8QmxhY2tCZXJyeXxPcGVyYSBNaW5pfE9wZXJhIE1vYml8SUVNb2JpbGUvaS50ZXN0KHVzZXJBZ2VudCk7CiAgdmFyIG1hYyA9IGlvcyB8fCAvTWFjLy50ZXN0KHBsYXRmb3JtKTsKICB2YXIgY2hyb21lT1MgPSAvXGJDck9TXGIvLnRlc3QodXNlckFnZW50KTsKICB2YXIgd2luZG93cyA9IC93aW4vaS50ZXN0KHBsYXRmb3JtKTsKCiAgdmFyIHByZXN0b192ZXJzaW9uID0gcHJlc3RvICYmIHVzZXJBZ2VudC5tYXRjaCgvVmVyc2lvblwvKFxkKlwuXGQqKS8pOwogIGlmIChwcmVzdG9fdmVyc2lvbikgeyBwcmVzdG9fdmVyc2lvbiA9IE51bWJlcihwcmVzdG9fdmVyc2lvblsxXSk7IH0KICBpZiAocHJlc3RvX3ZlcnNpb24gJiYgcHJlc3RvX3ZlcnNpb24gPj0gMTUpIHsgcHJlc3RvID0gZmFsc2U7IHdlYmtpdCA9IHRydWU7IH0KICAvLyBTb21lIGJyb3dzZXJzIHVzZSB0aGUgd3JvbmcgZXZlbnQgcHJvcGVydGllcyB0byBzaWduYWwgY21kL2N0cmwgb24gT1MgWAogIHZhciBmbGlwQ3RybENtZCA9IG1hYyAmJiAocXR3ZWJraXQgfHwgcHJlc3RvICYmIChwcmVzdG9fdmVyc2lvbiA9PSBudWxsIHx8IHByZXN0b192ZXJzaW9uIDwgMTIuMTEpKTsKICB2YXIgY2FwdHVyZVJpZ2h0Q2xpY2sgPSBnZWNrbyB8fCAoaWUgJiYgaWVfdmVyc2lvbiA+PSA5KTsKCiAgZnVuY3Rpb24gY2xhc3NUZXN0KGNscykgeyByZXR1cm4gbmV3IFJlZ0V4cCgiKF58XFxzKSIgKyBjbHMgKyAiKD86JHxcXHMpXFxzKiIpIH0KCiAgdmFyIHJtQ2xhc3MgPSBmdW5jdGlvbihub2RlLCBjbHMpIHsKICAgIHZhciBjdXJyZW50ID0gbm9kZS5jbGFzc05hbWU7CiAgICB2YXIgbWF0Y2ggPSBjbGFzc1Rlc3QoY2xzKS5leGVjKGN1cnJlbnQpOwogICAgaWYgKG1hdGNoKSB7CiAgICAgIHZhciBhZnRlciA9IGN1cnJlbnQuc2xpY2UobWF0Y2guaW5kZXggKyBtYXRjaFswXS5sZW5ndGgpOwogICAgICBub2RlLmNsYXNzTmFtZSA9IGN1cnJlbnQuc2xpY2UoMCwgbWF0Y2guaW5kZXgpICsgKGFmdGVyID8gbWF0Y2hbMV0gKyBhZnRlciA6ICIiKTsKICAgIH0KICB9OwoKICBmdW5jdGlvbiByZW1vdmVDaGlsZHJlbihlKSB7CiAgICBmb3IgKHZhciBjb3VudCA9IGUuY2hpbGROb2Rlcy5sZW5ndGg7IGNvdW50ID4gMDsgLS1jb3VudCkKICAgICAgeyBlLnJlbW92ZUNoaWxkKGUuZmlyc3RDaGlsZCk7IH0KICAgIHJldHVybiBlCiAgfQoKICBmdW5jdGlvbiByZW1vdmVDaGlsZHJlbkFuZEFkZChwYXJlbnQsIGUpIHsKICAgIHJldHVybiByZW1vdmVDaGlsZHJlbihwYXJlbnQpLmFwcGVuZENoaWxkKGUpCiAgfQoKICBmdW5jdGlvbiBlbHQodGFnLCBjb250ZW50LCBjbGFzc05hbWUsIHN0eWxlKSB7CiAgICB2YXIgZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQodGFnKTsKICAgIGlmIChjbGFzc05hbWUpIHsgZS5jbGFzc05hbWUgPSBjbGFzc05hbWU7IH0KICAgIGlmIChzdHlsZSkgeyBlLnN0eWxlLmNzc1RleHQgPSBzdHlsZTsgfQogICAgaWYgKHR5cGVvZiBjb250ZW50ID09ICJzdHJpbmciKSB7IGUuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoY29udGVudCkpOyB9CiAgICBlbHNlIGlmIChjb250ZW50KSB7IGZvciAodmFyIGkgPSAwOyBpIDwgY29udGVudC5sZW5ndGg7ICsraSkgeyBlLmFwcGVuZENoaWxkKGNvbnRlbnRbaV0pOyB9IH0KICAgIHJldHVybiBlCiAgfQogIC8vIHdyYXBwZXIgZm9yIGVsdCwgd2hpY2ggcmVtb3ZlcyB0aGUgZWx0IGZyb20gdGhlIGFjY2Vzc2liaWxpdHkgdHJlZQogIGZ1bmN0aW9uIGVsdFAodGFnLCBjb250ZW50LCBjbGFzc05hbWUsIHN0eWxlKSB7CiAgICB2YXIgZSA9IGVsdCh0YWcsIGNvbnRlbnQsIGNsYXNzTmFtZSwgc3R5bGUpOwogICAgZS5zZXRBdHRyaWJ1dGUoInJvbGUiLCAicHJlc2VudGF0aW9uIik7CiAgICByZXR1cm4gZQogIH0KCiAgdmFyIHJhbmdlOwogIGlmIChkb2N1bWVudC5jcmVhdGVSYW5nZSkgeyByYW5nZSA9IGZ1bmN0aW9uKG5vZGUsIHN0YXJ0LCBlbmQsIGVuZE5vZGUpIHsKICAgIHZhciByID0gZG9jdW1lbnQuY3JlYXRlUmFuZ2UoKTsKICAgIHIuc2V0RW5kKGVuZE5vZGUgfHwgbm9kZSwgZW5kKTsKICAgIHIuc2V0U3RhcnQobm9kZSwgc3RhcnQpOwogICAgcmV0dXJuIHIKICB9OyB9CiAgZWxzZSB7IHJhbmdlID0gZnVuY3Rpb24obm9kZSwgc3RhcnQsIGVuZCkgewogICAgdmFyIHIgPSBkb2N1bWVudC5ib2R5LmNyZWF0ZVRleHRSYW5nZSgpOwogICAgdHJ5IHsgci5tb3ZlVG9FbGVtZW50VGV4dChub2RlLnBhcmVudE5vZGUpOyB9CiAgICBjYXRjaChlKSB7IHJldHVybiByIH0KICAgIHIuY29sbGFwc2UodHJ1ZSk7CiAgICByLm1vdmVFbmQoImNoYXJhY3RlciIsIGVuZCk7CiAgICByLm1vdmVTdGFydCgiY2hhcmFjdGVyIiwgc3RhcnQpOwogICAgcmV0dXJuIHIKICB9OyB9CgogIGZ1bmN0aW9uIGNvbnRhaW5zKHBhcmVudCwgY2hpbGQpIHsKICAgIGlmIChjaGlsZC5ub2RlVHlwZSA9PSAzKSAvLyBBbmRyb2lkIGJyb3dzZXIgYWx3YXlzIHJldHVybnMgZmFsc2Ugd2hlbiBjaGlsZCBpcyBhIHRleHRub2RlCiAgICAgIHsgY2hpbGQgPSBjaGlsZC5wYXJlbnROb2RlOyB9CiAgICBpZiAocGFyZW50LmNvbnRhaW5zKQogICAgICB7IHJldHVybiBwYXJlbnQuY29udGFpbnMoY2hpbGQpIH0KICAgIGRvIHsKICAgICAgaWYgKGNoaWxkLm5vZGVUeXBlID09IDExKSB7IGNoaWxkID0gY2hpbGQuaG9zdDsgfQogICAgICBpZiAoY2hpbGQgPT0gcGFyZW50KSB7IHJldHVybiB0cnVlIH0KICAgIH0gd2hpbGUgKGNoaWxkID0gY2hpbGQucGFyZW50Tm9kZSkKICB9CgogIGZ1bmN0aW9uIGFjdGl2ZUVsdCgpIHsKICAgIC8vIElFIGFuZCBFZGdlIG1heSB0aHJvdyBhbiAiVW5zcGVjaWZpZWQgRXJyb3IiIHdoZW4gYWNjZXNzaW5nIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQuCiAgICAvLyBJRSA8IDEwIHdpbGwgdGhyb3cgd2hlbiBhY2Nlc3NlZCB3aGlsZSB0aGUgcGFnZSBpcyBsb2FkaW5nIG9yIGluIGFuIGlmcmFtZS4KICAgIC8vIElFID4gOSBhbmQgRWRnZSB3aWxsIHRocm93IHdoZW4gYWNjZXNzZWQgaW4gYW4gaWZyYW1lIGlmIGRvY3VtZW50LmJvZHkgaXMgdW5hdmFpbGFibGUuCiAgICB2YXIgYWN0aXZlRWxlbWVudDsKICAgIHRyeSB7CiAgICAgIGFjdGl2ZUVsZW1lbnQgPSBkb2N1bWVudC5hY3RpdmVFbGVtZW50OwogICAgfSBjYXRjaChlKSB7CiAgICAgIGFjdGl2ZUVsZW1lbnQgPSBkb2N1bWVudC5ib2R5IHx8IG51bGw7CiAgICB9CiAgICB3aGlsZSAoYWN0aXZlRWxlbWVudCAmJiBhY3RpdmVFbGVtZW50LnNoYWRvd1Jvb3QgJiYgYWN0aXZlRWxlbWVudC5zaGFkb3dSb290LmFjdGl2ZUVsZW1lbnQpCiAgICAgIHsgYWN0aXZlRWxlbWVudCA9IGFjdGl2ZUVsZW1lbnQuc2hhZG93Um9vdC5hY3RpdmVFbGVtZW50OyB9CiAgICByZXR1cm4gYWN0aXZlRWxlbWVudAogIH0KCiAgZnVuY3Rpb24gYWRkQ2xhc3Mobm9kZSwgY2xzKSB7CiAgICB2YXIgY3VycmVudCA9IG5vZGUuY2xhc3NOYW1lOwogICAgaWYgKCFjbGFzc1Rlc3QoY2xzKS50ZXN0KGN1cnJlbnQpKSB7IG5vZGUuY2xhc3NOYW1lICs9IChjdXJyZW50ID8gIiAiIDogIiIpICsgY2xzOyB9CiAgfQogIGZ1bmN0aW9uIGpvaW5DbGFzc2VzKGEsIGIpIHsKICAgIHZhciBhcyA9IGEuc3BsaXQoIiAiKTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXMubGVuZ3RoOyBpKyspCiAgICAgIHsgaWYgKGFzW2ldICYmICFjbGFzc1Rlc3QoYXNbaV0pLnRlc3QoYikpIHsgYiArPSAiICIgKyBhc1tpXTsgfSB9CiAgICByZXR1cm4gYgogIH0KCiAgdmFyIHNlbGVjdElucHV0ID0gZnVuY3Rpb24obm9kZSkgeyBub2RlLnNlbGVjdCgpOyB9OwogIGlmIChpb3MpIC8vIE1vYmlsZSBTYWZhcmkgYXBwYXJlbnRseSBoYXMgYSBidWcgd2hlcmUgc2VsZWN0KCkgaXMgYnJva2VuLgogICAgeyBzZWxlY3RJbnB1dCA9IGZ1bmN0aW9uKG5vZGUpIHsgbm9kZS5zZWxlY3Rpb25TdGFydCA9IDA7IG5vZGUuc2VsZWN0aW9uRW5kID0gbm9kZS52YWx1ZS5sZW5ndGg7IH07IH0KICBlbHNlIGlmIChpZSkgLy8gU3VwcHJlc3MgbXlzdGVyaW91cyBJRTEwIGVycm9ycwogICAgeyBzZWxlY3RJbnB1dCA9IGZ1bmN0aW9uKG5vZGUpIHsgdHJ5IHsgbm9kZS5zZWxlY3QoKTsgfSBjYXRjaChfZSkge30gfTsgfQoKICBmdW5jdGlvbiBiaW5kKGYpIHsKICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgIHJldHVybiBmdW5jdGlvbigpe3JldHVybiBmLmFwcGx5KG51bGwsIGFyZ3MpfQogIH0KCiAgZnVuY3Rpb24gY29weU9iaihvYmosIHRhcmdldCwgb3ZlcndyaXRlKSB7CiAgICBpZiAoIXRhcmdldCkgeyB0YXJnZXQgPSB7fTsgfQogICAgZm9yICh2YXIgcHJvcCBpbiBvYmopCiAgICAgIHsgaWYgKG9iai5oYXNPd25Qcm9wZXJ0eShwcm9wKSAmJiAob3ZlcndyaXRlICE9PSBmYWxzZSB8fCAhdGFyZ2V0Lmhhc093blByb3BlcnR5KHByb3ApKSkKICAgICAgICB7IHRhcmdldFtwcm9wXSA9IG9ialtwcm9wXTsgfSB9CiAgICByZXR1cm4gdGFyZ2V0CiAgfQoKICAvLyBDb3VudHMgdGhlIGNvbHVtbiBvZmZzZXQgaW4gYSBzdHJpbmcsIHRha2luZyB0YWJzIGludG8gYWNjb3VudC4KICAvLyBVc2VkIG1vc3RseSB0byBmaW5kIGluZGVudGF0aW9uLgogIGZ1bmN0aW9uIGNvdW50Q29sdW1uKHN0cmluZywgZW5kLCB0YWJTaXplLCBzdGFydEluZGV4LCBzdGFydFZhbHVlKSB7CiAgICBpZiAoZW5kID09IG51bGwpIHsKICAgICAgZW5kID0gc3RyaW5nLnNlYXJjaCgvW15cc1x1MDBhMF0vKTsKICAgICAgaWYgKGVuZCA9PSAtMSkgeyBlbmQgPSBzdHJpbmcubGVuZ3RoOyB9CiAgICB9CiAgICBmb3IgKHZhciBpID0gc3RhcnRJbmRleCB8fCAwLCBuID0gc3RhcnRWYWx1ZSB8fCAwOzspIHsKICAgICAgdmFyIG5leHRUYWIgPSBzdHJpbmcuaW5kZXhPZigiXHQiLCBpKTsKICAgICAgaWYgKG5leHRUYWIgPCAwIHx8IG5leHRUYWIgPj0gZW5kKQogICAgICAgIHsgcmV0dXJuIG4gKyAoZW5kIC0gaSkgfQogICAgICBuICs9IG5leHRUYWIgLSBpOwogICAgICBuICs9IHRhYlNpemUgLSAobiAlIHRhYlNpemUpOwogICAgICBpID0gbmV4dFRhYiArIDE7CiAgICB9CiAgfQoKICB2YXIgRGVsYXllZCA9IGZ1bmN0aW9uKCkge3RoaXMuaWQgPSBudWxsO307CiAgRGVsYXllZC5wcm90b3R5cGUuc2V0ID0gZnVuY3Rpb24gKG1zLCBmKSB7CiAgICBjbGVhclRpbWVvdXQodGhpcy5pZCk7CiAgICB0aGlzLmlkID0gc2V0VGltZW91dChmLCBtcyk7CiAgfTsKCiAgZnVuY3Rpb24gaW5kZXhPZihhcnJheSwgZWx0KSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFycmF5Lmxlbmd0aDsgKytpKQogICAgICB7IGlmIChhcnJheVtpXSA9PSBlbHQpIHsgcmV0dXJuIGkgfSB9CiAgICByZXR1cm4gLTEKICB9CgogIC8vIE51bWJlciBvZiBwaXhlbHMgYWRkZWQgdG8gc2Nyb2xsZXIgYW5kIHNpemVyIHRvIGhpZGUgc2Nyb2xsYmFyCiAgdmFyIHNjcm9sbGVyR2FwID0gMzA7CgogIC8vIFJldHVybmVkIG9yIHRocm93biBieSB2YXJpb3VzIHByb3RvY29scyB0byBzaWduYWwgJ0knbSBub3QKICAvLyBoYW5kbGluZyB0aGlzJy4KICB2YXIgUGFzcyA9IHt0b1N0cmluZzogZnVuY3Rpb24oKXtyZXR1cm4gIkNvZGVNaXJyb3IuUGFzcyJ9fTsKCiAgLy8gUmV1c2VkIG9wdGlvbiBvYmplY3RzIGZvciBzZXRTZWxlY3Rpb24gJiBmcmllbmRzCiAgdmFyIHNlbF9kb250U2Nyb2xsID0ge3Njcm9sbDogZmFsc2V9LCBzZWxfbW91c2UgPSB7b3JpZ2luOiAiKm1vdXNlIn0sIHNlbF9tb3ZlID0ge29yaWdpbjogIittb3ZlIn07CgogIC8vIFRoZSBpbnZlcnNlIG9mIGNvdW50Q29sdW1uIC0tIGZpbmQgdGhlIG9mZnNldCB0aGF0IGNvcnJlc3BvbmRzIHRvCiAgLy8gYSBwYXJ0aWN1bGFyIGNvbHVtbi4KICBmdW5jdGlvbiBmaW5kQ29sdW1uKHN0cmluZywgZ29hbCwgdGFiU2l6ZSkgewogICAgZm9yICh2YXIgcG9zID0gMCwgY29sID0gMDs7KSB7CiAgICAgIHZhciBuZXh0VGFiID0gc3RyaW5nLmluZGV4T2YoIlx0IiwgcG9zKTsKICAgICAgaWYgKG5leHRUYWIgPT0gLTEpIHsgbmV4dFRhYiA9IHN0cmluZy5sZW5ndGg7IH0KICAgICAgdmFyIHNraXBwZWQgPSBuZXh0VGFiIC0gcG9zOwogICAgICBpZiAobmV4dFRhYiA9PSBzdHJpbmcubGVuZ3RoIHx8IGNvbCArIHNraXBwZWQgPj0gZ29hbCkKICAgICAgICB7IHJldHVybiBwb3MgKyBNYXRoLm1pbihza2lwcGVkLCBnb2FsIC0gY29sKSB9CiAgICAgIGNvbCArPSBuZXh0VGFiIC0gcG9zOwogICAgICBjb2wgKz0gdGFiU2l6ZSAtIChjb2wgJSB0YWJTaXplKTsKICAgICAgcG9zID0gbmV4dFRhYiArIDE7CiAgICAgIGlmIChjb2wgPj0gZ29hbCkgeyByZXR1cm4gcG9zIH0KICAgIH0KICB9CgogIHZhciBzcGFjZVN0cnMgPSBbIiJdOwogIGZ1bmN0aW9uIHNwYWNlU3RyKG4pIHsKICAgIHdoaWxlIChzcGFjZVN0cnMubGVuZ3RoIDw9IG4pCiAgICAgIHsgc3BhY2VTdHJzLnB1c2gobHN0KHNwYWNlU3RycykgKyAiICIpOyB9CiAgICByZXR1cm4gc3BhY2VTdHJzW25dCiAgfQoKICBmdW5jdGlvbiBsc3QoYXJyKSB7IHJldHVybiBhcnJbYXJyLmxlbmd0aC0xXSB9CgogIGZ1bmN0aW9uIG1hcChhcnJheSwgZikgewogICAgdmFyIG91dCA9IFtdOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcnJheS5sZW5ndGg7IGkrKykgeyBvdXRbaV0gPSBmKGFycmF5W2ldLCBpKTsgfQogICAgcmV0dXJuIG91dAogIH0KCiAgZnVuY3Rpb24gaW5zZXJ0U29ydGVkKGFycmF5LCB2YWx1ZSwgc2NvcmUpIHsKICAgIHZhciBwb3MgPSAwLCBwcmlvcml0eSA9IHNjb3JlKHZhbHVlKTsKICAgIHdoaWxlIChwb3MgPCBhcnJheS5sZW5ndGggJiYgc2NvcmUoYXJyYXlbcG9zXSkgPD0gcHJpb3JpdHkpIHsgcG9zKys7IH0KICAgIGFycmF5LnNwbGljZShwb3MsIDAsIHZhbHVlKTsKICB9CgogIGZ1bmN0aW9uIG5vdGhpbmcoKSB7fQoKICBmdW5jdGlvbiBjcmVhdGVPYmooYmFzZSwgcHJvcHMpIHsKICAgIHZhciBpbnN0OwogICAgaWYgKE9iamVjdC5jcmVhdGUpIHsKICAgICAgaW5zdCA9IE9iamVjdC5jcmVhdGUoYmFzZSk7CiAgICB9IGVsc2UgewogICAgICBub3RoaW5nLnByb3RvdHlwZSA9IGJhc2U7CiAgICAgIGluc3QgPSBuZXcgbm90aGluZygpOwogICAgfQogICAgaWYgKHByb3BzKSB7IGNvcHlPYmoocHJvcHMsIGluc3QpOyB9CiAgICByZXR1cm4gaW5zdAogIH0KCiAgdmFyIG5vbkFTQ0lJU2luZ2xlQ2FzZVdvcmRDaGFyID0gL1tcdTAwZGZcdTA1ODdcdTA1OTAtXHUwNWY0XHUwNjAwLVx1MDZmZlx1MzA0MC1cdTMwOWZcdTMwYTAtXHUzMGZmXHUzNDAwLVx1NGRiNVx1NGUwMC1cdTlmY2NcdWFjMDAtXHVkN2FmXS87CiAgZnVuY3Rpb24gaXNXb3JkQ2hhckJhc2ljKGNoKSB7CiAgICByZXR1cm4gL1x3Ly50ZXN0KGNoKSB8fCBjaCA+ICJceDgwIiAmJgogICAgICAoY2gudG9VcHBlckNhc2UoKSAhPSBjaC50b0xvd2VyQ2FzZSgpIHx8IG5vbkFTQ0lJU2luZ2xlQ2FzZVdvcmRDaGFyLnRlc3QoY2gpKQogIH0KICBmdW5jdGlvbiBpc1dvcmRDaGFyKGNoLCBoZWxwZXIpIHsKICAgIGlmICghaGVscGVyKSB7IHJldHVybiBpc1dvcmRDaGFyQmFzaWMoY2gpIH0KICAgIGlmIChoZWxwZXIuc291cmNlLmluZGV4T2YoIlxcdyIpID4gLTEgJiYgaXNXb3JkQ2hhckJhc2ljKGNoKSkgeyByZXR1cm4gdHJ1ZSB9CiAgICByZXR1cm4gaGVscGVyLnRlc3QoY2gpCiAgfQoKICBmdW5jdGlvbiBpc0VtcHR5KG9iaikgewogICAgZm9yICh2YXIgbiBpbiBvYmopIHsgaWYgKG9iai5oYXNPd25Qcm9wZXJ0eShuKSAmJiBvYmpbbl0pIHsgcmV0dXJuIGZhbHNlIH0gfQogICAgcmV0dXJuIHRydWUKICB9CgogIC8vIEV4dGVuZGluZyB1bmljb2RlIGNoYXJhY3RlcnMuIEEgc2VyaWVzIG9mIGEgbm9uLWV4dGVuZGluZyBjaGFyICsKICAvLyBhbnkgbnVtYmVyIG9mIGV4dGVuZGluZyBjaGFycyBpcyB0cmVhdGVkIGFzIGEgc2luZ2xlIHVuaXQgYXMgZmFyCiAgLy8gYXMgZWRpdGluZyBhbmQgbWVhc3VyaW5nIGlzIGNvbmNlcm5lZC4gVGhpcyBpcyBub3QgZnVsbHkgY29ycmVjdCwKICAvLyBzaW5jZSBzb21lIHNjcmlwdHMvZm9udHMvYnJvd3NlcnMgYWxzbyB0cmVhdCBvdGhlciBjb25maWd1cmF0aW9ucwogIC8vIG9mIGNvZGUgcG9pbnRzIGFzIGEgZ3JvdXAuCiAgdmFyIGV4dGVuZGluZ0NoYXJzID0gL1tcdTAzMDAtXHUwMzZmXHUwNDgzLVx1MDQ4OVx1MDU5MS1cdTA1YmRcdTA1YmZcdTA1YzFcdTA1YzJcdTA1YzRcdTA1YzVcdTA1YzdcdTA2MTAtXHUwNjFhXHUwNjRiLVx1MDY1ZVx1MDY3MFx1MDZkNi1cdTA2ZGNcdTA2ZGUtXHUwNmU0XHUwNmU3XHUwNmU4XHUwNmVhLVx1MDZlZFx1MDcxMVx1MDczMC1cdTA3NGFcdTA3YTYtXHUwN2IwXHUwN2ViLVx1MDdmM1x1MDgxNi1cdTA4MTlcdTA4MWItXHUwODIzXHUwODI1LVx1MDgyN1x1MDgyOS1cdTA4MmRcdTA5MDAtXHUwOTAyXHUwOTNjXHUwOTQxLVx1MDk0OFx1MDk0ZFx1MDk1MS1cdTA5NTVcdTA5NjJcdTA5NjNcdTA5ODFcdTA5YmNcdTA5YmVcdTA5YzEtXHUwOWM0XHUwOWNkXHUwOWQ3XHUwOWUyXHUwOWUzXHUwYTAxXHUwYTAyXHUwYTNjXHUwYTQxXHUwYTQyXHUwYTQ3XHUwYTQ4XHUwYTRiLVx1MGE0ZFx1MGE1MVx1MGE3MFx1MGE3MVx1MGE3NVx1MGE4MVx1MGE4Mlx1MGFiY1x1MGFjMS1cdTBhYzVcdTBhYzdcdTBhYzhcdTBhY2RcdTBhZTJcdTBhZTNcdTBiMDFcdTBiM2NcdTBiM2VcdTBiM2ZcdTBiNDEtXHUwYjQ0XHUwYjRkXHUwYjU2XHUwYjU3XHUwYjYyXHUwYjYzXHUwYjgyXHUwYmJlXHUwYmMwXHUwYmNkXHUwYmQ3XHUwYzNlLVx1MGM0MFx1MGM0Ni1cdTBjNDhcdTBjNGEtXHUwYzRkXHUwYzU1XHUwYzU2XHUwYzYyXHUwYzYzXHUwY2JjXHUwY2JmXHUwY2MyXHUwY2M2XHUwY2NjXHUwY2NkXHUwY2Q1XHUwY2Q2XHUwY2UyXHUwY2UzXHUwZDNlXHUwZDQxLVx1MGQ0NFx1MGQ0ZFx1MGQ1N1x1MGQ2Mlx1MGQ2M1x1MGRjYVx1MGRjZlx1MGRkMi1cdTBkZDRcdTBkZDZcdTBkZGZcdTBlMzFcdTBlMzQtXHUwZTNhXHUwZTQ3LVx1MGU0ZVx1MGViMVx1MGViNC1cdTBlYjlcdTBlYmJcdTBlYmNcdTBlYzgtXHUwZWNkXHUwZjE4XHUwZjE5XHUwZjM1XHUwZjM3XHUwZjM5XHUwZjcxLVx1MGY3ZVx1MGY4MC1cdTBmODRcdTBmODZcdTBmODdcdTBmOTAtXHUwZjk3XHUwZjk5LVx1MGZiY1x1MGZjNlx1MTAyZC1cdTEwMzBcdTEwMzItXHUxMDM3XHUxMDM5XHUxMDNhXHUxMDNkXHUxMDNlXHUxMDU4XHUxMDU5XHUxMDVlLVx1MTA2MFx1MTA3MS1cdTEwNzRcdTEwODJcdTEwODVcdTEwODZcdTEwOGRcdTEwOWRcdTEzNWZcdTE3MTItXHUxNzE0XHUxNzMyLVx1MTczNFx1MTc1Mlx1MTc1M1x1MTc3Mlx1MTc3M1x1MTdiNy1cdTE3YmRcdTE3YzZcdTE3YzktXHUxN2QzXHUxN2RkXHUxODBiLVx1MTgwZFx1MThhOVx1MTkyMC1cdTE5MjJcdTE5MjdcdTE5MjhcdTE5MzJcdTE5MzktXHUxOTNiXHUxYTE3XHUxYTE4XHUxYTU2XHUxYTU4LVx1MWE1ZVx1MWE2MFx1MWE2Mlx1MWE2NS1cdTFhNmNcdTFhNzMtXHUxYTdjXHUxYTdmXHUxYjAwLVx1MWIwM1x1MWIzNFx1MWIzNi1cdTFiM2FcdTFiM2NcdTFiNDJcdTFiNmItXHUxYjczXHUxYjgwXHUxYjgxXHUxYmEyLVx1MWJhNVx1MWJhOFx1MWJhOVx1MWMyYy1cdTFjMzNcdTFjMzZcdTFjMzdcdTFjZDAtXHUxY2QyXHUxY2Q0LVx1MWNlMFx1MWNlMi1cdTFjZThcdTFjZWRcdTFkYzAtXHUxZGU2XHUxZGZkLVx1MWRmZlx1MjAwY1x1MjAwZFx1MjBkMC1cdTIwZjBcdTJjZWYtXHUyY2YxXHUyZGUwLVx1MmRmZlx1MzAyYS1cdTMwMmZcdTMwOTlcdTMwOWFcdWE2NmYtXHVhNjcyXHVhNjdjXHVhNjdkXHVhNmYwXHVhNmYxXHVhODAyXHVhODA2XHVhODBiXHVhODI1XHVhODI2XHVhOGM0XHVhOGUwLVx1YThmMVx1YTkyNi1cdWE5MmRcdWE5NDctXHVhOTUxXHVhOTgwLVx1YTk4Mlx1YTliM1x1YTliNi1cdWE5YjlcdWE5YmNcdWFhMjktXHVhYTJlXHVhYTMxXHVhYTMyXHVhYTM1XHVhYTM2XHVhYTQzXHVhYTRjXHVhYWIwXHVhYWIyLVx1YWFiNFx1YWFiN1x1YWFiOFx1YWFiZVx1YWFiZlx1YWFjMVx1YWJlNVx1YWJlOFx1YWJlZFx1ZGMwMC1cdWRmZmZcdWZiMWVcdWZlMDAtXHVmZTBmXHVmZTIwLVx1ZmUyNlx1ZmY5ZVx1ZmY5Zl0vOwogIGZ1bmN0aW9uIGlzRXh0ZW5kaW5nQ2hhcihjaCkgeyByZXR1cm4gY2guY2hhckNvZGVBdCgwKSA+PSA3NjggJiYgZXh0ZW5kaW5nQ2hhcnMudGVzdChjaCkgfQoKICAvLyBSZXR1cm5zIGEgbnVtYmVyIGZyb20gdGhlIHJhbmdlIFtgMGA7IGBzdHIubGVuZ3RoYF0gdW5sZXNzIGBwb3NgIGlzIG91dHNpZGUgdGhhdCByYW5nZS4KICBmdW5jdGlvbiBza2lwRXh0ZW5kaW5nQ2hhcnMoc3RyLCBwb3MsIGRpcikgewogICAgd2hpbGUgKChkaXIgPCAwID8gcG9zID4gMCA6IHBvcyA8IHN0ci5sZW5ndGgpICYmIGlzRXh0ZW5kaW5nQ2hhcihzdHIuY2hhckF0KHBvcykpKSB7IHBvcyArPSBkaXI7IH0KICAgIHJldHVybiBwb3MKICB9CgogIC8vIFJldHVybnMgdGhlIHZhbHVlIGZyb20gdGhlIHJhbmdlIFtgZnJvbWA7IGB0b2BdIHRoYXQgc2F0aXNmaWVzCiAgLy8gYHByZWRgIGFuZCBpcyBjbG9zZXN0IHRvIGBmcm9tYC4gQXNzdW1lcyB0aGF0IGF0IGxlYXN0IGB0b2AKICAvLyBzYXRpc2ZpZXMgYHByZWRgLiBTdXBwb3J0cyBgZnJvbWAgYmVpbmcgZ3JlYXRlciB0aGFuIGB0b2AuCiAgZnVuY3Rpb24gZmluZEZpcnN0KHByZWQsIGZyb20sIHRvKSB7CiAgICAvLyBBdCBhbnkgcG9pbnQgd2UgYXJlIGNlcnRhaW4gYHRvYCBzYXRpc2ZpZXMgYHByZWRgLCBkb24ndCBrbm93CiAgICAvLyB3aGV0aGVyIGBmcm9tYCBkb2VzLgogICAgdmFyIGRpciA9IGZyb20gPiB0byA/IC0xIDogMTsKICAgIGZvciAoOzspIHsKICAgICAgaWYgKGZyb20gPT0gdG8pIHsgcmV0dXJuIGZyb20gfQogICAgICB2YXIgbWlkRiA9IChmcm9tICsgdG8pIC8gMiwgbWlkID0gZGlyIDwgMCA/IE1hdGguY2VpbChtaWRGKSA6IE1hdGguZmxvb3IobWlkRik7CiAgICAgIGlmIChtaWQgPT0gZnJvbSkgeyByZXR1cm4gcHJlZChtaWQpID8gZnJvbSA6IHRvIH0KICAgICAgaWYgKHByZWQobWlkKSkgeyB0byA9IG1pZDsgfQogICAgICBlbHNlIHsgZnJvbSA9IG1pZCArIGRpcjsgfQogICAgfQogIH0KCiAgLy8gQklESSBIRUxQRVJTCgogIGZ1bmN0aW9uIGl0ZXJhdGVCaWRpU2VjdGlvbnMob3JkZXIsIGZyb20sIHRvLCBmKSB7CiAgICBpZiAoIW9yZGVyKSB7IHJldHVybiBmKGZyb20sIHRvLCAibHRyIiwgMCkgfQogICAgdmFyIGZvdW5kID0gZmFsc2U7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IG9yZGVyLmxlbmd0aDsgKytpKSB7CiAgICAgIHZhciBwYXJ0ID0gb3JkZXJbaV07CiAgICAgIGlmIChwYXJ0LmZyb20gPCB0byAmJiBwYXJ0LnRvID4gZnJvbSB8fCBmcm9tID09IHRvICYmIHBhcnQudG8gPT0gZnJvbSkgewogICAgICAgIGYoTWF0aC5tYXgocGFydC5mcm9tLCBmcm9tKSwgTWF0aC5taW4ocGFydC50bywgdG8pLCBwYXJ0LmxldmVsID09IDEgPyAicnRsIiA6ICJsdHIiLCBpKTsKICAgICAgICBmb3VuZCA9IHRydWU7CiAgICAgIH0KICAgIH0KICAgIGlmICghZm91bmQpIHsgZihmcm9tLCB0bywgImx0ciIpOyB9CiAgfQoKICB2YXIgYmlkaU90aGVyID0gbnVsbDsKICBmdW5jdGlvbiBnZXRCaWRpUGFydEF0KG9yZGVyLCBjaCwgc3RpY2t5KSB7CiAgICB2YXIgZm91bmQ7CiAgICBiaWRpT3RoZXIgPSBudWxsOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBvcmRlci5sZW5ndGg7ICsraSkgewogICAgICB2YXIgY3VyID0gb3JkZXJbaV07CiAgICAgIGlmIChjdXIuZnJvbSA8IGNoICYmIGN1ci50byA+IGNoKSB7IHJldHVybiBpIH0KICAgICAgaWYgKGN1ci50byA9PSBjaCkgewogICAgICAgIGlmIChjdXIuZnJvbSAhPSBjdXIudG8gJiYgc3RpY2t5ID09ICJiZWZvcmUiKSB7IGZvdW5kID0gaTsgfQogICAgICAgIGVsc2UgeyBiaWRpT3RoZXIgPSBpOyB9CiAgICAgIH0KICAgICAgaWYgKGN1ci5mcm9tID09IGNoKSB7CiAgICAgICAgaWYgKGN1ci5mcm9tICE9IGN1ci50byAmJiBzdGlja3kgIT0gImJlZm9yZSIpIHsgZm91bmQgPSBpOyB9CiAgICAgICAgZWxzZSB7IGJpZGlPdGhlciA9IGk7IH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIGZvdW5kICE9IG51bGwgPyBmb3VuZCA6IGJpZGlPdGhlcgogIH0KCiAgLy8gQmlkaXJlY3Rpb25hbCBvcmRlcmluZyBhbGdvcml0aG0KICAvLyBTZWUgaHR0cDovL3VuaWNvZGUub3JnL3JlcG9ydHMvdHI5L3RyOS0xMy5odG1sIGZvciB0aGUgYWxnb3JpdGhtCiAgLy8gdGhhdCB0aGlzIChwYXJ0aWFsbHkpIGltcGxlbWVudHMuCgogIC8vIE9uZS1jaGFyIGNvZGVzIHVzZWQgZm9yIGNoYXJhY3RlciB0eXBlczoKICAvLyBMIChMKTogICBMZWZ0LXRvLVJpZ2h0CiAgLy8gUiAoUik6ICAgUmlnaHQtdG8tTGVmdAogIC8vIHIgKEFMKTogIFJpZ2h0LXRvLUxlZnQgQXJhYmljCiAgLy8gMSAoRU4pOiAgRXVyb3BlYW4gTnVtYmVyCiAgLy8gKyAoRVMpOiAgRXVyb3BlYW4gTnVtYmVyIFNlcGFyYXRvcgogIC8vICUgKEVUKTogIEV1cm9wZWFuIE51bWJlciBUZXJtaW5hdG9yCiAgLy8gbiAoQU4pOiAgQXJhYmljIE51bWJlcgogIC8vICwgKENTKTogIENvbW1vbiBOdW1iZXIgU2VwYXJhdG9yCiAgLy8gbSAoTlNNKTogTm9uLVNwYWNpbmcgTWFyawogIC8vIGIgKEJOKTogIEJvdW5kYXJ5IE5ldXRyYWwKICAvLyBzIChCKTogICBQYXJhZ3JhcGggU2VwYXJhdG9yCiAgLy8gdCAoUyk6ICAgU2VnbWVudCBTZXBhcmF0b3IKICAvLyB3IChXUyk6ICBXaGl0ZXNwYWNlCiAgLy8gTiAoT04pOiAgT3RoZXIgTmV1dHJhbHMKCiAgLy8gUmV0dXJucyBudWxsIGlmIGNoYXJhY3RlcnMgYXJlIG9yZGVyZWQgYXMgdGhleSBhcHBlYXIKICAvLyAobGVmdC10by1yaWdodCksIG9yIGFuIGFycmF5IG9mIHNlY3Rpb25zICh7ZnJvbSwgdG8sIGxldmVsfQogIC8vIG9iamVjdHMpIGluIHRoZSBvcmRlciBpbiB3aGljaCB0aGV5IG9jY3VyIHZpc3VhbGx5LgogIHZhciBiaWRpT3JkZXJpbmcgPSAoZnVuY3Rpb24oKSB7CiAgICAvLyBDaGFyYWN0ZXIgdHlwZXMgZm9yIGNvZGVwb2ludHMgMCB0byAweGZmCiAgICB2YXIgbG93VHlwZXMgPSAiYmJiYmJiYmJidHN0d3NiYmJiYmJiYmJiYmJiYnNzc3R3Tk4lJSVOTk5OTk4sTixOMTExMTExMTExMU5OTk5OTk5MTExMTExMTExMTExMTExMTExMTExMTExMTE5OTk5OTkxMTExMTExMTExMTExMTExMTExMTExMTExMTk5OTmJiYmJiYnNiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYixOJSUlJU5OTk5MTk5OTk4lJTExTkxOTk4xTE5OTk5OTExMTExMTExMTExMTExMTExMTExMTExOTExMTExMTExMTExMTExMTExMTExMTExMTExMTExMTE4iOwogICAgLy8gQ2hhcmFjdGVyIHR5cGVzIGZvciBjb2RlcG9pbnRzIDB4NjAwIHRvIDB4NmY5CiAgICB2YXIgYXJhYmljVHlwZXMgPSAibm5ubm5uTk5yJSVyLHJOTm1tbW1tbW1tbW1tcnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJybW1tbW1tbW1tbW1tbW1tbW1tbW1tbm5ubm5ubm5ubiVubnJycm1ycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycnJycm1tbW1tbW1uTm1tbW1tbXJybW1ObW1tbXJyMTExMTExMTExMSI7CiAgICBmdW5jdGlvbiBjaGFyVHlwZShjb2RlKSB7CiAgICAgIGlmIChjb2RlIDw9IDB4ZjcpIHsgcmV0dXJuIGxvd1R5cGVzLmNoYXJBdChjb2RlKSB9CiAgICAgIGVsc2UgaWYgKDB4NTkwIDw9IGNvZGUgJiYgY29kZSA8PSAweDVmNCkgeyByZXR1cm4gIlIiIH0KICAgICAgZWxzZSBpZiAoMHg2MDAgPD0gY29kZSAmJiBjb2RlIDw9IDB4NmY5KSB7IHJldHVybiBhcmFiaWNUeXBlcy5jaGFyQXQoY29kZSAtIDB4NjAwKSB9CiAgICAgIGVsc2UgaWYgKDB4NmVlIDw9IGNvZGUgJiYgY29kZSA8PSAweDhhYykgeyByZXR1cm4gInIiIH0KICAgICAgZWxzZSBpZiAoMHgyMDAwIDw9IGNvZGUgJiYgY29kZSA8PSAweDIwMGIpIHsgcmV0dXJuICJ3IiB9CiAgICAgIGVsc2UgaWYgKGNvZGUgPT0gMHgyMDBjKSB7IHJldHVybiAiYiIgfQogICAgICBlbHNlIHsgcmV0dXJuICJMIiB9CiAgICB9CgogICAgdmFyIGJpZGlSRSA9IC9bXHUwNTkwLVx1MDVmNFx1MDYwMC1cdTA2ZmZcdTA3MDAtXHUwOGFjXS87CiAgICB2YXIgaXNOZXV0cmFsID0gL1tzdHdOXS8sIGlzU3Ryb25nID0gL1tMUnJdLywgY291bnRzQXNMZWZ0ID0gL1tMYjFuXS8sIGNvdW50c0FzTnVtID0gL1sxbl0vOwoKICAgIGZ1bmN0aW9uIEJpZGlTcGFuKGxldmVsLCBmcm9tLCB0bykgewogICAgICB0aGlzLmxldmVsID0gbGV2ZWw7CiAgICAgIHRoaXMuZnJvbSA9IGZyb207IHRoaXMudG8gPSB0bzsKICAgIH0KCiAgICByZXR1cm4gZnVuY3Rpb24oc3RyLCBkaXJlY3Rpb24pIHsKICAgICAgdmFyIG91dGVyVHlwZSA9IGRpcmVjdGlvbiA9PSAibHRyIiA/ICJMIiA6ICJSIjsKCiAgICAgIGlmIChzdHIubGVuZ3RoID09IDAgfHwgZGlyZWN0aW9uID09ICJsdHIiICYmICFiaWRpUkUudGVzdChzdHIpKSB7IHJldHVybiBmYWxzZSB9CiAgICAgIHZhciBsZW4gPSBzdHIubGVuZ3RoLCB0eXBlcyA9IFtdOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgKytpKQogICAgICAgIHsgdHlwZXMucHVzaChjaGFyVHlwZShzdHIuY2hhckNvZGVBdChpKSkpOyB9CgogICAgICAvLyBXMS4gRXhhbWluZSBlYWNoIG5vbi1zcGFjaW5nIG1hcmsgKE5TTSkgaW4gdGhlIGxldmVsIHJ1biwgYW5kCiAgICAgIC8vIGNoYW5nZSB0aGUgdHlwZSBvZiB0aGUgTlNNIHRvIHRoZSB0eXBlIG9mIHRoZSBwcmV2aW91cwogICAgICAvLyBjaGFyYWN0ZXIuIElmIHRoZSBOU00gaXMgYXQgdGhlIHN0YXJ0IG9mIHRoZSBsZXZlbCBydW4sIGl0IHdpbGwKICAgICAgLy8gZ2V0IHRoZSB0eXBlIG9mIHNvci4KICAgICAgZm9yICh2YXIgaSQxID0gMCwgcHJldiA9IG91dGVyVHlwZTsgaSQxIDwgbGVuOyArK2kkMSkgewogICAgICAgIHZhciB0eXBlID0gdHlwZXNbaSQxXTsKICAgICAgICBpZiAodHlwZSA9PSAibSIpIHsgdHlwZXNbaSQxXSA9IHByZXY7IH0KICAgICAgICBlbHNlIHsgcHJldiA9IHR5cGU7IH0KICAgICAgfQoKICAgICAgLy8gVzIuIFNlYXJjaCBiYWNrd2FyZHMgZnJvbSBlYWNoIGluc3RhbmNlIG9mIGEgRXVyb3BlYW4gbnVtYmVyCiAgICAgIC8vIHVudGlsIHRoZSBmaXJzdCBzdHJvbmcgdHlwZSAoUiwgTCwgQUwsIG9yIHNvcikgaXMgZm91bmQuIElmIGFuCiAgICAgIC8vIEFMIGlzIGZvdW5kLCBjaGFuZ2UgdGhlIHR5cGUgb2YgdGhlIEV1cm9wZWFuIG51bWJlciB0byBBcmFiaWMKICAgICAgLy8gbnVtYmVyLgogICAgICAvLyBXMy4gQ2hhbmdlIGFsbCBBTHMgdG8gUi4KICAgICAgZm9yICh2YXIgaSQyID0gMCwgY3VyID0gb3V0ZXJUeXBlOyBpJDIgPCBsZW47ICsraSQyKSB7CiAgICAgICAgdmFyIHR5cGUkMSA9IHR5cGVzW2kkMl07CiAgICAgICAgaWYgKHR5cGUkMSA9PSAiMSIgJiYgY3VyID09ICJyIikgeyB0eXBlc1tpJDJdID0gIm4iOyB9CiAgICAgICAgZWxzZSBpZiAoaXNTdHJvbmcudGVzdCh0eXBlJDEpKSB7IGN1ciA9IHR5cGUkMTsgaWYgKHR5cGUkMSA9PSAiciIpIHsgdHlwZXNbaSQyXSA9ICJSIjsgfSB9CiAgICAgIH0KCiAgICAgIC8vIFc0LiBBIHNpbmdsZSBFdXJvcGVhbiBzZXBhcmF0b3IgYmV0d2VlbiB0d28gRXVyb3BlYW4gbnVtYmVycwogICAgICAvLyBjaGFuZ2VzIHRvIGEgRXVyb3BlYW4gbnVtYmVyLiBBIHNpbmdsZSBjb21tb24gc2VwYXJhdG9yIGJldHdlZW4KICAgICAgLy8gdHdvIG51bWJlcnMgb2YgdGhlIHNhbWUgdHlwZSBjaGFuZ2VzIHRvIHRoYXQgdHlwZS4KICAgICAgZm9yICh2YXIgaSQzID0gMSwgcHJldiQxID0gdHlwZXNbMF07IGkkMyA8IGxlbiAtIDE7ICsraSQzKSB7CiAgICAgICAgdmFyIHR5cGUkMiA9IHR5cGVzW2kkM107CiAgICAgICAgaWYgKHR5cGUkMiA9PSAiKyIgJiYgcHJldiQxID09ICIxIiAmJiB0eXBlc1tpJDMrMV0gPT0gIjEiKSB7IHR5cGVzW2kkM10gPSAiMSI7IH0KICAgICAgICBlbHNlIGlmICh0eXBlJDIgPT0gIiwiICYmIHByZXYkMSA9PSB0eXBlc1tpJDMrMV0gJiYKICAgICAgICAgICAgICAgICAocHJldiQxID09ICIxIiB8fCBwcmV2JDEgPT0gIm4iKSkgeyB0eXBlc1tpJDNdID0gcHJldiQxOyB9CiAgICAgICAgcHJldiQxID0gdHlwZSQyOwogICAgICB9CgogICAgICAvLyBXNS4gQSBzZXF1ZW5jZSBvZiBFdXJvcGVhbiB0ZXJtaW5hdG9ycyBhZGphY2VudCB0byBFdXJvcGVhbgogICAgICAvLyBudW1iZXJzIGNoYW5nZXMgdG8gYWxsIEV1cm9wZWFuIG51bWJlcnMuCiAgICAgIC8vIFc2LiBPdGhlcndpc2UsIHNlcGFyYXRvcnMgYW5kIHRlcm1pbmF0b3JzIGNoYW5nZSB0byBPdGhlcgogICAgICAvLyBOZXV0cmFsLgogICAgICBmb3IgKHZhciBpJDQgPSAwOyBpJDQgPCBsZW47ICsraSQ0KSB7CiAgICAgICAgdmFyIHR5cGUkMyA9IHR5cGVzW2kkNF07CiAgICAgICAgaWYgKHR5cGUkMyA9PSAiLCIpIHsgdHlwZXNbaSQ0XSA9ICJOIjsgfQogICAgICAgIGVsc2UgaWYgKHR5cGUkMyA9PSAiJSIpIHsKICAgICAgICAgIHZhciBlbmQgPSAodm9pZCAwKTsKICAgICAgICAgIGZvciAoZW5kID0gaSQ0ICsgMTsgZW5kIDwgbGVuICYmIHR5cGVzW2VuZF0gPT0gIiUiOyArK2VuZCkge30KICAgICAgICAgIHZhciByZXBsYWNlID0gKGkkNCAmJiB0eXBlc1tpJDQtMV0gPT0gIiEiKSB8fCAoZW5kIDwgbGVuICYmIHR5cGVzW2VuZF0gPT0gIjEiKSA/ICIxIiA6ICJOIjsKICAgICAgICAgIGZvciAodmFyIGogPSBpJDQ7IGogPCBlbmQ7ICsraikgeyB0eXBlc1tqXSA9IHJlcGxhY2U7IH0KICAgICAgICAgIGkkNCA9IGVuZCAtIDE7CiAgICAgICAgfQogICAgICB9CgogICAgICAvLyBXNy4gU2VhcmNoIGJhY2t3YXJkcyBmcm9tIGVhY2ggaW5zdGFuY2Ugb2YgYSBFdXJvcGVhbiBudW1iZXIKICAgICAgLy8gdW50aWwgdGhlIGZpcnN0IHN0cm9uZyB0eXBlIChSLCBMLCBvciBzb3IpIGlzIGZvdW5kLiBJZiBhbiBMIGlzCiAgICAgIC8vIGZvdW5kLCB0aGVuIGNoYW5nZSB0aGUgdHlwZSBvZiB0aGUgRXVyb3BlYW4gbnVtYmVyIHRvIEwuCiAgICAgIGZvciAodmFyIGkkNSA9IDAsIGN1ciQxID0gb3V0ZXJUeXBlOyBpJDUgPCBsZW47ICsraSQ1KSB7CiAgICAgICAgdmFyIHR5cGUkNCA9IHR5cGVzW2kkNV07CiAgICAgICAgaWYgKGN1ciQxID09ICJMIiAmJiB0eXBlJDQgPT0gIjEiKSB7IHR5cGVzW2kkNV0gPSAiTCI7IH0KICAgICAgICBlbHNlIGlmIChpc1N0cm9uZy50ZXN0KHR5cGUkNCkpIHsgY3VyJDEgPSB0eXBlJDQ7IH0KICAgICAgfQoKICAgICAgLy8gTjEuIEEgc2VxdWVuY2Ugb2YgbmV1dHJhbHMgdGFrZXMgdGhlIGRpcmVjdGlvbiBvZiB0aGUKICAgICAgLy8gc3Vycm91bmRpbmcgc3Ryb25nIHRleHQgaWYgdGhlIHRleHQgb24gYm90aCBzaWRlcyBoYXMgdGhlIHNhbWUKICAgICAgLy8gZGlyZWN0aW9uLiBFdXJvcGVhbiBhbmQgQXJhYmljIG51bWJlcnMgYWN0IGFzIGlmIHRoZXkgd2VyZSBSIGluCiAgICAgIC8vIHRlcm1zIG9mIHRoZWlyIGluZmx1ZW5jZSBvbiBuZXV0cmFscy4gU3RhcnQtb2YtbGV2ZWwtcnVuIChzb3IpCiAgICAgIC8vIGFuZCBlbmQtb2YtbGV2ZWwtcnVuIChlb3IpIGFyZSB1c2VkIGF0IGxldmVsIHJ1biBib3VuZGFyaWVzLgogICAgICAvLyBOMi4gQW55IHJlbWFpbmluZyBuZXV0cmFscyB0YWtlIHRoZSBlbWJlZGRpbmcgZGlyZWN0aW9uLgogICAgICBmb3IgKHZhciBpJDYgPSAwOyBpJDYgPCBsZW47ICsraSQ2KSB7CiAgICAgICAgaWYgKGlzTmV1dHJhbC50ZXN0KHR5cGVzW2kkNl0pKSB7CiAgICAgICAgICB2YXIgZW5kJDEgPSAodm9pZCAwKTsKICAgICAgICAgIGZvciAoZW5kJDEgPSBpJDYgKyAxOyBlbmQkMSA8IGxlbiAmJiBpc05ldXRyYWwudGVzdCh0eXBlc1tlbmQkMV0pOyArK2VuZCQxKSB7fQogICAgICAgICAgdmFyIGJlZm9yZSA9IChpJDYgPyB0eXBlc1tpJDYtMV0gOiBvdXRlclR5cGUpID09ICJMIjsKICAgICAgICAgIHZhciBhZnRlciA9IChlbmQkMSA8IGxlbiA/IHR5cGVzW2VuZCQxXSA6IG91dGVyVHlwZSkgPT0gIkwiOwogICAgICAgICAgdmFyIHJlcGxhY2UkMSA9IGJlZm9yZSA9PSBhZnRlciA/IChiZWZvcmUgPyAiTCIgOiAiUiIpIDogb3V0ZXJUeXBlOwogICAgICAgICAgZm9yICh2YXIgaiQxID0gaSQ2OyBqJDEgPCBlbmQkMTsgKytqJDEpIHsgdHlwZXNbaiQxXSA9IHJlcGxhY2UkMTsgfQogICAgICAgICAgaSQ2ID0gZW5kJDEgLSAxOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gSGVyZSB3ZSBkZXBhcnQgZnJvbSB0aGUgZG9jdW1lbnRlZCBhbGdvcml0aG0sIGluIG9yZGVyIHRvIGF2b2lkCiAgICAgIC8vIGJ1aWxkaW5nIHVwIGFuIGFjdHVhbCBsZXZlbHMgYXJyYXkuIFNpbmNlIHRoZXJlIGFyZSBvbmx5IHRocmVlCiAgICAgIC8vIGxldmVscyAoMCwgMSwgMikgaW4gYW4gaW1wbGVtZW50YXRpb24gdGhhdCBkb2Vzbid0IHRha2UKICAgICAgLy8gZXhwbGljaXQgZW1iZWRkaW5nIGludG8gYWNjb3VudCwgd2UgY2FuIGJ1aWxkIHVwIHRoZSBvcmRlciBvbgogICAgICAvLyB0aGUgZmx5LCB3aXRob3V0IGZvbGxvd2luZyB0aGUgbGV2ZWwtYmFzZWQgYWxnb3JpdGhtLgogICAgICB2YXIgb3JkZXIgPSBbXSwgbTsKICAgICAgZm9yICh2YXIgaSQ3ID0gMDsgaSQ3IDwgbGVuOykgewogICAgICAgIGlmIChjb3VudHNBc0xlZnQudGVzdCh0eXBlc1tpJDddKSkgewogICAgICAgICAgdmFyIHN0YXJ0ID0gaSQ3OwogICAgICAgICAgZm9yICgrK2kkNzsgaSQ3IDwgbGVuICYmIGNvdW50c0FzTGVmdC50ZXN0KHR5cGVzW2kkN10pOyArK2kkNykge30KICAgICAgICAgIG9yZGVyLnB1c2gobmV3IEJpZGlTcGFuKDAsIHN0YXJ0LCBpJDcpKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIHBvcyA9IGkkNywgYXQgPSBvcmRlci5sZW5ndGg7CiAgICAgICAgICBmb3IgKCsraSQ3OyBpJDcgPCBsZW4gJiYgdHlwZXNbaSQ3XSAhPSAiTCI7ICsraSQ3KSB7fQogICAgICAgICAgZm9yICh2YXIgaiQyID0gcG9zOyBqJDIgPCBpJDc7KSB7CiAgICAgICAgICAgIGlmIChjb3VudHNBc051bS50ZXN0KHR5cGVzW2okMl0pKSB7CiAgICAgICAgICAgICAgaWYgKHBvcyA8IGokMikgeyBvcmRlci5zcGxpY2UoYXQsIDAsIG5ldyBCaWRpU3BhbigxLCBwb3MsIGokMikpOyB9CiAgICAgICAgICAgICAgdmFyIG5zdGFydCA9IGokMjsKICAgICAgICAgICAgICBmb3IgKCsraiQyOyBqJDIgPCBpJDcgJiYgY291bnRzQXNOdW0udGVzdCh0eXBlc1tqJDJdKTsgKytqJDIpIHt9CiAgICAgICAgICAgICAgb3JkZXIuc3BsaWNlKGF0LCAwLCBuZXcgQmlkaVNwYW4oMiwgbnN0YXJ0LCBqJDIpKTsKICAgICAgICAgICAgICBwb3MgPSBqJDI7CiAgICAgICAgICAgIH0gZWxzZSB7ICsraiQyOyB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocG9zIDwgaSQ3KSB7IG9yZGVyLnNwbGljZShhdCwgMCwgbmV3IEJpZGlTcGFuKDEsIHBvcywgaSQ3KSk7IH0KICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKGRpcmVjdGlvbiA9PSAibHRyIikgewogICAgICAgIGlmIChvcmRlclswXS5sZXZlbCA9PSAxICYmIChtID0gc3RyLm1hdGNoKC9eXHMrLykpKSB7CiAgICAgICAgICBvcmRlclswXS5mcm9tID0gbVswXS5sZW5ndGg7CiAgICAgICAgICBvcmRlci51bnNoaWZ0KG5ldyBCaWRpU3BhbigwLCAwLCBtWzBdLmxlbmd0aCkpOwogICAgICAgIH0KICAgICAgICBpZiAobHN0KG9yZGVyKS5sZXZlbCA9PSAxICYmIChtID0gc3RyLm1hdGNoKC9ccyskLykpKSB7CiAgICAgICAgICBsc3Qob3JkZXIpLnRvIC09IG1bMF0ubGVuZ3RoOwogICAgICAgICAgb3JkZXIucHVzaChuZXcgQmlkaVNwYW4oMCwgbGVuIC0gbVswXS5sZW5ndGgsIGxlbikpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIGRpcmVjdGlvbiA9PSAicnRsIiA/IG9yZGVyLnJldmVyc2UoKSA6IG9yZGVyCiAgICB9CiAgfSkoKTsKCiAgLy8gR2V0IHRoZSBiaWRpIG9yZGVyaW5nIGZvciB0aGUgZ2l2ZW4gbGluZSAoYW5kIGNhY2hlIGl0KS4gUmV0dXJucwogIC8vIGZhbHNlIGZvciBsaW5lcyB0aGF0IGFyZSBmdWxseSBsZWZ0LXRvLXJpZ2h0LCBhbmQgYW4gYXJyYXkgb2YKICAvLyBCaWRpU3BhbiBvYmplY3RzIG90aGVyd2lzZS4KICBmdW5jdGlvbiBnZXRPcmRlcihsaW5lLCBkaXJlY3Rpb24pIHsKICAgIHZhciBvcmRlciA9IGxpbmUub3JkZXI7CiAgICBpZiAob3JkZXIgPT0gbnVsbCkgeyBvcmRlciA9IGxpbmUub3JkZXIgPSBiaWRpT3JkZXJpbmcobGluZS50ZXh0LCBkaXJlY3Rpb24pOyB9CiAgICByZXR1cm4gb3JkZXIKICB9CgogIC8vIEVWRU5UIEhBTkRMSU5HCgogIC8vIExpZ2h0d2VpZ2h0IGV2ZW50IGZyYW1ld29yay4gb24vb2ZmIGFsc28gd29yayBvbiBET00gbm9kZXMsCiAgLy8gcmVnaXN0ZXJpbmcgbmF0aXZlIERPTSBoYW5kbGVycy4KCiAgdmFyIG5vSGFuZGxlcnMgPSBbXTsKCiAgdmFyIG9uID0gZnVuY3Rpb24oZW1pdHRlciwgdHlwZSwgZikgewogICAgaWYgKGVtaXR0ZXIuYWRkRXZlbnRMaXN0ZW5lcikgewogICAgICBlbWl0dGVyLmFkZEV2ZW50TGlzdGVuZXIodHlwZSwgZiwgZmFsc2UpOwogICAgfSBlbHNlIGlmIChlbWl0dGVyLmF0dGFjaEV2ZW50KSB7CiAgICAgIGVtaXR0ZXIuYXR0YWNoRXZlbnQoIm9uIiArIHR5cGUsIGYpOwogICAgfSBlbHNlIHsKICAgICAgdmFyIG1hcCQkMSA9IGVtaXR0ZXIuX2hhbmRsZXJzIHx8IChlbWl0dGVyLl9oYW5kbGVycyA9IHt9KTsKICAgICAgbWFwJCQxW3R5cGVdID0gKG1hcCQkMVt0eXBlXSB8fCBub0hhbmRsZXJzKS5jb25jYXQoZik7CiAgICB9CiAgfTsKCiAgZnVuY3Rpb24gZ2V0SGFuZGxlcnMoZW1pdHRlciwgdHlwZSkgewogICAgcmV0dXJuIGVtaXR0ZXIuX2hhbmRsZXJzICYmIGVtaXR0ZXIuX2hhbmRsZXJzW3R5cGVdIHx8IG5vSGFuZGxlcnMKICB9CgogIGZ1bmN0aW9uIG9mZihlbWl0dGVyLCB0eXBlLCBmKSB7CiAgICBpZiAoZW1pdHRlci5yZW1vdmVFdmVudExpc3RlbmVyKSB7CiAgICAgIGVtaXR0ZXIucmVtb3ZlRXZlbnRMaXN0ZW5lcih0eXBlLCBmLCBmYWxzZSk7CiAgICB9IGVsc2UgaWYgKGVtaXR0ZXIuZGV0YWNoRXZlbnQpIHsKICAgICAgZW1pdHRlci5kZXRhY2hFdmVudCgib24iICsgdHlwZSwgZik7CiAgICB9IGVsc2UgewogICAgICB2YXIgbWFwJCQxID0gZW1pdHRlci5faGFuZGxlcnMsIGFyciA9IG1hcCQkMSAmJiBtYXAkJDFbdHlwZV07CiAgICAgIGlmIChhcnIpIHsKICAgICAgICB2YXIgaW5kZXggPSBpbmRleE9mKGFyciwgZik7CiAgICAgICAgaWYgKGluZGV4ID4gLTEpCiAgICAgICAgICB7IG1hcCQkMVt0eXBlXSA9IGFyci5zbGljZSgwLCBpbmRleCkuY29uY2F0KGFyci5zbGljZShpbmRleCArIDEpKTsgfQogICAgICB9CiAgICB9CiAgfQoKICBmdW5jdGlvbiBzaWduYWwoZW1pdHRlciwgdHlwZSAvKiwgdmFsdWVzLi4uKi8pIHsKICAgIHZhciBoYW5kbGVycyA9IGdldEhhbmRsZXJzKGVtaXR0ZXIsIHR5cGUpOwogICAgaWYgKCFoYW5kbGVycy5sZW5ndGgpIHsgcmV0dXJuIH0KICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAyKTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaGFuZGxlcnMubGVuZ3RoOyArK2kpIHsgaGFuZGxlcnNbaV0uYXBwbHkobnVsbCwgYXJncyk7IH0KICB9CgogIC8vIFRoZSBET00gZXZlbnRzIHRoYXQgQ29kZU1pcnJvciBoYW5kbGVzIGNhbiBiZSBvdmVycmlkZGVuIGJ5CiAgLy8gcmVnaXN0ZXJpbmcgYSAobm9uLURPTSkgaGFuZGxlciBvbiB0aGUgZWRpdG9yIGZvciB0aGUgZXZlbnQgbmFtZSwKICAvLyBhbmQgcHJldmVudERlZmF1bHQtaW5nIHRoZSBldmVudCBpbiB0aGF0IGhhbmRsZXIuCiAgZnVuY3Rpb24gc2lnbmFsRE9NRXZlbnQoY20sIGUsIG92ZXJyaWRlKSB7CiAgICBpZiAodHlwZW9mIGUgPT0gInN0cmluZyIpCiAgICAgIHsgZSA9IHt0eXBlOiBlLCBwcmV2ZW50RGVmYXVsdDogZnVuY3Rpb24oKSB7IHRoaXMuZGVmYXVsdFByZXZlbnRlZCA9IHRydWU7IH19OyB9CiAgICBzaWduYWwoY20sIG92ZXJyaWRlIHx8IGUudHlwZSwgY20sIGUpOwogICAgcmV0dXJuIGVfZGVmYXVsdFByZXZlbnRlZChlKSB8fCBlLmNvZGVtaXJyb3JJZ25vcmUKICB9CgogIGZ1bmN0aW9uIHNpZ25hbEN1cnNvckFjdGl2aXR5KGNtKSB7CiAgICB2YXIgYXJyID0gY20uX2hhbmRsZXJzICYmIGNtLl9oYW5kbGVycy5jdXJzb3JBY3Rpdml0eTsKICAgIGlmICghYXJyKSB7IHJldHVybiB9CiAgICB2YXIgc2V0ID0gY20uY3VyT3AuY3Vyc29yQWN0aXZpdHlIYW5kbGVycyB8fCAoY20uY3VyT3AuY3Vyc29yQWN0aXZpdHlIYW5kbGVycyA9IFtdKTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJyLmxlbmd0aDsgKytpKSB7IGlmIChpbmRleE9mKHNldCwgYXJyW2ldKSA9PSAtMSkKICAgICAgeyBzZXQucHVzaChhcnJbaV0pOyB9IH0KICB9CgogIGZ1bmN0aW9uIGhhc0hhbmRsZXIoZW1pdHRlciwgdHlwZSkgewogICAgcmV0dXJuIGdldEhhbmRsZXJzKGVtaXR0ZXIsIHR5cGUpLmxlbmd0aCA+IDAKICB9CgogIC8vIEFkZCBvbiBhbmQgb2ZmIG1ldGhvZHMgdG8gYSBjb25zdHJ1Y3RvcidzIHByb3RvdHlwZSwgdG8gbWFrZQogIC8vIHJlZ2lzdGVyaW5nIGV2ZW50cyBvbiBzdWNoIG9iamVjdHMgbW9yZSBjb252ZW5pZW50LgogIGZ1bmN0aW9uIGV2ZW50TWl4aW4oY3RvcikgewogICAgY3Rvci5wcm90b3R5cGUub24gPSBmdW5jdGlvbih0eXBlLCBmKSB7b24odGhpcywgdHlwZSwgZik7fTsKICAgIGN0b3IucHJvdG90eXBlLm9mZiA9IGZ1bmN0aW9uKHR5cGUsIGYpIHtvZmYodGhpcywgdHlwZSwgZik7fTsKICB9CgogIC8vIER1ZSB0byB0aGUgZmFjdCB0aGF0IHdlIHN0aWxsIHN1cHBvcnQganVyYXNzaWMgSUUgdmVyc2lvbnMsIHNvbWUKICAvLyBjb21wYXRpYmlsaXR5IHdyYXBwZXJzIGFyZSBuZWVkZWQuCgogIGZ1bmN0aW9uIGVfcHJldmVudERlZmF1bHQoZSkgewogICAgaWYgKGUucHJldmVudERlZmF1bHQpIHsgZS5wcmV2ZW50RGVmYXVsdCgpOyB9CiAgICBlbHNlIHsgZS5yZXR1cm5WYWx1ZSA9IGZhbHNlOyB9CiAgfQogIGZ1bmN0aW9uIGVfc3RvcFByb3BhZ2F0aW9uKGUpIHsKICAgIGlmIChlLnN0b3BQcm9wYWdhdGlvbikgeyBlLnN0b3BQcm9wYWdhdGlvbigpOyB9CiAgICBlbHNlIHsgZS5jYW5jZWxCdWJibGUgPSB0cnVlOyB9CiAgfQogIGZ1bmN0aW9uIGVfZGVmYXVsdFByZXZlbnRlZChlKSB7CiAgICByZXR1cm4gZS5kZWZhdWx0UHJldmVudGVkICE9IG51bGwgPyBlLmRlZmF1bHRQcmV2ZW50ZWQgOiBlLnJldHVyblZhbHVlID09IGZhbHNlCiAgfQogIGZ1bmN0aW9uIGVfc3RvcChlKSB7ZV9wcmV2ZW50RGVmYXVsdChlKTsgZV9zdG9wUHJvcGFnYXRpb24oZSk7fQoKICBmdW5jdGlvbiBlX3RhcmdldChlKSB7cmV0dXJuIGUudGFyZ2V0IHx8IGUuc3JjRWxlbWVudH0KICBmdW5jdGlvbiBlX2J1dHRvbihlKSB7CiAgICB2YXIgYiA9IGUud2hpY2g7CiAgICBpZiAoYiA9PSBudWxsKSB7CiAgICAgIGlmIChlLmJ1dHRvbiAmIDEpIHsgYiA9IDE7IH0KICAgICAgZWxzZSBpZiAoZS5idXR0b24gJiAyKSB7IGIgPSAzOyB9CiAgICAgIGVsc2UgaWYgKGUuYnV0dG9uICYgNCkgeyBiID0gMjsgfQogICAgfQogICAgaWYgKG1hYyAmJiBlLmN0cmxLZXkgJiYgYiA9PSAxKSB7IGIgPSAzOyB9CiAgICByZXR1cm4gYgogIH0KCiAgLy8gRGV0ZWN0IGRyYWctYW5kLWRyb3AKICB2YXIgZHJhZ0FuZERyb3AgPSBmdW5jdGlvbigpIHsKICAgIC8vIFRoZXJlIGlzICpzb21lKiBraW5kIG9mIGRyYWctYW5kLWRyb3Agc3VwcG9ydCBpbiBJRTYtOCwgYnV0IEkKICAgIC8vIGNvdWxkbid0IGdldCBpdCB0byB3b3JrIHlldC4KICAgIGlmIChpZSAmJiBpZV92ZXJzaW9uIDwgOSkgeyByZXR1cm4gZmFsc2UgfQogICAgdmFyIGRpdiA9IGVsdCgnZGl2Jyk7CiAgICByZXR1cm4gImRyYWdnYWJsZSIgaW4gZGl2IHx8ICJkcmFnRHJvcCIgaW4gZGl2CiAgfSgpOwoKICB2YXIgendzcFN1cHBvcnRlZDsKICBmdW5jdGlvbiB6ZXJvV2lkdGhFbGVtZW50KG1lYXN1cmUpIHsKICAgIGlmICh6d3NwU3VwcG9ydGVkID09IG51bGwpIHsKICAgICAgdmFyIHRlc3QgPSBlbHQoInNwYW4iLCAiXHUyMDBiIik7CiAgICAgIHJlbW92ZUNoaWxkcmVuQW5kQWRkKG1lYXN1cmUsIGVsdCgic3BhbiIsIFt0ZXN0LCBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSgieCIpXSkpOwogICAgICBpZiAobWVhc3VyZS5maXJzdENoaWxkLm9mZnNldEhlaWdodCAhPSAwKQogICAgICAgIHsgendzcFN1cHBvcnRlZCA9IHRlc3Qub2Zmc2V0V2lkdGggPD0gMSAmJiB0ZXN0Lm9mZnNldEhlaWdodCA+IDIgJiYgIShpZSAmJiBpZV92ZXJzaW9uIDwgOCk7IH0KICAgIH0KICAgIHZhciBub2RlID0gendzcFN1cHBvcnRlZCA/IGVsdCgic3BhbiIsICJcdTIwMGIiKSA6CiAgICAgIGVsdCgic3BhbiIsICJcdTAwYTAiLCBudWxsLCAiZGlzcGxheTogaW5saW5lLWJsb2NrOyB3aWR0aDogMXB4OyBtYXJnaW4tcmlnaHQ6IC0xcHgiKTsKICAgIG5vZGUuc2V0QXR0cmlidXRlKCJjbS10ZXh0IiwgIiIpOwogICAgcmV0dXJuIG5vZGUKICB9CgogIC8vIEZlYXR1cmUtZGV0ZWN0IElFJ3MgY3J1bW15IGNsaWVudCByZWN0IHJlcG9ydGluZyBmb3IgYmlkaSB0ZXh0CiAgdmFyIGJhZEJpZGlSZWN0czsKICBmdW5jdGlvbiBoYXNCYWRCaWRpUmVjdHMobWVhc3VyZSkgewogICAgaWYgKGJhZEJpZGlSZWN0cyAhPSBudWxsKSB7IHJldHVybiBiYWRCaWRpUmVjdHMgfQogICAgdmFyIHR4dCA9IHJlbW92ZUNoaWxkcmVuQW5kQWRkKG1lYXN1cmUsIGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCJBXHUwNjJlQSIpKTsKICAgIHZhciByMCA9IHJhbmdlKHR4dCwgMCwgMSkuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICB2YXIgcjEgPSByYW5nZSh0eHQsIDEsIDIpLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgcmVtb3ZlQ2hpbGRyZW4obWVhc3VyZSk7CiAgICBpZiAoIXIwIHx8IHIwLmxlZnQgPT0gcjAucmlnaHQpIHsgcmV0dXJuIGZhbHNlIH0gLy8gU2FmYXJpIHJldHVybnMgbnVsbCBpbiBzb21lIGNhc2VzICgjMjc4MCkKICAgIHJldHVybiBiYWRCaWRpUmVjdHMgPSAocjEucmlnaHQgLSByMC5yaWdodCA8IDMpCiAgfQoKICAvLyBTZWUgaWYgIiIuc3BsaXQgaXMgdGhlIGJyb2tlbiBJRSB2ZXJzaW9uLCBpZiBzbywgcHJvdmlkZSBhbgogIC8vIGFsdGVybmF0aXZlIHdheSB0byBzcGxpdCBsaW5lcy4KICB2YXIgc3BsaXRMaW5lc0F1dG8gPSAiXG5cbmIiLnNwbGl0KC9cbi8pLmxlbmd0aCAhPSAzID8gZnVuY3Rpb24gKHN0cmluZykgewogICAgdmFyIHBvcyA9IDAsIHJlc3VsdCA9IFtdLCBsID0gc3RyaW5nLmxlbmd0aDsKICAgIHdoaWxlIChwb3MgPD0gbCkgewogICAgICB2YXIgbmwgPSBzdHJpbmcuaW5kZXhPZigiXG4iLCBwb3MpOwogICAgICBpZiAobmwgPT0gLTEpIHsgbmwgPSBzdHJpbmcubGVuZ3RoOyB9CiAgICAgIHZhciBsaW5lID0gc3RyaW5nLnNsaWNlKHBvcywgc3RyaW5nLmNoYXJBdChubCAtIDEpID09ICJcciIgPyBubCAtIDEgOiBubCk7CiAgICAgIHZhciBydCA9IGxpbmUuaW5kZXhPZigiXHIiKTsKICAgICAgaWYgKHJ0ICE9IC0xKSB7CiAgICAgICAgcmVzdWx0LnB1c2gobGluZS5zbGljZSgwLCBydCkpOwogICAgICAgIHBvcyArPSBydCArIDE7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVzdWx0LnB1c2gobGluZSk7CiAgICAgICAgcG9zID0gbmwgKyAxOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gcmVzdWx0CiAgfSA6IGZ1bmN0aW9uIChzdHJpbmcpIHsgcmV0dXJuIHN0cmluZy5zcGxpdCgvXHJcbj98XG4vKTsgfTsKCiAgdmFyIGhhc1NlbGVjdGlvbiA9IHdpbmRvdy5nZXRTZWxlY3Rpb24gPyBmdW5jdGlvbiAodGUpIHsKICAgIHRyeSB7IHJldHVybiB0ZS5zZWxlY3Rpb25TdGFydCAhPSB0ZS5zZWxlY3Rpb25FbmQgfQogICAgY2F0Y2goZSkgeyByZXR1cm4gZmFsc2UgfQogIH0gOiBmdW5jdGlvbiAodGUpIHsKICAgIHZhciByYW5nZSQkMTsKICAgIHRyeSB7cmFuZ2UkJDEgPSB0ZS5vd25lckRvY3VtZW50LnNlbGVjdGlvbi5jcmVhdGVSYW5nZSgpO30KICAgIGNhdGNoKGUpIHt9CiAgICBpZiAoIXJhbmdlJCQxIHx8IHJhbmdlJCQxLnBhcmVudEVsZW1lbnQoKSAhPSB0ZSkgeyByZXR1cm4gZmFsc2UgfQogICAgcmV0dXJuIHJhbmdlJCQxLmNvbXBhcmVFbmRQb2ludHMoIlN0YXJ0VG9FbmQiLCByYW5nZSQkMSkgIT0gMAogIH07CgogIHZhciBoYXNDb3B5RXZlbnQgPSAoZnVuY3Rpb24gKCkgewogICAgdmFyIGUgPSBlbHQoImRpdiIpOwogICAgaWYgKCJvbmNvcHkiIGluIGUpIHsgcmV0dXJuIHRydWUgfQogICAgZS5zZXRBdHRyaWJ1dGUoIm9uY29weSIsICJyZXR1cm47Iik7CiAgICByZXR1cm4gdHlwZW9mIGUub25jb3B5ID09ICJmdW5jdGlvbiIKICB9KSgpOwoKICB2YXIgYmFkWm9vbWVkUmVjdHMgPSBudWxsOwogIGZ1bmN0aW9uIGhhc0JhZFpvb21lZFJlY3RzKG1lYXN1cmUpIHsKICAgIGlmIChiYWRab29tZWRSZWN0cyAhPSBudWxsKSB7IHJldHVybiBiYWRab29tZWRSZWN0cyB9CiAgICB2YXIgbm9kZSA9IHJlbW92ZUNoaWxkcmVuQW5kQWRkKG1lYXN1cmUsIGVsdCgic3BhbiIsICJ4IikpOwogICAgdmFyIG5vcm1hbCA9IG5vZGUuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICB2YXIgZnJvbVJhbmdlID0gcmFuZ2Uobm9kZSwgMCwgMSkuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICByZXR1cm4gYmFkWm9vbWVkUmVjdHMgPSBNYXRoLmFicyhub3JtYWwubGVmdCAtIGZyb21SYW5nZS5sZWZ0KSA+IDEKICB9CgogIC8vIEtub3duIG1vZGVzLCBieSBuYW1lIGFuZCBieSBNSU1FCiAgdmFyIG1vZGVzID0ge30sIG1pbWVNb2RlcyA9IHt9OwoKICAvLyBFeHRyYSBhcmd1bWVudHMgYXJlIHN0b3JlZCBhcyB0aGUgbW9kZSdzIGRlcGVuZGVuY2llcywgd2hpY2ggaXMKICAvLyB1c2VkIGJ5IChsZWdhY3kpIG1lY2hhbmlzbXMgbGlrZSBsb2FkbW9kZS5qcyB0byBhdXRvbWF0aWNhbGx5CiAgLy8gbG9hZCBhIG1vZGUuIChQcmVmZXJyZWQgbWVjaGFuaXNtIGlzIHRoZSByZXF1aXJlL2RlZmluZSBjYWxscy4pCiAgZnVuY3Rpb24gZGVmaW5lTW9kZShuYW1lLCBtb2RlKSB7CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA+IDIpCiAgICAgIHsgbW9kZS5kZXBlbmRlbmNpZXMgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpOyB9CiAgICBtb2Rlc1tuYW1lXSA9IG1vZGU7CiAgfQoKICBmdW5jdGlvbiBkZWZpbmVNSU1FKG1pbWUsIHNwZWMpIHsKICAgIG1pbWVNb2Rlc1ttaW1lXSA9IHNwZWM7CiAgfQoKICAvLyBHaXZlbiBhIE1JTUUgdHlwZSwgYSB7bmFtZSwgLi4ub3B0aW9uc30gY29uZmlnIG9iamVjdCwgb3IgYSBuYW1lCiAgLy8gc3RyaW5nLCByZXR1cm4gYSBtb2RlIGNvbmZpZyBvYmplY3QuCiAgZnVuY3Rpb24gcmVzb2x2ZU1vZGUoc3BlYykgewogICAgaWYgKHR5cGVvZiBzcGVjID09ICJzdHJpbmciICYmIG1pbWVNb2Rlcy5oYXNPd25Qcm9wZXJ0eShzcGVjKSkgewogICAgICBzcGVjID0gbWltZU1vZGVzW3NwZWNdOwogICAgfSBlbHNlIGlmIChzcGVjICYmIHR5cGVvZiBzcGVjLm5hbWUgPT0gInN0cmluZyIgJiYgbWltZU1vZGVzLmhhc093blByb3BlcnR5KHNwZWMubmFtZSkpIHsKICAgICAgdmFyIGZvdW5kID0gbWltZU1vZGVzW3NwZWMubmFtZV07CiAgICAgIGlmICh0eXBlb2YgZm91bmQgPT0gInN0cmluZyIpIHsgZm91bmQgPSB7bmFtZTogZm91bmR9OyB9CiAgICAgIHNwZWMgPSBjcmVhdGVPYmooZm91bmQsIHNwZWMpOwogICAgICBzcGVjLm5hbWUgPSBmb3VuZC5uYW1lOwogICAgfSBlbHNlIGlmICh0eXBlb2Ygc3BlYyA9PSAic3RyaW5nIiAmJiAvXltcd1wtXStcL1tcd1wtXStcK3htbCQvLnRlc3Qoc3BlYykpIHsKICAgICAgcmV0dXJuIHJlc29sdmVNb2RlKCJhcHBsaWNhdGlvbi94bWwiKQogICAgfSBlbHNlIGlmICh0eXBlb2Ygc3BlYyA9PSAic3RyaW5nIiAmJiAvXltcd1wtXStcL1tcd1wtXStcK2pzb24kLy50ZXN0KHNwZWMpKSB7CiAgICAgIHJldHVybiByZXNvbHZlTW9kZSgiYXBwbGljYXRpb24vanNvbiIpCiAgICB9CiAgICBpZiAodHlwZW9mIHNwZWMgPT0gInN0cmluZyIpIHsgcmV0dXJuIHtuYW1lOiBzcGVjfSB9CiAgICBlbHNlIHsgcmV0dXJuIHNwZWMgfHwge25hbWU6ICJudWxsIn0gfQogIH0KCiAgLy8gR2l2ZW4gYSBtb2RlIHNwZWMgKGFueXRoaW5nIHRoYXQgcmVzb2x2ZU1vZGUgYWNjZXB0cyksIGZpbmQgYW5kCiAgLy8gaW5pdGlhbGl6ZSBhbiBhY3R1YWwgbW9kZSBvYmplY3QuCiAgZnVuY3Rpb24gZ2V0TW9kZShvcHRpb25zLCBzcGVjKSB7CiAgICBzcGVjID0gcmVzb2x2ZU1vZGUoc3BlYyk7CiAgICB2YXIgbWZhY3RvcnkgPSBtb2Rlc1tzcGVjLm5hbWVdOwogICAgaWYgKCFtZmFjdG9yeSkgeyByZXR1cm4gZ2V0TW9kZShvcHRpb25zLCAidGV4dC9wbGFpbiIpIH0KICAgIHZhciBtb2RlT2JqID0gbWZhY3Rvcnkob3B0aW9ucywgc3BlYyk7CiAgICBpZiAobW9kZUV4dGVuc2lvbnMuaGFzT3duUHJvcGVydHkoc3BlYy5uYW1lKSkgewogICAgICB2YXIgZXh0cyA9IG1vZGVFeHRlbnNpb25zW3NwZWMubmFtZV07CiAgICAgIGZvciAodmFyIHByb3AgaW4gZXh0cykgewogICAgICAgIGlmICghZXh0cy5oYXNPd25Qcm9wZXJ0eShwcm9wKSkgeyBjb250aW51ZSB9CiAgICAgICAgaWYgKG1vZGVPYmouaGFzT3duUHJvcGVydHkocHJvcCkpIHsgbW9kZU9ialsiXyIgKyBwcm9wXSA9IG1vZGVPYmpbcHJvcF07IH0KICAgICAgICBtb2RlT2JqW3Byb3BdID0gZXh0c1twcm9wXTsKICAgICAgfQogICAgfQogICAgbW9kZU9iai5uYW1lID0gc3BlYy5uYW1lOwogICAgaWYgKHNwZWMuaGVscGVyVHlwZSkgeyBtb2RlT2JqLmhlbHBlclR5cGUgPSBzcGVjLmhlbHBlclR5cGU7IH0KICAgIGlmIChzcGVjLm1vZGVQcm9wcykgeyBmb3IgKHZhciBwcm9wJDEgaW4gc3BlYy5tb2RlUHJvcHMpCiAgICAgIHsgbW9kZU9ialtwcm9wJDFdID0gc3BlYy5tb2RlUHJvcHNbcHJvcCQxXTsgfSB9CgogICAgcmV0dXJuIG1vZGVPYmoKICB9CgogIC8vIFRoaXMgY2FuIGJlIHVzZWQgdG8gYXR0YWNoIHByb3BlcnRpZXMgdG8gbW9kZSBvYmplY3RzIGZyb20KICAvLyBvdXRzaWRlIHRoZSBhY3R1YWwgbW9kZSBkZWZpbml0aW9uLgogIHZhciBtb2RlRXh0ZW5zaW9ucyA9IHt9OwogIGZ1bmN0aW9uIGV4dGVuZE1vZGUobW9kZSwgcHJvcGVydGllcykgewogICAgdmFyIGV4dHMgPSBtb2RlRXh0ZW5zaW9ucy5oYXNPd25Qcm9wZXJ0eShtb2RlKSA/IG1vZGVFeHRlbnNpb25zW21vZGVdIDogKG1vZGVFeHRlbnNpb25zW21vZGVdID0ge30pOwogICAgY29weU9iaihwcm9wZXJ0aWVzLCBleHRzKTsKICB9CgogIGZ1bmN0aW9uIGNvcHlTdGF0ZShtb2RlLCBzdGF0ZSkgewogICAgaWYgKHN0YXRlID09PSB0cnVlKSB7IHJldHVybiBzdGF0ZSB9CiAgICBpZiAobW9kZS5jb3B5U3RhdGUpIHsgcmV0dXJuIG1vZGUuY29weVN0YXRlKHN0YXRlKSB9CiAgICB2YXIgbnN0YXRlID0ge307CiAgICBmb3IgKHZhciBuIGluIHN0YXRlKSB7CiAgICAgIHZhciB2YWwgPSBzdGF0ZVtuXTsKICAgICAgaWYgKHZhbCBpbnN0YW5jZW9mIEFycmF5KSB7IHZhbCA9IHZhbC5jb25jYXQoW10pOyB9CiAgICAgIG5zdGF0ZVtuXSA9IHZhbDsKICAgIH0KICAgIHJldHVybiBuc3RhdGUKICB9CgogIC8vIEdpdmVuIGEgbW9kZSBhbmQgYSBzdGF0ZSAoZm9yIHRoYXQgbW9kZSksIGZpbmQgdGhlIGlubmVyIG1vZGUgYW5kCiAgLy8gc3RhdGUgYXQgdGhlIHBvc2l0aW9uIHRoYXQgdGhlIHN0YXRlIHJlZmVycyB0by4KICBmdW5jdGlvbiBpbm5lck1vZGUobW9kZSwgc3RhdGUpIHsKICAgIHZhciBpbmZvOwogICAgd2hpbGUgKG1vZGUuaW5uZXJNb2RlKSB7CiAgICAgIGluZm8gPSBtb2RlLmlubmVyTW9kZShzdGF0ZSk7CiAgICAgIGlmICghaW5mbyB8fCBpbmZvLm1vZGUgPT0gbW9kZSkgeyBicmVhayB9CiAgICAgIHN0YXRlID0gaW5mby5zdGF0ZTsKICAgICAgbW9kZSA9IGluZm8ubW9kZTsKICAgIH0KICAgIHJldHVybiBpbmZvIHx8IHttb2RlOiBtb2RlLCBzdGF0ZTogc3RhdGV9CiAgfQoKICBmdW5jdGlvbiBzdGFydFN0YXRlKG1vZGUsIGExLCBhMikgewogICAgcmV0dXJuIG1vZGUuc3RhcnRTdGF0ZSA/IG1vZGUuc3RhcnRTdGF0ZShhMSwgYTIpIDogdHJ1ZQogIH0KCiAgLy8gU1RSSU5HIFNUUkVBTQoKICAvLyBGZWQgdG8gdGhlIG1vZGUgcGFyc2VycywgcHJvdmlkZXMgaGVscGVyIGZ1bmN0aW9ucyB0byBtYWtlCiAgLy8gcGFyc2VycyBtb3JlIHN1Y2NpbmN0LgoKICB2YXIgU3RyaW5nU3RyZWFtID0gZnVuY3Rpb24oc3RyaW5nLCB0YWJTaXplLCBsaW5lT3JhY2xlKSB7CiAgICB0aGlzLnBvcyA9IHRoaXMuc3RhcnQgPSAwOwogICAgdGhpcy5zdHJpbmcgPSBzdHJpbmc7CiAgICB0aGlzLnRhYlNpemUgPSB0YWJTaXplIHx8IDg7CiAgICB0aGlzLmxhc3RDb2x1bW5Qb3MgPSB0aGlzLmxhc3RDb2x1bW5WYWx1ZSA9IDA7CiAgICB0aGlzLmxpbmVTdGFydCA9IDA7CiAgICB0aGlzLmxpbmVPcmFjbGUgPSBsaW5lT3JhY2xlOwogIH07CgogIFN0cmluZ1N0cmVhbS5wcm90b3R5cGUuZW9sID0gZnVuY3Rpb24gKCkge3JldHVybiB0aGlzLnBvcyA+PSB0aGlzLnN0cmluZy5sZW5ndGh9OwogIFN0cmluZ1N0cmVhbS5wcm90b3R5cGUuc29sID0gZnVuY3Rpb24gKCkge3JldHVybiB0aGlzLnBvcyA9PSB0aGlzLmxpbmVTdGFydH07CiAgU3RyaW5nU3RyZWFtLnByb3RvdHlwZS5wZWVrID0gZnVuY3Rpb24gKCkge3JldHVybiB0aGlzLnN0cmluZy5jaGFyQXQodGhpcy5wb3MpIHx8IHVuZGVmaW5lZH07CiAgU3RyaW5nU3RyZWFtLnByb3RvdHlwZS5uZXh0ID0gZnVuY3Rpb24gKCkgewogICAgaWYgKHRoaXMucG9zIDwgdGhpcy5zdHJpbmcubGVuZ3RoKQogICAgICB7IHJldHVybiB0aGlzLnN0cmluZy5jaGFyQXQodGhpcy5wb3MrKykgfQogIH07CiAgU3RyaW5nU3RyZWFtLnByb3RvdHlwZS5lYXQgPSBmdW5jdGlvbiAobWF0Y2gpIHsKICAgIHZhciBjaCA9IHRoaXMuc3RyaW5nLmNoYXJBdCh0aGlzLnBvcyk7CiAgICB2YXIgb2s7CiAgICBpZiAodHlwZW9mIG1hdGNoID09ICJzdHJpbmciKSB7IG9rID0gY2ggPT0gbWF0Y2g7IH0KICAgIGVsc2UgeyBvayA9IGNoICYmIChtYXRjaC50ZXN0ID8gbWF0Y2gudGVzdChjaCkgOiBtYXRjaChjaCkpOyB9CiAgICBpZiAob2spIHsrK3RoaXMucG9zOyByZXR1cm4gY2h9CiAgfTsKICBTdHJpbmdTdHJlYW0ucHJvdG90eXBlLmVhdFdoaWxlID0gZnVuY3Rpb24gKG1hdGNoKSB7CiAgICB2YXIgc3RhcnQgPSB0aGlzLnBvczsKICAgIHdoaWxlICh0aGlzLmVhdChtYXRjaCkpe30KICAgIHJldHVybiB0aGlzLnBvcyA+IHN0YXJ0CiAgfTsKICBTdHJpbmdTdHJlYW0ucHJvdG90eXBlLmVhdFNwYWNlID0gZnVuY3Rpb24gKCkgewogICAgICB2YXIgdGhpcyQxID0gdGhpczsKCiAgICB2YXIgc3RhcnQgPSB0aGlzLnBvczsKICAgIHdoaWxlICgvW1xzXHUwMGEwXS8udGVzdCh0aGlzLnN0cmluZy5jaGFyQXQodGhpcy5wb3MpKSkgeyArK3RoaXMkMS5wb3M7IH0KICAgIHJldHVybiB0aGlzLnBvcyA+IHN0YXJ0CiAgfTsKICBTdHJpbmdTdHJlYW0ucHJvdG90eXBlLnNraXBUb0VuZCA9IGZ1bmN0aW9uICgpIHt0aGlzLnBvcyA9IHRoaXMuc3RyaW5nLmxlbmd0aDt9OwogIFN0cmluZ1N0cmVhbS5wcm90b3R5cGUuc2tpcFRvID0gZnVuY3Rpb24gKGNoKSB7CiAgICB2YXIgZm91bmQgPSB0aGlzLnN0cmluZy5pbmRleE9mKGNoLCB0aGlzLnBvcyk7CiAgICBpZiAoZm91bmQgPiAtMSkge3RoaXMucG9zID0gZm91bmQ7IHJldHVybiB0cnVlfQogIH07CiAgU3RyaW5nU3RyZWFtLnByb3RvdHlwZS5iYWNrVXAgPSBmdW5jdGlvbiAobikge3RoaXMucG9zIC09IG47fTsKICBTdHJpbmdTdHJlYW0ucHJvdG90eXBlLmNvbHVtbiA9IGZ1bmN0aW9uICgpIHsKICAgIGlmICh0aGlzLmxhc3RDb2x1bW5Qb3MgPCB0aGlzLnN0YXJ0KSB7CiAgICAgIHRoaXMubGFzdENvbHVtblZhbHVlID0gY291bnRDb2x1bW4odGhpcy5zdHJpbmcsIHRoaXMuc3RhcnQsIHRoaXMudGFiU2l6ZSwgdGhpcy5sYXN0Q29sdW1uUG9zLCB0aGlzLmxhc3RDb2x1bW5WYWx1ZSk7CiAgICAgIHRoaXMubGFzdENvbHVtblBvcyA9IHRoaXMuc3RhcnQ7CiAgICB9CiAgICByZXR1cm4gdGhpcy5sYXN0Q29sdW1uVmFsdWUgLSAodGhpcy5saW5lU3RhcnQgPyBjb3VudENvbHVtbih0aGlzLnN0cmluZywgdGhpcy5saW5lU3RhcnQsIHRoaXMudGFiU2l6ZSkgOiAwKQogIH07CiAgU3RyaW5nU3RyZWFtLnByb3RvdHlwZS5pbmRlbnRhdGlvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb3VudENvbHVtbih0aGlzLnN0cmluZywgbnVsbCwgdGhpcy50YWJTaXplKSAtCiAgICAgICh0aGlzLmxpbmVTdGFydCA/IGNvdW50Q29sdW1uKHRoaXMuc3RyaW5nLCB0aGlzLmxpbmVTdGFydCwgdGhpcy50YWJTaXplKSA6IDApCiAgfTsKICBTdHJpbmdTdHJlYW0ucHJvdG90eXBlLm1hdGNoID0gZnVuY3Rpb24gKHBhdHRlcm4sIGNvbnN1bWUsIGNhc2VJbnNlbnNpdGl2ZSkgewogICAgaWYgKHR5cGVvZiBwYXR0ZXJuID09ICJzdHJpbmciKSB7CiAgICAgIHZhciBjYXNlZCA9IGZ1bmN0aW9uIChzdHIpIHsgcmV0dXJuIGNhc2VJbnNlbnNpdGl2ZSA/IHN0ci50b0xvd2VyQ2FzZSgpIDogc3RyOyB9OwogICAgICB2YXIgc3Vic3RyID0gdGhpcy5zdHJpbmcuc3Vic3RyKHRoaXMucG9zLCBwYXR0ZXJuLmxlbmd0aCk7CiAgICAgIGlmIChjYXNlZChzdWJzdHIpID09IGNhc2VkKHBhdHRlcm4pKSB7CiAgICAgICAgaWYgKGNvbnN1bWUgIT09IGZhbHNlKSB7IHRoaXMucG9zICs9IHBhdHRlcm4ubGVuZ3RoOyB9CiAgICAgICAgcmV0dXJuIHRydWUKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdmFyIG1hdGNoID0gdGhpcy5zdHJpbmcuc2xpY2UodGhpcy5wb3MpLm1hdGNoKHBhdHRlcm4pOwogICAgICBpZiAobWF0Y2ggJiYgbWF0Y2guaW5kZXggPiAwKSB7IHJldHVybiBudWxsIH0KICAgICAgaWYgKG1hdGNoICYmIGNvbnN1bWUgIT09IGZhbHNlKSB7IHRoaXMucG9zICs9IG1hdGNoWzBdLmxlbmd0aDsgfQogICAgICByZXR1cm4gbWF0Y2gKICAgIH0KICB9OwogIFN0cmluZ1N0cmVhbS5wcm90b3R5cGUuY3VycmVudCA9IGZ1bmN0aW9uICgpe3JldHVybiB0aGlzLnN0cmluZy5zbGljZSh0aGlzLnN0YXJ0LCB0aGlzLnBvcyl9OwogIFN0cmluZ1N0cmVhbS5wcm90b3R5cGUuaGlkZUZpcnN0Q2hhcnMgPSBmdW5jdGlvbiAobiwgaW5uZXIpIHsKICAgIHRoaXMubGluZVN0YXJ0ICs9IG47CiAgICB0cnkgeyByZXR1cm4gaW5uZXIoKSB9CiAgICBmaW5hbGx5IHsgdGhpcy5saW5lU3RhcnQgLT0gbjsgfQogIH07CiAgU3RyaW5nU3RyZWFtLnByb3RvdHlwZS5sb29rQWhlYWQgPSBmdW5jdGlvbiAobikgewogICAgdmFyIG9yYWNsZSA9IHRoaXMubGluZU9yYWNsZTsKICAgIHJldHVybiBvcmFjbGUgJiYgb3JhY2xlLmxvb2tBaGVhZChuKQogIH07CiAgU3RyaW5nU3RyZWFtLnByb3RvdHlwZS5iYXNlVG9rZW4gPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgb3JhY2xlID0gdGhpcy5saW5lT3JhY2xlOwogICAgcmV0dXJuIG9yYWNsZSAmJiBvcmFjbGUuYmFzZVRva2VuKHRoaXMucG9zKQogIH07CgogIC8vIEZpbmQgdGhlIGxpbmUgb2JqZWN0IGNvcnJlc3BvbmRpbmcgdG8gdGhlIGdpdmVuIGxpbmUgbnVtYmVyLgogIGZ1bmN0aW9uIGdldExpbmUoZG9jLCBuKSB7CiAgICBuIC09IGRvYy5maXJzdDsKICAgIGlmIChuIDwgMCB8fCBuID49IGRvYy5zaXplKSB7IHRocm93IG5ldyBFcnJvcigiVGhlcmUgaXMgbm8gbGluZSAiICsgKG4gKyBkb2MuZmlyc3QpICsgIiBpbiB0aGUgZG9jdW1lbnQuIikgfQogICAgdmFyIGNodW5rID0gZG9jOwogICAgd2hpbGUgKCFjaHVuay5saW5lcykgewogICAgICBmb3IgKHZhciBpID0gMDs7ICsraSkgewogICAgICAgIHZhciBjaGlsZCA9IGNodW5rLmNoaWxkcmVuW2ldLCBzeiA9IGNoaWxkLmNodW5rU2l6ZSgpOwogICAgICAgIGlmIChuIDwgc3opIHsgY2h1bmsgPSBjaGlsZDsgYnJlYWsgfQogICAgICAgIG4gLT0gc3o7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBjaHVuay5saW5lc1tuXQogIH0KCiAgLy8gR2V0IHRoZSBwYXJ0IG9mIGEgZG9jdW1lbnQgYmV0d2VlbiB0d28gcG9zaXRpb25zLCBhcyBhbiBhcnJheSBvZgogIC8vIHN0cmluZ3MuCiAgZnVuY3Rpb24gZ2V0QmV0d2Vlbihkb2MsIHN0YXJ0LCBlbmQpIHsKICAgIHZhciBvdXQgPSBbXSwgbiA9IHN0YXJ0LmxpbmU7CiAgICBkb2MuaXRlcihzdGFydC5saW5lLCBlbmQubGluZSArIDEsIGZ1bmN0aW9uIChsaW5lKSB7CiAgICAgIHZhciB0ZXh0ID0gbGluZS50ZXh0OwogICAgICBpZiAobiA9PSBlbmQubGluZSkgeyB0ZXh0ID0gdGV4dC5zbGljZSgwLCBlbmQuY2gpOyB9CiAgICAgIGlmIChuID09IHN0YXJ0LmxpbmUpIHsgdGV4dCA9IHRleHQuc2xpY2Uoc3RhcnQuY2gpOyB9CiAgICAgIG91dC5wdXNoKHRleHQpOwogICAgICArK247CiAgICB9KTsKICAgIHJldHVybiBvdXQKICB9CiAgLy8gR2V0IHRoZSBsaW5lcyBiZXR3ZWVuIGZyb20gYW5kIHRvLCBhcyBhcnJheSBvZiBzdHJpbmdzLgogIGZ1bmN0aW9uIGdldExpbmVzKGRvYywgZnJvbSwgdG8pIHsKICAgIHZhciBvdXQgPSBbXTsKICAgIGRvYy5pdGVyKGZyb20sIHRvLCBmdW5jdGlvbiAobGluZSkgeyBvdXQucHVzaChsaW5lLnRleHQpOyB9KTsgLy8gaXRlciBhYm9ydHMgd2hlbiBjYWxsYmFjayByZXR1cm5zIHRydXRoeSB2YWx1ZQogICAgcmV0dXJuIG91dAogIH0KCiAgLy8gVXBkYXRlIHRoZSBoZWlnaHQgb2YgYSBsaW5lLCBwcm9wYWdhdGluZyB0aGUgaGVpZ2h0IGNoYW5nZQogIC8vIHVwd2FyZHMgdG8gcGFyZW50IG5vZGVzLgogIGZ1bmN0aW9uIHVwZGF0ZUxpbmVIZWlnaHQobGluZSwgaGVpZ2h0KSB7CiAgICB2YXIgZGlmZiA9IGhlaWdodCAtIGxpbmUuaGVpZ2h0OwogICAgaWYgKGRpZmYpIHsgZm9yICh2YXIgbiA9IGxpbmU7IG47IG4gPSBuLnBhcmVudCkgeyBuLmhlaWdodCArPSBkaWZmOyB9IH0KICB9CgogIC8vIEdpdmVuIGEgbGluZSBvYmplY3QsIGZpbmQgaXRzIGxpbmUgbnVtYmVyIGJ5IHdhbGtpbmcgdXAgdGhyb3VnaAogIC8vIGl0cyBwYXJlbnQgbGlua3MuCiAgZnVuY3Rpb24gbGluZU5vKGxpbmUpIHsKICAgIGlmIChsaW5lLnBhcmVudCA9PSBudWxsKSB7IHJldHVybiBudWxsIH0KICAgIHZhciBjdXIgPSBsaW5lLnBhcmVudCwgbm8gPSBpbmRleE9mKGN1ci5saW5lcywgbGluZSk7CiAgICBmb3IgKHZhciBjaHVuayA9IGN1ci5wYXJlbnQ7IGNodW5rOyBjdXIgPSBjaHVuaywgY2h1bmsgPSBjaHVuay5wYXJlbnQpIHsKICAgICAgZm9yICh2YXIgaSA9IDA7OyArK2kpIHsKICAgICAgICBpZiAoY2h1bmsuY2hpbGRyZW5baV0gPT0gY3VyKSB7IGJyZWFrIH0KICAgICAgICBubyArPSBjaHVuay5jaGlsZHJlbltpXS5jaHVua1NpemUoKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIG5vICsgY3VyLmZpcnN0CiAgfQoKICAvLyBGaW5kIHRoZSBsaW5lIGF0IHRoZSBnaXZlbiB2ZXJ0aWNhbCBwb3NpdGlvbiwgdXNpbmcgdGhlIGhlaWdodAogIC8vIGluZm9ybWF0aW9uIGluIHRoZSBkb2N1bWVudCB0cmVlLgogIGZ1bmN0aW9uIGxpbmVBdEhlaWdodChjaHVuaywgaCkgewogICAgdmFyIG4gPSBjaHVuay5maXJzdDsKICAgIG91dGVyOiBkbyB7CiAgICAgIGZvciAodmFyIGkkMSA9IDA7IGkkMSA8IGNodW5rLmNoaWxkcmVuLmxlbmd0aDsgKytpJDEpIHsKICAgICAgICB2YXIgY2hpbGQgPSBjaHVuay5jaGlsZHJlbltpJDFdLCBjaCA9IGNoaWxkLmhlaWdodDsKICAgICAgICBpZiAoaCA8IGNoKSB7IGNodW5rID0gY2hpbGQ7IGNvbnRpbnVlIG91dGVyIH0KICAgICAgICBoIC09IGNoOwogICAgICAgIG4gKz0gY2hpbGQuY2h1bmtTaXplKCk7CiAgICAgIH0KICAgICAgcmV0dXJuIG4KICAgIH0gd2hpbGUgKCFjaHVuay5saW5lcykKICAgIHZhciBpID0gMDsKICAgIGZvciAoOyBpIDwgY2h1bmsubGluZXMubGVuZ3RoOyArK2kpIHsKICAgICAgdmFyIGxpbmUgPSBjaHVuay5saW5lc1tpXSwgbGggPSBsaW5lLmhlaWdodDsKICAgICAgaWYgKGggPCBsaCkgeyBicmVhayB9CiAgICAgIGggLT0gbGg7CiAgICB9CiAgICByZXR1cm4gbiArIGkKICB9CgogIGZ1bmN0aW9uIGlzTGluZShkb2MsIGwpIHtyZXR1cm4gbCA+PSBkb2MuZmlyc3QgJiYgbCA8IGRvYy5maXJzdCArIGRvYy5zaXplfQoKICBmdW5jdGlvbiBsaW5lTnVtYmVyRm9yKG9wdGlvbnMsIGkpIHsKICAgIHJldHVybiBTdHJpbmcob3B0aW9ucy5saW5lTnVtYmVyRm9ybWF0dGVyKGkgKyBvcHRpb25zLmZpcnN0TGluZU51bWJlcikpCiAgfQoKICAvLyBBIFBvcyBpbnN0YW5jZSByZXByZXNlbnRzIGEgcG9zaXRpb24gd2l0aGluIHRoZSB0ZXh0LgogIGZ1bmN0aW9uIFBvcyhsaW5lLCBjaCwgc3RpY2t5KSB7CiAgICBpZiAoIHN0aWNreSA9PT0gdm9pZCAwICkgc3RpY2t5ID0gbnVsbDsKCiAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgUG9zKSkgeyByZXR1cm4gbmV3IFBvcyhsaW5lLCBjaCwgc3RpY2t5KSB9CiAgICB0aGlzLmxpbmUgPSBsaW5lOwogICAgdGhpcy5jaCA9IGNoOwogICAgdGhpcy5zdGlja3kgPSBzdGlja3k7CiAgfQoKICAvLyBDb21wYXJlIHR3byBwb3NpdGlvbnMsIHJldHVybiAwIGlmIHRoZXkgYXJlIHRoZSBzYW1lLCBhIG5lZ2F0aXZlCiAgLy8gbnVtYmVyIHdoZW4gYSBpcyBsZXNzLCBhbmQgYSBwb3NpdGl2ZSBudW1iZXIgb3RoZXJ3aXNlLgogIGZ1bmN0aW9uIGNtcChhLCBiKSB7IHJldHVybiBhLmxpbmUgLSBiLmxpbmUgfHwgYS5jaCAtIGIuY2ggfQoKICBmdW5jdGlvbiBlcXVhbEN1cnNvclBvcyhhLCBiKSB7IHJldHVybiBhLnN0aWNreSA9PSBiLnN0aWNreSAmJiBjbXAoYSwgYikgPT0gMCB9CgogIGZ1bmN0aW9uIGNvcHlQb3MoeCkge3JldHVybiBQb3MoeC5saW5lLCB4LmNoKX0KICBmdW5jdGlvbiBtYXhQb3MoYSwgYikgeyByZXR1cm4gY21wKGEsIGIpIDwgMCA/IGIgOiBhIH0KICBmdW5jdGlvbiBtaW5Qb3MoYSwgYikgeyByZXR1cm4gY21wKGEsIGIpIDwgMCA/IGEgOiBiIH0KCiAgLy8gTW9zdCBvZiB0aGUgZXh0ZXJuYWwgQVBJIGNsaXBzIGdpdmVuIHBvc2l0aW9ucyB0byBtYWtlIHN1cmUgdGhleQogIC8vIGFjdHVhbGx5IGV4aXN0IHdpdGhpbiB0aGUgZG9jdW1lbnQuCiAgZnVuY3Rpb24gY2xpcExpbmUoZG9jLCBuKSB7cmV0dXJuIE1hdGgubWF4KGRvYy5maXJzdCwgTWF0aC5taW4obiwgZG9jLmZpcnN0ICsgZG9jLnNpemUgLSAxKSl9CiAgZnVuY3Rpb24gY2xpcFBvcyhkb2MsIHBvcykgewogICAgaWYgKHBvcy5saW5lIDwgZG9jLmZpcnN0KSB7IHJldHVybiBQb3MoZG9jLmZpcnN0LCAwKSB9CiAgICB2YXIgbGFzdCA9IGRvYy5maXJzdCArIGRvYy5zaXplIC0gMTsKICAgIGlmIChwb3MubGluZSA+IGxhc3QpIHsgcmV0dXJuIFBvcyhsYXN0LCBnZXRMaW5lKGRvYywgbGFzdCkudGV4dC5sZW5ndGgpIH0KICAgIHJldHVybiBjbGlwVG9MZW4ocG9zLCBnZXRMaW5lKGRvYywgcG9zLmxpbmUpLnRleHQubGVuZ3RoKQogIH0KICBmdW5jdGlvbiBjbGlwVG9MZW4ocG9zLCBsaW5lbGVuKSB7CiAgICB2YXIgY2ggPSBwb3MuY2g7CiAgICBpZiAoY2ggPT0gbnVsbCB8fCBjaCA+IGxpbmVsZW4pIHsgcmV0dXJuIFBvcyhwb3MubGluZSwgbGluZWxlbikgfQogICAgZWxzZSBpZiAoY2ggPCAwKSB7IHJldHVybiBQb3MocG9zLmxpbmUsIDApIH0KICAgIGVsc2UgeyByZXR1cm4gcG9zIH0KICB9CiAgZnVuY3Rpb24gY2xpcFBvc0FycmF5KGRvYywgYXJyYXkpIHsKICAgIHZhciBvdXQgPSBbXTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJyYXkubGVuZ3RoOyBpKyspIHsgb3V0W2ldID0gY2xpcFBvcyhkb2MsIGFycmF5W2ldKTsgfQogICAgcmV0dXJuIG91dAogIH0KCiAgdmFyIFNhdmVkQ29udGV4dCA9IGZ1bmN0aW9uKHN0YXRlLCBsb29rQWhlYWQpIHsKICAgIHRoaXMuc3RhdGUgPSBzdGF0ZTsKICAgIHRoaXMubG9va0FoZWFkID0gbG9va0FoZWFkOwogIH07CgogIHZhciBDb250ZXh0ID0gZnVuY3Rpb24oZG9jLCBzdGF0ZSwgbGluZSwgbG9va0FoZWFkKSB7CiAgICB0aGlzLnN0YXRlID0gc3RhdGU7CiAgICB0aGlzLmRvYyA9IGRvYzsKICAgIHRoaXMubGluZSA9IGxpbmU7CiAgICB0aGlzLm1heExvb2tBaGVhZCA9IGxvb2tBaGVhZCB8fCAwOwogICAgdGhpcy5iYXNlVG9rZW5zID0gbnVsbDsKICAgIHRoaXMuYmFzZVRva2VuUG9zID0gMTsKICB9OwoKICBDb250ZXh0LnByb3RvdHlwZS5sb29rQWhlYWQgPSBmdW5jdGlvbiAobikgewogICAgdmFyIGxpbmUgPSB0aGlzLmRvYy5nZXRMaW5lKHRoaXMubGluZSArIG4pOwogICAgaWYgKGxpbmUgIT0gbnVsbCAmJiBuID4gdGhpcy5tYXhMb29rQWhlYWQpIHsgdGhpcy5tYXhMb29rQWhlYWQgPSBuOyB9CiAgICByZXR1cm4gbGluZQogIH07CgogIENvbnRleHQucHJvdG90eXBlLmJhc2VUb2tlbiA9IGZ1bmN0aW9uIChuKSB7CiAgICAgIHZhciB0aGlzJDEgPSB0aGlzOwoKICAgIGlmICghdGhpcy5iYXNlVG9rZW5zKSB7IHJldHVybiBudWxsIH0KICAgIHdoaWxlICh0aGlzLmJhc2VUb2tlbnNbdGhpcy5iYXNlVG9rZW5Qb3NdIDw9IG4pCiAgICAgIHsgdGhpcyQxLmJhc2VUb2tlblBvcyArPSAyOyB9CiAgICB2YXIgdHlwZSA9IHRoaXMuYmFzZVRva2Vuc1t0aGlzLmJhc2VUb2tlblBvcyArIDFdOwogICAgcmV0dXJuIHt0eXBlOiB0eXBlICYmIHR5cGUucmVwbGFjZSgvKCB8XilvdmVybGF5IC4qLywgIiIpLAogICAgICAgICAgICBzaXplOiB0aGlzLmJhc2VUb2tlbnNbdGhpcy5iYXNlVG9rZW5Qb3NdIC0gbn0KICB9OwoKICBDb250ZXh0LnByb3RvdHlwZS5uZXh0TGluZSA9IGZ1bmN0aW9uICgpIHsKICAgIHRoaXMubGluZSsrOwogICAgaWYgKHRoaXMubWF4TG9va0FoZWFkID4gMCkgeyB0aGlzLm1heExvb2tBaGVhZC0tOyB9CiAgfTsKCiAgQ29udGV4dC5mcm9tU2F2ZWQgPSBmdW5jdGlvbiAoZG9jLCBzYXZlZCwgbGluZSkgewogICAgaWYgKHNhdmVkIGluc3RhbmNlb2YgU2F2ZWRDb250ZXh0KQogICAgICB7IHJldHVybiBuZXcgQ29udGV4dChkb2MsIGNvcHlTdGF0ZShkb2MubW9kZSwgc2F2ZWQuc3RhdGUpLCBsaW5lLCBzYXZlZC5sb29rQWhlYWQpIH0KICAgIGVsc2UKICAgICAgeyByZXR1cm4gbmV3IENvbnRleHQoZG9jLCBjb3B5U3RhdGUoZG9jLm1vZGUsIHNhdmVkKSwgbGluZSkgfQogIH07CgogIENvbnRleHQucHJvdG90eXBlLnNhdmUgPSBmdW5jdGlvbiAoY29weSkgewogICAgdmFyIHN0YXRlID0gY29weSAhPT0gZmFsc2UgPyBjb3B5U3RhdGUodGhpcy5kb2MubW9kZSwgdGhpcy5zdGF0ZSkgOiB0aGlzLnN0YXRlOwogICAgcmV0dXJuIHRoaXMubWF4TG9va0FoZWFkID4gMCA/IG5ldyBTYXZlZENvbnRleHQoc3RhdGUsIHRoaXMubWF4TG9va0FoZWFkKSA6IHN0YXRlCiAgfTsKCgogIC8vIENvbXB1dGUgYSBzdHlsZSBhcnJheSAoYW4gYXJyYXkgc3RhcnRpbmcgd2l0aCBhIG1vZGUgZ2VuZXJhdGlvbgogIC8vIC0tIGZvciBpbnZhbGlkYXRpb24gLS0gZm9sbG93ZWQgYnkgcGFpcnMgb2YgZW5kIHBvc2l0aW9ucyBhbmQKICAvLyBzdHlsZSBzdHJpbmdzKSwgd2hpY2ggaXMgdXNlZCB0byBoaWdobGlnaHQgdGhlIHRva2VucyBvbiB0aGUKICAvLyBsaW5lLgogIGZ1bmN0aW9uIGhpZ2hsaWdodExpbmUoY20sIGxpbmUsIGNvbnRleHQsIGZvcmNlVG9FbmQpIHsKICAgIC8vIEEgc3R5bGVzIGFycmF5IGFsd2F5cyBzdGFydHMgd2l0aCBhIG51bWJlciBpZGVudGlmeWluZyB0aGUKICAgIC8vIG1vZGUvb3ZlcmxheXMgdGhhdCBpdCBpcyBiYXNlZCBvbiAoZm9yIGVhc3kgaW52YWxpZGF0aW9uKS4KICAgIHZhciBzdCA9IFtjbS5zdGF0ZS5tb2RlR2VuXSwgbGluZUNsYXNzZXMgPSB7fTsKICAgIC8vIENvbXB1dGUgdGhlIGJhc2UgYXJyYXkgb2Ygc3R5bGVzCiAgICBydW5Nb2RlKGNtLCBsaW5lLnRleHQsIGNtLmRvYy5tb2RlLCBjb250ZXh0LCBmdW5jdGlvbiAoZW5kLCBzdHlsZSkgeyByZXR1cm4gc3QucHVzaChlbmQsIHN0eWxlKTsgfSwKICAgICAgICAgICAgbGluZUNsYXNzZXMsIGZvcmNlVG9FbmQpOwogICAgdmFyIHN0YXRlID0gY29udGV4dC5zdGF0ZTsKCiAgICAvLyBSdW4gb3ZlcmxheXMsIGFkanVzdCBzdHlsZSBhcnJheS4KICAgIHZhciBsb29wID0gZnVuY3Rpb24gKCBvICkgewogICAgICBjb250ZXh0LmJhc2VUb2tlbnMgPSBzdDsKICAgICAgdmFyIG92ZXJsYXkgPSBjbS5zdGF0ZS5vdmVybGF5c1tvXSwgaSA9IDEsIGF0ID0gMDsKICAgICAgY29udGV4dC5zdGF0ZSA9IHRydWU7CiAgICAgIHJ1bk1vZGUoY20sIGxpbmUudGV4dCwgb3ZlcmxheS5tb2RlLCBjb250ZXh0LCBmdW5jdGlvbiAoZW5kLCBzdHlsZSkgewogICAgICAgIHZhciBzdGFydCA9IGk7CiAgICAgICAgLy8gRW5zdXJlIHRoZXJlJ3MgYSB0b2tlbiBlbmQgYXQgdGhlIGN1cnJlbnQgcG9zaXRpb24sIGFuZCB0aGF0IGkgcG9pbnRzIGF0IGl0CiAgICAgICAgd2hpbGUgKGF0IDwgZW5kKSB7CiAgICAgICAgICB2YXIgaV9lbmQgPSBzdFtpXTsKICAgICAgICAgIGlmIChpX2VuZCA+IGVuZCkKICAgICAgICAgICAgeyBzdC5zcGxpY2UoaSwgMSwgZW5kLCBzdFtpKzFdLCBpX2VuZCk7IH0KICAgICAgICAgIGkgKz0gMjsKICAgICAgICAgIGF0ID0gTWF0aC5taW4oZW5kLCBpX2VuZCk7CiAgICAgICAgfQogICAgICAgIGlmICghc3R5bGUpIHsgcmV0dXJuIH0KICAgICAgICBpZiAob3ZlcmxheS5vcGFxdWUpIHsKICAgICAgICAgIHN0LnNwbGljZShzdGFydCwgaSAtIHN0YXJ0LCBlbmQsICJvdmVybGF5ICIgKyBzdHlsZSk7CiAgICAgICAgICBpID0gc3RhcnQgKyAyOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmb3IgKDsgc3RhcnQgPCBpOyBzdGFydCArPSAyKSB7CiAgICAgICAgICAgIHZhciBjdXIgPSBzdFtzdGFydCsxXTsKICAgICAgICAgICAgc3Rbc3RhcnQrMV0gPSAoY3VyID8gY3VyICsgIiAiIDogIiIpICsgIm92ZXJsYXkgIiArIHN0eWxlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwgbGluZUNsYXNzZXMpOwogICAgICBjb250ZXh0LnN0YXRlID0gc3RhdGU7CiAgICAgIGNvbnRleHQuYmFzZVRva2VucyA9IG51bGw7CiAgICAgIGNvbnRleHQuYmFzZVRva2VuUG9zID0gMTsKICAgIH07CgogICAgZm9yICh2YXIgbyA9IDA7IG8gPCBjbS5zdGF0ZS5vdmVybGF5cy5sZW5ndGg7ICsrbykgbG9vcCggbyApOwoKICAgIHJldHVybiB7c3R5bGVzOiBzdCwgY2xhc3NlczogbGluZUNsYXNzZXMuYmdDbGFzcyB8fCBsaW5lQ2xhc3Nlcy50ZXh0Q2xhc3MgPyBsaW5lQ2xhc3NlcyA6IG51bGx9CiAgfQoKICBmdW5jdGlvbiBnZXRMaW5lU3R5bGVzKGNtLCBsaW5lLCB1cGRhdGVGcm9udGllcikgewogICAgaWYgKCFsaW5lLnN0eWxlcyB8fCBsaW5lLnN0eWxlc1swXSAhPSBjbS5zdGF0ZS5tb2RlR2VuKSB7CiAgICAgIHZhciBjb250ZXh0ID0gZ2V0Q29udGV4dEJlZm9yZShjbSwgbGluZU5vKGxpbmUpKTsKICAgICAgdmFyIHJlc2V0U3RhdGUgPSBsaW5lLnRleHQubGVuZ3RoID4gY20ub3B0aW9ucy5tYXhIaWdobGlnaHRMZW5ndGggJiYgY29weVN0YXRlKGNtLmRvYy5tb2RlLCBjb250ZXh0LnN0YXRlKTsKICAgICAgdmFyIHJlc3VsdCA9IGhpZ2hsaWdodExpbmUoY20sIGxpbmUsIGNvbnRleHQpOwogICAgICBpZiAocmVzZXRTdGF0ZSkgeyBjb250ZXh0LnN0YXRlID0gcmVzZXRTdGF0ZTsgfQogICAgICBsaW5lLnN0YXRlQWZ0ZXIgPSBjb250ZXh0LnNhdmUoIXJlc2V0U3RhdGUpOwogICAgICBsaW5lLnN0eWxlcyA9IHJlc3VsdC5zdHlsZXM7CiAgICAgIGlmIChyZXN1bHQuY2xhc3NlcykgeyBsaW5lLnN0eWxlQ2xhc3NlcyA9IHJlc3VsdC5jbGFzc2VzOyB9CiAgICAgIGVsc2UgaWYgKGxpbmUuc3R5bGVDbGFzc2VzKSB7IGxpbmUuc3R5bGVDbGFzc2VzID0gbnVsbDsgfQogICAgICBpZiAodXBkYXRlRnJvbnRpZXIgPT09IGNtLmRvYy5oaWdobGlnaHRGcm9udGllcikKICAgICAgICB7IGNtLmRvYy5tb2RlRnJvbnRpZXIgPSBNYXRoLm1heChjbS5kb2MubW9kZUZyb250aWVyLCArK2NtLmRvYy5oaWdobGlnaHRGcm9udGllcik7IH0KICAgIH0KICAgIHJldHVybiBsaW5lLnN0eWxlcwogIH0KCiAgZnVuY3Rpb24gZ2V0Q29udGV4dEJlZm9yZShjbSwgbiwgcHJlY2lzZSkgewogICAgdmFyIGRvYyA9IGNtLmRvYywgZGlzcGxheSA9IGNtLmRpc3BsYXk7CiAgICBpZiAoIWRvYy5tb2RlLnN0YXJ0U3RhdGUpIHsgcmV0dXJuIG5ldyBDb250ZXh0KGRvYywgdHJ1ZSwgbikgfQogICAgdmFyIHN0YXJ0ID0gZmluZFN0YXJ0TGluZShjbSwgbiwgcHJlY2lzZSk7CiAgICB2YXIgc2F2ZWQgPSBzdGFydCA+IGRvYy5maXJzdCAmJiBnZXRMaW5lKGRvYywgc3RhcnQgLSAxKS5zdGF0ZUFmdGVyOwogICAgdmFyIGNvbnRleHQgPSBzYXZlZCA/IENvbnRleHQuZnJvbVNhdmVkKGRvYywgc2F2ZWQsIHN0YXJ0KSA6IG5ldyBDb250ZXh0KGRvYywgc3RhcnRTdGF0ZShkb2MubW9kZSksIHN0YXJ0KTsKCiAgICBkb2MuaXRlcihzdGFydCwgbiwgZnVuY3Rpb24gKGxpbmUpIHsKICAgICAgcHJvY2Vzc0xpbmUoY20sIGxpbmUudGV4dCwgY29udGV4dCk7CiAgICAgIHZhciBwb3MgPSBjb250ZXh0LmxpbmU7CiAgICAgIGxpbmUuc3RhdGVBZnRlciA9IHBvcyA9PSBuIC0gMSB8fCBwb3MgJSA1ID09IDAgfHwgcG9zID49IGRpc3BsYXkudmlld0Zyb20gJiYgcG9zIDwgZGlzcGxheS52aWV3VG8gPyBjb250ZXh0LnNhdmUoKSA6IG51bGw7CiAgICAgIGNvbnRleHQubmV4dExpbmUoKTsKICAgIH0pOwogICAgaWYgKHByZWNpc2UpIHsgZG9jLm1vZGVGcm9udGllciA9IGNvbnRleHQubGluZTsgfQogICAgcmV0dXJuIGNvbnRleHQKICB9CgogIC8vIExpZ2h0d2VpZ2h0IGZvcm0gb2YgaGlnaGxpZ2h0IC0tIHByb2NlZWQgb3ZlciB0aGlzIGxpbmUgYW5kCiAgLy8gdXBkYXRlIHN0YXRlLCBidXQgZG9uJ3Qgc2F2ZSBhIHN0eWxlIGFycmF5LiBVc2VkIGZvciBsaW5lcyB0aGF0CiAgLy8gYXJlbid0IGN1cnJlbnRseSB2aXNpYmxlLgogIGZ1bmN0aW9uIHByb2Nlc3NMaW5lKGNtLCB0ZXh0LCBjb250ZXh0LCBzdGFydEF0KSB7CiAgICB2YXIgbW9kZSA9IGNtLmRvYy5tb2RlOwogICAgdmFyIHN0cmVhbSA9IG5ldyBTdHJpbmdTdHJlYW0odGV4dCwgY20ub3B0aW9ucy50YWJTaXplLCBjb250ZXh0KTsKICAgIHN0cmVhbS5zdGFydCA9IHN0cmVhbS5wb3MgPSBzdGFydEF0IHx8IDA7CiAgICBpZiAodGV4dCA9PSAiIikgeyBjYWxsQmxhbmtMaW5lKG1vZGUsIGNvbnRleHQuc3RhdGUpOyB9CiAgICB3aGlsZSAoIXN0cmVhbS5lb2woKSkgewogICAgICByZWFkVG9rZW4obW9kZSwgc3RyZWFtLCBjb250ZXh0LnN0YXRlKTsKICAgICAgc3RyZWFtLnN0YXJ0ID0gc3RyZWFtLnBvczsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGNhbGxCbGFua0xpbmUobW9kZSwgc3RhdGUpIHsKICAgIGlmIChtb2RlLmJsYW5rTGluZSkgeyByZXR1cm4gbW9kZS5ibGFua0xpbmUoc3RhdGUpIH0KICAgIGlmICghbW9kZS5pbm5lck1vZGUpIHsgcmV0dXJuIH0KICAgIHZhciBpbm5lciA9IGlubmVyTW9kZShtb2RlLCBzdGF0ZSk7CiAgICBpZiAoaW5uZXIubW9kZS5ibGFua0xpbmUpIHsgcmV0dXJuIGlubmVyLm1vZGUuYmxhbmtMaW5lKGlubmVyLnN0YXRlKSB9CiAgfQoKICBmdW5jdGlvbiByZWFkVG9rZW4obW9kZSwgc3RyZWFtLCBzdGF0ZSwgaW5uZXIpIHsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgMTA7IGkrKykgewogICAgICBpZiAoaW5uZXIpIHsgaW5uZXJbMF0gPSBpbm5lck1vZGUobW9kZSwgc3RhdGUpLm1vZGU7IH0KICAgICAgdmFyIHN0eWxlID0gbW9kZS50b2tlbihzdHJlYW0sIHN0YXRlKTsKICAgICAgaWYgKHN0cmVhbS5wb3MgPiBzdHJlYW0uc3RhcnQpIHsgcmV0dXJuIHN0eWxlIH0KICAgIH0KICAgIHRocm93IG5ldyBFcnJvcigiTW9kZSAiICsgbW9kZS5uYW1lICsgIiBmYWlsZWQgdG8gYWR2YW5jZSBzdHJlYW0uIikKICB9CgogIHZhciBUb2tlbiA9IGZ1bmN0aW9uKHN0cmVhbSwgdHlwZSwgc3RhdGUpIHsKICAgIHRoaXMuc3RhcnQgPSBzdHJlYW0uc3RhcnQ7IHRoaXMuZW5kID0gc3RyZWFtLnBvczsKICAgIHRoaXMuc3RyaW5nID0gc3RyZWFtLmN1cnJlbnQoKTsKICAgIHRoaXMudHlwZSA9IHR5cGUgfHwgbnVsbDsKICAgIHRoaXMuc3RhdGUgPSBzdGF0ZTsKICB9OwoKICAvLyBVdGlsaXR5IGZvciBnZXRUb2tlbkF0IGFuZCBnZXRMaW5lVG9rZW5zCiAgZnVuY3Rpb24gdGFrZVRva2VuKGNtLCBwb3MsIHByZWNpc2UsIGFzQXJyYXkpIHsKICAgIHZhciBkb2MgPSBjbS5kb2MsIG1vZGUgPSBkb2MubW9kZSwgc3R5bGU7CiAgICBwb3MgPSBjbGlwUG9zKGRvYywgcG9zKTsKICAgIHZhciBsaW5lID0gZ2V0TGluZShkb2MsIHBvcy5saW5lKSwgY29udGV4dCA9IGdldENvbnRleHRCZWZvcmUoY20sIHBvcy5saW5lLCBwcmVjaXNlKTsKICAgIHZhciBzdHJlYW0gPSBuZXcgU3RyaW5nU3RyZWFtKGxpbmUudGV4dCwgY20ub3B0aW9ucy50YWJTaXplLCBjb250ZXh0KSwgdG9rZW5zOwogICAgaWYgKGFzQXJyYXkpIHsgdG9rZW5zID0gW107IH0KICAgIHdoaWxlICgoYXNBcnJheSB8fCBzdHJlYW0ucG9zIDwgcG9zLmNoKSAmJiAhc3RyZWFtLmVvbCgpKSB7CiAgICAgIHN0cmVhbS5zdGFydCA9IHN0cmVhbS5wb3M7CiAgICAgIHN0eWxlID0gcmVhZFRva2VuKG1vZGUsIHN0cmVhbSwgY29udGV4dC5zdGF0ZSk7CiAgICAgIGlmIChhc0FycmF5KSB7IHRva2Vucy5wdXNoKG5ldyBUb2tlbihzdHJlYW0sIHN0eWxlLCBjb3B5U3RhdGUoZG9jLm1vZGUsIGNvbnRleHQuc3RhdGUpKSk7IH0KICAgIH0KICAgIHJldHVybiBhc0FycmF5ID8gdG9rZW5zIDogbmV3IFRva2VuKHN0cmVhbSwgc3R5bGUsIGNvbnRleHQuc3RhdGUpCiAgfQoKICBmdW5jdGlvbiBleHRyYWN0TGluZUNsYXNzZXModHlwZSwgb3V0cHV0KSB7CiAgICBpZiAodHlwZSkgeyBmb3IgKDs7KSB7CiAgICAgIHZhciBsaW5lQ2xhc3MgPSB0eXBlLm1hdGNoKC8oPzpefFxzKylsaW5lLShiYWNrZ3JvdW5kLSk/KFxTKykvKTsKICAgICAgaWYgKCFsaW5lQ2xhc3MpIHsgYnJlYWsgfQogICAgICB0eXBlID0gdHlwZS5zbGljZSgwLCBsaW5lQ2xhc3MuaW5kZXgpICsgdHlwZS5zbGljZShsaW5lQ2xhc3MuaW5kZXggKyBsaW5lQ2xhc3NbMF0ubGVuZ3RoKTsKICAgICAgdmFyIHByb3AgPSBsaW5lQ2xhc3NbMV0gPyAiYmdDbGFzcyIgOiAidGV4dENsYXNzIjsKICAgICAgaWYgKG91dHB1dFtwcm9wXSA9PSBudWxsKQogICAgICAgIHsgb3V0cHV0W3Byb3BdID0gbGluZUNsYXNzWzJdOyB9CiAgICAgIGVsc2UgaWYgKCEobmV3IFJlZ0V4cCgiKD86XnxccykiICsgbGluZUNsYXNzWzJdICsgIig/OiR8XHMpIikpLnRlc3Qob3V0cHV0W3Byb3BdKSkKICAgICAgICB7IG91dHB1dFtwcm9wXSArPSAiICIgKyBsaW5lQ2xhc3NbMl07IH0KICAgIH0gfQogICAgcmV0dXJuIHR5cGUKICB9CgogIC8vIFJ1biB0aGUgZ2l2ZW4gbW9kZSdzIHBhcnNlciBvdmVyIGEgbGluZSwgY2FsbGluZyBmIGZvciBlYWNoIHRva2VuLgogIGZ1bmN0aW9uIHJ1bk1vZGUoY20sIHRleHQsIG1vZGUsIGNvbnRleHQsIGYsIGxpbmVDbGFzc2VzLCBmb3JjZVRvRW5kKSB7CiAgICB2YXIgZmxhdHRlblNwYW5zID0gbW9kZS5mbGF0dGVuU3BhbnM7CiAgICBpZiAoZmxhdHRlblNwYW5zID09IG51bGwpIHsgZmxhdHRlblNwYW5zID0gY20ub3B0aW9ucy5mbGF0dGVuU3BhbnM7IH0KICAgIHZhciBjdXJTdGFydCA9IDAsIGN1clN0eWxlID0gbnVsbDsKICAgIHZhciBzdHJlYW0gPSBuZXcgU3RyaW5nU3RyZWFtKHRleHQsIGNtLm9wdGlvbnMudGFiU2l6ZSwgY29udGV4dCksIHN0eWxlOwogICAgdmFyIGlubmVyID0gY20ub3B0aW9ucy5hZGRNb2RlQ2xhc3MgJiYgW251bGxdOwogICAgaWYgKHRleHQgPT0gIiIpIHsgZXh0cmFjdExpbmVDbGFzc2VzKGNhbGxCbGFua0xpbmUobW9kZSwgY29udGV4dC5zdGF0ZSksIGxpbmVDbGFzc2VzKTsgfQogICAgd2hpbGUgKCFzdHJlYW0uZW9sKCkpIHsKICAgICAgaWYgKHN0cmVhbS5wb3MgPiBjbS5vcHRpb25zLm1heEhpZ2hsaWdodExlbmd0aCkgewogICAgICAgIGZsYXR0ZW5TcGFucyA9IGZhbHNlOwogICAgICAgIGlmIChmb3JjZVRvRW5kKSB7IHByb2Nlc3NMaW5lKGNtLCB0ZXh0LCBjb250ZXh0LCBzdHJlYW0ucG9zKTsgfQogICAgICAgIHN0cmVhbS5wb3MgPSB0ZXh0Lmxlbmd0aDsKICAgICAgICBzdHlsZSA9IG51bGw7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc3R5bGUgPSBleHRyYWN0TGluZUNsYXNzZXMocmVhZFRva2VuKG1vZGUsIHN0cmVhbSwgY29udGV4dC5zdGF0ZSwgaW5uZXIpLCBsaW5lQ2xhc3Nlcyk7CiAgICAgIH0KICAgICAgaWYgKGlubmVyKSB7CiAgICAgICAgdmFyIG1OYW1lID0gaW5uZXJbMF0ubmFtZTsKICAgICAgICBpZiAobU5hbWUpIHsgc3R5bGUgPSAibS0iICsgKHN0eWxlID8gbU5hbWUgKyAiICIgKyBzdHlsZSA6IG1OYW1lKTsgfQogICAgICB9CiAgICAgIGlmICghZmxhdHRlblNwYW5zIHx8IGN1clN0eWxlICE9IHN0eWxlKSB7CiAgICAgICAgd2hpbGUgKGN1clN0YXJ0IDwgc3RyZWFtLnN0YXJ0KSB7CiAgICAgICAgICBjdXJTdGFydCA9IE1hdGgubWluKHN0cmVhbS5zdGFydCwgY3VyU3RhcnQgKyA1MDAwKTsKICAgICAgICAgIGYoY3VyU3RhcnQsIGN1clN0eWxlKTsKICAgICAgICB9CiAgICAgICAgY3VyU3R5bGUgPSBzdHlsZTsKICAgICAgfQogICAgICBzdHJlYW0uc3RhcnQgPSBzdHJlYW0ucG9zOwogICAgfQogICAgd2hpbGUgKGN1clN0YXJ0IDwgc3RyZWFtLnBvcykgewogICAgICAvLyBXZWJraXQgc2VlbXMgdG8gcmVmdXNlIHRvIHJlbmRlciB0ZXh0IG5vZGVzIGxvbmdlciB0aGFuIDU3NDQ0CiAgICAgIC8vIGNoYXJhY3RlcnMsIGFuZCByZXR1cm5zIGluYWNjdXJhdGUgbWVhc3VyZW1lbnRzIGluIG5vZGVzCiAgICAgIC8vIHN0YXJ0aW5nIGFyb3VuZCA1MDAwIGNoYXJzLgogICAgICB2YXIgcG9zID0gTWF0aC5taW4oc3RyZWFtLnBvcywgY3VyU3RhcnQgKyA1MDAwKTsKICAgICAgZihwb3MsIGN1clN0eWxlKTsKICAgICAgY3VyU3RhcnQgPSBwb3M7CiAgICB9CiAgfQoKICAvLyBGaW5kcyB0aGUgbGluZSB0byBzdGFydCB3aXRoIHdoZW4gc3RhcnRpbmcgYSBwYXJzZS4gVHJpZXMgdG8KICAvLyBmaW5kIGEgbGluZSB3aXRoIGEgc3RhdGVBZnRlciwgc28gdGhhdCBpdCBjYW4gc3RhcnQgd2l0aCBhCiAgLy8gdmFsaWQgc3RhdGUuIElmIHRoYXQgZmFpbHMsIGl0IHJldHVybnMgdGhlIGxpbmUgd2l0aCB0aGUKICAvLyBzbWFsbGVzdCBpbmRlbnRhdGlvbiwgd2hpY2ggdGVuZHMgdG8gbmVlZCB0aGUgbGVhc3QgY29udGV4dCB0bwogIC8vIHBhcnNlIGNvcnJlY3RseS4KICBmdW5jdGlvbiBmaW5kU3RhcnRMaW5lKGNtLCBuLCBwcmVjaXNlKSB7CiAgICB2YXIgbWluaW5kZW50LCBtaW5saW5lLCBkb2MgPSBjbS5kb2M7CiAgICB2YXIgbGltID0gcHJlY2lzZSA/IC0xIDogbiAtIChjbS5kb2MubW9kZS5pbm5lck1vZGUgPyAxMDAwIDogMTAwKTsKICAgIGZvciAodmFyIHNlYXJjaCA9IG47IHNlYXJjaCA+IGxpbTsgLS1zZWFyY2gpIHsKICAgICAgaWYgKHNlYXJjaCA8PSBkb2MuZmlyc3QpIHsgcmV0dXJuIGRvYy5maXJzdCB9CiAgICAgIHZhciBsaW5lID0gZ2V0TGluZShkb2MsIHNlYXJjaCAtIDEpLCBhZnRlciA9IGxpbmUuc3RhdGVBZnRlcjsKICAgICAgaWYgKGFmdGVyICYmICghcHJlY2lzZSB8fCBzZWFyY2ggKyAoYWZ0ZXIgaW5zdGFuY2VvZiBTYXZlZENvbnRleHQgPyBhZnRlci5sb29rQWhlYWQgOiAwKSA8PSBkb2MubW9kZUZyb250aWVyKSkKICAgICAgICB7IHJldHVybiBzZWFyY2ggfQogICAgICB2YXIgaW5kZW50ZWQgPSBjb3VudENvbHVtbihsaW5lLnRleHQsIG51bGwsIGNtLm9wdGlvbnMudGFiU2l6ZSk7CiAgICAgIGlmIChtaW5saW5lID09IG51bGwgfHwgbWluaW5kZW50ID4gaW5kZW50ZWQpIHsKICAgICAgICBtaW5saW5lID0gc2VhcmNoIC0gMTsKICAgICAgICBtaW5pbmRlbnQgPSBpbmRlbnRlZDsKICAgICAgfQogICAgfQogICAgcmV0dXJuIG1pbmxpbmUKICB9CgogIGZ1bmN0aW9uIHJldHJlYXRGcm9udGllcihkb2MsIG4pIHsKICAgIGRvYy5tb2RlRnJvbnRpZXIgPSBNYXRoLm1pbihkb2MubW9kZUZyb250aWVyLCBuKTsKICAgIGlmIChkb2MuaGlnaGxpZ2h0RnJvbnRpZXIgPCBuIC0gMTApIHsgcmV0dXJuIH0KICAgIHZhciBzdGFydCA9IGRvYy5maXJzdDsKICAgIGZvciAodmFyIGxpbmUgPSBuIC0gMTsgbGluZSA+IHN0YXJ0OyBsaW5lLS0pIHsKICAgICAgdmFyIHNhdmVkID0gZ2V0TGluZShkb2MsIGxpbmUpLnN0YXRlQWZ0ZXI7CiAgICAgIC8vIGNoYW5nZSBpcyBvbiAzCiAgICAgIC8vIHN0YXRlIG9uIGxpbmUgMSBsb29rZWQgYWhlYWQgMiAtLSBzbyBzYXcgMwogICAgICAvLyB0ZXN0IDEgKyAyIDwgMyBzaG91bGQgY292ZXIgdGhpcwogICAgICBpZiAoc2F2ZWQgJiYgKCEoc2F2ZWQgaW5zdGFuY2VvZiBTYXZlZENvbnRleHQpIHx8IGxpbmUgKyBzYXZlZC5sb29rQWhlYWQgPCBuKSkgewogICAgICAgIHN0YXJ0ID0gbGluZSArIDE7CiAgICAgICAgYnJlYWsKICAgICAgfQogICAgfQogICAgZG9jLmhpZ2hsaWdodEZyb250aWVyID0gTWF0aC5taW4oZG9jLmhpZ2hsaWdodEZyb250aWVyLCBzdGFydCk7CiAgfQoKICAvLyBPcHRpbWl6ZSBzb21lIGNvZGUgd2hlbiB0aGVzZSBmZWF0dXJlcyBhcmUgbm90IHVzZWQuCiAgdmFyIHNhd1JlYWRPbmx5U3BhbnMgPSBmYWxzZSwgc2F3Q29sbGFwc2VkU3BhbnMgPSBmYWxzZTsKCiAgZnVuY3Rpb24gc2VlUmVhZE9ubHlTcGFucygpIHsKICAgIHNhd1JlYWRPbmx5U3BhbnMgPSB0cnVlOwogIH0KCiAgZnVuY3Rpb24gc2VlQ29sbGFwc2VkU3BhbnMoKSB7CiAgICBzYXdDb2xsYXBzZWRTcGFucyA9IHRydWU7CiAgfQoKICAvLyBURVhUTUFSS0VSIFNQQU5TCgogIGZ1bmN0aW9uIE1hcmtlZFNwYW4obWFya2VyLCBmcm9tLCB0bykgewogICAgdGhpcy5tYXJrZXIgPSBtYXJrZXI7CiAgICB0aGlzLmZyb20gPSBmcm9tOyB0aGlzLnRvID0gdG87CiAgfQoKICAvLyBTZWFyY2ggYW4gYXJyYXkgb2Ygc3BhbnMgZm9yIGEgc3BhbiBtYXRjaGluZyB0aGUgZ2l2ZW4gbWFya2VyLgogIGZ1bmN0aW9uIGdldE1hcmtlZFNwYW5Gb3Ioc3BhbnMsIG1hcmtlcikgewogICAgaWYgKHNwYW5zKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgc3BhbnMubGVuZ3RoOyArK2kpIHsKICAgICAgdmFyIHNwYW4gPSBzcGFuc1tpXTsKICAgICAgaWYgKHNwYW4ubWFya2VyID09IG1hcmtlcikgeyByZXR1cm4gc3BhbiB9CiAgICB9IH0KICB9CiAgLy8gUmVtb3ZlIGEgc3BhbiBmcm9tIGFuIGFycmF5LCByZXR1cm5pbmcgdW5kZWZpbmVkIGlmIG5vIHNwYW5zIGFyZQogIC8vIGxlZnQgKHdlIGRvbid0IHN0b3JlIGFycmF5cyBmb3IgbGluZXMgd2l0aG91dCBzcGFucykuCiAgZnVuY3Rpb24gcmVtb3ZlTWFya2VkU3BhbihzcGFucywgc3BhbikgewogICAgdmFyIHI7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNwYW5zLmxlbmd0aDsgKytpKQogICAgICB7IGlmIChzcGFuc1tpXSAhPSBzcGFuKSB7IChyIHx8IChyID0gW10pKS5wdXNoKHNwYW5zW2ldKTsgfSB9CiAgICByZXR1cm4gcgogIH0KICAvLyBBZGQgYSBzcGFuIHRvIGEgbGluZS4KICBmdW5jdGlvbiBhZGRNYXJrZWRTcGFuKGxpbmUsIHNwYW4pIHsKICAgIGxpbmUubWFya2VkU3BhbnMgPSBsaW5lLm1hcmtlZFNwYW5zID8gbGluZS5tYXJrZWRTcGFucy5jb25jYXQoW3NwYW5dKSA6IFtzcGFuXTsKICAgIHNwYW4ubWFya2VyLmF0dGFjaExpbmUobGluZSk7CiAgfQoKICAvLyBVc2VkIGZvciB0aGUgYWxnb3JpdGhtIHRoYXQgYWRqdXN0cyBtYXJrZXJzIGZvciBhIGNoYW5nZSBpbiB0aGUKICAvLyBkb2N1bWVudC4gVGhlc2UgZnVuY3Rpb25zIGN1dCBhbiBhcnJheSBvZiBzcGFucyBhdCBhIGdpdmVuCiAgLy8gY2hhcmFjdGVyIHBvc2l0aW9uLCByZXR1cm5pbmcgYW4gYXJyYXkgb2YgcmVtYWluaW5nIGNodW5rcyAob3IKICAvLyB1bmRlZmluZWQgaWYgbm90aGluZyByZW1haW5zKS4KICBmdW5jdGlvbiBtYXJrZWRTcGFuc0JlZm9yZShvbGQsIHN0YXJ0Q2gsIGlzSW5zZXJ0KSB7CiAgICB2YXIgbnc7CiAgICBpZiAob2xkKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgb2xkLmxlbmd0aDsgKytpKSB7CiAgICAgIHZhciBzcGFuID0gb2xkW2ldLCBtYXJrZXIgPSBzcGFuLm1hcmtlcjsKICAgICAgdmFyIHN0YXJ0c0JlZm9yZSA9IHNwYW4uZnJvbSA9PSBudWxsIHx8IChtYXJrZXIuaW5jbHVzaXZlTGVmdCA/IHNwYW4uZnJvbSA8PSBzdGFydENoIDogc3Bhbi5mcm9tIDwgc3RhcnRDaCk7CiAgICAgIGlmIChzdGFydHNCZWZvcmUgfHwgc3Bhbi5mcm9tID09IHN0YXJ0Q2ggJiYgbWFya2VyLnR5cGUgPT0gImJvb2ttYXJrIiAmJiAoIWlzSW5zZXJ0IHx8ICFzcGFuLm1hcmtlci5pbnNlcnRMZWZ0KSkgewogICAgICAgIHZhciBlbmRzQWZ0ZXIgPSBzcGFuLnRvID09IG51bGwgfHwgKG1hcmtlci5pbmNsdXNpdmVSaWdodCA/IHNwYW4udG8gPj0gc3RhcnRDaCA6IHNwYW4udG8gPiBzdGFydENoKQogICAgICAgIDsobncgfHwgKG53ID0gW10pKS5wdXNoKG5ldyBNYXJrZWRTcGFuKG1hcmtlciwgc3Bhbi5mcm9tLCBlbmRzQWZ0ZXIgPyBudWxsIDogc3Bhbi50bykpOwogICAgICB9CiAgICB9IH0KICAgIHJldHVybiBudwogIH0KICBmdW5jdGlvbiBtYXJrZWRTcGFuc0FmdGVyKG9sZCwgZW5kQ2gsIGlzSW5zZXJ0KSB7CiAgICB2YXIgbnc7CiAgICBpZiAob2xkKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgb2xkLmxlbmd0aDsgKytpKSB7CiAgICAgIHZhciBzcGFuID0gb2xkW2ldLCBtYXJrZXIgPSBzcGFuLm1hcmtlcjsKICAgICAgdmFyIGVuZHNBZnRlciA9IHNwYW4udG8gPT0gbnVsbCB8fCAobWFya2VyLmluY2x1c2l2ZVJpZ2h0ID8gc3Bhbi50byA+PSBlbmRDaCA6IHNwYW4udG8gPiBlbmRDaCk7CiAgICAgIGlmIChlbmRzQWZ0ZXIgfHwgc3Bhbi5mcm9tID09IGVuZENoICYmIG1hcmtlci50eXBlID09ICJib29rbWFyayIgJiYgKCFpc0luc2VydCB8fCBzcGFuLm1hcmtlci5pbnNlcnRMZWZ0KSkgewogICAgICAgIHZhciBzdGFydHNCZWZvcmUgPSBzcGFuLmZyb20gPT0gbnVsbCB8fCAobWFya2VyLmluY2x1c2l2ZUxlZnQgPyBzcGFuLmZyb20gPD0gZW5kQ2ggOiBzcGFuLmZyb20gPCBlbmRDaCkKICAgICAgICA7KG53IHx8IChudyA9IFtdKSkucHVzaChuZXcgTWFya2VkU3BhbihtYXJrZXIsIHN0YXJ0c0JlZm9yZSA/IG51bGwgOiBzcGFuLmZyb20gLSBlbmRDaCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNwYW4udG8gPT0gbnVsbCA/IG51bGwgOiBzcGFuLnRvIC0gZW5kQ2gpKTsKICAgICAgfQogICAgfSB9CiAgICByZXR1cm4gbncKICB9CgogIC8vIEdpdmVuIGEgY2hhbmdlIG9iamVjdCwgY29tcHV0ZSB0aGUgbmV3IHNldCBvZiBtYXJrZXIgc3BhbnMgdGhhdAogIC8vIGNvdmVyIHRoZSBsaW5lIGluIHdoaWNoIHRoZSBjaGFuZ2UgdG9vayBwbGFjZS4gUmVtb3ZlcyBzcGFucwogIC8vIGVudGlyZWx5IHdpdGhpbiB0aGUgY2hhbmdlLCByZWNvbm5lY3RzIHNwYW5zIGJlbG9uZ2luZyB0byB0aGUKICAvLyBzYW1lIG1hcmtlciB0aGF0IGFwcGVhciBvbiBib3RoIHNpZGVzIG9mIHRoZSBjaGFuZ2UsIGFuZCBjdXRzIG9mZgogIC8vIHNwYW5zIHBhcnRpYWxseSB3aXRoaW4gdGhlIGNoYW5nZS4gUmV0dXJucyBhbiBhcnJheSBvZiBzcGFuCiAgLy8gYXJyYXlzIHdpdGggb25lIGVsZW1lbnQgZm9yIGVhY2ggbGluZSBpbiAoYWZ0ZXIpIHRoZSBjaGFuZ2UuCiAgZnVuY3Rpb24gc3RyZXRjaFNwYW5zT3ZlckNoYW5nZShkb2MsIGNoYW5nZSkgewogICAgaWYgKGNoYW5nZS5mdWxsKSB7IHJldHVybiBudWxsIH0KICAgIHZhciBvbGRGaXJzdCA9IGlzTGluZShkb2MsIGNoYW5nZS5mcm9tLmxpbmUpICYmIGdldExpbmUoZG9jLCBjaGFuZ2UuZnJvbS5saW5lKS5tYXJrZWRTcGFuczsKICAgIHZhciBvbGRMYXN0ID0gaXNMaW5lKGRvYywgY2hhbmdlLnRvLmxpbmUpICYmIGdldExpbmUoZG9jLCBjaGFuZ2UudG8ubGluZSkubWFya2VkU3BhbnM7CiAgICBpZiAoIW9sZEZpcnN0ICYmICFvbGRMYXN0KSB7IHJldHVybiBudWxsIH0KCiAgICB2YXIgc3RhcnRDaCA9IGNoYW5nZS5mcm9tLmNoLCBlbmRDaCA9IGNoYW5nZS50by5jaCwgaXNJbnNlcnQgPSBjbXAoY2hhbmdlLmZyb20sIGNoYW5nZS50bykgPT0gMDsKICAgIC8vIEdldCB0aGUgc3BhbnMgdGhhdCAnc3RpY2sgb3V0JyBvbiBib3RoIHNpZGVzCiAgICB2YXIgZmlyc3QgPSBtYXJrZWRTcGFuc0JlZm9yZShvbGRGaXJzdCwgc3RhcnRDaCwgaXNJbnNlcnQpOwogICAgdmFyIGxhc3QgPSBtYXJrZWRTcGFuc0FmdGVyKG9sZExhc3QsIGVuZENoLCBpc0luc2VydCk7CgogICAgLy8gTmV4dCwgbWVyZ2UgdGhvc2UgdHdvIGVuZHMKICAgIHZhciBzYW1lTGluZSA9IGNoYW5nZS50ZXh0Lmxlbmd0aCA9PSAxLCBvZmZzZXQgPSBsc3QoY2hhbmdlLnRleHQpLmxlbmd0aCArIChzYW1lTGluZSA/IHN0YXJ0Q2ggOiAwKTsKICAgIGlmIChmaXJzdCkgewogICAgICAvLyBGaXggdXAgLnRvIHByb3BlcnRpZXMgb2YgZmlyc3QKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBmaXJzdC5sZW5ndGg7ICsraSkgewogICAgICAgIHZhciBzcGFuID0gZmlyc3RbaV07CiAgICAgICAgaWYgKHNwYW4udG8gPT0gbnVsbCkgewogICAgICAgICAgdmFyIGZvdW5kID0gZ2V0TWFya2VkU3BhbkZvcihsYXN0LCBzcGFuLm1hcmtlcik7CiAgICAgICAgICBpZiAoIWZvdW5kKSB7IHNwYW4udG8gPSBzdGFydENoOyB9CiAgICAgICAgICBlbHNlIGlmIChzYW1lTGluZSkgeyBzcGFuLnRvID0gZm91bmQudG8gPT0gbnVsbCA/IG51bGwgOiBmb3VuZC50byArIG9mZnNldDsgfQogICAgICAgIH0KICAgICAgfQogICAgfQogICAgaWYgKGxhc3QpIHsKICAgICAgLy8gRml4IHVwIC5mcm9tIGluIGxhc3QgKG9yIG1vdmUgdGhlbSBpbnRvIGZpcnN0IGluIGNhc2Ugb2Ygc2FtZUxpbmUpCiAgICAgIGZvciAodmFyIGkkMSA9IDA7IGkkMSA8IGxhc3QubGVuZ3RoOyArK2kkMSkgewogICAgICAgIHZhciBzcGFuJDEgPSBsYXN0W2kkMV07CiAgICAgICAgaWYgKHNwYW4kMS50byAhPSBudWxsKSB7IHNwYW4kMS50byArPSBvZmZzZXQ7IH0KICAgICAgICBpZiAoc3BhbiQxLmZyb20gPT0gbnVsbCkgewogICAgICAgICAgdmFyIGZvdW5kJDEgPSBnZXRNYXJrZWRTcGFuRm9yKGZpcnN0LCBzcGFuJDEubWFya2VyKTsKICAgICAgICAgIGlmICghZm91bmQkMSkgewogICAgICAgICAgICBzcGFuJDEuZnJvbSA9IG9mZnNldDsKICAgICAgICAgICAgaWYgKHNhbWVMaW5lKSB7IChmaXJzdCB8fCAoZmlyc3QgPSBbXSkpLnB1c2goc3BhbiQxKTsgfQogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzcGFuJDEuZnJvbSArPSBvZmZzZXQ7CiAgICAgICAgICBpZiAoc2FtZUxpbmUpIHsgKGZpcnN0IHx8IChmaXJzdCA9IFtdKSkucHVzaChzcGFuJDEpOyB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICAvLyBNYWtlIHN1cmUgd2UgZGlkbid0IGNyZWF0ZSBhbnkgemVyby1sZW5ndGggc3BhbnMKICAgIGlmIChmaXJzdCkgeyBmaXJzdCA9IGNsZWFyRW1wdHlTcGFucyhmaXJzdCk7IH0KICAgIGlmIChsYXN0ICYmIGxhc3QgIT0gZmlyc3QpIHsgbGFzdCA9IGNsZWFyRW1wdHlTcGFucyhsYXN0KTsgfQoKICAgIHZhciBuZXdNYXJrZXJzID0gW2ZpcnN0XTsKICAgIGlmICghc2FtZUxpbmUpIHsKICAgICAgLy8gRmlsbCBnYXAgd2l0aCB3aG9sZS1saW5lLXNwYW5zCiAgICAgIHZhciBnYXAgPSBjaGFuZ2UudGV4dC5sZW5ndGggLSAyLCBnYXBNYXJrZXJzOwogICAgICBpZiAoZ2FwID4gMCAmJiBmaXJzdCkKICAgICAgICB7IGZvciAodmFyIGkkMiA9IDA7IGkkMiA8IGZpcnN0Lmxlbmd0aDsgKytpJDIpCiAgICAgICAgICB7IGlmIChmaXJzdFtpJDJdLnRvID09IG51bGwpCiAgICAgICAgICAgIHsgKGdhcE1hcmtlcnMgfHwgKGdhcE1hcmtlcnMgPSBbXSkpLnB1c2gobmV3IE1hcmtlZFNwYW4oZmlyc3RbaSQyXS5tYXJrZXIsIG51bGwsIG51bGwpKTsgfSB9IH0KICAgICAgZm9yICh2YXIgaSQzID0gMDsgaSQzIDwgZ2FwOyArK2kkMykKICAgICAgICB7IG5ld01hcmtlcnMucHVzaChnYXBNYXJrZXJzKTsgfQogICAgICBuZXdNYXJrZXJzLnB1c2gobGFzdCk7CiAgICB9CiAgICByZXR1cm4gbmV3TWFya2VycwogIH0KCiAgLy8gUmVtb3ZlIHNwYW5zIHRoYXQgYXJlIGVtcHR5IGFuZCBkb24ndCBoYXZlIGEgY2xlYXJXaGVuRW1wdHkKICAvLyBvcHRpb24gb2YgZmFsc2UuCiAgZnVuY3Rpb24gY2xlYXJFbXB0eVNwYW5zKHNwYW5zKSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNwYW5zLmxlbmd0aDsgKytpKSB7CiAgICAgIHZhciBzcGFuID0gc3BhbnNbaV07CiAgICAgIGlmIChzcGFuLmZyb20gIT0gbnVsbCAmJiBzcGFuLmZyb20gPT0gc3Bhbi50byAmJiBzcGFuLm1hcmtlci5jbGVhcldoZW5FbXB0eSAhPT0gZmFsc2UpCiAgICAgICAgeyBzcGFucy5zcGxpY2UoaS0tLCAxKTsgfQogICAgfQogICAgaWYgKCFzcGFucy5sZW5ndGgpIHsgcmV0dXJuIG51bGwgfQogICAgcmV0dXJuIHNwYW5zCiAgfQoKICAvLyBVc2VkIHRvICdjbGlwJyBvdXQgcmVhZE9ubHkgcmFuZ2VzIHdoZW4gbWFraW5nIGEgY2hhbmdlLgogIGZ1bmN0aW9uIHJlbW92ZVJlYWRPbmx5UmFuZ2VzKGRvYywgZnJvbSwgdG8pIHsKICAgIHZhciBtYXJrZXJzID0gbnVsbDsKICAgIGRvYy5pdGVyKGZyb20ubGluZSwgdG8ubGluZSArIDEsIGZ1bmN0aW9uIChsaW5lKSB7CiAgICAgIGlmIChsaW5lLm1hcmtlZFNwYW5zKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgbGluZS5tYXJrZWRTcGFucy5sZW5ndGg7ICsraSkgewogICAgICAgIHZhciBtYXJrID0gbGluZS5tYXJrZWRTcGFuc1tpXS5tYXJrZXI7CiAgICAgICAgaWYgKG1hcmsucmVhZE9ubHkgJiYgKCFtYXJrZXJzIHx8IGluZGV4T2YobWFya2VycywgbWFyaykgPT0gLTEpKQogICAgICAgICAgeyAobWFya2VycyB8fCAobWFya2VycyA9IFtdKSkucHVzaChtYXJrKTsgfQogICAgICB9IH0KICAgIH0pOwogICAgaWYgKCFtYXJrZXJzKSB7IHJldHVybiBudWxsIH0KICAgIHZhciBwYXJ0cyA9IFt7ZnJvbTogZnJvbSwgdG86IHRvfV07CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IG1hcmtlcnMubGVuZ3RoOyArK2kpIHsKICAgICAgdmFyIG1rID0gbWFya2Vyc1tpXSwgbSA9IG1rLmZpbmQoMCk7CiAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgcGFydHMubGVuZ3RoOyArK2opIHsKICAgICAgICB2YXIgcCA9IHBhcnRzW2pdOwogICAgICAgIGlmIChjbXAocC50bywgbS5mcm9tKSA8IDAgfHwgY21wKHAuZnJvbSwgbS50bykgPiAwKSB7IGNvbnRpbnVlIH0KICAgICAgICB2YXIgbmV3UGFydHMgPSBbaiwgMV0sIGRmcm9tID0gY21wKHAuZnJvbSwgbS5mcm9tKSwgZHRvID0gY21wKHAudG8sIG0udG8pOwogICAgICAgIGlmIChkZnJvbSA8IDAgfHwgIW1rLmluY2x1c2l2ZUxlZnQgJiYgIWRmcm9tKQogICAgICAgICAgeyBuZXdQYXJ0cy5wdXNoKHtmcm9tOiBwLmZyb20sIHRvOiBtLmZyb219KTsgfQogICAgICAgIGlmIChkdG8gPiAwIHx8ICFtay5pbmNsdXNpdmVSaWdodCAmJiAhZHRvKQogICAgICAgICAgeyBuZXdQYXJ0cy5wdXNoKHtmcm9tOiBtLnRvLCB0bzogcC50b30pOyB9CiAgICAgICAgcGFydHMuc3BsaWNlLmFwcGx5KHBhcnRzLCBuZXdQYXJ0cyk7CiAgICAgICAgaiArPSBuZXdQYXJ0cy5sZW5ndGggLSAzOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gcGFydHMKICB9CgogIC8vIENvbm5lY3Qgb3IgZGlzY29ubmVjdCBzcGFucyBmcm9tIGEgbGluZS4KICBmdW5jdGlvbiBkZXRhY2hNYXJrZWRTcGFucyhsaW5lKSB7CiAgICB2YXIgc3BhbnMgPSBsaW5lLm1hcmtlZFNwYW5zOwogICAgaWYgKCFzcGFucykgeyByZXR1cm4gfQogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzcGFucy5sZW5ndGg7ICsraSkKICAgICAgeyBzcGFuc1tpXS5tYXJrZXIuZGV0YWNoTGluZShsaW5lKTsgfQogICAgbGluZS5tYXJrZWRTcGFucyA9IG51bGw7CiAgfQogIGZ1bmN0aW9uIGF0dGFjaE1hcmtlZFNwYW5zKGxpbmUsIHNwYW5zKSB7CiAgICBpZiAoIXNwYW5zKSB7IHJldHVybiB9CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNwYW5zLmxlbmd0aDsgKytpKQogICAgICB7IHNwYW5zW2ldLm1hcmtlci5hdHRhY2hMaW5lKGxpbmUpOyB9CiAgICBsaW5lLm1hcmtlZFNwYW5zID0gc3BhbnM7CiAgfQoKICAvLyBIZWxwZXJzIHVzZWQgd2hlbiBjb21wdXRpbmcgd2hpY2ggb3ZlcmxhcHBpbmcgY29sbGFwc2VkIHNwYW4KICAvLyBjb3VudHMgYXMgdGhlIGxhcmdlciBvbmUuCiAgZnVuY3Rpb24gZXh0cmFMZWZ0KG1hcmtlcikgeyByZXR1cm4gbWFya2VyLmluY2x1c2l2ZUxlZnQgPyAtMSA6IDAgfQogIGZ1bmN0aW9uIGV4dHJhUmlnaHQobWFya2VyKSB7IHJldHVybiBtYXJrZXIuaW5jbHVzaXZlUmlnaHQgPyAxIDogMCB9CgogIC8vIFJldHVybnMgYSBudW1iZXIgaW5kaWNhdGluZyB3aGljaCBvZiB0d28gb3ZlcmxhcHBpbmcgY29sbGFwc2VkCiAgLy8gc3BhbnMgaXMgbGFyZ2VyIChhbmQgdGh1cyBpbmNsdWRlcyB0aGUgb3RoZXIpLiBGYWxscyBiYWNrIHRvCiAgLy8gY29tcGFyaW5nIGlkcyB3aGVuIHRoZSBzcGFucyBjb3ZlciBleGFjdGx5IHRoZSBzYW1lIHJhbmdlLgogIGZ1bmN0aW9uIGNvbXBhcmVDb2xsYXBzZWRNYXJrZXJzKGEsIGIpIHsKICAgIHZhciBsZW5EaWZmID0gYS5saW5lcy5sZW5ndGggLSBiLmxpbmVzLmxlbmd0aDsKICAgIGlmIChsZW5EaWZmICE9IDApIHsgcmV0dXJuIGxlbkRpZmYgfQogICAgdmFyIGFQb3MgPSBhLmZpbmQoKSwgYlBvcyA9IGIuZmluZCgpOwogICAgdmFyIGZyb21DbXAgPSBjbXAoYVBvcy5mcm9tLCBiUG9zLmZyb20pIHx8IGV4dHJhTGVmdChhKSAtIGV4dHJhTGVmdChiKTsKICAgIGlmIChmcm9tQ21wKSB7IHJldHVybiAtZnJvbUNtcCB9CiAgICB2YXIgdG9DbXAgPSBjbXAoYVBvcy50bywgYlBvcy50bykgfHwgZXh0cmFSaWdodChhKSAtIGV4dHJhUmlnaHQoYik7CiAgICBpZiAodG9DbXApIHsgcmV0dXJuIHRvQ21wIH0KICAgIHJldHVybiBiLmlkIC0gYS5pZAogIH0KCiAgLy8gRmluZCBvdXQgd2hldGhlciBhIGxpbmUgZW5kcyBvciBzdGFydHMgaW4gYSBjb2xsYXBzZWQgc3Bhbi4gSWYKICAvLyBzbywgcmV0dXJuIHRoZSBtYXJrZXIgZm9yIHRoYXQgc3Bhbi4KICBmdW5jdGlvbiBjb2xsYXBzZWRTcGFuQXRTaWRlKGxpbmUsIHN0YXJ0KSB7CiAgICB2YXIgc3BzID0gc2F3Q29sbGFwc2VkU3BhbnMgJiYgbGluZS5tYXJrZWRTcGFucywgZm91bmQ7CiAgICBpZiAoc3BzKSB7IGZvciAodmFyIHNwID0gKHZvaWQgMCksIGkgPSAwOyBpIDwgc3BzLmxlbmd0aDsgKytpKSB7CiAgICAgIHNwID0gc3BzW2ldOwogICAgICBpZiAoc3AubWFya2VyLmNvbGxhcHNlZCAmJiAoc3RhcnQgPyBzcC5mcm9tIDogc3AudG8pID09IG51bGwgJiYKICAgICAgICAgICghZm91bmQgfHwgY29tcGFyZUNvbGxhcHNlZE1hcmtlcnMoZm91bmQsIHNwLm1hcmtlcikgPCAwKSkKICAgICAgICB7IGZvdW5kID0gc3AubWFya2VyOyB9CiAgICB9IH0KICAgIHJldHVybiBmb3VuZAogIH0KICBmdW5jdGlvbiBjb2xsYXBzZWRTcGFuQXRTdGFydChsaW5lKSB7IHJldHVybiBjb2xsYXBzZWRTcGFuQXRTaWRlKGxpbmUsIHRydWUpIH0KICBmdW5jdGlvbiBjb2xsYXBzZWRTcGFuQXRFbmQobGluZSkgeyByZXR1cm4gY29sbGFwc2VkU3BhbkF0U2lkZShsaW5lLCBmYWxzZSkgfQoKICBmdW5jdGlvbiBjb2xsYXBzZWRTcGFuQXJvdW5kKGxpbmUsIGNoKSB7CiAgICB2YXIgc3BzID0gc2F3Q29sbGFwc2VkU3BhbnMgJiYgbGluZS5tYXJrZWRTcGFucywgZm91bmQ7CiAgICBpZiAoc3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgc3BzLmxlbmd0aDsgKytpKSB7CiAgICAgIHZhciBzcCA9IHNwc1tpXTsKICAgICAgaWYgKHNwLm1hcmtlci5jb2xsYXBzZWQgJiYgKHNwLmZyb20gPT0gbnVsbCB8fCBzcC5mcm9tIDwgY2gpICYmIChzcC50byA9PSBudWxsIHx8IHNwLnRvID4gY2gpICYmCiAgICAgICAgICAoIWZvdW5kIHx8IGNvbXBhcmVDb2xsYXBzZWRNYXJrZXJzKGZvdW5kLCBzcC5tYXJrZXIpIDwgMCkpIHsgZm91bmQgPSBzcC5tYXJrZXI7IH0KICAgIH0gfQogICAgcmV0dXJuIGZvdW5kCiAgfQoKICAvLyBUZXN0IHdoZXRoZXIgdGhlcmUgZXhpc3RzIGEgY29sbGFwc2VkIHNwYW4gdGhhdCBwYXJ0aWFsbHkKICAvLyBvdmVybGFwcyAoY292ZXJzIHRoZSBzdGFydCBvciBlbmQsIGJ1dCBub3QgYm90aCkgb2YgYSBuZXcgc3Bhbi4KICAvLyBTdWNoIG92ZXJsYXAgaXMgbm90IGFsbG93ZWQuCiAgZnVuY3Rpb24gY29uZmxpY3RpbmdDb2xsYXBzZWRSYW5nZShkb2MsIGxpbmVObyQkMSwgZnJvbSwgdG8sIG1hcmtlcikgewogICAgdmFyIGxpbmUgPSBnZXRMaW5lKGRvYywgbGluZU5vJCQxKTsKICAgIHZhciBzcHMgPSBzYXdDb2xsYXBzZWRTcGFucyAmJiBsaW5lLm1hcmtlZFNwYW5zOwogICAgaWYgKHNwcykgeyBmb3IgKHZhciBpID0gMDsgaSA8IHNwcy5sZW5ndGg7ICsraSkgewogICAgICB2YXIgc3AgPSBzcHNbaV07CiAgICAgIGlmICghc3AubWFya2VyLmNvbGxhcHNlZCkgeyBjb250aW51ZSB9CiAgICAgIHZhciBmb3VuZCA9IHNwLm1hcmtlci5maW5kKDApOwogICAgICB2YXIgZnJvbUNtcCA9IGNtcChmb3VuZC5mcm9tLCBmcm9tKSB8fCBleHRyYUxlZnQoc3AubWFya2VyKSAtIGV4dHJhTGVmdChtYXJrZXIpOwogICAgICB2YXIgdG9DbXAgPSBjbXAoZm91bmQudG8sIHRvKSB8fCBleHRyYVJpZ2h0KHNwLm1hcmtlcikgLSBleHRyYVJpZ2h0KG1hcmtlcik7CiAgICAgIGlmIChmcm9tQ21wID49IDAgJiYgdG9DbXAgPD0gMCB8fCBmcm9tQ21wIDw9IDAgJiYgdG9DbXAgPj0gMCkgeyBjb250aW51ZSB9CiAgICAgIGlmIChmcm9tQ21wIDw9IDAgJiYgKHNwLm1hcmtlci5pbmNsdXNpdmVSaWdodCAmJiBtYXJrZXIuaW5jbHVzaXZlTGVmdCA/IGNtcChmb3VuZC50bywgZnJvbSkgPj0gMCA6IGNtcChmb3VuZC50bywgZnJvbSkgPiAwKSB8fAogICAgICAgICAgZnJvbUNtcCA+PSAwICYmIChzcC5tYXJrZXIuaW5jbHVzaXZlUmlnaHQgJiYgbWFya2VyLmluY2x1c2l2ZUxlZnQgPyBjbXAoZm91bmQuZnJvbSwgdG8pIDw9IDAgOiBjbXAoZm91bmQuZnJvbSwgdG8pIDwgMCkpCiAgICAgICAgeyByZXR1cm4gdHJ1ZSB9CiAgICB9IH0KICB9CgogIC8vIEEgdmlzdWFsIGxpbmUgaXMgYSBsaW5lIGFzIGRyYXduIG9uIHRoZSBzY3JlZW4uIEZvbGRpbmcsIGZvcgogIC8vIGV4YW1wbGUsIGNhbiBjYXVzZSBtdWx0aXBsZSBsb2dpY2FsIGxpbmVzIHRvIGFwcGVhciBvbiB0aGUgc2FtZQogIC8vIHZpc3VhbCBsaW5lLiBUaGlzIGZpbmRzIHRoZSBzdGFydCBvZiB0aGUgdmlzdWFsIGxpbmUgdGhhdCB0aGUKICAvLyBnaXZlbiBsaW5lIGlzIHBhcnQgb2YgKHVzdWFsbHkgdGhhdCBpcyB0aGUgbGluZSBpdHNlbGYpLgogIGZ1bmN0aW9uIHZpc3VhbExpbmUobGluZSkgewogICAgdmFyIG1lcmdlZDsKICAgIHdoaWxlIChtZXJnZWQgPSBjb2xsYXBzZWRTcGFuQXRTdGFydChsaW5lKSkKICAgICAgeyBsaW5lID0gbWVyZ2VkLmZpbmQoLTEsIHRydWUpLmxpbmU7IH0KICAgIHJldHVybiBsaW5lCiAgfQoKICBmdW5jdGlvbiB2aXN1YWxMaW5lRW5kKGxpbmUpIHsKICAgIHZhciBtZXJnZWQ7CiAgICB3aGlsZSAobWVyZ2VkID0gY29sbGFwc2VkU3BhbkF0RW5kKGxpbmUpKQogICAgICB7IGxpbmUgPSBtZXJnZWQuZmluZCgxLCB0cnVlKS5saW5lOyB9CiAgICByZXR1cm4gbGluZQogIH0KCiAgLy8gUmV0dXJucyBhbiBhcnJheSBvZiBsb2dpY2FsIGxpbmVzIHRoYXQgY29udGludWUgdGhlIHZpc3VhbCBsaW5lCiAgLy8gc3RhcnRlZCBieSB0aGUgYXJndW1lbnQsIG9yIHVuZGVmaW5lZCBpZiB0aGVyZSBhcmUgbm8gc3VjaCBsaW5lcy4KICBmdW5jdGlvbiB2aXN1YWxMaW5lQ29udGludWVkKGxpbmUpIHsKICAgIHZhciBtZXJnZWQsIGxpbmVzOwogICAgd2hpbGUgKG1lcmdlZCA9IGNvbGxhcHNlZFNwYW5BdEVuZChsaW5lKSkgewogICAgICBsaW5lID0gbWVyZ2VkLmZpbmQoMSwgdHJ1ZSkubGluZQogICAgICA7KGxpbmVzIHx8IChsaW5lcyA9IFtdKSkucHVzaChsaW5lKTsKICAgIH0KICAgIHJldHVybiBsaW5lcwogIH0KCiAgLy8gR2V0IHRoZSBsaW5lIG51bWJlciBvZiB0aGUgc3RhcnQgb2YgdGhlIHZpc3VhbCBsaW5lIHRoYXQgdGhlCiAgLy8gZ2l2ZW4gbGluZSBudW1iZXIgaXMgcGFydCBvZi4KICBmdW5jdGlvbiB2aXN1YWxMaW5lTm8oZG9jLCBsaW5lTikgewogICAgdmFyIGxpbmUgPSBnZXRMaW5lKGRvYywgbGluZU4pLCB2aXMgPSB2aXN1YWxMaW5lKGxpbmUpOwogICAgaWYgKGxpbmUgPT0gdmlzKSB7IHJldHVybiBsaW5lTiB9CiAgICByZXR1cm4gbGluZU5vKHZpcykKICB9CgogIC8vIEdldCB0aGUgbGluZSBudW1iZXIgb2YgdGhlIHN0YXJ0IG9mIHRoZSBuZXh0IHZpc3VhbCBsaW5lIGFmdGVyCiAgLy8gdGhlIGdpdmVuIGxpbmUuCiAgZnVuY3Rpb24gdmlzdWFsTGluZUVuZE5vKGRvYywgbGluZU4pIHsKICAgIGlmIChsaW5lTiA+IGRvYy5sYXN0TGluZSgpKSB7IHJldHVybiBsaW5lTiB9CiAgICB2YXIgbGluZSA9IGdldExpbmUoZG9jLCBsaW5lTiksIG1lcmdlZDsKICAgIGlmICghbGluZUlzSGlkZGVuKGRvYywgbGluZSkpIHsgcmV0dXJuIGxpbmVOIH0KICAgIHdoaWxlIChtZXJnZWQgPSBjb2xsYXBzZWRTcGFuQXRFbmQobGluZSkpCiAgICAgIHsgbGluZSA9IG1lcmdlZC5maW5kKDEsIHRydWUpLmxpbmU7IH0KICAgIHJldHVybiBsaW5lTm8obGluZSkgKyAxCiAgfQoKICAvLyBDb21wdXRlIHdoZXRoZXIgYSBsaW5lIGlzIGhpZGRlbi4gTGluZXMgY291bnQgYXMgaGlkZGVuIHdoZW4gdGhleQogIC8vIGFyZSBwYXJ0IG9mIGEgdmlzdWFsIGxpbmUgdGhhdCBzdGFydHMgd2l0aCBhbm90aGVyIGxpbmUsIG9yIHdoZW4KICAvLyB0aGV5IGFyZSBlbnRpcmVseSBjb3ZlcmVkIGJ5IGNvbGxhcHNlZCwgbm9uLXdpZGdldCBzcGFuLgogIGZ1bmN0aW9uIGxpbmVJc0hpZGRlbihkb2MsIGxpbmUpIHsKICAgIHZhciBzcHMgPSBzYXdDb2xsYXBzZWRTcGFucyAmJiBsaW5lLm1hcmtlZFNwYW5zOwogICAgaWYgKHNwcykgeyBmb3IgKHZhciBzcCA9ICh2b2lkIDApLCBpID0gMDsgaSA8IHNwcy5sZW5ndGg7ICsraSkgewogICAgICBzcCA9IHNwc1tpXTsKICAgICAgaWYgKCFzcC5tYXJrZXIuY29sbGFwc2VkKSB7IGNvbnRpbnVlIH0KICAgICAgaWYgKHNwLmZyb20gPT0gbnVsbCkgeyByZXR1cm4gdHJ1ZSB9CiAgICAgIGlmIChzcC5tYXJrZXIud2lkZ2V0Tm9kZSkgeyBjb250aW51ZSB9CiAgICAgIGlmIChzcC5mcm9tID09IDAgJiYgc3AubWFya2VyLmluY2x1c2l2ZUxlZnQgJiYgbGluZUlzSGlkZGVuSW5uZXIoZG9jLCBsaW5lLCBzcCkpCiAgICAgICAgeyByZXR1cm4gdHJ1ZSB9CiAgICB9IH0KICB9CiAgZnVuY3Rpb24gbGluZUlzSGlkZGVuSW5uZXIoZG9jLCBsaW5lLCBzcGFuKSB7CiAgICBpZiAoc3Bhbi50byA9PSBudWxsKSB7CiAgICAgIHZhciBlbmQgPSBzcGFuLm1hcmtlci5maW5kKDEsIHRydWUpOwogICAgICByZXR1cm4gbGluZUlzSGlkZGVuSW5uZXIoZG9jLCBlbmQubGluZSwgZ2V0TWFya2VkU3BhbkZvcihlbmQubGluZS5tYXJrZWRTcGFucywgc3Bhbi5tYXJrZXIpKQogICAgfQogICAgaWYgKHNwYW4ubWFya2VyLmluY2x1c2l2ZVJpZ2h0ICYmIHNwYW4udG8gPT0gbGluZS50ZXh0Lmxlbmd0aCkKICAgICAgeyByZXR1cm4gdHJ1ZSB9CiAgICBmb3IgKHZhciBzcCA9ICh2b2lkIDApLCBpID0gMDsgaSA8IGxpbmUubWFya2VkU3BhbnMubGVuZ3RoOyArK2kpIHsKICAgICAgc3AgPSBsaW5lLm1hcmtlZFNwYW5zW2ldOwogICAgICBpZiAoc3AubWFya2VyLmNvbGxhcHNlZCAmJiAhc3AubWFya2VyLndpZGdldE5vZGUgJiYgc3AuZnJvbSA9PSBzcGFuLnRvICYmCiAgICAgICAgICAoc3AudG8gPT0gbnVsbCB8fCBzcC50byAhPSBzcGFuLmZyb20pICYmCiAgICAgICAgICAoc3AubWFya2VyLmluY2x1c2l2ZUxlZnQgfHwgc3Bhbi5tYXJrZXIuaW5jbHVzaXZlUmlnaHQpICYmCiAgICAgICAgICBsaW5lSXNIaWRkZW5Jbm5lcihkb2MsIGxpbmUsIHNwKSkgeyByZXR1cm4gdHJ1ZSB9CiAgICB9CiAgfQoKICAvLyBGaW5kIHRoZSBoZWlnaHQgYWJvdmUgdGhlIGdpdmVuIGxpbmUuCiAgZnVuY3Rpb24gaGVpZ2h0QXRMaW5lKGxpbmVPYmopIHsKICAgIGxpbmVPYmogPSB2aXN1YWxMaW5lKGxpbmVPYmopOwoKICAgIHZhciBoID0gMCwgY2h1bmsgPSBsaW5lT2JqLnBhcmVudDsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2h1bmsubGluZXMubGVuZ3RoOyArK2kpIHsKICAgICAgdmFyIGxpbmUgPSBjaHVuay5saW5lc1tpXTsKICAgICAgaWYgKGxpbmUgPT0gbGluZU9iaikgeyBicmVhayB9CiAgICAgIGVsc2UgeyBoICs9IGxpbmUuaGVpZ2h0OyB9CiAgICB9CiAgICBmb3IgKHZhciBwID0gY2h1bmsucGFyZW50OyBwOyBjaHVuayA9IHAsIHAgPSBjaHVuay5wYXJlbnQpIHsKICAgICAgZm9yICh2YXIgaSQxID0gMDsgaSQxIDwgcC5jaGlsZHJlbi5sZW5ndGg7ICsraSQxKSB7CiAgICAgICAgdmFyIGN1ciA9IHAuY2hpbGRyZW5baSQxXTsKICAgICAgICBpZiAoY3VyID09IGNodW5rKSB7IGJyZWFrIH0KICAgICAgICBlbHNlIHsgaCArPSBjdXIuaGVpZ2h0OyB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBoCiAgfQoKICAvLyBDb21wdXRlIHRoZSBjaGFyYWN0ZXIgbGVuZ3RoIG9mIGEgbGluZSwgdGFraW5nIGludG8gYWNjb3VudAogIC8vIGNvbGxhcHNlZCByYW5nZXMgKHNlZSBtYXJrVGV4dCkgdGhhdCBtaWdodCBoaWRlIHBhcnRzLCBhbmQgam9pbgogIC8vIG90aGVyIGxpbmVzIG9udG8gaXQuCiAgZnVuY3Rpb24gbGluZUxlbmd0aChsaW5lKSB7CiAgICBpZiAobGluZS5oZWlnaHQgPT0gMCkgeyByZXR1cm4gMCB9CiAgICB2YXIgbGVuID0gbGluZS50ZXh0Lmxlbmd0aCwgbWVyZ2VkLCBjdXIgPSBsaW5lOwogICAgd2hpbGUgKG1lcmdlZCA9IGNvbGxhcHNlZFNwYW5BdFN0YXJ0KGN1cikpIHsKICAgICAgdmFyIGZvdW5kID0gbWVyZ2VkLmZpbmQoMCwgdHJ1ZSk7CiAgICAgIGN1ciA9IGZvdW5kLmZyb20ubGluZTsKICAgICAgbGVuICs9IGZvdW5kLmZyb20uY2ggLSBmb3VuZC50by5jaDsKICAgIH0KICAgIGN1ciA9IGxpbmU7CiAgICB3aGlsZSAobWVyZ2VkID0gY29sbGFwc2VkU3BhbkF0RW5kKGN1cikpIHsKICAgICAgdmFyIGZvdW5kJDEgPSBtZXJnZWQuZmluZCgwLCB0cnVlKTsKICAgICAgbGVuIC09IGN1ci50ZXh0Lmxlbmd0aCAtIGZvdW5kJDEuZnJvbS5jaDsKICAgICAgY3VyID0gZm91bmQkMS50by5saW5lOwogICAgICBsZW4gKz0gY3VyLnRleHQubGVuZ3RoIC0gZm91bmQkMS50by5jaDsKICAgIH0KICAgIHJldHVybiBsZW4KICB9CgogIC8vIEZpbmQgdGhlIGxvbmdlc3QgbGluZSBpbiB0aGUgZG9jdW1lbnQuCiAgZnVuY3Rpb24gZmluZE1heExpbmUoY20pIHsKICAgIHZhciBkID0gY20uZGlzcGxheSwgZG9jID0gY20uZG9jOwogICAgZC5tYXhMaW5lID0gZ2V0TGluZShkb2MsIGRvYy5maXJzdCk7CiAgICBkLm1heExpbmVMZW5ndGggPSBsaW5lTGVuZ3RoKGQubWF4TGluZSk7CiAgICBkLm1heExpbmVDaGFuZ2VkID0gdHJ1ZTsKICAgIGRvYy5pdGVyKGZ1bmN0aW9uIChsaW5lKSB7CiAgICAgIHZhciBsZW4gPSBsaW5lTGVuZ3RoKGxpbmUpOwogICAgICBpZiAobGVuID4gZC5tYXhMaW5lTGVuZ3RoKSB7CiAgICAgICAgZC5tYXhMaW5lTGVuZ3RoID0gbGVuOwogICAgICAgIGQubWF4TGluZSA9IGxpbmU7CiAgICAgIH0KICAgIH0pOwogIH0KCiAgLy8gTElORSBEQVRBIFNUUlVDVFVSRQoKICAvLyBMaW5lIG9iamVjdHMuIFRoZXNlIGhvbGQgc3RhdGUgcmVsYXRlZCB0byBhIGxpbmUsIGluY2x1ZGluZwogIC8vIGhpZ2hsaWdodGluZyBpbmZvICh0aGUgc3R5bGVzIGFycmF5KS4KICB2YXIgTGluZSA9IGZ1bmN0aW9uKHRleHQsIG1hcmtlZFNwYW5zLCBlc3RpbWF0ZUhlaWdodCkgewogICAgdGhpcy50ZXh0ID0gdGV4dDsKICAgIGF0dGFjaE1hcmtlZFNwYW5zKHRoaXMsIG1hcmtlZFNwYW5zKTsKICAgIHRoaXMuaGVpZ2h0ID0gZXN0aW1hdGVIZWlnaHQgPyBlc3RpbWF0ZUhlaWdodCh0aGlzKSA6IDE7CiAgfTsKCiAgTGluZS5wcm90b3R5cGUubGluZU5vID0gZnVuY3Rpb24gKCkgeyByZXR1cm4gbGluZU5vKHRoaXMpIH07CiAgZXZlbnRNaXhpbihMaW5lKTsKCiAgLy8gQ2hhbmdlIHRoZSBjb250ZW50ICh0ZXh0LCBtYXJrZXJzKSBvZiBhIGxpbmUuIEF1dG9tYXRpY2FsbHkKICAvLyBpbnZhbGlkYXRlcyBjYWNoZWQgaW5mb3JtYXRpb24gYW5kIHRyaWVzIHRvIHJlLWVzdGltYXRlIHRoZQogIC8vIGxpbmUncyBoZWlnaHQuCiAgZnVuY3Rpb24gdXBkYXRlTGluZShsaW5lLCB0ZXh0LCBtYXJrZWRTcGFucywgZXN0aW1hdGVIZWlnaHQpIHsKICAgIGxpbmUudGV4dCA9IHRleHQ7CiAgICBpZiAobGluZS5zdGF0ZUFmdGVyKSB7IGxpbmUuc3RhdGVBZnRlciA9IG51bGw7IH0KICAgIGlmIChsaW5lLnN0eWxlcykgeyBsaW5lLnN0eWxlcyA9IG51bGw7IH0KICAgIGlmIChsaW5lLm9yZGVyICE9IG51bGwpIHsgbGluZS5vcmRlciA9IG51bGw7IH0KICAgIGRldGFjaE1hcmtlZFNwYW5zKGxpbmUpOwogICAgYXR0YWNoTWFya2VkU3BhbnMobGluZSwgbWFya2VkU3BhbnMpOwogICAgdmFyIGVzdEhlaWdodCA9IGVzdGltYXRlSGVpZ2h0ID8gZXN0aW1hdGVIZWlnaHQobGluZSkgOiAxOwogICAgaWYgKGVzdEhlaWdodCAhPSBsaW5lLmhlaWdodCkgeyB1cGRhdGVMaW5lSGVpZ2h0KGxpbmUsIGVzdEhlaWdodCk7IH0KICB9CgogIC8vIERldGFjaCBhIGxpbmUgZnJvbSB0aGUgZG9jdW1lbnQgdHJlZSBhbmQgaXRzIG1hcmtlcnMuCiAgZnVuY3Rpb24gY2xlYW5VcExpbmUobGluZSkgewogICAgbGluZS5wYXJlbnQgPSBudWxsOwogICAgZGV0YWNoTWFya2VkU3BhbnMobGluZSk7CiAgfQoKICAvLyBDb252ZXJ0IGEgc3R5bGUgYXMgcmV0dXJuZWQgYnkgYSBtb2RlIChlaXRoZXIgbnVsbCwgb3IgYSBzdHJpbmcKICAvLyBjb250YWluaW5nIG9uZSBvciBtb3JlIHN0eWxlcykgdG8gYSBDU1Mgc3R5bGUuIFRoaXMgaXMgY2FjaGVkLAogIC8vIGFuZCBhbHNvIGxvb2tzIGZvciBsaW5lLXdpZGUgc3R5bGVzLgogIHZhciBzdHlsZVRvQ2xhc3NDYWNoZSA9IHt9LCBzdHlsZVRvQ2xhc3NDYWNoZVdpdGhNb2RlID0ge307CiAgZnVuY3Rpb24gaW50ZXJwcmV0VG9rZW5TdHlsZShzdHlsZSwgb3B0aW9ucykgewogICAgaWYgKCFzdHlsZSB8fCAvXlxzKiQvLnRlc3Qoc3R5bGUpKSB7IHJldHVybiBudWxsIH0KICAgIHZhciBjYWNoZSA9IG9wdGlvbnMuYWRkTW9kZUNsYXNzID8gc3R5bGVUb0NsYXNzQ2FjaGVXaXRoTW9kZSA6IHN0eWxlVG9DbGFzc0NhY2hlOwogICAgcmV0dXJuIGNhY2hlW3N0eWxlXSB8fAogICAgICAoY2FjaGVbc3R5bGVdID0gc3R5bGUucmVwbGFjZSgvXFMrL2csICJjbS0kJiIpKQogIH0KCiAgLy8gUmVuZGVyIHRoZSBET00gcmVwcmVzZW50YXRpb24gb2YgdGhlIHRleHQgb2YgYSBsaW5lLiBBbHNvIGJ1aWxkcwogIC8vIHVwIGEgJ2xpbmUgbWFwJywgd2hpY2ggcG9pbnRzIGF0IHRoZSBET00gbm9kZXMgdGhhdCByZXByZXNlbnQKICAvLyBzcGVjaWZpYyBzdHJldGNoZXMgb2YgdGV4dCwgYW5kIGlzIHVzZWQgYnkgdGhlIG1lYXN1cmluZyBjb2RlLgogIC8vIFRoZSByZXR1cm5lZCBvYmplY3QgY29udGFpbnMgdGhlIERPTSBub2RlLCB0aGlzIG1hcCwgYW5kCiAgLy8gaW5mb3JtYXRpb24gYWJvdXQgbGluZS13aWRlIHN0eWxlcyB0aGF0IHdlcmUgc2V0IGJ5IHRoZSBtb2RlLgogIGZ1bmN0aW9uIGJ1aWxkTGluZUNvbnRlbnQoY20sIGxpbmVWaWV3KSB7CiAgICAvLyBUaGUgcGFkZGluZy1yaWdodCBmb3JjZXMgdGhlIGVsZW1lbnQgdG8gaGF2ZSBhICdib3JkZXInLCB3aGljaAogICAgLy8gaXMgbmVlZGVkIG9uIFdlYmtpdCB0byBiZSBhYmxlIHRvIGdldCBsaW5lLWxldmVsIGJvdW5kaW5nCiAgICAvLyByZWN0YW5nbGVzIGZvciBpdCAoaW4gbWVhc3VyZUNoYXIpLgogICAgdmFyIGNvbnRlbnQgPSBlbHRQKCJzcGFuIiwgbnVsbCwgbnVsbCwgd2Via2l0ID8gInBhZGRpbmctcmlnaHQ6IC4xcHgiIDogbnVsbCk7CiAgICB2YXIgYnVpbGRlciA9IHtwcmU6IGVsdFAoInByZSIsIFtjb250ZW50XSwgIkNvZGVNaXJyb3ItbGluZSIpLCBjb250ZW50OiBjb250ZW50LAogICAgICAgICAgICAgICAgICAgY29sOiAwLCBwb3M6IDAsIGNtOiBjbSwKICAgICAgICAgICAgICAgICAgIHRyYWlsaW5nU3BhY2U6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgc3BsaXRTcGFjZXM6IGNtLmdldE9wdGlvbigibGluZVdyYXBwaW5nIil9OwogICAgbGluZVZpZXcubWVhc3VyZSA9IHt9OwoKICAgIC8vIEl0ZXJhdGUgb3ZlciB0aGUgbG9naWNhbCBsaW5lcyB0aGF0IG1ha2UgdXAgdGhpcyB2aXN1YWwgbGluZS4KICAgIGZvciAodmFyIGkgPSAwOyBpIDw9IChsaW5lVmlldy5yZXN0ID8gbGluZVZpZXcucmVzdC5sZW5ndGggOiAwKTsgaSsrKSB7CiAgICAgIHZhciBsaW5lID0gaSA/IGxpbmVWaWV3LnJlc3RbaSAtIDFdIDogbGluZVZpZXcubGluZSwgb3JkZXIgPSAodm9pZCAwKTsKICAgICAgYnVpbGRlci5wb3MgPSAwOwogICAgICBidWlsZGVyLmFkZFRva2VuID0gYnVpbGRUb2tlbjsKICAgICAgLy8gT3B0aW9uYWxseSB3aXJlIGluIHNvbWUgaGFja3MgaW50byB0aGUgdG9rZW4tcmVuZGVyaW5nCiAgICAgIC8vIGFsZ29yaXRobSwgdG8gZGVhbCB3aXRoIGJyb3dzZXIgcXVpcmtzLgogICAgICBpZiAoaGFzQmFkQmlkaVJlY3RzKGNtLmRpc3BsYXkubWVhc3VyZSkgJiYgKG9yZGVyID0gZ2V0T3JkZXIobGluZSwgY20uZG9jLmRpcmVjdGlvbikpKQogICAgICAgIHsgYnVpbGRlci5hZGRUb2tlbiA9IGJ1aWxkVG9rZW5CYWRCaWRpKGJ1aWxkZXIuYWRkVG9rZW4sIG9yZGVyKTsgfQogICAgICBidWlsZGVyLm1hcCA9IFtdOwogICAgICB2YXIgYWxsb3dGcm9udGllclVwZGF0ZSA9IGxpbmVWaWV3ICE9IGNtLmRpc3BsYXkuZXh0ZXJuYWxNZWFzdXJlZCAmJiBsaW5lTm8obGluZSk7CiAgICAgIGluc2VydExpbmVDb250ZW50KGxpbmUsIGJ1aWxkZXIsIGdldExpbmVTdHlsZXMoY20sIGxpbmUsIGFsbG93RnJvbnRpZXJVcGRhdGUpKTsKICAgICAgaWYgKGxpbmUuc3R5bGVDbGFzc2VzKSB7CiAgICAgICAgaWYgKGxpbmUuc3R5bGVDbGFzc2VzLmJnQ2xhc3MpCiAgICAgICAgICB7IGJ1aWxkZXIuYmdDbGFzcyA9IGpvaW5DbGFzc2VzKGxpbmUuc3R5bGVDbGFzc2VzLmJnQ2xhc3MsIGJ1aWxkZXIuYmdDbGFzcyB8fCAiIik7IH0KICAgICAgICBpZiAobGluZS5zdHlsZUNsYXNzZXMudGV4dENsYXNzKQogICAgICAgICAgeyBidWlsZGVyLnRleHRDbGFzcyA9IGpvaW5DbGFzc2VzKGxpbmUuc3R5bGVDbGFzc2VzLnRleHRDbGFzcywgYnVpbGRlci50ZXh0Q2xhc3MgfHwgIiIpOyB9CiAgICAgIH0KCiAgICAgIC8vIEVuc3VyZSBhdCBsZWFzdCBhIHNpbmdsZSBub2RlIGlzIHByZXNlbnQsIGZvciBtZWFzdXJpbmcuCiAgICAgIGlmIChidWlsZGVyLm1hcC5sZW5ndGggPT0gMCkKICAgICAgICB7IGJ1aWxkZXIubWFwLnB1c2goMCwgMCwgYnVpbGRlci5jb250ZW50LmFwcGVuZENoaWxkKHplcm9XaWR0aEVsZW1lbnQoY20uZGlzcGxheS5tZWFzdXJlKSkpOyB9CgogICAgICAvLyBTdG9yZSB0aGUgbWFwIGFuZCBhIGNhY2hlIG9iamVjdCBmb3IgdGhlIGN1cnJlbnQgbG9naWNhbCBsaW5lCiAgICAgIGlmIChpID09IDApIHsKICAgICAgICBsaW5lVmlldy5tZWFzdXJlLm1hcCA9IGJ1aWxkZXIubWFwOwogICAgICAgIGxpbmVWaWV3Lm1lYXN1cmUuY2FjaGUgPSB7fTsKICAgICAgfSBlbHNlIHsKICAobGluZVZpZXcubWVhc3VyZS5tYXBzIHx8IChsaW5lVmlldy5tZWFzdXJlLm1hcHMgPSBbXSkpLnB1c2goYnVpbGRlci5tYXApCiAgICAgICAgOyhsaW5lVmlldy5tZWFzdXJlLmNhY2hlcyB8fCAobGluZVZpZXcubWVhc3VyZS5jYWNoZXMgPSBbXSkpLnB1c2goe30pOwogICAgICB9CiAgICB9CgogICAgLy8gU2VlIGlzc3VlICMyOTAxCiAgICBpZiAod2Via2l0KSB7CiAgICAgIHZhciBsYXN0ID0gYnVpbGRlci5jb250ZW50Lmxhc3RDaGlsZDsKICAgICAgaWYgKC9cYmNtLXRhYlxiLy50ZXN0KGxhc3QuY2xhc3NOYW1lKSB8fCAobGFzdC5xdWVyeVNlbGVjdG9yICYmIGxhc3QucXVlcnlTZWxlY3RvcigiLmNtLXRhYiIpKSkKICAgICAgICB7IGJ1aWxkZXIuY29udGVudC5jbGFzc05hbWUgPSAiY20tdGFiLXdyYXAtaGFjayI7IH0KICAgIH0KCiAgICBzaWduYWwoY20sICJyZW5kZXJMaW5lIiwgY20sIGxpbmVWaWV3LmxpbmUsIGJ1aWxkZXIucHJlKTsKICAgIGlmIChidWlsZGVyLnByZS5jbGFzc05hbWUpCiAgICAgIHsgYnVpbGRlci50ZXh0Q2xhc3MgPSBqb2luQ2xhc3NlcyhidWlsZGVyLnByZS5jbGFzc05hbWUsIGJ1aWxkZXIudGV4dENsYXNzIHx8ICIiKTsgfQoKICAgIHJldHVybiBidWlsZGVyCiAgfQoKICBmdW5jdGlvbiBkZWZhdWx0U3BlY2lhbENoYXJQbGFjZWhvbGRlcihjaCkgewogICAgdmFyIHRva2VuID0gZWx0KCJzcGFuIiwgIlx1MjAyMiIsICJjbS1pbnZhbGlkY2hhciIpOwogICAgdG9rZW4udGl0bGUgPSAiXFx1IiArIGNoLmNoYXJDb2RlQXQoMCkudG9TdHJpbmcoMTYpOwogICAgdG9rZW4uc2V0QXR0cmlidXRlKCJhcmlhLWxhYmVsIiwgdG9rZW4udGl0bGUpOwogICAgcmV0dXJuIHRva2VuCiAgfQoKICAvLyBCdWlsZCB1cCB0aGUgRE9NIHJlcHJlc2VudGF0aW9uIGZvciBhIHNpbmdsZSB0b2tlbiwgYW5kIGFkZCBpdCB0bwogIC8vIHRoZSBsaW5lIG1hcC4gVGFrZXMgY2FyZSB0byByZW5kZXIgc3BlY2lhbCBjaGFyYWN0ZXJzIHNlcGFyYXRlbHkuCiAgZnVuY3Rpb24gYnVpbGRUb2tlbihidWlsZGVyLCB0ZXh0LCBzdHlsZSwgc3RhcnRTdHlsZSwgZW5kU3R5bGUsIGNzcywgYXR0cmlidXRlcykgewogICAgaWYgKCF0ZXh0KSB7IHJldHVybiB9CiAgICB2YXIgZGlzcGxheVRleHQgPSBidWlsZGVyLnNwbGl0U3BhY2VzID8gc3BsaXRTcGFjZXModGV4dCwgYnVpbGRlci50cmFpbGluZ1NwYWNlKSA6IHRleHQ7CiAgICB2YXIgc3BlY2lhbCA9IGJ1aWxkZXIuY20uc3RhdGUuc3BlY2lhbENoYXJzLCBtdXN0V3JhcCA9IGZhbHNlOwogICAgdmFyIGNvbnRlbnQ7CiAgICBpZiAoIXNwZWNpYWwudGVzdCh0ZXh0KSkgewogICAgICBidWlsZGVyLmNvbCArPSB0ZXh0Lmxlbmd0aDsKICAgICAgY29udGVudCA9IGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKGRpc3BsYXlUZXh0KTsKICAgICAgYnVpbGRlci5tYXAucHVzaChidWlsZGVyLnBvcywgYnVpbGRlci5wb3MgKyB0ZXh0Lmxlbmd0aCwgY29udGVudCk7CiAgICAgIGlmIChpZSAmJiBpZV92ZXJzaW9uIDwgOSkgeyBtdXN0V3JhcCA9IHRydWU7IH0KICAgICAgYnVpbGRlci5wb3MgKz0gdGV4dC5sZW5ndGg7CiAgICB9IGVsc2UgewogICAgICBjb250ZW50ID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOwogICAgICB2YXIgcG9zID0gMDsKICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICBzcGVjaWFsLmxhc3RJbmRleCA9IHBvczsKICAgICAgICB2YXIgbSA9IHNwZWNpYWwuZXhlYyh0ZXh0KTsKICAgICAgICB2YXIgc2tpcHBlZCA9IG0gPyBtLmluZGV4IC0gcG9zIDogdGV4dC5sZW5ndGggLSBwb3M7CiAgICAgICAgaWYgKHNraXBwZWQpIHsKICAgICAgICAgIHZhciB0eHQgPSBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShkaXNwbGF5VGV4dC5zbGljZShwb3MsIHBvcyArIHNraXBwZWQpKTsKICAgICAgICAgIGlmIChpZSAmJiBpZV92ZXJzaW9uIDwgOSkgeyBjb250ZW50LmFwcGVuZENoaWxkKGVsdCgic3BhbiIsIFt0eHRdKSk7IH0KICAgICAgICAgIGVsc2UgeyBjb250ZW50LmFwcGVuZENoaWxkKHR4dCk7IH0KICAgICAgICAgIGJ1aWxkZXIubWFwLnB1c2goYnVpbGRlci5wb3MsIGJ1aWxkZXIucG9zICsgc2tpcHBlZCwgdHh0KTsKICAgICAgICAgIGJ1aWxkZXIuY29sICs9IHNraXBwZWQ7CiAgICAgICAgICBidWlsZGVyLnBvcyArPSBza2lwcGVkOwogICAgICAgIH0KICAgICAgICBpZiAoIW0pIHsgYnJlYWsgfQogICAgICAgIHBvcyArPSBza2lwcGVkICsgMTsKICAgICAgICB2YXIgdHh0JDEgPSAodm9pZCAwKTsKICAgICAgICBpZiAobVswXSA9PSAiXHQiKSB7CiAgICAgICAgICB2YXIgdGFiU2l6ZSA9IGJ1aWxkZXIuY20ub3B0aW9ucy50YWJTaXplLCB0YWJXaWR0aCA9IHRhYlNpemUgLSBidWlsZGVyLmNvbCAlIHRhYlNpemU7CiAgICAgICAgICB0eHQkMSA9IGNvbnRlbnQuYXBwZW5kQ2hpbGQoZWx0KCJzcGFuIiwgc3BhY2VTdHIodGFiV2lkdGgpLCAiY20tdGFiIikpOwogICAgICAgICAgdHh0JDEuc2V0QXR0cmlidXRlKCJyb2xlIiwgInByZXNlbnRhdGlvbiIpOwogICAgICAgICAgdHh0JDEuc2V0QXR0cmlidXRlKCJjbS10ZXh0IiwgIlx0Iik7CiAgICAgICAgICBidWlsZGVyLmNvbCArPSB0YWJXaWR0aDsKICAgICAgICB9IGVsc2UgaWYgKG1bMF0gPT0gIlxyIiB8fCBtWzBdID09ICJcbiIpIHsKICAgICAgICAgIHR4dCQxID0gY29udGVudC5hcHBlbmRDaGlsZChlbHQoInNwYW4iLCBtWzBdID09ICJcciIgPyAiXHUyNDBkIiA6ICJcdTI0MjQiLCAiY20taW52YWxpZGNoYXIiKSk7CiAgICAgICAgICB0eHQkMS5zZXRBdHRyaWJ1dGUoImNtLXRleHQiLCBtWzBdKTsKICAgICAgICAgIGJ1aWxkZXIuY29sICs9IDE7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHR4dCQxID0gYnVpbGRlci5jbS5vcHRpb25zLnNwZWNpYWxDaGFyUGxhY2Vob2xkZXIobVswXSk7CiAgICAgICAgICB0eHQkMS5zZXRBdHRyaWJ1dGUoImNtLXRleHQiLCBtWzBdKTsKICAgICAgICAgIGlmIChpZSAmJiBpZV92ZXJzaW9uIDwgOSkgeyBjb250ZW50LmFwcGVuZENoaWxkKGVsdCgic3BhbiIsIFt0eHQkMV0pKTsgfQogICAgICAgICAgZWxzZSB7IGNvbnRlbnQuYXBwZW5kQ2hpbGQodHh0JDEpOyB9CiAgICAgICAgICBidWlsZGVyLmNvbCArPSAxOwogICAgICAgIH0KICAgICAgICBidWlsZGVyLm1hcC5wdXNoKGJ1aWxkZXIucG9zLCBidWlsZGVyLnBvcyArIDEsIHR4dCQxKTsKICAgICAgICBidWlsZGVyLnBvcysrOwogICAgICB9CiAgICB9CiAgICBidWlsZGVyLnRyYWlsaW5nU3BhY2UgPSBkaXNwbGF5VGV4dC5jaGFyQ29kZUF0KHRleHQubGVuZ3RoIC0gMSkgPT0gMzI7CiAgICBpZiAoc3R5bGUgfHwgc3RhcnRTdHlsZSB8fCBlbmRTdHlsZSB8fCBtdXN0V3JhcCB8fCBjc3MpIHsKICAgICAgdmFyIGZ1bGxTdHlsZSA9IHN0eWxlIHx8ICIiOwogICAgICBpZiAoc3RhcnRTdHlsZSkgeyBmdWxsU3R5bGUgKz0gc3RhcnRTdHlsZTsgfQogICAgICBpZiAoZW5kU3R5bGUpIHsgZnVsbFN0eWxlICs9IGVuZFN0eWxlOyB9CiAgICAgIHZhciB0b2tlbiA9IGVsdCgic3BhbiIsIFtjb250ZW50XSwgZnVsbFN0eWxlLCBjc3MpOwogICAgICBpZiAoYXR0cmlidXRlcykgewogICAgICAgIGZvciAodmFyIGF0dHIgaW4gYXR0cmlidXRlcykgeyBpZiAoYXR0cmlidXRlcy5oYXNPd25Qcm9wZXJ0eShhdHRyKSAmJiBhdHRyICE9ICJzdHlsZSIgJiYgYXR0ciAhPSAiY2xhc3MiKQogICAgICAgICAgeyB0b2tlbi5zZXRBdHRyaWJ1dGUoYXR0ciwgYXR0cmlidXRlc1thdHRyXSk7IH0gfQogICAgICB9CiAgICAgIHJldHVybiBidWlsZGVyLmNvbnRlbnQuYXBwZW5kQ2hpbGQodG9rZW4pCiAgICB9CiAgICBidWlsZGVyLmNvbnRlbnQuYXBwZW5kQ2hpbGQoY29udGVudCk7CiAgfQoKICAvLyBDaGFuZ2Ugc29tZSBzcGFjZXMgdG8gTkJTUCB0byBwcmV2ZW50IHRoZSBicm93c2VyIGZyb20gY29sbGFwc2luZwogIC8vIHRyYWlsaW5nIHNwYWNlcyBhdCB0aGUgZW5kIG9mIGEgbGluZSB3aGVuIHJlbmRlcmluZyB0ZXh0IChpc3N1ZSAjMTM2MikuCiAgZnVuY3Rpb24gc3BsaXRTcGFjZXModGV4dCwgdHJhaWxpbmdCZWZvcmUpIHsKICAgIGlmICh0ZXh0Lmxlbmd0aCA+IDEgJiYgIS8gIC8udGVzdCh0ZXh0KSkgeyByZXR1cm4gdGV4dCB9CiAgICB2YXIgc3BhY2VCZWZvcmUgPSB0cmFpbGluZ0JlZm9yZSwgcmVzdWx0ID0gIiI7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRleHQubGVuZ3RoOyBpKyspIHsKICAgICAgdmFyIGNoID0gdGV4dC5jaGFyQXQoaSk7CiAgICAgIGlmIChjaCA9PSAiICIgJiYgc3BhY2VCZWZvcmUgJiYgKGkgPT0gdGV4dC5sZW5ndGggLSAxIHx8IHRleHQuY2hhckNvZGVBdChpICsgMSkgPT0gMzIpKQogICAgICAgIHsgY2ggPSAiXHUwMGEwIjsgfQogICAgICByZXN1bHQgKz0gY2g7CiAgICAgIHNwYWNlQmVmb3JlID0gY2ggPT0gIiAiOwogICAgfQogICAgcmV0dXJuIHJlc3VsdAogIH0KCiAgLy8gV29yayBhcm91bmQgbm9uc2Vuc2UgZGltZW5zaW9ucyBiZWluZyByZXBvcnRlZCBmb3Igc3RyZXRjaGVzIG9mCiAgLy8gcmlnaHQtdG8tbGVmdCB0ZXh0LgogIGZ1bmN0aW9uIGJ1aWxkVG9rZW5CYWRCaWRpKGlubmVyLCBvcmRlcikgewogICAgcmV0dXJuIGZ1bmN0aW9uIChidWlsZGVyLCB0ZXh0LCBzdHlsZSwgc3RhcnRTdHlsZSwgZW5kU3R5bGUsIGNzcywgYXR0cmlidXRlcykgewogICAgICBzdHlsZSA9IHN0eWxlID8gc3R5bGUgKyAiIGNtLWZvcmNlLWJvcmRlciIgOiAiY20tZm9yY2UtYm9yZGVyIjsKICAgICAgdmFyIHN0YXJ0ID0gYnVpbGRlci5wb3MsIGVuZCA9IHN0YXJ0ICsgdGV4dC5sZW5ndGg7CiAgICAgIGZvciAoOzspIHsKICAgICAgICAvLyBGaW5kIHRoZSBwYXJ0IHRoYXQgb3ZlcmxhcHMgd2l0aCB0aGUgc3RhcnQgb2YgdGhpcyB0ZXh0CiAgICAgICAgdmFyIHBhcnQgPSAodm9pZCAwKTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG9yZGVyLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBwYXJ0ID0gb3JkZXJbaV07CiAgICAgICAgICBpZiAocGFydC50byA+IHN0YXJ0ICYmIHBhcnQuZnJvbSA8PSBzdGFydCkgeyBicmVhayB9CiAgICAgICAgfQogICAgICAgIGlmIChwYXJ0LnRvID49IGVuZCkgeyByZXR1cm4gaW5uZXIoYnVpbGRlciwgdGV4dCwgc3R5bGUsIHN0YXJ0U3R5bGUsIGVuZFN0eWxlLCBjc3MsIGF0dHJpYnV0ZXMpIH0KICAgICAgICBpbm5lcihidWlsZGVyLCB0ZXh0LnNsaWNlKDAsIHBhcnQudG8gLSBzdGFydCksIHN0eWxlLCBzdGFydFN0eWxlLCBudWxsLCBjc3MsIGF0dHJpYnV0ZXMpOwogICAgICAgIHN0YXJ0U3R5bGUgPSBudWxsOwogICAgICAgIHRleHQgPSB0ZXh0LnNsaWNlKHBhcnQudG8gLSBzdGFydCk7CiAgICAgICAgc3RhcnQgPSBwYXJ0LnRvOwogICAgICB9CiAgICB9CiAgfQoKICBmdW5jdGlvbiBidWlsZENvbGxhcHNlZFNwYW4oYnVpbGRlciwgc2l6ZSwgbWFya2VyLCBpZ25vcmVXaWRnZXQpIHsKICAgIHZhciB3aWRnZXQgPSAhaWdub3JlV2lkZ2V0ICYmIG1hcmtlci53aWRnZXROb2RlOwogICAgaWYgKHdpZGdldCkgeyBidWlsZGVyLm1hcC5wdXNoKGJ1aWxkZXIucG9zLCBidWlsZGVyLnBvcyArIHNpemUsIHdpZGdldCk7IH0KICAgIGlmICghaWdub3JlV2lkZ2V0ICYmIGJ1aWxkZXIuY20uZGlzcGxheS5pbnB1dC5uZWVkc0NvbnRlbnRBdHRyaWJ1dGUpIHsKICAgICAgaWYgKCF3aWRnZXQpCiAgICAgICAgeyB3aWRnZXQgPSBidWlsZGVyLmNvbnRlbnQuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3BhbiIpKTsgfQogICAgICB3aWRnZXQuc2V0QXR0cmlidXRlKCJjbS1tYXJrZXIiLCBtYXJrZXIuaWQpOwogICAgfQogICAgaWYgKHdpZGdldCkgewogICAgICBidWlsZGVyLmNtLmRpc3BsYXkuaW5wdXQuc2V0VW5lZGl0YWJsZSh3aWRnZXQpOwogICAgICBidWlsZGVyLmNvbnRlbnQuYXBwZW5kQ2hpbGQod2lkZ2V0KTsKICAgIH0KICAgIGJ1aWxkZXIucG9zICs9IHNpemU7CiAgICBidWlsZGVyLnRyYWlsaW5nU3BhY2UgPSBmYWxzZTsKICB9CgogIC8vIE91dHB1dHMgYSBudW1iZXIgb2Ygc3BhbnMgdG8gbWFrZSB1cCBhIGxpbmUsIHRha2luZyBoaWdobGlnaHRpbmcKICAvLyBhbmQgbWFya2VkIHRleHQgaW50byBhY2NvdW50LgogIGZ1bmN0aW9uIGluc2VydExpbmVDb250ZW50KGxpbmUsIGJ1aWxkZXIsIHN0eWxlcykgewogICAgdmFyIHNwYW5zID0gbGluZS5tYXJrZWRTcGFucywgYWxsVGV4dCA9IGxpbmUudGV4dCwgYXQgPSAwOwogICAgaWYgKCFzcGFucykgewogICAgICBmb3IgKHZhciBpJDEgPSAxOyBpJDEgPCBzdHlsZXMubGVuZ3RoOyBpJDErPTIpCiAgICAgICAgeyBidWlsZGVyLmFkZFRva2VuKGJ1aWxkZXIsIGFsbFRleHQuc2xpY2UoYXQsIGF0ID0gc3R5bGVzW2kkMV0pLCBpbnRlcnByZXRUb2tlblN0eWxlKHN0eWxlc1tpJDErMV0sIGJ1aWxkZXIuY20ub3B0aW9ucykpOyB9CiAgICAgIHJldHVybgogICAgfQoKICAgIHZhciBsZW4gPSBhbGxUZXh0Lmxlbmd0aCwgcG9zID0gMCwgaSA9IDEsIHRleHQgPSAiIiwgc3R5bGUsIGNzczsKICAgIHZhciBuZXh0Q2hhbmdlID0gMCwgc3BhblN0eWxlLCBzcGFuRW5kU3R5bGUsIHNwYW5TdGFydFN0eWxlLCBjb2xsYXBzZWQsIGF0dHJpYnV0ZXM7CiAgICBmb3IgKDs7KSB7CiAgICAgIGlmIChuZXh0Q2hhbmdlID09IHBvcykgeyAvLyBVcGRhdGUgY3VycmVudCBtYXJrZXIgc2V0CiAgICAgICAgc3BhblN0eWxlID0gc3BhbkVuZFN0eWxlID0gc3BhblN0YXJ0U3R5bGUgPSBjc3MgPSAiIjsKICAgICAgICBhdHRyaWJ1dGVzID0gbnVsbDsKICAgICAgICBjb2xsYXBzZWQgPSBudWxsOyBuZXh0Q2hhbmdlID0gSW5maW5pdHk7CiAgICAgICAgdmFyIGZvdW5kQm9va21hcmtzID0gW10sIGVuZFN0eWxlcyA9ICh2b2lkIDApOwogICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgc3BhbnMubGVuZ3RoOyArK2opIHsKICAgICAgICAgIHZhciBzcCA9IHNwYW5zW2pdLCBtID0gc3AubWFya2VyOwogICAgICAgICAgaWYgKG0udHlwZSA9PSAiYm9va21hcmsiICYmIHNwLmZyb20gPT0gcG9zICYmIG0ud2lkZ2V0Tm9kZSkgewogICAgICAgICAgICBmb3VuZEJvb2ttYXJrcy5wdXNoKG0pOwogICAgICAgICAgfSBlbHNlIGlmIChzcC5mcm9tIDw9IHBvcyAmJiAoc3AudG8gPT0gbnVsbCB8fCBzcC50byA+IHBvcyB8fCBtLmNvbGxhcHNlZCAmJiBzcC50byA9PSBwb3MgJiYgc3AuZnJvbSA9PSBwb3MpKSB7CiAgICAgICAgICAgIGlmIChzcC50byAhPSBudWxsICYmIHNwLnRvICE9IHBvcyAmJiBuZXh0Q2hhbmdlID4gc3AudG8pIHsKICAgICAgICAgICAgICBuZXh0Q2hhbmdlID0gc3AudG87CiAgICAgICAgICAgICAgc3BhbkVuZFN0eWxlID0gIiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG0uY2xhc3NOYW1lKSB7IHNwYW5TdHlsZSArPSAiICIgKyBtLmNsYXNzTmFtZTsgfQogICAgICAgICAgICBpZiAobS5jc3MpIHsgY3NzID0gKGNzcyA/IGNzcyArICI7IiA6ICIiKSArIG0uY3NzOyB9CiAgICAgICAgICAgIGlmIChtLnN0YXJ0U3R5bGUgJiYgc3AuZnJvbSA9PSBwb3MpIHsgc3BhblN0YXJ0U3R5bGUgKz0gIiAiICsgbS5zdGFydFN0eWxlOyB9CiAgICAgICAgICAgIGlmIChtLmVuZFN0eWxlICYmIHNwLnRvID09IG5leHRDaGFuZ2UpIHsgKGVuZFN0eWxlcyB8fCAoZW5kU3R5bGVzID0gW10pKS5wdXNoKG0uZW5kU3R5bGUsIHNwLnRvKTsgfQogICAgICAgICAgICAvLyBzdXBwb3J0IGZvciB0aGUgb2xkIHRpdGxlIHByb3BlcnR5CiAgICAgICAgICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9jb2RlbWlycm9yL0NvZGVNaXJyb3IvcHVsbC81NjczCiAgICAgICAgICAgIGlmIChtLnRpdGxlKSB7IChhdHRyaWJ1dGVzIHx8IChhdHRyaWJ1dGVzID0ge30pKS50aXRsZSA9IG0udGl0bGU7IH0KICAgICAgICAgICAgaWYgKG0uYXR0cmlidXRlcykgewogICAgICAgICAgICAgIGZvciAodmFyIGF0dHIgaW4gbS5hdHRyaWJ1dGVzKQogICAgICAgICAgICAgICAgeyAoYXR0cmlidXRlcyB8fCAoYXR0cmlidXRlcyA9IHt9KSlbYXR0cl0gPSBtLmF0dHJpYnV0ZXNbYXR0cl07IH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobS5jb2xsYXBzZWQgJiYgKCFjb2xsYXBzZWQgfHwgY29tcGFyZUNvbGxhcHNlZE1hcmtlcnMoY29sbGFwc2VkLm1hcmtlciwgbSkgPCAwKSkKICAgICAgICAgICAgICB7IGNvbGxhcHNlZCA9IHNwOyB9CiAgICAgICAgICB9IGVsc2UgaWYgKHNwLmZyb20gPiBwb3MgJiYgbmV4dENoYW5nZSA+IHNwLmZyb20pIHsKICAgICAgICAgICAgbmV4dENoYW5nZSA9IHNwLmZyb207CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChlbmRTdHlsZXMpIHsgZm9yICh2YXIgaiQxID0gMDsgaiQxIDwgZW5kU3R5bGVzLmxlbmd0aDsgaiQxICs9IDIpCiAgICAgICAgICB7IGlmIChlbmRTdHlsZXNbaiQxICsgMV0gPT0gbmV4dENoYW5nZSkgeyBzcGFuRW5kU3R5bGUgKz0gIiAiICsgZW5kU3R5bGVzW2okMV07IH0gfSB9CgogICAgICAgIGlmICghY29sbGFwc2VkIHx8IGNvbGxhcHNlZC5mcm9tID09IHBvcykgeyBmb3IgKHZhciBqJDIgPSAwOyBqJDIgPCBmb3VuZEJvb2ttYXJrcy5sZW5ndGg7ICsraiQyKQogICAgICAgICAgeyBidWlsZENvbGxhcHNlZFNwYW4oYnVpbGRlciwgMCwgZm91bmRCb29rbWFya3NbaiQyXSk7IH0gfQogICAgICAgIGlmIChjb2xsYXBzZWQgJiYgKGNvbGxhcHNlZC5mcm9tIHx8IDApID09IHBvcykgewogICAgICAgICAgYnVpbGRDb2xsYXBzZWRTcGFuKGJ1aWxkZXIsIChjb2xsYXBzZWQudG8gPT0gbnVsbCA/IGxlbiArIDEgOiBjb2xsYXBzZWQudG8pIC0gcG9zLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbGxhcHNlZC5tYXJrZXIsIGNvbGxhcHNlZC5mcm9tID09IG51bGwpOwogICAgICAgICAgaWYgKGNvbGxhcHNlZC50byA9PSBudWxsKSB7IHJldHVybiB9CiAgICAgICAgICBpZiAoY29sbGFwc2VkLnRvID09IHBvcykgeyBjb2xsYXBzZWQgPSBmYWxzZTsgfQogICAgICAgIH0KICAgICAgfQogICAgICBpZiAocG9zID49IGxlbikgeyBicmVhayB9CgogICAgICB2YXIgdXB0byA9IE1hdGgubWluKGxlbiwgbmV4dENoYW5nZSk7CiAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgaWYgKHRleHQpIHsKICAgICAgICAgIHZhciBlbmQgPSBwb3MgKyB0ZXh0Lmxlbmd0aDsKICAgICAgICAgIGlmICghY29sbGFwc2VkKSB7CiAgICAgICAgICAgIHZhciB0b2tlblRleHQgPSBlbmQgPiB1cHRvID8gdGV4dC5zbGljZSgwLCB1cHRvIC0gcG9zKSA6IHRleHQ7CiAgICAgICAgICAgIGJ1aWxkZXIuYWRkVG9rZW4oYnVpbGRlciwgdG9rZW5UZXh0LCBzdHlsZSA/IHN0eWxlICsgc3BhblN0eWxlIDogc3BhblN0eWxlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNwYW5TdGFydFN0eWxlLCBwb3MgKyB0b2tlblRleHQubGVuZ3RoID09IG5leHRDaGFuZ2UgPyBzcGFuRW5kU3R5bGUgOiAiIiwgY3NzLCBhdHRyaWJ1dGVzKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChlbmQgPj0gdXB0bykge3RleHQgPSB0ZXh0LnNsaWNlKHVwdG8gLSBwb3MpOyBwb3MgPSB1cHRvOyBicmVha30KICAgICAgICAgIHBvcyA9IGVuZDsKICAgICAgICAgIHNwYW5TdGFydFN0eWxlID0gIiI7CiAgICAgICAgfQogICAgICAgIHRleHQgPSBhbGxUZXh0LnNsaWNlKGF0LCBhdCA9IHN0eWxlc1tpKytdKTsKICAgICAgICBzdHlsZSA9IGludGVycHJldFRva2VuU3R5bGUoc3R5bGVzW2krK10sIGJ1aWxkZXIuY20ub3B0aW9ucyk7CiAgICAgIH0KICAgIH0KICB9CgoKICAvLyBUaGVzZSBvYmplY3RzIGFyZSB1c2VkIHRvIHJlcHJlc2VudCB0aGUgdmlzaWJsZSAoY3VycmVudGx5IGRyYXduKQogIC8vIHBhcnQgb2YgdGhlIGRvY3VtZW50LiBBIExpbmVWaWV3IG1heSBjb3JyZXNwb25kIHRvIG11bHRpcGxlCiAgLy8gbG9naWNhbCBsaW5lcywgaWYgdGhvc2UgYXJlIGNvbm5lY3RlZCBieSBjb2xsYXBzZWQgcmFuZ2VzLgogIGZ1bmN0aW9uIExpbmVWaWV3KGRvYywgbGluZSwgbGluZU4pIHsKICAgIC8vIFRoZSBzdGFydGluZyBsaW5lCiAgICB0aGlzLmxpbmUgPSBsaW5lOwogICAgLy8gQ29udGludWluZyBsaW5lcywgaWYgYW55CiAgICB0aGlzLnJlc3QgPSB2aXN1YWxMaW5lQ29udGludWVkKGxpbmUpOwogICAgLy8gTnVtYmVyIG9mIGxvZ2ljYWwgbGluZXMgaW4gdGhpcyB2aXN1YWwgbGluZQogICAgdGhpcy5zaXplID0gdGhpcy5yZXN0ID8gbGluZU5vKGxzdCh0aGlzLnJlc3QpKSAtIGxpbmVOICsgMSA6IDE7CiAgICB0aGlzLm5vZGUgPSB0aGlzLnRleHQgPSBudWxsOwogICAgdGhpcy5oaWRkZW4gPSBsaW5lSXNIaWRkZW4oZG9jLCBsaW5lKTsKICB9CgogIC8vIENyZWF0ZSBhIHJhbmdlIG9mIExpbmVWaWV3IG9iamVjdHMgZm9yIHRoZSBnaXZlbiBsaW5lcy4KICBmdW5jdGlvbiBidWlsZFZpZXdBcnJheShjbSwgZnJvbSwgdG8pIHsKICAgIHZhciBhcnJheSA9IFtdLCBuZXh0UG9zOwogICAgZm9yICh2YXIgcG9zID0gZnJvbTsgcG9zIDwgdG87IHBvcyA9IG5leHRQb3MpIHsKICAgICAgdmFyIHZpZXcgPSBuZXcgTGluZVZpZXcoY20uZG9jLCBnZXRMaW5lKGNtLmRvYywgcG9zKSwgcG9zKTsKICAgICAgbmV4dFBvcyA9IHBvcyArIHZpZXcuc2l6ZTsKICAgICAgYXJyYXkucHVzaCh2aWV3KTsKICAgIH0KICAgIHJldHVybiBhcnJheQogIH0KCiAgdmFyIG9wZXJhdGlvbkdyb3VwID0gbnVsbDsKCiAgZnVuY3Rpb24gcHVzaE9wZXJhdGlvbihvcCkgewogICAgaWYgKG9wZXJhdGlvbkdyb3VwKSB7CiAgICAgIG9wZXJhdGlvbkdyb3VwLm9wcy5wdXNoKG9wKTsKICAgIH0gZWxzZSB7CiAgICAgIG9wLm93bnNHcm91cCA9IG9wZXJhdGlvbkdyb3VwID0gewogICAgICAgIG9wczogW29wXSwKICAgICAgICBkZWxheWVkQ2FsbGJhY2tzOiBbXQogICAgICB9OwogICAgfQogIH0KCiAgZnVuY3Rpb24gZmlyZUNhbGxiYWNrc0Zvck9wcyhncm91cCkgewogICAgLy8gQ2FsbHMgZGVsYXllZCBjYWxsYmFja3MgYW5kIGN1cnNvckFjdGl2aXR5IGhhbmRsZXJzIHVudGlsIG5vCiAgICAvLyBuZXcgb25lcyBhcHBlYXIKICAgIHZhciBjYWxsYmFja3MgPSBncm91cC5kZWxheWVkQ2FsbGJhY2tzLCBpID0gMDsKICAgIGRvIHsKICAgICAgZm9yICg7IGkgPCBjYWxsYmFja3MubGVuZ3RoOyBpKyspCiAgICAgICAgeyBjYWxsYmFja3NbaV0uY2FsbChudWxsKTsgfQogICAgICBmb3IgKHZhciBqID0gMDsgaiA8IGdyb3VwLm9wcy5sZW5ndGg7IGorKykgewogICAgICAgIHZhciBvcCA9IGdyb3VwLm9wc1tqXTsKICAgICAgICBpZiAob3AuY3Vyc29yQWN0aXZpdHlIYW5kbGVycykKICAgICAgICAgIHsgd2hpbGUgKG9wLmN1cnNvckFjdGl2aXR5Q2FsbGVkIDwgb3AuY3Vyc29yQWN0aXZpdHlIYW5kbGVycy5sZW5ndGgpCiAgICAgICAgICAgIHsgb3AuY3Vyc29yQWN0aXZpdHlIYW5kbGVyc1tvcC5jdXJzb3JBY3Rpdml0eUNhbGxlZCsrXS5jYWxsKG51bGwsIG9wLmNtKTsgfSB9CiAgICAgIH0KICAgIH0gd2hpbGUgKGkgPCBjYWxsYmFja3MubGVuZ3RoKQogIH0KCiAgZnVuY3Rpb24gZmluaXNoT3BlcmF0aW9uKG9wLCBlbmRDYikgewogICAgdmFyIGdyb3VwID0gb3Aub3duc0dyb3VwOwogICAgaWYgKCFncm91cCkgeyByZXR1cm4gfQoKICAgIHRyeSB7IGZpcmVDYWxsYmFja3NGb3JPcHMoZ3JvdXApOyB9CiAgICBmaW5hbGx5IHsKICAgICAgb3BlcmF0aW9uR3JvdXAgPSBudWxsOwogICAgICBlbmRDYihncm91cCk7CiAgICB9CiAgfQoKICB2YXIgb3JwaGFuRGVsYXllZENhbGxiYWNrcyA9IG51bGw7CgogIC8vIE9mdGVuLCB3ZSB3YW50IHRvIHNpZ25hbCBldmVudHMgYXQgYSBwb2ludCB3aGVyZSB3ZSBhcmUgaW4gdGhlCiAgLy8gbWlkZGxlIG9mIHNvbWUgd29yaywgYnV0IGRvbid0IHdhbnQgdGhlIGhhbmRsZXIgdG8gc3RhcnQgY2FsbGluZwogIC8vIG90aGVyIG1ldGhvZHMgb24gdGhlIGVkaXRvciwgd2hpY2ggbWlnaHQgYmUgaW4gYW4gaW5jb25zaXN0ZW50CiAgLy8gc3RhdGUgb3Igc2ltcGx5IG5vdCBleHBlY3QgYW55IG90aGVyIGV2ZW50cyB0byBoYXBwZW4uCiAgLy8gc2lnbmFsTGF0ZXIgbG9va3Mgd2hldGhlciB0aGVyZSBhcmUgYW55IGhhbmRsZXJzLCBhbmQgc2NoZWR1bGVzCiAgLy8gdGhlbSB0byBiZSBleGVjdXRlZCB3aGVuIHRoZSBsYXN0IG9wZXJhdGlvbiBlbmRzLCBvciwgaWYgbm8KICAvLyBvcGVyYXRpb24gaXMgYWN0aXZlLCB3aGVuIGEgdGltZW91dCBmaXJlcy4KICBmdW5jdGlvbiBzaWduYWxMYXRlcihlbWl0dGVyLCB0eXBlIC8qLCB2YWx1ZXMuLi4qLykgewogICAgdmFyIGFyciA9IGdldEhhbmRsZXJzKGVtaXR0ZXIsIHR5cGUpOwogICAgaWYgKCFhcnIubGVuZ3RoKSB7IHJldHVybiB9CiAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMiksIGxpc3Q7CiAgICBpZiAob3BlcmF0aW9uR3JvdXApIHsKICAgICAgbGlzdCA9IG9wZXJhdGlvbkdyb3VwLmRlbGF5ZWRDYWxsYmFja3M7CiAgICB9IGVsc2UgaWYgKG9ycGhhbkRlbGF5ZWRDYWxsYmFja3MpIHsKICAgICAgbGlzdCA9IG9ycGhhbkRlbGF5ZWRDYWxsYmFja3M7CiAgICB9IGVsc2UgewogICAgICBsaXN0ID0gb3JwaGFuRGVsYXllZENhbGxiYWNrcyA9IFtdOwogICAgICBzZXRUaW1lb3V0KGZpcmVPcnBoYW5EZWxheWVkLCAwKTsKICAgIH0KICAgIHZhciBsb29wID0gZnVuY3Rpb24gKCBpICkgewogICAgICBsaXN0LnB1c2goZnVuY3Rpb24gKCkgeyByZXR1cm4gYXJyW2ldLmFwcGx5KG51bGwsIGFyZ3MpOyB9KTsKICAgIH07CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyArK2kpCiAgICAgIGxvb3AoIGkgKTsKICB9CgogIGZ1bmN0aW9uIGZpcmVPcnBoYW5EZWxheWVkKCkgewogICAgdmFyIGRlbGF5ZWQgPSBvcnBoYW5EZWxheWVkQ2FsbGJhY2tzOwogICAgb3JwaGFuRGVsYXllZENhbGxiYWNrcyA9IG51bGw7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRlbGF5ZWQubGVuZ3RoOyArK2kpIHsgZGVsYXllZFtpXSgpOyB9CiAgfQoKICAvLyBXaGVuIGFuIGFzcGVjdCBvZiBhIGxpbmUgY2hhbmdlcywgYSBzdHJpbmcgaXMgYWRkZWQgdG8KICAvLyBsaW5lVmlldy5jaGFuZ2VzLiBUaGlzIHVwZGF0ZXMgdGhlIHJlbGV2YW50IHBhcnQgb2YgdGhlIGxpbmUncwogIC8vIERPTSBzdHJ1Y3R1cmUuCiAgZnVuY3Rpb24gdXBkYXRlTGluZUZvckNoYW5nZXMoY20sIGxpbmVWaWV3LCBsaW5lTiwgZGltcykgewogICAgZm9yICh2YXIgaiA9IDA7IGogPCBsaW5lVmlldy5jaGFuZ2VzLmxlbmd0aDsgaisrKSB7CiAgICAgIHZhciB0eXBlID0gbGluZVZpZXcuY2hhbmdlc1tqXTsKICAgICAgaWYgKHR5cGUgPT0gInRleHQiKSB7IHVwZGF0ZUxpbmVUZXh0KGNtLCBsaW5lVmlldyk7IH0KICAgICAgZWxzZSBpZiAodHlwZSA9PSAiZ3V0dGVyIikgeyB1cGRhdGVMaW5lR3V0dGVyKGNtLCBsaW5lVmlldywgbGluZU4sIGRpbXMpOyB9CiAgICAgIGVsc2UgaWYgKHR5cGUgPT0gImNsYXNzIikgeyB1cGRhdGVMaW5lQ2xhc3NlcyhjbSwgbGluZVZpZXcpOyB9CiAgICAgIGVsc2UgaWYgKHR5cGUgPT0gIndpZGdldCIpIHsgdXBkYXRlTGluZVdpZGdldHMoY20sIGxpbmVWaWV3LCBkaW1zKTsgfQogICAgfQogICAgbGluZVZpZXcuY2hhbmdlcyA9IG51bGw7CiAgfQoKICAvLyBMaW5lcyB3aXRoIGd1dHRlciBlbGVtZW50cywgd2lkZ2V0cyBvciBhIGJhY2tncm91bmQgY2xhc3MgbmVlZCB0bwogIC8vIGJlIHdyYXBwZWQsIGFuZCBoYXZlIHRoZSBleHRyYSBlbGVtZW50cyBhZGRlZCB0byB0aGUgd3JhcHBlciBkaXYKICBmdW5jdGlvbiBlbnN1cmVMaW5lV3JhcHBlZChsaW5lVmlldykgewogICAgaWYgKGxpbmVWaWV3Lm5vZGUgPT0gbGluZVZpZXcudGV4dCkgewogICAgICBsaW5lVmlldy5ub2RlID0gZWx0KCJkaXYiLCBudWxsLCBudWxsLCAicG9zaXRpb246IHJlbGF0aXZlIik7CiAgICAgIGlmIChsaW5lVmlldy50ZXh0LnBhcmVudE5vZGUpCiAgICAgICAgeyBsaW5lVmlldy50ZXh0LnBhcmVudE5vZGUucmVwbGFjZUNoaWxkKGxpbmVWaWV3Lm5vZGUsIGxpbmVWaWV3LnRleHQpOyB9CiAgICAgIGxpbmVWaWV3Lm5vZGUuYXBwZW5kQ2hpbGQobGluZVZpZXcudGV4dCk7CiAgICAgIGlmIChpZSAmJiBpZV92ZXJzaW9uIDwgOCkgeyBsaW5lVmlldy5ub2RlLnN0eWxlLnpJbmRleCA9IDI7IH0KICAgIH0KICAgIHJldHVybiBsaW5lVmlldy5ub2RlCiAgfQoKICBmdW5jdGlvbiB1cGRhdGVMaW5lQmFja2dyb3VuZChjbSwgbGluZVZpZXcpIHsKICAgIHZhciBjbHMgPSBsaW5lVmlldy5iZ0NsYXNzID8gbGluZVZpZXcuYmdDbGFzcyArICIgIiArIChsaW5lVmlldy5saW5lLmJnQ2xhc3MgfHwgIiIpIDogbGluZVZpZXcubGluZS5iZ0NsYXNzOwogICAgaWYgKGNscykgeyBjbHMgKz0gIiBDb2RlTWlycm9yLWxpbmViYWNrZ3JvdW5kIjsgfQogICAgaWYgKGxpbmVWaWV3LmJhY2tncm91bmQpIHsKICAgICAgaWYgKGNscykgeyBsaW5lVmlldy5iYWNrZ3JvdW5kLmNsYXNzTmFtZSA9IGNsczsgfQogICAgICBlbHNlIHsgbGluZVZpZXcuYmFja2dyb3VuZC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGxpbmVWaWV3LmJhY2tncm91bmQpOyBsaW5lVmlldy5iYWNrZ3JvdW5kID0gbnVsbDsgfQogICAgfSBlbHNlIGlmIChjbHMpIHsKICAgICAgdmFyIHdyYXAgPSBlbnN1cmVMaW5lV3JhcHBlZChsaW5lVmlldyk7CiAgICAgIGxpbmVWaWV3LmJhY2tncm91bmQgPSB3cmFwLmluc2VydEJlZm9yZShlbHQoImRpdiIsIG51bGwsIGNscyksIHdyYXAuZmlyc3RDaGlsZCk7CiAgICAgIGNtLmRpc3BsYXkuaW5wdXQuc2V0VW5lZGl0YWJsZShsaW5lVmlldy5iYWNrZ3JvdW5kKTsKICAgIH0KICB9CgogIC8vIFdyYXBwZXIgYXJvdW5kIGJ1aWxkTGluZUNvbnRlbnQgd2hpY2ggd2lsbCByZXVzZSB0aGUgc3RydWN0dXJlCiAgLy8gaW4gZGlzcGxheS5leHRlcm5hbE1lYXN1cmVkIHdoZW4gcG9zc2libGUuCiAgZnVuY3Rpb24gZ2V0TGluZUNvbnRlbnQoY20sIGxpbmVWaWV3KSB7CiAgICB2YXIgZXh0ID0gY20uZGlzcGxheS5leHRlcm5hbE1lYXN1cmVkOwogICAgaWYgKGV4dCAmJiBleHQubGluZSA9PSBsaW5lVmlldy5saW5lKSB7CiAgICAgIGNtLmRpc3BsYXkuZXh0ZXJuYWxNZWFzdXJlZCA9IG51bGw7CiAgICAgIGxpbmVWaWV3Lm1lYXN1cmUgPSBleHQubWVhc3VyZTsKICAgICAgcmV0dXJuIGV4dC5idWlsdAogICAgfQogICAgcmV0dXJuIGJ1aWxkTGluZUNvbnRlbnQoY20sIGxpbmVWaWV3KQogIH0KCiAgLy8gUmVkcmF3IHRoZSBsaW5lJ3MgdGV4dC4gSW50ZXJhY3RzIHdpdGggdGhlIGJhY2tncm91bmQgYW5kIHRleHQKICAvLyBjbGFzc2VzIGJlY2F1c2UgdGhlIG1vZGUgbWF5IG91dHB1dCB0b2tlbnMgdGhhdCBpbmZsdWVuY2UgdGhlc2UKICAvLyBjbGFzc2VzLgogIGZ1bmN0aW9uIHVwZGF0ZUxpbmVUZXh0KGNtLCBsaW5lVmlldykgewogICAgdmFyIGNscyA9IGxpbmVWaWV3LnRleHQuY2xhc3NOYW1lOwogICAgdmFyIGJ1aWx0ID0gZ2V0TGluZUNvbnRlbnQoY20sIGxpbmVWaWV3KTsKICAgIGlmIChsaW5lVmlldy50ZXh0ID09IGxpbmVWaWV3Lm5vZGUpIHsgbGluZVZpZXcubm9kZSA9IGJ1aWx0LnByZTsgfQogICAgbGluZVZpZXcudGV4dC5wYXJlbnROb2RlLnJlcGxhY2VDaGlsZChidWlsdC5wcmUsIGxpbmVWaWV3LnRleHQpOwogICAgbGluZVZpZXcudGV4dCA9IGJ1aWx0LnByZTsKICAgIGlmIChidWlsdC5iZ0NsYXNzICE9IGxpbmVWaWV3LmJnQ2xhc3MgfHwgYnVpbHQudGV4dENsYXNzICE9IGxpbmVWaWV3LnRleHRDbGFzcykgewogICAgICBsaW5lVmlldy5iZ0NsYXNzID0gYnVpbHQuYmdDbGFzczsKICAgICAgbGluZVZpZXcudGV4dENsYXNzID0gYnVpbHQudGV4dENsYXNzOwogICAgICB1cGRhdGVMaW5lQ2xhc3NlcyhjbSwgbGluZVZpZXcpOwogICAgfSBlbHNlIGlmIChjbHMpIHsKICAgICAgbGluZVZpZXcudGV4dC5jbGFzc05hbWUgPSBjbHM7CiAgICB9CiAgfQoKICBmdW5jdGlvbiB1cGRhdGVMaW5lQ2xhc3NlcyhjbSwgbGluZVZpZXcpIHsKICAgIHVwZGF0ZUxpbmVCYWNrZ3JvdW5kKGNtLCBsaW5lVmlldyk7CiAgICBpZiAobGluZVZpZXcubGluZS53cmFwQ2xhc3MpCiAgICAgIHsgZW5zdXJlTGluZVdyYXBwZWQobGluZVZpZXcpLmNsYXNzTmFtZSA9IGxpbmVWaWV3LmxpbmUud3JhcENsYXNzOyB9CiAgICBlbHNlIGlmIChsaW5lVmlldy5ub2RlICE9IGxpbmVWaWV3LnRleHQpCiAgICAgIHsgbGluZVZpZXcubm9kZS5jbGFzc05hbWUgPSAiIjsgfQogICAgdmFyIHRleHRDbGFzcyA9IGxpbmVWaWV3LnRleHRDbGFzcyA/IGxpbmVWaWV3LnRleHRDbGFzcyArICIgIiArIChsaW5lVmlldy5saW5lLnRleHRDbGFzcyB8fCAiIikgOiBsaW5lVmlldy5saW5lLnRleHRDbGFzczsKICAgIGxpbmVWaWV3LnRleHQuY2xhc3NOYW1lID0gdGV4dENsYXNzIHx8ICIiOwogIH0KCiAgZnVuY3Rpb24gdXBkYXRlTGluZUd1dHRlcihjbSwgbGluZVZpZXcsIGxpbmVOLCBkaW1zKSB7CiAgICBpZiAobGluZVZpZXcuZ3V0dGVyKSB7CiAgICAgIGxpbmVWaWV3Lm5vZGUucmVtb3ZlQ2hpbGQobGluZVZpZXcuZ3V0dGVyKTsKICAgICAgbGluZVZpZXcuZ3V0dGVyID0gbnVsbDsKICAgIH0KICAgIGlmIChsaW5lVmlldy5ndXR0ZXJCYWNrZ3JvdW5kKSB7CiAgICAgIGxpbmVWaWV3Lm5vZGUucmVtb3ZlQ2hpbGQobGluZVZpZXcuZ3V0dGVyQmFja2dyb3VuZCk7CiAgICAgIGxpbmVWaWV3Lmd1dHRlckJhY2tncm91bmQgPSBudWxsOwogICAgfQogICAgaWYgKGxpbmVWaWV3LmxpbmUuZ3V0dGVyQ2xhc3MpIHsKICAgICAgdmFyIHdyYXAgPSBlbnN1cmVMaW5lV3JhcHBlZChsaW5lVmlldyk7CiAgICAgIGxpbmVWaWV3Lmd1dHRlckJhY2tncm91bmQgPSBlbHQoImRpdiIsIG51bGwsICJDb2RlTWlycm9yLWd1dHRlci1iYWNrZ3JvdW5kICIgKyBsaW5lVmlldy5saW5lLmd1dHRlckNsYXNzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICgibGVmdDogIiArIChjbS5vcHRpb25zLmZpeGVkR3V0dGVyID8gZGltcy5maXhlZFBvcyA6IC1kaW1zLmd1dHRlclRvdGFsV2lkdGgpICsgInB4OyB3aWR0aDogIiArIChkaW1zLmd1dHRlclRvdGFsV2lkdGgpICsgInB4IikpOwogICAgICBjbS5kaXNwbGF5LmlucHV0LnNldFVuZWRpdGFibGUobGluZVZpZXcuZ3V0dGVyQmFja2dyb3VuZCk7CiAgICAgIHdyYXAuaW5zZXJ0QmVmb3JlKGxpbmVWaWV3Lmd1dHRlckJhY2tncm91bmQsIGxpbmVWaWV3LnRleHQpOwogICAgfQogICAgdmFyIG1hcmtlcnMgPSBsaW5lVmlldy5saW5lLmd1dHRlck1hcmtlcnM7CiAgICBpZiAoY20ub3B0aW9ucy5saW5lTnVtYmVycyB8fCBtYXJrZXJzKSB7CiAgICAgIHZhciB3cmFwJDEgPSBlbnN1cmVMaW5lV3JhcHBlZChsaW5lVmlldyk7CiAgICAgIHZhciBndXR0ZXJXcmFwID0gbGluZVZpZXcuZ3V0dGVyID0gZWx0KCJkaXYiLCBudWxsLCAiQ29kZU1pcnJvci1ndXR0ZXItd3JhcHBlciIsICgibGVmdDogIiArIChjbS5vcHRpb25zLmZpeGVkR3V0dGVyID8gZGltcy5maXhlZFBvcyA6IC1kaW1zLmd1dHRlclRvdGFsV2lkdGgpICsgInB4IikpOwogICAgICBjbS5kaXNwbGF5LmlucHV0LnNldFVuZWRpdGFibGUoZ3V0dGVyV3JhcCk7CiAgICAgIHdyYXAkMS5pbnNlcnRCZWZvcmUoZ3V0dGVyV3JhcCwgbGluZVZpZXcudGV4dCk7CiAgICAgIGlmIChsaW5lVmlldy5saW5lLmd1dHRlckNsYXNzKQogICAgICAgIHsgZ3V0dGVyV3JhcC5jbGFzc05hbWUgKz0gIiAiICsgbGluZVZpZXcubGluZS5ndXR0ZXJDbGFzczsgfQogICAgICBpZiAoY20ub3B0aW9ucy5saW5lTnVtYmVycyAmJiAoIW1hcmtlcnMgfHwgIW1hcmtlcnNbIkNvZGVNaXJyb3ItbGluZW51bWJlcnMiXSkpCiAgICAgICAgeyBsaW5lVmlldy5saW5lTnVtYmVyID0gZ3V0dGVyV3JhcC5hcHBlbmRDaGlsZCgKICAgICAgICAgIGVsdCgiZGl2IiwgbGluZU51bWJlckZvcihjbS5vcHRpb25zLCBsaW5lTiksCiAgICAgICAgICAgICAgIkNvZGVNaXJyb3ItbGluZW51bWJlciBDb2RlTWlycm9yLWd1dHRlci1lbHQiLAogICAgICAgICAgICAgICgibGVmdDogIiArIChkaW1zLmd1dHRlckxlZnRbIkNvZGVNaXJyb3ItbGluZW51bWJlcnMiXSkgKyAicHg7IHdpZHRoOiAiICsgKGNtLmRpc3BsYXkubGluZU51bUlubmVyV2lkdGgpICsgInB4IikpKTsgfQogICAgICBpZiAobWFya2VycykgeyBmb3IgKHZhciBrID0gMDsgayA8IGNtLmRpc3BsYXkuZ3V0dGVyU3BlY3MubGVuZ3RoOyArK2spIHsKICAgICAgICB2YXIgaWQgPSBjbS5kaXNwbGF5Lmd1dHRlclNwZWNzW2tdLmNsYXNzTmFtZSwgZm91bmQgPSBtYXJrZXJzLmhhc093blByb3BlcnR5KGlkKSAmJiBtYXJrZXJzW2lkXTsKICAgICAgICBpZiAoZm91bmQpCiAgICAgICAgICB7IGd1dHRlcldyYXAuYXBwZW5kQ2hpbGQoZWx0KCJkaXYiLCBbZm91bmRdLCAiQ29kZU1pcnJvci1ndXR0ZXItZWx0IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICgibGVmdDogIiArIChkaW1zLmd1dHRlckxlZnRbaWRdKSArICJweDsgd2lkdGg6ICIgKyAoZGltcy5ndXR0ZXJXaWR0aFtpZF0pICsgInB4IikpKTsgfQogICAgICB9IH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIHVwZGF0ZUxpbmVXaWRnZXRzKGNtLCBsaW5lVmlldywgZGltcykgewogICAgaWYgKGxpbmVWaWV3LmFsaWduYWJsZSkgeyBsaW5lVmlldy5hbGlnbmFibGUgPSBudWxsOyB9CiAgICBmb3IgKHZhciBub2RlID0gbGluZVZpZXcubm9kZS5maXJzdENoaWxkLCBuZXh0ID0gKHZvaWQgMCk7IG5vZGU7IG5vZGUgPSBuZXh0KSB7CiAgICAgIG5leHQgPSBub2RlLm5leHRTaWJsaW5nOwogICAgICBpZiAobm9kZS5jbGFzc05hbWUgPT0gIkNvZGVNaXJyb3ItbGluZXdpZGdldCIpCiAgICAgICAgeyBsaW5lVmlldy5ub2RlLnJlbW92ZUNoaWxkKG5vZGUpOyB9CiAgICB9CiAgICBpbnNlcnRMaW5lV2lkZ2V0cyhjbSwgbGluZVZpZXcsIGRpbXMpOwogIH0KCiAgLy8gQnVpbGQgYSBsaW5lJ3MgRE9NIHJlcHJlc2VudGF0aW9uIGZyb20gc2NyYXRjaAogIGZ1bmN0aW9uIGJ1aWxkTGluZUVsZW1lbnQoY20sIGxpbmVWaWV3LCBsaW5lTiwgZGltcykgewogICAgdmFyIGJ1aWx0ID0gZ2V0TGluZUNvbnRlbnQoY20sIGxpbmVWaWV3KTsKICAgIGxpbmVWaWV3LnRleHQgPSBsaW5lVmlldy5ub2RlID0gYnVpbHQucHJlOwogICAgaWYgKGJ1aWx0LmJnQ2xhc3MpIHsgbGluZVZpZXcuYmdDbGFzcyA9IGJ1aWx0LmJnQ2xhc3M7IH0KICAgIGlmIChidWlsdC50ZXh0Q2xhc3MpIHsgbGluZVZpZXcudGV4dENsYXNzID0gYnVpbHQudGV4dENsYXNzOyB9CgogICAgdXBkYXRlTGluZUNsYXNzZXMoY20sIGxpbmVWaWV3KTsKICAgIHVwZGF0ZUxpbmVHdXR0ZXIoY20sIGxpbmVWaWV3LCBsaW5lTiwgZGltcyk7CiAgICBpbnNlcnRMaW5lV2lkZ2V0cyhjbSwgbGluZVZpZXcsIGRpbXMpOwogICAgcmV0dXJuIGxpbmVWaWV3Lm5vZGUKICB9CgogIC8vIEEgbGluZVZpZXcgbWF5IGNvbnRhaW4gbXVsdGlwbGUgbG9naWNhbCBsaW5lcyAod2hlbiBtZXJnZWQgYnkKICAvLyBjb2xsYXBzZWQgc3BhbnMpLiBUaGUgd2lkZ2V0cyBmb3IgYWxsIG9mIHRoZW0gbmVlZCB0byBiZSBkcmF3bi4KICBmdW5jdGlvbiBpbnNlcnRMaW5lV2lkZ2V0cyhjbSwgbGluZVZpZXcsIGRpbXMpIHsKICAgIGluc2VydExpbmVXaWRnZXRzRm9yKGNtLCBsaW5lVmlldy5saW5lLCBsaW5lVmlldywgZGltcywgdHJ1ZSk7CiAgICBpZiAobGluZVZpZXcucmVzdCkgeyBmb3IgKHZhciBpID0gMDsgaSA8IGxpbmVWaWV3LnJlc3QubGVuZ3RoOyBpKyspCiAgICAgIHsgaW5zZXJ0TGluZVdpZGdldHNGb3IoY20sIGxpbmVWaWV3LnJlc3RbaV0sIGxpbmVWaWV3LCBkaW1zLCBmYWxzZSk7IH0gfQogIH0KCiAgZnVuY3Rpb24gaW5zZXJ0TGluZVdpZGdldHNGb3IoY20sIGxpbmUsIGxpbmVWaWV3LCBkaW1zLCBhbGxvd0Fib3ZlKSB7CiAgICBpZiAoIWxpbmUud2lkZ2V0cykgeyByZXR1cm4gfQogICAgdmFyIHdyYXAgPSBlbnN1cmVMaW5lV3JhcHBlZChsaW5lVmlldyk7CiAgICBmb3IgKHZhciBpID0gMCwgd3MgPSBsaW5lLndpZGdldHM7IGkgPCB3cy5sZW5ndGg7ICsraSkgewogICAgICB2YXIgd2lkZ2V0ID0gd3NbaV0sIG5vZGUgPSBlbHQoImRpdiIsIFt3aWRnZXQubm9kZV0sICJDb2RlTWlycm9yLWxpbmV3aWRnZXQiKTsKICAgICAgaWYgKCF3aWRnZXQuaGFuZGxlTW91c2VFdmVudHMpIHsgbm9kZS5zZXRBdHRyaWJ1dGUoImNtLWlnbm9yZS1ldmVudHMiLCAidHJ1ZSIpOyB9CiAgICAgIHBvc2l0aW9uTGluZVdpZGdldCh3aWRnZXQsIG5vZGUsIGxpbmVWaWV3LCBkaW1zKTsKICAgICAgY20uZGlzcGxheS5pbnB1dC5zZXRVbmVkaXRhYmxlKG5vZGUpOwogICAgICBpZiAoYWxsb3dBYm92ZSAmJiB3aWRnZXQuYWJvdmUpCiAgICAgICAgeyB3cmFwLmluc2VydEJlZm9yZShub2RlLCBsaW5lVmlldy5ndXR0ZXIgfHwgbGluZVZpZXcudGV4dCk7IH0KICAgICAgZWxzZQogICAgICAgIHsgd3JhcC5hcHBlbmRDaGlsZChub2RlKTsgfQogICAgICBzaWduYWxMYXRlcih3aWRnZXQsICJyZWRyYXciKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHBvc2l0aW9uTGluZVdpZGdldCh3aWRnZXQsIG5vZGUsIGxpbmVWaWV3LCBkaW1zKSB7CiAgICBpZiAod2lkZ2V0Lm5vSFNjcm9sbCkgewogIChsaW5lVmlldy5hbGlnbmFibGUgfHwgKGxpbmVWaWV3LmFsaWduYWJsZSA9IFtdKSkucHVzaChub2RlKTsKICAgICAgdmFyIHdpZHRoID0gZGltcy53cmFwcGVyV2lkdGg7CiAgICAgIG5vZGUuc3R5bGUubGVmdCA9IGRpbXMuZml4ZWRQb3MgKyAicHgiOwogICAgICBpZiAoIXdpZGdldC5jb3Zlckd1dHRlcikgewogICAgICAgIHdpZHRoIC09IGRpbXMuZ3V0dGVyVG90YWxXaWR0aDsKICAgICAgICBub2RlLnN0eWxlLnBhZGRpbmdMZWZ0ID0gZGltcy5ndXR0ZXJUb3RhbFdpZHRoICsgInB4IjsKICAgICAgfQogICAgICBub2RlLnN0eWxlLndpZHRoID0gd2lkdGggKyAicHgiOwogICAgfQogICAgaWYgKHdpZGdldC5jb3Zlckd1dHRlcikgewogICAgICBub2RlLnN0eWxlLnpJbmRleCA9IDU7CiAgICAgIG5vZGUuc3R5bGUucG9zaXRpb24gPSAicmVsYXRpdmUiOwogICAgICBpZiAoIXdpZGdldC5ub0hTY3JvbGwpIHsgbm9kZS5zdHlsZS5tYXJnaW5MZWZ0ID0gLWRpbXMuZ3V0dGVyVG90YWxXaWR0aCArICJweCI7IH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIHdpZGdldEhlaWdodCh3aWRnZXQpIHsKICAgIGlmICh3aWRnZXQuaGVpZ2h0ICE9IG51bGwpIHsgcmV0dXJuIHdpZGdldC5oZWlnaHQgfQogICAgdmFyIGNtID0gd2lkZ2V0LmRvYy5jbTsKICAgIGlmICghY20pIHsgcmV0dXJuIDAgfQogICAgaWYgKCFjb250YWlucyhkb2N1bWVudC5ib2R5LCB3aWRnZXQubm9kZSkpIHsKICAgICAgdmFyIHBhcmVudFN0eWxlID0gInBvc2l0aW9uOiByZWxhdGl2ZTsiOwogICAgICBpZiAod2lkZ2V0LmNvdmVyR3V0dGVyKQogICAgICAgIHsgcGFyZW50U3R5bGUgKz0gIm1hcmdpbi1sZWZ0OiAtIiArIGNtLmRpc3BsYXkuZ3V0dGVycy5vZmZzZXRXaWR0aCArICJweDsiOyB9CiAgICAgIGlmICh3aWRnZXQubm9IU2Nyb2xsKQogICAgICAgIHsgcGFyZW50U3R5bGUgKz0gIndpZHRoOiAiICsgY20uZGlzcGxheS53cmFwcGVyLmNsaWVudFdpZHRoICsgInB4OyI7IH0KICAgICAgcmVtb3ZlQ2hpbGRyZW5BbmRBZGQoY20uZGlzcGxheS5tZWFzdXJlLCBlbHQoImRpdiIsIFt3aWRnZXQubm9kZV0sIG51bGwsIHBhcmVudFN0eWxlKSk7CiAgICB9CiAgICByZXR1cm4gd2lkZ2V0LmhlaWdodCA9IHdpZGdldC5ub2RlLnBhcmVudE5vZGUub2Zmc2V0SGVpZ2h0CiAgfQoKICAvLyBSZXR1cm4gdHJ1ZSB3aGVuIHRoZSBnaXZlbiBtb3VzZSBldmVudCBoYXBwZW5lZCBpbiBhIHdpZGdldAogIGZ1bmN0aW9uIGV2ZW50SW5XaWRnZXQoZGlzcGxheSwgZSkgewogICAgZm9yICh2YXIgbiA9IGVfdGFyZ2V0KGUpOyBuICE9IGRpc3BsYXkud3JhcHBlcjsgbiA9IG4ucGFyZW50Tm9kZSkgewogICAgICBpZiAoIW4gfHwgKG4ubm9kZVR5cGUgPT0gMSAmJiBuLmdldEF0dHJpYnV0ZSgiY20taWdub3JlLWV2ZW50cyIpID09ICJ0cnVlIikgfHwKICAgICAgICAgIChuLnBhcmVudE5vZGUgPT0gZGlzcGxheS5zaXplciAmJiBuICE9IGRpc3BsYXkubW92ZXIpKQogICAgICAgIHsgcmV0dXJuIHRydWUgfQogICAgfQogIH0KCiAgLy8gUE9TSVRJT04gTUVBU1VSRU1FTlQKCiAgZnVuY3Rpb24gcGFkZGluZ1RvcChkaXNwbGF5KSB7cmV0dXJuIGRpc3BsYXkubGluZVNwYWNlLm9mZnNldFRvcH0KICBmdW5jdGlvbiBwYWRkaW5nVmVydChkaXNwbGF5KSB7cmV0dXJuIGRpc3BsYXkubW92ZXIub2Zmc2V0SGVpZ2h0IC0gZGlzcGxheS5saW5lU3BhY2Uub2Zmc2V0SGVpZ2h0fQogIGZ1bmN0aW9uIHBhZGRpbmdIKGRpc3BsYXkpIHsKICAgIGlmIChkaXNwbGF5LmNhY2hlZFBhZGRpbmdIKSB7IHJldHVybiBkaXNwbGF5LmNhY2hlZFBhZGRpbmdIIH0KICAgIHZhciBlID0gcmVtb3ZlQ2hpbGRyZW5BbmRBZGQoZGlzcGxheS5tZWFzdXJlLCBlbHQoInByZSIsICJ4IiwgIkNvZGVNaXJyb3ItbGluZS1saWtlIikpOwogICAgdmFyIHN0eWxlID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUgPyB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShlKSA6IGUuY3VycmVudFN0eWxlOwogICAgdmFyIGRhdGEgPSB7bGVmdDogcGFyc2VJbnQoc3R5bGUucGFkZGluZ0xlZnQpLCByaWdodDogcGFyc2VJbnQoc3R5bGUucGFkZGluZ1JpZ2h0KX07CiAgICBpZiAoIWlzTmFOKGRhdGEubGVmdCkgJiYgIWlzTmFOKGRhdGEucmlnaHQpKSB7IGRpc3BsYXkuY2FjaGVkUGFkZGluZ0ggPSBkYXRhOyB9CiAgICByZXR1cm4gZGF0YQogIH0KCiAgZnVuY3Rpb24gc2Nyb2xsR2FwKGNtKSB7IHJldHVybiBzY3JvbGxlckdhcCAtIGNtLmRpc3BsYXkubmF0aXZlQmFyV2lkdGggfQogIGZ1bmN0aW9uIGRpc3BsYXlXaWR0aChjbSkgewogICAgcmV0dXJuIGNtLmRpc3BsYXkuc2Nyb2xsZXIuY2xpZW50V2lkdGggLSBzY3JvbGxHYXAoY20pIC0gY20uZGlzcGxheS5iYXJXaWR0aAogIH0KICBmdW5jdGlvbiBkaXNwbGF5SGVpZ2h0KGNtKSB7CiAgICByZXR1cm4gY20uZGlzcGxheS5zY3JvbGxlci5jbGllbnRIZWlnaHQgLSBzY3JvbGxHYXAoY20pIC0gY20uZGlzcGxheS5iYXJIZWlnaHQKICB9CgogIC8vIEVuc3VyZSB0aGUgbGluZVZpZXcud3JhcHBpbmcuaGVpZ2h0cyBhcnJheSBpcyBwb3B1bGF0ZWQuIFRoaXMgaXMKICAvLyBhbiBhcnJheSBvZiBib3R0b20gb2Zmc2V0cyBmb3IgdGhlIGxpbmVzIHRoYXQgbWFrZSB1cCBhIGRyYXduCiAgLy8gbGluZS4gV2hlbiBsaW5lV3JhcHBpbmcgaXMgb24sIHRoZXJlIG1pZ2h0IGJlIG1vcmUgdGhhbiBvbmUKICAvLyBoZWlnaHQuCiAgZnVuY3Rpb24gZW5zdXJlTGluZUhlaWdodHMoY20sIGxpbmVWaWV3LCByZWN0KSB7CiAgICB2YXIgd3JhcHBpbmcgPSBjbS5vcHRpb25zLmxpbmVXcmFwcGluZzsKICAgIHZhciBjdXJXaWR0aCA9IHdyYXBwaW5nICYmIGRpc3BsYXlXaWR0aChjbSk7CiAgICBpZiAoIWxpbmVWaWV3Lm1lYXN1cmUuaGVpZ2h0cyB8fCB3cmFwcGluZyAmJiBsaW5lVmlldy5tZWFzdXJlLndpZHRoICE9IGN1cldpZHRoKSB7CiAgICAgIHZhciBoZWlnaHRzID0gbGluZVZpZXcubWVhc3VyZS5oZWlnaHRzID0gW107CiAgICAgIGlmICh3cmFwcGluZykgewogICAgICAgIGxpbmVWaWV3Lm1lYXN1cmUud2lkdGggPSBjdXJXaWR0aDsKICAgICAgICB2YXIgcmVjdHMgPSBsaW5lVmlldy50ZXh0LmZpcnN0Q2hpbGQuZ2V0Q2xpZW50UmVjdHMoKTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlY3RzLmxlbmd0aCAtIDE7IGkrKykgewogICAgICAgICAgdmFyIGN1ciA9IHJlY3RzW2ldLCBuZXh0ID0gcmVjdHNbaSArIDFdOwogICAgICAgICAgaWYgKE1hdGguYWJzKGN1ci5ib3R0b20gLSBuZXh0LmJvdHRvbSkgPiAyKQogICAgICAgICAgICB7IGhlaWdodHMucHVzaCgoY3VyLmJvdHRvbSArIG5leHQudG9wKSAvIDIgLSByZWN0LnRvcCk7IH0KICAgICAgICB9CiAgICAgIH0KICAgICAgaGVpZ2h0cy5wdXNoKHJlY3QuYm90dG9tIC0gcmVjdC50b3ApOwogICAgfQogIH0KCiAgLy8gRmluZCBhIGxpbmUgbWFwIChtYXBwaW5nIGNoYXJhY3RlciBvZmZzZXRzIHRvIHRleHQgbm9kZXMpIGFuZCBhCiAgLy8gbWVhc3VyZW1lbnQgY2FjaGUgZm9yIHRoZSBnaXZlbiBsaW5lIG51bWJlci4gKEEgbGluZSB2aWV3IG1pZ2h0CiAgLy8gY29udGFpbiBtdWx0aXBsZSBsaW5lcyB3aGVuIGNvbGxhcHNlZCByYW5nZXMgYXJlIHByZXNlbnQuKQogIGZ1bmN0aW9uIG1hcEZyb21MaW5lVmlldyhsaW5lVmlldywgbGluZSwgbGluZU4pIHsKICAgIGlmIChsaW5lVmlldy5saW5lID09IGxpbmUpCiAgICAgIHsgcmV0dXJuIHttYXA6IGxpbmVWaWV3Lm1lYXN1cmUubWFwLCBjYWNoZTogbGluZVZpZXcubWVhc3VyZS5jYWNoZX0gfQogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsaW5lVmlldy5yZXN0Lmxlbmd0aDsgaSsrKQogICAgICB7IGlmIChsaW5lVmlldy5yZXN0W2ldID09IGxpbmUpCiAgICAgICAgeyByZXR1cm4ge21hcDogbGluZVZpZXcubWVhc3VyZS5tYXBzW2ldLCBjYWNoZTogbGluZVZpZXcubWVhc3VyZS5jYWNoZXNbaV19IH0gfQogICAgZm9yICh2YXIgaSQxID0gMDsgaSQxIDwgbGluZVZpZXcucmVzdC5sZW5ndGg7IGkkMSsrKQogICAgICB7IGlmIChsaW5lTm8obGluZVZpZXcucmVzdFtpJDFdKSA+IGxpbmVOKQogICAgICAgIHsgcmV0dXJuIHttYXA6IGxpbmVWaWV3Lm1lYXN1cmUubWFwc1tpJDFdLCBjYWNoZTogbGluZVZpZXcubWVhc3VyZS5jYWNoZXNbaSQxXSwgYmVmb3JlOiB0cnVlfSB9IH0KICB9CgogIC8vIFJlbmRlciBhIGxpbmUgaW50byB0aGUgaGlkZGVuIG5vZGUgZGlzcGxheS5leHRlcm5hbE1lYXN1cmVkLiBVc2VkCiAgLy8gd2hlbiBtZWFzdXJlbWVudCBpcyBuZWVkZWQgZm9yIGEgbGluZSB0aGF0J3Mgbm90IGluIHRoZSB2aWV3cG9ydC4KICBmdW5jdGlvbiB1cGRhdGVFeHRlcm5hbE1lYXN1cmVtZW50KGNtLCBsaW5lKSB7CiAgICBsaW5lID0gdmlzdWFsTGluZShsaW5lKTsKICAgIHZhciBsaW5lTiA9IGxpbmVObyhsaW5lKTsKICAgIHZhciB2aWV3ID0gY20uZGlzcGxheS5leHRlcm5hbE1lYXN1cmVkID0gbmV3IExpbmVWaWV3KGNtLmRvYywgbGluZSwgbGluZU4pOwogICAgdmlldy5saW5lTiA9IGxpbmVOOwogICAgdmFyIGJ1aWx0ID0gdmlldy5idWlsdCA9IGJ1aWxkTGluZUNvbnRlbnQoY20sIHZpZXcpOwogICAgdmlldy50ZXh0ID0gYnVpbHQucHJlOwogICAgcmVtb3ZlQ2hpbGRyZW5BbmRBZGQoY20uZGlzcGxheS5saW5lTWVhc3VyZSwgYnVpbHQucHJlKTsKICAgIHJldHVybiB2aWV3CiAgfQoKICAvLyBHZXQgYSB7dG9wLCBib3R0b20sIGxlZnQsIHJpZ2h0fSBib3ggKGluIGxpbmUtbG9jYWwgY29vcmRpbmF0ZXMpCiAgLy8gZm9yIGEgZ2l2ZW4gY2hhcmFjdGVyLgogIGZ1bmN0aW9uIG1lYXN1cmVDaGFyKGNtLCBsaW5lLCBjaCwgYmlhcykgewogICAgcmV0dXJuIG1lYXN1cmVDaGFyUHJlcGFyZWQoY20sIHByZXBhcmVNZWFzdXJlRm9yTGluZShjbSwgbGluZSksIGNoLCBiaWFzKQogIH0KCiAgLy8gRmluZCBhIGxpbmUgdmlldyB0aGF0IGNvcnJlc3BvbmRzIHRvIHRoZSBnaXZlbiBsaW5lIG51bWJlci4KICBmdW5jdGlvbiBmaW5kVmlld0ZvckxpbmUoY20sIGxpbmVOKSB7CiAgICBpZiAobGluZU4gPj0gY20uZGlzcGxheS52aWV3RnJvbSAmJiBsaW5lTiA8IGNtLmRpc3BsYXkudmlld1RvKQogICAgICB7IHJldHVybiBjbS5kaXNwbGF5LnZpZXdbZmluZFZpZXdJbmRleChjbSwgbGluZU4pXSB9CiAgICB2YXIgZXh0ID0gY20uZGlzcGxheS5leHRlcm5hbE1lYXN1cmVkOwogICAgaWYgKGV4dCAmJiBsaW5lTiA+PSBleHQubGluZU4gJiYgbGluZU4gPCBleHQubGluZU4gKyBleHQuc2l6ZSkKICAgICAgeyByZXR1cm4gZXh0IH0KICB9CgogIC8vIE1lYXN1cmVtZW50IGNhbiBiZSBzcGxpdCBpbiB0d28gc3RlcHMsIHRoZSBzZXQtdXAgd29yayB0aGF0CiAgLy8gYXBwbGllcyB0byB0aGUgd2hvbGUgbGluZSwgYW5kIHRoZSBtZWFzdXJlbWVudCBvZiB0aGUgYWN0dWFsCiAgLy8gY2hhcmFjdGVyLiBGdW5jdGlvbnMgbGlrZSBjb29yZHNDaGFyLCB0aGF0IG5lZWQgdG8gZG8gYSBsb3Qgb2YKICAvLyBtZWFzdXJlbWVudHMgaW4gYSByb3csIGNhbiB0aHVzIGVuc3VyZSB0aGF0IHRoZSBzZXQtdXAgd29yayBpcwogIC8vIG9ubHkgZG9uZSBvbmNlLgogIGZ1bmN0aW9uIHByZXBhcmVNZWFzdXJlRm9yTGluZShjbSwgbGluZSkgewogICAgdmFyIGxpbmVOID0gbGluZU5vKGxpbmUpOwogICAgdmFyIHZpZXcgPSBmaW5kVmlld0ZvckxpbmUoY20sIGxpbmVOKTsKICAgIGlmICh2aWV3ICYmICF2aWV3LnRleHQpIHsKICAgICAgdmlldyA9IG51bGw7CiAgICB9IGVsc2UgaWYgKHZpZXcgJiYgdmlldy5jaGFuZ2VzKSB7CiAgICAgIHVwZGF0ZUxpbmVGb3JDaGFuZ2VzKGNtLCB2aWV3LCBsaW5lTiwgZ2V0RGltZW5zaW9ucyhjbSkpOwogICAgICBjbS5jdXJPcC5mb3JjZVVwZGF0ZSA9IHRydWU7CiAgICB9CiAgICBpZiAoIXZpZXcpCiAgICAgIHsgdmlldyA9IHVwZGF0ZUV4dGVybmFsTWVhc3VyZW1lbnQoY20sIGxpbmUpOyB9CgogICAgdmFyIGluZm8gPSBtYXBGcm9tTGluZVZpZXcodmlldywgbGluZSwgbGluZU4pOwogICAgcmV0dXJuIHsKICAgICAgbGluZTogbGluZSwgdmlldzogdmlldywgcmVjdDogbnVsbCwKICAgICAgbWFwOiBpbmZvLm1hcCwgY2FjaGU6IGluZm8uY2FjaGUsIGJlZm9yZTogaW5mby5iZWZvcmUsCiAgICAgIGhhc0hlaWdodHM6IGZhbHNlCiAgICB9CiAgfQoKICAvLyBHaXZlbiBhIHByZXBhcmVkIG1lYXN1cmVtZW50IG9iamVjdCwgbWVhc3VyZXMgdGhlIHBvc2l0aW9uIG9mIGFuCiAgLy8gYWN0dWFsIGNoYXJhY3RlciAob3IgZmV0Y2hlcyBpdCBmcm9tIHRoZSBjYWNoZSkuCiAgZnVuY3Rpb24gbWVhc3VyZUNoYXJQcmVwYXJlZChjbSwgcHJlcGFyZWQsIGNoLCBiaWFzLCB2YXJIZWlnaHQpIHsKICAgIGlmIChwcmVwYXJlZC5iZWZvcmUpIHsgY2ggPSAtMTsgfQogICAgdmFyIGtleSA9IGNoICsgKGJpYXMgfHwgIiIpLCBmb3VuZDsKICAgIGlmIChwcmVwYXJlZC5jYWNoZS5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgIGZvdW5kID0gcHJlcGFyZWQuY2FjaGVba2V5XTsKICAgIH0gZWxzZSB7CiAgICAgIGlmICghcHJlcGFyZWQucmVjdCkKICAgICAgICB7IHByZXBhcmVkLnJlY3QgPSBwcmVwYXJlZC52aWV3LnRleHQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7IH0KICAgICAgaWYgKCFwcmVwYXJlZC5oYXNIZWlnaHRzKSB7CiAgICAgICAgZW5zdXJlTGluZUhlaWdodHMoY20sIHByZXBhcmVkLnZpZXcsIHByZXBhcmVkLnJlY3QpOwogICAgICAgIHByZXBhcmVkLmhhc0hlaWdodHMgPSB0cnVlOwogICAgICB9CiAgICAgIGZvdW5kID0gbWVhc3VyZUNoYXJJbm5lcihjbSwgcHJlcGFyZWQsIGNoLCBiaWFzKTsKICAgICAgaWYgKCFmb3VuZC5ib2d1cykgeyBwcmVwYXJlZC5jYWNoZVtrZXldID0gZm91bmQ7IH0KICAgIH0KICAgIHJldHVybiB7bGVmdDogZm91bmQubGVmdCwgcmlnaHQ6IGZvdW5kLnJpZ2h0LAogICAgICAgICAgICB0b3A6IHZhckhlaWdodCA/IGZvdW5kLnJ0b3AgOiBmb3VuZC50b3AsCiAgICAgICAgICAgIGJvdHRvbTogdmFySGVpZ2h0ID8gZm91bmQucmJvdHRvbSA6IGZvdW5kLmJvdHRvbX0KICB9CgogIHZhciBudWxsUmVjdCA9IHtsZWZ0OiAwLCByaWdodDogMCwgdG9wOiAwLCBib3R0b206IDB9OwoKICBmdW5jdGlvbiBub2RlQW5kT2Zmc2V0SW5MaW5lTWFwKG1hcCQkMSwgY2gsIGJpYXMpIHsKICAgIHZhciBub2RlLCBzdGFydCwgZW5kLCBjb2xsYXBzZSwgbVN0YXJ0LCBtRW5kOwogICAgLy8gRmlyc3QsIHNlYXJjaCB0aGUgbGluZSBtYXAgZm9yIHRoZSB0ZXh0IG5vZGUgY29ycmVzcG9uZGluZyB0bywKICAgIC8vIG9yIGNsb3Nlc3QgdG8sIHRoZSB0YXJnZXQgY2hhcmFjdGVyLgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBtYXAkJDEubGVuZ3RoOyBpICs9IDMpIHsKICAgICAgbVN0YXJ0ID0gbWFwJCQxW2ldOwogICAgICBtRW5kID0gbWFwJCQxW2kgKyAxXTsKICAgICAgaWYgKGNoIDwgbVN0YXJ0KSB7CiAgICAgICAgc3RhcnQgPSAwOyBlbmQgPSAxOwogICAgICAgIGNvbGxhcHNlID0gImxlZnQiOwogICAgICB9IGVsc2UgaWYgKGNoIDwgbUVuZCkgewogICAgICAgIHN0YXJ0ID0gY2ggLSBtU3RhcnQ7CiAgICAgICAgZW5kID0gc3RhcnQgKyAxOwogICAgICB9IGVsc2UgaWYgKGkgPT0gbWFwJCQxLmxlbmd0aCAtIDMgfHwgY2ggPT0gbUVuZCAmJiBtYXAkJDFbaSArIDNdID4gY2gpIHsKICAgICAgICBlbmQgPSBtRW5kIC0gbVN0YXJ0OwogICAgICAgIHN0YXJ0ID0gZW5kIC0gMTsKICAgICAgICBpZiAoY2ggPj0gbUVuZCkgeyBjb2xsYXBzZSA9ICJyaWdodCI7IH0KICAgICAgfQogICAgICBpZiAoc3RhcnQgIT0gbnVsbCkgewogICAgICAgIG5vZGUgPSBtYXAkJDFbaSArIDJdOwogICAgICAgIGlmIChtU3RhcnQgPT0gbUVuZCAmJiBiaWFzID09IChub2RlLmluc2VydExlZnQgPyAibGVmdCIgOiAicmlnaHQiKSkKICAgICAgICAgIHsgY29sbGFwc2UgPSBiaWFzOyB9CiAgICAgICAgaWYgKGJpYXMgPT0gImxlZnQiICYmIHN0YXJ0ID09IDApCiAgICAgICAgICB7IHdoaWxlIChpICYmIG1hcCQkMVtpIC0gMl0gPT0gbWFwJCQxW2kgLSAzXSAmJiBtYXAkJDFbaSAtIDFdLmluc2VydExlZnQpIHsKICAgICAgICAgICAgbm9kZSA9IG1hcCQkMVsoaSAtPSAzKSArIDJdOwogICAgICAgICAgICBjb2xsYXBzZSA9ICJsZWZ0IjsKICAgICAgICAgIH0gfQogICAgICAgIGlmIChiaWFzID09ICJyaWdodCIgJiYgc3RhcnQgPT0gbUVuZCAtIG1TdGFydCkKICAgICAgICAgIHsgd2hpbGUgKGkgPCBtYXAkJDEubGVuZ3RoIC0gMyAmJiBtYXAkJDFbaSArIDNdID09IG1hcCQkMVtpICsgNF0gJiYgIW1hcCQkMVtpICsgNV0uaW5zZXJ0TGVmdCkgewogICAgICAgICAgICBub2RlID0gbWFwJCQxWyhpICs9IDMpICsgMl07CiAgICAgICAgICAgIGNvbGxhcHNlID0gInJpZ2h0IjsKICAgICAgICAgIH0gfQogICAgICAgIGJyZWFrCiAgICAgIH0KICAgIH0KICAgIHJldHVybiB7bm9kZTogbm9kZSwgc3RhcnQ6IHN0YXJ0LCBlbmQ6IGVuZCwgY29sbGFwc2U6IGNvbGxhcHNlLCBjb3ZlclN0YXJ0OiBtU3RhcnQsIGNvdmVyRW5kOiBtRW5kfQogIH0KCiAgZnVuY3Rpb24gZ2V0VXNlZnVsUmVjdChyZWN0cywgYmlhcykgewogICAgdmFyIHJlY3QgPSBudWxsUmVjdDsKICAgIGlmIChiaWFzID09ICJsZWZ0IikgeyBmb3IgKHZhciBpID0gMDsgaSA8IHJlY3RzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmICgocmVjdCA9IHJlY3RzW2ldKS5sZWZ0ICE9IHJlY3QucmlnaHQpIHsgYnJlYWsgfQogICAgfSB9IGVsc2UgeyBmb3IgKHZhciBpJDEgPSByZWN0cy5sZW5ndGggLSAxOyBpJDEgPj0gMDsgaSQxLS0pIHsKICAgICAgaWYgKChyZWN0ID0gcmVjdHNbaSQxXSkubGVmdCAhPSByZWN0LnJpZ2h0KSB7IGJyZWFrIH0KICAgIH0gfQogICAgcmV0dXJuIHJlY3QKICB9CgogIGZ1bmN0aW9uIG1lYXN1cmVDaGFySW5uZXIoY20sIHByZXBhcmVkLCBjaCwgYmlhcykgewogICAgdmFyIHBsYWNlID0gbm9kZUFuZE9mZnNldEluTGluZU1hcChwcmVwYXJlZC5tYXAsIGNoLCBiaWFzKTsKICAgIHZhciBub2RlID0gcGxhY2Uubm9kZSwgc3RhcnQgPSBwbGFjZS5zdGFydCwgZW5kID0gcGxhY2UuZW5kLCBjb2xsYXBzZSA9IHBsYWNlLmNvbGxhcHNlOwoKICAgIHZhciByZWN0OwogICAgaWYgKG5vZGUubm9kZVR5cGUgPT0gMykgeyAvLyBJZiBpdCBpcyBhIHRleHQgbm9kZSwgdXNlIGEgcmFuZ2UgdG8gcmV0cmlldmUgdGhlIGNvb3JkaW5hdGVzLgogICAgICBmb3IgKHZhciBpJDEgPSAwOyBpJDEgPCA0OyBpJDErKykgeyAvLyBSZXRyeSBhIG1heGltdW0gb2YgNCB0aW1lcyB3aGVuIG5vbnNlbnNlIHJlY3RhbmdsZXMgYXJlIHJldHVybmVkCiAgICAgICAgd2hpbGUgKHN0YXJ0ICYmIGlzRXh0ZW5kaW5nQ2hhcihwcmVwYXJlZC5saW5lLnRleHQuY2hhckF0KHBsYWNlLmNvdmVyU3RhcnQgKyBzdGFydCkpKSB7IC0tc3RhcnQ7IH0KICAgICAgICB3aGlsZSAocGxhY2UuY292ZXJTdGFydCArIGVuZCA8IHBsYWNlLmNvdmVyRW5kICYmIGlzRXh0ZW5kaW5nQ2hhcihwcmVwYXJlZC5saW5lLnRleHQuY2hhckF0KHBsYWNlLmNvdmVyU3RhcnQgKyBlbmQpKSkgeyArK2VuZDsgfQogICAgICAgIGlmIChpZSAmJiBpZV92ZXJzaW9uIDwgOSAmJiBzdGFydCA9PSAwICYmIGVuZCA9PSBwbGFjZS5jb3ZlckVuZCAtIHBsYWNlLmNvdmVyU3RhcnQpCiAgICAgICAgICB7IHJlY3QgPSBub2RlLnBhcmVudE5vZGUuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7IH0KICAgICAgICBlbHNlCiAgICAgICAgICB7IHJlY3QgPSBnZXRVc2VmdWxSZWN0KHJhbmdlKG5vZGUsIHN0YXJ0LCBlbmQpLmdldENsaWVudFJlY3RzKCksIGJpYXMpOyB9CiAgICAgICAgaWYgKHJlY3QubGVmdCB8fCByZWN0LnJpZ2h0IHx8IHN0YXJ0ID09IDApIHsgYnJlYWsgfQogICAgICAgIGVuZCA9IHN0YXJ0OwogICAgICAgIHN0YXJ0ID0gc3RhcnQgLSAxOwogICAgICAgIGNvbGxhcHNlID0gInJpZ2h0IjsKICAgICAgfQogICAgICBpZiAoaWUgJiYgaWVfdmVyc2lvbiA8IDExKSB7IHJlY3QgPSBtYXliZVVwZGF0ZVJlY3RGb3Jab29taW5nKGNtLmRpc3BsYXkubWVhc3VyZSwgcmVjdCk7IH0KICAgIH0gZWxzZSB7IC8vIElmIGl0IGlzIGEgd2lkZ2V0LCBzaW1wbHkgZ2V0IHRoZSBib3ggZm9yIHRoZSB3aG9sZSB3aWRnZXQuCiAgICAgIGlmIChzdGFydCA+IDApIHsgY29sbGFwc2UgPSBiaWFzID0gInJpZ2h0IjsgfQogICAgICB2YXIgcmVjdHM7CiAgICAgIGlmIChjbS5vcHRpb25zLmxpbmVXcmFwcGluZyAmJiAocmVjdHMgPSBub2RlLmdldENsaWVudFJlY3RzKCkpLmxlbmd0aCA+IDEpCiAgICAgICAgeyByZWN0ID0gcmVjdHNbYmlhcyA9PSAicmlnaHQiID8gcmVjdHMubGVuZ3RoIC0gMSA6IDBdOyB9CiAgICAgIGVsc2UKICAgICAgICB7IHJlY3QgPSBub2RlLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOyB9CiAgICB9CiAgICBpZiAoaWUgJiYgaWVfdmVyc2lvbiA8IDkgJiYgIXN0YXJ0ICYmICghcmVjdCB8fCAhcmVjdC5sZWZ0ICYmICFyZWN0LnJpZ2h0KSkgewogICAgICB2YXIgclNwYW4gPSBub2RlLnBhcmVudE5vZGUuZ2V0Q2xpZW50UmVjdHMoKVswXTsKICAgICAgaWYgKHJTcGFuKQogICAgICAgIHsgcmVjdCA9IHtsZWZ0OiByU3Bhbi5sZWZ0LCByaWdodDogclNwYW4ubGVmdCArIGNoYXJXaWR0aChjbS5kaXNwbGF5KSwgdG9wOiByU3Bhbi50b3AsIGJvdHRvbTogclNwYW4uYm90dG9tfTsgfQogICAgICBlbHNlCiAgICAgICAgeyByZWN0ID0gbnVsbFJlY3Q7IH0KICAgIH0KCiAgICB2YXIgcnRvcCA9IHJlY3QudG9wIC0gcHJlcGFyZWQucmVjdC50b3AsIHJib3QgPSByZWN0LmJvdHRvbSAtIHByZXBhcmVkLnJlY3QudG9wOwogICAgdmFyIG1pZCA9IChydG9wICsgcmJvdCkgLyAyOwogICAgdmFyIGhlaWdodHMgPSBwcmVwYXJlZC52aWV3Lm1lYXN1cmUuaGVpZ2h0czsKICAgIHZhciBpID0gMDsKICAgIGZvciAoOyBpIDwgaGVpZ2h0cy5sZW5ndGggLSAxOyBpKyspCiAgICAgIHsgaWYgKG1pZCA8IGhlaWdodHNbaV0pIHsgYnJlYWsgfSB9CiAgICB2YXIgdG9wID0gaSA/IGhlaWdodHNbaSAtIDFdIDogMCwgYm90ID0gaGVpZ2h0c1tpXTsKICAgIHZhciByZXN1bHQgPSB7bGVmdDogKGNvbGxhcHNlID09ICJyaWdodCIgPyByZWN0LnJpZ2h0IDogcmVjdC5sZWZ0KSAtIHByZXBhcmVkLnJlY3QubGVmdCwKICAgICAgICAgICAgICAgICAgcmlnaHQ6IChjb2xsYXBzZSA9PSAibGVmdCIgPyByZWN0LmxlZnQgOiByZWN0LnJpZ2h0KSAtIHByZXBhcmVkLnJlY3QubGVmdCwKICAgICAgICAgICAgICAgICAgdG9wOiB0b3AsIGJvdHRvbTogYm90fTsKICAgIGlmICghcmVjdC5sZWZ0ICYmICFyZWN0LnJpZ2h0KSB7IHJlc3VsdC5ib2d1cyA9IHRydWU7IH0KICAgIGlmICghY20ub3B0aW9ucy5zaW5nbGVDdXJzb3JIZWlnaHRQZXJMaW5lKSB7IHJlc3VsdC5ydG9wID0gcnRvcDsgcmVzdWx0LnJib3R0b20gPSByYm90OyB9CgogICAgcmV0dXJuIHJlc3VsdAogIH0KCiAgLy8gV29yayBhcm91bmQgcHJvYmxlbSB3aXRoIGJvdW5kaW5nIGNsaWVudCByZWN0cyBvbiByYW5nZXMgYmVpbmcKICAvLyByZXR1cm5lZCBpbmNvcnJlY3RseSB3aGVuIHpvb21lZCBvbiBJRTEwIGFuZCBiZWxvdy4KICBmdW5jdGlvbiBtYXliZVVwZGF0ZVJlY3RGb3Jab29taW5nKG1lYXN1cmUsIHJlY3QpIHsKICAgIGlmICghd2luZG93LnNjcmVlbiB8fCBzY3JlZW4ubG9naWNhbFhEUEkgPT0gbnVsbCB8fAogICAgICAgIHNjcmVlbi5sb2dpY2FsWERQSSA9PSBzY3JlZW4uZGV2aWNlWERQSSB8fCAhaGFzQmFkWm9vbWVkUmVjdHMobWVhc3VyZSkpCiAgICAgIHsgcmV0dXJuIHJlY3QgfQogICAgdmFyIHNjYWxlWCA9IHNjcmVlbi5sb2dpY2FsWERQSSAvIHNjcmVlbi5kZXZpY2VYRFBJOwogICAgdmFyIHNjYWxlWSA9IHNjcmVlbi5sb2dpY2FsWURQSSAvIHNjcmVlbi5kZXZpY2VZRFBJOwogICAgcmV0dXJuIHtsZWZ0OiByZWN0LmxlZnQgKiBzY2FsZVgsIHJpZ2h0OiByZWN0LnJpZ2h0ICogc2NhbGVYLAogICAgICAgICAgICB0b3A6IHJlY3QudG9wICogc2NhbGVZLCBib3R0b206IHJlY3QuYm90dG9tICogc2NhbGVZfQogIH0KCiAgZnVuY3Rpb24gY2xlYXJMaW5lTWVhc3VyZW1lbnRDYWNoZUZvcihsaW5lVmlldykgewogICAgaWYgKGxpbmVWaWV3Lm1lYXN1cmUpIHsKICAgICAgbGluZVZpZXcubWVhc3VyZS5jYWNoZSA9IHt9OwogICAgICBsaW5lVmlldy5tZWFzdXJlLmhlaWdodHMgPSBudWxsOwogICAgICBpZiAobGluZVZpZXcucmVzdCkgeyBmb3IgKHZhciBpID0gMDsgaSA8IGxpbmVWaWV3LnJlc3QubGVuZ3RoOyBpKyspCiAgICAgICAgeyBsaW5lVmlldy5tZWFzdXJlLmNhY2hlc1tpXSA9IHt9OyB9IH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIGNsZWFyTGluZU1lYXN1cmVtZW50Q2FjaGUoY20pIHsKICAgIGNtLmRpc3BsYXkuZXh0ZXJuYWxNZWFzdXJlID0gbnVsbDsKICAgIHJlbW92ZUNoaWxkcmVuKGNtLmRpc3BsYXkubGluZU1lYXN1cmUpOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjbS5kaXNwbGF5LnZpZXcubGVuZ3RoOyBpKyspCiAgICAgIHsgY2xlYXJMaW5lTWVhc3VyZW1lbnRDYWNoZUZvcihjbS5kaXNwbGF5LnZpZXdbaV0pOyB9CiAgfQoKICBmdW5jdGlvbiBjbGVhckNhY2hlcyhjbSkgewogICAgY2xlYXJMaW5lTWVhc3VyZW1lbnRDYWNoZShjbSk7CiAgICBjbS5kaXNwbGF5LmNhY2hlZENoYXJXaWR0aCA9IGNtLmRpc3BsYXkuY2FjaGVkVGV4dEhlaWdodCA9IGNtLmRpc3BsYXkuY2FjaGVkUGFkZGluZ0ggPSBudWxsOwogICAgaWYgKCFjbS5vcHRpb25zLmxpbmVXcmFwcGluZykgeyBjbS5kaXNwbGF5Lm1heExpbmVDaGFuZ2VkID0gdHJ1ZTsgfQogICAgY20uZGlzcGxheS5saW5lTnVtQ2hhcnMgPSBudWxsOwogIH0KCiAgZnVuY3Rpb24gcGFnZVNjcm9sbFgoKSB7CiAgICAvLyBXb3JrIGFyb3VuZCBodHRwczovL2J1Z3MuY2hyb21pdW0ub3JnL3AvY2hyb21pdW0vaXNzdWVzL2RldGFpbD9pZD00ODkyMDYKICAgIC8vIHdoaWNoIGNhdXNlcyBwYWdlX09mZnNldCBhbmQgYm91bmRpbmcgY2xpZW50IHJlY3RzIHRvIHVzZQogICAgLy8gZGlmZmVyZW50IHJlZmVyZW5jZSB2aWV3cG9ydHMgYW5kIGludmFsaWRhdGUgb3VyIGNhbGN1bGF0aW9ucy4KICAgIGlmIChjaHJvbWUgJiYgYW5kcm9pZCkgeyByZXR1cm4gLShkb2N1bWVudC5ib2R5LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLmxlZnQgLSBwYXJzZUludChnZXRDb21wdXRlZFN0eWxlKGRvY3VtZW50LmJvZHkpLm1hcmdpbkxlZnQpKSB9CiAgICByZXR1cm4gd2luZG93LnBhZ2VYT2Zmc2V0IHx8IChkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQgfHwgZG9jdW1lbnQuYm9keSkuc2Nyb2xsTGVmdAogIH0KICBmdW5jdGlvbiBwYWdlU2Nyb2xsWSgpIHsKICAgIGlmIChjaHJvbWUgJiYgYW5kcm9pZCkgeyByZXR1cm4gLShkb2N1bWVudC5ib2R5LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLnRvcCAtIHBhcnNlSW50KGdldENvbXB1dGVkU3R5bGUoZG9jdW1lbnQuYm9keSkubWFyZ2luVG9wKSkgfQogICAgcmV0dXJuIHdpbmRvdy5wYWdlWU9mZnNldCB8fCAoZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50IHx8IGRvY3VtZW50LmJvZHkpLnNjcm9sbFRvcAogIH0KCiAgZnVuY3Rpb24gd2lkZ2V0VG9wSGVpZ2h0KGxpbmVPYmopIHsKICAgIHZhciBoZWlnaHQgPSAwOwogICAgaWYgKGxpbmVPYmoud2lkZ2V0cykgeyBmb3IgKHZhciBpID0gMDsgaSA8IGxpbmVPYmoud2lkZ2V0cy5sZW5ndGg7ICsraSkgeyBpZiAobGluZU9iai53aWRnZXRzW2ldLmFib3ZlKQogICAgICB7IGhlaWdodCArPSB3aWRnZXRIZWlnaHQobGluZU9iai53aWRnZXRzW2ldKTsgfSB9IH0KICAgIHJldHVybiBoZWlnaHQKICB9CgogIC8vIENvbnZlcnRzIGEge3RvcCwgYm90dG9tLCBsZWZ0LCByaWdodH0gYm94IGZyb20gbGluZS1sb2NhbAogIC8vIGNvb3JkaW5hdGVzIGludG8gYW5vdGhlciBjb29yZGluYXRlIHN5c3RlbS4gQ29udGV4dCBtYXkgYmUgb25lIG9mCiAgLy8gImxpbmUiLCAiZGl2IiAoZGlzcGxheS5saW5lRGl2KSwgImxvY2FsIi4vbnVsbCAoZWRpdG9yKSwgIndpbmRvdyIsCiAgLy8gb3IgInBhZ2UiLgogIGZ1bmN0aW9uIGludG9Db29yZFN5c3RlbShjbSwgbGluZU9iaiwgcmVjdCwgY29udGV4dCwgaW5jbHVkZVdpZGdldHMpIHsKICAgIGlmICghaW5jbHVkZVdpZGdldHMpIHsKICAgICAgdmFyIGhlaWdodCA9IHdpZGdldFRvcEhlaWdodChsaW5lT2JqKTsKICAgICAgcmVjdC50b3AgKz0gaGVpZ2h0OyByZWN0LmJvdHRvbSArPSBoZWlnaHQ7CiAgICB9CiAgICBpZiAoY29udGV4dCA9PSAibGluZSIpIHsgcmV0dXJuIHJlY3QgfQogICAgaWYgKCFjb250ZXh0KSB7IGNvbnRleHQgPSAibG9jYWwiOyB9CiAgICB2YXIgeU9mZiA9IGhlaWdodEF0TGluZShsaW5lT2JqKTsKICAgIGlmIChjb250ZXh0ID09ICJsb2NhbCIpIHsgeU9mZiArPSBwYWRkaW5nVG9wKGNtLmRpc3BsYXkpOyB9CiAgICBlbHNlIHsgeU9mZiAtPSBjbS5kaXNwbGF5LnZpZXdPZmZzZXQ7IH0KICAgIGlmIChjb250ZXh0ID09ICJwYWdlIiB8fCBjb250ZXh0ID09ICJ3aW5kb3ciKSB7CiAgICAgIHZhciBsT2ZmID0gY20uZGlzcGxheS5saW5lU3BhY2UuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICAgIHlPZmYgKz0gbE9mZi50b3AgKyAoY29udGV4dCA9PSAid2luZG93IiA/IDAgOiBwYWdlU2Nyb2xsWSgpKTsKICAgICAgdmFyIHhPZmYgPSBsT2ZmLmxlZnQgKyAoY29udGV4dCA9PSAid2luZG93IiA/IDAgOiBwYWdlU2Nyb2xsWCgpKTsKICAgICAgcmVjdC5sZWZ0ICs9IHhPZmY7IHJlY3QucmlnaHQgKz0geE9mZjsKICAgIH0KICAgIHJlY3QudG9wICs9IHlPZmY7IHJlY3QuYm90dG9tICs9IHlPZmY7CiAgICByZXR1cm4gcmVjdAogIH0KCiAgLy8gQ292ZXJ0cyBhIGJveCBmcm9tICJkaXYiIGNvb3JkcyB0byBhbm90aGVyIGNvb3JkaW5hdGUgc3lzdGVtLgogIC8vIENvbnRleHQgbWF5IGJlICJ3aW5kb3ciLCAicGFnZSIsICJkaXYiLCBvciAibG9jYWwiLi9udWxsLgogIGZ1bmN0aW9uIGZyb21Db29yZFN5c3RlbShjbSwgY29vcmRzLCBjb250ZXh0KSB7CiAgICBpZiAoY29udGV4dCA9PSAiZGl2IikgeyByZXR1cm4gY29vcmRzIH0KICAgIHZhciBsZWZ0ID0gY29vcmRzLmxlZnQsIHRvcCA9IGNvb3Jkcy50b3A7CiAgICAvLyBGaXJzdCBtb3ZlIGludG8gInBhZ2UiIGNvb3JkaW5hdGUgc3lzdGVtCiAgICBpZiAoY29udGV4dCA9PSAicGFnZSIpIHsKICAgICAgbGVmdCAtPSBwYWdlU2Nyb2xsWCgpOwogICAgICB0b3AgLT0gcGFnZVNjcm9sbFkoKTsKICAgIH0gZWxzZSBpZiAoY29udGV4dCA9PSAibG9jYWwiIHx8ICFjb250ZXh0KSB7CiAgICAgIHZhciBsb2NhbEJveCA9IGNtLmRpc3BsYXkuc2l6ZXIuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICAgIGxlZnQgKz0gbG9jYWxCb3gubGVmdDsKICAgICAgdG9wICs9IGxvY2FsQm94LnRvcDsKICAgIH0KCiAgICB2YXIgbGluZVNwYWNlQm94ID0gY20uZGlzcGxheS5saW5lU3BhY2UuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICByZXR1cm4ge2xlZnQ6IGxlZnQgLSBsaW5lU3BhY2VCb3gubGVmdCwgdG9wOiB0b3AgLSBsaW5lU3BhY2VCb3gudG9wfQogIH0KCiAgZnVuY3Rpb24gY2hhckNvb3JkcyhjbSwgcG9zLCBjb250ZXh0LCBsaW5lT2JqLCBiaWFzKSB7CiAgICBpZiAoIWxpbmVPYmopIHsgbGluZU9iaiA9IGdldExpbmUoY20uZG9jLCBwb3MubGluZSk7IH0KICAgIHJldHVybiBpbnRvQ29vcmRTeXN0ZW0oY20sIGxpbmVPYmosIG1lYXN1cmVDaGFyKGNtLCBsaW5lT2JqLCBwb3MuY2gsIGJpYXMpLCBjb250ZXh0KQogIH0KCiAgLy8gUmV0dXJucyBhIGJveCBmb3IgYSBnaXZlbiBjdXJzb3IgcG9zaXRpb24sIHdoaWNoIG1heSBoYXZlIGFuCiAgLy8gJ290aGVyJyBwcm9wZXJ0eSBjb250YWluaW5nIHRoZSBwb3NpdGlvbiBvZiB0aGUgc2Vjb25kYXJ5IGN1cnNvcgogIC8vIG9uIGEgYmlkaSBib3VuZGFyeS4KICAvLyBBIGN1cnNvciBQb3MobGluZSwgY2hhciwgImJlZm9yZSIpIGlzIG9uIHRoZSBzYW1lIHZpc3VhbCBsaW5lIGFzIGBjaGFyIC0gMWAKICAvLyBhbmQgYWZ0ZXIgYGNoYXIgLSAxYCBpbiB3cml0aW5nIG9yZGVyIG9mIGBjaGFyIC0gMWAKICAvLyBBIGN1cnNvciBQb3MobGluZSwgY2hhciwgImFmdGVyIikgaXMgb24gdGhlIHNhbWUgdmlzdWFsIGxpbmUgYXMgYGNoYXJgCiAgLy8gYW5kIGJlZm9yZSBgY2hhcmAgaW4gd3JpdGluZyBvcmRlciBvZiBgY2hhcmAKICAvLyBFeGFtcGxlcyAodXBwZXItY2FzZSBsZXR0ZXJzIGFyZSBSVEwsIGxvd2VyLWNhc2UgYXJlIExUUik6CiAgLy8gICAgIFBvcygwLCAxLCAuLi4pCiAgLy8gICAgIGJlZm9yZSAgIGFmdGVyCiAgLy8gYWIgICAgIGF8YiAgICAgYXxiCiAgLy8gYUIgICAgIGF8QiAgICAgYUJ8CiAgLy8gQWIgICAgIHxBYiAgICAgQXxiCiAgLy8gQUIgICAgIEJ8QSAgICAgQnxBCiAgLy8gRXZlcnkgcG9zaXRpb24gYWZ0ZXIgdGhlIGxhc3QgY2hhcmFjdGVyIG9uIGEgbGluZSBpcyBjb25zaWRlcmVkIHRvIHN0aWNrCiAgLy8gdG8gdGhlIGxhc3QgY2hhcmFjdGVyIG9uIHRoZSBsaW5lLgogIGZ1bmN0aW9uIGN1cnNvckNvb3JkcyhjbSwgcG9zLCBjb250ZXh0LCBsaW5lT2JqLCBwcmVwYXJlZE1lYXN1cmUsIHZhckhlaWdodCkgewogICAgbGluZU9iaiA9IGxpbmVPYmogfHwgZ2V0TGluZShjbS5kb2MsIHBvcy5saW5lKTsKICAgIGlmICghcHJlcGFyZWRNZWFzdXJlKSB7IHByZXBhcmVkTWVhc3VyZSA9IHByZXBhcmVNZWFzdXJlRm9yTGluZShjbSwgbGluZU9iaik7IH0KICAgIGZ1bmN0aW9uIGdldChjaCwgcmlnaHQpIHsKICAgICAgdmFyIG0gPSBtZWFzdXJlQ2hhclByZXBhcmVkKGNtLCBwcmVwYXJlZE1lYXN1cmUsIGNoLCByaWdodCA/ICJyaWdodCIgOiAibGVmdCIsIHZhckhlaWdodCk7CiAgICAgIGlmIChyaWdodCkgeyBtLmxlZnQgPSBtLnJpZ2h0OyB9IGVsc2UgeyBtLnJpZ2h0ID0gbS5sZWZ0OyB9CiAgICAgIHJldHVybiBpbnRvQ29vcmRTeXN0ZW0oY20sIGxpbmVPYmosIG0sIGNvbnRleHQpCiAgICB9CiAgICB2YXIgb3JkZXIgPSBnZXRPcmRlcihsaW5lT2JqLCBjbS5kb2MuZGlyZWN0aW9uKSwgY2ggPSBwb3MuY2gsIHN0aWNreSA9IHBvcy5zdGlja3k7CiAgICBpZiAoY2ggPj0gbGluZU9iai50ZXh0Lmxlbmd0aCkgewogICAgICBjaCA9IGxpbmVPYmoudGV4dC5sZW5ndGg7CiAgICAgIHN0aWNreSA9ICJiZWZvcmUiOwogICAgfSBlbHNlIGlmIChjaCA8PSAwKSB7CiAgICAgIGNoID0gMDsKICAgICAgc3RpY2t5ID0gImFmdGVyIjsKICAgIH0KICAgIGlmICghb3JkZXIpIHsgcmV0dXJuIGdldChzdGlja3kgPT0gImJlZm9yZSIgPyBjaCAtIDEgOiBjaCwgc3RpY2t5ID09ICJiZWZvcmUiKSB9CgogICAgZnVuY3Rpb24gZ2V0QmlkaShjaCwgcGFydFBvcywgaW52ZXJ0KSB7CiAgICAgIHZhciBwYXJ0ID0gb3JkZXJbcGFydFBvc10sIHJpZ2h0ID0gcGFydC5sZXZlbCA9PSAxOwogICAgICByZXR1cm4gZ2V0KGludmVydCA/IGNoIC0gMSA6IGNoLCByaWdodCAhPSBpbnZlcnQpCiAgICB9CiAgICB2YXIgcGFydFBvcyA9IGdldEJpZGlQYXJ0QXQob3JkZXIsIGNoLCBzdGlja3kpOwogICAgdmFyIG90aGVyID0gYmlkaU90aGVyOwogICAgdmFyIHZhbCA9IGdldEJpZGkoY2gsIHBhcnRQb3MsIHN0aWNreSA9PSAiYmVmb3JlIik7CiAgICBpZiAob3RoZXIgIT0gbnVsbCkgeyB2YWwub3RoZXIgPSBnZXRCaWRpKGNoLCBvdGhlciwgc3RpY2t5ICE9ICJiZWZvcmUiKTsgfQogICAgcmV0dXJuIHZhbAogIH0KCiAgLy8gVXNlZCB0byBjaGVhcGx5IGVzdGltYXRlIHRoZSBjb29yZGluYXRlcyBmb3IgYSBwb3NpdGlvbi4gVXNlZCBmb3IKICAvLyBpbnRlcm1lZGlhdGUgc2Nyb2xsIHVwZGF0ZXMuCiAgZnVuY3Rpb24gZXN0aW1hdGVDb29yZHMoY20sIHBvcykgewogICAgdmFyIGxlZnQgPSAwOwogICAgcG9zID0gY2xpcFBvcyhjbS5kb2MsIHBvcyk7CiAgICBpZiAoIWNtLm9wdGlvbnMubGluZVdyYXBwaW5nKSB7IGxlZnQgPSBjaGFyV2lkdGgoY20uZGlzcGxheSkgKiBwb3MuY2g7IH0KICAgIHZhciBsaW5lT2JqID0gZ2V0TGluZShjbS5kb2MsIHBvcy5saW5lKTsKICAgIHZhciB0b3AgPSBoZWlnaHRBdExpbmUobGluZU9iaikgKyBwYWRkaW5nVG9wKGNtLmRpc3BsYXkpOwogICAgcmV0dXJuIHtsZWZ0OiBsZWZ0LCByaWdodDogbGVmdCwgdG9wOiB0b3AsIGJvdHRvbTogdG9wICsgbGluZU9iai5oZWlnaHR9CiAgfQoKICAvLyBQb3NpdGlvbnMgcmV0dXJuZWQgYnkgY29vcmRzQ2hhciBjb250YWluIHNvbWUgZXh0cmEgaW5mb3JtYXRpb24uCiAgLy8geFJlbCBpcyB0aGUgcmVsYXRpdmUgeCBwb3NpdGlvbiBvZiB0aGUgaW5wdXQgY29vcmRpbmF0ZXMgY29tcGFyZWQKICAvLyB0byB0aGUgZm91bmQgcG9zaXRpb24gKHNvIHhSZWwgPiAwIG1lYW5zIHRoZSBjb29yZGluYXRlcyBhcmUgdG8KICAvLyB0aGUgcmlnaHQgb2YgdGhlIGNoYXJhY3RlciBwb3NpdGlvbiwgZm9yIGV4YW1wbGUpLiBXaGVuIG91dHNpZGUKICAvLyBpcyB0cnVlLCB0aGF0IG1lYW5zIHRoZSBjb29yZGluYXRlcyBsaWUgb3V0c2lkZSB0aGUgbGluZSdzCiAgLy8gdmVydGljYWwgcmFuZ2UuCiAgZnVuY3Rpb24gUG9zV2l0aEluZm8obGluZSwgY2gsIHN0aWNreSwgb3V0c2lkZSwgeFJlbCkgewogICAgdmFyIHBvcyA9IFBvcyhsaW5lLCBjaCwgc3RpY2t5KTsKICAgIHBvcy54UmVsID0geFJlbDsKICAgIGlmIChvdXRzaWRlKSB7IHBvcy5vdXRzaWRlID0gb3V0c2lkZTsgfQogICAgcmV0dXJuIHBvcwogIH0KCiAgLy8gQ29tcHV0ZSB0aGUgY2hhcmFjdGVyIHBvc2l0aW9uIGNsb3Nlc3QgdG8gdGhlIGdpdmVuIGNvb3JkaW5hdGVzLgogIC8vIElucHV0IG11c3QgYmUgbGluZVNwYWNlLWxvY2FsICgiZGl2IiBjb29yZGluYXRlIHN5c3RlbSkuCiAgZnVuY3Rpb24gY29vcmRzQ2hhcihjbSwgeCwgeSkgewogICAgdmFyIGRvYyA9IGNtLmRvYzsKICAgIHkgKz0gY20uZGlzcGxheS52aWV3T2Zmc2V0OwogICAgaWYgKHkgPCAwKSB7IHJldHVybiBQb3NXaXRoSW5mbyhkb2MuZmlyc3QsIDAsIG51bGwsIC0xLCAtMSkgfQogICAgdmFyIGxpbmVOID0gbGluZUF0SGVpZ2h0KGRvYywgeSksIGxhc3QgPSBkb2MuZmlyc3QgKyBkb2Muc2l6ZSAtIDE7CiAgICBpZiAobGluZU4gPiBsYXN0KQogICAgICB7IHJldHVybiBQb3NXaXRoSW5mbyhkb2MuZmlyc3QgKyBkb2Muc2l6ZSAtIDEsIGdldExpbmUoZG9jLCBsYXN0KS50ZXh0Lmxlbmd0aCwgbnVsbCwgMSwgMSkgfQogICAgaWYgKHggPCAwKSB7IHggPSAwOyB9CgogICAgdmFyIGxpbmVPYmogPSBnZXRMaW5lKGRvYywgbGluZU4pOwogICAgZm9yICg7OykgewogICAgICB2YXIgZm91bmQgPSBjb29yZHNDaGFySW5uZXIoY20sIGxpbmVPYmosIGxpbmVOLCB4LCB5KTsKICAgICAgdmFyIGNvbGxhcHNlZCA9IGNvbGxhcHNlZFNwYW5Bcm91bmQobGluZU9iaiwgZm91bmQuY2ggKyAoZm91bmQueFJlbCA+IDAgfHwgZm91bmQub3V0c2lkZSA+IDAgPyAxIDogMCkpOwogICAgICBpZiAoIWNvbGxhcHNlZCkgeyByZXR1cm4gZm91bmQgfQogICAgICB2YXIgcmFuZ2VFbmQgPSBjb2xsYXBzZWQuZmluZCgxKTsKICAgICAgaWYgKHJhbmdlRW5kLmxpbmUgPT0gbGluZU4pIHsgcmV0dXJuIHJhbmdlRW5kIH0KICAgICAgbGluZU9iaiA9IGdldExpbmUoZG9jLCBsaW5lTiA9IHJhbmdlRW5kLmxpbmUpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gd3JhcHBlZExpbmVFeHRlbnQoY20sIGxpbmVPYmosIHByZXBhcmVkTWVhc3VyZSwgeSkgewogICAgeSAtPSB3aWRnZXRUb3BIZWlnaHQobGluZU9iaik7CiAgICB2YXIgZW5kID0gbGluZU9iai50ZXh0Lmxlbmd0aDsKICAgIHZhciBiZWdpbiA9IGZpbmRGaXJzdChmdW5jdGlvbiAoY2gpIHsgcmV0dXJuIG1lYXN1cmVDaGFyUHJlcGFyZWQoY20sIHByZXBhcmVkTWVhc3VyZSwgY2ggLSAxKS5ib3R0b20gPD0geTsgfSwgZW5kLCAwKTsKICAgIGVuZCA9IGZpbmRGaXJzdChmdW5jdGlvbiAoY2gpIHsgcmV0dXJuIG1lYXN1cmVDaGFyUHJlcGFyZWQoY20sIHByZXBhcmVkTWVhc3VyZSwgY2gpLnRvcCA+IHk7IH0sIGJlZ2luLCBlbmQpOwogICAgcmV0dXJuIHtiZWdpbjogYmVnaW4sIGVuZDogZW5kfQogIH0KCiAgZnVuY3Rpb24gd3JhcHBlZExpbmVFeHRlbnRDaGFyKGNtLCBsaW5lT2JqLCBwcmVwYXJlZE1lYXN1cmUsIHRhcmdldCkgewogICAgaWYgKCFwcmVwYXJlZE1lYXN1cmUpIHsgcHJlcGFyZWRNZWFzdXJlID0gcHJlcGFyZU1lYXN1cmVGb3JMaW5lKGNtLCBsaW5lT2JqKTsgfQogICAgdmFyIHRhcmdldFRvcCA9IGludG9Db29yZFN5c3RlbShjbSwgbGluZU9iaiwgbWVhc3VyZUNoYXJQcmVwYXJlZChjbSwgcHJlcGFyZWRNZWFzdXJlLCB0YXJnZXQpLCAibGluZSIpLnRvcDsKICAgIHJldHVybiB3cmFwcGVkTGluZUV4dGVudChjbSwgbGluZU9iaiwgcHJlcGFyZWRNZWFzdXJlLCB0YXJnZXRUb3ApCiAgfQoKICAvLyBSZXR1cm5zIHRydWUgaWYgdGhlIGdpdmVuIHNpZGUgb2YgYSBib3ggaXMgYWZ0ZXIgdGhlIGdpdmVuCiAgLy8gY29vcmRpbmF0ZXMsIGluIHRvcC10by1ib3R0b20sIGxlZnQtdG8tcmlnaHQgb3JkZXIuCiAgZnVuY3Rpb24gYm94SXNBZnRlcihib3gsIHgsIHksIGxlZnQpIHsKICAgIHJldHVybiBib3guYm90dG9tIDw9IHkgPyBmYWxzZSA6IGJveC50b3AgPiB5ID8gdHJ1ZSA6IChsZWZ0ID8gYm94LmxlZnQgOiBib3gucmlnaHQpID4geAogIH0KCiAgZnVuY3Rpb24gY29vcmRzQ2hhcklubmVyKGNtLCBsaW5lT2JqLCBsaW5lTm8kJDEsIHgsIHkpIHsKICAgIC8vIE1vdmUgeSBpbnRvIGxpbmUtbG9jYWwgY29vcmRpbmF0ZSBzcGFjZQogICAgeSAtPSBoZWlnaHRBdExpbmUobGluZU9iaik7CiAgICB2YXIgcHJlcGFyZWRNZWFzdXJlID0gcHJlcGFyZU1lYXN1cmVGb3JMaW5lKGNtLCBsaW5lT2JqKTsKICAgIC8vIFdoZW4gZGlyZWN0bHkgY2FsbGluZyBgbWVhc3VyZUNoYXJQcmVwYXJlZGAsIHdlIGhhdmUgdG8gYWRqdXN0CiAgICAvLyBmb3IgdGhlIHdpZGdldHMgYXQgdGhpcyBsaW5lLgogICAgdmFyIHdpZGdldEhlaWdodCQkMSA9IHdpZGdldFRvcEhlaWdodChsaW5lT2JqKTsKICAgIHZhciBiZWdpbiA9IDAsIGVuZCA9IGxpbmVPYmoudGV4dC5sZW5ndGgsIGx0ciA9IHRydWU7CgogICAgdmFyIG9yZGVyID0gZ2V0T3JkZXIobGluZU9iaiwgY20uZG9jLmRpcmVjdGlvbik7CiAgICAvLyBJZiB0aGUgbGluZSBpc24ndCBwbGFpbiBsZWZ0LXRvLXJpZ2h0IHRleHQsIGZpcnN0IGZpZ3VyZSBvdXQKICAgIC8vIHdoaWNoIGJpZGkgc2VjdGlvbiB0aGUgY29vcmRpbmF0ZXMgZmFsbCBpbnRvLgogICAgaWYgKG9yZGVyKSB7CiAgICAgIHZhciBwYXJ0ID0gKGNtLm9wdGlvbnMubGluZVdyYXBwaW5nID8gY29vcmRzQmlkaVBhcnRXcmFwcGVkIDogY29vcmRzQmlkaVBhcnQpCiAgICAgICAgICAgICAgICAgICAoY20sIGxpbmVPYmosIGxpbmVObyQkMSwgcHJlcGFyZWRNZWFzdXJlLCBvcmRlciwgeCwgeSk7CiAgICAgIGx0ciA9IHBhcnQubGV2ZWwgIT0gMTsKICAgICAgLy8gVGhlIGF3a3dhcmQgLTEgb2Zmc2V0cyBhcmUgbmVlZGVkIGJlY2F1c2UgZmluZEZpcnN0IChjYWxsZWQKICAgICAgLy8gb24gdGhlc2UgYmVsb3cpIHdpbGwgdHJlYXQgaXRzIGZpcnN0IGJvdW5kIGFzIGluY2x1c2l2ZSwKICAgICAgLy8gc2Vjb25kIGFzIGV4Y2x1c2l2ZSwgYnV0IHdlIHdhbnQgdG8gYWN0dWFsbHkgYWRkcmVzcyB0aGUKICAgICAgLy8gY2hhcmFjdGVycyBpbiB0aGUgcGFydCdzIHJhbmdlCiAgICAgIGJlZ2luID0gbHRyID8gcGFydC5mcm9tIDogcGFydC50byAtIDE7CiAgICAgIGVuZCA9IGx0ciA/IHBhcnQudG8gOiBwYXJ0LmZyb20gLSAxOwogICAgfQoKICAgIC8vIEEgYmluYXJ5IHNlYXJjaCB0byBmaW5kIHRoZSBmaXJzdCBjaGFyYWN0ZXIgd2hvc2UgYm91bmRpbmcgYm94CiAgICAvLyBzdGFydHMgYWZ0ZXIgdGhlIGNvb3JkaW5hdGVzLiBJZiB3ZSBydW4gYWNyb3NzIGFueSB3aG9zZSBib3ggd3JhcAogICAgLy8gdGhlIGNvb3JkaW5hdGVzLCBzdG9yZSB0aGF0LgogICAgdmFyIGNoQXJvdW5kID0gbnVsbCwgYm94QXJvdW5kID0gbnVsbDsKICAgIHZhciBjaCA9IGZpbmRGaXJzdChmdW5jdGlvbiAoY2gpIHsKICAgICAgdmFyIGJveCA9IG1lYXN1cmVDaGFyUHJlcGFyZWQoY20sIHByZXBhcmVkTWVhc3VyZSwgY2gpOwogICAgICBib3gudG9wICs9IHdpZGdldEhlaWdodCQkMTsgYm94LmJvdHRvbSArPSB3aWRnZXRIZWlnaHQkJDE7CiAgICAgIGlmICghYm94SXNBZnRlcihib3gsIHgsIHksIGZhbHNlKSkgeyByZXR1cm4gZmFsc2UgfQogICAgICBpZiAoYm94LnRvcCA8PSB5ICYmIGJveC5sZWZ0IDw9IHgpIHsKICAgICAgICBjaEFyb3VuZCA9IGNoOwogICAgICAgIGJveEFyb3VuZCA9IGJveDsKICAgICAgfQogICAgICByZXR1cm4gdHJ1ZQogICAgfSwgYmVnaW4sIGVuZCk7CgogICAgdmFyIGJhc2VYLCBzdGlja3ksIG91dHNpZGUgPSBmYWxzZTsKICAgIC8vIElmIGEgYm94IGFyb3VuZCB0aGUgY29vcmRpbmF0ZXMgd2FzIGZvdW5kLCB1c2UgdGhhdAogICAgaWYgKGJveEFyb3VuZCkgewogICAgICAvLyBEaXN0aW5ndWlzaCBjb29yZGluYXRlcyBuZWFyZXIgdG8gdGhlIGxlZnQgb3IgcmlnaHQgc2lkZSBvZiB0aGUgYm94CiAgICAgIHZhciBhdExlZnQgPSB4IC0gYm94QXJvdW5kLmxlZnQgPCBib3hBcm91bmQucmlnaHQgLSB4LCBhdFN0YXJ0ID0gYXRMZWZ0ID09IGx0cjsKICAgICAgY2ggPSBjaEFyb3VuZCArIChhdFN0YXJ0ID8gMCA6IDEpOwogICAgICBzdGlja3kgPSBhdFN0YXJ0ID8gImFmdGVyIiA6ICJiZWZvcmUiOwogICAgICBiYXNlWCA9IGF0TGVmdCA/IGJveEFyb3VuZC5sZWZ0IDogYm94QXJvdW5kLnJpZ2h0OwogICAgfSBlbHNlIHsKICAgICAgLy8gKEFkanVzdCBmb3IgZXh0ZW5kZWQgYm91bmQsIGlmIG5lY2Vzc2FyeS4pCiAgICAgIGlmICghbHRyICYmIChjaCA9PSBlbmQgfHwgY2ggPT0gYmVnaW4pKSB7IGNoKys7IH0KICAgICAgLy8gVG8gZGV0ZXJtaW5lIHdoaWNoIHNpZGUgdG8gYXNzb2NpYXRlIHdpdGgsIGdldCB0aGUgYm94IHRvIHRoZQogICAgICAvLyBsZWZ0IG9mIHRoZSBjaGFyYWN0ZXIgYW5kIGNvbXBhcmUgaXQncyB2ZXJ0aWNhbCBwb3NpdGlvbiB0byB0aGUKICAgICAgLy8gY29vcmRpbmF0ZXMKICAgICAgc3RpY2t5ID0gY2ggPT0gMCA/ICJhZnRlciIgOiBjaCA9PSBsaW5lT2JqLnRleHQubGVuZ3RoID8gImJlZm9yZSIgOgogICAgICAgIChtZWFzdXJlQ2hhclByZXBhcmVkKGNtLCBwcmVwYXJlZE1lYXN1cmUsIGNoIC0gKGx0ciA/IDEgOiAwKSkuYm90dG9tICsgd2lkZ2V0SGVpZ2h0JCQxIDw9IHkpID09IGx0ciA/CiAgICAgICAgImFmdGVyIiA6ICJiZWZvcmUiOwogICAgICAvLyBOb3cgZ2V0IGFjY3VyYXRlIGNvb3JkaW5hdGVzIGZvciB0aGlzIHBsYWNlLCBpbiBvcmRlciB0byBnZXQgYQogICAgICAvLyBiYXNlIFggcG9zaXRpb24KICAgICAgdmFyIGNvb3JkcyA9IGN1cnNvckNvb3JkcyhjbSwgUG9zKGxpbmVObyQkMSwgY2gsIHN0aWNreSksICJsaW5lIiwgbGluZU9iaiwgcHJlcGFyZWRNZWFzdXJlKTsKICAgICAgYmFzZVggPSBjb29yZHMubGVmdDsKICAgICAgb3V0c2lkZSA9IHkgPCBjb29yZHMudG9wID8gLTEgOiB5ID49IGNvb3Jkcy5ib3R0b20gPyAxIDogMDsKICAgIH0KCiAgICBjaCA9IHNraXBFeHRlbmRpbmdDaGFycyhsaW5lT2JqLnRleHQsIGNoLCAxKTsKICAgIHJldHVybiBQb3NXaXRoSW5mbyhsaW5lTm8kJDEsIGNoLCBzdGlja3ksIG91dHNpZGUsIHggLSBiYXNlWCkKICB9CgogIGZ1bmN0aW9uIGNvb3Jkc0JpZGlQYXJ0KGNtLCBsaW5lT2JqLCBsaW5lTm8kJDEsIHByZXBhcmVkTWVhc3VyZSwgb3JkZXIsIHgsIHkpIHsKICAgIC8vIEJpZGkgcGFydHMgYXJlIHNvcnRlZCBsZWZ0LXRvLXJpZ2h0LCBhbmQgaW4gYSBub24tbGluZS13cmFwcGluZwogICAgLy8gc2l0dWF0aW9uLCB3ZSBjYW4gdGFrZSB0aGlzIG9yZGVyaW5nIHRvIGNvcnJlc3BvbmQgdG8gdGhlIHZpc3VhbAogICAgLy8gb3JkZXJpbmcuIFRoaXMgZmluZHMgdGhlIGZpcnN0IHBhcnQgd2hvc2UgZW5kIGlzIGFmdGVyIHRoZSBnaXZlbgogICAgLy8gY29vcmRpbmF0ZXMuCiAgICB2YXIgaW5kZXggPSBmaW5kRmlyc3QoZnVuY3Rpb24gKGkpIHsKICAgICAgdmFyIHBhcnQgPSBvcmRlcltpXSwgbHRyID0gcGFydC5sZXZlbCAhPSAxOwogICAgICByZXR1cm4gYm94SXNBZnRlcihjdXJzb3JDb29yZHMoY20sIFBvcyhsaW5lTm8kJDEsIGx0ciA/IHBhcnQudG8gOiBwYXJ0LmZyb20sIGx0ciA/ICJiZWZvcmUiIDogImFmdGVyIiksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAibGluZSIsIGxpbmVPYmosIHByZXBhcmVkTWVhc3VyZSksIHgsIHksIHRydWUpCiAgICB9LCAwLCBvcmRlci5sZW5ndGggLSAxKTsKICAgIHZhciBwYXJ0ID0gb3JkZXJbaW5kZXhdOwogICAgLy8gSWYgdGhpcyBpc24ndCB0aGUgZmlyc3QgcGFydCwgdGhlIHBhcnQncyBzdGFydCBpcyBhbHNvIGFmdGVyCiAgICAvLyB0aGUgY29vcmRpbmF0ZXMsIGFuZCB0aGUgY29vcmRpbmF0ZXMgYXJlbid0IG9uIHRoZSBzYW1lIGxpbmUgYXMKICAgIC8vIHRoYXQgc3RhcnQsIG1vdmUgb25lIHBhcnQgYmFjay4KICAgIGlmIChpbmRleCA+IDApIHsKICAgICAgdmFyIGx0ciA9IHBhcnQubGV2ZWwgIT0gMTsKICAgICAgdmFyIHN0YXJ0ID0gY3Vyc29yQ29vcmRzKGNtLCBQb3MobGluZU5vJCQxLCBsdHIgPyBwYXJ0LmZyb20gOiBwYXJ0LnRvLCBsdHIgPyAiYWZ0ZXIiIDogImJlZm9yZSIpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImxpbmUiLCBsaW5lT2JqLCBwcmVwYXJlZE1lYXN1cmUpOwogICAgICBpZiAoYm94SXNBZnRlcihzdGFydCwgeCwgeSwgdHJ1ZSkgJiYgc3RhcnQudG9wID4geSkKICAgICAgICB7IHBhcnQgPSBvcmRlcltpbmRleCAtIDFdOyB9CiAgICB9CiAgICByZXR1cm4gcGFydAogIH0KCiAgZnVuY3Rpb24gY29vcmRzQmlkaVBhcnRXcmFwcGVkKGNtLCBsaW5lT2JqLCBfbGluZU5vLCBwcmVwYXJlZE1lYXN1cmUsIG9yZGVyLCB4LCB5KSB7CiAgICAvLyBJbiBhIHdyYXBwZWQgbGluZSwgcnRsIHRleHQgb24gd3JhcHBpbmcgYm91bmRhcmllcyBjYW4gZG8gdGhpbmdzCiAgICAvLyB0aGF0IGRvbid0IGNvcnJlc3BvbmQgdG8gdGhlIG9yZGVyaW5nIGluIG91ciBgb3JkZXJgIGFycmF5IGF0CiAgICAvLyBhbGwsIHNvIGEgYmluYXJ5IHNlYXJjaCBkb2Vzbid0IHdvcmssIGFuZCB3ZSB3YW50IHRvIHJldHVybiBhCiAgICAvLyBwYXJ0IHRoYXQgb25seSBzcGFucyBvbmUgbGluZSBzbyB0aGF0IHRoZSBiaW5hcnkgc2VhcmNoIGluCiAgICAvLyBjb29yZHNDaGFySW5uZXIgaXMgc2FmZS4gQXMgc3VjaCwgd2UgZmlyc3QgZmluZCB0aGUgZXh0ZW50IG9mIHRoZQogICAgLy8gd3JhcHBlZCBsaW5lLCBhbmQgdGhlbiBkbyBhIGZsYXQgc2VhcmNoIGluIHdoaWNoIHdlIGRpc2NhcmQgYW55CiAgICAvLyBzcGFucyB0aGF0IGFyZW4ndCBvbiB0aGUgbGluZS4KICAgIHZhciByZWYgPSB3cmFwcGVkTGluZUV4dGVudChjbSwgbGluZU9iaiwgcHJlcGFyZWRNZWFzdXJlLCB5KTsKICAgIHZhciBiZWdpbiA9IHJlZi5iZWdpbjsKICAgIHZhciBlbmQgPSByZWYuZW5kOwogICAgaWYgKC9ccy8udGVzdChsaW5lT2JqLnRleHQuY2hhckF0KGVuZCAtIDEpKSkgeyBlbmQtLTsgfQogICAgdmFyIHBhcnQgPSBudWxsLCBjbG9zZXN0RGlzdCA9IG51bGw7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IG9yZGVyLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBwID0gb3JkZXJbaV07CiAgICAgIGlmIChwLmZyb20gPj0gZW5kIHx8IHAudG8gPD0gYmVnaW4pIHsgY29udGludWUgfQogICAgICB2YXIgbHRyID0gcC5sZXZlbCAhPSAxOwogICAgICB2YXIgZW5kWCA9IG1lYXN1cmVDaGFyUHJlcGFyZWQoY20sIHByZXBhcmVkTWVhc3VyZSwgbHRyID8gTWF0aC5taW4oZW5kLCBwLnRvKSAtIDEgOiBNYXRoLm1heChiZWdpbiwgcC5mcm9tKSkucmlnaHQ7CiAgICAgIC8vIFdlaWdoIGFnYWluc3Qgc3BhbnMgZW5kaW5nIGJlZm9yZSB0aGlzLCBzbyB0aGF0IHRoZXkgYXJlIG9ubHkKICAgICAgLy8gcGlja2VkIGlmIG5vdGhpbmcgZW5kcyBhZnRlcgogICAgICB2YXIgZGlzdCA9IGVuZFggPCB4ID8geCAtIGVuZFggKyAxZTkgOiBlbmRYIC0geDsKICAgICAgaWYgKCFwYXJ0IHx8IGNsb3Nlc3REaXN0ID4gZGlzdCkgewogICAgICAgIHBhcnQgPSBwOwogICAgICAgIGNsb3Nlc3REaXN0ID0gZGlzdDsKICAgICAgfQogICAgfQogICAgaWYgKCFwYXJ0KSB7IHBhcnQgPSBvcmRlcltvcmRlci5sZW5ndGggLSAxXTsgfQogICAgLy8gQ2xpcCB0aGUgcGFydCB0byB0aGUgd3JhcHBlZCBsaW5lLgogICAgaWYgKHBhcnQuZnJvbSA8IGJlZ2luKSB7IHBhcnQgPSB7ZnJvbTogYmVnaW4sIHRvOiBwYXJ0LnRvLCBsZXZlbDogcGFydC5sZXZlbH07IH0KICAgIGlmIChwYXJ0LnRvID4gZW5kKSB7IHBhcnQgPSB7ZnJvbTogcGFydC5mcm9tLCB0bzogZW5kLCBsZXZlbDogcGFydC5sZXZlbH07IH0KICAgIHJldHVybiBwYXJ0CiAgfQoKICB2YXIgbWVhc3VyZVRleHQ7CiAgLy8gQ29tcHV0ZSB0aGUgZGVmYXVsdCB0ZXh0IGhlaWdodC4KICBmdW5jdGlvbiB0ZXh0SGVpZ2h0KGRpc3BsYXkpIHsKICAgIGlmIChkaXNwbGF5LmNhY2hlZFRleHRIZWlnaHQgIT0gbnVsbCkgeyByZXR1cm4gZGlzcGxheS5jYWNoZWRUZXh0SGVpZ2h0IH0KICAgIGlmIChtZWFzdXJlVGV4dCA9PSBudWxsKSB7CiAgICAgIG1lYXN1cmVUZXh0ID0gZWx0KCJwcmUiLCBudWxsLCAiQ29kZU1pcnJvci1saW5lLWxpa2UiKTsKICAgICAgLy8gTWVhc3VyZSBhIGJ1bmNoIG9mIGxpbmVzLCBmb3IgYnJvd3NlcnMgdGhhdCBjb21wdXRlCiAgICAgIC8vIGZyYWN0aW9uYWwgaGVpZ2h0cy4KICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCA0OTsgKytpKSB7CiAgICAgICAgbWVhc3VyZVRleHQuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIngiKSk7CiAgICAgICAgbWVhc3VyZVRleHQuYXBwZW5kQ2hpbGQoZWx0KCJiciIpKTsKICAgICAgfQogICAgICBtZWFzdXJlVGV4dC5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSgieCIpKTsKICAgIH0KICAgIHJlbW92ZUNoaWxkcmVuQW5kQWRkKGRpc3BsYXkubWVhc3VyZSwgbWVhc3VyZVRleHQpOwogICAgdmFyIGhlaWdodCA9IG1lYXN1cmVUZXh0Lm9mZnNldEhlaWdodCAvIDUwOwogICAgaWYgKGhlaWdodCA+IDMpIHsgZGlzcGxheS5jYWNoZWRUZXh0SGVpZ2h0ID0gaGVpZ2h0OyB9CiAgICByZW1vdmVDaGlsZHJlbihkaXNwbGF5Lm1lYXN1cmUpOwogICAgcmV0dXJuIGhlaWdodCB8fCAxCiAgfQoKICAvLyBDb21wdXRlIHRoZSBkZWZhdWx0IGNoYXJhY3RlciB3aWR0aC4KICBmdW5jdGlvbiBjaGFyV2lkdGgoZGlzcGxheSkgewogICAgaWYgKGRpc3BsYXkuY2FjaGVkQ2hhcldpZHRoICE9IG51bGwpIHsgcmV0dXJuIGRpc3BsYXkuY2FjaGVkQ2hhcldpZHRoIH0KICAgIHZhciBhbmNob3IgPSBlbHQoInNwYW4iLCAieHh4eHh4eHh4eCIpOwogICAgdmFyIHByZSA9IGVsdCgicHJlIiwgW2FuY2hvcl0sICJDb2RlTWlycm9yLWxpbmUtbGlrZSIpOwogICAgcmVtb3ZlQ2hpbGRyZW5BbmRBZGQoZGlzcGxheS5tZWFzdXJlLCBwcmUpOwogICAgdmFyIHJlY3QgPSBhbmNob3IuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCksIHdpZHRoID0gKHJlY3QucmlnaHQgLSByZWN0LmxlZnQpIC8gMTA7CiAgICBpZiAod2lkdGggPiAyKSB7IGRpc3BsYXkuY2FjaGVkQ2hhcldpZHRoID0gd2lkdGg7IH0KICAgIHJldHVybiB3aWR0aCB8fCAxMAogIH0KCiAgLy8gRG8gYSBidWxrLXJlYWQgb2YgdGhlIERPTSBwb3NpdGlvbnMgYW5kIHNpemVzIG5lZWRlZCB0byBkcmF3IHRoZQogIC8vIHZpZXcsIHNvIHRoYXQgd2UgZG9uJ3QgaW50ZXJsZWF2ZSByZWFkaW5nIGFuZCB3cml0aW5nIHRvIHRoZSBET00uCiAgZnVuY3Rpb24gZ2V0RGltZW5zaW9ucyhjbSkgewogICAgdmFyIGQgPSBjbS5kaXNwbGF5LCBsZWZ0ID0ge30sIHdpZHRoID0ge307CiAgICB2YXIgZ3V0dGVyTGVmdCA9IGQuZ3V0dGVycy5jbGllbnRMZWZ0OwogICAgZm9yICh2YXIgbiA9IGQuZ3V0dGVycy5maXJzdENoaWxkLCBpID0gMDsgbjsgbiA9IG4ubmV4dFNpYmxpbmcsICsraSkgewogICAgICB2YXIgaWQgPSBjbS5kaXNwbGF5Lmd1dHRlclNwZWNzW2ldLmNsYXNzTmFtZTsKICAgICAgbGVmdFtpZF0gPSBuLm9mZnNldExlZnQgKyBuLmNsaWVudExlZnQgKyBndXR0ZXJMZWZ0OwogICAgICB3aWR0aFtpZF0gPSBuLmNsaWVudFdpZHRoOwogICAgfQogICAgcmV0dXJuIHtmaXhlZFBvczogY29tcGVuc2F0ZUZvckhTY3JvbGwoZCksCiAgICAgICAgICAgIGd1dHRlclRvdGFsV2lkdGg6IGQuZ3V0dGVycy5vZmZzZXRXaWR0aCwKICAgICAgICAgICAgZ3V0dGVyTGVmdDogbGVmdCwKICAgICAgICAgICAgZ3V0dGVyV2lkdGg6IHdpZHRoLAogICAgICAgICAgICB3cmFwcGVyV2lkdGg6IGQud3JhcHBlci5jbGllbnRXaWR0aH0KICB9CgogIC8vIENvbXB1dGVzIGRpc3BsYXkuc2Nyb2xsZXIuc2Nyb2xsTGVmdCArIGRpc3BsYXkuZ3V0dGVycy5vZmZzZXRXaWR0aCwKICAvLyBidXQgdXNpbmcgZ2V0Qm91bmRpbmdDbGllbnRSZWN0IHRvIGdldCBhIHN1Yi1waXhlbC1hY2N1cmF0ZQogIC8vIHJlc3VsdC4KICBmdW5jdGlvbiBjb21wZW5zYXRlRm9ySFNjcm9sbChkaXNwbGF5KSB7CiAgICByZXR1cm4gZGlzcGxheS5zY3JvbGxlci5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS5sZWZ0IC0gZGlzcGxheS5zaXplci5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS5sZWZ0CiAgfQoKICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24gdGhhdCBlc3RpbWF0ZXMgdGhlIGhlaWdodCBvZiBhIGxpbmUsIHRvIHVzZSBhcwogIC8vIGZpcnN0IGFwcHJveGltYXRpb24gdW50aWwgdGhlIGxpbmUgYmVjb21lcyB2aXNpYmxlIChhbmQgaXMgdGh1cwogIC8vIHByb3Blcmx5IG1lYXN1cmFibGUpLgogIGZ1bmN0aW9uIGVzdGltYXRlSGVpZ2h0KGNtKSB7CiAgICB2YXIgdGggPSB0ZXh0SGVpZ2h0KGNtLmRpc3BsYXkpLCB3cmFwcGluZyA9IGNtLm9wdGlvbnMubGluZVdyYXBwaW5nOwogICAgdmFyIHBlckxpbmUgPSB3cmFwcGluZyAmJiBNYXRoLm1heCg1LCBjbS5kaXNwbGF5LnNjcm9sbGVyLmNsaWVudFdpZHRoIC8gY2hhcldpZHRoKGNtLmRpc3BsYXkpIC0gMyk7CiAgICByZXR1cm4gZnVuY3Rpb24gKGxpbmUpIHsKICAgICAgaWYgKGxpbmVJc0hpZGRlbihjbS5kb2MsIGxpbmUpKSB7IHJldHVybiAwIH0KCiAgICAgIHZhciB3aWRnZXRzSGVpZ2h0ID0gMDsKICAgICAgaWYgKGxpbmUud2lkZ2V0cykgeyBmb3IgKHZhciBpID0gMDsgaSA8IGxpbmUud2lkZ2V0cy5sZW5ndGg7IGkrKykgewogICAgICAgIGlmIChsaW5lLndpZGdldHNbaV0uaGVpZ2h0KSB7IHdpZGdldHNIZWlnaHQgKz0gbGluZS53aWRnZXRzW2ldLmhlaWdodDsgfQogICAgICB9IH0KCiAgICAgIGlmICh3cmFwcGluZykKICAgICAgICB7IHJldHVybiB3aWRnZXRzSGVpZ2h0ICsgKE1hdGguY2VpbChsaW5lLnRleHQubGVuZ3RoIC8gcGVyTGluZSkgfHwgMSkgKiB0aCB9CiAgICAgIGVsc2UKICAgICAgICB7IHJldHVybiB3aWRnZXRzSGVpZ2h0ICsgdGggfQogICAgfQogIH0KCiAgZnVuY3Rpb24gZXN0aW1hdGVMaW5lSGVpZ2h0cyhjbSkgewogICAgdmFyIGRvYyA9IGNtLmRvYywgZXN0ID0gZXN0aW1hdGVIZWlnaHQoY20pOwogICAgZG9jLml0ZXIoZnVuY3Rpb24gKGxpbmUpIHsKICAgICAgdmFyIGVzdEhlaWdodCA9IGVzdChsaW5lKTsKICAgICAgaWYgKGVzdEhlaWdodCAhPSBsaW5lLmhlaWdodCkgeyB1cGRhdGVMaW5lSGVpZ2h0KGxpbmUsIGVzdEhlaWdodCk7IH0KICAgIH0pOwogIH0KCiAgLy8gR2l2ZW4gYSBtb3VzZSBldmVudCwgZmluZCB0aGUgY29ycmVzcG9uZGluZyBwb3NpdGlvbi4gSWYgbGliZXJhbAogIC8vIGlzIGZhbHNlLCBpdCBjaGVja3Mgd2hldGhlciBhIGd1dHRlciBvciBzY3JvbGxiYXIgd2FzIGNsaWNrZWQsCiAgLy8gYW5kIHJldHVybnMgbnVsbCBpZiBpdCB3YXMuIGZvclJlY3QgaXMgdXNlZCBieSByZWN0YW5ndWxhcgogIC8vIHNlbGVjdGlvbnMsIGFuZCB0cmllcyB0byBlc3RpbWF0ZSBhIGNoYXJhY3RlciBwb3NpdGlvbiBldmVuIGZvcgogIC8vIGNvb3JkaW5hdGVzIGJleW9uZCB0aGUgcmlnaHQgb2YgdGhlIHRleHQuCiAgZnVuY3Rpb24gcG9zRnJvbU1vdXNlKGNtLCBlLCBsaWJlcmFsLCBmb3JSZWN0KSB7CiAgICB2YXIgZGlzcGxheSA9IGNtLmRpc3BsYXk7CiAgICBpZiAoIWxpYmVyYWwgJiYgZV90YXJnZXQoZSkuZ2V0QXR0cmlidXRlKCJjbS1ub3QtY29udGVudCIpID09ICJ0cnVlIikgeyByZXR1cm4gbnVsbCB9CgogICAgdmFyIHgsIHksIHNwYWNlID0gZGlzcGxheS5saW5lU3BhY2UuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICAvLyBGYWlscyB1bnByZWRpY3RhYmx5IG9uIElFWzY3XSB3aGVuIG1vdXNlIGlzIGRyYWdnZWQgYXJvdW5kIHF1aWNrbHkuCiAgICB0cnkgeyB4ID0gZS5jbGllbnRYIC0gc3BhY2UubGVmdDsgeSA9IGUuY2xpZW50WSAtIHNwYWNlLnRvcDsgfQogICAgY2F0Y2ggKGUpIHsgcmV0dXJuIG51bGwgfQogICAgdmFyIGNvb3JkcyA9IGNvb3Jkc0NoYXIoY20sIHgsIHkpLCBsaW5lOwogICAgaWYgKGZvclJlY3QgJiYgY29vcmRzLnhSZWwgPT0gMSAmJiAobGluZSA9IGdldExpbmUoY20uZG9jLCBjb29yZHMubGluZSkudGV4dCkubGVuZ3RoID09IGNvb3Jkcy5jaCkgewogICAgICB2YXIgY29sRGlmZiA9IGNvdW50Q29sdW1uKGxpbmUsIGxpbmUubGVuZ3RoLCBjbS5vcHRpb25zLnRhYlNpemUpIC0gbGluZS5sZW5ndGg7CiAgICAgIGNvb3JkcyA9IFBvcyhjb29yZHMubGluZSwgTWF0aC5tYXgoMCwgTWF0aC5yb3VuZCgoeCAtIHBhZGRpbmdIKGNtLmRpc3BsYXkpLmxlZnQpIC8gY2hhcldpZHRoKGNtLmRpc3BsYXkpKSAtIGNvbERpZmYpKTsKICAgIH0KICAgIHJldHVybiBjb29yZHMKICB9CgogIC8vIEZpbmQgdGhlIHZpZXcgZWxlbWVudCBjb3JyZXNwb25kaW5nIHRvIGEgZ2l2ZW4gbGluZS4gUmV0dXJuIG51bGwKICAvLyB3aGVuIHRoZSBsaW5lIGlzbid0IHZpc2libGUuCiAgZnVuY3Rpb24gZmluZFZpZXdJbmRleChjbSwgbikgewogICAgaWYgKG4gPj0gY20uZGlzcGxheS52aWV3VG8pIHsgcmV0dXJuIG51bGwgfQogICAgbiAtPSBjbS5kaXNwbGF5LnZpZXdGcm9tOwogICAgaWYgKG4gPCAwKSB7IHJldHVybiBudWxsIH0KICAgIHZhciB2aWV3ID0gY20uZGlzcGxheS52aWV3OwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCB2aWV3Lmxlbmd0aDsgaSsrKSB7CiAgICAgIG4gLT0gdmlld1tpXS5zaXplOwogICAgICBpZiAobiA8IDApIHsgcmV0dXJuIGkgfQogICAgfQogIH0KCiAgLy8gVXBkYXRlcyB0aGUgZGlzcGxheS52aWV3IGRhdGEgc3RydWN0dXJlIGZvciBhIGdpdmVuIGNoYW5nZSB0byB0aGUKICAvLyBkb2N1bWVudC4gRnJvbSBhbmQgdG8gYXJlIGluIHByZS1jaGFuZ2UgY29vcmRpbmF0ZXMuIExlbmRpZmYgaXMKICAvLyB0aGUgYW1vdW50IG9mIGxpbmVzIGFkZGVkIG9yIHN1YnRyYWN0ZWQgYnkgdGhlIGNoYW5nZS4gVGhpcyBpcwogIC8vIHVzZWQgZm9yIGNoYW5nZXMgdGhhdCBzcGFuIG11bHRpcGxlIGxpbmVzLCBvciBjaGFuZ2UgdGhlIHdheQogIC8vIGxpbmVzIGFyZSBkaXZpZGVkIGludG8gdmlzdWFsIGxpbmVzLiByZWdMaW5lQ2hhbmdlIChiZWxvdykKICAvLyByZWdpc3RlcnMgc2luZ2xlLWxpbmUgY2hhbmdlcy4KICBmdW5jdGlvbiByZWdDaGFuZ2UoY20sIGZyb20sIHRvLCBsZW5kaWZmKSB7CiAgICBpZiAoZnJvbSA9PSBudWxsKSB7IGZyb20gPSBjbS5kb2MuZmlyc3Q7IH0KICAgIGlmICh0byA9PSBudWxsKSB7IHRvID0gY20uZG9jLmZpcnN0ICsgY20uZG9jLnNpemU7IH0KICAgIGlmICghbGVuZGlmZikgeyBsZW5kaWZmID0gMDsgfQoKICAgIHZhciBkaXNwbGF5ID0gY20uZGlzcGxheTsKICAgIGlmIChsZW5kaWZmICYmIHRvIDwgZGlzcGxheS52aWV3VG8gJiYKICAgICAgICAoZGlzcGxheS51cGRhdGVMaW5lTnVtYmVycyA9PSBudWxsIHx8IGRpc3BsYXkudXBkYXRlTGluZU51bWJlcnMgPiBmcm9tKSkKICAgICAgeyBkaXNwbGF5LnVwZGF0ZUxpbmVOdW1iZXJzID0gZnJvbTsgfQoKICAgIGNtLmN1ck9wLnZpZXdDaGFuZ2VkID0gdHJ1ZTsKCiAgICBpZiAoZnJvbSA+PSBkaXNwbGF5LnZpZXdUbykgeyAvLyBDaGFuZ2UgYWZ0ZXIKICAgICAgaWYgKHNhd0NvbGxhcHNlZFNwYW5zICYmIHZpc3VhbExpbmVObyhjbS5kb2MsIGZyb20pIDwgZGlzcGxheS52aWV3VG8pCiAgICAgICAgeyByZXNldFZpZXcoY20pOyB9CiAgICB9IGVsc2UgaWYgKHRvIDw9IGRpc3BsYXkudmlld0Zyb20pIHsgLy8gQ2hhbmdlIGJlZm9yZQogICAgICBpZiAoc2F3Q29sbGFwc2VkU3BhbnMgJiYgdmlzdWFsTGluZUVuZE5vKGNtLmRvYywgdG8gKyBsZW5kaWZmKSA+IGRpc3BsYXkudmlld0Zyb20pIHsKICAgICAgICByZXNldFZpZXcoY20pOwogICAgICB9IGVsc2UgewogICAgICAgIGRpc3BsYXkudmlld0Zyb20gKz0gbGVuZGlmZjsKICAgICAgICBkaXNwbGF5LnZpZXdUbyArPSBsZW5kaWZmOwogICAgICB9CiAgICB9IGVsc2UgaWYgKGZyb20gPD0gZGlzcGxheS52aWV3RnJvbSAmJiB0byA+PSBkaXNwbGF5LnZpZXdUbykgeyAvLyBGdWxsIG92ZXJsYXAKICAgICAgcmVzZXRWaWV3KGNtKTsKICAgIH0gZWxzZSBpZiAoZnJvbSA8PSBkaXNwbGF5LnZpZXdGcm9tKSB7IC8vIFRvcCBvdmVybGFwCiAgICAgIHZhciBjdXQgPSB2aWV3Q3V0dGluZ1BvaW50KGNtLCB0bywgdG8gKyBsZW5kaWZmLCAxKTsKICAgICAgaWYgKGN1dCkgewogICAgICAgIGRpc3BsYXkudmlldyA9IGRpc3BsYXkudmlldy5zbGljZShjdXQuaW5kZXgpOwogICAgICAgIGRpc3BsYXkudmlld0Zyb20gPSBjdXQubGluZU47CiAgICAgICAgZGlzcGxheS52aWV3VG8gKz0gbGVuZGlmZjsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXNldFZpZXcoY20pOwogICAgICB9CiAgICB9IGVsc2UgaWYgKHRvID49IGRpc3BsYXkudmlld1RvKSB7IC8vIEJvdHRvbSBvdmVybGFwCiAgICAgIHZhciBjdXQkMSA9IHZpZXdDdXR0aW5nUG9pbnQoY20sIGZyb20sIGZyb20sIC0xKTsKICAgICAgaWYgKGN1dCQxKSB7CiAgICAgICAgZGlzcGxheS52aWV3ID0gZGlzcGxheS52aWV3LnNsaWNlKDAsIGN1dCQxLmluZGV4KTsKICAgICAgICBkaXNwbGF5LnZpZXdUbyA9IGN1dCQxLmxpbmVOOwogICAgICB9IGVsc2UgewogICAgICAgIHJlc2V0VmlldyhjbSk7CiAgICAgIH0KICAgIH0gZWxzZSB7IC8vIEdhcCBpbiB0aGUgbWlkZGxlCiAgICAgIHZhciBjdXRUb3AgPSB2aWV3Q3V0dGluZ1BvaW50KGNtLCBmcm9tLCBmcm9tLCAtMSk7CiAgICAgIHZhciBjdXRCb3QgPSB2aWV3Q3V0dGluZ1BvaW50KGNtLCB0bywgdG8gKyBsZW5kaWZmLCAxKTsKICAgICAgaWYgKGN1dFRvcCAmJiBjdXRCb3QpIHsKICAgICAgICBkaXNwbGF5LnZpZXcgPSBkaXNwbGF5LnZpZXcuc2xpY2UoMCwgY3V0VG9wLmluZGV4KQogICAgICAgICAgLmNvbmNhdChidWlsZFZpZXdBcnJheShjbSwgY3V0VG9wLmxpbmVOLCBjdXRCb3QubGluZU4pKQogICAgICAgICAgLmNvbmNhdChkaXNwbGF5LnZpZXcuc2xpY2UoY3V0Qm90LmluZGV4KSk7CiAgICAgICAgZGlzcGxheS52aWV3VG8gKz0gbGVuZGlmZjsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXNldFZpZXcoY20pOwogICAgICB9CiAgICB9CgogICAgdmFyIGV4dCA9IGRpc3BsYXkuZXh0ZXJuYWxNZWFzdXJlZDsKICAgIGlmIChleHQpIHsKICAgICAgaWYgKHRvIDwgZXh0LmxpbmVOKQogICAgICAgIHsgZXh0LmxpbmVOICs9IGxlbmRpZmY7IH0KICAgICAgZWxzZSBpZiAoZnJvbSA8IGV4dC5saW5lTiArIGV4dC5zaXplKQogICAgICAgIHsgZGlzcGxheS5leHRlcm5hbE1lYXN1cmVkID0gbnVsbDsgfQogICAgfQogIH0KCiAgLy8gUmVnaXN0ZXIgYSBjaGFuZ2UgdG8gYSBzaW5nbGUgbGluZS4gVHlwZSBtdXN0IGJlIG9uZSBvZiAidGV4dCIsCiAgLy8gImd1dHRlciIsICJjbGFzcyIsICJ3aWRnZXQiCiAgZnVuY3Rpb24gcmVnTGluZUNoYW5nZShjbSwgbGluZSwgdHlwZSkgewogICAgY20uY3VyT3Audmlld0NoYW5nZWQgPSB0cnVlOwogICAgdmFyIGRpc3BsYXkgPSBjbS5kaXNwbGF5LCBleHQgPSBjbS5kaXNwbGF5LmV4dGVybmFsTWVhc3VyZWQ7CiAgICBpZiAoZXh0ICYmIGxpbmUgPj0gZXh0LmxpbmVOICYmIGxpbmUgPCBleHQubGluZU4gKyBleHQuc2l6ZSkKICAgICAgeyBkaXNwbGF5LmV4dGVybmFsTWVhc3VyZWQgPSBudWxsOyB9CgogICAgaWYgKGxpbmUgPCBkaXNwbGF5LnZpZXdGcm9tIHx8IGxpbmUgPj0gZGlzcGxheS52aWV3VG8pIHsgcmV0dXJuIH0KICAgIHZhciBsaW5lVmlldyA9IGRpc3BsYXkudmlld1tmaW5kVmlld0luZGV4KGNtLCBsaW5lKV07CiAgICBpZiAobGluZVZpZXcubm9kZSA9PSBudWxsKSB7IHJldHVybiB9CiAgICB2YXIgYXJyID0gbGluZVZpZXcuY2hhbmdlcyB8fCAobGluZVZpZXcuY2hhbmdlcyA9IFtdKTsKICAgIGlmIChpbmRleE9mKGFyciwgdHlwZSkgPT0gLTEpIHsgYXJyLnB1c2godHlwZSk7IH0KICB9CgogIC8vIENsZWFyIHRoZSB2aWV3LgogIGZ1bmN0aW9uIHJlc2V0VmlldyhjbSkgewogICAgY20uZGlzcGxheS52aWV3RnJvbSA9IGNtLmRpc3BsYXkudmlld1RvID0gY20uZG9jLmZpcnN0OwogICAgY20uZGlzcGxheS52aWV3ID0gW107CiAgICBjbS5kaXNwbGF5LnZpZXdPZmZzZXQgPSAwOwogIH0KCiAgZnVuY3Rpb24gdmlld0N1dHRpbmdQb2ludChjbSwgb2xkTiwgbmV3TiwgZGlyKSB7CiAgICB2YXIgaW5kZXggPSBmaW5kVmlld0luZGV4KGNtLCBvbGROKSwgZGlmZiwgdmlldyA9IGNtLmRpc3BsYXkudmlldzsKICAgIGlmICghc2F3Q29sbGFwc2VkU3BhbnMgfHwgbmV3TiA9PSBjbS5kb2MuZmlyc3QgKyBjbS5kb2Muc2l6ZSkKICAgICAgeyByZXR1cm4ge2luZGV4OiBpbmRleCwgbGluZU46IG5ld059IH0KICAgIHZhciBuID0gY20uZGlzcGxheS52aWV3RnJvbTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaW5kZXg7IGkrKykKICAgICAgeyBuICs9IHZpZXdbaV0uc2l6ZTsgfQogICAgaWYgKG4gIT0gb2xkTikgewogICAgICBpZiAoZGlyID4gMCkgewogICAgICAgIGlmIChpbmRleCA9PSB2aWV3Lmxlbmd0aCAtIDEpIHsgcmV0dXJuIG51bGwgfQogICAgICAgIGRpZmYgPSAobiArIHZpZXdbaW5kZXhdLnNpemUpIC0gb2xkTjsKICAgICAgICBpbmRleCsrOwogICAgICB9IGVsc2UgewogICAgICAgIGRpZmYgPSBuIC0gb2xkTjsKICAgICAgfQogICAgICBvbGROICs9IGRpZmY7IG5ld04gKz0gZGlmZjsKICAgIH0KICAgIHdoaWxlICh2aXN1YWxMaW5lTm8oY20uZG9jLCBuZXdOKSAhPSBuZXdOKSB7CiAgICAgIGlmIChpbmRleCA9PSAoZGlyIDwgMCA/IDAgOiB2aWV3Lmxlbmd0aCAtIDEpKSB7IHJldHVybiBudWxsIH0KICAgICAgbmV3TiArPSBkaXIgKiB2aWV3W2luZGV4IC0gKGRpciA8IDAgPyAxIDogMCldLnNpemU7CiAgICAgIGluZGV4ICs9IGRpcjsKICAgIH0KICAgIHJldHVybiB7aW5kZXg6IGluZGV4LCBsaW5lTjogbmV3Tn0KICB9CgogIC8vIEZvcmNlIHRoZSB2aWV3IHRvIGNvdmVyIGEgZ2l2ZW4gcmFuZ2UsIGFkZGluZyBlbXB0eSB2aWV3IGVsZW1lbnQKICAvLyBvciBjbGlwcGluZyBvZmYgZXhpc3Rpbmcgb25lcyBhcyBuZWVkZWQuCiAgZnVuY3Rpb24gYWRqdXN0VmlldyhjbSwgZnJvbSwgdG8pIHsKICAgIHZhciBkaXNwbGF5ID0gY20uZGlzcGxheSwgdmlldyA9IGRpc3BsYXkudmlldzsKICAgIGlmICh2aWV3Lmxlbmd0aCA9PSAwIHx8IGZyb20gPj0gZGlzcGxheS52aWV3VG8gfHwgdG8gPD0gZGlzcGxheS52aWV3RnJvbSkgewogICAgICBkaXNwbGF5LnZpZXcgPSBidWlsZFZpZXdBcnJheShjbSwgZnJvbSwgdG8pOwogICAgICBkaXNwbGF5LnZpZXdGcm9tID0gZnJvbTsKICAgIH0gZWxzZSB7CiAgICAgIGlmIChkaXNwbGF5LnZpZXdGcm9tID4gZnJvbSkKICAgICAgICB7IGRpc3BsYXkudmlldyA9IGJ1aWxkVmlld0FycmF5KGNtLCBmcm9tLCBkaXNwbGF5LnZpZXdGcm9tKS5jb25jYXQoZGlzcGxheS52aWV3KTsgfQogICAgICBlbHNlIGlmIChkaXNwbGF5LnZpZXdGcm9tIDwgZnJvbSkKICAgICAgICB7IGRpc3BsYXkudmlldyA9IGRpc3BsYXkudmlldy5zbGljZShmaW5kVmlld0luZGV4KGNtLCBmcm9tKSk7IH0KICAgICAgZGlzcGxheS52aWV3RnJvbSA9IGZyb207CiAgICAgIGlmIChkaXNwbGF5LnZpZXdUbyA8IHRvKQogICAgICAgIHsgZGlzcGxheS52aWV3ID0gZGlzcGxheS52aWV3LmNvbmNhdChidWlsZFZpZXdBcnJheShjbSwgZGlzcGxheS52aWV3VG8sIHRvKSk7IH0KICAgICAgZWxzZSBpZiAoZGlzcGxheS52aWV3VG8gPiB0bykKICAgICAgICB7IGRpc3BsYXkudmlldyA9IGRpc3BsYXkudmlldy5zbGljZSgwLCBmaW5kVmlld0luZGV4KGNtLCB0bykpOyB9CiAgICB9CiAgICBkaXNwbGF5LnZpZXdUbyA9IHRvOwogIH0KCiAgLy8gQ291bnQgdGhlIG51bWJlciBvZiBsaW5lcyBpbiB0aGUgdmlldyB3aG9zZSBET00gcmVwcmVzZW50YXRpb24gaXMKICAvLyBvdXQgb2YgZGF0ZSAob3Igbm9uZXhpc3RlbnQpLgogIGZ1bmN0aW9uIGNvdW50RGlydHlWaWV3KGNtKSB7CiAgICB2YXIgdmlldyA9IGNtLmRpc3BsYXkudmlldywgZGlydHkgPSAwOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCB2aWV3Lmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBsaW5lVmlldyA9IHZpZXdbaV07CiAgICAgIGlmICghbGluZVZpZXcuaGlkZGVuICYmICghbGluZVZpZXcubm9kZSB8fCBsaW5lVmlldy5jaGFuZ2VzKSkgeyArK2RpcnR5OyB9CiAgICB9CiAgICByZXR1cm4gZGlydHkKICB9CgogIGZ1bmN0aW9uIHVwZGF0ZVNlbGVjdGlvbihjbSkgewogICAgY20uZGlzcGxheS5pbnB1dC5zaG93U2VsZWN0aW9uKGNtLmRpc3BsYXkuaW5wdXQucHJlcGFyZVNlbGVjdGlvbigpKTsKICB9CgogIGZ1bmN0aW9uIHByZXBhcmVTZWxlY3Rpb24oY20sIHByaW1hcnkpIHsKICAgIGlmICggcHJpbWFyeSA9PT0gdm9pZCAwICkgcHJpbWFyeSA9IHRydWU7CgogICAgdmFyIGRvYyA9IGNtLmRvYywgcmVzdWx0ID0ge307CiAgICB2YXIgY3VyRnJhZ21lbnQgPSByZXN1bHQuY3Vyc29ycyA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTsKICAgIHZhciBzZWxGcmFnbWVudCA9IHJlc3VsdC5zZWxlY3Rpb24gPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkb2Muc2VsLnJhbmdlcy5sZW5ndGg7IGkrKykgewogICAgICBpZiAoIXByaW1hcnkgJiYgaSA9PSBkb2Muc2VsLnByaW1JbmRleCkgeyBjb250aW51ZSB9CiAgICAgIHZhciByYW5nZSQkMSA9IGRvYy5zZWwucmFuZ2VzW2ldOwogICAgICBpZiAocmFuZ2UkJDEuZnJvbSgpLmxpbmUgPj0gY20uZGlzcGxheS52aWV3VG8gfHwgcmFuZ2UkJDEudG8oKS5saW5lIDwgY20uZGlzcGxheS52aWV3RnJvbSkgeyBjb250aW51ZSB9CiAgICAgIHZhciBjb2xsYXBzZWQgPSByYW5nZSQkMS5lbXB0eSgpOwogICAgICBpZiAoY29sbGFwc2VkIHx8IGNtLm9wdGlvbnMuc2hvd0N1cnNvcldoZW5TZWxlY3RpbmcpCiAgICAgICAgeyBkcmF3U2VsZWN0aW9uQ3Vyc29yKGNtLCByYW5nZSQkMS5oZWFkLCBjdXJGcmFnbWVudCk7IH0KICAgICAgaWYgKCFjb2xsYXBzZWQpCiAgICAgICAgeyBkcmF3U2VsZWN0aW9uUmFuZ2UoY20sIHJhbmdlJCQxLCBzZWxGcmFnbWVudCk7IH0KICAgIH0KICAgIHJldHVybiByZXN1bHQKICB9CgogIC8vIERyYXdzIGEgY3Vyc29yIGZvciB0aGUgZ2l2ZW4gcmFuZ2UKICBmdW5jdGlvbiBkcmF3U2VsZWN0aW9uQ3Vyc29yKGNtLCBoZWFkLCBvdXRwdXQpIHsKICAgIHZhciBwb3MgPSBjdXJzb3JDb29yZHMoY20sIGhlYWQsICJkaXYiLCBudWxsLCBudWxsLCAhY20ub3B0aW9ucy5zaW5nbGVDdXJzb3JIZWlnaHRQZXJMaW5lKTsKCiAgICB2YXIgY3Vyc29yID0gb3V0cHV0LmFwcGVuZENoaWxkKGVsdCgiZGl2IiwgIlx1MDBhMCIsICJDb2RlTWlycm9yLWN1cnNvciIpKTsKICAgIGN1cnNvci5zdHlsZS5sZWZ0ID0gcG9zLmxlZnQgKyAicHgiOwogICAgY3Vyc29yLnN0eWxlLnRvcCA9IHBvcy50b3AgKyAicHgiOwogICAgY3Vyc29yLnN0eWxlLmhlaWdodCA9IE1hdGgubWF4KDAsIHBvcy5ib3R0b20gLSBwb3MudG9wKSAqIGNtLm9wdGlvbnMuY3Vyc29ySGVpZ2h0ICsgInB4IjsKCiAgICBpZiAocG9zLm90aGVyKSB7CiAgICAgIC8vIFNlY29uZGFyeSBjdXJzb3IsIHNob3duIHdoZW4gb24gYSAnanVtcCcgaW4gYmktZGlyZWN0aW9uYWwgdGV4dAogICAgICB2YXIgb3RoZXJDdXJzb3IgPSBvdXRwdXQuYXBwZW5kQ2hpbGQoZWx0KCJkaXYiLCAiXHUwMGEwIiwgIkNvZGVNaXJyb3ItY3Vyc29yIENvZGVNaXJyb3Itc2Vjb25kYXJ5Y3Vyc29yIikpOwogICAgICBvdGhlckN1cnNvci5zdHlsZS5kaXNwbGF5ID0gIiI7CiAgICAgIG90aGVyQ3Vyc29yLnN0eWxlLmxlZnQgPSBwb3Mub3RoZXIubGVmdCArICJweCI7CiAgICAgIG90aGVyQ3Vyc29yLnN0eWxlLnRvcCA9IHBvcy5vdGhlci50b3AgKyAicHgiOwogICAgICBvdGhlckN1cnNvci5zdHlsZS5oZWlnaHQgPSAocG9zLm90aGVyLmJvdHRvbSAtIHBvcy5vdGhlci50b3ApICogLjg1ICsgInB4IjsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGNtcENvb3JkcyhhLCBiKSB7IHJldHVybiBhLnRvcCAtIGIudG9wIHx8IGEubGVmdCAtIGIubGVmdCB9CgogIC8vIERyYXdzIHRoZSBnaXZlbiByYW5nZSBhcyBhIGhpZ2hsaWdodGVkIHNlbGVjdGlvbgogIGZ1bmN0aW9uIGRyYXdTZWxlY3Rpb25SYW5nZShjbSwgcmFuZ2UkJDEsIG91dHB1dCkgewogICAgdmFyIGRpc3BsYXkgPSBjbS5kaXNwbGF5LCBkb2MgPSBjbS5kb2M7CiAgICB2YXIgZnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CiAgICB2YXIgcGFkZGluZyA9IHBhZGRpbmdIKGNtLmRpc3BsYXkpLCBsZWZ0U2lkZSA9IHBhZGRpbmcubGVmdDsKICAgIHZhciByaWdodFNpZGUgPSBNYXRoLm1heChkaXNwbGF5LnNpemVyV2lkdGgsIGRpc3BsYXlXaWR0aChjbSkgLSBkaXNwbGF5LnNpemVyLm9mZnNldExlZnQpIC0gcGFkZGluZy5yaWdodDsKICAgIHZhciBkb2NMVFIgPSBkb2MuZGlyZWN0aW9uID09ICJsdHIiOwoKICAgIGZ1bmN0aW9uIGFkZChsZWZ0LCB0b3AsIHdpZHRoLCBib3R0b20pIHsKICAgICAgaWYgKHRvcCA8IDApIHsgdG9wID0gMDsgfQogICAgICB0b3AgPSBNYXRoLnJvdW5kKHRvcCk7CiAgICAgIGJvdHRvbSA9IE1hdGgucm91bmQoYm90dG9tKTsKICAgICAgZnJhZ21lbnQuYXBwZW5kQ2hpbGQoZWx0KCJkaXYiLCBudWxsLCAiQ29kZU1pcnJvci1zZWxlY3RlZCIsICgicG9zaXRpb246IGFic29sdXRlOyBsZWZ0OiAiICsgbGVmdCArICJweDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9wOiAiICsgdG9wICsgInB4OyB3aWR0aDogIiArICh3aWR0aCA9PSBudWxsID8gcmlnaHRTaWRlIC0gbGVmdCA6IHdpZHRoKSArICJweDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVpZ2h0OiAiICsgKGJvdHRvbSAtIHRvcCkgKyAicHgiKSkpOwogICAgfQoKICAgIGZ1bmN0aW9uIGRyYXdGb3JMaW5lKGxpbmUsIGZyb21BcmcsIHRvQXJnKSB7CiAgICAgIHZhciBsaW5lT2JqID0gZ2V0TGluZShkb2MsIGxpbmUpOwogICAgICB2YXIgbGluZUxlbiA9IGxpbmVPYmoudGV4dC5sZW5ndGg7CiAgICAgIHZhciBzdGFydCwgZW5kOwogICAgICBmdW5jdGlvbiBjb29yZHMoY2gsIGJpYXMpIHsKICAgICAgICByZXR1cm4gY2hhckNvb3JkcyhjbSwgUG9zKGxpbmUsIGNoKSwgImRpdiIsIGxpbmVPYmosIGJpYXMpCiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIHdyYXBYKHBvcywgZGlyLCBzaWRlKSB7CiAgICAgICAgdmFyIGV4dGVudCA9IHdyYXBwZWRMaW5lRXh0ZW50Q2hhcihjbSwgbGluZU9iaiwgbnVsbCwgcG9zKTsKICAgICAgICB2YXIgcHJvcCA9IChkaXIgPT0gImx0ciIpID09IChzaWRlID09ICJhZnRlciIpID8gImxlZnQiIDogInJpZ2h0IjsKICAgICAgICB2YXIgY2ggPSBzaWRlID09ICJhZnRlciIgPyBleHRlbnQuYmVnaW4gOiBleHRlbnQuZW5kIC0gKC9ccy8udGVzdChsaW5lT2JqLnRleHQuY2hhckF0KGV4dGVudC5lbmQgLSAxKSkgPyAyIDogMSk7CiAgICAgICAgcmV0dXJuIGNvb3JkcyhjaCwgcHJvcClbcHJvcF0KICAgICAgfQoKICAgICAgdmFyIG9yZGVyID0gZ2V0T3JkZXIobGluZU9iaiwgZG9jLmRpcmVjdGlvbik7CiAgICAgIGl0ZXJhdGVCaWRpU2VjdGlvbnMob3JkZXIsIGZyb21BcmcgfHwgMCwgdG9BcmcgPT0gbnVsbCA/IGxpbmVMZW4gOiB0b0FyZywgZnVuY3Rpb24gKGZyb20sIHRvLCBkaXIsIGkpIHsKICAgICAgICB2YXIgbHRyID0gZGlyID09ICJsdHIiOwogICAgICAgIHZhciBmcm9tUG9zID0gY29vcmRzKGZyb20sIGx0ciA/ICJsZWZ0IiA6ICJyaWdodCIpOwogICAgICAgIHZhciB0b1BvcyA9IGNvb3Jkcyh0byAtIDEsIGx0ciA/ICJyaWdodCIgOiAibGVmdCIpOwoKICAgICAgICB2YXIgb3BlblN0YXJ0ID0gZnJvbUFyZyA9PSBudWxsICYmIGZyb20gPT0gMCwgb3BlbkVuZCA9IHRvQXJnID09IG51bGwgJiYgdG8gPT0gbGluZUxlbjsKICAgICAgICB2YXIgZmlyc3QgPSBpID09IDAsIGxhc3QgPSAhb3JkZXIgfHwgaSA9PSBvcmRlci5sZW5ndGggLSAxOwogICAgICAgIGlmICh0b1Bvcy50b3AgLSBmcm9tUG9zLnRvcCA8PSAzKSB7IC8vIFNpbmdsZSBsaW5lCiAgICAgICAgICB2YXIgb3BlbkxlZnQgPSAoZG9jTFRSID8gb3BlblN0YXJ0IDogb3BlbkVuZCkgJiYgZmlyc3Q7CiAgICAgICAgICB2YXIgb3BlblJpZ2h0ID0gKGRvY0xUUiA/IG9wZW5FbmQgOiBvcGVuU3RhcnQpICYmIGxhc3Q7CiAgICAgICAgICB2YXIgbGVmdCA9IG9wZW5MZWZ0ID8gbGVmdFNpZGUgOiAobHRyID8gZnJvbVBvcyA6IHRvUG9zKS5sZWZ0OwogICAgICAgICAgdmFyIHJpZ2h0ID0gb3BlblJpZ2h0ID8gcmlnaHRTaWRlIDogKGx0ciA/IHRvUG9zIDogZnJvbVBvcykucmlnaHQ7CiAgICAgICAgICBhZGQobGVmdCwgZnJvbVBvcy50b3AsIHJpZ2h0IC0gbGVmdCwgZnJvbVBvcy5ib3R0b20pOwogICAgICAgIH0gZWxzZSB7IC8vIE11bHRpcGxlIGxpbmVzCiAgICAgICAgICB2YXIgdG9wTGVmdCwgdG9wUmlnaHQsIGJvdExlZnQsIGJvdFJpZ2h0OwogICAgICAgICAgaWYgKGx0cikgewogICAgICAgICAgICB0b3BMZWZ0ID0gZG9jTFRSICYmIG9wZW5TdGFydCAmJiBmaXJzdCA/IGxlZnRTaWRlIDogZnJvbVBvcy5sZWZ0OwogICAgICAgICAgICB0b3BSaWdodCA9IGRvY0xUUiA/IHJpZ2h0U2lkZSA6IHdyYXBYKGZyb20sIGRpciwgImJlZm9yZSIpOwogICAgICAgICAgICBib3RMZWZ0ID0gZG9jTFRSID8gbGVmdFNpZGUgOiB3cmFwWCh0bywgZGlyLCAiYWZ0ZXIiKTsKICAgICAgICAgICAgYm90UmlnaHQgPSBkb2NMVFIgJiYgb3BlbkVuZCAmJiBsYXN0ID8gcmlnaHRTaWRlIDogdG9Qb3MucmlnaHQ7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0b3BMZWZ0ID0gIWRvY0xUUiA/IGxlZnRTaWRlIDogd3JhcFgoZnJvbSwgZGlyLCAiYmVmb3JlIik7CiAgICAgICAgICAgIHRvcFJpZ2h0ID0gIWRvY0xUUiAmJiBvcGVuU3RhcnQgJiYgZmlyc3QgPyByaWdodFNpZGUgOiBmcm9tUG9zLnJpZ2h0OwogICAgICAgICAgICBib3RMZWZ0ID0gIWRvY0xUUiAmJiBvcGVuRW5kICYmIGxhc3QgPyBsZWZ0U2lkZSA6IHRvUG9zLmxlZnQ7CiAgICAgICAgICAgIGJvdFJpZ2h0ID0gIWRvY0xUUiA/IHJpZ2h0U2lkZSA6IHdyYXBYKHRvLCBkaXIsICJhZnRlciIpOwogICAgICAgICAgfQogICAgICAgICAgYWRkKHRvcExlZnQsIGZyb21Qb3MudG9wLCB0b3BSaWdodCAtIHRvcExlZnQsIGZyb21Qb3MuYm90dG9tKTsKICAgICAgICAgIGlmIChmcm9tUG9zLmJvdHRvbSA8IHRvUG9zLnRvcCkgeyBhZGQobGVmdFNpZGUsIGZyb21Qb3MuYm90dG9tLCBudWxsLCB0b1Bvcy50b3ApOyB9CiAgICAgICAgICBhZGQoYm90TGVmdCwgdG9Qb3MudG9wLCBib3RSaWdodCAtIGJvdExlZnQsIHRvUG9zLmJvdHRvbSk7CiAgICAgICAgfQoKICAgICAgICBpZiAoIXN0YXJ0IHx8IGNtcENvb3Jkcyhmcm9tUG9zLCBzdGFydCkgPCAwKSB7IHN0YXJ0ID0gZnJvbVBvczsgfQogICAgICAgIGlmIChjbXBDb29yZHModG9Qb3MsIHN0YXJ0KSA8IDApIHsgc3RhcnQgPSB0b1BvczsgfQogICAgICAgIGlmICghZW5kIHx8IGNtcENvb3Jkcyhmcm9tUG9zLCBlbmQpIDwgMCkgeyBlbmQgPSBmcm9tUG9zOyB9CiAgICAgICAgaWYgKGNtcENvb3Jkcyh0b1BvcywgZW5kKSA8IDApIHsgZW5kID0gdG9Qb3M7IH0KICAgICAgfSk7CiAgICAgIHJldHVybiB7c3RhcnQ6IHN0YXJ0LCBlbmQ6IGVuZH0KICAgIH0KCiAgICB2YXIgc0Zyb20gPSByYW5nZSQkMS5mcm9tKCksIHNUbyA9IHJhbmdlJCQxLnRvKCk7CiAgICBpZiAoc0Zyb20ubGluZSA9PSBzVG8ubGluZSkgewogICAgICBkcmF3Rm9yTGluZShzRnJvbS5saW5lLCBzRnJvbS5jaCwgc1RvLmNoKTsKICAgIH0gZWxzZSB7CiAgICAgIHZhciBmcm9tTGluZSA9IGdldExpbmUoZG9jLCBzRnJvbS5saW5lKSwgdG9MaW5lID0gZ2V0TGluZShkb2MsIHNUby5saW5lKTsKICAgICAgdmFyIHNpbmdsZVZMaW5lID0gdmlzdWFsTGluZShmcm9tTGluZSkgPT0gdmlzdWFsTGluZSh0b0xpbmUpOwogICAgICB2YXIgbGVmdEVuZCA9IGRyYXdGb3JMaW5lKHNGcm9tLmxpbmUsIHNGcm9tLmNoLCBzaW5nbGVWTGluZSA/IGZyb21MaW5lLnRleHQubGVuZ3RoICsgMSA6IG51bGwpLmVuZDsKICAgICAgdmFyIHJpZ2h0U3RhcnQgPSBkcmF3Rm9yTGluZShzVG8ubGluZSwgc2luZ2xlVkxpbmUgPyAwIDogbnVsbCwgc1RvLmNoKS5zdGFydDsKICAgICAgaWYgKHNpbmdsZVZMaW5lKSB7CiAgICAgICAgaWYgKGxlZnRFbmQudG9wIDwgcmlnaHRTdGFydC50b3AgLSAyKSB7CiAgICAgICAgICBhZGQobGVmdEVuZC5yaWdodCwgbGVmdEVuZC50b3AsIG51bGwsIGxlZnRFbmQuYm90dG9tKTsKICAgICAgICAgIGFkZChsZWZ0U2lkZSwgcmlnaHRTdGFydC50b3AsIHJpZ2h0U3RhcnQubGVmdCwgcmlnaHRTdGFydC5ib3R0b20pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBhZGQobGVmdEVuZC5yaWdodCwgbGVmdEVuZC50b3AsIHJpZ2h0U3RhcnQubGVmdCAtIGxlZnRFbmQucmlnaHQsIGxlZnRFbmQuYm90dG9tKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKGxlZnRFbmQuYm90dG9tIDwgcmlnaHRTdGFydC50b3ApCiAgICAgICAgeyBhZGQobGVmdFNpZGUsIGxlZnRFbmQuYm90dG9tLCBudWxsLCByaWdodFN0YXJ0LnRvcCk7IH0KICAgIH0KCiAgICBvdXRwdXQuYXBwZW5kQ2hpbGQoZnJhZ21lbnQpOwogIH0KCiAgLy8gQ3Vyc29yLWJsaW5raW5nCiAgZnVuY3Rpb24gcmVzdGFydEJsaW5rKGNtKSB7CiAgICBpZiAoIWNtLnN0YXRlLmZvY3VzZWQpIHsgcmV0dXJuIH0KICAgIHZhciBkaXNwbGF5ID0gY20uZGlzcGxheTsKICAgIGNsZWFySW50ZXJ2YWwoZGlzcGxheS5ibGlua2VyKTsKICAgIHZhciBvbiA9IHRydWU7CiAgICBkaXNwbGF5LmN1cnNvckRpdi5zdHlsZS52aXNpYmlsaXR5ID0gIiI7CiAgICBpZiAoY20ub3B0aW9ucy5jdXJzb3JCbGlua1JhdGUgPiAwKQogICAgICB7IGRpc3BsYXkuYmxpbmtlciA9IHNldEludGVydmFsKGZ1bmN0aW9uICgpIHsgcmV0dXJuIGRpc3BsYXkuY3Vyc29yRGl2LnN0eWxlLnZpc2liaWxpdHkgPSAob24gPSAhb24pID8gIiIgOiAiaGlkZGVuIjsgfSwKICAgICAgICBjbS5vcHRpb25zLmN1cnNvckJsaW5rUmF0ZSk7IH0KICAgIGVsc2UgaWYgKGNtLm9wdGlvbnMuY3Vyc29yQmxpbmtSYXRlIDwgMCkKICAgICAgeyBkaXNwbGF5LmN1cnNvckRpdi5zdHlsZS52aXNpYmlsaXR5ID0gImhpZGRlbiI7IH0KICB9CgogIGZ1bmN0aW9uIGVuc3VyZUZvY3VzKGNtKSB7CiAgICBpZiAoIWNtLnN0YXRlLmZvY3VzZWQpIHsgY20uZGlzcGxheS5pbnB1dC5mb2N1cygpOyBvbkZvY3VzKGNtKTsgfQogIH0KCiAgZnVuY3Rpb24gZGVsYXlCbHVyRXZlbnQoY20pIHsKICAgIGNtLnN0YXRlLmRlbGF5aW5nQmx1ckV2ZW50ID0gdHJ1ZTsKICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgeyBpZiAoY20uc3RhdGUuZGVsYXlpbmdCbHVyRXZlbnQpIHsKICAgICAgY20uc3RhdGUuZGVsYXlpbmdCbHVyRXZlbnQgPSBmYWxzZTsKICAgICAgb25CbHVyKGNtKTsKICAgIH0gfSwgMTAwKTsKICB9CgogIGZ1bmN0aW9uIG9uRm9jdXMoY20sIGUpIHsKICAgIGlmIChjbS5zdGF0ZS5kZWxheWluZ0JsdXJFdmVudCkgeyBjbS5zdGF0ZS5kZWxheWluZ0JsdXJFdmVudCA9IGZhbHNlOyB9CgogICAgaWYgKGNtLm9wdGlvbnMucmVhZE9ubHkgPT0gIm5vY3Vyc29yIikgeyByZXR1cm4gfQogICAgaWYgKCFjbS5zdGF0ZS5mb2N1c2VkKSB7CiAgICAgIHNpZ25hbChjbSwgImZvY3VzIiwgY20sIGUpOwogICAgICBjbS5zdGF0ZS5mb2N1c2VkID0gdHJ1ZTsKICAgICAgYWRkQ2xhc3MoY20uZGlzcGxheS53cmFwcGVyLCAiQ29kZU1pcnJvci1mb2N1c2VkIik7CiAgICAgIC8vIFRoaXMgdGVzdCBwcmV2ZW50cyB0aGlzIGZyb20gZmlyaW5nIHdoZW4gYSBjb250ZXh0CiAgICAgIC8vIG1lbnUgaXMgY2xvc2VkIChzaW5jZSB0aGUgaW5wdXQgcmVzZXQgd291bGQga2lsbCB0aGUKICAgICAgLy8gc2VsZWN0LWFsbCBkZXRlY3Rpb24gaGFjaykKICAgICAgaWYgKCFjbS5jdXJPcCAmJiBjbS5kaXNwbGF5LnNlbEZvckNvbnRleHRNZW51ICE9IGNtLmRvYy5zZWwpIHsKICAgICAgICBjbS5kaXNwbGF5LmlucHV0LnJlc2V0KCk7CiAgICAgICAgaWYgKHdlYmtpdCkgeyBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsgcmV0dXJuIGNtLmRpc3BsYXkuaW5wdXQucmVzZXQodHJ1ZSk7IH0sIDIwKTsgfSAvLyBJc3N1ZSAjMTczMAogICAgICB9CiAgICAgIGNtLmRpc3BsYXkuaW5wdXQucmVjZWl2ZWRGb2N1cygpOwogICAgfQogICAgcmVzdGFydEJsaW5rKGNtKTsKICB9CiAgZnVuY3Rpb24gb25CbHVyKGNtLCBlKSB7CiAgICBpZiAoY20uc3RhdGUuZGVsYXlpbmdCbHVyRXZlbnQpIHsgcmV0dXJuIH0KCiAgICBpZiAoY20uc3RhdGUuZm9jdXNlZCkgewogICAgICBzaWduYWwoY20sICJibHVyIiwgY20sIGUpOwogICAgICBjbS5zdGF0ZS5mb2N1c2VkID0gZmFsc2U7CiAgICAgIHJtQ2xhc3MoY20uZGlzcGxheS53cmFwcGVyLCAiQ29kZU1pcnJvci1mb2N1c2VkIik7CiAgICB9CiAgICBjbGVhckludGVydmFsKGNtLmRpc3BsYXkuYmxpbmtlcik7CiAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsgaWYgKCFjbS5zdGF0ZS5mb2N1c2VkKSB7IGNtLmRpc3BsYXkuc2hpZnQgPSBmYWxzZTsgfSB9LCAxNTApOwogIH0KCiAgLy8gUmVhZCB0aGUgYWN0dWFsIGhlaWdodHMgb2YgdGhlIHJlbmRlcmVkIGxpbmVzLCBhbmQgdXBkYXRlIHRoZWlyCiAgLy8gc3RvcmVkIGhlaWdodHMgdG8gbWF0Y2guCiAgZnVuY3Rpb24gdXBkYXRlSGVpZ2h0c0luVmlld3BvcnQoY20pIHsKICAgIHZhciBkaXNwbGF5ID0gY20uZGlzcGxheTsKICAgIHZhciBwcmV2Qm90dG9tID0gZGlzcGxheS5saW5lRGl2Lm9mZnNldFRvcDsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZGlzcGxheS52aWV3Lmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBjdXIgPSBkaXNwbGF5LnZpZXdbaV0sIHdyYXBwaW5nID0gY20ub3B0aW9ucy5saW5lV3JhcHBpbmc7CiAgICAgIHZhciBoZWlnaHQgPSAodm9pZCAwKSwgd2lkdGggPSAwOwogICAgICBpZiAoY3VyLmhpZGRlbikgeyBjb250aW51ZSB9CiAgICAgIGlmIChpZSAmJiBpZV92ZXJzaW9uIDwgOCkgewogICAgICAgIHZhciBib3QgPSBjdXIubm9kZS5vZmZzZXRUb3AgKyBjdXIubm9kZS5vZmZzZXRIZWlnaHQ7CiAgICAgICAgaGVpZ2h0ID0gYm90IC0gcHJldkJvdHRvbTsKICAgICAgICBwcmV2Qm90dG9tID0gYm90OwogICAgICB9IGVsc2UgewogICAgICAgIHZhciBib3ggPSBjdXIubm9kZS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgICAgICBoZWlnaHQgPSBib3guYm90dG9tIC0gYm94LnRvcDsKICAgICAgICAvLyBDaGVjayB0aGF0IGxpbmVzIGRvbid0IGV4dGVuZCBwYXN0IHRoZSByaWdodCBvZiB0aGUgY3VycmVudAogICAgICAgIC8vIGVkaXRvciB3aWR0aAogICAgICAgIGlmICghd3JhcHBpbmcgJiYgY3VyLnRleHQuZmlyc3RDaGlsZCkKICAgICAgICAgIHsgd2lkdGggPSBjdXIudGV4dC5maXJzdENoaWxkLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLnJpZ2h0IC0gYm94LmxlZnQgLSAxOyB9CiAgICAgIH0KICAgICAgdmFyIGRpZmYgPSBjdXIubGluZS5oZWlnaHQgLSBoZWlnaHQ7CiAgICAgIGlmIChkaWZmID4gLjAwNSB8fCBkaWZmIDwgLS4wMDUpIHsKICAgICAgICB1cGRhdGVMaW5lSGVpZ2h0KGN1ci5saW5lLCBoZWlnaHQpOwogICAgICAgIHVwZGF0ZVdpZGdldEhlaWdodChjdXIubGluZSk7CiAgICAgICAgaWYgKGN1ci5yZXN0KSB7IGZvciAodmFyIGogPSAwOyBqIDwgY3VyLnJlc3QubGVuZ3RoOyBqKyspCiAgICAgICAgICB7IHVwZGF0ZVdpZGdldEhlaWdodChjdXIucmVzdFtqXSk7IH0gfQogICAgICB9CiAgICAgIGlmICh3aWR0aCA+IGNtLmRpc3BsYXkuc2l6ZXJXaWR0aCkgewogICAgICAgIHZhciBjaFdpZHRoID0gTWF0aC5jZWlsKHdpZHRoIC8gY2hhcldpZHRoKGNtLmRpc3BsYXkpKTsKICAgICAgICBpZiAoY2hXaWR0aCA+IGNtLmRpc3BsYXkubWF4TGluZUxlbmd0aCkgewogICAgICAgICAgY20uZGlzcGxheS5tYXhMaW5lTGVuZ3RoID0gY2hXaWR0aDsKICAgICAgICAgIGNtLmRpc3BsYXkubWF4TGluZSA9IGN1ci5saW5lOwogICAgICAgICAgY20uZGlzcGxheS5tYXhMaW5lQ2hhbmdlZCA9IHRydWU7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQoKICAvLyBSZWFkIGFuZCBzdG9yZSB0aGUgaGVpZ2h0IG9mIGxpbmUgd2lkZ2V0cyBhc3NvY2lhdGVkIHdpdGggdGhlCiAgLy8gZ2l2ZW4gbGluZS4KICBmdW5jdGlvbiB1cGRhdGVXaWRnZXRIZWlnaHQobGluZSkgewogICAgaWYgKGxpbmUud2lkZ2V0cykgeyBmb3IgKHZhciBpID0gMDsgaSA8IGxpbmUud2lkZ2V0cy5sZW5ndGg7ICsraSkgewogICAgICB2YXIgdyA9IGxpbmUud2lkZ2V0c1tpXSwgcGFyZW50ID0gdy5ub2RlLnBhcmVudE5vZGU7CiAgICAgIGlmIChwYXJlbnQpIHsgdy5oZWlnaHQgPSBwYXJlbnQub2Zmc2V0SGVpZ2h0OyB9CiAgICB9IH0KICB9CgogIC8vIENvbXB1dGUgdGhlIGxpbmVzIHRoYXQgYXJlIHZpc2libGUgaW4gYSBnaXZlbiB2aWV3cG9ydCAoZGVmYXVsdHMKICAvLyB0aGUgdGhlIGN1cnJlbnQgc2Nyb2xsIHBvc2l0aW9uKS4gdmlld3BvcnQgbWF5IGNvbnRhaW4gdG9wLAogIC8vIGhlaWdodCwgYW5kIGVuc3VyZSAoc2VlIG9wLnNjcm9sbFRvUG9zKSBwcm9wZXJ0aWVzLgogIGZ1bmN0aW9uIHZpc2libGVMaW5lcyhkaXNwbGF5LCBkb2MsIHZpZXdwb3J0KSB7CiAgICB2YXIgdG9wID0gdmlld3BvcnQgJiYgdmlld3BvcnQudG9wICE9IG51bGwgPyBNYXRoLm1heCgwLCB2aWV3cG9ydC50b3ApIDogZGlzcGxheS5zY3JvbGxlci5zY3JvbGxUb3A7CiAgICB0b3AgPSBNYXRoLmZsb29yKHRvcCAtIHBhZGRpbmdUb3AoZGlzcGxheSkpOwogICAgdmFyIGJvdHRvbSA9IHZpZXdwb3J0ICYmIHZpZXdwb3J0LmJvdHRvbSAhPSBudWxsID8gdmlld3BvcnQuYm90dG9tIDogdG9wICsgZGlzcGxheS53cmFwcGVyLmNsaWVudEhlaWdodDsKCiAgICB2YXIgZnJvbSA9IGxpbmVBdEhlaWdodChkb2MsIHRvcCksIHRvID0gbGluZUF0SGVpZ2h0KGRvYywgYm90dG9tKTsKICAgIC8vIEVuc3VyZSBpcyBhIHtmcm9tOiB7bGluZSwgY2h9LCB0bzoge2xpbmUsIGNofX0gb2JqZWN0LCBhbmQKICAgIC8vIGZvcmNlcyB0aG9zZSBsaW5lcyBpbnRvIHRoZSB2aWV3cG9ydCAoaWYgcG9zc2libGUpLgogICAgaWYgKHZpZXdwb3J0ICYmIHZpZXdwb3J0LmVuc3VyZSkgewogICAgICB2YXIgZW5zdXJlRnJvbSA9IHZpZXdwb3J0LmVuc3VyZS5mcm9tLmxpbmUsIGVuc3VyZVRvID0gdmlld3BvcnQuZW5zdXJlLnRvLmxpbmU7CiAgICAgIGlmIChlbnN1cmVGcm9tIDwgZnJvbSkgewogICAgICAgIGZyb20gPSBlbnN1cmVGcm9tOwogICAgICAgIHRvID0gbGluZUF0SGVpZ2h0KGRvYywgaGVpZ2h0QXRMaW5lKGdldExpbmUoZG9jLCBlbnN1cmVGcm9tKSkgKyBkaXNwbGF5LndyYXBwZXIuY2xpZW50SGVpZ2h0KTsKICAgICAgfSBlbHNlIGlmIChNYXRoLm1pbihlbnN1cmVUbywgZG9jLmxhc3RMaW5lKCkpID49IHRvKSB7CiAgICAgICAgZnJvbSA9IGxpbmVBdEhlaWdodChkb2MsIGhlaWdodEF0TGluZShnZXRMaW5lKGRvYywgZW5zdXJlVG8pKSAtIGRpc3BsYXkud3JhcHBlci5jbGllbnRIZWlnaHQpOwogICAgICAgIHRvID0gZW5zdXJlVG87CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB7ZnJvbTogZnJvbSwgdG86IE1hdGgubWF4KHRvLCBmcm9tICsgMSl9CiAgfQoKICAvLyBTQ1JPTExJTkcgVEhJTkdTIElOVE8gVklFVwoKICAvLyBJZiBhbiBlZGl0b3Igc2l0cyBvbiB0aGUgdG9wIG9yIGJvdHRvbSBvZiB0aGUgd2luZG93LCBwYXJ0aWFsbHkKICAvLyBzY3JvbGxlZCBvdXQgb2YgdmlldywgdGhpcyBlbnN1cmVzIHRoYXQgdGhlIGN1cnNvciBpcyB2aXNpYmxlLgogIGZ1bmN0aW9uIG1heWJlU2Nyb2xsV2luZG93KGNtLCByZWN0KSB7CiAgICBpZiAoc2lnbmFsRE9NRXZlbnQoY20sICJzY3JvbGxDdXJzb3JJbnRvVmlldyIpKSB7IHJldHVybiB9CgogICAgdmFyIGRpc3BsYXkgPSBjbS5kaXNwbGF5LCBib3ggPSBkaXNwbGF5LnNpemVyLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLCBkb1Njcm9sbCA9IG51bGw7CiAgICBpZiAocmVjdC50b3AgKyBib3gudG9wIDwgMCkgeyBkb1Njcm9sbCA9IHRydWU7IH0KICAgIGVsc2UgaWYgKHJlY3QuYm90dG9tICsgYm94LnRvcCA+ICh3aW5kb3cuaW5uZXJIZWlnaHQgfHwgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsaWVudEhlaWdodCkpIHsgZG9TY3JvbGwgPSBmYWxzZTsgfQogICAgaWYgKGRvU2Nyb2xsICE9IG51bGwgJiYgIXBoYW50b20pIHsKICAgICAgdmFyIHNjcm9sbE5vZGUgPSBlbHQoImRpdiIsICJcdTIwMGIiLCBudWxsLCAoInBvc2l0aW9uOiBhYnNvbHV0ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICB0b3A6ICIgKyAocmVjdC50b3AgLSBkaXNwbGF5LnZpZXdPZmZzZXQgLSBwYWRkaW5nVG9wKGNtLmRpc3BsYXkpKSArICJweDtcbiAgICAgICAgICAgICAgICAgICAgICAgICBoZWlnaHQ6ICIgKyAocmVjdC5ib3R0b20gLSByZWN0LnRvcCArIHNjcm9sbEdhcChjbSkgKyBkaXNwbGF5LmJhckhlaWdodCkgKyAicHg7XG4gICAgICAgICAgICAgICAgICAgICAgICAgbGVmdDogIiArIChyZWN0LmxlZnQpICsgInB4OyB3aWR0aDogIiArIChNYXRoLm1heCgyLCByZWN0LnJpZ2h0IC0gcmVjdC5sZWZ0KSkgKyAicHg7IikpOwogICAgICBjbS5kaXNwbGF5LmxpbmVTcGFjZS5hcHBlbmRDaGlsZChzY3JvbGxOb2RlKTsKICAgICAgc2Nyb2xsTm9kZS5zY3JvbGxJbnRvVmlldyhkb1Njcm9sbCk7CiAgICAgIGNtLmRpc3BsYXkubGluZVNwYWNlLnJlbW92ZUNoaWxkKHNjcm9sbE5vZGUpOwogICAgfQogIH0KCiAgLy8gU2Nyb2xsIGEgZ2l2ZW4gcG9zaXRpb24gaW50byB2aWV3IChpbW1lZGlhdGVseSksIHZlcmlmeWluZyB0aGF0CiAgLy8gaXQgYWN0dWFsbHkgYmVjYW1lIHZpc2libGUgKGFzIGxpbmUgaGVpZ2h0cyBhcmUgYWNjdXJhdGVseQogIC8vIG1lYXN1cmVkLCB0aGUgcG9zaXRpb24gb2Ygc29tZXRoaW5nIG1heSAnZHJpZnQnIGR1cmluZyBkcmF3aW5nKS4KICBmdW5jdGlvbiBzY3JvbGxQb3NJbnRvVmlldyhjbSwgcG9zLCBlbmQsIG1hcmdpbikgewogICAgaWYgKG1hcmdpbiA9PSBudWxsKSB7IG1hcmdpbiA9IDA7IH0KICAgIHZhciByZWN0OwogICAgaWYgKCFjbS5vcHRpb25zLmxpbmVXcmFwcGluZyAmJiBwb3MgPT0gZW5kKSB7CiAgICAgIC8vIFNldCBwb3MgYW5kIGVuZCB0byB0aGUgY3Vyc29yIHBvc2l0aW9ucyBhcm91bmQgdGhlIGNoYXJhY3RlciBwb3Mgc3RpY2tzIHRvCiAgICAgIC8vIElmIHBvcy5zdGlja3kgPT0gImJlZm9yZSIsIHRoYXQgaXMgYXJvdW5kIHBvcy5jaCAtIDEsIG90aGVyd2lzZSBhcm91bmQgcG9zLmNoCiAgICAgIC8vIElmIHBvcyA9PSBQb3MoXywgMCwgImJlZm9yZSIpLCBwb3MgYW5kIGVuZCBhcmUgdW5jaGFuZ2VkCiAgICAgIHBvcyA9IHBvcy5jaCA/IFBvcyhwb3MubGluZSwgcG9zLnN0aWNreSA9PSAiYmVmb3JlIiA/IHBvcy5jaCAtIDEgOiBwb3MuY2gsICJhZnRlciIpIDogcG9zOwogICAgICBlbmQgPSBwb3Muc3RpY2t5ID09ICJiZWZvcmUiID8gUG9zKHBvcy5saW5lLCBwb3MuY2ggKyAxLCAiYmVmb3JlIikgOiBwb3M7CiAgICB9CiAgICBmb3IgKHZhciBsaW1pdCA9IDA7IGxpbWl0IDwgNTsgbGltaXQrKykgewogICAgICB2YXIgY2hhbmdlZCA9IGZhbHNlOwogICAgICB2YXIgY29vcmRzID0gY3Vyc29yQ29vcmRzKGNtLCBwb3MpOwogICAgICB2YXIgZW5kQ29vcmRzID0gIWVuZCB8fCBlbmQgPT0gcG9zID8gY29vcmRzIDogY3Vyc29yQ29vcmRzKGNtLCBlbmQpOwogICAgICByZWN0ID0ge2xlZnQ6IE1hdGgubWluKGNvb3Jkcy5sZWZ0LCBlbmRDb29yZHMubGVmdCksCiAgICAgICAgICAgICAgdG9wOiBNYXRoLm1pbihjb29yZHMudG9wLCBlbmRDb29yZHMudG9wKSAtIG1hcmdpbiwKICAgICAgICAgICAgICByaWdodDogTWF0aC5tYXgoY29vcmRzLmxlZnQsIGVuZENvb3Jkcy5sZWZ0KSwKICAgICAgICAgICAgICBib3R0b206IE1hdGgubWF4KGNvb3Jkcy5ib3R0b20sIGVuZENvb3Jkcy5ib3R0b20pICsgbWFyZ2lufTsKICAgICAgdmFyIHNjcm9sbFBvcyA9IGNhbGN1bGF0ZVNjcm9sbFBvcyhjbSwgcmVjdCk7CiAgICAgIHZhciBzdGFydFRvcCA9IGNtLmRvYy5zY3JvbGxUb3AsIHN0YXJ0TGVmdCA9IGNtLmRvYy5zY3JvbGxMZWZ0OwogICAgICBpZiAoc2Nyb2xsUG9zLnNjcm9sbFRvcCAhPSBudWxsKSB7CiAgICAgICAgdXBkYXRlU2Nyb2xsVG9wKGNtLCBzY3JvbGxQb3Muc2Nyb2xsVG9wKTsKICAgICAgICBpZiAoTWF0aC5hYnMoY20uZG9jLnNjcm9sbFRvcCAtIHN0YXJ0VG9wKSA+IDEpIHsgY2hhbmdlZCA9IHRydWU7IH0KICAgICAgfQogICAgICBpZiAoc2Nyb2xsUG9zLnNjcm9sbExlZnQgIT0gbnVsbCkgewogICAgICAgIHNldFNjcm9sbExlZnQoY20sIHNjcm9sbFBvcy5zY3JvbGxMZWZ0KTsKICAgICAgICBpZiAoTWF0aC5hYnMoY20uZG9jLnNjcm9sbExlZnQgLSBzdGFydExlZnQpID4gMSkgeyBjaGFuZ2VkID0gdHJ1ZTsgfQogICAgICB9CiAgICAgIGlmICghY2hhbmdlZCkgeyBicmVhayB9CiAgICB9CiAgICByZXR1cm4gcmVjdAogIH0KCiAgLy8gU2Nyb2xsIGEgZ2l2ZW4gc2V0IG9mIGNvb3JkaW5hdGVzIGludG8gdmlldyAoaW1tZWRpYXRlbHkpLgogIGZ1bmN0aW9uIHNjcm9sbEludG9WaWV3KGNtLCByZWN0KSB7CiAgICB2YXIgc2Nyb2xsUG9zID0gY2FsY3VsYXRlU2Nyb2xsUG9zKGNtLCByZWN0KTsKICAgIGlmIChzY3JvbGxQb3Muc2Nyb2xsVG9wICE9IG51bGwpIHsgdXBkYXRlU2Nyb2xsVG9wKGNtLCBzY3JvbGxQb3Muc2Nyb2xsVG9wKTsgfQogICAgaWYgKHNjcm9sbFBvcy5zY3JvbGxMZWZ0ICE9IG51bGwpIHsgc2V0U2Nyb2xsTGVmdChjbSwgc2Nyb2xsUG9zLnNjcm9sbExlZnQpOyB9CiAgfQoKICAvLyBDYWxjdWxhdGUgYSBuZXcgc2Nyb2xsIHBvc2l0aW9uIG5lZWRlZCB0byBzY3JvbGwgdGhlIGdpdmVuCiAgLy8gcmVjdGFuZ2xlIGludG8gdmlldy4gUmV0dXJucyBhbiBvYmplY3Qgd2l0aCBzY3JvbGxUb3AgYW5kCiAgLy8gc2Nyb2xsTGVmdCBwcm9wZXJ0aWVzLiBXaGVuIHRoZXNlIGFyZSB1bmRlZmluZWQsIHRoZQogIC8vIHZlcnRpY2FsL2hvcml6b250YWwgcG9zaXRpb24gZG9lcyBub3QgbmVlZCB0byBiZSBhZGp1c3RlZC4KICBmdW5jdGlvbiBjYWxjdWxhdGVTY3JvbGxQb3MoY20sIHJlY3QpIHsKICAgIHZhciBkaXNwbGF5ID0gY20uZGlzcGxheSwgc25hcE1hcmdpbiA9IHRleHRIZWlnaHQoY20uZGlzcGxheSk7CiAgICBpZiAocmVjdC50b3AgPCAwKSB7IHJlY3QudG9wID0gMDsgfQogICAgdmFyIHNjcmVlbnRvcCA9IGNtLmN1ck9wICYmIGNtLmN1ck9wLnNjcm9sbFRvcCAhPSBudWxsID8gY20uY3VyT3Auc2Nyb2xsVG9wIDogZGlzcGxheS5zY3JvbGxlci5zY3JvbGxUb3A7CiAgICB2YXIgc2NyZWVuID0gZGlzcGxheUhlaWdodChjbSksIHJlc3VsdCA9IHt9OwogICAgaWYgKHJlY3QuYm90dG9tIC0gcmVjdC50b3AgPiBzY3JlZW4pIHsgcmVjdC5ib3R0b20gPSByZWN0LnRvcCArIHNjcmVlbjsgfQogICAgdmFyIGRvY0JvdHRvbSA9IGNtLmRvYy5oZWlnaHQgKyBwYWRkaW5nVmVydChkaXNwbGF5KTsKICAgIHZhciBhdFRvcCA9IHJlY3QudG9wIDwgc25hcE1hcmdpbiwgYXRCb3R0b20gPSByZWN0LmJvdHRvbSA+IGRvY0JvdHRvbSAtIHNuYXBNYXJnaW47CiAgICBpZiAocmVjdC50b3AgPCBzY3JlZW50b3ApIHsKICAgICAgcmVzdWx0LnNjcm9sbFRvcCA9IGF0VG9wID8gMCA6IHJlY3QudG9wOwogICAgfSBlbHNlIGlmIChyZWN0LmJvdHRvbSA+IHNjcmVlbnRvcCArIHNjcmVlbikgewogICAgICB2YXIgbmV3VG9wID0gTWF0aC5taW4ocmVjdC50b3AsIChhdEJvdHRvbSA/IGRvY0JvdHRvbSA6IHJlY3QuYm90dG9tKSAtIHNjcmVlbik7CiAgICAgIGlmIChuZXdUb3AgIT0gc2NyZWVudG9wKSB7IHJlc3VsdC5zY3JvbGxUb3AgPSBuZXdUb3A7IH0KICAgIH0KCiAgICB2YXIgc2NyZWVubGVmdCA9IGNtLmN1ck9wICYmIGNtLmN1ck9wLnNjcm9sbExlZnQgIT0gbnVsbCA/IGNtLmN1ck9wLnNjcm9sbExlZnQgOiBkaXNwbGF5LnNjcm9sbGVyLnNjcm9sbExlZnQ7CiAgICB2YXIgc2NyZWVudyA9IGRpc3BsYXlXaWR0aChjbSkgLSAoY20ub3B0aW9ucy5maXhlZEd1dHRlciA/IGRpc3BsYXkuZ3V0dGVycy5vZmZzZXRXaWR0aCA6IDApOwogICAgdmFyIHRvb1dpZGUgPSByZWN0LnJpZ2h0IC0gcmVjdC5sZWZ0ID4gc2NyZWVudzsKICAgIGlmICh0b29XaWRlKSB7IHJlY3QucmlnaHQgPSByZWN0LmxlZnQgKyBzY3JlZW53OyB9CiAgICBpZiAocmVjdC5sZWZ0IDwgMTApCiAgICAgIHsgcmVzdWx0LnNjcm9sbExlZnQgPSAwOyB9CiAgICBlbHNlIGlmIChyZWN0LmxlZnQgPCBzY3JlZW5sZWZ0KQogICAgICB7IHJlc3VsdC5zY3JvbGxMZWZ0ID0gTWF0aC5tYXgoMCwgcmVjdC5sZWZ0IC0gKHRvb1dpZGUgPyAwIDogMTApKTsgfQogICAgZWxzZSBpZiAocmVjdC5yaWdodCA+IHNjcmVlbncgKyBzY3JlZW5sZWZ0IC0gMykKICAgICAgeyByZXN1bHQuc2Nyb2xsTGVmdCA9IHJlY3QucmlnaHQgKyAodG9vV2lkZSA/IDAgOiAxMCkgLSBzY3JlZW53OyB9CiAgICByZXR1cm4gcmVzdWx0CiAgfQoKICAvLyBTdG9yZSBhIHJlbGF0aXZlIGFkanVzdG1lbnQgdG8gdGhlIHNjcm9sbCBwb3NpdGlvbiBpbiB0aGUgY3VycmVudAogIC8vIG9wZXJhdGlvbiAodG8gYmUgYXBwbGllZCB3aGVuIHRoZSBvcGVyYXRpb24gZmluaXNoZXMpLgogIGZ1bmN0aW9uIGFkZFRvU2Nyb2xsVG9wKGNtLCB0b3ApIHsKICAgIGlmICh0b3AgPT0gbnVsbCkgeyByZXR1cm4gfQogICAgcmVzb2x2ZVNjcm9sbFRvUG9zKGNtKTsKICAgIGNtLmN1ck9wLnNjcm9sbFRvcCA9IChjbS5jdXJPcC5zY3JvbGxUb3AgPT0gbnVsbCA/IGNtLmRvYy5zY3JvbGxUb3AgOiBjbS5jdXJPcC5zY3JvbGxUb3ApICsgdG9wOwogIH0KCiAgLy8gTWFrZSBzdXJlIHRoYXQgYXQgdGhlIGVuZCBvZiB0aGUgb3BlcmF0aW9uIHRoZSBjdXJyZW50IGN1cnNvciBpcwogIC8vIHNob3duLgogIGZ1bmN0aW9uIGVuc3VyZUN1cnNvclZpc2libGUoY20pIHsKICAgIHJlc29sdmVTY3JvbGxUb1BvcyhjbSk7CiAgICB2YXIgY3VyID0gY20uZ2V0Q3Vyc29yKCk7CiAgICBjbS5jdXJPcC5zY3JvbGxUb1BvcyA9IHtmcm9tOiBjdXIsIHRvOiBjdXIsIG1hcmdpbjogY20ub3B0aW9ucy5jdXJzb3JTY3JvbGxNYXJnaW59OwogIH0KCiAgZnVuY3Rpb24gc2Nyb2xsVG9Db29yZHMoY20sIHgsIHkpIHsKICAgIGlmICh4ICE9IG51bGwgfHwgeSAhPSBudWxsKSB7IHJlc29sdmVTY3JvbGxUb1BvcyhjbSk7IH0KICAgIGlmICh4ICE9IG51bGwpIHsgY20uY3VyT3Auc2Nyb2xsTGVmdCA9IHg7IH0KICAgIGlmICh5ICE9IG51bGwpIHsgY20uY3VyT3Auc2Nyb2xsVG9wID0geTsgfQogIH0KCiAgZnVuY3Rpb24gc2Nyb2xsVG9SYW5nZShjbSwgcmFuZ2UkJDEpIHsKICAgIHJlc29sdmVTY3JvbGxUb1BvcyhjbSk7CiAgICBjbS5jdXJPcC5zY3JvbGxUb1BvcyA9IHJhbmdlJCQxOwogIH0KCiAgLy8gV2hlbiBhbiBvcGVyYXRpb24gaGFzIGl0cyBzY3JvbGxUb1BvcyBwcm9wZXJ0eSBzZXQsIGFuZCBhbm90aGVyCiAgLy8gc2Nyb2xsIGFjdGlvbiBpcyBhcHBsaWVkIGJlZm9yZSB0aGUgZW5kIG9mIHRoZSBvcGVyYXRpb24sIHRoaXMKICAvLyAnc2ltdWxhdGVzJyBzY3JvbGxpbmcgdGhhdCBwb3NpdGlvbiBpbnRvIHZpZXcgaW4gYSBjaGVhcCB3YXksIHNvCiAgLy8gdGhhdCB0aGUgZWZmZWN0IG9mIGludGVybWVkaWF0ZSBzY3JvbGwgY29tbWFuZHMgaXMgbm90IGlnbm9yZWQuCiAgZnVuY3Rpb24gcmVzb2x2ZVNjcm9sbFRvUG9zKGNtKSB7CiAgICB2YXIgcmFuZ2UkJDEgPSBjbS5jdXJPcC5zY3JvbGxUb1BvczsKICAgIGlmIChyYW5nZSQkMSkgewogICAgICBjbS5jdXJPcC5zY3JvbGxUb1BvcyA9IG51bGw7CiAgICAgIHZhciBmcm9tID0gZXN0aW1hdGVDb29yZHMoY20sIHJhbmdlJCQxLmZyb20pLCB0byA9IGVzdGltYXRlQ29vcmRzKGNtLCByYW5nZSQkMS50byk7CiAgICAgIHNjcm9sbFRvQ29vcmRzUmFuZ2UoY20sIGZyb20sIHRvLCByYW5nZSQkMS5tYXJnaW4pOwogICAgfQogIH0KCiAgZnVuY3Rpb24gc2Nyb2xsVG9Db29yZHNSYW5nZShjbSwgZnJvbSwgdG8sIG1hcmdpbikgewogICAgdmFyIHNQb3MgPSBjYWxjdWxhdGVTY3JvbGxQb3MoY20sIHsKICAgICAgbGVmdDogTWF0aC5taW4oZnJvbS5sZWZ0LCB0by5sZWZ0KSwKICAgICAgdG9wOiBNYXRoLm1pbihmcm9tLnRvcCwgdG8udG9wKSAtIG1hcmdpbiwKICAgICAgcmlnaHQ6IE1hdGgubWF4KGZyb20ucmlnaHQsIHRvLnJpZ2h0KSwKICAgICAgYm90dG9tOiBNYXRoLm1heChmcm9tLmJvdHRvbSwgdG8uYm90dG9tKSArIG1hcmdpbgogICAgfSk7CiAgICBzY3JvbGxUb0Nvb3JkcyhjbSwgc1Bvcy5zY3JvbGxMZWZ0LCBzUG9zLnNjcm9sbFRvcCk7CiAgfQoKICAvLyBTeW5jIHRoZSBzY3JvbGxhYmxlIGFyZWEgYW5kIHNjcm9sbGJhcnMsIGVuc3VyZSB0aGUgdmlld3BvcnQKICAvLyBjb3ZlcnMgdGhlIHZpc2libGUgYXJlYS4KICBmdW5jdGlvbiB1cGRhdGVTY3JvbGxUb3AoY20sIHZhbCkgewogICAgaWYgKE1hdGguYWJzKGNtLmRvYy5zY3JvbGxUb3AgLSB2YWwpIDwgMikgeyByZXR1cm4gfQogICAgaWYgKCFnZWNrbykgeyB1cGRhdGVEaXNwbGF5U2ltcGxlKGNtLCB7dG9wOiB2YWx9KTsgfQogICAgc2V0U2Nyb2xsVG9wKGNtLCB2YWwsIHRydWUpOwogICAgaWYgKGdlY2tvKSB7IHVwZGF0ZURpc3BsYXlTaW1wbGUoY20pOyB9CiAgICBzdGFydFdvcmtlcihjbSwgMTAwKTsKICB9CgogIGZ1bmN0aW9uIHNldFNjcm9sbFRvcChjbSwgdmFsLCBmb3JjZVNjcm9sbCkgewogICAgdmFsID0gTWF0aC5taW4oY20uZGlzcGxheS5zY3JvbGxlci5zY3JvbGxIZWlnaHQgLSBjbS5kaXNwbGF5LnNjcm9sbGVyLmNsaWVudEhlaWdodCwgdmFsKTsKICAgIGlmIChjbS5kaXNwbGF5LnNjcm9sbGVyLnNjcm9sbFRvcCA9PSB2YWwgJiYgIWZvcmNlU2Nyb2xsKSB7IHJldHVybiB9CiAgICBjbS5kb2Muc2Nyb2xsVG9wID0gdmFsOwogICAgY20uZGlzcGxheS5zY3JvbGxiYXJzLnNldFNjcm9sbFRvcCh2YWwpOwogICAgaWYgKGNtLmRpc3BsYXkuc2Nyb2xsZXIuc2Nyb2xsVG9wICE9IHZhbCkgeyBjbS5kaXNwbGF5LnNjcm9sbGVyLnNjcm9sbFRvcCA9IHZhbDsgfQogIH0KCiAgLy8gU3luYyBzY3JvbGxlciBhbmQgc2Nyb2xsYmFyLCBlbnN1cmUgdGhlIGd1dHRlciBlbGVtZW50cyBhcmUKICAvLyBhbGlnbmVkLgogIGZ1bmN0aW9uIHNldFNjcm9sbExlZnQoY20sIHZhbCwgaXNTY3JvbGxlciwgZm9yY2VTY3JvbGwpIHsKICAgIHZhbCA9IE1hdGgubWluKHZhbCwgY20uZGlzcGxheS5zY3JvbGxlci5zY3JvbGxXaWR0aCAtIGNtLmRpc3BsYXkuc2Nyb2xsZXIuY2xpZW50V2lkdGgpOwogICAgaWYgKChpc1Njcm9sbGVyID8gdmFsID09IGNtLmRvYy5zY3JvbGxMZWZ0IDogTWF0aC5hYnMoY20uZG9jLnNjcm9sbExlZnQgLSB2YWwpIDwgMikgJiYgIWZvcmNlU2Nyb2xsKSB7IHJldHVybiB9CiAgICBjbS5kb2Muc2Nyb2xsTGVmdCA9IHZhbDsKICAgIGFsaWduSG9yaXpvbnRhbGx5KGNtKTsKICAgIGlmIChjbS5kaXNwbGF5LnNjcm9sbGVyLnNjcm9sbExlZnQgIT0gdmFsKSB7IGNtLmRpc3BsYXkuc2Nyb2xsZXIuc2Nyb2xsTGVmdCA9IHZhbDsgfQogICAgY20uZGlzcGxheS5zY3JvbGxiYXJzLnNldFNjcm9sbExlZnQodmFsKTsKICB9CgogIC8vIFNDUk9MTEJBUlMKCiAgLy8gUHJlcGFyZSBET00gcmVhZHMgbmVlZGVkIHRvIHVwZGF0ZSB0aGUgc2Nyb2xsYmFycy4gRG9uZSBpbiBvbmUKICAvLyBzaG90IHRvIG1pbmltaXplIHVwZGF0ZS9tZWFzdXJlIHJvdW5kdHJpcHMuCiAgZnVuY3Rpb24gbWVhc3VyZUZvclNjcm9sbGJhcnMoY20pIHsKICAgIHZhciBkID0gY20uZGlzcGxheSwgZ3V0dGVyVyA9IGQuZ3V0dGVycy5vZmZzZXRXaWR0aDsKICAgIHZhciBkb2NIID0gTWF0aC5yb3VuZChjbS5kb2MuaGVpZ2h0ICsgcGFkZGluZ1ZlcnQoY20uZGlzcGxheSkpOwogICAgcmV0dXJuIHsKICAgICAgY2xpZW50SGVpZ2h0OiBkLnNjcm9sbGVyLmNsaWVudEhlaWdodCwKICAgICAgdmlld0hlaWdodDogZC53cmFwcGVyLmNsaWVudEhlaWdodCwKICAgICAgc2Nyb2xsV2lkdGg6IGQuc2Nyb2xsZXIuc2Nyb2xsV2lkdGgsIGNsaWVudFdpZHRoOiBkLnNjcm9sbGVyLmNsaWVudFdpZHRoLAogICAgICB2aWV3V2lkdGg6IGQud3JhcHBlci5jbGllbnRXaWR0aCwKICAgICAgYmFyTGVmdDogY20ub3B0aW9ucy5maXhlZEd1dHRlciA/IGd1dHRlclcgOiAwLAogICAgICBkb2NIZWlnaHQ6IGRvY0gsCiAgICAgIHNjcm9sbEhlaWdodDogZG9jSCArIHNjcm9sbEdhcChjbSkgKyBkLmJhckhlaWdodCwKICAgICAgbmF0aXZlQmFyV2lkdGg6IGQubmF0aXZlQmFyV2lkdGgsCiAgICAgIGd1dHRlcldpZHRoOiBndXR0ZXJXCiAgICB9CiAgfQoKICB2YXIgTmF0aXZlU2Nyb2xsYmFycyA9IGZ1bmN0aW9uKHBsYWNlLCBzY3JvbGwsIGNtKSB7CiAgICB0aGlzLmNtID0gY207CiAgICB2YXIgdmVydCA9IHRoaXMudmVydCA9IGVsdCgiZGl2IiwgW2VsdCgiZGl2IiwgbnVsbCwgbnVsbCwgIm1pbi13aWR0aDogMXB4IildLCAiQ29kZU1pcnJvci12c2Nyb2xsYmFyIik7CiAgICB2YXIgaG9yaXogPSB0aGlzLmhvcml6ID0gZWx0KCJkaXYiLCBbZWx0KCJkaXYiLCBudWxsLCBudWxsLCAiaGVpZ2h0OiAxMDAlOyBtaW4taGVpZ2h0OiAxcHgiKV0sICJDb2RlTWlycm9yLWhzY3JvbGxiYXIiKTsKICAgIHZlcnQudGFiSW5kZXggPSBob3Jpei50YWJJbmRleCA9IC0xOwogICAgcGxhY2UodmVydCk7IHBsYWNlKGhvcml6KTsKCiAgICBvbih2ZXJ0LCAic2Nyb2xsIiwgZnVuY3Rpb24gKCkgewogICAgICBpZiAodmVydC5jbGllbnRIZWlnaHQpIHsgc2Nyb2xsKHZlcnQuc2Nyb2xsVG9wLCAidmVydGljYWwiKTsgfQogICAgfSk7CiAgICBvbihob3JpeiwgInNjcm9sbCIsIGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKGhvcml6LmNsaWVudFdpZHRoKSB7IHNjcm9sbChob3Jpei5zY3JvbGxMZWZ0LCAiaG9yaXpvbnRhbCIpOyB9CiAgICB9KTsKCiAgICB0aGlzLmNoZWNrZWRaZXJvV2lkdGggPSBmYWxzZTsKICAgIC8vIE5lZWQgdG8gc2V0IGEgbWluaW11bSB3aWR0aCB0byBzZWUgdGhlIHNjcm9sbGJhciBvbiBJRTcgKGJ1dCBtdXN0IG5vdCBzZXQgaXQgb24gSUU4KS4KICAgIGlmIChpZSAmJiBpZV92ZXJzaW9uIDwgOCkgeyB0aGlzLmhvcml6LnN0eWxlLm1pbkhlaWdodCA9IHRoaXMudmVydC5zdHlsZS5taW5XaWR0aCA9ICIxOHB4IjsgfQogIH07CgogIE5hdGl2ZVNjcm9sbGJhcnMucHJvdG90eXBlLnVwZGF0ZSA9IGZ1bmN0aW9uIChtZWFzdXJlKSB7CiAgICB2YXIgbmVlZHNIID0gbWVhc3VyZS5zY3JvbGxXaWR0aCA+IG1lYXN1cmUuY2xpZW50V2lkdGggKyAxOwogICAgdmFyIG5lZWRzViA9IG1lYXN1cmUuc2Nyb2xsSGVpZ2h0ID4gbWVhc3VyZS5jbGllbnRIZWlnaHQgKyAxOwogICAgdmFyIHNXaWR0aCA9IG1lYXN1cmUubmF0aXZlQmFyV2lkdGg7CgogICAgaWYgKG5lZWRzVikgewogICAgICB0aGlzLnZlcnQuc3R5bGUuZGlzcGxheSA9ICJibG9jayI7CiAgICAgIHRoaXMudmVydC5zdHlsZS5ib3R0b20gPSBuZWVkc0ggPyBzV2lkdGggKyAicHgiIDogIjAiOwogICAgICB2YXIgdG90YWxIZWlnaHQgPSBtZWFzdXJlLnZpZXdIZWlnaHQgLSAobmVlZHNIID8gc1dpZHRoIDogMCk7CiAgICAgIC8vIEEgYnVnIGluIElFOCBjYW4gY2F1c2UgdGhpcyB2YWx1ZSB0byBiZSBuZWdhdGl2ZSwgc28gZ3VhcmQgaXQuCiAgICAgIHRoaXMudmVydC5maXJzdENoaWxkLnN0eWxlLmhlaWdodCA9CiAgICAgICAgTWF0aC5tYXgoMCwgbWVhc3VyZS5zY3JvbGxIZWlnaHQgLSBtZWFzdXJlLmNsaWVudEhlaWdodCArIHRvdGFsSGVpZ2h0KSArICJweCI7CiAgICB9IGVsc2UgewogICAgICB0aGlzLnZlcnQuc3R5bGUuZGlzcGxheSA9ICIiOwogICAgICB0aGlzLnZlcnQuZmlyc3RDaGlsZC5zdHlsZS5oZWlnaHQgPSAiMCI7CiAgICB9CgogICAgaWYgKG5lZWRzSCkgewogICAgICB0aGlzLmhvcml6LnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siOwogICAgICB0aGlzLmhvcml6LnN0eWxlLnJpZ2h0ID0gbmVlZHNWID8gc1dpZHRoICsgInB4IiA6ICIwIjsKICAgICAgdGhpcy5ob3Jpei5zdHlsZS5sZWZ0ID0gbWVhc3VyZS5iYXJMZWZ0ICsgInB4IjsKICAgICAgdmFyIHRvdGFsV2lkdGggPSBtZWFzdXJlLnZpZXdXaWR0aCAtIG1lYXN1cmUuYmFyTGVmdCAtIChuZWVkc1YgPyBzV2lkdGggOiAwKTsKICAgICAgdGhpcy5ob3Jpei5maXJzdENoaWxkLnN0eWxlLndpZHRoID0KICAgICAgICBNYXRoLm1heCgwLCBtZWFzdXJlLnNjcm9sbFdpZHRoIC0gbWVhc3VyZS5jbGllbnRXaWR0aCArIHRvdGFsV2lkdGgpICsgInB4IjsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuaG9yaXouc3R5bGUuZGlzcGxheSA9ICIiOwogICAgICB0aGlzLmhvcml6LmZpcnN0Q2hpbGQuc3R5bGUud2lkdGggPSAiMCI7CiAgICB9CgogICAgaWYgKCF0aGlzLmNoZWNrZWRaZXJvV2lkdGggJiYgbWVhc3VyZS5jbGllbnRIZWlnaHQgPiAwKSB7CiAgICAgIGlmIChzV2lkdGggPT0gMCkgeyB0aGlzLnplcm9XaWR0aEhhY2soKTsgfQogICAgICB0aGlzLmNoZWNrZWRaZXJvV2lkdGggPSB0cnVlOwogICAgfQoKICAgIHJldHVybiB7cmlnaHQ6IG5lZWRzViA/IHNXaWR0aCA6IDAsIGJvdHRvbTogbmVlZHNIID8gc1dpZHRoIDogMH0KICB9OwoKICBOYXRpdmVTY3JvbGxiYXJzLnByb3RvdHlwZS5zZXRTY3JvbGxMZWZ0ID0gZnVuY3Rpb24gKHBvcykgewogICAgaWYgKHRoaXMuaG9yaXouc2Nyb2xsTGVmdCAhPSBwb3MpIHsgdGhpcy5ob3Jpei5zY3JvbGxMZWZ0ID0gcG9zOyB9CiAgICBpZiAodGhpcy5kaXNhYmxlSG9yaXopIHsgdGhpcy5lbmFibGVaZXJvV2lkdGhCYXIodGhpcy5ob3JpeiwgdGhpcy5kaXNhYmxlSG9yaXosICJob3JpeiIpOyB9CiAgfTsKCiAgTmF0aXZlU2Nyb2xsYmFycy5wcm90b3R5cGUuc2V0U2Nyb2xsVG9wID0gZnVuY3Rpb24gKHBvcykgewogICAgaWYgKHRoaXMudmVydC5zY3JvbGxUb3AgIT0gcG9zKSB7IHRoaXMudmVydC5zY3JvbGxUb3AgPSBwb3M7IH0KICAgIGlmICh0aGlzLmRpc2FibGVWZXJ0KSB7IHRoaXMuZW5hYmxlWmVyb1dpZHRoQmFyKHRoaXMudmVydCwgdGhpcy5kaXNhYmxlVmVydCwgInZlcnQiKTsgfQogIH07CgogIE5hdGl2ZVNjcm9sbGJhcnMucHJvdG90eXBlLnplcm9XaWR0aEhhY2sgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgdyA9IG1hYyAmJiAhbWFjX2dlTW91bnRhaW5MaW9uID8gIjEycHgiIDogIjE4cHgiOwogICAgdGhpcy5ob3Jpei5zdHlsZS5oZWlnaHQgPSB0aGlzLnZlcnQuc3R5bGUud2lkdGggPSB3OwogICAgdGhpcy5ob3Jpei5zdHlsZS5wb2ludGVyRXZlbnRzID0gdGhpcy52ZXJ0LnN0eWxlLnBvaW50ZXJFdmVudHMgPSAibm9uZSI7CiAgICB0aGlzLmRpc2FibGVIb3JpeiA9IG5ldyBEZWxheWVkOwogICAgdGhpcy5kaXNhYmxlVmVydCA9IG5ldyBEZWxheWVkOwogIH07CgogIE5hdGl2ZVNjcm9sbGJhcnMucHJvdG90eXBlLmVuYWJsZVplcm9XaWR0aEJhciA9IGZ1bmN0aW9uIChiYXIsIGRlbGF5LCB0eXBlKSB7CiAgICBiYXIuc3R5bGUucG9pbnRlckV2ZW50cyA9ICJhdXRvIjsKICAgIGZ1bmN0aW9uIG1heWJlRGlzYWJsZSgpIHsKICAgICAgLy8gVG8gZmluZCBvdXQgd2hldGhlciB0aGUgc2Nyb2xsYmFyIGlzIHN0aWxsIHZpc2libGUsIHdlCiAgICAgIC8vIGNoZWNrIHdoZXRoZXIgdGhlIGVsZW1lbnQgdW5kZXIgdGhlIHBpeGVsIGluIHRoZSBib3R0b20KICAgICAgLy8gcmlnaHQgY29ybmVyIG9mIHRoZSBzY3JvbGxiYXIgYm94IGlzIHRoZSBzY3JvbGxiYXIgYm94CiAgICAgIC8vIGl0c2VsZiAod2hlbiB0aGUgYmFyIGlzIHN0aWxsIHZpc2libGUpIG9yIGl0cyBmaWxsZXIgY2hpbGQKICAgICAgLy8gKHdoZW4gdGhlIGJhciBpcyBoaWRkZW4pLiBJZiBpdCBpcyBzdGlsbCB2aXNpYmxlLCB3ZSBrZWVwCiAgICAgIC8vIGl0IGVuYWJsZWQsIGlmIGl0J3MgaGlkZGVuLCB3ZSBkaXNhYmxlIHBvaW50ZXIgZXZlbnRzLgogICAgICB2YXIgYm94ID0gYmFyLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgICB2YXIgZWx0JCQxID0gdHlwZSA9PSAidmVydCIgPyBkb2N1bWVudC5lbGVtZW50RnJvbVBvaW50KGJveC5yaWdodCAtIDEsIChib3gudG9wICsgYm94LmJvdHRvbSkgLyAyKQogICAgICAgICAgOiBkb2N1bWVudC5lbGVtZW50RnJvbVBvaW50KChib3gucmlnaHQgKyBib3gubGVmdCkgLyAyLCBib3guYm90dG9tIC0gMSk7CiAgICAgIGlmIChlbHQkJDEgIT0gYmFyKSB7IGJhci5zdHlsZS5wb2ludGVyRXZlbnRzID0gIm5vbmUiOyB9CiAgICAgIGVsc2UgeyBkZWxheS5zZXQoMTAwMCwgbWF5YmVEaXNhYmxlKTsgfQogICAgfQogICAgZGVsYXkuc2V0KDEwMDAsIG1heWJlRGlzYWJsZSk7CiAgfTsKCiAgTmF0aXZlU2Nyb2xsYmFycy5wcm90b3R5cGUuY2xlYXIgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgcGFyZW50ID0gdGhpcy5ob3Jpei5wYXJlbnROb2RlOwogICAgcGFyZW50LnJlbW92ZUNoaWxkKHRoaXMuaG9yaXopOwogICAgcGFyZW50LnJlbW92ZUNoaWxkKHRoaXMudmVydCk7CiAgfTsKCiAgdmFyIE51bGxTY3JvbGxiYXJzID0gZnVuY3Rpb24gKCkge307CgogIE51bGxTY3JvbGxiYXJzLnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbiAoKSB7IHJldHVybiB7Ym90dG9tOiAwLCByaWdodDogMH0gfTsKICBOdWxsU2Nyb2xsYmFycy5wcm90b3R5cGUuc2V0U2Nyb2xsTGVmdCA9IGZ1bmN0aW9uICgpIHt9OwogIE51bGxTY3JvbGxiYXJzLnByb3RvdHlwZS5zZXRTY3JvbGxUb3AgPSBmdW5jdGlvbiAoKSB7fTsKICBOdWxsU2Nyb2xsYmFycy5wcm90b3R5cGUuY2xlYXIgPSBmdW5jdGlvbiAoKSB7fTsKCiAgZnVuY3Rpb24gdXBkYXRlU2Nyb2xsYmFycyhjbSwgbWVhc3VyZSkgewogICAgaWYgKCFtZWFzdXJlKSB7IG1lYXN1cmUgPSBtZWFzdXJlRm9yU2Nyb2xsYmFycyhjbSk7IH0KICAgIHZhciBzdGFydFdpZHRoID0gY20uZGlzcGxheS5iYXJXaWR0aCwgc3RhcnRIZWlnaHQgPSBjbS5kaXNwbGF5LmJhckhlaWdodDsKICAgIHVwZGF0ZVNjcm9sbGJhcnNJbm5lcihjbSwgbWVhc3VyZSk7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IDQgJiYgc3RhcnRXaWR0aCAhPSBjbS5kaXNwbGF5LmJhcldpZHRoIHx8IHN0YXJ0SGVpZ2h0ICE9IGNtLmRpc3BsYXkuYmFySGVpZ2h0OyBpKyspIHsKICAgICAgaWYgKHN0YXJ0V2lkdGggIT0gY20uZGlzcGxheS5iYXJXaWR0aCAmJiBjbS5vcHRpb25zLmxpbmVXcmFwcGluZykKICAgICAgICB7IHVwZGF0ZUhlaWdodHNJblZpZXdwb3J0KGNtKTsgfQogICAgICB1cGRhdGVTY3JvbGxiYXJzSW5uZXIoY20sIG1lYXN1cmVGb3JTY3JvbGxiYXJzKGNtKSk7CiAgICAgIHN0YXJ0V2lkdGggPSBjbS5kaXNwbGF5LmJhcldpZHRoOyBzdGFydEhlaWdodCA9IGNtLmRpc3BsYXkuYmFySGVpZ2h0OwogICAgfQogIH0KCiAgLy8gUmUtc3luY2hyb25pemUgdGhlIGZha2Ugc2Nyb2xsYmFycyB3aXRoIHRoZSBhY3R1YWwgc2l6ZSBvZiB0aGUKICAvLyBjb250ZW50LgogIGZ1bmN0aW9uIHVwZGF0ZVNjcm9sbGJhcnNJbm5lcihjbSwgbWVhc3VyZSkgewogICAgdmFyIGQgPSBjbS5kaXNwbGF5OwogICAgdmFyIHNpemVzID0gZC5zY3JvbGxiYXJzLnVwZGF0ZShtZWFzdXJlKTsKCiAgICBkLnNpemVyLnN0eWxlLnBhZGRpbmdSaWdodCA9IChkLmJhcldpZHRoID0gc2l6ZXMucmlnaHQpICsgInB4IjsKICAgIGQuc2l6ZXIuc3R5bGUucGFkZGluZ0JvdHRvbSA9IChkLmJhckhlaWdodCA9IHNpemVzLmJvdHRvbSkgKyAicHgiOwogICAgZC5oZWlnaHRGb3JjZXIuc3R5bGUuYm9yZGVyQm90dG9tID0gc2l6ZXMuYm90dG9tICsgInB4IHNvbGlkIHRyYW5zcGFyZW50IjsKCiAgICBpZiAoc2l6ZXMucmlnaHQgJiYgc2l6ZXMuYm90dG9tKSB7CiAgICAgIGQuc2Nyb2xsYmFyRmlsbGVyLnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siOwogICAgICBkLnNjcm9sbGJhckZpbGxlci5zdHlsZS5oZWlnaHQgPSBzaXplcy5ib3R0b20gKyAicHgiOwogICAgICBkLnNjcm9sbGJhckZpbGxlci5zdHlsZS53aWR0aCA9IHNpemVzLnJpZ2h0ICsgInB4IjsKICAgIH0gZWxzZSB7IGQuc2Nyb2xsYmFyRmlsbGVyLnN0eWxlLmRpc3BsYXkgPSAiIjsgfQogICAgaWYgKHNpemVzLmJvdHRvbSAmJiBjbS5vcHRpb25zLmNvdmVyR3V0dGVyTmV4dFRvU2Nyb2xsYmFyICYmIGNtLm9wdGlvbnMuZml4ZWRHdXR0ZXIpIHsKICAgICAgZC5ndXR0ZXJGaWxsZXIuc3R5bGUuZGlzcGxheSA9ICJibG9jayI7CiAgICAgIGQuZ3V0dGVyRmlsbGVyLnN0eWxlLmhlaWdodCA9IHNpemVzLmJvdHRvbSArICJweCI7CiAgICAgIGQuZ3V0dGVyRmlsbGVyLnN0eWxlLndpZHRoID0gbWVhc3VyZS5ndXR0ZXJXaWR0aCArICJweCI7CiAgICB9IGVsc2UgeyBkLmd1dHRlckZpbGxlci5zdHlsZS5kaXNwbGF5ID0gIiI7IH0KICB9CgogIHZhciBzY3JvbGxiYXJNb2RlbCA9IHsibmF0aXZlIjogTmF0aXZlU2Nyb2xsYmFycywgIm51bGwiOiBOdWxsU2Nyb2xsYmFyc307CgogIGZ1bmN0aW9uIGluaXRTY3JvbGxiYXJzKGNtKSB7CiAgICBpZiAoY20uZGlzcGxheS5zY3JvbGxiYXJzKSB7CiAgICAgIGNtLmRpc3BsYXkuc2Nyb2xsYmFycy5jbGVhcigpOwogICAgICBpZiAoY20uZGlzcGxheS5zY3JvbGxiYXJzLmFkZENsYXNzKQogICAgICAgIHsgcm1DbGFzcyhjbS5kaXNwbGF5LndyYXBwZXIsIGNtLmRpc3BsYXkuc2Nyb2xsYmFycy5hZGRDbGFzcyk7IH0KICAgIH0KCiAgICBjbS5kaXNwbGF5LnNjcm9sbGJhcnMgPSBuZXcgc2Nyb2xsYmFyTW9kZWxbY20ub3B0aW9ucy5zY3JvbGxiYXJTdHlsZV0oZnVuY3Rpb24gKG5vZGUpIHsKICAgICAgY20uZGlzcGxheS53cmFwcGVyLmluc2VydEJlZm9yZShub2RlLCBjbS5kaXNwbGF5LnNjcm9sbGJhckZpbGxlcik7CiAgICAgIC8vIFByZXZlbnQgY2xpY2tzIGluIHRoZSBzY3JvbGxiYXJzIGZyb20ga2lsbGluZyBmb2N1cwogICAgICBvbihub2RlLCAibW91c2Vkb3duIiwgZnVuY3Rpb24gKCkgewogICAgICAgIGlmIChjbS5zdGF0ZS5mb2N1c2VkKSB7IHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgeyByZXR1cm4gY20uZGlzcGxheS5pbnB1dC5mb2N1cygpOyB9LCAwKTsgfQogICAgICB9KTsKICAgICAgbm9kZS5zZXRBdHRyaWJ1dGUoImNtLW5vdC1jb250ZW50IiwgInRydWUiKTsKICAgIH0sIGZ1bmN0aW9uIChwb3MsIGF4aXMpIHsKICAgICAgaWYgKGF4aXMgPT0gImhvcml6b250YWwiKSB7IHNldFNjcm9sbExlZnQoY20sIHBvcyk7IH0KICAgICAgZWxzZSB7IHVwZGF0ZVNjcm9sbFRvcChjbSwgcG9zKTsgfQogICAgfSwgY20pOwogICAgaWYgKGNtLmRpc3BsYXkuc2Nyb2xsYmFycy5hZGRDbGFzcykKICAgICAgeyBhZGRDbGFzcyhjbS5kaXNwbGF5LndyYXBwZXIsIGNtLmRpc3BsYXkuc2Nyb2xsYmFycy5hZGRDbGFzcyk7IH0KICB9CgogIC8vIE9wZXJhdGlvbnMgYXJlIHVzZWQgdG8gd3JhcCBhIHNlcmllcyBvZiBjaGFuZ2VzIHRvIHRoZSBlZGl0b3IKICAvLyBzdGF0ZSBpbiBzdWNoIGEgd2F5IHRoYXQgZWFjaCBjaGFuZ2Ugd29uJ3QgaGF2ZSB0byB1cGRhdGUgdGhlCiAgLy8gY3Vyc29yIGFuZCBkaXNwbGF5ICh3aGljaCB3b3VsZCBiZSBhd2t3YXJkLCBzbG93LCBhbmQKICAvLyBlcnJvci1wcm9uZSkuIEluc3RlYWQsIGRpc3BsYXkgdXBkYXRlcyBhcmUgYmF0Y2hlZCBhbmQgdGhlbiBhbGwKICAvLyBjb21iaW5lZCBhbmQgZXhlY3V0ZWQgYXQgb25jZS4KCiAgdmFyIG5leHRPcElkID0gMDsKICAvLyBTdGFydCBhIG5ldyBvcGVyYXRpb24uCiAgZnVuY3Rpb24gc3RhcnRPcGVyYXRpb24oY20pIHsKICAgIGNtLmN1ck9wID0gewogICAgICBjbTogY20sCiAgICAgIHZpZXdDaGFuZ2VkOiBmYWxzZSwgICAgICAvLyBGbGFnIHRoYXQgaW5kaWNhdGVzIHRoYXQgbGluZXMgbWlnaHQgbmVlZCB0byBiZSByZWRyYXduCiAgICAgIHN0YXJ0SGVpZ2h0OiBjbS5kb2MuaGVpZ2h0LCAvLyBVc2VkIHRvIGRldGVjdCBuZWVkIHRvIHVwZGF0ZSBzY3JvbGxiYXIKICAgICAgZm9yY2VVcGRhdGU6IGZhbHNlLCAgICAgIC8vIFVzZWQgdG8gZm9yY2UgYSByZWRyYXcKICAgICAgdXBkYXRlSW5wdXQ6IDAsICAgICAgIC8vIFdoZXRoZXIgdG8gcmVzZXQgdGhlIGlucHV0IHRleHRhcmVhCiAgICAgIHR5cGluZzogZmFsc2UsICAgICAgICAgICAvLyBXaGV0aGVyIHRoaXMgcmVzZXQgc2hvdWxkIGJlIGNhcmVmdWwgdG8gbGVhdmUgZXhpc3RpbmcgdGV4dCAoZm9yIGNvbXBvc2l0aW5nKQogICAgICBjaGFuZ2VPYmpzOiBudWxsLCAgICAgICAgLy8gQWNjdW11bGF0ZWQgY2hhbmdlcywgZm9yIGZpcmluZyBjaGFuZ2UgZXZlbnRzCiAgICAgIGN1cnNvckFjdGl2aXR5SGFuZGxlcnM6IG51bGwsIC8vIFNldCBvZiBoYW5kbGVycyB0byBmaXJlIGN1cnNvckFjdGl2aXR5IG9uCiAgICAgIGN1cnNvckFjdGl2aXR5Q2FsbGVkOiAwLCAvLyBUcmFja3Mgd2hpY2ggY3Vyc29yQWN0aXZpdHkgaGFuZGxlcnMgaGF2ZSBiZWVuIGNhbGxlZCBhbHJlYWR5CiAgICAgIHNlbGVjdGlvbkNoYW5nZWQ6IGZhbHNlLCAvLyBXaGV0aGVyIHRoZSBzZWxlY3Rpb24gbmVlZHMgdG8gYmUgcmVkcmF3bgogICAgICB1cGRhdGVNYXhMaW5lOiBmYWxzZSwgICAgLy8gU2V0IHdoZW4gdGhlIHdpZGVzdCBsaW5lIG5lZWRzIHRvIGJlIGRldGVybWluZWQgYW5ldwogICAgICBzY3JvbGxMZWZ0OiBudWxsLCBzY3JvbGxUb3A6IG51bGwsIC8vIEludGVybWVkaWF0ZSBzY3JvbGwgcG9zaXRpb24sIG5vdCBwdXNoZWQgdG8gRE9NIHlldAogICAgICBzY3JvbGxUb1BvczogbnVsbCwgICAgICAgLy8gVXNlZCB0byBzY3JvbGwgdG8gYSBzcGVjaWZpYyBwb3NpdGlvbgogICAgICBmb2N1czogZmFsc2UsCiAgICAgIGlkOiArK25leHRPcElkICAgICAgICAgICAvLyBVbmlxdWUgSUQKICAgIH07CiAgICBwdXNoT3BlcmF0aW9uKGNtLmN1ck9wKTsKICB9CgogIC8vIEZpbmlzaCBhbiBvcGVyYXRpb24sIHVwZGF0aW5nIHRoZSBkaXNwbGF5IGFuZCBzaWduYWxsaW5nIGRlbGF5ZWQgZXZlbnRzCiAgZnVuY3Rpb24gZW5kT3BlcmF0aW9uKGNtKSB7CiAgICB2YXIgb3AgPSBjbS5jdXJPcDsKICAgIGlmIChvcCkgeyBmaW5pc2hPcGVyYXRpb24ob3AsIGZ1bmN0aW9uIChncm91cCkgewogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGdyb3VwLm9wcy5sZW5ndGg7IGkrKykKICAgICAgICB7IGdyb3VwLm9wc1tpXS5jbS5jdXJPcCA9IG51bGw7IH0KICAgICAgZW5kT3BlcmF0aW9ucyhncm91cCk7CiAgICB9KTsgfQogIH0KCiAgLy8gVGhlIERPTSB1cGRhdGVzIGRvbmUgd2hlbiBhbiBvcGVyYXRpb24gZmluaXNoZXMgYXJlIGJhdGNoZWQgc28KICAvLyB0aGF0IHRoZSBtaW5pbXVtIG51bWJlciBvZiByZWxheW91dHMgYXJlIHJlcXVpcmVkLgogIGZ1bmN0aW9uIGVuZE9wZXJhdGlvbnMoZ3JvdXApIHsKICAgIHZhciBvcHMgPSBncm91cC5vcHM7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IG9wcy5sZW5ndGg7IGkrKykgLy8gUmVhZCBET00KICAgICAgeyBlbmRPcGVyYXRpb25fUjEob3BzW2ldKTsgfQogICAgZm9yICh2YXIgaSQxID0gMDsgaSQxIDwgb3BzLmxlbmd0aDsgaSQxKyspIC8vIFdyaXRlIERPTSAobWF5YmUpCiAgICAgIHsgZW5kT3BlcmF0aW9uX1cxKG9wc1tpJDFdKTsgfQogICAgZm9yICh2YXIgaSQyID0gMDsgaSQyIDwgb3BzLmxlbmd0aDsgaSQyKyspIC8vIFJlYWQgRE9NCiAgICAgIHsgZW5kT3BlcmF0aW9uX1IyKG9wc1tpJDJdKTsgfQogICAgZm9yICh2YXIgaSQzID0gMDsgaSQzIDwgb3BzLmxlbmd0aDsgaSQzKyspIC8vIFdyaXRlIERPTSAobWF5YmUpCiAgICAgIHsgZW5kT3BlcmF0aW9uX1cyKG9wc1tpJDNdKTsgfQogICAgZm9yICh2YXIgaSQ0ID0gMDsgaSQ0IDwgb3BzLmxlbmd0aDsgaSQ0KyspIC8vIFJlYWQgRE9NCiAgICAgIHsgZW5kT3BlcmF0aW9uX2ZpbmlzaChvcHNbaSQ0XSk7IH0KICB9CgogIGZ1bmN0aW9uIGVuZE9wZXJhdGlvbl9SMShvcCkgewogICAgdmFyIGNtID0gb3AuY20sIGRpc3BsYXkgPSBjbS5kaXNwbGF5OwogICAgbWF5YmVDbGlwU2Nyb2xsYmFycyhjbSk7CiAgICBpZiAob3AudXBkYXRlTWF4TGluZSkgeyBmaW5kTWF4TGluZShjbSk7IH0KCiAgICBvcC5tdXN0VXBkYXRlID0gb3Audmlld0NoYW5nZWQgfHwgb3AuZm9yY2VVcGRhdGUgfHwgb3Auc2Nyb2xsVG9wICE9IG51bGwgfHwKICAgICAgb3Auc2Nyb2xsVG9Qb3MgJiYgKG9wLnNjcm9sbFRvUG9zLmZyb20ubGluZSA8IGRpc3BsYXkudmlld0Zyb20gfHwKICAgICAgICAgICAgICAgICAgICAgICAgIG9wLnNjcm9sbFRvUG9zLnRvLmxpbmUgPj0gZGlzcGxheS52aWV3VG8pIHx8CiAgICAgIGRpc3BsYXkubWF4TGluZUNoYW5nZWQgJiYgY20ub3B0aW9ucy5saW5lV3JhcHBpbmc7CiAgICBvcC51cGRhdGUgPSBvcC5tdXN0VXBkYXRlICYmCiAgICAgIG5ldyBEaXNwbGF5VXBkYXRlKGNtLCBvcC5tdXN0VXBkYXRlICYmIHt0b3A6IG9wLnNjcm9sbFRvcCwgZW5zdXJlOiBvcC5zY3JvbGxUb1Bvc30sIG9wLmZvcmNlVXBkYXRlKTsKICB9CgogIGZ1bmN0aW9uIGVuZE9wZXJhdGlvbl9XMShvcCkgewogICAgb3AudXBkYXRlZERpc3BsYXkgPSBvcC5tdXN0VXBkYXRlICYmIHVwZGF0ZURpc3BsYXlJZk5lZWRlZChvcC5jbSwgb3AudXBkYXRlKTsKICB9CgogIGZ1bmN0aW9uIGVuZE9wZXJhdGlvbl9SMihvcCkgewogICAgdmFyIGNtID0gb3AuY20sIGRpc3BsYXkgPSBjbS5kaXNwbGF5OwogICAgaWYgKG9wLnVwZGF0ZWREaXNwbGF5KSB7IHVwZGF0ZUhlaWdodHNJblZpZXdwb3J0KGNtKTsgfQoKICAgIG9wLmJhck1lYXN1cmUgPSBtZWFzdXJlRm9yU2Nyb2xsYmFycyhjbSk7CgogICAgLy8gSWYgdGhlIG1heCBsaW5lIGNoYW5nZWQgc2luY2UgaXQgd2FzIGxhc3QgbWVhc3VyZWQsIG1lYXN1cmUgaXQsCiAgICAvLyBhbmQgZW5zdXJlIHRoZSBkb2N1bWVudCdzIHdpZHRoIG1hdGNoZXMgaXQuCiAgICAvLyB1cGRhdGVEaXNwbGF5X1cyIHdpbGwgdXNlIHRoZXNlIHByb3BlcnRpZXMgdG8gZG8gdGhlIGFjdHVhbCByZXNpemluZwogICAgaWYgKGRpc3BsYXkubWF4TGluZUNoYW5nZWQgJiYgIWNtLm9wdGlvbnMubGluZVdyYXBwaW5nKSB7CiAgICAgIG9wLmFkanVzdFdpZHRoVG8gPSBtZWFzdXJlQ2hhcihjbSwgZGlzcGxheS5tYXhMaW5lLCBkaXNwbGF5Lm1heExpbmUudGV4dC5sZW5ndGgpLmxlZnQgKyAzOwogICAgICBjbS5kaXNwbGF5LnNpemVyV2lkdGggPSBvcC5hZGp1c3RXaWR0aFRvOwogICAgICBvcC5iYXJNZWFzdXJlLnNjcm9sbFdpZHRoID0KICAgICAgICBNYXRoLm1heChkaXNwbGF5LnNjcm9sbGVyLmNsaWVudFdpZHRoLCBkaXNwbGF5LnNpemVyLm9mZnNldExlZnQgKyBvcC5hZGp1c3RXaWR0aFRvICsgc2Nyb2xsR2FwKGNtKSArIGNtLmRpc3BsYXkuYmFyV2lkdGgpOwogICAgICBvcC5tYXhTY3JvbGxMZWZ0ID0gTWF0aC5tYXgoMCwgZGlzcGxheS5zaXplci5vZmZzZXRMZWZ0ICsgb3AuYWRqdXN0V2lkdGhUbyAtIGRpc3BsYXlXaWR0aChjbSkpOwogICAgfQoKICAgIGlmIChvcC51cGRhdGVkRGlzcGxheSB8fCBvcC5zZWxlY3Rpb25DaGFuZ2VkKQogICAgICB7IG9wLnByZXBhcmVkU2VsZWN0aW9uID0gZGlzcGxheS5pbnB1dC5wcmVwYXJlU2VsZWN0aW9uKCk7IH0KICB9CgogIGZ1bmN0aW9uIGVuZE9wZXJhdGlvbl9XMihvcCkgewogICAgdmFyIGNtID0gb3AuY207CgogICAgaWYgKG9wLmFkanVzdFdpZHRoVG8gIT0gbnVsbCkgewogICAgICBjbS5kaXNwbGF5LnNpemVyLnN0eWxlLm1pbldpZHRoID0gb3AuYWRqdXN0V2lkdGhUbyArICJweCI7CiAgICAgIGlmIChvcC5tYXhTY3JvbGxMZWZ0IDwgY20uZG9jLnNjcm9sbExlZnQpCiAgICAgICAgeyBzZXRTY3JvbGxMZWZ0KGNtLCBNYXRoLm1pbihjbS5kaXNwbGF5LnNjcm9sbGVyLnNjcm9sbExlZnQsIG9wLm1heFNjcm9sbExlZnQpLCB0cnVlKTsgfQogICAgICBjbS5kaXNwbGF5Lm1heExpbmVDaGFuZ2VkID0gZmFsc2U7CiAgICB9CgogICAgdmFyIHRha2VGb2N1cyA9IG9wLmZvY3VzICYmIG9wLmZvY3VzID09IGFjdGl2ZUVsdCgpOwogICAgaWYgKG9wLnByZXBhcmVkU2VsZWN0aW9uKQogICAgICB7IGNtLmRpc3BsYXkuaW5wdXQuc2hvd1NlbGVjdGlvbihvcC5wcmVwYXJlZFNlbGVjdGlvbiwgdGFrZUZvY3VzKTsgfQogICAgaWYgKG9wLnVwZGF0ZWREaXNwbGF5IHx8IG9wLnN0YXJ0SGVpZ2h0ICE9IGNtLmRvYy5oZWlnaHQpCiAgICAgIHsgdXBkYXRlU2Nyb2xsYmFycyhjbSwgb3AuYmFyTWVhc3VyZSk7IH0KICAgIGlmIChvcC51cGRhdGVkRGlzcGxheSkKICAgICAgeyBzZXREb2N1bWVudEhlaWdodChjbSwgb3AuYmFyTWVhc3VyZSk7IH0KCiAgICBpZiAob3Auc2VsZWN0aW9uQ2hhbmdlZCkgeyByZXN0YXJ0QmxpbmsoY20pOyB9CgogICAgaWYgKGNtLnN0YXRlLmZvY3VzZWQgJiYgb3AudXBkYXRlSW5wdXQpCiAgICAgIHsgY20uZGlzcGxheS5pbnB1dC5yZXNldChvcC50eXBpbmcpOyB9CiAgICBpZiAodGFrZUZvY3VzKSB7IGVuc3VyZUZvY3VzKG9wLmNtKTsgfQogIH0KCiAgZnVuY3Rpb24gZW5kT3BlcmF0aW9uX2ZpbmlzaChvcCkgewogICAgdmFyIGNtID0gb3AuY20sIGRpc3BsYXkgPSBjbS5kaXNwbGF5LCBkb2MgPSBjbS5kb2M7CgogICAgaWYgKG9wLnVwZGF0ZWREaXNwbGF5KSB7IHBvc3RVcGRhdGVEaXNwbGF5KGNtLCBvcC51cGRhdGUpOyB9CgogICAgLy8gQWJvcnQgbW91c2Ugd2hlZWwgZGVsdGEgbWVhc3VyZW1lbnQsIHdoZW4gc2Nyb2xsaW5nIGV4cGxpY2l0bHkKICAgIGlmIChkaXNwbGF5LndoZWVsU3RhcnRYICE9IG51bGwgJiYgKG9wLnNjcm9sbFRvcCAhPSBudWxsIHx8IG9wLnNjcm9sbExlZnQgIT0gbnVsbCB8fCBvcC5zY3JvbGxUb1BvcykpCiAgICAgIHsgZGlzcGxheS53aGVlbFN0YXJ0WCA9IGRpc3BsYXkud2hlZWxTdGFydFkgPSBudWxsOyB9CgogICAgLy8gUHJvcGFnYXRlIHRoZSBzY3JvbGwgcG9zaXRpb24gdG8gdGhlIGFjdHVhbCBET00gc2Nyb2xsZXIKICAgIGlmIChvcC5zY3JvbGxUb3AgIT0gbnVsbCkgeyBzZXRTY3JvbGxUb3AoY20sIG9wLnNjcm9sbFRvcCwgb3AuZm9yY2VTY3JvbGwpOyB9CgogICAgaWYgKG9wLnNjcm9sbExlZnQgIT0gbnVsbCkgeyBzZXRTY3JvbGxMZWZ0KGNtLCBvcC5zY3JvbGxMZWZ0LCB0cnVlLCB0cnVlKTsgfQogICAgLy8gSWYgd2UgbmVlZCB0byBzY3JvbGwgYSBzcGVjaWZpYyBwb3NpdGlvbiBpbnRvIHZpZXcsIGRvIHNvLgogICAgaWYgKG9wLnNjcm9sbFRvUG9zKSB7CiAgICAgIHZhciByZWN0ID0gc2Nyb2xsUG9zSW50b1ZpZXcoY20sIGNsaXBQb3MoZG9jLCBvcC5zY3JvbGxUb1Bvcy5mcm9tKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGlwUG9zKGRvYywgb3Auc2Nyb2xsVG9Qb3MudG8pLCBvcC5zY3JvbGxUb1Bvcy5tYXJnaW4pOwogICAgICBtYXliZVNjcm9sbFdpbmRvdyhjbSwgcmVjdCk7CiAgICB9CgogICAgLy8gRmlyZSBldmVudHMgZm9yIG1hcmtlcnMgdGhhdCBhcmUgaGlkZGVuL3VuaWRkZW4gYnkgZWRpdGluZyBvcgogICAgLy8gdW5kb2luZwogICAgdmFyIGhpZGRlbiA9IG9wLm1heWJlSGlkZGVuTWFya2VycywgdW5oaWRkZW4gPSBvcC5tYXliZVVuaGlkZGVuTWFya2VyczsKICAgIGlmIChoaWRkZW4pIHsgZm9yICh2YXIgaSA9IDA7IGkgPCBoaWRkZW4ubGVuZ3RoOyArK2kpCiAgICAgIHsgaWYgKCFoaWRkZW5baV0ubGluZXMubGVuZ3RoKSB7IHNpZ25hbChoaWRkZW5baV0sICJoaWRlIik7IH0gfSB9CiAgICBpZiAodW5oaWRkZW4pIHsgZm9yICh2YXIgaSQxID0gMDsgaSQxIDwgdW5oaWRkZW4ubGVuZ3RoOyArK2kkMSkKICAgICAgeyBpZiAodW5oaWRkZW5baSQxXS5saW5lcy5sZW5ndGgpIHsgc2lnbmFsKHVuaGlkZGVuW2kkMV0sICJ1bmhpZGUiKTsgfSB9IH0KCiAgICBpZiAoZGlzcGxheS53cmFwcGVyLm9mZnNldEhlaWdodCkKICAgICAgeyBkb2Muc2Nyb2xsVG9wID0gY20uZGlzcGxheS5zY3JvbGxlci5zY3JvbGxUb3A7IH0KCiAgICAvLyBGaXJlIGNoYW5nZSBldmVudHMsIGFuZCBkZWxheWVkIGV2ZW50IGhhbmRsZXJzCiAgICBpZiAob3AuY2hhbmdlT2JqcykKICAgICAgeyBzaWduYWwoY20sICJjaGFuZ2VzIiwgY20sIG9wLmNoYW5nZU9ianMpOyB9CiAgICBpZiAob3AudXBkYXRlKQogICAgICB7IG9wLnVwZGF0ZS5maW5pc2goKTsgfQogIH0KCiAgLy8gUnVuIHRoZSBnaXZlbiBmdW5jdGlvbiBpbiBhbiBvcGVyYXRpb24KICBmdW5jdGlvbiBydW5Jbk9wKGNtLCBmKSB7CiAgICBpZiAoY20uY3VyT3ApIHsgcmV0dXJuIGYoKSB9CiAgICBzdGFydE9wZXJhdGlvbihjbSk7CiAgICB0cnkgeyByZXR1cm4gZigpIH0KICAgIGZpbmFsbHkgeyBlbmRPcGVyYXRpb24oY20pOyB9CiAgfQogIC8vIFdyYXBzIGEgZnVuY3Rpb24gaW4gYW4gb3BlcmF0aW9uLiBSZXR1cm5zIHRoZSB3cmFwcGVkIGZ1bmN0aW9uLgogIGZ1bmN0aW9uIG9wZXJhdGlvbihjbSwgZikgewogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICBpZiAoY20uY3VyT3ApIHsgcmV0dXJuIGYuYXBwbHkoY20sIGFyZ3VtZW50cykgfQogICAgICBzdGFydE9wZXJhdGlvbihjbSk7CiAgICAgIHRyeSB7IHJldHVybiBmLmFwcGx5KGNtLCBhcmd1bWVudHMpIH0KICAgICAgZmluYWxseSB7IGVuZE9wZXJhdGlvbihjbSk7IH0KICAgIH0KICB9CiAgLy8gVXNlZCB0byBhZGQgbWV0aG9kcyB0byBlZGl0b3IgYW5kIGRvYyBpbnN0YW5jZXMsIHdyYXBwaW5nIHRoZW0gaW4KICAvLyBvcGVyYXRpb25zLgogIGZ1bmN0aW9uIG1ldGhvZE9wKGYpIHsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgaWYgKHRoaXMuY3VyT3ApIHsgcmV0dXJuIGYuYXBwbHkodGhpcywgYXJndW1lbnRzKSB9CiAgICAgIHN0YXJ0T3BlcmF0aW9uKHRoaXMpOwogICAgICB0cnkgeyByZXR1cm4gZi5hcHBseSh0aGlzLCBhcmd1bWVudHMpIH0KICAgICAgZmluYWxseSB7IGVuZE9wZXJhdGlvbih0aGlzKTsgfQogICAgfQogIH0KICBmdW5jdGlvbiBkb2NNZXRob2RPcChmKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBjbSA9IHRoaXMuY207CiAgICAgIGlmICghY20gfHwgY20uY3VyT3ApIHsgcmV0dXJuIGYuYXBwbHkodGhpcywgYXJndW1lbnRzKSB9CiAgICAgIHN0YXJ0T3BlcmF0aW9uKGNtKTsKICAgICAgdHJ5IHsgcmV0dXJuIGYuYXBwbHkodGhpcywgYXJndW1lbnRzKSB9CiAgICAgIGZpbmFsbHkgeyBlbmRPcGVyYXRpb24oY20pOyB9CiAgICB9CiAgfQoKICAvLyBISUdITElHSFQgV09SS0VSCgogIGZ1bmN0aW9uIHN0YXJ0V29ya2VyKGNtLCB0aW1lKSB7CiAgICBpZiAoY20uZG9jLmhpZ2hsaWdodEZyb250aWVyIDwgY20uZGlzcGxheS52aWV3VG8pCiAgICAgIHsgY20uc3RhdGUuaGlnaGxpZ2h0LnNldCh0aW1lLCBiaW5kKGhpZ2hsaWdodFdvcmtlciwgY20pKTsgfQogIH0KCiAgZnVuY3Rpb24gaGlnaGxpZ2h0V29ya2VyKGNtKSB7CiAgICB2YXIgZG9jID0gY20uZG9jOwogICAgaWYgKGRvYy5oaWdobGlnaHRGcm9udGllciA+PSBjbS5kaXNwbGF5LnZpZXdUbykgeyByZXR1cm4gfQogICAgdmFyIGVuZCA9ICtuZXcgRGF0ZSArIGNtLm9wdGlvbnMud29ya1RpbWU7CiAgICB2YXIgY29udGV4dCA9IGdldENvbnRleHRCZWZvcmUoY20sIGRvYy5oaWdobGlnaHRGcm9udGllcik7CiAgICB2YXIgY2hhbmdlZExpbmVzID0gW107CgogICAgZG9jLml0ZXIoY29udGV4dC5saW5lLCBNYXRoLm1pbihkb2MuZmlyc3QgKyBkb2Muc2l6ZSwgY20uZGlzcGxheS52aWV3VG8gKyA1MDApLCBmdW5jdGlvbiAobGluZSkgewogICAgICBpZiAoY29udGV4dC5saW5lID49IGNtLmRpc3BsYXkudmlld0Zyb20pIHsgLy8gVmlzaWJsZQogICAgICAgIHZhciBvbGRTdHlsZXMgPSBsaW5lLnN0eWxlczsKICAgICAgICB2YXIgcmVzZXRTdGF0ZSA9IGxpbmUudGV4dC5sZW5ndGggPiBjbS5vcHRpb25zLm1heEhpZ2hsaWdodExlbmd0aCA/IGNvcHlTdGF0ZShkb2MubW9kZSwgY29udGV4dC5zdGF0ZSkgOiBudWxsOwogICAgICAgIHZhciBoaWdobGlnaHRlZCA9IGhpZ2hsaWdodExpbmUoY20sIGxpbmUsIGNvbnRleHQsIHRydWUpOwogICAgICAgIGlmIChyZXNldFN0YXRlKSB7IGNvbnRleHQuc3RhdGUgPSByZXNldFN0YXRlOyB9CiAgICAgICAgbGluZS5zdHlsZXMgPSBoaWdobGlnaHRlZC5zdHlsZXM7CiAgICAgICAgdmFyIG9sZENscyA9IGxpbmUuc3R5bGVDbGFzc2VzLCBuZXdDbHMgPSBoaWdobGlnaHRlZC5jbGFzc2VzOwogICAgICAgIGlmIChuZXdDbHMpIHsgbGluZS5zdHlsZUNsYXNzZXMgPSBuZXdDbHM7IH0KICAgICAgICBlbHNlIGlmIChvbGRDbHMpIHsgbGluZS5zdHlsZUNsYXNzZXMgPSBudWxsOyB9CiAgICAgICAgdmFyIGlzY2hhbmdlID0gIW9sZFN0eWxlcyB8fCBvbGRTdHlsZXMubGVuZ3RoICE9IGxpbmUuc3R5bGVzLmxlbmd0aCB8fAogICAgICAgICAgb2xkQ2xzICE9IG5ld0NscyAmJiAoIW9sZENscyB8fCAhbmV3Q2xzIHx8IG9sZENscy5iZ0NsYXNzICE9IG5ld0Nscy5iZ0NsYXNzIHx8IG9sZENscy50ZXh0Q2xhc3MgIT0gbmV3Q2xzLnRleHRDbGFzcyk7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7ICFpc2NoYW5nZSAmJiBpIDwgb2xkU3R5bGVzLmxlbmd0aDsgKytpKSB7IGlzY2hhbmdlID0gb2xkU3R5bGVzW2ldICE9IGxpbmUuc3R5bGVzW2ldOyB9CiAgICAgICAgaWYgKGlzY2hhbmdlKSB7IGNoYW5nZWRMaW5lcy5wdXNoKGNvbnRleHQubGluZSk7IH0KICAgICAgICBsaW5lLnN0YXRlQWZ0ZXIgPSBjb250ZXh0LnNhdmUoKTsKICAgICAgICBjb250ZXh0Lm5leHRMaW5lKCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKGxpbmUudGV4dC5sZW5ndGggPD0gY20ub3B0aW9ucy5tYXhIaWdobGlnaHRMZW5ndGgpCiAgICAgICAgICB7IHByb2Nlc3NMaW5lKGNtLCBsaW5lLnRleHQsIGNvbnRleHQpOyB9CiAgICAgICAgbGluZS5zdGF0ZUFmdGVyID0gY29udGV4dC5saW5lICUgNSA9PSAwID8gY29udGV4dC5zYXZlKCkgOiBudWxsOwogICAgICAgIGNvbnRleHQubmV4dExpbmUoKTsKICAgICAgfQogICAgICBpZiAoK25ldyBEYXRlID4gZW5kKSB7CiAgICAgICAgc3RhcnRXb3JrZXIoY20sIGNtLm9wdGlvbnMud29ya0RlbGF5KTsKICAgICAgICByZXR1cm4gdHJ1ZQogICAgICB9CiAgICB9KTsKICAgIGRvYy5oaWdobGlnaHRGcm9udGllciA9IGNvbnRleHQubGluZTsKICAgIGRvYy5tb2RlRnJvbnRpZXIgPSBNYXRoLm1heChkb2MubW9kZUZyb250aWVyLCBjb250ZXh0LmxpbmUpOwogICAgaWYgKGNoYW5nZWRMaW5lcy5sZW5ndGgpIHsgcnVuSW5PcChjbSwgZnVuY3Rpb24gKCkgewogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNoYW5nZWRMaW5lcy5sZW5ndGg7IGkrKykKICAgICAgICB7IHJlZ0xpbmVDaGFuZ2UoY20sIGNoYW5nZWRMaW5lc1tpXSwgInRleHQiKTsgfQogICAgfSk7IH0KICB9CgogIC8vIERJU1BMQVkgRFJBV0lORwoKICB2YXIgRGlzcGxheVVwZGF0ZSA9IGZ1bmN0aW9uKGNtLCB2aWV3cG9ydCwgZm9yY2UpIHsKICAgIHZhciBkaXNwbGF5ID0gY20uZGlzcGxheTsKCiAgICB0aGlzLnZpZXdwb3J0ID0gdmlld3BvcnQ7CiAgICAvLyBTdG9yZSBzb21lIHZhbHVlcyB0aGF0IHdlJ2xsIG5lZWQgbGF0ZXIgKGJ1dCBkb24ndCB3YW50IHRvIGZvcmNlIGEgcmVsYXlvdXQgZm9yKQogICAgdGhpcy52aXNpYmxlID0gdmlzaWJsZUxpbmVzKGRpc3BsYXksIGNtLmRvYywgdmlld3BvcnQpOwogICAgdGhpcy5lZGl0b3JJc0hpZGRlbiA9ICFkaXNwbGF5LndyYXBwZXIub2Zmc2V0V2lkdGg7CiAgICB0aGlzLndyYXBwZXJIZWlnaHQgPSBkaXNwbGF5LndyYXBwZXIuY2xpZW50SGVpZ2h0OwogICAgdGhpcy53cmFwcGVyV2lkdGggPSBkaXNwbGF5LndyYXBwZXIuY2xpZW50V2lkdGg7CiAgICB0aGlzLm9sZERpc3BsYXlXaWR0aCA9IGRpc3BsYXlXaWR0aChjbSk7CiAgICB0aGlzLmZvcmNlID0gZm9yY2U7CiAgICB0aGlzLmRpbXMgPSBnZXREaW1lbnNpb25zKGNtKTsKICAgIHRoaXMuZXZlbnRzID0gW107CiAgfTsKCiAgRGlzcGxheVVwZGF0ZS5wcm90b3R5cGUuc2lnbmFsID0gZnVuY3Rpb24gKGVtaXR0ZXIsIHR5cGUpIHsKICAgIGlmIChoYXNIYW5kbGVyKGVtaXR0ZXIsIHR5cGUpKQogICAgICB7IHRoaXMuZXZlbnRzLnB1c2goYXJndW1lbnRzKTsgfQogIH07CiAgRGlzcGxheVVwZGF0ZS5wcm90b3R5cGUuZmluaXNoID0gZnVuY3Rpb24gKCkgewogICAgICB2YXIgdGhpcyQxID0gdGhpczsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuZXZlbnRzLmxlbmd0aDsgaSsrKQogICAgICB7IHNpZ25hbC5hcHBseShudWxsLCB0aGlzJDEuZXZlbnRzW2ldKTsgfQogIH07CgogIGZ1bmN0aW9uIG1heWJlQ2xpcFNjcm9sbGJhcnMoY20pIHsKICAgIHZhciBkaXNwbGF5ID0gY20uZGlzcGxheTsKICAgIGlmICghZGlzcGxheS5zY3JvbGxiYXJzQ2xpcHBlZCAmJiBkaXNwbGF5LnNjcm9sbGVyLm9mZnNldFdpZHRoKSB7CiAgICAgIGRpc3BsYXkubmF0aXZlQmFyV2lkdGggPSBkaXNwbGF5LnNjcm9sbGVyLm9mZnNldFdpZHRoIC0gZGlzcGxheS5zY3JvbGxlci5jbGllbnRXaWR0aDsKICAgICAgZGlzcGxheS5oZWlnaHRGb3JjZXIuc3R5bGUuaGVpZ2h0ID0gc2Nyb2xsR2FwKGNtKSArICJweCI7CiAgICAgIGRpc3BsYXkuc2l6ZXIuc3R5bGUubWFyZ2luQm90dG9tID0gLWRpc3BsYXkubmF0aXZlQmFyV2lkdGggKyAicHgiOwogICAgICBkaXNwbGF5LnNpemVyLnN0eWxlLmJvcmRlclJpZ2h0V2lkdGggPSBzY3JvbGxHYXAoY20pICsgInB4IjsKICAgICAgZGlzcGxheS5zY3JvbGxiYXJzQ2xpcHBlZCA9IHRydWU7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBzZWxlY3Rpb25TbmFwc2hvdChjbSkgewogICAgaWYgKGNtLmhhc0ZvY3VzKCkpIHsgcmV0dXJuIG51bGwgfQogICAgdmFyIGFjdGl2ZSA9IGFjdGl2ZUVsdCgpOwogICAgaWYgKCFhY3RpdmUgfHwgIWNvbnRhaW5zKGNtLmRpc3BsYXkubGluZURpdiwgYWN0aXZlKSkgeyByZXR1cm4gbnVsbCB9CiAgICB2YXIgcmVzdWx0ID0ge2FjdGl2ZUVsdDogYWN0aXZlfTsKICAgIGlmICh3aW5kb3cuZ2V0U2VsZWN0aW9uKSB7CiAgICAgIHZhciBzZWwgPSB3aW5kb3cuZ2V0U2VsZWN0aW9uKCk7CiAgICAgIGlmIChzZWwuYW5jaG9yTm9kZSAmJiBzZWwuZXh0ZW5kICYmIGNvbnRhaW5zKGNtLmRpc3BsYXkubGluZURpdiwgc2VsLmFuY2hvck5vZGUpKSB7CiAgICAgICAgcmVzdWx0LmFuY2hvck5vZGUgPSBzZWwuYW5jaG9yTm9kZTsKICAgICAgICByZXN1bHQuYW5jaG9yT2Zmc2V0ID0gc2VsLmFuY2hvck9mZnNldDsKICAgICAgICByZXN1bHQuZm9jdXNOb2RlID0gc2VsLmZvY3VzTm9kZTsKICAgICAgICByZXN1bHQuZm9jdXNPZmZzZXQgPSBzZWwuZm9jdXNPZmZzZXQ7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiByZXN1bHQKICB9CgogIGZ1bmN0aW9uIHJlc3RvcmVTZWxlY3Rpb24oc25hcHNob3QpIHsKICAgIGlmICghc25hcHNob3QgfHwgIXNuYXBzaG90LmFjdGl2ZUVsdCB8fCBzbmFwc2hvdC5hY3RpdmVFbHQgPT0gYWN0aXZlRWx0KCkpIHsgcmV0dXJuIH0KICAgIHNuYXBzaG90LmFjdGl2ZUVsdC5mb2N1cygpOwogICAgaWYgKHNuYXBzaG90LmFuY2hvck5vZGUgJiYgY29udGFpbnMoZG9jdW1lbnQuYm9keSwgc25hcHNob3QuYW5jaG9yTm9kZSkgJiYgY29udGFpbnMoZG9jdW1lbnQuYm9keSwgc25hcHNob3QuZm9jdXNOb2RlKSkgewogICAgICB2YXIgc2VsID0gd2luZG93LmdldFNlbGVjdGlvbigpLCByYW5nZSQkMSA9IGRvY3VtZW50LmNyZWF0ZVJhbmdlKCk7CiAgICAgIHJhbmdlJCQxLnNldEVuZChzbmFwc2hvdC5hbmNob3JOb2RlLCBzbmFwc2hvdC5hbmNob3JPZmZzZXQpOwogICAgICByYW5nZSQkMS5jb2xsYXBzZShmYWxzZSk7CiAgICAgIHNlbC5yZW1vdmVBbGxSYW5nZXMoKTsKICAgICAgc2VsLmFkZFJhbmdlKHJhbmdlJCQxKTsKICAgICAgc2VsLmV4dGVuZChzbmFwc2hvdC5mb2N1c05vZGUsIHNuYXBzaG90LmZvY3VzT2Zmc2V0KTsKICAgIH0KICB9CgogIC8vIERvZXMgdGhlIGFjdHVhbCB1cGRhdGluZyBvZiB0aGUgbGluZSBkaXNwbGF5LiBCYWlscyBvdXQKICAvLyAocmV0dXJuaW5nIGZhbHNlKSB3aGVuIHRoZXJlIGlzIG5vdGhpbmcgdG8gYmUgZG9uZSBhbmQgZm9yY2VkIGlzCiAgLy8gZmFsc2UuCiAgZnVuY3Rpb24gdXBkYXRlRGlzcGxheUlmTmVlZGVkKGNtLCB1cGRhdGUpIHsKICAgIHZhciBkaXNwbGF5ID0gY20uZGlzcGxheSwgZG9jID0gY20uZG9jOwoKICAgIGlmICh1cGRhdGUuZWRpdG9ySXNIaWRkZW4pIHsKICAgICAgcmVzZXRWaWV3KGNtKTsKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CgogICAgLy8gQmFpbCBvdXQgaWYgdGhlIHZpc2libGUgYXJlYSBpcyBhbHJlYWR5IHJlbmRlcmVkIGFuZCBub3RoaW5nIGNoYW5nZWQuCiAgICBpZiAoIXVwZGF0ZS5mb3JjZSAmJgogICAgICAgIHVwZGF0ZS52aXNpYmxlLmZyb20gPj0gZGlzcGxheS52aWV3RnJvbSAmJiB1cGRhdGUudmlzaWJsZS50byA8PSBkaXNwbGF5LnZpZXdUbyAmJgogICAgICAgIChkaXNwbGF5LnVwZGF0ZUxpbmVOdW1iZXJzID09IG51bGwgfHwgZGlzcGxheS51cGRhdGVMaW5lTnVtYmVycyA+PSBkaXNwbGF5LnZpZXdUbykgJiYKICAgICAgICBkaXNwbGF5LnJlbmRlcmVkVmlldyA9PSBkaXNwbGF5LnZpZXcgJiYgY291bnREaXJ0eVZpZXcoY20pID09IDApCiAgICAgIHsgcmV0dXJuIGZhbHNlIH0KCiAgICBpZiAobWF5YmVVcGRhdGVMaW5lTnVtYmVyV2lkdGgoY20pKSB7CiAgICAgIHJlc2V0VmlldyhjbSk7CiAgICAgIHVwZGF0ZS5kaW1zID0gZ2V0RGltZW5zaW9ucyhjbSk7CiAgICB9CgogICAgLy8gQ29tcHV0ZSBhIHN1aXRhYmxlIG5ldyB2aWV3cG9ydCAoZnJvbSAmIHRvKQogICAgdmFyIGVuZCA9IGRvYy5maXJzdCArIGRvYy5zaXplOwogICAgdmFyIGZyb20gPSBNYXRoLm1heCh1cGRhdGUudmlzaWJsZS5mcm9tIC0gY20ub3B0aW9ucy52aWV3cG9ydE1hcmdpbiwgZG9jLmZpcnN0KTsKICAgIHZhciB0byA9IE1hdGgubWluKGVuZCwgdXBkYXRlLnZpc2libGUudG8gKyBjbS5vcHRpb25zLnZpZXdwb3J0TWFyZ2luKTsKICAgIGlmIChkaXNwbGF5LnZpZXdGcm9tIDwgZnJvbSAmJiBmcm9tIC0gZGlzcGxheS52aWV3RnJvbSA8IDIwKSB7IGZyb20gPSBNYXRoLm1heChkb2MuZmlyc3QsIGRpc3BsYXkudmlld0Zyb20pOyB9CiAgICBpZiAoZGlzcGxheS52aWV3VG8gPiB0byAmJiBkaXNwbGF5LnZpZXdUbyAtIHRvIDwgMjApIHsgdG8gPSBNYXRoLm1pbihlbmQsIGRpc3BsYXkudmlld1RvKTsgfQogICAgaWYgKHNhd0NvbGxhcHNlZFNwYW5zKSB7CiAgICAgIGZyb20gPSB2aXN1YWxMaW5lTm8oY20uZG9jLCBmcm9tKTsKICAgICAgdG8gPSB2aXN1YWxMaW5lRW5kTm8oY20uZG9jLCB0byk7CiAgICB9CgogICAgdmFyIGRpZmZlcmVudCA9IGZyb20gIT0gZGlzcGxheS52aWV3RnJvbSB8fCB0byAhPSBkaXNwbGF5LnZpZXdUbyB8fAogICAgICBkaXNwbGF5Lmxhc3RXcmFwSGVpZ2h0ICE9IHVwZGF0ZS53cmFwcGVySGVpZ2h0IHx8IGRpc3BsYXkubGFzdFdyYXBXaWR0aCAhPSB1cGRhdGUud3JhcHBlcldpZHRoOwogICAgYWRqdXN0VmlldyhjbSwgZnJvbSwgdG8pOwoKICAgIGRpc3BsYXkudmlld09mZnNldCA9IGhlaWdodEF0TGluZShnZXRMaW5lKGNtLmRvYywgZGlzcGxheS52aWV3RnJvbSkpOwogICAgLy8gUG9zaXRpb24gdGhlIG1vdmVyIGRpdiB0byBhbGlnbiB3aXRoIHRoZSBjdXJyZW50IHNjcm9sbCBwb3NpdGlvbgogICAgY20uZGlzcGxheS5tb3Zlci5zdHlsZS50b3AgPSBkaXNwbGF5LnZpZXdPZmZzZXQgKyAicHgiOwoKICAgIHZhciB0b1VwZGF0ZSA9IGNvdW50RGlydHlWaWV3KGNtKTsKICAgIGlmICghZGlmZmVyZW50ICYmIHRvVXBkYXRlID09IDAgJiYgIXVwZGF0ZS5mb3JjZSAmJiBkaXNwbGF5LnJlbmRlcmVkVmlldyA9PSBkaXNwbGF5LnZpZXcgJiYKICAgICAgICAoZGlzcGxheS51cGRhdGVMaW5lTnVtYmVycyA9PSBudWxsIHx8IGRpc3BsYXkudXBkYXRlTGluZU51bWJlcnMgPj0gZGlzcGxheS52aWV3VG8pKQogICAgICB7IHJldHVybiBmYWxzZSB9CgogICAgLy8gRm9yIGJpZyBjaGFuZ2VzLCB3ZSBoaWRlIHRoZSBlbmNsb3NpbmcgZWxlbWVudCBkdXJpbmcgdGhlCiAgICAvLyB1cGRhdGUsIHNpbmNlIHRoYXQgc3BlZWRzIHVwIHRoZSBvcGVyYXRpb25zIG9uIG1vc3QgYnJvd3NlcnMuCiAgICB2YXIgc2VsU25hcHNob3QgPSBzZWxlY3Rpb25TbmFwc2hvdChjbSk7CiAgICBpZiAodG9VcGRhdGUgPiA0KSB7IGRpc3BsYXkubGluZURpdi5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOyB9CiAgICBwYXRjaERpc3BsYXkoY20sIGRpc3BsYXkudXBkYXRlTGluZU51bWJlcnMsIHVwZGF0ZS5kaW1zKTsKICAgIGlmICh0b1VwZGF0ZSA+IDQpIHsgZGlzcGxheS5saW5lRGl2LnN0eWxlLmRpc3BsYXkgPSAiIjsgfQogICAgZGlzcGxheS5yZW5kZXJlZFZpZXcgPSBkaXNwbGF5LnZpZXc7CiAgICAvLyBUaGVyZSBtaWdodCBoYXZlIGJlZW4gYSB3aWRnZXQgd2l0aCBhIGZvY3VzZWQgZWxlbWVudCB0aGF0IGdvdAogICAgLy8gaGlkZGVuIG9yIHVwZGF0ZWQsIGlmIHNvIHJlLWZvY3VzIGl0LgogICAgcmVzdG9yZVNlbGVjdGlvbihzZWxTbmFwc2hvdCk7CgogICAgLy8gUHJldmVudCBzZWxlY3Rpb24gYW5kIGN1cnNvcnMgZnJvbSBpbnRlcmZlcmluZyB3aXRoIHRoZSBzY3JvbGwKICAgIC8vIHdpZHRoIGFuZCBoZWlnaHQuCiAgICByZW1vdmVDaGlsZHJlbihkaXNwbGF5LmN1cnNvckRpdik7CiAgICByZW1vdmVDaGlsZHJlbihkaXNwbGF5LnNlbGVjdGlvbkRpdik7CiAgICBkaXNwbGF5Lmd1dHRlcnMuc3R5bGUuaGVpZ2h0ID0gZGlzcGxheS5zaXplci5zdHlsZS5taW5IZWlnaHQgPSAwOwoKICAgIGlmIChkaWZmZXJlbnQpIHsKICAgICAgZGlzcGxheS5sYXN0V3JhcEhlaWdodCA9IHVwZGF0ZS53cmFwcGVySGVpZ2h0OwogICAgICBkaXNwbGF5Lmxhc3RXcmFwV2lkdGggPSB1cGRhdGUud3JhcHBlcldpZHRoOwogICAgICBzdGFydFdvcmtlcihjbSwgNDAwKTsKICAgIH0KCiAgICBkaXNwbGF5LnVwZGF0ZUxpbmVOdW1iZXJzID0gbnVsbDsKCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgZnVuY3Rpb24gcG9zdFVwZGF0ZURpc3BsYXkoY20sIHVwZGF0ZSkgewogICAgdmFyIHZpZXdwb3J0ID0gdXBkYXRlLnZpZXdwb3J0OwoKICAgIGZvciAodmFyIGZpcnN0ID0gdHJ1ZTs7IGZpcnN0ID0gZmFsc2UpIHsKICAgICAgaWYgKCFmaXJzdCB8fCAhY20ub3B0aW9ucy5saW5lV3JhcHBpbmcgfHwgdXBkYXRlLm9sZERpc3BsYXlXaWR0aCA9PSBkaXNwbGF5V2lkdGgoY20pKSB7CiAgICAgICAgLy8gQ2xpcCBmb3JjZWQgdmlld3BvcnQgdG8gYWN0dWFsIHNjcm9sbGFibGUgYXJlYS4KICAgICAgICBpZiAodmlld3BvcnQgJiYgdmlld3BvcnQudG9wICE9IG51bGwpCiAgICAgICAgICB7IHZpZXdwb3J0ID0ge3RvcDogTWF0aC5taW4oY20uZG9jLmhlaWdodCArIHBhZGRpbmdWZXJ0KGNtLmRpc3BsYXkpIC0gZGlzcGxheUhlaWdodChjbSksIHZpZXdwb3J0LnRvcCl9OyB9CiAgICAgICAgLy8gVXBkYXRlZCBsaW5lIGhlaWdodHMgbWlnaHQgcmVzdWx0IGluIHRoZSBkcmF3biBhcmVhIG5vdAogICAgICAgIC8vIGFjdHVhbGx5IGNvdmVyaW5nIHRoZSB2aWV3cG9ydC4gS2VlcCBsb29waW5nIHVudGlsIGl0IGRvZXMuCiAgICAgICAgdXBkYXRlLnZpc2libGUgPSB2aXNpYmxlTGluZXMoY20uZGlzcGxheSwgY20uZG9jLCB2aWV3cG9ydCk7CiAgICAgICAgaWYgKHVwZGF0ZS52aXNpYmxlLmZyb20gPj0gY20uZGlzcGxheS52aWV3RnJvbSAmJiB1cGRhdGUudmlzaWJsZS50byA8PSBjbS5kaXNwbGF5LnZpZXdUbykKICAgICAgICAgIHsgYnJlYWsgfQogICAgICB9CiAgICAgIGlmICghdXBkYXRlRGlzcGxheUlmTmVlZGVkKGNtLCB1cGRhdGUpKSB7IGJyZWFrIH0KICAgICAgdXBkYXRlSGVpZ2h0c0luVmlld3BvcnQoY20pOwogICAgICB2YXIgYmFyTWVhc3VyZSA9IG1lYXN1cmVGb3JTY3JvbGxiYXJzKGNtKTsKICAgICAgdXBkYXRlU2VsZWN0aW9uKGNtKTsKICAgICAgdXBkYXRlU2Nyb2xsYmFycyhjbSwgYmFyTWVhc3VyZSk7CiAgICAgIHNldERvY3VtZW50SGVpZ2h0KGNtLCBiYXJNZWFzdXJlKTsKICAgICAgdXBkYXRlLmZvcmNlID0gZmFsc2U7CiAgICB9CgogICAgdXBkYXRlLnNpZ25hbChjbSwgInVwZGF0ZSIsIGNtKTsKICAgIGlmIChjbS5kaXNwbGF5LnZpZXdGcm9tICE9IGNtLmRpc3BsYXkucmVwb3J0ZWRWaWV3RnJvbSB8fCBjbS5kaXNwbGF5LnZpZXdUbyAhPSBjbS5kaXNwbGF5LnJlcG9ydGVkVmlld1RvKSB7CiAgICAgIHVwZGF0ZS5zaWduYWwoY20sICJ2aWV3cG9ydENoYW5nZSIsIGNtLCBjbS5kaXNwbGF5LnZpZXdGcm9tLCBjbS5kaXNwbGF5LnZpZXdUbyk7CiAgICAgIGNtLmRpc3BsYXkucmVwb3J0ZWRWaWV3RnJvbSA9IGNtLmRpc3BsYXkudmlld0Zyb207IGNtLmRpc3BsYXkucmVwb3J0ZWRWaWV3VG8gPSBjbS5kaXNwbGF5LnZpZXdUbzsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHVwZGF0ZURpc3BsYXlTaW1wbGUoY20sIHZpZXdwb3J0KSB7CiAgICB2YXIgdXBkYXRlID0gbmV3IERpc3BsYXlVcGRhdGUoY20sIHZpZXdwb3J0KTsKICAgIGlmICh1cGRhdGVEaXNwbGF5SWZOZWVkZWQoY20sIHVwZGF0ZSkpIHsKICAgICAgdXBkYXRlSGVpZ2h0c0luVmlld3BvcnQoY20pOwogICAgICBwb3N0VXBkYXRlRGlzcGxheShjbSwgdXBkYXRlKTsKICAgICAgdmFyIGJhck1lYXN1cmUgPSBtZWFzdXJlRm9yU2Nyb2xsYmFycyhjbSk7CiAgICAgIHVwZGF0ZVNlbGVjdGlvbihjbSk7CiAgICAgIHVwZGF0ZVNjcm9sbGJhcnMoY20sIGJhck1lYXN1cmUpOwogICAgICBzZXREb2N1bWVudEhlaWdodChjbSwgYmFyTWVhc3VyZSk7CiAgICAgIHVwZGF0ZS5maW5pc2goKTsKICAgIH0KICB9CgogIC8vIFN5bmMgdGhlIGFjdHVhbCBkaXNwbGF5IERPTSBzdHJ1Y3R1cmUgd2l0aCBkaXNwbGF5LnZpZXcsIHJlbW92aW5nCiAgLy8gbm9kZXMgZm9yIGxpbmVzIHRoYXQgYXJlIG5vIGxvbmdlciBpbiB2aWV3LCBhbmQgY3JlYXRpbmcgdGhlIG9uZXMKICAvLyB0aGF0IGFyZSBub3QgdGhlcmUgeWV0LCBhbmQgdXBkYXRpbmcgdGhlIG9uZXMgdGhhdCBhcmUgb3V0IG9mCiAgLy8gZGF0ZS4KICBmdW5jdGlvbiBwYXRjaERpc3BsYXkoY20sIHVwZGF0ZU51bWJlcnNGcm9tLCBkaW1zKSB7CiAgICB2YXIgZGlzcGxheSA9IGNtLmRpc3BsYXksIGxpbmVOdW1iZXJzID0gY20ub3B0aW9ucy5saW5lTnVtYmVyczsKICAgIHZhciBjb250YWluZXIgPSBkaXNwbGF5LmxpbmVEaXYsIGN1ciA9IGNvbnRhaW5lci5maXJzdENoaWxkOwoKICAgIGZ1bmN0aW9uIHJtKG5vZGUpIHsKICAgICAgdmFyIG5leHQgPSBub2RlLm5leHRTaWJsaW5nOwogICAgICAvLyBXb3JrcyBhcm91bmQgYSB0aHJvdy1zY3JvbGwgYnVnIGluIE9TIFggV2Via2l0CiAgICAgIGlmICh3ZWJraXQgJiYgbWFjICYmIGNtLmRpc3BsYXkuY3VycmVudFdoZWVsVGFyZ2V0ID09IG5vZGUpCiAgICAgICAgeyBub2RlLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7IH0KICAgICAgZWxzZQogICAgICAgIHsgbm9kZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKG5vZGUpOyB9CiAgICAgIHJldHVybiBuZXh0CiAgICB9CgogICAgdmFyIHZpZXcgPSBkaXNwbGF5LnZpZXcsIGxpbmVOID0gZGlzcGxheS52aWV3RnJvbTsKICAgIC8vIExvb3Agb3ZlciB0aGUgZWxlbWVudHMgaW4gdGhlIHZpZXcsIHN5bmNpbmcgY3VyICh0aGUgRE9NIG5vZGVzCiAgICAvLyBpbiBkaXNwbGF5LmxpbmVEaXYpIHdpdGggdGhlIHZpZXcgYXMgd2UgZ28uCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHZpZXcubGVuZ3RoOyBpKyspIHsKICAgICAgdmFyIGxpbmVWaWV3ID0gdmlld1tpXTsKICAgICAgaWYgKGxpbmVWaWV3LmhpZGRlbikgOyBlbHNlIGlmICghbGluZVZpZXcubm9kZSB8fCBsaW5lVmlldy5ub2RlLnBhcmVudE5vZGUgIT0gY29udGFpbmVyKSB7IC8vIE5vdCBkcmF3biB5ZXQKICAgICAgICB2YXIgbm9kZSA9IGJ1aWxkTGluZUVsZW1lbnQoY20sIGxpbmVWaWV3LCBsaW5lTiwgZGltcyk7CiAgICAgICAgY29udGFpbmVyLmluc2VydEJlZm9yZShub2RlLCBjdXIpOwogICAgICB9IGVsc2UgeyAvLyBBbHJlYWR5IGRyYXduCiAgICAgICAgd2hpbGUgKGN1ciAhPSBsaW5lVmlldy5ub2RlKSB7IGN1ciA9IHJtKGN1cik7IH0KICAgICAgICB2YXIgdXBkYXRlTnVtYmVyID0gbGluZU51bWJlcnMgJiYgdXBkYXRlTnVtYmVyc0Zyb20gIT0gbnVsbCAmJgogICAgICAgICAgdXBkYXRlTnVtYmVyc0Zyb20gPD0gbGluZU4gJiYgbGluZVZpZXcubGluZU51bWJlcjsKICAgICAgICBpZiAobGluZVZpZXcuY2hhbmdlcykgewogICAgICAgICAgaWYgKGluZGV4T2YobGluZVZpZXcuY2hhbmdlcywgImd1dHRlciIpID4gLTEpIHsgdXBkYXRlTnVtYmVyID0gZmFsc2U7IH0KICAgICAgICAgIHVwZGF0ZUxpbmVGb3JDaGFuZ2VzKGNtLCBsaW5lVmlldywgbGluZU4sIGRpbXMpOwogICAgICAgIH0KICAgICAgICBpZiAodXBkYXRlTnVtYmVyKSB7CiAgICAgICAgICByZW1vdmVDaGlsZHJlbihsaW5lVmlldy5saW5lTnVtYmVyKTsKICAgICAgICAgIGxpbmVWaWV3LmxpbmVOdW1iZXIuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUobGluZU51bWJlckZvcihjbS5vcHRpb25zLCBsaW5lTikpKTsKICAgICAgICB9CiAgICAgICAgY3VyID0gbGluZVZpZXcubm9kZS5uZXh0U2libGluZzsKICAgICAgfQogICAgICBsaW5lTiArPSBsaW5lVmlldy5zaXplOwogICAgfQogICAgd2hpbGUgKGN1cikgeyBjdXIgPSBybShjdXIpOyB9CiAgfQoKICBmdW5jdGlvbiB1cGRhdGVHdXR0ZXJTcGFjZShkaXNwbGF5KSB7CiAgICB2YXIgd2lkdGggPSBkaXNwbGF5Lmd1dHRlcnMub2Zmc2V0V2lkdGg7CiAgICBkaXNwbGF5LnNpemVyLnN0eWxlLm1hcmdpbkxlZnQgPSB3aWR0aCArICJweCI7CiAgfQoKICBmdW5jdGlvbiBzZXREb2N1bWVudEhlaWdodChjbSwgbWVhc3VyZSkgewogICAgY20uZGlzcGxheS5zaXplci5zdHlsZS5taW5IZWlnaHQgPSBtZWFzdXJlLmRvY0hlaWdodCArICJweCI7CiAgICBjbS5kaXNwbGF5LmhlaWdodEZvcmNlci5zdHlsZS50b3AgPSBtZWFzdXJlLmRvY0hlaWdodCArICJweCI7CiAgICBjbS5kaXNwbGF5Lmd1dHRlcnMuc3R5bGUuaGVpZ2h0ID0gKG1lYXN1cmUuZG9jSGVpZ2h0ICsgY20uZGlzcGxheS5iYXJIZWlnaHQgKyBzY3JvbGxHYXAoY20pKSArICJweCI7CiAgfQoKICAvLyBSZS1hbGlnbiBsaW5lIG51bWJlcnMgYW5kIGd1dHRlciBtYXJrcyB0byBjb21wZW5zYXRlIGZvcgogIC8vIGhvcml6b250YWwgc2Nyb2xsaW5nLgogIGZ1bmN0aW9uIGFsaWduSG9yaXpvbnRhbGx5KGNtKSB7CiAgICB2YXIgZGlzcGxheSA9IGNtLmRpc3BsYXksIHZpZXcgPSBkaXNwbGF5LnZpZXc7CiAgICBpZiAoIWRpc3BsYXkuYWxpZ25XaWRnZXRzICYmICghZGlzcGxheS5ndXR0ZXJzLmZpcnN0Q2hpbGQgfHwgIWNtLm9wdGlvbnMuZml4ZWRHdXR0ZXIpKSB7IHJldHVybiB9CiAgICB2YXIgY29tcCA9IGNvbXBlbnNhdGVGb3JIU2Nyb2xsKGRpc3BsYXkpIC0gZGlzcGxheS5zY3JvbGxlci5zY3JvbGxMZWZ0ICsgY20uZG9jLnNjcm9sbExlZnQ7CiAgICB2YXIgZ3V0dGVyVyA9IGRpc3BsYXkuZ3V0dGVycy5vZmZzZXRXaWR0aCwgbGVmdCA9IGNvbXAgKyAicHgiOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCB2aWV3Lmxlbmd0aDsgaSsrKSB7IGlmICghdmlld1tpXS5oaWRkZW4pIHsKICAgICAgaWYgKGNtLm9wdGlvbnMuZml4ZWRHdXR0ZXIpIHsKICAgICAgICBpZiAodmlld1tpXS5ndXR0ZXIpCiAgICAgICAgICB7IHZpZXdbaV0uZ3V0dGVyLnN0eWxlLmxlZnQgPSBsZWZ0OyB9CiAgICAgICAgaWYgKHZpZXdbaV0uZ3V0dGVyQmFja2dyb3VuZCkKICAgICAgICAgIHsgdmlld1tpXS5ndXR0ZXJCYWNrZ3JvdW5kLnN0eWxlLmxlZnQgPSBsZWZ0OyB9CiAgICAgIH0KICAgICAgdmFyIGFsaWduID0gdmlld1tpXS5hbGlnbmFibGU7CiAgICAgIGlmIChhbGlnbikgeyBmb3IgKHZhciBqID0gMDsgaiA8IGFsaWduLmxlbmd0aDsgaisrKQogICAgICAgIHsgYWxpZ25bal0uc3R5bGUubGVmdCA9IGxlZnQ7IH0gfQogICAgfSB9CiAgICBpZiAoY20ub3B0aW9ucy5maXhlZEd1dHRlcikKICAgICAgeyBkaXNwbGF5Lmd1dHRlcnMuc3R5bGUubGVmdCA9IChjb21wICsgZ3V0dGVyVykgKyAicHgiOyB9CiAgfQoKICAvLyBVc2VkIHRvIGVuc3VyZSB0aGF0IHRoZSBsaW5lIG51bWJlciBndXR0ZXIgaXMgc3RpbGwgdGhlIHJpZ2h0CiAgLy8gc2l6ZSBmb3IgdGhlIGN1cnJlbnQgZG9jdW1lbnQgc2l6ZS4gUmV0dXJucyB0cnVlIHdoZW4gYW4gdXBkYXRlCiAgLy8gaXMgbmVlZGVkLgogIGZ1bmN0aW9uIG1heWJlVXBkYXRlTGluZU51bWJlcldpZHRoKGNtKSB7CiAgICBpZiAoIWNtLm9wdGlvbnMubGluZU51bWJlcnMpIHsgcmV0dXJuIGZhbHNlIH0KICAgIHZhciBkb2MgPSBjbS5kb2MsIGxhc3QgPSBsaW5lTnVtYmVyRm9yKGNtLm9wdGlvbnMsIGRvYy5maXJzdCArIGRvYy5zaXplIC0gMSksIGRpc3BsYXkgPSBjbS5kaXNwbGF5OwogICAgaWYgKGxhc3QubGVuZ3RoICE9IGRpc3BsYXkubGluZU51bUNoYXJzKSB7CiAgICAgIHZhciB0ZXN0ID0gZGlzcGxheS5tZWFzdXJlLmFwcGVuZENoaWxkKGVsdCgiZGl2IiwgW2VsdCgiZGl2IiwgbGFzdCldLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIkNvZGVNaXJyb3ItbGluZW51bWJlciBDb2RlTWlycm9yLWd1dHRlci1lbHQiKSk7CiAgICAgIHZhciBpbm5lclcgPSB0ZXN0LmZpcnN0Q2hpbGQub2Zmc2V0V2lkdGgsIHBhZGRpbmcgPSB0ZXN0Lm9mZnNldFdpZHRoIC0gaW5uZXJXOwogICAgICBkaXNwbGF5LmxpbmVHdXR0ZXIuc3R5bGUud2lkdGggPSAiIjsKICAgICAgZGlzcGxheS5saW5lTnVtSW5uZXJXaWR0aCA9IE1hdGgubWF4KGlubmVyVywgZGlzcGxheS5saW5lR3V0dGVyLm9mZnNldFdpZHRoIC0gcGFkZGluZykgKyAxOwogICAgICBkaXNwbGF5LmxpbmVOdW1XaWR0aCA9IGRpc3BsYXkubGluZU51bUlubmVyV2lkdGggKyBwYWRkaW5nOwogICAgICBkaXNwbGF5LmxpbmVOdW1DaGFycyA9IGRpc3BsYXkubGluZU51bUlubmVyV2lkdGggPyBsYXN0Lmxlbmd0aCA6IC0xOwogICAgICBkaXNwbGF5LmxpbmVHdXR0ZXIuc3R5bGUud2lkdGggPSBkaXNwbGF5LmxpbmVOdW1XaWR0aCArICJweCI7CiAgICAgIHVwZGF0ZUd1dHRlclNwYWNlKGNtLmRpc3BsYXkpOwogICAgICByZXR1cm4gdHJ1ZQogICAgfQogICAgcmV0dXJuIGZhbHNlCiAgfQoKICBmdW5jdGlvbiBnZXRHdXR0ZXJzKGd1dHRlcnMsIGxpbmVOdW1iZXJzKSB7CiAgICB2YXIgcmVzdWx0ID0gW10sIHNhd0xpbmVOdW1iZXJzID0gZmFsc2U7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGd1dHRlcnMubGVuZ3RoOyBpKyspIHsKICAgICAgdmFyIG5hbWUgPSBndXR0ZXJzW2ldLCBzdHlsZSA9IG51bGw7CiAgICAgIGlmICh0eXBlb2YgbmFtZSAhPSAic3RyaW5nIikgeyBzdHlsZSA9IG5hbWUuc3R5bGU7IG5hbWUgPSBuYW1lLmNsYXNzTmFtZTsgfQogICAgICBpZiAobmFtZSA9PSAiQ29kZU1pcnJvci1saW5lbnVtYmVycyIpIHsKICAgICAgICBpZiAoIWxpbmVOdW1iZXJzKSB7IGNvbnRpbnVlIH0KICAgICAgICBlbHNlIHsgc2F3TGluZU51bWJlcnMgPSB0cnVlOyB9CiAgICAgIH0KICAgICAgcmVzdWx0LnB1c2goe2NsYXNzTmFtZTogbmFtZSwgc3R5bGU6IHN0eWxlfSk7CiAgICB9CiAgICBpZiAobGluZU51bWJlcnMgJiYgIXNhd0xpbmVOdW1iZXJzKSB7IHJlc3VsdC5wdXNoKHtjbGFzc05hbWU6ICJDb2RlTWlycm9yLWxpbmVudW1iZXJzIiwgc3R5bGU6IG51bGx9KTsgfQogICAgcmV0dXJuIHJlc3VsdAogIH0KCiAgLy8gUmVidWlsZCB0aGUgZ3V0dGVyIGVsZW1lbnRzLCBlbnN1cmUgdGhlIG1hcmdpbiB0byB0aGUgbGVmdCBvZiB0aGUKICAvLyBjb2RlIG1hdGNoZXMgdGhlaXIgd2lkdGguCiAgZnVuY3Rpb24gcmVuZGVyR3V0dGVycyhkaXNwbGF5KSB7CiAgICB2YXIgZ3V0dGVycyA9IGRpc3BsYXkuZ3V0dGVycywgc3BlY3MgPSBkaXNwbGF5Lmd1dHRlclNwZWNzOwogICAgcmVtb3ZlQ2hpbGRyZW4oZ3V0dGVycyk7CiAgICBkaXNwbGF5LmxpbmVHdXR0ZXIgPSBudWxsOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzcGVjcy5sZW5ndGg7ICsraSkgewogICAgICB2YXIgcmVmID0gc3BlY3NbaV07CiAgICAgIHZhciBjbGFzc05hbWUgPSByZWYuY2xhc3NOYW1lOwogICAgICB2YXIgc3R5bGUgPSByZWYuc3R5bGU7CiAgICAgIHZhciBnRWx0ID0gZ3V0dGVycy5hcHBlbmRDaGlsZChlbHQoImRpdiIsIG51bGwsICJDb2RlTWlycm9yLWd1dHRlciAiICsgY2xhc3NOYW1lKSk7CiAgICAgIGlmIChzdHlsZSkgeyBnRWx0LnN0eWxlLmNzc1RleHQgPSBzdHlsZTsgfQogICAgICBpZiAoY2xhc3NOYW1lID09ICJDb2RlTWlycm9yLWxpbmVudW1iZXJzIikgewogICAgICAgIGRpc3BsYXkubGluZUd1dHRlciA9IGdFbHQ7CiAgICAgICAgZ0VsdC5zdHlsZS53aWR0aCA9IChkaXNwbGF5LmxpbmVOdW1XaWR0aCB8fCAxKSArICJweCI7CiAgICAgIH0KICAgIH0KICAgIGd1dHRlcnMuc3R5bGUuZGlzcGxheSA9IHNwZWNzLmxlbmd0aCA/ICIiIDogIm5vbmUiOwogICAgdXBkYXRlR3V0dGVyU3BhY2UoZGlzcGxheSk7CiAgfQoKICBmdW5jdGlvbiB1cGRhdGVHdXR0ZXJzKGNtKSB7CiAgICByZW5kZXJHdXR0ZXJzKGNtLmRpc3BsYXkpOwogICAgcmVnQ2hhbmdlKGNtKTsKICAgIGFsaWduSG9yaXpvbnRhbGx5KGNtKTsKICB9CgogIC8vIFRoZSBkaXNwbGF5IGhhbmRsZXMgdGhlIERPTSBpbnRlZ3JhdGlvbiwgYm90aCBmb3IgaW5wdXQgcmVhZGluZwogIC8vIGFuZCBjb250ZW50IGRyYXdpbmcuIEl0IGhvbGRzIHJlZmVyZW5jZXMgdG8gRE9NIG5vZGVzIGFuZAogIC8vIGRpc3BsYXktcmVsYXRlZCBzdGF0ZS4KCiAgZnVuY3Rpb24gRGlzcGxheShwbGFjZSwgZG9jLCBpbnB1dCwgb3B0aW9ucykgewogICAgdmFyIGQgPSB0aGlzOwogICAgdGhpcy5pbnB1dCA9IGlucHV0OwoKICAgIC8vIENvdmVycyBib3R0b20tcmlnaHQgc3F1YXJlIHdoZW4gYm90aCBzY3JvbGxiYXJzIGFyZSBwcmVzZW50LgogICAgZC5zY3JvbGxiYXJGaWxsZXIgPSBlbHQoImRpdiIsIG51bGwsICJDb2RlTWlycm9yLXNjcm9sbGJhci1maWxsZXIiKTsKICAgIGQuc2Nyb2xsYmFyRmlsbGVyLnNldEF0dHJpYnV0ZSgiY20tbm90LWNvbnRlbnQiLCAidHJ1ZSIpOwogICAgLy8gQ292ZXJzIGJvdHRvbSBvZiBndXR0ZXIgd2hlbiBjb3Zlckd1dHRlck5leHRUb1Njcm9sbGJhciBpcyBvbgogICAgLy8gYW5kIGggc2Nyb2xsYmFyIGlzIHByZXNlbnQuCiAgICBkLmd1dHRlckZpbGxlciA9IGVsdCgiZGl2IiwgbnVsbCwgIkNvZGVNaXJyb3ItZ3V0dGVyLWZpbGxlciIpOwogICAgZC5ndXR0ZXJGaWxsZXIuc2V0QXR0cmlidXRlKCJjbS1ub3QtY29udGVudCIsICJ0cnVlIik7CiAgICAvLyBXaWxsIGNvbnRhaW4gdGhlIGFjdHVhbCBjb2RlLCBwb3NpdGlvbmVkIHRvIGNvdmVyIHRoZSB2aWV3cG9ydC4KICAgIGQubGluZURpdiA9IGVsdFAoImRpdiIsIG51bGwsICJDb2RlTWlycm9yLWNvZGUiKTsKICAgIC8vIEVsZW1lbnRzIGFyZSBhZGRlZCB0byB0aGVzZSB0byByZXByZXNlbnQgc2VsZWN0aW9uIGFuZCBjdXJzb3JzLgogICAgZC5zZWxlY3Rpb25EaXYgPSBlbHQoImRpdiIsIG51bGwsIG51bGwsICJwb3NpdGlvbjogcmVsYXRpdmU7IHotaW5kZXg6IDEiKTsKICAgIGQuY3Vyc29yRGl2ID0gZWx0KCJkaXYiLCBudWxsLCAiQ29kZU1pcnJvci1jdXJzb3JzIik7CiAgICAvLyBBIHZpc2liaWxpdHk6IGhpZGRlbiBlbGVtZW50IHVzZWQgdG8gZmluZCB0aGUgc2l6ZSBvZiB0aGluZ3MuCiAgICBkLm1lYXN1cmUgPSBlbHQoImRpdiIsIG51bGwsICJDb2RlTWlycm9yLW1lYXN1cmUiKTsKICAgIC8vIFdoZW4gbGluZXMgb3V0c2lkZSBvZiB0aGUgdmlld3BvcnQgYXJlIG1lYXN1cmVkLCB0aGV5IGFyZSBkcmF3biBpbiB0aGlzLgogICAgZC5saW5lTWVhc3VyZSA9IGVsdCgiZGl2IiwgbnVsbCwgIkNvZGVNaXJyb3ItbWVhc3VyZSIpOwogICAgLy8gV3JhcHMgZXZlcnl0aGluZyB0aGF0IG5lZWRzIHRvIGV4aXN0IGluc2lkZSB0aGUgdmVydGljYWxseS1wYWRkZWQgY29vcmRpbmF0ZSBzeXN0ZW0KICAgIGQubGluZVNwYWNlID0gZWx0UCgiZGl2IiwgW2QubWVhc3VyZSwgZC5saW5lTWVhc3VyZSwgZC5zZWxlY3Rpb25EaXYsIGQuY3Vyc29yRGl2LCBkLmxpbmVEaXZdLAogICAgICAgICAgICAgICAgICAgICAgbnVsbCwgInBvc2l0aW9uOiByZWxhdGl2ZTsgb3V0bGluZTogbm9uZSIpOwogICAgdmFyIGxpbmVzID0gZWx0UCgiZGl2IiwgW2QubGluZVNwYWNlXSwgIkNvZGVNaXJyb3ItbGluZXMiKTsKICAgIC8vIE1vdmVkIGFyb3VuZCBpdHMgcGFyZW50IHRvIGNvdmVyIHZpc2libGUgdmlldy4KICAgIGQubW92ZXIgPSBlbHQoImRpdiIsIFtsaW5lc10sIG51bGwsICJwb3NpdGlvbjogcmVsYXRpdmUiKTsKICAgIC8vIFNldCB0byB0aGUgaGVpZ2h0IG9mIHRoZSBkb2N1bWVudCwgYWxsb3dpbmcgc2Nyb2xsaW5nLgogICAgZC5zaXplciA9IGVsdCgiZGl2IiwgW2QubW92ZXJdLCAiQ29kZU1pcnJvci1zaXplciIpOwogICAgZC5zaXplcldpZHRoID0gbnVsbDsKICAgIC8vIEJlaGF2aW9yIG9mIGVsdHMgd2l0aCBvdmVyZmxvdzogYXV0byBhbmQgcGFkZGluZyBpcwogICAgLy8gaW5jb25zaXN0ZW50IGFjcm9zcyBicm93c2Vycy4gVGhpcyBpcyB1c2VkIHRvIGVuc3VyZSB0aGUKICAgIC8vIHNjcm9sbGFibGUgYXJlYSBpcyBiaWcgZW5vdWdoLgogICAgZC5oZWlnaHRGb3JjZXIgPSBlbHQoImRpdiIsIG51bGwsIG51bGwsICJwb3NpdGlvbjogYWJzb2x1dGU7IGhlaWdodDogIiArIHNjcm9sbGVyR2FwICsgInB4OyB3aWR0aDogMXB4OyIpOwogICAgLy8gV2lsbCBjb250YWluIHRoZSBndXR0ZXJzLCBpZiBhbnkuCiAgICBkLmd1dHRlcnMgPSBlbHQoImRpdiIsIG51bGwsICJDb2RlTWlycm9yLWd1dHRlcnMiKTsKICAgIGQubGluZUd1dHRlciA9IG51bGw7CiAgICAvLyBBY3R1YWwgc2Nyb2xsYWJsZSBlbGVtZW50LgogICAgZC5zY3JvbGxlciA9IGVsdCgiZGl2IiwgW2Quc2l6ZXIsIGQuaGVpZ2h0Rm9yY2VyLCBkLmd1dHRlcnNdLCAiQ29kZU1pcnJvci1zY3JvbGwiKTsKICAgIGQuc2Nyb2xsZXIuc2V0QXR0cmlidXRlKCJ0YWJJbmRleCIsICItMSIpOwogICAgLy8gVGhlIGVsZW1lbnQgaW4gd2hpY2ggdGhlIGVkaXRvciBsaXZlcy4KICAgIGQud3JhcHBlciA9IGVsdCgiZGl2IiwgW2Quc2Nyb2xsYmFyRmlsbGVyLCBkLmd1dHRlckZpbGxlciwgZC5zY3JvbGxlcl0sICJDb2RlTWlycm9yIik7CgogICAgLy8gV29yayBhcm91bmQgSUU3IHotaW5kZXggYnVnIChub3QgcGVyZmVjdCwgaGVuY2UgSUU3IG5vdCByZWFsbHkgYmVpbmcgc3VwcG9ydGVkKQogICAgaWYgKGllICYmIGllX3ZlcnNpb24gPCA4KSB7IGQuZ3V0dGVycy5zdHlsZS56SW5kZXggPSAtMTsgZC5zY3JvbGxlci5zdHlsZS5wYWRkaW5nUmlnaHQgPSAwOyB9CiAgICBpZiAoIXdlYmtpdCAmJiAhKGdlY2tvICYmIG1vYmlsZSkpIHsgZC5zY3JvbGxlci5kcmFnZ2FibGUgPSB0cnVlOyB9CgogICAgaWYgKHBsYWNlKSB7CiAgICAgIGlmIChwbGFjZS5hcHBlbmRDaGlsZCkgeyBwbGFjZS5hcHBlbmRDaGlsZChkLndyYXBwZXIpOyB9CiAgICAgIGVsc2UgeyBwbGFjZShkLndyYXBwZXIpOyB9CiAgICB9CgogICAgLy8gQ3VycmVudCByZW5kZXJlZCByYW5nZSAobWF5IGJlIGJpZ2dlciB0aGFuIHRoZSB2aWV3IHdpbmRvdykuCiAgICBkLnZpZXdGcm9tID0gZC52aWV3VG8gPSBkb2MuZmlyc3Q7CiAgICBkLnJlcG9ydGVkVmlld0Zyb20gPSBkLnJlcG9ydGVkVmlld1RvID0gZG9jLmZpcnN0OwogICAgLy8gSW5mb3JtYXRpb24gYWJvdXQgdGhlIHJlbmRlcmVkIGxpbmVzLgogICAgZC52aWV3ID0gW107CiAgICBkLnJlbmRlcmVkVmlldyA9IG51bGw7CiAgICAvLyBIb2xkcyBpbmZvIGFib3V0IGEgc2luZ2xlIHJlbmRlcmVkIGxpbmUgd2hlbiBpdCB3YXMgcmVuZGVyZWQKICAgIC8vIGZvciBtZWFzdXJlbWVudCwgd2hpbGUgbm90IGluIHZpZXcuCiAgICBkLmV4dGVybmFsTWVhc3VyZWQgPSBudWxsOwogICAgLy8gRW1wdHkgc3BhY2UgKGluIHBpeGVscykgYWJvdmUgdGhlIHZpZXcKICAgIGQudmlld09mZnNldCA9IDA7CiAgICBkLmxhc3RXcmFwSGVpZ2h0ID0gZC5sYXN0V3JhcFdpZHRoID0gMDsKICAgIGQudXBkYXRlTGluZU51bWJlcnMgPSBudWxsOwoKICAgIGQubmF0aXZlQmFyV2lkdGggPSBkLmJhckhlaWdodCA9IGQuYmFyV2lkdGggPSAwOwogICAgZC5zY3JvbGxiYXJzQ2xpcHBlZCA9IGZhbHNlOwoKICAgIC8vIFVzZWQgdG8gb25seSByZXNpemUgdGhlIGxpbmUgbnVtYmVyIGd1dHRlciB3aGVuIG5lY2Vzc2FyeSAod2hlbgogICAgLy8gdGhlIGFtb3VudCBvZiBsaW5lcyBjcm9zc2VzIGEgYm91bmRhcnkgdGhhdCBtYWtlcyBpdHMgd2lkdGggY2hhbmdlKQogICAgZC5saW5lTnVtV2lkdGggPSBkLmxpbmVOdW1Jbm5lcldpZHRoID0gZC5saW5lTnVtQ2hhcnMgPSBudWxsOwogICAgLy8gU2V0IHRvIHRydWUgd2hlbiBhIG5vbi1ob3Jpem9udGFsLXNjcm9sbGluZyBsaW5lIHdpZGdldCBpcwogICAgLy8gYWRkZWQuIEFzIGFuIG9wdGltaXphdGlvbiwgbGluZSB3aWRnZXQgYWxpZ25pbmcgaXMgc2tpcHBlZCB3aGVuCiAgICAvLyB0aGlzIGlzIGZhbHNlLgogICAgZC5hbGlnbldpZGdldHMgPSBmYWxzZTsKCiAgICBkLmNhY2hlZENoYXJXaWR0aCA9IGQuY2FjaGVkVGV4dEhlaWdodCA9IGQuY2FjaGVkUGFkZGluZ0ggPSBudWxsOwoKICAgIC8vIFRyYWNrcyB0aGUgbWF4aW11bSBsaW5lIGxlbmd0aCBzbyB0aGF0IHRoZSBob3Jpem9udGFsIHNjcm9sbGJhcgogICAgLy8gY2FuIGJlIGtlcHQgc3RhdGljIHdoZW4gc2Nyb2xsaW5nLgogICAgZC5tYXhMaW5lID0gbnVsbDsKICAgIGQubWF4TGluZUxlbmd0aCA9IDA7CiAgICBkLm1heExpbmVDaGFuZ2VkID0gZmFsc2U7CgogICAgLy8gVXNlZCBmb3IgbWVhc3VyaW5nIHdoZWVsIHNjcm9sbGluZyBncmFudWxhcml0eQogICAgZC53aGVlbERYID0gZC53aGVlbERZID0gZC53aGVlbFN0YXJ0WCA9IGQud2hlZWxTdGFydFkgPSBudWxsOwoKICAgIC8vIFRydWUgd2hlbiBzaGlmdCBpcyBoZWxkIGRvd24uCiAgICBkLnNoaWZ0ID0gZmFsc2U7CgogICAgLy8gVXNlZCB0byB0cmFjayB3aGV0aGVyIGFueXRoaW5nIGhhcHBlbmVkIHNpbmNlIHRoZSBjb250ZXh0IG1lbnUKICAgIC8vIHdhcyBvcGVuZWQuCiAgICBkLnNlbEZvckNvbnRleHRNZW51ID0gbnVsbDsKCiAgICBkLmFjdGl2ZVRvdWNoID0gbnVsbDsKCiAgICBkLmd1dHRlclNwZWNzID0gZ2V0R3V0dGVycyhvcHRpb25zLmd1dHRlcnMsIG9wdGlvbnMubGluZU51bWJlcnMpOwogICAgcmVuZGVyR3V0dGVycyhkKTsKCiAgICBpbnB1dC5pbml0KGQpOwogIH0KCiAgLy8gU2luY2UgdGhlIGRlbHRhIHZhbHVlcyByZXBvcnRlZCBvbiBtb3VzZSB3aGVlbCBldmVudHMgYXJlCiAgLy8gdW5zdGFuZGFyZGl6ZWQgYmV0d2VlbiBicm93c2VycyBhbmQgZXZlbiBicm93c2VyIHZlcnNpb25zLCBhbmQKICAvLyBnZW5lcmFsbHkgaG9ycmlibHkgdW5wcmVkaWN0YWJsZSwgdGhpcyBjb2RlIHN0YXJ0cyBieSBtZWFzdXJpbmcKICAvLyB0aGUgc2Nyb2xsIGVmZmVjdCB0aGF0IHRoZSBmaXJzdCBmZXcgbW91c2Ugd2hlZWwgZXZlbnRzIGhhdmUsCiAgLy8gYW5kLCBmcm9tIHRoYXQsIGRldGVjdHMgdGhlIHdheSBpdCBjYW4gY29udmVydCBkZWx0YXMgdG8gcGl4ZWwKICAvLyBvZmZzZXRzIGFmdGVyd2FyZHMuCiAgLy8KICAvLyBUaGUgcmVhc29uIHdlIHdhbnQgdG8ga25vdyB0aGUgYW1vdW50IGEgd2hlZWwgZXZlbnQgd2lsbCBzY3JvbGwKICAvLyBpcyB0aGF0IGl0IGdpdmVzIHVzIGEgY2hhbmNlIHRvIHVwZGF0ZSB0aGUgZGlzcGxheSBiZWZvcmUgdGhlCiAgLy8gYWN0dWFsIHNjcm9sbGluZyBoYXBwZW5zLCByZWR1Y2luZyBmbGlja2VyaW5nLgoKICB2YXIgd2hlZWxTYW1wbGVzID0gMCwgd2hlZWxQaXhlbHNQZXJVbml0ID0gbnVsbDsKICAvLyBGaWxsIGluIGEgYnJvd3Nlci1kZXRlY3RlZCBzdGFydGluZyB2YWx1ZSBvbiBicm93c2VycyB3aGVyZSB3ZQogIC8vIGtub3cgb25lLiBUaGVzZSBkb24ndCBoYXZlIHRvIGJlIGFjY3VyYXRlIC0tIHRoZSByZXN1bHQgb2YgdGhlbQogIC8vIGJlaW5nIHdyb25nIHdvdWxkIGp1c3QgYmUgYSBzbGlnaHQgZmxpY2tlciBvbiB0aGUgZmlyc3Qgd2hlZWwKICAvLyBzY3JvbGwgKGlmIGl0IGlzIGxhcmdlIGVub3VnaCkuCiAgaWYgKGllKSB7IHdoZWVsUGl4ZWxzUGVyVW5pdCA9IC0uNTM7IH0KICBlbHNlIGlmIChnZWNrbykgeyB3aGVlbFBpeGVsc1BlclVuaXQgPSAxNTsgfQogIGVsc2UgaWYgKGNocm9tZSkgeyB3aGVlbFBpeGVsc1BlclVuaXQgPSAtLjc7IH0KICBlbHNlIGlmIChzYWZhcmkpIHsgd2hlZWxQaXhlbHNQZXJVbml0ID0gLTEvMzsgfQoKICBmdW5jdGlvbiB3aGVlbEV2ZW50RGVsdGEoZSkgewogICAgdmFyIGR4ID0gZS53aGVlbERlbHRhWCwgZHkgPSBlLndoZWVsRGVsdGFZOwogICAgaWYgKGR4ID09IG51bGwgJiYgZS5kZXRhaWwgJiYgZS5heGlzID09IGUuSE9SSVpPTlRBTF9BWElTKSB7IGR4ID0gZS5kZXRhaWw7IH0KICAgIGlmIChkeSA9PSBudWxsICYmIGUuZGV0YWlsICYmIGUuYXhpcyA9PSBlLlZFUlRJQ0FMX0FYSVMpIHsgZHkgPSBlLmRldGFpbDsgfQogICAgZWxzZSBpZiAoZHkgPT0gbnVsbCkgeyBkeSA9IGUud2hlZWxEZWx0YTsgfQogICAgcmV0dXJuIHt4OiBkeCwgeTogZHl9CiAgfQogIGZ1bmN0aW9uIHdoZWVsRXZlbnRQaXhlbHMoZSkgewogICAgdmFyIGRlbHRhID0gd2hlZWxFdmVudERlbHRhKGUpOwogICAgZGVsdGEueCAqPSB3aGVlbFBpeGVsc1BlclVuaXQ7CiAgICBkZWx0YS55ICo9IHdoZWVsUGl4ZWxzUGVyVW5pdDsKICAgIHJldHVybiBkZWx0YQogIH0KCiAgZnVuY3Rpb24gb25TY3JvbGxXaGVlbChjbSwgZSkgewogICAgdmFyIGRlbHRhID0gd2hlZWxFdmVudERlbHRhKGUpLCBkeCA9IGRlbHRhLngsIGR5ID0gZGVsdGEueTsKCiAgICB2YXIgZGlzcGxheSA9IGNtLmRpc3BsYXksIHNjcm9sbCA9IGRpc3BsYXkuc2Nyb2xsZXI7CiAgICAvLyBRdWl0IGlmIHRoZXJlJ3Mgbm90aGluZyB0byBzY3JvbGwgaGVyZQogICAgdmFyIGNhblNjcm9sbFggPSBzY3JvbGwuc2Nyb2xsV2lkdGggPiBzY3JvbGwuY2xpZW50V2lkdGg7CiAgICB2YXIgY2FuU2Nyb2xsWSA9IHNjcm9sbC5zY3JvbGxIZWlnaHQgPiBzY3JvbGwuY2xpZW50SGVpZ2h0OwogICAgaWYgKCEoZHggJiYgY2FuU2Nyb2xsWCB8fCBkeSAmJiBjYW5TY3JvbGxZKSkgeyByZXR1cm4gfQoKICAgIC8vIFdlYmtpdCBicm93c2VycyBvbiBPUyBYIGFib3J0IG1vbWVudHVtIHNjcm9sbHMgd2hlbiB0aGUgdGFyZ2V0CiAgICAvLyBvZiB0aGUgc2Nyb2xsIGV2ZW50IGlzIHJlbW92ZWQgZnJvbSB0aGUgc2Nyb2xsYWJsZSBlbGVtZW50LgogICAgLy8gVGhpcyBoYWNrIChzZWUgcmVsYXRlZCBjb2RlIGluIHBhdGNoRGlzcGxheSkgbWFrZXMgc3VyZSB0aGUKICAgIC8vIGVsZW1lbnQgaXMga2VwdCBhcm91bmQuCiAgICBpZiAoZHkgJiYgbWFjICYmIHdlYmtpdCkgewogICAgICBvdXRlcjogZm9yICh2YXIgY3VyID0gZS50YXJnZXQsIHZpZXcgPSBkaXNwbGF5LnZpZXc7IGN1ciAhPSBzY3JvbGw7IGN1ciA9IGN1ci5wYXJlbnROb2RlKSB7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB2aWV3Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBpZiAodmlld1tpXS5ub2RlID09IGN1cikgewogICAgICAgICAgICBjbS5kaXNwbGF5LmN1cnJlbnRXaGVlbFRhcmdldCA9IGN1cjsKICAgICAgICAgICAgYnJlYWsgb3V0ZXIKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICAvLyBPbiBzb21lIGJyb3dzZXJzLCBob3Jpem9udGFsIHNjcm9sbGluZyB3aWxsIGNhdXNlIHJlZHJhd3MgdG8KICAgIC8vIGhhcHBlbiBiZWZvcmUgdGhlIGd1dHRlciBoYXMgYmVlbiByZWFsaWduZWQsIGNhdXNpbmcgaXQgdG8KICAgIC8vIHdyaWdnbGUgYXJvdW5kIGluIGEgbW9zdCB1bnNlZW1seSB3YXkuIFdoZW4gd2UgaGF2ZSBhbgogICAgLy8gZXN0aW1hdGVkIHBpeGVscy9kZWx0YSB2YWx1ZSwgd2UganVzdCBoYW5kbGUgaG9yaXpvbnRhbAogICAgLy8gc2Nyb2xsaW5nIGVudGlyZWx5IGhlcmUuIEl0J2xsIGJlIHNsaWdodGx5IG9mZiBmcm9tIG5hdGl2ZSwgYnV0CiAgICAvLyBiZXR0ZXIgdGhhbiBnbGl0Y2hpbmcgb3V0LgogICAgaWYgKGR4ICYmICFnZWNrbyAmJiAhcHJlc3RvICYmIHdoZWVsUGl4ZWxzUGVyVW5pdCAhPSBudWxsKSB7CiAgICAgIGlmIChkeSAmJiBjYW5TY3JvbGxZKQogICAgICAgIHsgdXBkYXRlU2Nyb2xsVG9wKGNtLCBNYXRoLm1heCgwLCBzY3JvbGwuc2Nyb2xsVG9wICsgZHkgKiB3aGVlbFBpeGVsc1BlclVuaXQpKTsgfQogICAgICBzZXRTY3JvbGxMZWZ0KGNtLCBNYXRoLm1heCgwLCBzY3JvbGwuc2Nyb2xsTGVmdCArIGR4ICogd2hlZWxQaXhlbHNQZXJVbml0KSk7CiAgICAgIC8vIE9ubHkgcHJldmVudCBkZWZhdWx0IHNjcm9sbGluZyBpZiB2ZXJ0aWNhbCBzY3JvbGxpbmcgaXMKICAgICAgLy8gYWN0dWFsbHkgcG9zc2libGUuIE90aGVyd2lzZSwgaXQgY2F1c2VzIHZlcnRpY2FsIHNjcm9sbAogICAgICAvLyBqaXR0ZXIgb24gT1NYIHRyYWNrcGFkcyB3aGVuIGRlbHRhWCBpcyBzbWFsbCBhbmQgZGVsdGFZCiAgICAgIC8vIGlzIGxhcmdlIChpc3N1ZSAjMzU3OSkKICAgICAgaWYgKCFkeSB8fCAoZHkgJiYgY2FuU2Nyb2xsWSkpCiAgICAgICAgeyBlX3ByZXZlbnREZWZhdWx0KGUpOyB9CiAgICAgIGRpc3BsYXkud2hlZWxTdGFydFggPSBudWxsOyAvLyBBYm9ydCBtZWFzdXJlbWVudCwgaWYgaW4gcHJvZ3Jlc3MKICAgICAgcmV0dXJuCiAgICB9CgogICAgLy8gJ1Byb2plY3QnIHRoZSB2aXNpYmxlIHZpZXdwb3J0IHRvIGNvdmVyIHRoZSBhcmVhIHRoYXQgaXMgYmVpbmcKICAgIC8vIHNjcm9sbGVkIGludG8gdmlldyAoaWYgd2Uga25vdyBlbm91Z2ggdG8gZXN0aW1hdGUgaXQpLgogICAgaWYgKGR5ICYmIHdoZWVsUGl4ZWxzUGVyVW5pdCAhPSBudWxsKSB7CiAgICAgIHZhciBwaXhlbHMgPSBkeSAqIHdoZWVsUGl4ZWxzUGVyVW5pdDsKICAgICAgdmFyIHRvcCA9IGNtLmRvYy5zY3JvbGxUb3AsIGJvdCA9IHRvcCArIGRpc3BsYXkud3JhcHBlci5jbGllbnRIZWlnaHQ7CiAgICAgIGlmIChwaXhlbHMgPCAwKSB7IHRvcCA9IE1hdGgubWF4KDAsIHRvcCArIHBpeGVscyAtIDUwKTsgfQogICAgICBlbHNlIHsgYm90ID0gTWF0aC5taW4oY20uZG9jLmhlaWdodCwgYm90ICsgcGl4ZWxzICsgNTApOyB9CiAgICAgIHVwZGF0ZURpc3BsYXlTaW1wbGUoY20sIHt0b3A6IHRvcCwgYm90dG9tOiBib3R9KTsKICAgIH0KCiAgICBpZiAod2hlZWxTYW1wbGVzIDwgMjApIHsKICAgICAgaWYgKGRpc3BsYXkud2hlZWxTdGFydFggPT0gbnVsbCkgewogICAgICAgIGRpc3BsYXkud2hlZWxTdGFydFggPSBzY3JvbGwuc2Nyb2xsTGVmdDsgZGlzcGxheS53aGVlbFN0YXJ0WSA9IHNjcm9sbC5zY3JvbGxUb3A7CiAgICAgICAgZGlzcGxheS53aGVlbERYID0gZHg7IGRpc3BsYXkud2hlZWxEWSA9IGR5OwogICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgaWYgKGRpc3BsYXkud2hlZWxTdGFydFggPT0gbnVsbCkgeyByZXR1cm4gfQogICAgICAgICAgdmFyIG1vdmVkWCA9IHNjcm9sbC5zY3JvbGxMZWZ0IC0gZGlzcGxheS53aGVlbFN0YXJ0WDsKICAgICAgICAgIHZhciBtb3ZlZFkgPSBzY3JvbGwuc2Nyb2xsVG9wIC0gZGlzcGxheS53aGVlbFN0YXJ0WTsKICAgICAgICAgIHZhciBzYW1wbGUgPSAobW92ZWRZICYmIGRpc3BsYXkud2hlZWxEWSAmJiBtb3ZlZFkgLyBkaXNwbGF5LndoZWVsRFkpIHx8CiAgICAgICAgICAgIChtb3ZlZFggJiYgZGlzcGxheS53aGVlbERYICYmIG1vdmVkWCAvIGRpc3BsYXkud2hlZWxEWCk7CiAgICAgICAgICBkaXNwbGF5LndoZWVsU3RhcnRYID0gZGlzcGxheS53aGVlbFN0YXJ0WSA9IG51bGw7CiAgICAgICAgICBpZiAoIXNhbXBsZSkgeyByZXR1cm4gfQogICAgICAgICAgd2hlZWxQaXhlbHNQZXJVbml0ID0gKHdoZWVsUGl4ZWxzUGVyVW5pdCAqIHdoZWVsU2FtcGxlcyArIHNhbXBsZSkgLyAod2hlZWxTYW1wbGVzICsgMSk7CiAgICAgICAgICArK3doZWVsU2FtcGxlczsKICAgICAgICB9LCAyMDApOwogICAgICB9IGVsc2UgewogICAgICAgIGRpc3BsYXkud2hlZWxEWCArPSBkeDsgZGlzcGxheS53aGVlbERZICs9IGR5OwogICAgICB9CiAgICB9CiAgfQoKICAvLyBTZWxlY3Rpb24gb2JqZWN0cyBhcmUgaW1tdXRhYmxlLiBBIG5ldyBvbmUgaXMgY3JlYXRlZCBldmVyeSB0aW1lCiAgLy8gdGhlIHNlbGVjdGlvbiBjaGFuZ2VzLiBBIHNlbGVjdGlvbiBpcyBvbmUgb3IgbW9yZSBub24tb3ZlcmxhcHBpbmcKICAvLyAoYW5kIG5vbi10b3VjaGluZykgcmFuZ2VzLCBzb3J0ZWQsIGFuZCBhbiBpbnRlZ2VyIHRoYXQgaW5kaWNhdGVzCiAgLy8gd2hpY2ggb25lIGlzIHRoZSBwcmltYXJ5IHNlbGVjdGlvbiAodGhlIG9uZSB0aGF0J3Mgc2Nyb2xsZWQgaW50bwogIC8vIHZpZXcsIHRoYXQgZ2V0Q3Vyc29yIHJldHVybnMsIGV0YykuCiAgdmFyIFNlbGVjdGlvbiA9IGZ1bmN0aW9uKHJhbmdlcywgcHJpbUluZGV4KSB7CiAgICB0aGlzLnJhbmdlcyA9IHJhbmdlczsKICAgIHRoaXMucHJpbUluZGV4ID0gcHJpbUluZGV4OwogIH07CgogIFNlbGVjdGlvbi5wcm90b3R5cGUucHJpbWFyeSA9IGZ1bmN0aW9uICgpIHsgcmV0dXJuIHRoaXMucmFuZ2VzW3RoaXMucHJpbUluZGV4XSB9OwoKICBTZWxlY3Rpb24ucHJvdG90eXBlLmVxdWFscyA9IGZ1bmN0aW9uIChvdGhlcikgewogICAgICB2YXIgdGhpcyQxID0gdGhpczsKCiAgICBpZiAob3RoZXIgPT0gdGhpcykgeyByZXR1cm4gdHJ1ZSB9CiAgICBpZiAob3RoZXIucHJpbUluZGV4ICE9IHRoaXMucHJpbUluZGV4IHx8IG90aGVyLnJhbmdlcy5sZW5ndGggIT0gdGhpcy5yYW5nZXMubGVuZ3RoKSB7IHJldHVybiBmYWxzZSB9CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMucmFuZ2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBoZXJlID0gdGhpcyQxLnJhbmdlc1tpXSwgdGhlcmUgPSBvdGhlci5yYW5nZXNbaV07CiAgICAgIGlmICghZXF1YWxDdXJzb3JQb3MoaGVyZS5hbmNob3IsIHRoZXJlLmFuY2hvcikgfHwgIWVxdWFsQ3Vyc29yUG9zKGhlcmUuaGVhZCwgdGhlcmUuaGVhZCkpIHsgcmV0dXJuIGZhbHNlIH0KICAgIH0KICAgIHJldHVybiB0cnVlCiAgfTsKCiAgU2VsZWN0aW9uLnByb3RvdHlwZS5kZWVwQ29weSA9IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIHRoaXMkMSA9IHRoaXM7CgogICAgdmFyIG91dCA9IFtdOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLnJhbmdlcy5sZW5ndGg7IGkrKykKICAgICAgeyBvdXRbaV0gPSBuZXcgUmFuZ2UoY29weVBvcyh0aGlzJDEucmFuZ2VzW2ldLmFuY2hvciksIGNvcHlQb3ModGhpcyQxLnJhbmdlc1tpXS5oZWFkKSk7IH0KICAgIHJldHVybiBuZXcgU2VsZWN0aW9uKG91dCwgdGhpcy5wcmltSW5kZXgpCiAgfTsKCiAgU2VsZWN0aW9uLnByb3RvdHlwZS5zb21ldGhpbmdTZWxlY3RlZCA9IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIHRoaXMkMSA9IHRoaXM7CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLnJhbmdlcy5sZW5ndGg7IGkrKykKICAgICAgeyBpZiAoIXRoaXMkMS5yYW5nZXNbaV0uZW1wdHkoKSkgeyByZXR1cm4gdHJ1ZSB9IH0KICAgIHJldHVybiBmYWxzZQogIH07CgogIFNlbGVjdGlvbi5wcm90b3R5cGUuY29udGFpbnMgPSBmdW5jdGlvbiAocG9zLCBlbmQpIHsKICAgICAgdmFyIHRoaXMkMSA9IHRoaXM7CgogICAgaWYgKCFlbmQpIHsgZW5kID0gcG9zOyB9CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMucmFuZ2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciByYW5nZSA9IHRoaXMkMS5yYW5nZXNbaV07CiAgICAgIGlmIChjbXAoZW5kLCByYW5nZS5mcm9tKCkpID49IDAgJiYgY21wKHBvcywgcmFuZ2UudG8oKSkgPD0gMCkKICAgICAgICB7IHJldHVybiBpIH0KICAgIH0KICAgIHJldHVybiAtMQogIH07CgogIHZhciBSYW5nZSA9IGZ1bmN0aW9uKGFuY2hvciwgaGVhZCkgewogICAgdGhpcy5hbmNob3IgPSBhbmNob3I7IHRoaXMuaGVhZCA9IGhlYWQ7CiAgfTsKCiAgUmFuZ2UucHJvdG90eXBlLmZyb20gPSBmdW5jdGlvbiAoKSB7IHJldHVybiBtaW5Qb3ModGhpcy5hbmNob3IsIHRoaXMuaGVhZCkgfTsKICBSYW5nZS5wcm90b3R5cGUudG8gPSBmdW5jdGlvbiAoKSB7IHJldHVybiBtYXhQb3ModGhpcy5hbmNob3IsIHRoaXMuaGVhZCkgfTsKICBSYW5nZS5wcm90b3R5cGUuZW1wdHkgPSBmdW5jdGlvbiAoKSB7IHJldHVybiB0aGlzLmhlYWQubGluZSA9PSB0aGlzLmFuY2hvci5saW5lICYmIHRoaXMuaGVhZC5jaCA9PSB0aGlzLmFuY2hvci5jaCB9OwoKICAvLyBUYWtlIGFuIHVuc29ydGVkLCBwb3RlbnRpYWxseSBvdmVybGFwcGluZyBzZXQgb2YgcmFuZ2VzLCBhbmQKICAvLyBidWlsZCBhIHNlbGVjdGlvbiBvdXQgb2YgaXQuICdDb25zdW1lcycgcmFuZ2VzIGFycmF5IChtb2RpZnlpbmcKICAvLyBpdCkuCiAgZnVuY3Rpb24gbm9ybWFsaXplU2VsZWN0aW9uKGNtLCByYW5nZXMsIHByaW1JbmRleCkgewogICAgdmFyIG1heVRvdWNoID0gY20gJiYgY20ub3B0aW9ucy5zZWxlY3Rpb25zTWF5VG91Y2g7CiAgICB2YXIgcHJpbSA9IHJhbmdlc1twcmltSW5kZXhdOwogICAgcmFuZ2VzLnNvcnQoZnVuY3Rpb24gKGEsIGIpIHsgcmV0dXJuIGNtcChhLmZyb20oKSwgYi5mcm9tKCkpOyB9KTsKICAgIHByaW1JbmRleCA9IGluZGV4T2YocmFuZ2VzLCBwcmltKTsKICAgIGZvciAodmFyIGkgPSAxOyBpIDwgcmFuZ2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBjdXIgPSByYW5nZXNbaV0sIHByZXYgPSByYW5nZXNbaSAtIDFdOwogICAgICB2YXIgZGlmZiA9IGNtcChwcmV2LnRvKCksIGN1ci5mcm9tKCkpOwogICAgICBpZiAobWF5VG91Y2ggJiYgIWN1ci5lbXB0eSgpID8gZGlmZiA+IDAgOiBkaWZmID49IDApIHsKICAgICAgICB2YXIgZnJvbSA9IG1pblBvcyhwcmV2LmZyb20oKSwgY3VyLmZyb20oKSksIHRvID0gbWF4UG9zKHByZXYudG8oKSwgY3VyLnRvKCkpOwogICAgICAgIHZhciBpbnYgPSBwcmV2LmVtcHR5KCkgPyBjdXIuZnJvbSgpID09IGN1ci5oZWFkIDogcHJldi5mcm9tKCkgPT0gcHJldi5oZWFkOwogICAgICAgIGlmIChpIDw9IHByaW1JbmRleCkgeyAtLXByaW1JbmRleDsgfQogICAgICAgIHJhbmdlcy5zcGxpY2UoLS1pLCAyLCBuZXcgUmFuZ2UoaW52ID8gdG8gOiBmcm9tLCBpbnYgPyBmcm9tIDogdG8pKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIG5ldyBTZWxlY3Rpb24ocmFuZ2VzLCBwcmltSW5kZXgpCiAgfQoKICBmdW5jdGlvbiBzaW1wbGVTZWxlY3Rpb24oYW5jaG9yLCBoZWFkKSB7CiAgICByZXR1cm4gbmV3IFNlbGVjdGlvbihbbmV3IFJhbmdlKGFuY2hvciwgaGVhZCB8fCBhbmNob3IpXSwgMCkKICB9CgogIC8vIENvbXB1dGUgdGhlIHBvc2l0aW9uIG9mIHRoZSBlbmQgb2YgYSBjaGFuZ2UgKGl0cyAndG8nIHByb3BlcnR5CiAgLy8gcmVmZXJzIHRvIHRoZSBwcmUtY2hhbmdlIGVuZCkuCiAgZnVuY3Rpb24gY2hhbmdlRW5kKGNoYW5nZSkgewogICAgaWYgKCFjaGFuZ2UudGV4dCkgeyByZXR1cm4gY2hhbmdlLnRvIH0KICAgIHJldHVybiBQb3MoY2hhbmdlLmZyb20ubGluZSArIGNoYW5nZS50ZXh0Lmxlbmd0aCAtIDEsCiAgICAgICAgICAgICAgIGxzdChjaGFuZ2UudGV4dCkubGVuZ3RoICsgKGNoYW5nZS50ZXh0Lmxlbmd0aCA9PSAxID8gY2hhbmdlLmZyb20uY2ggOiAwKSkKICB9CgogIC8vIEFkanVzdCBhIHBvc2l0aW9uIHRvIHJlZmVyIHRvIHRoZSBwb3N0LWNoYW5nZSBwb3NpdGlvbiBvZiB0aGUKICAvLyBzYW1lIHRleHQsIG9yIHRoZSBlbmQgb2YgdGhlIGNoYW5nZSBpZiB0aGUgY2hhbmdlIGNvdmVycyBpdC4KICBmdW5jdGlvbiBhZGp1c3RGb3JDaGFuZ2UocG9zLCBjaGFuZ2UpIHsKICAgIGlmIChjbXAocG9zLCBjaGFuZ2UuZnJvbSkgPCAwKSB7IHJldHVybiBwb3MgfQogICAgaWYgKGNtcChwb3MsIGNoYW5nZS50bykgPD0gMCkgeyByZXR1cm4gY2hhbmdlRW5kKGNoYW5nZSkgfQoKICAgIHZhciBsaW5lID0gcG9zLmxpbmUgKyBjaGFuZ2UudGV4dC5sZW5ndGggLSAoY2hhbmdlLnRvLmxpbmUgLSBjaGFuZ2UuZnJvbS5saW5lKSAtIDEsIGNoID0gcG9zLmNoOwogICAgaWYgKHBvcy5saW5lID09IGNoYW5nZS50by5saW5lKSB7IGNoICs9IGNoYW5nZUVuZChjaGFuZ2UpLmNoIC0gY2hhbmdlLnRvLmNoOyB9CiAgICByZXR1cm4gUG9zKGxpbmUsIGNoKQogIH0KCiAgZnVuY3Rpb24gY29tcHV0ZVNlbEFmdGVyQ2hhbmdlKGRvYywgY2hhbmdlKSB7CiAgICB2YXIgb3V0ID0gW107CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRvYy5zZWwucmFuZ2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciByYW5nZSA9IGRvYy5zZWwucmFuZ2VzW2ldOwogICAgICBvdXQucHVzaChuZXcgUmFuZ2UoYWRqdXN0Rm9yQ2hhbmdlKHJhbmdlLmFuY2hvciwgY2hhbmdlKSwKICAgICAgICAgICAgICAgICAgICAgICAgIGFkanVzdEZvckNoYW5nZShyYW5nZS5oZWFkLCBjaGFuZ2UpKSk7CiAgICB9CiAgICByZXR1cm4gbm9ybWFsaXplU2VsZWN0aW9uKGRvYy5jbSwgb3V0LCBkb2Muc2VsLnByaW1JbmRleCkKICB9CgogIGZ1bmN0aW9uIG9mZnNldFBvcyhwb3MsIG9sZCwgbncpIHsKICAgIGlmIChwb3MubGluZSA9PSBvbGQubGluZSkKICAgICAgeyByZXR1cm4gUG9zKG53LmxpbmUsIHBvcy5jaCAtIG9sZC5jaCArIG53LmNoKSB9CiAgICBlbHNlCiAgICAgIHsgcmV0dXJuIFBvcyhudy5saW5lICsgKHBvcy5saW5lIC0gb2xkLmxpbmUpLCBwb3MuY2gpIH0KICB9CgogIC8vIFVzZWQgYnkgcmVwbGFjZVNlbGVjdGlvbnMgdG8gYWxsb3cgbW92aW5nIHRoZSBzZWxlY3Rpb24gdG8gdGhlCiAgLy8gc3RhcnQgb3IgYXJvdW5kIHRoZSByZXBsYWNlZCB0ZXN0LiBIaW50IG1heSBiZSAic3RhcnQiIG9yICJhcm91bmQiLgogIGZ1bmN0aW9uIGNvbXB1dGVSZXBsYWNlZFNlbChkb2MsIGNoYW5nZXMsIGhpbnQpIHsKICAgIHZhciBvdXQgPSBbXTsKICAgIHZhciBvbGRQcmV2ID0gUG9zKGRvYy5maXJzdCwgMCksIG5ld1ByZXYgPSBvbGRQcmV2OwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjaGFuZ2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBjaGFuZ2UgPSBjaGFuZ2VzW2ldOwogICAgICB2YXIgZnJvbSA9IG9mZnNldFBvcyhjaGFuZ2UuZnJvbSwgb2xkUHJldiwgbmV3UHJldik7CiAgICAgIHZhciB0byA9IG9mZnNldFBvcyhjaGFuZ2VFbmQoY2hhbmdlKSwgb2xkUHJldiwgbmV3UHJldik7CiAgICAgIG9sZFByZXYgPSBjaGFuZ2UudG87CiAgICAgIG5ld1ByZXYgPSB0bzsKICAgICAgaWYgKGhpbnQgPT0gImFyb3VuZCIpIHsKICAgICAgICB2YXIgcmFuZ2UgPSBkb2Muc2VsLnJhbmdlc1tpXSwgaW52ID0gY21wKHJhbmdlLmhlYWQsIHJhbmdlLmFuY2hvcikgPCAwOwogICAgICAgIG91dFtpXSA9IG5ldyBSYW5nZShpbnYgPyB0byA6IGZyb20sIGludiA/IGZyb20gOiB0byk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgb3V0W2ldID0gbmV3IFJhbmdlKGZyb20sIGZyb20pOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gbmV3IFNlbGVjdGlvbihvdXQsIGRvYy5zZWwucHJpbUluZGV4KQogIH0KCiAgLy8gVXNlZCB0byBnZXQgdGhlIGVkaXRvciBpbnRvIGEgY29uc2lzdGVudCBzdGF0ZSBhZ2FpbiB3aGVuIG9wdGlvbnMgY2hhbmdlLgoKICBmdW5jdGlvbiBsb2FkTW9kZShjbSkgewogICAgY20uZG9jLm1vZGUgPSBnZXRNb2RlKGNtLm9wdGlvbnMsIGNtLmRvYy5tb2RlT3B0aW9uKTsKICAgIHJlc2V0TW9kZVN0YXRlKGNtKTsKICB9CgogIGZ1bmN0aW9uIHJlc2V0TW9kZVN0YXRlKGNtKSB7CiAgICBjbS5kb2MuaXRlcihmdW5jdGlvbiAobGluZSkgewogICAgICBpZiAobGluZS5zdGF0ZUFmdGVyKSB7IGxpbmUuc3RhdGVBZnRlciA9IG51bGw7IH0KICAgICAgaWYgKGxpbmUuc3R5bGVzKSB7IGxpbmUuc3R5bGVzID0gbnVsbDsgfQogICAgfSk7CiAgICBjbS5kb2MubW9kZUZyb250aWVyID0gY20uZG9jLmhpZ2hsaWdodEZyb250aWVyID0gY20uZG9jLmZpcnN0OwogICAgc3RhcnRXb3JrZXIoY20sIDEwMCk7CiAgICBjbS5zdGF0ZS5tb2RlR2VuKys7CiAgICBpZiAoY20uY3VyT3ApIHsgcmVnQ2hhbmdlKGNtKTsgfQogIH0KCiAgLy8gRE9DVU1FTlQgREFUQSBTVFJVQ1RVUkUKCiAgLy8gQnkgZGVmYXVsdCwgdXBkYXRlcyB0aGF0IHN0YXJ0IGFuZCBlbmQgYXQgdGhlIGJlZ2lubmluZyBvZiBhIGxpbmUKICAvLyBhcmUgdHJlYXRlZCBzcGVjaWFsbHksIGluIG9yZGVyIHRvIG1ha2UgdGhlIGFzc29jaWF0aW9uIG9mIGxpbmUKICAvLyB3aWRnZXRzIGFuZCBtYXJrZXIgZWxlbWVudHMgd2l0aCB0aGUgdGV4dCBiZWhhdmUgbW9yZSBpbnR1aXRpdmUuCiAgZnVuY3Rpb24gaXNXaG9sZUxpbmVVcGRhdGUoZG9jLCBjaGFuZ2UpIHsKICAgIHJldHVybiBjaGFuZ2UuZnJvbS5jaCA9PSAwICYmIGNoYW5nZS50by5jaCA9PSAwICYmIGxzdChjaGFuZ2UudGV4dCkgPT0gIiIgJiYKICAgICAgKCFkb2MuY20gfHwgZG9jLmNtLm9wdGlvbnMud2hvbGVMaW5lVXBkYXRlQmVmb3JlKQogIH0KCiAgLy8gUGVyZm9ybSBhIGNoYW5nZSBvbiB0aGUgZG9jdW1lbnQgZGF0YSBzdHJ1Y3R1cmUuCiAgZnVuY3Rpb24gdXBkYXRlRG9jKGRvYywgY2hhbmdlLCBtYXJrZWRTcGFucywgZXN0aW1hdGVIZWlnaHQkJDEpIHsKICAgIGZ1bmN0aW9uIHNwYW5zRm9yKG4pIHtyZXR1cm4gbWFya2VkU3BhbnMgPyBtYXJrZWRTcGFuc1tuXSA6IG51bGx9CiAgICBmdW5jdGlvbiB1cGRhdGUobGluZSwgdGV4dCwgc3BhbnMpIHsKICAgICAgdXBkYXRlTGluZShsaW5lLCB0ZXh0LCBzcGFucywgZXN0aW1hdGVIZWlnaHQkJDEpOwogICAgICBzaWduYWxMYXRlcihsaW5lLCAiY2hhbmdlIiwgbGluZSwgY2hhbmdlKTsKICAgIH0KICAgIGZ1bmN0aW9uIGxpbmVzRm9yKHN0YXJ0LCBlbmQpIHsKICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICBmb3IgKHZhciBpID0gc3RhcnQ7IGkgPCBlbmQ7ICsraSkKICAgICAgICB7IHJlc3VsdC5wdXNoKG5ldyBMaW5lKHRleHRbaV0sIHNwYW5zRm9yKGkpLCBlc3RpbWF0ZUhlaWdodCQkMSkpOyB9CiAgICAgIHJldHVybiByZXN1bHQKICAgIH0KCiAgICB2YXIgZnJvbSA9IGNoYW5nZS5mcm9tLCB0byA9IGNoYW5nZS50bywgdGV4dCA9IGNoYW5nZS50ZXh0OwogICAgdmFyIGZpcnN0TGluZSA9IGdldExpbmUoZG9jLCBmcm9tLmxpbmUpLCBsYXN0TGluZSA9IGdldExpbmUoZG9jLCB0by5saW5lKTsKICAgIHZhciBsYXN0VGV4dCA9IGxzdCh0ZXh0KSwgbGFzdFNwYW5zID0gc3BhbnNGb3IodGV4dC5sZW5ndGggLSAxKSwgbmxpbmVzID0gdG8ubGluZSAtIGZyb20ubGluZTsKCiAgICAvLyBBZGp1c3QgdGhlIGxpbmUgc3RydWN0dXJlCiAgICBpZiAoY2hhbmdlLmZ1bGwpIHsKICAgICAgZG9jLmluc2VydCgwLCBsaW5lc0ZvcigwLCB0ZXh0Lmxlbmd0aCkpOwogICAgICBkb2MucmVtb3ZlKHRleHQubGVuZ3RoLCBkb2Muc2l6ZSAtIHRleHQubGVuZ3RoKTsKICAgIH0gZWxzZSBpZiAoaXNXaG9sZUxpbmVVcGRhdGUoZG9jLCBjaGFuZ2UpKSB7CiAgICAgIC8vIFRoaXMgaXMgYSB3aG9sZS1saW5lIHJlcGxhY2UuIFRyZWF0ZWQgc3BlY2lhbGx5IHRvIG1ha2UKICAgICAgLy8gc3VyZSBsaW5lIG9iamVjdHMgbW92ZSB0aGUgd2F5IHRoZXkgYXJlIHN1cHBvc2VkIHRvLgogICAgICB2YXIgYWRkZWQgPSBsaW5lc0ZvcigwLCB0ZXh0Lmxlbmd0aCAtIDEpOwogICAgICB1cGRhdGUobGFzdExpbmUsIGxhc3RMaW5lLnRleHQsIGxhc3RTcGFucyk7CiAgICAgIGlmIChubGluZXMpIHsgZG9jLnJlbW92ZShmcm9tLmxpbmUsIG5saW5lcyk7IH0KICAgICAgaWYgKGFkZGVkLmxlbmd0aCkgeyBkb2MuaW5zZXJ0KGZyb20ubGluZSwgYWRkZWQpOyB9CiAgICB9IGVsc2UgaWYgKGZpcnN0TGluZSA9PSBsYXN0TGluZSkgewogICAgICBpZiAodGV4dC5sZW5ndGggPT0gMSkgewogICAgICAgIHVwZGF0ZShmaXJzdExpbmUsIGZpcnN0TGluZS50ZXh0LnNsaWNlKDAsIGZyb20uY2gpICsgbGFzdFRleHQgKyBmaXJzdExpbmUudGV4dC5zbGljZSh0by5jaCksIGxhc3RTcGFucyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIGFkZGVkJDEgPSBsaW5lc0ZvcigxLCB0ZXh0Lmxlbmd0aCAtIDEpOwogICAgICAgIGFkZGVkJDEucHVzaChuZXcgTGluZShsYXN0VGV4dCArIGZpcnN0TGluZS50ZXh0LnNsaWNlKHRvLmNoKSwgbGFzdFNwYW5zLCBlc3RpbWF0ZUhlaWdodCQkMSkpOwogICAgICAgIHVwZGF0ZShmaXJzdExpbmUsIGZpcnN0TGluZS50ZXh0LnNsaWNlKDAsIGZyb20uY2gpICsgdGV4dFswXSwgc3BhbnNGb3IoMCkpOwogICAgICAgIGRvYy5pbnNlcnQoZnJvbS5saW5lICsgMSwgYWRkZWQkMSk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAodGV4dC5sZW5ndGggPT0gMSkgewogICAgICB1cGRhdGUoZmlyc3RMaW5lLCBmaXJzdExpbmUudGV4dC5zbGljZSgwLCBmcm9tLmNoKSArIHRleHRbMF0gKyBsYXN0TGluZS50ZXh0LnNsaWNlKHRvLmNoKSwgc3BhbnNGb3IoMCkpOwogICAgICBkb2MucmVtb3ZlKGZyb20ubGluZSArIDEsIG5saW5lcyk7CiAgICB9IGVsc2UgewogICAgICB1cGRhdGUoZmlyc3RMaW5lLCBmaXJzdExpbmUudGV4dC5zbGljZSgwLCBmcm9tLmNoKSArIHRleHRbMF0sIHNwYW5zRm9yKDApKTsKICAgICAgdXBkYXRlKGxhc3RMaW5lLCBsYXN0VGV4dCArIGxhc3RMaW5lLnRleHQuc2xpY2UodG8uY2gpLCBsYXN0U3BhbnMpOwogICAgICB2YXIgYWRkZWQkMiA9IGxpbmVzRm9yKDEsIHRleHQubGVuZ3RoIC0gMSk7CiAgICAgIGlmIChubGluZXMgPiAxKSB7IGRvYy5yZW1vdmUoZnJvbS5saW5lICsgMSwgbmxpbmVzIC0gMSk7IH0KICAgICAgZG9jLmluc2VydChmcm9tLmxpbmUgKyAxLCBhZGRlZCQyKTsKICAgIH0KCiAgICBzaWduYWxMYXRlcihkb2MsICJjaGFuZ2UiLCBkb2MsIGNoYW5nZSk7CiAgfQoKICAvLyBDYWxsIGYgZm9yIGFsbCBsaW5rZWQgZG9jdW1lbnRzLgogIGZ1bmN0aW9uIGxpbmtlZERvY3MoZG9jLCBmLCBzaGFyZWRIaXN0T25seSkgewogICAgZnVuY3Rpb24gcHJvcGFnYXRlKGRvYywgc2tpcCwgc2hhcmVkSGlzdCkgewogICAgICBpZiAoZG9jLmxpbmtlZCkgeyBmb3IgKHZhciBpID0gMDsgaSA8IGRvYy5saW5rZWQubGVuZ3RoOyArK2kpIHsKICAgICAgICB2YXIgcmVsID0gZG9jLmxpbmtlZFtpXTsKICAgICAgICBpZiAocmVsLmRvYyA9PSBza2lwKSB7IGNvbnRpbnVlIH0KICAgICAgICB2YXIgc2hhcmVkID0gc2hhcmVkSGlzdCAmJiByZWwuc2hhcmVkSGlzdDsKICAgICAgICBpZiAoc2hhcmVkSGlzdE9ubHkgJiYgIXNoYXJlZCkgeyBjb250aW51ZSB9CiAgICAgICAgZihyZWwuZG9jLCBzaGFyZWQpOwogICAgICAgIHByb3BhZ2F0ZShyZWwuZG9jLCBkb2MsIHNoYXJlZCk7CiAgICAgIH0gfQogICAgfQogICAgcHJvcGFnYXRlKGRvYywgbnVsbCwgdHJ1ZSk7CiAgfQoKICAvLyBBdHRhY2ggYSBkb2N1bWVudCB0byBhbiBlZGl0b3IuCiAgZnVuY3Rpb24gYXR0YWNoRG9jKGNtLCBkb2MpIHsKICAgIGlmIChkb2MuY20pIHsgdGhyb3cgbmV3IEVycm9yKCJUaGlzIGRvY3VtZW50IGlzIGFscmVhZHkgaW4gdXNlLiIpIH0KICAgIGNtLmRvYyA9IGRvYzsKICAgIGRvYy5jbSA9IGNtOwogICAgZXN0aW1hdGVMaW5lSGVpZ2h0cyhjbSk7CiAgICBsb2FkTW9kZShjbSk7CiAgICBzZXREaXJlY3Rpb25DbGFzcyhjbSk7CiAgICBpZiAoIWNtLm9wdGlvbnMubGluZVdyYXBwaW5nKSB7IGZpbmRNYXhMaW5lKGNtKTsgfQogICAgY20ub3B0aW9ucy5tb2RlID0gZG9jLm1vZGVPcHRpb247CiAgICByZWdDaGFuZ2UoY20pOwogIH0KCiAgZnVuY3Rpb24gc2V0RGlyZWN0aW9uQ2xhc3MoY20pIHsKICAoY20uZG9jLmRpcmVjdGlvbiA9PSAicnRsIiA/IGFkZENsYXNzIDogcm1DbGFzcykoY20uZGlzcGxheS5saW5lRGl2LCAiQ29kZU1pcnJvci1ydGwiKTsKICB9CgogIGZ1bmN0aW9uIGRpcmVjdGlvbkNoYW5nZWQoY20pIHsKICAgIHJ1bkluT3AoY20sIGZ1bmN0aW9uICgpIHsKICAgICAgc2V0RGlyZWN0aW9uQ2xhc3MoY20pOwogICAgICByZWdDaGFuZ2UoY20pOwogICAgfSk7CiAgfQoKICBmdW5jdGlvbiBIaXN0b3J5KHN0YXJ0R2VuKSB7CiAgICAvLyBBcnJheXMgb2YgY2hhbmdlIGV2ZW50cyBhbmQgc2VsZWN0aW9ucy4gRG9pbmcgc29tZXRoaW5nIGFkZHMgYW4KICAgIC8vIGV2ZW50IHRvIGRvbmUgYW5kIGNsZWFycyB1bmRvLiBVbmRvaW5nIG1vdmVzIGV2ZW50cyBmcm9tIGRvbmUKICAgIC8vIHRvIHVuZG9uZSwgcmVkb2luZyBtb3ZlcyB0aGVtIGluIHRoZSBvdGhlciBkaXJlY3Rpb24uCiAgICB0aGlzLmRvbmUgPSBbXTsgdGhpcy51bmRvbmUgPSBbXTsKICAgIHRoaXMudW5kb0RlcHRoID0gSW5maW5pdHk7CiAgICAvLyBVc2VkIHRvIHRyYWNrIHdoZW4gY2hhbmdlcyBjYW4gYmUgbWVyZ2VkIGludG8gYSBzaW5nbGUgdW5kbwogICAgLy8gZXZlbnQKICAgIHRoaXMubGFzdE1vZFRpbWUgPSB0aGlzLmxhc3RTZWxUaW1lID0gMDsKICAgIHRoaXMubGFzdE9wID0gdGhpcy5sYXN0U2VsT3AgPSBudWxsOwogICAgdGhpcy5sYXN0T3JpZ2luID0gdGhpcy5sYXN0U2VsT3JpZ2luID0gbnVsbDsKICAgIC8vIFVzZWQgYnkgdGhlIGlzQ2xlYW4oKSBtZXRob2QKICAgIHRoaXMuZ2VuZXJhdGlvbiA9IHRoaXMubWF4R2VuZXJhdGlvbiA9IHN0YXJ0R2VuIHx8IDE7CiAgfQoKICAvLyBDcmVhdGUgYSBoaXN0b3J5IGNoYW5nZSBldmVudCBmcm9tIGFuIHVwZGF0ZURvYy1zdHlsZSBjaGFuZ2UKICAvLyBvYmplY3QuCiAgZnVuY3Rpb24gaGlzdG9yeUNoYW5nZUZyb21DaGFuZ2UoZG9jLCBjaGFuZ2UpIHsKICAgIHZhciBoaXN0Q2hhbmdlID0ge2Zyb206IGNvcHlQb3MoY2hhbmdlLmZyb20pLCB0bzogY2hhbmdlRW5kKGNoYW5nZSksIHRleHQ6IGdldEJldHdlZW4oZG9jLCBjaGFuZ2UuZnJvbSwgY2hhbmdlLnRvKX07CiAgICBhdHRhY2hMb2NhbFNwYW5zKGRvYywgaGlzdENoYW5nZSwgY2hhbmdlLmZyb20ubGluZSwgY2hhbmdlLnRvLmxpbmUgKyAxKTsKICAgIGxpbmtlZERvY3MoZG9jLCBmdW5jdGlvbiAoZG9jKSB7IHJldHVybiBhdHRhY2hMb2NhbFNwYW5zKGRvYywgaGlzdENoYW5nZSwgY2hhbmdlLmZyb20ubGluZSwgY2hhbmdlLnRvLmxpbmUgKyAxKTsgfSwgdHJ1ZSk7CiAgICByZXR1cm4gaGlzdENoYW5nZQogIH0KCiAgLy8gUG9wIGFsbCBzZWxlY3Rpb24gZXZlbnRzIG9mZiB0aGUgZW5kIG9mIGEgaGlzdG9yeSBhcnJheS4gU3RvcCBhdAogIC8vIGEgY2hhbmdlIGV2ZW50LgogIGZ1bmN0aW9uIGNsZWFyU2VsZWN0aW9uRXZlbnRzKGFycmF5KSB7CiAgICB3aGlsZSAoYXJyYXkubGVuZ3RoKSB7CiAgICAgIHZhciBsYXN0ID0gbHN0KGFycmF5KTsKICAgICAgaWYgKGxhc3QucmFuZ2VzKSB7IGFycmF5LnBvcCgpOyB9CiAgICAgIGVsc2UgeyBicmVhayB9CiAgICB9CiAgfQoKICAvLyBGaW5kIHRoZSB0b3AgY2hhbmdlIGV2ZW50IGluIHRoZSBoaXN0b3J5LiBQb3Agb2ZmIHNlbGVjdGlvbgogIC8vIGV2ZW50cyB0aGF0IGFyZSBpbiB0aGUgd2F5LgogIGZ1bmN0aW9uIGxhc3RDaGFuZ2VFdmVudChoaXN0LCBmb3JjZSkgewogICAgaWYgKGZvcmNlKSB7CiAgICAgIGNsZWFyU2VsZWN0aW9uRXZlbnRzKGhpc3QuZG9uZSk7CiAgICAgIHJldHVybiBsc3QoaGlzdC5kb25lKQogICAgfSBlbHNlIGlmIChoaXN0LmRvbmUubGVuZ3RoICYmICFsc3QoaGlzdC5kb25lKS5yYW5nZXMpIHsKICAgICAgcmV0dXJuIGxzdChoaXN0LmRvbmUpCiAgICB9IGVsc2UgaWYgKGhpc3QuZG9uZS5sZW5ndGggPiAxICYmICFoaXN0LmRvbmVbaGlzdC5kb25lLmxlbmd0aCAtIDJdLnJhbmdlcykgewogICAgICBoaXN0LmRvbmUucG9wKCk7CiAgICAgIHJldHVybiBsc3QoaGlzdC5kb25lKQogICAgfQogIH0KCiAgLy8gUmVnaXN0ZXIgYSBjaGFuZ2UgaW4gdGhlIGhpc3RvcnkuIE1lcmdlcyBjaGFuZ2VzIHRoYXQgYXJlIHdpdGhpbgogIC8vIGEgc2luZ2xlIG9wZXJhdGlvbiwgb3IgYXJlIGNsb3NlIHRvZ2V0aGVyIHdpdGggYW4gb3JpZ2luIHRoYXQKICAvLyBhbGxvd3MgbWVyZ2luZyAoc3RhcnRpbmcgd2l0aCAiKyIpIGludG8gYSBzaW5nbGUgZXZlbnQuCiAgZnVuY3Rpb24gYWRkQ2hhbmdlVG9IaXN0b3J5KGRvYywgY2hhbmdlLCBzZWxBZnRlciwgb3BJZCkgewogICAgdmFyIGhpc3QgPSBkb2MuaGlzdG9yeTsKICAgIGhpc3QudW5kb25lLmxlbmd0aCA9IDA7CiAgICB2YXIgdGltZSA9ICtuZXcgRGF0ZSwgY3VyOwogICAgdmFyIGxhc3Q7CgogICAgaWYgKChoaXN0Lmxhc3RPcCA9PSBvcElkIHx8CiAgICAgICAgIGhpc3QubGFzdE9yaWdpbiA9PSBjaGFuZ2Uub3JpZ2luICYmIGNoYW5nZS5vcmlnaW4gJiYKICAgICAgICAgKChjaGFuZ2Uub3JpZ2luLmNoYXJBdCgwKSA9PSAiKyIgJiYgaGlzdC5sYXN0TW9kVGltZSA+IHRpbWUgLSAoZG9jLmNtID8gZG9jLmNtLm9wdGlvbnMuaGlzdG9yeUV2ZW50RGVsYXkgOiA1MDApKSB8fAogICAgICAgICAgY2hhbmdlLm9yaWdpbi5jaGFyQXQoMCkgPT0gIioiKSkgJiYKICAgICAgICAoY3VyID0gbGFzdENoYW5nZUV2ZW50KGhpc3QsIGhpc3QubGFzdE9wID09IG9wSWQpKSkgewogICAgICAvLyBNZXJnZSB0aGlzIGNoYW5nZSBpbnRvIHRoZSBsYXN0IGV2ZW50CiAgICAgIGxhc3QgPSBsc3QoY3VyLmNoYW5nZXMpOwogICAgICBpZiAoY21wKGNoYW5nZS5mcm9tLCBjaGFuZ2UudG8pID09IDAgJiYgY21wKGNoYW5nZS5mcm9tLCBsYXN0LnRvKSA9PSAwKSB7CiAgICAgICAgLy8gT3B0aW1pemVkIGNhc2UgZm9yIHNpbXBsZSBpbnNlcnRpb24gLS0gZG9uJ3Qgd2FudCB0byBhZGQKICAgICAgICAvLyBuZXcgY2hhbmdlc2V0cyBmb3IgZXZlcnkgY2hhcmFjdGVyIHR5cGVkCiAgICAgICAgbGFzdC50byA9IGNoYW5nZUVuZChjaGFuZ2UpOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIEFkZCBuZXcgc3ViLWV2ZW50CiAgICAgICAgY3VyLmNoYW5nZXMucHVzaChoaXN0b3J5Q2hhbmdlRnJvbUNoYW5nZShkb2MsIGNoYW5nZSkpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICAvLyBDYW4gbm90IGJlIG1lcmdlZCwgc3RhcnQgYSBuZXcgZXZlbnQuCiAgICAgIHZhciBiZWZvcmUgPSBsc3QoaGlzdC5kb25lKTsKICAgICAgaWYgKCFiZWZvcmUgfHwgIWJlZm9yZS5yYW5nZXMpCiAgICAgICAgeyBwdXNoU2VsZWN0aW9uVG9IaXN0b3J5KGRvYy5zZWwsIGhpc3QuZG9uZSk7IH0KICAgICAgY3VyID0ge2NoYW5nZXM6IFtoaXN0b3J5Q2hhbmdlRnJvbUNoYW5nZShkb2MsIGNoYW5nZSldLAogICAgICAgICAgICAgZ2VuZXJhdGlvbjogaGlzdC5nZW5lcmF0aW9ufTsKICAgICAgaGlzdC5kb25lLnB1c2goY3VyKTsKICAgICAgd2hpbGUgKGhpc3QuZG9uZS5sZW5ndGggPiBoaXN0LnVuZG9EZXB0aCkgewogICAgICAgIGhpc3QuZG9uZS5zaGlmdCgpOwogICAgICAgIGlmICghaGlzdC5kb25lWzBdLnJhbmdlcykgeyBoaXN0LmRvbmUuc2hpZnQoKTsgfQogICAgICB9CiAgICB9CiAgICBoaXN0LmRvbmUucHVzaChzZWxBZnRlcik7CiAgICBoaXN0LmdlbmVyYXRpb24gPSArK2hpc3QubWF4R2VuZXJhdGlvbjsKICAgIGhpc3QubGFzdE1vZFRpbWUgPSBoaXN0Lmxhc3RTZWxUaW1lID0gdGltZTsKICAgIGhpc3QubGFzdE9wID0gaGlzdC5sYXN0U2VsT3AgPSBvcElkOwogICAgaGlzdC5sYXN0T3JpZ2luID0gaGlzdC5sYXN0U2VsT3JpZ2luID0gY2hhbmdlLm9yaWdpbjsKCiAgICBpZiAoIWxhc3QpIHsgc2lnbmFsKGRvYywgImhpc3RvcnlBZGRlZCIpOyB9CiAgfQoKICBmdW5jdGlvbiBzZWxlY3Rpb25FdmVudENhbkJlTWVyZ2VkKGRvYywgb3JpZ2luLCBwcmV2LCBzZWwpIHsKICAgIHZhciBjaCA9IG9yaWdpbi5jaGFyQXQoMCk7CiAgICByZXR1cm4gY2ggPT0gIioiIHx8CiAgICAgIGNoID09ICIrIiAmJgogICAgICBwcmV2LnJhbmdlcy5sZW5ndGggPT0gc2VsLnJhbmdlcy5sZW5ndGggJiYKICAgICAgcHJldi5zb21ldGhpbmdTZWxlY3RlZCgpID09IHNlbC5zb21ldGhpbmdTZWxlY3RlZCgpICYmCiAgICAgIG5ldyBEYXRlIC0gZG9jLmhpc3RvcnkubGFzdFNlbFRpbWUgPD0gKGRvYy5jbSA/IGRvYy5jbS5vcHRpb25zLmhpc3RvcnlFdmVudERlbGF5IDogNTAwKQogIH0KCiAgLy8gQ2FsbGVkIHdoZW5ldmVyIHRoZSBzZWxlY3Rpb24gY2hhbmdlcywgc2V0cyB0aGUgbmV3IHNlbGVjdGlvbiBhcwogIC8vIHRoZSBwZW5kaW5nIHNlbGVjdGlvbiBpbiB0aGUgaGlzdG9yeSwgYW5kIHB1c2hlcyB0aGUgb2xkIHBlbmRpbmcKICAvLyBzZWxlY3Rpb24gaW50byB0aGUgJ2RvbmUnIGFycmF5IHdoZW4gaXQgd2FzIHNpZ25pZmljYW50bHkKICAvLyBkaWZmZXJlbnQgKGluIG51bWJlciBvZiBzZWxlY3RlZCByYW5nZXMsIGVtcHRpbmVzcywgb3IgdGltZSkuCiAgZnVuY3Rpb24gYWRkU2VsZWN0aW9uVG9IaXN0b3J5KGRvYywgc2VsLCBvcElkLCBvcHRpb25zKSB7CiAgICB2YXIgaGlzdCA9IGRvYy5oaXN0b3J5LCBvcmlnaW4gPSBvcHRpb25zICYmIG9wdGlvbnMub3JpZ2luOwoKICAgIC8vIEEgbmV3IGV2ZW50IGlzIHN0YXJ0ZWQgd2hlbiB0aGUgcHJldmlvdXMgb3JpZ2luIGRvZXMgbm90IG1hdGNoCiAgICAvLyB0aGUgY3VycmVudCwgb3IgdGhlIG9yaWdpbnMgZG9uJ3QgYWxsb3cgbWF0Y2hpbmcuIE9yaWdpbnMKICAgIC8vIHN0YXJ0aW5nIHdpdGggKiBhcmUgYWx3YXlzIG1lcmdlZCwgdGhvc2Ugc3RhcnRpbmcgd2l0aCArIGFyZQogICAgLy8gbWVyZ2VkIHdoZW4gc2ltaWxhciBhbmQgY2xvc2UgdG9nZXRoZXIgaW4gdGltZS4KICAgIGlmIChvcElkID09IGhpc3QubGFzdFNlbE9wIHx8CiAgICAgICAgKG9yaWdpbiAmJiBoaXN0Lmxhc3RTZWxPcmlnaW4gPT0gb3JpZ2luICYmCiAgICAgICAgIChoaXN0Lmxhc3RNb2RUaW1lID09IGhpc3QubGFzdFNlbFRpbWUgJiYgaGlzdC5sYXN0T3JpZ2luID09IG9yaWdpbiB8fAogICAgICAgICAgc2VsZWN0aW9uRXZlbnRDYW5CZU1lcmdlZChkb2MsIG9yaWdpbiwgbHN0KGhpc3QuZG9uZSksIHNlbCkpKSkKICAgICAgeyBoaXN0LmRvbmVbaGlzdC5kb25lLmxlbmd0aCAtIDFdID0gc2VsOyB9CiAgICBlbHNlCiAgICAgIHsgcHVzaFNlbGVjdGlvblRvSGlzdG9yeShzZWwsIGhpc3QuZG9uZSk7IH0KCiAgICBoaXN0Lmxhc3RTZWxUaW1lID0gK25ldyBEYXRlOwogICAgaGlzdC5sYXN0U2VsT3JpZ2luID0gb3JpZ2luOwogICAgaGlzdC5sYXN0U2VsT3AgPSBvcElkOwogICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5jbGVhclJlZG8gIT09IGZhbHNlKQogICAgICB7IGNsZWFyU2VsZWN0aW9uRXZlbnRzKGhpc3QudW5kb25lKTsgfQogIH0KCiAgZnVuY3Rpb24gcHVzaFNlbGVjdGlvblRvSGlzdG9yeShzZWwsIGRlc3QpIHsKICAgIHZhciB0b3AgPSBsc3QoZGVzdCk7CiAgICBpZiAoISh0b3AgJiYgdG9wLnJhbmdlcyAmJiB0b3AuZXF1YWxzKHNlbCkpKQogICAgICB7IGRlc3QucHVzaChzZWwpOyB9CiAgfQoKICAvLyBVc2VkIHRvIHN0b3JlIG1hcmtlZCBzcGFuIGluZm9ybWF0aW9uIGluIHRoZSBoaXN0b3J5LgogIGZ1bmN0aW9uIGF0dGFjaExvY2FsU3BhbnMoZG9jLCBjaGFuZ2UsIGZyb20sIHRvKSB7CiAgICB2YXIgZXhpc3RpbmcgPSBjaGFuZ2VbInNwYW5zXyIgKyBkb2MuaWRdLCBuID0gMDsKICAgIGRvYy5pdGVyKE1hdGgubWF4KGRvYy5maXJzdCwgZnJvbSksIE1hdGgubWluKGRvYy5maXJzdCArIGRvYy5zaXplLCB0byksIGZ1bmN0aW9uIChsaW5lKSB7CiAgICAgIGlmIChsaW5lLm1hcmtlZFNwYW5zKQogICAgICAgIHsgKGV4aXN0aW5nIHx8IChleGlzdGluZyA9IGNoYW5nZVsic3BhbnNfIiArIGRvYy5pZF0gPSB7fSkpW25dID0gbGluZS5tYXJrZWRTcGFuczsgfQogICAgICArK247CiAgICB9KTsKICB9CgogIC8vIFdoZW4gdW4vcmUtZG9pbmcgcmVzdG9yZXMgdGV4dCBjb250YWluaW5nIG1hcmtlZCBzcGFucywgdGhvc2UKICAvLyB0aGF0IGhhdmUgYmVlbiBleHBsaWNpdGx5IGNsZWFyZWQgc2hvdWxkIG5vdCBiZSByZXN0b3JlZC4KICBmdW5jdGlvbiByZW1vdmVDbGVhcmVkU3BhbnMoc3BhbnMpIHsKICAgIGlmICghc3BhbnMpIHsgcmV0dXJuIG51bGwgfQogICAgdmFyIG91dDsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc3BhbnMubGVuZ3RoOyArK2kpIHsKICAgICAgaWYgKHNwYW5zW2ldLm1hcmtlci5leHBsaWNpdGx5Q2xlYXJlZCkgeyBpZiAoIW91dCkgeyBvdXQgPSBzcGFucy5zbGljZSgwLCBpKTsgfSB9CiAgICAgIGVsc2UgaWYgKG91dCkgeyBvdXQucHVzaChzcGFuc1tpXSk7IH0KICAgIH0KICAgIHJldHVybiAhb3V0ID8gc3BhbnMgOiBvdXQubGVuZ3RoID8gb3V0IDogbnVsbAogIH0KCiAgLy8gUmV0cmlldmUgYW5kIGZpbHRlciB0aGUgb2xkIG1hcmtlZCBzcGFucyBzdG9yZWQgaW4gYSBjaGFuZ2UgZXZlbnQuCiAgZnVuY3Rpb24gZ2V0T2xkU3BhbnMoZG9jLCBjaGFuZ2UpIHsKICAgIHZhciBmb3VuZCA9IGNoYW5nZVsic3BhbnNfIiArIGRvYy5pZF07CiAgICBpZiAoIWZvdW5kKSB7IHJldHVybiBudWxsIH0KICAgIHZhciBudyA9IFtdOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjaGFuZ2UudGV4dC5sZW5ndGg7ICsraSkKICAgICAgeyBudy5wdXNoKHJlbW92ZUNsZWFyZWRTcGFucyhmb3VuZFtpXSkpOyB9CiAgICByZXR1cm4gbncKICB9CgogIC8vIFVzZWQgZm9yIHVuL3JlLWRvaW5nIGNoYW5nZXMgZnJvbSB0aGUgaGlzdG9yeS4gQ29tYmluZXMgdGhlCiAgLy8gcmVzdWx0IG9mIGNvbXB1dGluZyB0aGUgZXhpc3Rpbmcgc3BhbnMgd2l0aCB0aGUgc2V0IG9mIHNwYW5zIHRoYXQKICAvLyBleGlzdGVkIGluIHRoZSBoaXN0b3J5IChzbyB0aGF0IGRlbGV0aW5nIGFyb3VuZCBhIHNwYW4gYW5kIHRoZW4KICAvLyB1bmRvaW5nIGJyaW5ncyBiYWNrIHRoZSBzcGFuKS4KICBmdW5jdGlvbiBtZXJnZU9sZFNwYW5zKGRvYywgY2hhbmdlKSB7CiAgICB2YXIgb2xkID0gZ2V0T2xkU3BhbnMoZG9jLCBjaGFuZ2UpOwogICAgdmFyIHN0cmV0Y2hlZCA9IHN0cmV0Y2hTcGFuc092ZXJDaGFuZ2UoZG9jLCBjaGFuZ2UpOwogICAgaWYgKCFvbGQpIHsgcmV0dXJuIHN0cmV0Y2hlZCB9CiAgICBpZiAoIXN0cmV0Y2hlZCkgeyByZXR1cm4gb2xkIH0KCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IG9sZC5sZW5ndGg7ICsraSkgewogICAgICB2YXIgb2xkQ3VyID0gb2xkW2ldLCBzdHJldGNoQ3VyID0gc3RyZXRjaGVkW2ldOwogICAgICBpZiAob2xkQ3VyICYmIHN0cmV0Y2hDdXIpIHsKICAgICAgICBzcGFuczogZm9yICh2YXIgaiA9IDA7IGogPCBzdHJldGNoQ3VyLmxlbmd0aDsgKytqKSB7CiAgICAgICAgICB2YXIgc3BhbiA9IHN0cmV0Y2hDdXJbal07CiAgICAgICAgICBmb3IgKHZhciBrID0gMDsgayA8IG9sZEN1ci5sZW5ndGg7ICsraykKICAgICAgICAgICAgeyBpZiAob2xkQ3VyW2tdLm1hcmtlciA9PSBzcGFuLm1hcmtlcikgeyBjb250aW51ZSBzcGFucyB9IH0KICAgICAgICAgIG9sZEN1ci5wdXNoKHNwYW4pOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChzdHJldGNoQ3VyKSB7CiAgICAgICAgb2xkW2ldID0gc3RyZXRjaEN1cjsKICAgICAgfQogICAgfQogICAgcmV0dXJuIG9sZAogIH0KCiAgLy8gVXNlZCBib3RoIHRvIHByb3ZpZGUgYSBKU09OLXNhZmUgb2JqZWN0IGluIC5nZXRIaXN0b3J5LCBhbmQsIHdoZW4KICAvLyBkZXRhY2hpbmcgYSBkb2N1bWVudCwgdG8gc3BsaXQgdGhlIGhpc3RvcnkgaW4gdHdvCiAgZnVuY3Rpb24gY29weUhpc3RvcnlBcnJheShldmVudHMsIG5ld0dyb3VwLCBpbnN0YW50aWF0ZVNlbCkgewogICAgdmFyIGNvcHkgPSBbXTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZXZlbnRzLmxlbmd0aDsgKytpKSB7CiAgICAgIHZhciBldmVudCA9IGV2ZW50c1tpXTsKICAgICAgaWYgKGV2ZW50LnJhbmdlcykgewogICAgICAgIGNvcHkucHVzaChpbnN0YW50aWF0ZVNlbCA/IFNlbGVjdGlvbi5wcm90b3R5cGUuZGVlcENvcHkuY2FsbChldmVudCkgOiBldmVudCk7CiAgICAgICAgY29udGludWUKICAgICAgfQogICAgICB2YXIgY2hhbmdlcyA9IGV2ZW50LmNoYW5nZXMsIG5ld0NoYW5nZXMgPSBbXTsKICAgICAgY29weS5wdXNoKHtjaGFuZ2VzOiBuZXdDaGFuZ2VzfSk7CiAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgY2hhbmdlcy5sZW5ndGg7ICsraikgewogICAgICAgIHZhciBjaGFuZ2UgPSBjaGFuZ2VzW2pdLCBtID0gKHZvaWQgMCk7CiAgICAgICAgbmV3Q2hhbmdlcy5wdXNoKHtmcm9tOiBjaGFuZ2UuZnJvbSwgdG86IGNoYW5nZS50bywgdGV4dDogY2hhbmdlLnRleHR9KTsKICAgICAgICBpZiAobmV3R3JvdXApIHsgZm9yICh2YXIgcHJvcCBpbiBjaGFuZ2UpIHsgaWYgKG0gPSBwcm9wLm1hdGNoKC9ec3BhbnNfKFxkKykkLykpIHsKICAgICAgICAgIGlmIChpbmRleE9mKG5ld0dyb3VwLCBOdW1iZXIobVsxXSkpID4gLTEpIHsKICAgICAgICAgICAgbHN0KG5ld0NoYW5nZXMpW3Byb3BdID0gY2hhbmdlW3Byb3BdOwogICAgICAgICAgICBkZWxldGUgY2hhbmdlW3Byb3BdOwogICAgICAgICAgfQogICAgICAgIH0gfSB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBjb3B5CiAgfQoKICAvLyBUaGUgJ3Njcm9sbCcgcGFyYW1ldGVyIGdpdmVuIHRvIG1hbnkgb2YgdGhlc2UgaW5kaWNhdGVkIHdoZXRoZXIKICAvLyB0aGUgbmV3IGN1cnNvciBwb3NpdGlvbiBzaG91bGQgYmUgc2Nyb2xsZWQgaW50byB2aWV3IGFmdGVyCiAgLy8gbW9kaWZ5aW5nIHRoZSBzZWxlY3Rpb24uCgogIC8vIElmIHNoaWZ0IGlzIGhlbGQgb3IgdGhlIGV4dGVuZCBmbGFnIGlzIHNldCwgZXh0ZW5kcyBhIHJhbmdlIHRvCiAgLy8gaW5jbHVkZSBhIGdpdmVuIHBvc2l0aW9uIChhbmQgb3B0aW9uYWxseSBhIHNlY29uZCBwb3NpdGlvbikuCiAgLy8gT3RoZXJ3aXNlLCBzaW1wbHkgcmV0dXJucyB0aGUgcmFuZ2UgYmV0d2VlbiB0aGUgZ2l2ZW4gcG9zaXRpb25zLgogIC8vIFVzZWQgZm9yIGN1cnNvciBtb3Rpb24gYW5kIHN1Y2guCiAgZnVuY3Rpb24gZXh0ZW5kUmFuZ2UocmFuZ2UsIGhlYWQsIG90aGVyLCBleHRlbmQpIHsKICAgIGlmIChleHRlbmQpIHsKICAgICAgdmFyIGFuY2hvciA9IHJhbmdlLmFuY2hvcjsKICAgICAgaWYgKG90aGVyKSB7CiAgICAgICAgdmFyIHBvc0JlZm9yZSA9IGNtcChoZWFkLCBhbmNob3IpIDwgMDsKICAgICAgICBpZiAocG9zQmVmb3JlICE9IChjbXAob3RoZXIsIGFuY2hvcikgPCAwKSkgewogICAgICAgICAgYW5jaG9yID0gaGVhZDsKICAgICAgICAgIGhlYWQgPSBvdGhlcjsKICAgICAgICB9IGVsc2UgaWYgKHBvc0JlZm9yZSAhPSAoY21wKGhlYWQsIG90aGVyKSA8IDApKSB7CiAgICAgICAgICBoZWFkID0gb3RoZXI7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBuZXcgUmFuZ2UoYW5jaG9yLCBoZWFkKQogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIG5ldyBSYW5nZShvdGhlciB8fCBoZWFkLCBoZWFkKQogICAgfQogIH0KCiAgLy8gRXh0ZW5kIHRoZSBwcmltYXJ5IHNlbGVjdGlvbiByYW5nZSwgZGlzY2FyZCB0aGUgcmVzdC4KICBmdW5jdGlvbiBleHRlbmRTZWxlY3Rpb24oZG9jLCBoZWFkLCBvdGhlciwgb3B0aW9ucywgZXh0ZW5kKSB7CiAgICBpZiAoZXh0ZW5kID09IG51bGwpIHsgZXh0ZW5kID0gZG9jLmNtICYmIChkb2MuY20uZGlzcGxheS5zaGlmdCB8fCBkb2MuZXh0ZW5kKTsgfQogICAgc2V0U2VsZWN0aW9uKGRvYywgbmV3IFNlbGVjdGlvbihbZXh0ZW5kUmFuZ2UoZG9jLnNlbC5wcmltYXJ5KCksIGhlYWQsIG90aGVyLCBleHRlbmQpXSwgMCksIG9wdGlvbnMpOwogIH0KCiAgLy8gRXh0ZW5kIGFsbCBzZWxlY3Rpb25zIChwb3MgaXMgYW4gYXJyYXkgb2Ygc2VsZWN0aW9ucyB3aXRoIGxlbmd0aAogIC8vIGVxdWFsIHRoZSBudW1iZXIgb2Ygc2VsZWN0aW9ucykKICBmdW5jdGlvbiBleHRlbmRTZWxlY3Rpb25zKGRvYywgaGVhZHMsIG9wdGlvbnMpIHsKICAgIHZhciBvdXQgPSBbXTsKICAgIHZhciBleHRlbmQgPSBkb2MuY20gJiYgKGRvYy5jbS5kaXNwbGF5LnNoaWZ0IHx8IGRvYy5leHRlbmQpOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkb2Muc2VsLnJhbmdlcy5sZW5ndGg7IGkrKykKICAgICAgeyBvdXRbaV0gPSBleHRlbmRSYW5nZShkb2Muc2VsLnJhbmdlc1tpXSwgaGVhZHNbaV0sIG51bGwsIGV4dGVuZCk7IH0KICAgIHZhciBuZXdTZWwgPSBub3JtYWxpemVTZWxlY3Rpb24oZG9jLmNtLCBvdXQsIGRvYy5zZWwucHJpbUluZGV4KTsKICAgIHNldFNlbGVjdGlvbihkb2MsIG5ld1NlbCwgb3B0aW9ucyk7CiAgfQoKICAvLyBVcGRhdGVzIGEgc2luZ2xlIHJhbmdlIGluIHRoZSBzZWxlY3Rpb24uCiAgZnVuY3Rpb24gcmVwbGFjZU9uZVNlbGVjdGlvbihkb2MsIGksIHJhbmdlLCBvcHRpb25zKSB7CiAgICB2YXIgcmFuZ2VzID0gZG9jLnNlbC5yYW5nZXMuc2xpY2UoMCk7CiAgICByYW5nZXNbaV0gPSByYW5nZTsKICAgIHNldFNlbGVjdGlvbihkb2MsIG5vcm1hbGl6ZVNlbGVjdGlvbihkb2MuY20sIHJhbmdlcywgZG9jLnNlbC5wcmltSW5kZXgpLCBvcHRpb25zKTsKICB9CgogIC8vIFJlc2V0IHRoZSBzZWxlY3Rpb24gdG8gYSBzaW5nbGUgcmFuZ2UuCiAgZnVuY3Rpb24gc2V0U2ltcGxlU2VsZWN0aW9uKGRvYywgYW5jaG9yLCBoZWFkLCBvcHRpb25zKSB7CiAgICBzZXRTZWxlY3Rpb24oZG9jLCBzaW1wbGVTZWxlY3Rpb24oYW5jaG9yLCBoZWFkKSwgb3B0aW9ucyk7CiAgfQoKICAvLyBHaXZlIGJlZm9yZVNlbGVjdGlvbkNoYW5nZSBoYW5kbGVycyBhIGNoYW5nZSB0byBpbmZsdWVuY2UgYQogIC8vIHNlbGVjdGlvbiB1cGRhdGUuCiAgZnVuY3Rpb24gZmlsdGVyU2VsZWN0aW9uQ2hhbmdlKGRvYywgc2VsLCBvcHRpb25zKSB7CiAgICB2YXIgb2JqID0gewogICAgICByYW5nZXM6IHNlbC5yYW5nZXMsCiAgICAgIHVwZGF0ZTogZnVuY3Rpb24ocmFuZ2VzKSB7CiAgICAgICAgdmFyIHRoaXMkMSA9IHRoaXM7CgogICAgICAgIHRoaXMucmFuZ2VzID0gW107CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByYW5nZXMubGVuZ3RoOyBpKyspCiAgICAgICAgICB7IHRoaXMkMS5yYW5nZXNbaV0gPSBuZXcgUmFuZ2UoY2xpcFBvcyhkb2MsIHJhbmdlc1tpXS5hbmNob3IpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xpcFBvcyhkb2MsIHJhbmdlc1tpXS5oZWFkKSk7IH0KICAgICAgfSwKICAgICAgb3JpZ2luOiBvcHRpb25zICYmIG9wdGlvbnMub3JpZ2luCiAgICB9OwogICAgc2lnbmFsKGRvYywgImJlZm9yZVNlbGVjdGlvbkNoYW5nZSIsIGRvYywgb2JqKTsKICAgIGlmIChkb2MuY20pIHsgc2lnbmFsKGRvYy5jbSwgImJlZm9yZVNlbGVjdGlvbkNoYW5nZSIsIGRvYy5jbSwgb2JqKTsgfQogICAgaWYgKG9iai5yYW5nZXMgIT0gc2VsLnJhbmdlcykgeyByZXR1cm4gbm9ybWFsaXplU2VsZWN0aW9uKGRvYy5jbSwgb2JqLnJhbmdlcywgb2JqLnJhbmdlcy5sZW5ndGggLSAxKSB9CiAgICBlbHNlIHsgcmV0dXJuIHNlbCB9CiAgfQoKICBmdW5jdGlvbiBzZXRTZWxlY3Rpb25SZXBsYWNlSGlzdG9yeShkb2MsIHNlbCwgb3B0aW9ucykgewogICAgdmFyIGRvbmUgPSBkb2MuaGlzdG9yeS5kb25lLCBsYXN0ID0gbHN0KGRvbmUpOwogICAgaWYgKGxhc3QgJiYgbGFzdC5yYW5nZXMpIHsKICAgICAgZG9uZVtkb25lLmxlbmd0aCAtIDFdID0gc2VsOwogICAgICBzZXRTZWxlY3Rpb25Ob1VuZG8oZG9jLCBzZWwsIG9wdGlvbnMpOwogICAgfSBlbHNlIHsKICAgICAgc2V0U2VsZWN0aW9uKGRvYywgc2VsLCBvcHRpb25zKTsKICAgIH0KICB9CgogIC8vIFNldCBhIG5ldyBzZWxlY3Rpb24uCiAgZnVuY3Rpb24gc2V0U2VsZWN0aW9uKGRvYywgc2VsLCBvcHRpb25zKSB7CiAgICBzZXRTZWxlY3Rpb25Ob1VuZG8oZG9jLCBzZWwsIG9wdGlvbnMpOwogICAgYWRkU2VsZWN0aW9uVG9IaXN0b3J5KGRvYywgZG9jLnNlbCwgZG9jLmNtID8gZG9jLmNtLmN1ck9wLmlkIDogTmFOLCBvcHRpb25zKTsKICB9CgogIGZ1bmN0aW9uIHNldFNlbGVjdGlvbk5vVW5kbyhkb2MsIHNlbCwgb3B0aW9ucykgewogICAgaWYgKGhhc0hhbmRsZXIoZG9jLCAiYmVmb3JlU2VsZWN0aW9uQ2hhbmdlIikgfHwgZG9jLmNtICYmIGhhc0hhbmRsZXIoZG9jLmNtLCAiYmVmb3JlU2VsZWN0aW9uQ2hhbmdlIikpCiAgICAgIHsgc2VsID0gZmlsdGVyU2VsZWN0aW9uQ2hhbmdlKGRvYywgc2VsLCBvcHRpb25zKTsgfQoKICAgIHZhciBiaWFzID0gb3B0aW9ucyAmJiBvcHRpb25zLmJpYXMgfHwKICAgICAgKGNtcChzZWwucHJpbWFyeSgpLmhlYWQsIGRvYy5zZWwucHJpbWFyeSgpLmhlYWQpIDwgMCA/IC0xIDogMSk7CiAgICBzZXRTZWxlY3Rpb25Jbm5lcihkb2MsIHNraXBBdG9taWNJblNlbGVjdGlvbihkb2MsIHNlbCwgYmlhcywgdHJ1ZSkpOwoKICAgIGlmICghKG9wdGlvbnMgJiYgb3B0aW9ucy5zY3JvbGwgPT09IGZhbHNlKSAmJiBkb2MuY20pCiAgICAgIHsgZW5zdXJlQ3Vyc29yVmlzaWJsZShkb2MuY20pOyB9CiAgfQoKICBmdW5jdGlvbiBzZXRTZWxlY3Rpb25Jbm5lcihkb2MsIHNlbCkgewogICAgaWYgKHNlbC5lcXVhbHMoZG9jLnNlbCkpIHsgcmV0dXJuIH0KCiAgICBkb2Muc2VsID0gc2VsOwoKICAgIGlmIChkb2MuY20pIHsKICAgICAgZG9jLmNtLmN1ck9wLnVwZGF0ZUlucHV0ID0gMTsKICAgICAgZG9jLmNtLmN1ck9wLnNlbGVjdGlvbkNoYW5nZWQgPSB0cnVlOwogICAgICBzaWduYWxDdXJzb3JBY3Rpdml0eShkb2MuY20pOwogICAgfQogICAgc2lnbmFsTGF0ZXIoZG9jLCAiY3Vyc29yQWN0aXZpdHkiLCBkb2MpOwogIH0KCiAgLy8gVmVyaWZ5IHRoYXQgdGhlIHNlbGVjdGlvbiBkb2VzIG5vdCBwYXJ0aWFsbHkgc2VsZWN0IGFueSBhdG9taWMKICAvLyBtYXJrZWQgcmFuZ2VzLgogIGZ1bmN0aW9uIHJlQ2hlY2tTZWxlY3Rpb24oZG9jKSB7CiAgICBzZXRTZWxlY3Rpb25Jbm5lcihkb2MsIHNraXBBdG9taWNJblNlbGVjdGlvbihkb2MsIGRvYy5zZWwsIG51bGwsIGZhbHNlKSk7CiAgfQoKICAvLyBSZXR1cm4gYSBzZWxlY3Rpb24gdGhhdCBkb2VzIG5vdCBwYXJ0aWFsbHkgc2VsZWN0IGFueSBhdG9taWMKICAvLyByYW5nZXMuCiAgZnVuY3Rpb24gc2tpcEF0b21pY0luU2VsZWN0aW9uKGRvYywgc2VsLCBiaWFzLCBtYXlDbGVhcikgewogICAgdmFyIG91dDsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc2VsLnJhbmdlcy5sZW5ndGg7IGkrKykgewogICAgICB2YXIgcmFuZ2UgPSBzZWwucmFuZ2VzW2ldOwogICAgICB2YXIgb2xkID0gc2VsLnJhbmdlcy5sZW5ndGggPT0gZG9jLnNlbC5yYW5nZXMubGVuZ3RoICYmIGRvYy5zZWwucmFuZ2VzW2ldOwogICAgICB2YXIgbmV3QW5jaG9yID0gc2tpcEF0b21pYyhkb2MsIHJhbmdlLmFuY2hvciwgb2xkICYmIG9sZC5hbmNob3IsIGJpYXMsIG1heUNsZWFyKTsKICAgICAgdmFyIG5ld0hlYWQgPSBza2lwQXRvbWljKGRvYywgcmFuZ2UuaGVhZCwgb2xkICYmIG9sZC5oZWFkLCBiaWFzLCBtYXlDbGVhcik7CiAgICAgIGlmIChvdXQgfHwgbmV3QW5jaG9yICE9IHJhbmdlLmFuY2hvciB8fCBuZXdIZWFkICE9IHJhbmdlLmhlYWQpIHsKICAgICAgICBpZiAoIW91dCkgeyBvdXQgPSBzZWwucmFuZ2VzLnNsaWNlKDAsIGkpOyB9CiAgICAgICAgb3V0W2ldID0gbmV3IFJhbmdlKG5ld0FuY2hvciwgbmV3SGVhZCk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBvdXQgPyBub3JtYWxpemVTZWxlY3Rpb24oZG9jLmNtLCBvdXQsIHNlbC5wcmltSW5kZXgpIDogc2VsCiAgfQoKICBmdW5jdGlvbiBza2lwQXRvbWljSW5uZXIoZG9jLCBwb3MsIG9sZFBvcywgZGlyLCBtYXlDbGVhcikgewogICAgdmFyIGxpbmUgPSBnZXRMaW5lKGRvYywgcG9zLmxpbmUpOwogICAgaWYgKGxpbmUubWFya2VkU3BhbnMpIHsgZm9yICh2YXIgaSA9IDA7IGkgPCBsaW5lLm1hcmtlZFNwYW5zLmxlbmd0aDsgKytpKSB7CiAgICAgIHZhciBzcCA9IGxpbmUubWFya2VkU3BhbnNbaV0sIG0gPSBzcC5tYXJrZXI7CgogICAgICAvLyBEZXRlcm1pbmUgaWYgd2Ugc2hvdWxkIHByZXZlbnQgdGhlIGN1cnNvciBiZWluZyBwbGFjZWQgdG8gdGhlIGxlZnQvcmlnaHQgb2YgYW4gYXRvbWljIG1hcmtlcgogICAgICAvLyBIaXN0b3JpY2FsbHkgdGhpcyB3YXMgZGV0ZXJtaW5lZCB1c2luZyB0aGUgaW5jbHVzaXZlTGVmdC9SaWdodCBvcHRpb24sIGJ1dCB0aGUgbmV3IHdheSB0byBjb250cm9sIGl0CiAgICAgIC8vIGlzIHdpdGggc2VsZWN0TGVmdC9SaWdodAogICAgICB2YXIgcHJldmVudEN1cnNvckxlZnQgPSAoInNlbGVjdExlZnQiIGluIG0pID8gIW0uc2VsZWN0TGVmdCA6IG0uaW5jbHVzaXZlTGVmdDsKICAgICAgdmFyIHByZXZlbnRDdXJzb3JSaWdodCA9ICgic2VsZWN0UmlnaHQiIGluIG0pID8gIW0uc2VsZWN0UmlnaHQgOiBtLmluY2x1c2l2ZVJpZ2h0OwoKICAgICAgaWYgKChzcC5mcm9tID09IG51bGwgfHwgKHByZXZlbnRDdXJzb3JMZWZ0ID8gc3AuZnJvbSA8PSBwb3MuY2ggOiBzcC5mcm9tIDwgcG9zLmNoKSkgJiYKICAgICAgICAgIChzcC50byA9PSBudWxsIHx8IChwcmV2ZW50Q3Vyc29yUmlnaHQgPyBzcC50byA+PSBwb3MuY2ggOiBzcC50byA+IHBvcy5jaCkpKSB7CiAgICAgICAgaWYgKG1heUNsZWFyKSB7CiAgICAgICAgICBzaWduYWwobSwgImJlZm9yZUN1cnNvckVudGVyIik7CiAgICAgICAgICBpZiAobS5leHBsaWNpdGx5Q2xlYXJlZCkgewogICAgICAgICAgICBpZiAoIWxpbmUubWFya2VkU3BhbnMpIHsgYnJlYWsgfQogICAgICAgICAgICBlbHNlIHstLWk7IGNvbnRpbnVlfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoIW0uYXRvbWljKSB7IGNvbnRpbnVlIH0KCiAgICAgICAgaWYgKG9sZFBvcykgewogICAgICAgICAgdmFyIG5lYXIgPSBtLmZpbmQoZGlyIDwgMCA/IDEgOiAtMSksIGRpZmYgPSAodm9pZCAwKTsKICAgICAgICAgIGlmIChkaXIgPCAwID8gcHJldmVudEN1cnNvclJpZ2h0IDogcHJldmVudEN1cnNvckxlZnQpCiAgICAgICAgICAgIHsgbmVhciA9IG1vdmVQb3MoZG9jLCBuZWFyLCAtZGlyLCBuZWFyICYmIG5lYXIubGluZSA9PSBwb3MubGluZSA/IGxpbmUgOiBudWxsKTsgfQogICAgICAgICAgaWYgKG5lYXIgJiYgbmVhci5saW5lID09IHBvcy5saW5lICYmIChkaWZmID0gY21wKG5lYXIsIG9sZFBvcykpICYmIChkaXIgPCAwID8gZGlmZiA8IDAgOiBkaWZmID4gMCkpCiAgICAgICAgICAgIHsgcmV0dXJuIHNraXBBdG9taWNJbm5lcihkb2MsIG5lYXIsIHBvcywgZGlyLCBtYXlDbGVhcikgfQogICAgICAgIH0KCiAgICAgICAgdmFyIGZhciA9IG0uZmluZChkaXIgPCAwID8gLTEgOiAxKTsKICAgICAgICBpZiAoZGlyIDwgMCA/IHByZXZlbnRDdXJzb3JMZWZ0IDogcHJldmVudEN1cnNvclJpZ2h0KQogICAgICAgICAgeyBmYXIgPSBtb3ZlUG9zKGRvYywgZmFyLCBkaXIsIGZhci5saW5lID09IHBvcy5saW5lID8gbGluZSA6IG51bGwpOyB9CiAgICAgICAgcmV0dXJuIGZhciA/IHNraXBBdG9taWNJbm5lcihkb2MsIGZhciwgcG9zLCBkaXIsIG1heUNsZWFyKSA6IG51bGwKICAgICAgfQogICAgfSB9CiAgICByZXR1cm4gcG9zCiAgfQoKICAvLyBFbnN1cmUgYSBnaXZlbiBwb3NpdGlvbiBpcyBub3QgaW5zaWRlIGFuIGF0b21pYyByYW5nZS4KICBmdW5jdGlvbiBza2lwQXRvbWljKGRvYywgcG9zLCBvbGRQb3MsIGJpYXMsIG1heUNsZWFyKSB7CiAgICB2YXIgZGlyID0gYmlhcyB8fCAxOwogICAgdmFyIGZvdW5kID0gc2tpcEF0b21pY0lubmVyKGRvYywgcG9zLCBvbGRQb3MsIGRpciwgbWF5Q2xlYXIpIHx8CiAgICAgICAgKCFtYXlDbGVhciAmJiBza2lwQXRvbWljSW5uZXIoZG9jLCBwb3MsIG9sZFBvcywgZGlyLCB0cnVlKSkgfHwKICAgICAgICBza2lwQXRvbWljSW5uZXIoZG9jLCBwb3MsIG9sZFBvcywgLWRpciwgbWF5Q2xlYXIpIHx8CiAgICAgICAgKCFtYXlDbGVhciAmJiBza2lwQXRvbWljSW5uZXIoZG9jLCBwb3MsIG9sZFBvcywgLWRpciwgdHJ1ZSkpOwogICAgaWYgKCFmb3VuZCkgewogICAgICBkb2MuY2FudEVkaXQgPSB0cnVlOwogICAgICByZXR1cm4gUG9zKGRvYy5maXJzdCwgMCkKICAgIH0KICAgIHJldHVybiBmb3VuZAogIH0KCiAgZnVuY3Rpb24gbW92ZVBvcyhkb2MsIHBvcywgZGlyLCBsaW5lKSB7CiAgICBpZiAoZGlyIDwgMCAmJiBwb3MuY2ggPT0gMCkgewogICAgICBpZiAocG9zLmxpbmUgPiBkb2MuZmlyc3QpIHsgcmV0dXJuIGNsaXBQb3MoZG9jLCBQb3MocG9zLmxpbmUgLSAxKSkgfQogICAgICBlbHNlIHsgcmV0dXJuIG51bGwgfQogICAgfSBlbHNlIGlmIChkaXIgPiAwICYmIHBvcy5jaCA9PSAobGluZSB8fCBnZXRMaW5lKGRvYywgcG9zLmxpbmUpKS50ZXh0Lmxlbmd0aCkgewogICAgICBpZiAocG9zLmxpbmUgPCBkb2MuZmlyc3QgKyBkb2Muc2l6ZSAtIDEpIHsgcmV0dXJuIFBvcyhwb3MubGluZSArIDEsIDApIH0KICAgICAgZWxzZSB7IHJldHVybiBudWxsIH0KICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBuZXcgUG9zKHBvcy5saW5lLCBwb3MuY2ggKyBkaXIpCiAgICB9CiAgfQoKICBmdW5jdGlvbiBzZWxlY3RBbGwoY20pIHsKICAgIGNtLnNldFNlbGVjdGlvbihQb3MoY20uZmlyc3RMaW5lKCksIDApLCBQb3MoY20ubGFzdExpbmUoKSksIHNlbF9kb250U2Nyb2xsKTsKICB9CgogIC8vIFVQREFUSU5HCgogIC8vIEFsbG93ICJiZWZvcmVDaGFuZ2UiIGV2ZW50IGhhbmRsZXJzIHRvIGluZmx1ZW5jZSBhIGNoYW5nZQogIGZ1bmN0aW9uIGZpbHRlckNoYW5nZShkb2MsIGNoYW5nZSwgdXBkYXRlKSB7CiAgICB2YXIgb2JqID0gewogICAgICBjYW5jZWxlZDogZmFsc2UsCiAgICAgIGZyb206IGNoYW5nZS5mcm9tLAogICAgICB0bzogY2hhbmdlLnRvLAogICAgICB0ZXh0OiBjaGFuZ2UudGV4dCwKICAgICAgb3JpZ2luOiBjaGFuZ2Uub3JpZ2luLAogICAgICBjYW5jZWw6IGZ1bmN0aW9uICgpIHsgcmV0dXJuIG9iai5jYW5jZWxlZCA9IHRydWU7IH0KICAgIH07CiAgICBpZiAodXBkYXRlKSB7IG9iai51cGRhdGUgPSBmdW5jdGlvbiAoZnJvbSwgdG8sIHRleHQsIG9yaWdpbikgewogICAgICBpZiAoZnJvbSkgeyBvYmouZnJvbSA9IGNsaXBQb3MoZG9jLCBmcm9tKTsgfQogICAgICBpZiAodG8pIHsgb2JqLnRvID0gY2xpcFBvcyhkb2MsIHRvKTsgfQogICAgICBpZiAodGV4dCkgeyBvYmoudGV4dCA9IHRleHQ7IH0KICAgICAgaWYgKG9yaWdpbiAhPT0gdW5kZWZpbmVkKSB7IG9iai5vcmlnaW4gPSBvcmlnaW47IH0KICAgIH07IH0KICAgIHNpZ25hbChkb2MsICJiZWZvcmVDaGFuZ2UiLCBkb2MsIG9iaik7CiAgICBpZiAoZG9jLmNtKSB7IHNpZ25hbChkb2MuY20sICJiZWZvcmVDaGFuZ2UiLCBkb2MuY20sIG9iaik7IH0KCiAgICBpZiAob2JqLmNhbmNlbGVkKSB7CiAgICAgIGlmIChkb2MuY20pIHsgZG9jLmNtLmN1ck9wLnVwZGF0ZUlucHV0ID0gMjsgfQogICAgICByZXR1cm4gbnVsbAogICAgfQogICAgcmV0dXJuIHtmcm9tOiBvYmouZnJvbSwgdG86IG9iai50bywgdGV4dDogb2JqLnRleHQsIG9yaWdpbjogb2JqLm9yaWdpbn0KICB9CgogIC8vIEFwcGx5IGEgY2hhbmdlIHRvIGEgZG9jdW1lbnQsIGFuZCBhZGQgaXQgdG8gdGhlIGRvY3VtZW50J3MKICAvLyBoaXN0b3J5LCBhbmQgcHJvcGFnYXRpbmcgaXQgdG8gYWxsIGxpbmtlZCBkb2N1bWVudHMuCiAgZnVuY3Rpb24gbWFrZUNoYW5nZShkb2MsIGNoYW5nZSwgaWdub3JlUmVhZE9ubHkpIHsKICAgIGlmIChkb2MuY20pIHsKICAgICAgaWYgKCFkb2MuY20uY3VyT3ApIHsgcmV0dXJuIG9wZXJhdGlvbihkb2MuY20sIG1ha2VDaGFuZ2UpKGRvYywgY2hhbmdlLCBpZ25vcmVSZWFkT25seSkgfQogICAgICBpZiAoZG9jLmNtLnN0YXRlLnN1cHByZXNzRWRpdHMpIHsgcmV0dXJuIH0KICAgIH0KCiAgICBpZiAoaGFzSGFuZGxlcihkb2MsICJiZWZvcmVDaGFuZ2UiKSB8fCBkb2MuY20gJiYgaGFzSGFuZGxlcihkb2MuY20sICJiZWZvcmVDaGFuZ2UiKSkgewogICAgICBjaGFuZ2UgPSBmaWx0ZXJDaGFuZ2UoZG9jLCBjaGFuZ2UsIHRydWUpOwogICAgICBpZiAoIWNoYW5nZSkgeyByZXR1cm4gfQogICAgfQoKICAgIC8vIFBvc3NpYmx5IHNwbGl0IG9yIHN1cHByZXNzIHRoZSB1cGRhdGUgYmFzZWQgb24gdGhlIHByZXNlbmNlCiAgICAvLyBvZiByZWFkLW9ubHkgc3BhbnMgaW4gaXRzIHJhbmdlLgogICAgdmFyIHNwbGl0ID0gc2F3UmVhZE9ubHlTcGFucyAmJiAhaWdub3JlUmVhZE9ubHkgJiYgcmVtb3ZlUmVhZE9ubHlSYW5nZXMoZG9jLCBjaGFuZ2UuZnJvbSwgY2hhbmdlLnRvKTsKICAgIGlmIChzcGxpdCkgewogICAgICBmb3IgKHZhciBpID0gc3BsaXQubGVuZ3RoIC0gMTsgaSA+PSAwOyAtLWkpCiAgICAgICAgeyBtYWtlQ2hhbmdlSW5uZXIoZG9jLCB7ZnJvbTogc3BsaXRbaV0uZnJvbSwgdG86IHNwbGl0W2ldLnRvLCB0ZXh0OiBpID8gWyIiXSA6IGNoYW5nZS50ZXh0LCBvcmlnaW46IGNoYW5nZS5vcmlnaW59KTsgfQogICAgfSBlbHNlIHsKICAgICAgbWFrZUNoYW5nZUlubmVyKGRvYywgY2hhbmdlKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIG1ha2VDaGFuZ2VJbm5lcihkb2MsIGNoYW5nZSkgewogICAgaWYgKGNoYW5nZS50ZXh0Lmxlbmd0aCA9PSAxICYmIGNoYW5nZS50ZXh0WzBdID09ICIiICYmIGNtcChjaGFuZ2UuZnJvbSwgY2hhbmdlLnRvKSA9PSAwKSB7IHJldHVybiB9CiAgICB2YXIgc2VsQWZ0ZXIgPSBjb21wdXRlU2VsQWZ0ZXJDaGFuZ2UoZG9jLCBjaGFuZ2UpOwogICAgYWRkQ2hhbmdlVG9IaXN0b3J5KGRvYywgY2hhbmdlLCBzZWxBZnRlciwgZG9jLmNtID8gZG9jLmNtLmN1ck9wLmlkIDogTmFOKTsKCiAgICBtYWtlQ2hhbmdlU2luZ2xlRG9jKGRvYywgY2hhbmdlLCBzZWxBZnRlciwgc3RyZXRjaFNwYW5zT3ZlckNoYW5nZShkb2MsIGNoYW5nZSkpOwogICAgdmFyIHJlYmFzZWQgPSBbXTsKCiAgICBsaW5rZWREb2NzKGRvYywgZnVuY3Rpb24gKGRvYywgc2hhcmVkSGlzdCkgewogICAgICBpZiAoIXNoYXJlZEhpc3QgJiYgaW5kZXhPZihyZWJhc2VkLCBkb2MuaGlzdG9yeSkgPT0gLTEpIHsKICAgICAgICByZWJhc2VIaXN0KGRvYy5oaXN0b3J5LCBjaGFuZ2UpOwogICAgICAgIHJlYmFzZWQucHVzaChkb2MuaGlzdG9yeSk7CiAgICAgIH0KICAgICAgbWFrZUNoYW5nZVNpbmdsZURvYyhkb2MsIGNoYW5nZSwgbnVsbCwgc3RyZXRjaFNwYW5zT3ZlckNoYW5nZShkb2MsIGNoYW5nZSkpOwogICAgfSk7CiAgfQoKICAvLyBSZXZlcnQgYSBjaGFuZ2Ugc3RvcmVkIGluIGEgZG9jdW1lbnQncyBoaXN0b3J5LgogIGZ1bmN0aW9uIG1ha2VDaGFuZ2VGcm9tSGlzdG9yeShkb2MsIHR5cGUsIGFsbG93U2VsZWN0aW9uT25seSkgewogICAgdmFyIHN1cHByZXNzID0gZG9jLmNtICYmIGRvYy5jbS5zdGF0ZS5zdXBwcmVzc0VkaXRzOwogICAgaWYgKHN1cHByZXNzICYmICFhbGxvd1NlbGVjdGlvbk9ubHkpIHsgcmV0dXJuIH0KCiAgICB2YXIgaGlzdCA9IGRvYy5oaXN0b3J5LCBldmVudCwgc2VsQWZ0ZXIgPSBkb2Muc2VsOwogICAgdmFyIHNvdXJjZSA9IHR5cGUgPT0gInVuZG8iID8gaGlzdC5kb25lIDogaGlzdC51bmRvbmUsIGRlc3QgPSB0eXBlID09ICJ1bmRvIiA/IGhpc3QudW5kb25lIDogaGlzdC5kb25lOwoKICAgIC8vIFZlcmlmeSB0aGF0IHRoZXJlIGlzIGEgdXNlYWJsZSBldmVudCAoc28gdGhhdCBjdHJsLXogd29uJ3QKICAgIC8vIG5lZWRsZXNzbHkgY2xlYXIgc2VsZWN0aW9uIGV2ZW50cykKICAgIHZhciBpID0gMDsKICAgIGZvciAoOyBpIDwgc291cmNlLmxlbmd0aDsgaSsrKSB7CiAgICAgIGV2ZW50ID0gc291cmNlW2ldOwogICAgICBpZiAoYWxsb3dTZWxlY3Rpb25Pbmx5ID8gZXZlbnQucmFuZ2VzICYmICFldmVudC5lcXVhbHMoZG9jLnNlbCkgOiAhZXZlbnQucmFuZ2VzKQogICAgICAgIHsgYnJlYWsgfQogICAgfQogICAgaWYgKGkgPT0gc291cmNlLmxlbmd0aCkgeyByZXR1cm4gfQogICAgaGlzdC5sYXN0T3JpZ2luID0gaGlzdC5sYXN0U2VsT3JpZ2luID0gbnVsbDsKCiAgICBmb3IgKDs7KSB7CiAgICAgIGV2ZW50ID0gc291cmNlLnBvcCgpOwogICAgICBpZiAoZXZlbnQucmFuZ2VzKSB7CiAgICAgICAgcHVzaFNlbGVjdGlvblRvSGlzdG9yeShldmVudCwgZGVzdCk7CiAgICAgICAgaWYgKGFsbG93U2VsZWN0aW9uT25seSAmJiAhZXZlbnQuZXF1YWxzKGRvYy5zZWwpKSB7CiAgICAgICAgICBzZXRTZWxlY3Rpb24oZG9jLCBldmVudCwge2NsZWFyUmVkbzogZmFsc2V9KTsKICAgICAgICAgIHJldHVybgogICAgICAgIH0KICAgICAgICBzZWxBZnRlciA9IGV2ZW50OwogICAgICB9IGVsc2UgaWYgKHN1cHByZXNzKSB7CiAgICAgICAgc291cmNlLnB1c2goZXZlbnQpOwogICAgICAgIHJldHVybgogICAgICB9IGVsc2UgeyBicmVhayB9CiAgICB9CgogICAgLy8gQnVpbGQgdXAgYSByZXZlcnNlIGNoYW5nZSBvYmplY3QgdG8gYWRkIHRvIHRoZSBvcHBvc2l0ZSBoaXN0b3J5CiAgICAvLyBzdGFjayAocmVkbyB3aGVuIHVuZG9pbmcsIGFuZCB2aWNlIHZlcnNhKS4KICAgIHZhciBhbnRpQ2hhbmdlcyA9IFtdOwogICAgcHVzaFNlbGVjdGlvblRvSGlzdG9yeShzZWxBZnRlciwgZGVzdCk7CiAgICBkZXN0LnB1c2goe2NoYW5nZXM6IGFudGlDaGFuZ2VzLCBnZW5lcmF0aW9uOiBoaXN0LmdlbmVyYXRpb259KTsKICAgIGhpc3QuZ2VuZXJhdGlvbiA9IGV2ZW50LmdlbmVyYXRpb24gfHwgKytoaXN0Lm1heEdlbmVyYXRpb247CgogICAgdmFyIGZpbHRlciA9IGhhc0hhbmRsZXIoZG9jLCAiYmVmb3JlQ2hhbmdlIikgfHwgZG9jLmNtICYmIGhhc0hhbmRsZXIoZG9jLmNtLCAiYmVmb3JlQ2hhbmdlIik7CgogICAgdmFyIGxvb3AgPSBmdW5jdGlvbiAoIGkgKSB7CiAgICAgIHZhciBjaGFuZ2UgPSBldmVudC5jaGFuZ2VzW2ldOwogICAgICBjaGFuZ2Uub3JpZ2luID0gdHlwZTsKICAgICAgaWYgKGZpbHRlciAmJiAhZmlsdGVyQ2hhbmdlKGRvYywgY2hhbmdlLCBmYWxzZSkpIHsKICAgICAgICBzb3VyY2UubGVuZ3RoID0gMDsKICAgICAgICByZXR1cm4ge30KICAgICAgfQoKICAgICAgYW50aUNoYW5nZXMucHVzaChoaXN0b3J5Q2hhbmdlRnJvbUNoYW5nZShkb2MsIGNoYW5nZSkpOwoKICAgICAgdmFyIGFmdGVyID0gaSA/IGNvbXB1dGVTZWxBZnRlckNoYW5nZShkb2MsIGNoYW5nZSkgOiBsc3Qoc291cmNlKTsKICAgICAgbWFrZUNoYW5nZVNpbmdsZURvYyhkb2MsIGNoYW5nZSwgYWZ0ZXIsIG1lcmdlT2xkU3BhbnMoZG9jLCBjaGFuZ2UpKTsKICAgICAgaWYgKCFpICYmIGRvYy5jbSkgeyBkb2MuY20uc2Nyb2xsSW50b1ZpZXcoe2Zyb206IGNoYW5nZS5mcm9tLCB0bzogY2hhbmdlRW5kKGNoYW5nZSl9KTsgfQogICAgICB2YXIgcmViYXNlZCA9IFtdOwoKICAgICAgLy8gUHJvcGFnYXRlIHRvIHRoZSBsaW5rZWQgZG9jdW1lbnRzCiAgICAgIGxpbmtlZERvY3MoZG9jLCBmdW5jdGlvbiAoZG9jLCBzaGFyZWRIaXN0KSB7CiAgICAgICAgaWYgKCFzaGFyZWRIaXN0ICYmIGluZGV4T2YocmViYXNlZCwgZG9jLmhpc3RvcnkpID09IC0xKSB7CiAgICAgICAgICByZWJhc2VIaXN0KGRvYy5oaXN0b3J5LCBjaGFuZ2UpOwogICAgICAgICAgcmViYXNlZC5wdXNoKGRvYy5oaXN0b3J5KTsKICAgICAgICB9CiAgICAgICAgbWFrZUNoYW5nZVNpbmdsZURvYyhkb2MsIGNoYW5nZSwgbnVsbCwgbWVyZ2VPbGRTcGFucyhkb2MsIGNoYW5nZSkpOwogICAgICB9KTsKICAgIH07CgogICAgZm9yICh2YXIgaSQxID0gZXZlbnQuY2hhbmdlcy5sZW5ndGggLSAxOyBpJDEgPj0gMDsgLS1pJDEpIHsKICAgICAgdmFyIHJldHVybmVkID0gbG9vcCggaSQxICk7CgogICAgICBpZiAoIHJldHVybmVkICkgcmV0dXJuIHJldHVybmVkLnY7CiAgICB9CiAgfQoKICAvLyBTdWItdmlld3MgbmVlZCB0aGVpciBsaW5lIG51bWJlcnMgc2hpZnRlZCB3aGVuIHRleHQgaXMgYWRkZWQKICAvLyBhYm92ZSBvciBiZWxvdyB0aGVtIGluIHRoZSBwYXJlbnQgZG9jdW1lbnQuCiAgZnVuY3Rpb24gc2hpZnREb2MoZG9jLCBkaXN0YW5jZSkgewogICAgaWYgKGRpc3RhbmNlID09IDApIHsgcmV0dXJuIH0KICAgIGRvYy5maXJzdCArPSBkaXN0YW5jZTsKICAgIGRvYy5zZWwgPSBuZXcgU2VsZWN0aW9uKG1hcChkb2Muc2VsLnJhbmdlcywgZnVuY3Rpb24gKHJhbmdlKSB7IHJldHVybiBuZXcgUmFuZ2UoCiAgICAgIFBvcyhyYW5nZS5hbmNob3IubGluZSArIGRpc3RhbmNlLCByYW5nZS5hbmNob3IuY2gpLAogICAgICBQb3MocmFuZ2UuaGVhZC5saW5lICsgZGlzdGFuY2UsIHJhbmdlLmhlYWQuY2gpCiAgICApOyB9KSwgZG9jLnNlbC5wcmltSW5kZXgpOwogICAgaWYgKGRvYy5jbSkgewogICAgICByZWdDaGFuZ2UoZG9jLmNtLCBkb2MuZmlyc3QsIGRvYy5maXJzdCAtIGRpc3RhbmNlLCBkaXN0YW5jZSk7CiAgICAgIGZvciAodmFyIGQgPSBkb2MuY20uZGlzcGxheSwgbCA9IGQudmlld0Zyb207IGwgPCBkLnZpZXdUbzsgbCsrKQogICAgICAgIHsgcmVnTGluZUNoYW5nZShkb2MuY20sIGwsICJndXR0ZXIiKTsgfQogICAgfQogIH0KCiAgLy8gTW9yZSBsb3dlci1sZXZlbCBjaGFuZ2UgZnVuY3Rpb24sIGhhbmRsaW5nIG9ubHkgYSBzaW5nbGUgZG9jdW1lbnQKICAvLyAobm90IGxpbmtlZCBvbmVzKS4KICBmdW5jdGlvbiBtYWtlQ2hhbmdlU2luZ2xlRG9jKGRvYywgY2hhbmdlLCBzZWxBZnRlciwgc3BhbnMpIHsKICAgIGlmIChkb2MuY20gJiYgIWRvYy5jbS5jdXJPcCkKICAgICAgeyByZXR1cm4gb3BlcmF0aW9uKGRvYy5jbSwgbWFrZUNoYW5nZVNpbmdsZURvYykoZG9jLCBjaGFuZ2UsIHNlbEFmdGVyLCBzcGFucykgfQoKICAgIGlmIChjaGFuZ2UudG8ubGluZSA8IGRvYy5maXJzdCkgewogICAgICBzaGlmdERvYyhkb2MsIGNoYW5nZS50ZXh0Lmxlbmd0aCAtIDEgLSAoY2hhbmdlLnRvLmxpbmUgLSBjaGFuZ2UuZnJvbS5saW5lKSk7CiAgICAgIHJldHVybgogICAgfQogICAgaWYgKGNoYW5nZS5mcm9tLmxpbmUgPiBkb2MubGFzdExpbmUoKSkgeyByZXR1cm4gfQoKICAgIC8vIENsaXAgdGhlIGNoYW5nZSB0byB0aGUgc2l6ZSBvZiB0aGlzIGRvYwogICAgaWYgKGNoYW5nZS5mcm9tLmxpbmUgPCBkb2MuZmlyc3QpIHsKICAgICAgdmFyIHNoaWZ0ID0gY2hhbmdlLnRleHQubGVuZ3RoIC0gMSAtIChkb2MuZmlyc3QgLSBjaGFuZ2UuZnJvbS5saW5lKTsKICAgICAgc2hpZnREb2MoZG9jLCBzaGlmdCk7CiAgICAgIGNoYW5nZSA9IHtmcm9tOiBQb3MoZG9jLmZpcnN0LCAwKSwgdG86IFBvcyhjaGFuZ2UudG8ubGluZSArIHNoaWZ0LCBjaGFuZ2UudG8uY2gpLAogICAgICAgICAgICAgICAgdGV4dDogW2xzdChjaGFuZ2UudGV4dCldLCBvcmlnaW46IGNoYW5nZS5vcmlnaW59OwogICAgfQogICAgdmFyIGxhc3QgPSBkb2MubGFzdExpbmUoKTsKICAgIGlmIChjaGFuZ2UudG8ubGluZSA+IGxhc3QpIHsKICAgICAgY2hhbmdlID0ge2Zyb206IGNoYW5nZS5mcm9tLCB0bzogUG9zKGxhc3QsIGdldExpbmUoZG9jLCBsYXN0KS50ZXh0Lmxlbmd0aCksCiAgICAgICAgICAgICAgICB0ZXh0OiBbY2hhbmdlLnRleHRbMF1dLCBvcmlnaW46IGNoYW5nZS5vcmlnaW59OwogICAgfQoKICAgIGNoYW5nZS5yZW1vdmVkID0gZ2V0QmV0d2Vlbihkb2MsIGNoYW5nZS5mcm9tLCBjaGFuZ2UudG8pOwoKICAgIGlmICghc2VsQWZ0ZXIpIHsgc2VsQWZ0ZXIgPSBjb21wdXRlU2VsQWZ0ZXJDaGFuZ2UoZG9jLCBjaGFuZ2UpOyB9CiAgICBpZiAoZG9jLmNtKSB7IG1ha2VDaGFuZ2VTaW5nbGVEb2NJbkVkaXRvcihkb2MuY20sIGNoYW5nZSwgc3BhbnMpOyB9CiAgICBlbHNlIHsgdXBkYXRlRG9jKGRvYywgY2hhbmdlLCBzcGFucyk7IH0KICAgIHNldFNlbGVjdGlvbk5vVW5kbyhkb2MsIHNlbEFmdGVyLCBzZWxfZG9udFNjcm9sbCk7CgogICAgaWYgKGRvYy5jYW50RWRpdCAmJiBza2lwQXRvbWljKGRvYywgUG9zKGRvYy5maXJzdExpbmUoKSwgMCkpKQogICAgICB7IGRvYy5jYW50RWRpdCA9IGZhbHNlOyB9CiAgfQoKICAvLyBIYW5kbGUgdGhlIGludGVyYWN0aW9uIG9mIGEgY2hhbmdlIHRvIGEgZG9jdW1lbnQgd2l0aCB0aGUgZWRpdG9yCiAgLy8gdGhhdCB0aGlzIGRvY3VtZW50IGlzIHBhcnQgb2YuCiAgZnVuY3Rpb24gbWFrZUNoYW5nZVNpbmdsZURvY0luRWRpdG9yKGNtLCBjaGFuZ2UsIHNwYW5zKSB7CiAgICB2YXIgZG9jID0gY20uZG9jLCBkaXNwbGF5ID0gY20uZGlzcGxheSwgZnJvbSA9IGNoYW5nZS5mcm9tLCB0byA9IGNoYW5nZS50bzsKCiAgICB2YXIgcmVjb21wdXRlTWF4TGVuZ3RoID0gZmFsc2UsIGNoZWNrV2lkdGhTdGFydCA9IGZyb20ubGluZTsKICAgIGlmICghY20ub3B0aW9ucy5saW5lV3JhcHBpbmcpIHsKICAgICAgY2hlY2tXaWR0aFN0YXJ0ID0gbGluZU5vKHZpc3VhbExpbmUoZ2V0TGluZShkb2MsIGZyb20ubGluZSkpKTsKICAgICAgZG9jLml0ZXIoY2hlY2tXaWR0aFN0YXJ0LCB0by5saW5lICsgMSwgZnVuY3Rpb24gKGxpbmUpIHsKICAgICAgICBpZiAobGluZSA9PSBkaXNwbGF5Lm1heExpbmUpIHsKICAgICAgICAgIHJlY29tcHV0ZU1heExlbmd0aCA9IHRydWU7CiAgICAgICAgICByZXR1cm4gdHJ1ZQogICAgICAgIH0KICAgICAgfSk7CiAgICB9CgogICAgaWYgKGRvYy5zZWwuY29udGFpbnMoY2hhbmdlLmZyb20sIGNoYW5nZS50bykgPiAtMSkKICAgICAgeyBzaWduYWxDdXJzb3JBY3Rpdml0eShjbSk7IH0KCiAgICB1cGRhdGVEb2MoZG9jLCBjaGFuZ2UsIHNwYW5zLCBlc3RpbWF0ZUhlaWdodChjbSkpOwoKICAgIGlmICghY20ub3B0aW9ucy5saW5lV3JhcHBpbmcpIHsKICAgICAgZG9jLml0ZXIoY2hlY2tXaWR0aFN0YXJ0LCBmcm9tLmxpbmUgKyBjaGFuZ2UudGV4dC5sZW5ndGgsIGZ1bmN0aW9uIChsaW5lKSB7CiAgICAgICAgdmFyIGxlbiA9IGxpbmVMZW5ndGgobGluZSk7CiAgICAgICAgaWYgKGxlbiA+IGRpc3BsYXkubWF4TGluZUxlbmd0aCkgewogICAgICAgICAgZGlzcGxheS5tYXhMaW5lID0gbGluZTsKICAgICAgICAgIGRpc3BsYXkubWF4TGluZUxlbmd0aCA9IGxlbjsKICAgICAgICAgIGRpc3BsYXkubWF4TGluZUNoYW5nZWQgPSB0cnVlOwogICAgICAgICAgcmVjb21wdXRlTWF4TGVuZ3RoID0gZmFsc2U7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgaWYgKHJlY29tcHV0ZU1heExlbmd0aCkgeyBjbS5jdXJPcC51cGRhdGVNYXhMaW5lID0gdHJ1ZTsgfQogICAgfQoKICAgIHJldHJlYXRGcm9udGllcihkb2MsIGZyb20ubGluZSk7CiAgICBzdGFydFdvcmtlcihjbSwgNDAwKTsKCiAgICB2YXIgbGVuZGlmZiA9IGNoYW5nZS50ZXh0Lmxlbmd0aCAtICh0by5saW5lIC0gZnJvbS5saW5lKSAtIDE7CiAgICAvLyBSZW1lbWJlciB0aGF0IHRoZXNlIGxpbmVzIGNoYW5nZWQsIGZvciB1cGRhdGluZyB0aGUgZGlzcGxheQogICAgaWYgKGNoYW5nZS5mdWxsKQogICAgICB7IHJlZ0NoYW5nZShjbSk7IH0KICAgIGVsc2UgaWYgKGZyb20ubGluZSA9PSB0by5saW5lICYmIGNoYW5nZS50ZXh0Lmxlbmd0aCA9PSAxICYmICFpc1dob2xlTGluZVVwZGF0ZShjbS5kb2MsIGNoYW5nZSkpCiAgICAgIHsgcmVnTGluZUNoYW5nZShjbSwgZnJvbS5saW5lLCAidGV4dCIpOyB9CiAgICBlbHNlCiAgICAgIHsgcmVnQ2hhbmdlKGNtLCBmcm9tLmxpbmUsIHRvLmxpbmUgKyAxLCBsZW5kaWZmKTsgfQoKICAgIHZhciBjaGFuZ2VzSGFuZGxlciA9IGhhc0hhbmRsZXIoY20sICJjaGFuZ2VzIiksIGNoYW5nZUhhbmRsZXIgPSBoYXNIYW5kbGVyKGNtLCAiY2hhbmdlIik7CiAgICBpZiAoY2hhbmdlSGFuZGxlciB8fCBjaGFuZ2VzSGFuZGxlcikgewogICAgICB2YXIgb2JqID0gewogICAgICAgIGZyb206IGZyb20sIHRvOiB0bywKICAgICAgICB0ZXh0OiBjaGFuZ2UudGV4dCwKICAgICAgICByZW1vdmVkOiBjaGFuZ2UucmVtb3ZlZCwKICAgICAgICBvcmlnaW46IGNoYW5nZS5vcmlnaW4KICAgICAgfTsKICAgICAgaWYgKGNoYW5nZUhhbmRsZXIpIHsgc2lnbmFsTGF0ZXIoY20sICJjaGFuZ2UiLCBjbSwgb2JqKTsgfQogICAgICBpZiAoY2hhbmdlc0hhbmRsZXIpIHsgKGNtLmN1ck9wLmNoYW5nZU9ianMgfHwgKGNtLmN1ck9wLmNoYW5nZU9ianMgPSBbXSkpLnB1c2gob2JqKTsgfQogICAgfQogICAgY20uZGlzcGxheS5zZWxGb3JDb250ZXh0TWVudSA9IG51bGw7CiAgfQoKICBmdW5jdGlvbiByZXBsYWNlUmFuZ2UoZG9jLCBjb2RlLCBmcm9tLCB0bywgb3JpZ2luKSB7CiAgICB2YXIgYXNzaWduOwoKICAgIGlmICghdG8pIHsgdG8gPSBmcm9tOyB9CiAgICBpZiAoY21wKHRvLCBmcm9tKSA8IDApIHsgKGFzc2lnbiA9IFt0bywgZnJvbV0sIGZyb20gPSBhc3NpZ25bMF0sIHRvID0gYXNzaWduWzFdKTsgfQogICAgaWYgKHR5cGVvZiBjb2RlID09ICJzdHJpbmciKSB7IGNvZGUgPSBkb2Muc3BsaXRMaW5lcyhjb2RlKTsgfQogICAgbWFrZUNoYW5nZShkb2MsIHtmcm9tOiBmcm9tLCB0bzogdG8sIHRleHQ6IGNvZGUsIG9yaWdpbjogb3JpZ2lufSk7CiAgfQoKICAvLyBSZWJhc2luZy9yZXNldHRpbmcgaGlzdG9yeSB0byBkZWFsIHdpdGggZXh0ZXJuYWxseS1zb3VyY2VkIGNoYW5nZXMKCiAgZnVuY3Rpb24gcmViYXNlSGlzdFNlbFNpbmdsZShwb3MsIGZyb20sIHRvLCBkaWZmKSB7CiAgICBpZiAodG8gPCBwb3MubGluZSkgewogICAgICBwb3MubGluZSArPSBkaWZmOwogICAgfSBlbHNlIGlmIChmcm9tIDwgcG9zLmxpbmUpIHsKICAgICAgcG9zLmxpbmUgPSBmcm9tOwogICAgICBwb3MuY2ggPSAwOwogICAgfQogIH0KCiAgLy8gVHJpZXMgdG8gcmViYXNlIGFuIGFycmF5IG9mIGhpc3RvcnkgZXZlbnRzIGdpdmVuIGEgY2hhbmdlIGluIHRoZQogIC8vIGRvY3VtZW50LiBJZiB0aGUgY2hhbmdlIHRvdWNoZXMgdGhlIHNhbWUgbGluZXMgYXMgdGhlIGV2ZW50LCB0aGUKICAvLyBldmVudCwgYW5kIGV2ZXJ5dGhpbmcgJ2JlaGluZCcgaXQsIGlzIGRpc2NhcmRlZC4gSWYgdGhlIGNoYW5nZSBpcwogIC8vIGJlZm9yZSB0aGUgZXZlbnQsIHRoZSBldmVudCdzIHBvc2l0aW9ucyBhcmUgdXBkYXRlZC4gVXNlcyBhCiAgLy8gY29weS1vbi13cml0ZSBzY2hlbWUgZm9yIHRoZSBwb3NpdGlvbnMsIHRvIGF2b2lkIGhhdmluZyB0bwogIC8vIHJlYWxsb2NhdGUgdGhlbSBhbGwgb24gZXZlcnkgcmViYXNlLCBidXQgYWxzbyBhdm9pZCBwcm9ibGVtcyB3aXRoCiAgLy8gc2hhcmVkIHBvc2l0aW9uIG9iamVjdHMgYmVpbmcgdW5zYWZlbHkgdXBkYXRlZC4KICBmdW5jdGlvbiByZWJhc2VIaXN0QXJyYXkoYXJyYXksIGZyb20sIHRvLCBkaWZmKSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFycmF5Lmxlbmd0aDsgKytpKSB7CiAgICAgIHZhciBzdWIgPSBhcnJheVtpXSwgb2sgPSB0cnVlOwogICAgICBpZiAoc3ViLnJhbmdlcykgewogICAgICAgIGlmICghc3ViLmNvcGllZCkgeyBzdWIgPSBhcnJheVtpXSA9IHN1Yi5kZWVwQ29weSgpOyBzdWIuY29waWVkID0gdHJ1ZTsgfQogICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgc3ViLnJhbmdlcy5sZW5ndGg7IGorKykgewogICAgICAgICAgcmViYXNlSGlzdFNlbFNpbmdsZShzdWIucmFuZ2VzW2pdLmFuY2hvciwgZnJvbSwgdG8sIGRpZmYpOwogICAgICAgICAgcmViYXNlSGlzdFNlbFNpbmdsZShzdWIucmFuZ2VzW2pdLmhlYWQsIGZyb20sIHRvLCBkaWZmKTsKICAgICAgICB9CiAgICAgICAgY29udGludWUKICAgICAgfQogICAgICBmb3IgKHZhciBqJDEgPSAwOyBqJDEgPCBzdWIuY2hhbmdlcy5sZW5ndGg7ICsraiQxKSB7CiAgICAgICAgdmFyIGN1ciA9IHN1Yi5jaGFuZ2VzW2okMV07CiAgICAgICAgaWYgKHRvIDwgY3VyLmZyb20ubGluZSkgewogICAgICAgICAgY3VyLmZyb20gPSBQb3MoY3VyLmZyb20ubGluZSArIGRpZmYsIGN1ci5mcm9tLmNoKTsKICAgICAgICAgIGN1ci50byA9IFBvcyhjdXIudG8ubGluZSArIGRpZmYsIGN1ci50by5jaCk7CiAgICAgICAgfSBlbHNlIGlmIChmcm9tIDw9IGN1ci50by5saW5lKSB7CiAgICAgICAgICBvayA9IGZhbHNlOwogICAgICAgICAgYnJlYWsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKCFvaykgewogICAgICAgIGFycmF5LnNwbGljZSgwLCBpICsgMSk7CiAgICAgICAgaSA9IDA7CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIHJlYmFzZUhpc3QoaGlzdCwgY2hhbmdlKSB7CiAgICB2YXIgZnJvbSA9IGNoYW5nZS5mcm9tLmxpbmUsIHRvID0gY2hhbmdlLnRvLmxpbmUsIGRpZmYgPSBjaGFuZ2UudGV4dC5sZW5ndGggLSAodG8gLSBmcm9tKSAtIDE7CiAgICByZWJhc2VIaXN0QXJyYXkoaGlzdC5kb25lLCBmcm9tLCB0bywgZGlmZik7CiAgICByZWJhc2VIaXN0QXJyYXkoaGlzdC51bmRvbmUsIGZyb20sIHRvLCBkaWZmKTsKICB9CgogIC8vIFV0aWxpdHkgZm9yIGFwcGx5aW5nIGEgY2hhbmdlIHRvIGEgbGluZSBieSBoYW5kbGUgb3IgbnVtYmVyLAogIC8vIHJldHVybmluZyB0aGUgbnVtYmVyIGFuZCBvcHRpb25hbGx5IHJlZ2lzdGVyaW5nIHRoZSBsaW5lIGFzCiAgLy8gY2hhbmdlZC4KICBmdW5jdGlvbiBjaGFuZ2VMaW5lKGRvYywgaGFuZGxlLCBjaGFuZ2VUeXBlLCBvcCkgewogICAgdmFyIG5vID0gaGFuZGxlLCBsaW5lID0gaGFuZGxlOwogICAgaWYgKHR5cGVvZiBoYW5kbGUgPT0gIm51bWJlciIpIHsgbGluZSA9IGdldExpbmUoZG9jLCBjbGlwTGluZShkb2MsIGhhbmRsZSkpOyB9CiAgICBlbHNlIHsgbm8gPSBsaW5lTm8oaGFuZGxlKTsgfQogICAgaWYgKG5vID09IG51bGwpIHsgcmV0dXJuIG51bGwgfQogICAgaWYgKG9wKGxpbmUsIG5vKSAmJiBkb2MuY20pIHsgcmVnTGluZUNoYW5nZShkb2MuY20sIG5vLCBjaGFuZ2VUeXBlKTsgfQogICAgcmV0dXJuIGxpbmUKICB9CgogIC8vIFRoZSBkb2N1bWVudCBpcyByZXByZXNlbnRlZCBhcyBhIEJUcmVlIGNvbnNpc3Rpbmcgb2YgbGVhdmVzLCB3aXRoCiAgLy8gY2h1bmsgb2YgbGluZXMgaW4gdGhlbSwgYW5kIGJyYW5jaGVzLCB3aXRoIHVwIHRvIHRlbiBsZWF2ZXMgb3IKICAvLyBvdGhlciBicmFuY2ggbm9kZXMgYmVsb3cgdGhlbS4gVGhlIHRvcCBub2RlIGlzIGFsd2F5cyBhIGJyYW5jaAogIC8vIG5vZGUsIGFuZCBpcyB0aGUgZG9jdW1lbnQgb2JqZWN0IGl0c2VsZiAobWVhbmluZyBpdCBoYXMKICAvLyBhZGRpdGlvbmFsIG1ldGhvZHMgYW5kIHByb3BlcnRpZXMpLgogIC8vCiAgLy8gQWxsIG5vZGVzIGhhdmUgcGFyZW50IGxpbmtzLiBUaGUgdHJlZSBpcyB1c2VkIGJvdGggdG8gZ28gZnJvbQogIC8vIGxpbmUgbnVtYmVycyB0byBsaW5lIG9iamVjdHMsIGFuZCB0byBnbyBmcm9tIG9iamVjdHMgdG8gbnVtYmVycy4KICAvLyBJdCBhbHNvIGluZGV4ZXMgYnkgaGVpZ2h0LCBhbmQgaXMgdXNlZCB0byBjb252ZXJ0IGJldHdlZW4gaGVpZ2h0CiAgLy8gYW5kIGxpbmUgb2JqZWN0LCBhbmQgdG8gZmluZCB0aGUgdG90YWwgaGVpZ2h0IG9mIHRoZSBkb2N1bWVudC4KICAvLwogIC8vIFNlZSBhbHNvIGh0dHA6Ly9tYXJpam5oYXZlcmJla2UubmwvYmxvZy9jb2RlbWlycm9yLWxpbmUtdHJlZS5odG1sCgogIGZ1bmN0aW9uIExlYWZDaHVuayhsaW5lcykgewogICAgdmFyIHRoaXMkMSA9IHRoaXM7CgogICAgdGhpcy5saW5lcyA9IGxpbmVzOwogICAgdGhpcy5wYXJlbnQgPSBudWxsOwogICAgdmFyIGhlaWdodCA9IDA7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxpbmVzLmxlbmd0aDsgKytpKSB7CiAgICAgIGxpbmVzW2ldLnBhcmVudCA9IHRoaXMkMTsKICAgICAgaGVpZ2h0ICs9IGxpbmVzW2ldLmhlaWdodDsKICAgIH0KICAgIHRoaXMuaGVpZ2h0ID0gaGVpZ2h0OwogIH0KCiAgTGVhZkNodW5rLnByb3RvdHlwZSA9IHsKICAgIGNodW5rU2l6ZTogZnVuY3Rpb24oKSB7IHJldHVybiB0aGlzLmxpbmVzLmxlbmd0aCB9LAoKICAgIC8vIFJlbW92ZSB0aGUgbiBsaW5lcyBhdCBvZmZzZXQgJ2F0Jy4KICAgIHJlbW92ZUlubmVyOiBmdW5jdGlvbihhdCwgbikgewogICAgICB2YXIgdGhpcyQxID0gdGhpczsKCiAgICAgIGZvciAodmFyIGkgPSBhdCwgZSA9IGF0ICsgbjsgaSA8IGU7ICsraSkgewogICAgICAgIHZhciBsaW5lID0gdGhpcyQxLmxpbmVzW2ldOwogICAgICAgIHRoaXMkMS5oZWlnaHQgLT0gbGluZS5oZWlnaHQ7CiAgICAgICAgY2xlYW5VcExpbmUobGluZSk7CiAgICAgICAgc2lnbmFsTGF0ZXIobGluZSwgImRlbGV0ZSIpOwogICAgICB9CiAgICAgIHRoaXMubGluZXMuc3BsaWNlKGF0LCBuKTsKICAgIH0sCgogICAgLy8gSGVscGVyIHVzZWQgdG8gY29sbGFwc2UgYSBzbWFsbCBicmFuY2ggaW50byBhIHNpbmdsZSBsZWFmLgogICAgY29sbGFwc2U6IGZ1bmN0aW9uKGxpbmVzKSB7CiAgICAgIGxpbmVzLnB1c2guYXBwbHkobGluZXMsIHRoaXMubGluZXMpOwogICAgfSwKCiAgICAvLyBJbnNlcnQgdGhlIGdpdmVuIGFycmF5IG9mIGxpbmVzIGF0IG9mZnNldCAnYXQnLCBjb3VudCB0aGVtIGFzCiAgICAvLyBoYXZpbmcgdGhlIGdpdmVuIGhlaWdodC4KICAgIGluc2VydElubmVyOiBmdW5jdGlvbihhdCwgbGluZXMsIGhlaWdodCkgewogICAgICB2YXIgdGhpcyQxID0gdGhpczsKCiAgICAgIHRoaXMuaGVpZ2h0ICs9IGhlaWdodDsKICAgICAgdGhpcy5saW5lcyA9IHRoaXMubGluZXMuc2xpY2UoMCwgYXQpLmNvbmNhdChsaW5lcykuY29uY2F0KHRoaXMubGluZXMuc2xpY2UoYXQpKTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsaW5lcy5sZW5ndGg7ICsraSkgeyBsaW5lc1tpXS5wYXJlbnQgPSB0aGlzJDE7IH0KICAgIH0sCgogICAgLy8gVXNlZCB0byBpdGVyYXRlIG92ZXIgYSBwYXJ0IG9mIHRoZSB0cmVlLgogICAgaXRlck46IGZ1bmN0aW9uKGF0LCBuLCBvcCkgewogICAgICB2YXIgdGhpcyQxID0gdGhpczsKCiAgICAgIGZvciAodmFyIGUgPSBhdCArIG47IGF0IDwgZTsgKythdCkKICAgICAgICB7IGlmIChvcCh0aGlzJDEubGluZXNbYXRdKSkgeyByZXR1cm4gdHJ1ZSB9IH0KICAgIH0KICB9OwoKICBmdW5jdGlvbiBCcmFuY2hDaHVuayhjaGlsZHJlbikgewogICAgdmFyIHRoaXMkMSA9IHRoaXM7CgogICAgdGhpcy5jaGlsZHJlbiA9IGNoaWxkcmVuOwogICAgdmFyIHNpemUgPSAwLCBoZWlnaHQgPSAwOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjaGlsZHJlbi5sZW5ndGg7ICsraSkgewogICAgICB2YXIgY2ggPSBjaGlsZHJlbltpXTsKICAgICAgc2l6ZSArPSBjaC5jaHVua1NpemUoKTsgaGVpZ2h0ICs9IGNoLmhlaWdodDsKICAgICAgY2gucGFyZW50ID0gdGhpcyQxOwogICAgfQogICAgdGhpcy5zaXplID0gc2l6ZTsKICAgIHRoaXMuaGVpZ2h0ID0gaGVpZ2h0OwogICAgdGhpcy5wYXJlbnQgPSBudWxsOwogIH0KCiAgQnJhbmNoQ2h1bmsucHJvdG90eXBlID0gewogICAgY2h1bmtTaXplOiBmdW5jdGlvbigpIHsgcmV0dXJuIHRoaXMuc2l6ZSB9LAoKICAgIHJlbW92ZUlubmVyOiBmdW5jdGlvbihhdCwgbikgewogICAgICB2YXIgdGhpcyQxID0gdGhpczsKCiAgICAgIHRoaXMuc2l6ZSAtPSBuOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuY2hpbGRyZW4ubGVuZ3RoOyArK2kpIHsKICAgICAgICB2YXIgY2hpbGQgPSB0aGlzJDEuY2hpbGRyZW5baV0sIHN6ID0gY2hpbGQuY2h1bmtTaXplKCk7CiAgICAgICAgaWYgKGF0IDwgc3opIHsKICAgICAgICAgIHZhciBybSA9IE1hdGgubWluKG4sIHN6IC0gYXQpLCBvbGRIZWlnaHQgPSBjaGlsZC5oZWlnaHQ7CiAgICAgICAgICBjaGlsZC5yZW1vdmVJbm5lcihhdCwgcm0pOwogICAgICAgICAgdGhpcyQxLmhlaWdodCAtPSBvbGRIZWlnaHQgLSBjaGlsZC5oZWlnaHQ7CiAgICAgICAgICBpZiAoc3ogPT0gcm0pIHsgdGhpcyQxLmNoaWxkcmVuLnNwbGljZShpLS0sIDEpOyBjaGlsZC5wYXJlbnQgPSBudWxsOyB9CiAgICAgICAgICBpZiAoKG4gLT0gcm0pID09IDApIHsgYnJlYWsgfQogICAgICAgICAgYXQgPSAwOwogICAgICAgIH0gZWxzZSB7IGF0IC09IHN6OyB9CiAgICAgIH0KICAgICAgLy8gSWYgdGhlIHJlc3VsdCBpcyBzbWFsbGVyIHRoYW4gMjUgbGluZXMsIGVuc3VyZSB0aGF0IGl0IGlzIGEKICAgICAgLy8gc2luZ2xlIGxlYWYgbm9kZS4KICAgICAgaWYgKHRoaXMuc2l6ZSAtIG4gPCAyNSAmJgogICAgICAgICAgKHRoaXMuY2hpbGRyZW4ubGVuZ3RoID4gMSB8fCAhKHRoaXMuY2hpbGRyZW5bMF0gaW5zdGFuY2VvZiBMZWFmQ2h1bmspKSkgewogICAgICAgIHZhciBsaW5lcyA9IFtdOwogICAgICAgIHRoaXMuY29sbGFwc2UobGluZXMpOwogICAgICAgIHRoaXMuY2hpbGRyZW4gPSBbbmV3IExlYWZDaHVuayhsaW5lcyldOwogICAgICAgIHRoaXMuY2hpbGRyZW5bMF0ucGFyZW50ID0gdGhpczsKICAgICAgfQogICAgfSwKCiAgICBjb2xsYXBzZTogZnVuY3Rpb24obGluZXMpIHsKICAgICAgdmFyIHRoaXMkMSA9IHRoaXM7CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuY2hpbGRyZW4ubGVuZ3RoOyArK2kpIHsgdGhpcyQxLmNoaWxkcmVuW2ldLmNvbGxhcHNlKGxpbmVzKTsgfQogICAgfSwKCiAgICBpbnNlcnRJbm5lcjogZnVuY3Rpb24oYXQsIGxpbmVzLCBoZWlnaHQpIHsKICAgICAgdmFyIHRoaXMkMSA9IHRoaXM7CgogICAgICB0aGlzLnNpemUgKz0gbGluZXMubGVuZ3RoOwogICAgICB0aGlzLmhlaWdodCArPSBoZWlnaHQ7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5jaGlsZHJlbi5sZW5ndGg7ICsraSkgewogICAgICAgIHZhciBjaGlsZCA9IHRoaXMkMS5jaGlsZHJlbltpXSwgc3ogPSBjaGlsZC5jaHVua1NpemUoKTsKICAgICAgICBpZiAoYXQgPD0gc3opIHsKICAgICAgICAgIGNoaWxkLmluc2VydElubmVyKGF0LCBsaW5lcywgaGVpZ2h0KTsKICAgICAgICAgIGlmIChjaGlsZC5saW5lcyAmJiBjaGlsZC5saW5lcy5sZW5ndGggPiA1MCkgewogICAgICAgICAgICAvLyBUbyBhdm9pZCBtZW1vcnkgdGhyYXNoaW5nIHdoZW4gY2hpbGQubGluZXMgaXMgaHVnZSAoZS5nLiBmaXJzdCB2aWV3IG9mIGEgbGFyZ2UgZmlsZSksIGl0J3MgbmV2ZXIgc3BsaWNlZC4KICAgICAgICAgICAgLy8gSW5zdGVhZCwgc21hbGwgc2xpY2VzIGFyZSB0YWtlbi4gVGhleSdyZSB0YWtlbiBpbiBvcmRlciBiZWNhdXNlIHNlcXVlbnRpYWwgbWVtb3J5IGFjY2Vzc2VzIGFyZSBmYXN0ZXN0LgogICAgICAgICAgICB2YXIgcmVtYWluaW5nID0gY2hpbGQubGluZXMubGVuZ3RoICUgMjUgKyAyNTsKICAgICAgICAgICAgZm9yICh2YXIgcG9zID0gcmVtYWluaW5nOyBwb3MgPCBjaGlsZC5saW5lcy5sZW5ndGg7KSB7CiAgICAgICAgICAgICAgdmFyIGxlYWYgPSBuZXcgTGVhZkNodW5rKGNoaWxkLmxpbmVzLnNsaWNlKHBvcywgcG9zICs9IDI1KSk7CiAgICAgICAgICAgICAgY2hpbGQuaGVpZ2h0IC09IGxlYWYuaGVpZ2h0OwogICAgICAgICAgICAgIHRoaXMkMS5jaGlsZHJlbi5zcGxpY2UoKytpLCAwLCBsZWFmKTsKICAgICAgICAgICAgICBsZWFmLnBhcmVudCA9IHRoaXMkMTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjaGlsZC5saW5lcyA9IGNoaWxkLmxpbmVzLnNsaWNlKDAsIHJlbWFpbmluZyk7CiAgICAgICAgICAgIHRoaXMkMS5tYXliZVNwaWxsKCk7CiAgICAgICAgICB9CiAgICAgICAgICBicmVhawogICAgICAgIH0KICAgICAgICBhdCAtPSBzejsKICAgICAgfQogICAgfSwKCiAgICAvLyBXaGVuIGEgbm9kZSBoYXMgZ3Jvd24sIGNoZWNrIHdoZXRoZXIgaXQgc2hvdWxkIGJlIHNwbGl0LgogICAgbWF5YmVTcGlsbDogZnVuY3Rpb24oKSB7CiAgICAgIGlmICh0aGlzLmNoaWxkcmVuLmxlbmd0aCA8PSAxMCkgeyByZXR1cm4gfQogICAgICB2YXIgbWUgPSB0aGlzOwogICAgICBkbyB7CiAgICAgICAgdmFyIHNwaWxsZWQgPSBtZS5jaGlsZHJlbi5zcGxpY2UobWUuY2hpbGRyZW4ubGVuZ3RoIC0gNSwgNSk7CiAgICAgICAgdmFyIHNpYmxpbmcgPSBuZXcgQnJhbmNoQ2h1bmsoc3BpbGxlZCk7CiAgICAgICAgaWYgKCFtZS5wYXJlbnQpIHsgLy8gQmVjb21lIHRoZSBwYXJlbnQgbm9kZQogICAgICAgICAgdmFyIGNvcHkgPSBuZXcgQnJhbmNoQ2h1bmsobWUuY2hpbGRyZW4pOwogICAgICAgICAgY29weS5wYXJlbnQgPSBtZTsKICAgICAgICAgIG1lLmNoaWxkcmVuID0gW2NvcHksIHNpYmxpbmddOwogICAgICAgICAgbWUgPSBjb3B5OwogICAgICAgfSBlbHNlIHsKICAgICAgICAgIG1lLnNpemUgLT0gc2libGluZy5zaXplOwogICAgICAgICAgbWUuaGVpZ2h0IC09IHNpYmxpbmcuaGVpZ2h0OwogICAgICAgICAgdmFyIG15SW5kZXggPSBpbmRleE9mKG1lLnBhcmVudC5jaGlsZHJlbiwgbWUpOwogICAgICAgICAgbWUucGFyZW50LmNoaWxkcmVuLnNwbGljZShteUluZGV4ICsgMSwgMCwgc2libGluZyk7CiAgICAgICAgfQogICAgICAgIHNpYmxpbmcucGFyZW50ID0gbWUucGFyZW50OwogICAgICB9IHdoaWxlIChtZS5jaGlsZHJlbi5sZW5ndGggPiAxMCkKICAgICAgbWUucGFyZW50Lm1heWJlU3BpbGwoKTsKICAgIH0sCgogICAgaXRlck46IGZ1bmN0aW9uKGF0LCBuLCBvcCkgewogICAgICB2YXIgdGhpcyQxID0gdGhpczsKCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5jaGlsZHJlbi5sZW5ndGg7ICsraSkgewogICAgICAgIHZhciBjaGlsZCA9IHRoaXMkMS5jaGlsZHJlbltpXSwgc3ogPSBjaGlsZC5jaHVua1NpemUoKTsKICAgICAgICBpZiAoYXQgPCBzeikgewogICAgICAgICAgdmFyIHVzZWQgPSBNYXRoLm1pbihuLCBzeiAtIGF0KTsKICAgICAgICAgIGlmIChjaGlsZC5pdGVyTihhdCwgdXNlZCwgb3ApKSB7IHJldHVybiB0cnVlIH0KICAgICAgICAgIGlmICgobiAtPSB1c2VkKSA9PSAwKSB7IGJyZWFrIH0KICAgICAgICAgIGF0ID0gMDsKICAgICAgICB9IGVsc2UgeyBhdCAtPSBzejsgfQogICAgICB9CiAgICB9CiAgfTsKCiAgLy8gTGluZSB3aWRnZXRzIGFyZSBibG9jayBlbGVtZW50cyBkaXNwbGF5ZWQgYWJvdmUgb3IgYmVsb3cgYSBsaW5lLgoKICB2YXIgTGluZVdpZGdldCA9IGZ1bmN0aW9uKGRvYywgbm9kZSwgb3B0aW9ucykgewogICAgdmFyIHRoaXMkMSA9IHRoaXM7CgogICAgaWYgKG9wdGlvbnMpIHsgZm9yICh2YXIgb3B0IGluIG9wdGlvbnMpIHsgaWYgKG9wdGlvbnMuaGFzT3duUHJvcGVydHkob3B0KSkKICAgICAgeyB0aGlzJDFbb3B0XSA9IG9wdGlvbnNbb3B0XTsgfSB9IH0KICAgIHRoaXMuZG9jID0gZG9jOwogICAgdGhpcy5ub2RlID0gbm9kZTsKICB9OwoKICBMaW5lV2lkZ2V0LnByb3RvdHlwZS5jbGVhciA9IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIHRoaXMkMSA9IHRoaXM7CgogICAgdmFyIGNtID0gdGhpcy5kb2MuY20sIHdzID0gdGhpcy5saW5lLndpZGdldHMsIGxpbmUgPSB0aGlzLmxpbmUsIG5vID0gbGluZU5vKGxpbmUpOwogICAgaWYgKG5vID09IG51bGwgfHwgIXdzKSB7IHJldHVybiB9CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHdzLmxlbmd0aDsgKytpKSB7IGlmICh3c1tpXSA9PSB0aGlzJDEpIHsgd3Muc3BsaWNlKGktLSwgMSk7IH0gfQogICAgaWYgKCF3cy5sZW5ndGgpIHsgbGluZS53aWRnZXRzID0gbnVsbDsgfQogICAgdmFyIGhlaWdodCA9IHdpZGdldEhlaWdodCh0aGlzKTsKICAgIHVwZGF0ZUxpbmVIZWlnaHQobGluZSwgTWF0aC5tYXgoMCwgbGluZS5oZWlnaHQgLSBoZWlnaHQpKTsKICAgIGlmIChjbSkgewogICAgICBydW5Jbk9wKGNtLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgYWRqdXN0U2Nyb2xsV2hlbkFib3ZlVmlzaWJsZShjbSwgbGluZSwgLWhlaWdodCk7CiAgICAgICAgcmVnTGluZUNoYW5nZShjbSwgbm8sICJ3aWRnZXQiKTsKICAgICAgfSk7CiAgICAgIHNpZ25hbExhdGVyKGNtLCAibGluZVdpZGdldENsZWFyZWQiLCBjbSwgdGhpcywgbm8pOwogICAgfQogIH07CgogIExpbmVXaWRnZXQucHJvdG90eXBlLmNoYW5nZWQgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciB0aGlzJDEgPSB0aGlzOwoKICAgIHZhciBvbGRIID0gdGhpcy5oZWlnaHQsIGNtID0gdGhpcy5kb2MuY20sIGxpbmUgPSB0aGlzLmxpbmU7CiAgICB0aGlzLmhlaWdodCA9IG51bGw7CiAgICB2YXIgZGlmZiA9IHdpZGdldEhlaWdodCh0aGlzKSAtIG9sZEg7CiAgICBpZiAoIWRpZmYpIHsgcmV0dXJuIH0KICAgIGlmICghbGluZUlzSGlkZGVuKHRoaXMuZG9jLCBsaW5lKSkgeyB1cGRhdGVMaW5lSGVpZ2h0KGxpbmUsIGxpbmUuaGVpZ2h0ICsgZGlmZik7IH0KICAgIGlmIChjbSkgewogICAgICBydW5Jbk9wKGNtLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgY20uY3VyT3AuZm9yY2VVcGRhdGUgPSB0cnVlOwogICAgICAgIGFkanVzdFNjcm9sbFdoZW5BYm92ZVZpc2libGUoY20sIGxpbmUsIGRpZmYpOwogICAgICAgIHNpZ25hbExhdGVyKGNtLCAibGluZVdpZGdldENoYW5nZWQiLCBjbSwgdGhpcyQxLCBsaW5lTm8obGluZSkpOwogICAgICB9KTsKICAgIH0KICB9OwogIGV2ZW50TWl4aW4oTGluZVdpZGdldCk7CgogIGZ1bmN0aW9uIGFkanVzdFNjcm9sbFdoZW5BYm92ZVZpc2libGUoY20sIGxpbmUsIGRpZmYpIHsKICAgIGlmIChoZWlnaHRBdExpbmUobGluZSkgPCAoKGNtLmN1ck9wICYmIGNtLmN1ck9wLnNjcm9sbFRvcCkgfHwgY20uZG9jLnNjcm9sbFRvcCkpCiAgICAgIHsgYWRkVG9TY3JvbGxUb3AoY20sIGRpZmYpOyB9CiAgfQoKICBmdW5jdGlvbiBhZGRMaW5lV2lkZ2V0KGRvYywgaGFuZGxlLCBub2RlLCBvcHRpb25zKSB7CiAgICB2YXIgd2lkZ2V0ID0gbmV3IExpbmVXaWRnZXQoZG9jLCBub2RlLCBvcHRpb25zKTsKICAgIHZhciBjbSA9IGRvYy5jbTsKICAgIGlmIChjbSAmJiB3aWRnZXQubm9IU2Nyb2xsKSB7IGNtLmRpc3BsYXkuYWxpZ25XaWRnZXRzID0gdHJ1ZTsgfQogICAgY2hhbmdlTGluZShkb2MsIGhhbmRsZSwgIndpZGdldCIsIGZ1bmN0aW9uIChsaW5lKSB7CiAgICAgIHZhciB3aWRnZXRzID0gbGluZS53aWRnZXRzIHx8IChsaW5lLndpZGdldHMgPSBbXSk7CiAgICAgIGlmICh3aWRnZXQuaW5zZXJ0QXQgPT0gbnVsbCkgeyB3aWRnZXRzLnB1c2god2lkZ2V0KTsgfQogICAgICBlbHNlIHsgd2lkZ2V0cy5zcGxpY2UoTWF0aC5taW4od2lkZ2V0cy5sZW5ndGggLSAxLCBNYXRoLm1heCgwLCB3aWRnZXQuaW5zZXJ0QXQpKSwgMCwgd2lkZ2V0KTsgfQogICAgICB3aWRnZXQubGluZSA9IGxpbmU7CiAgICAgIGlmIChjbSAmJiAhbGluZUlzSGlkZGVuKGRvYywgbGluZSkpIHsKICAgICAgICB2YXIgYWJvdmVWaXNpYmxlID0gaGVpZ2h0QXRMaW5lKGxpbmUpIDwgZG9jLnNjcm9sbFRvcDsKICAgICAgICB1cGRhdGVMaW5lSGVpZ2h0KGxpbmUsIGxpbmUuaGVpZ2h0ICsgd2lkZ2V0SGVpZ2h0KHdpZGdldCkpOwogICAgICAgIGlmIChhYm92ZVZpc2libGUpIHsgYWRkVG9TY3JvbGxUb3AoY20sIHdpZGdldC5oZWlnaHQpOyB9CiAgICAgICAgY20uY3VyT3AuZm9yY2VVcGRhdGUgPSB0cnVlOwogICAgICB9CiAgICAgIHJldHVybiB0cnVlCiAgICB9KTsKICAgIGlmIChjbSkgeyBzaWduYWxMYXRlcihjbSwgImxpbmVXaWRnZXRBZGRlZCIsIGNtLCB3aWRnZXQsIHR5cGVvZiBoYW5kbGUgPT0gIm51bWJlciIgPyBoYW5kbGUgOiBsaW5lTm8oaGFuZGxlKSk7IH0KICAgIHJldHVybiB3aWRnZXQKICB9CgogIC8vIFRFWFRNQVJLRVJTCgogIC8vIENyZWF0ZWQgd2l0aCBtYXJrVGV4dCBhbmQgc2V0Qm9va21hcmsgbWV0aG9kcy4gQSBUZXh0TWFya2VyIGlzIGEKICAvLyBoYW5kbGUgdGhhdCBjYW4gYmUgdXNlZCB0byBjbGVhciBvciBmaW5kIGEgbWFya2VkIHBvc2l0aW9uIGluIHRoZQogIC8vIGRvY3VtZW50LiBMaW5lIG9iamVjdHMgaG9sZCBhcnJheXMgKG1hcmtlZFNwYW5zKSBjb250YWluaW5nCiAgLy8ge2Zyb20sIHRvLCBtYXJrZXJ9IG9iamVjdCBwb2ludGluZyB0byBzdWNoIG1hcmtlciBvYmplY3RzLCBhbmQKICAvLyBpbmRpY2F0aW5nIHRoYXQgc3VjaCBhIG1hcmtlciBpcyBwcmVzZW50IG9uIHRoYXQgbGluZS4gTXVsdGlwbGUKICAvLyBsaW5lcyBtYXkgcG9pbnQgdG8gdGhlIHNhbWUgbWFya2VyIHdoZW4gaXQgc3BhbnMgYWNyb3NzIGxpbmVzLgogIC8vIFRoZSBzcGFucyB3aWxsIGhhdmUgbnVsbCBmb3IgdGhlaXIgZnJvbS90byBwcm9wZXJ0aWVzIHdoZW4gdGhlCiAgLy8gbWFya2VyIGNvbnRpbnVlcyBiZXlvbmQgdGhlIHN0YXJ0L2VuZCBvZiB0aGUgbGluZS4gTWFya2VycyBoYXZlCiAgLy8gbGlua3MgYmFjayB0byB0aGUgbGluZXMgdGhleSBjdXJyZW50bHkgdG91Y2guCgogIC8vIENvbGxhcHNlZCBtYXJrZXJzIGhhdmUgdW5pcXVlIGlkcywgaW4gb3JkZXIgdG8gYmUgYWJsZSB0byBvcmRlcgogIC8vIHRoZW0sIHdoaWNoIGlzIG5lZWRlZCBmb3IgdW5pcXVlbHkgZGV0ZXJtaW5pbmcgYW4gb3V0ZXIgbWFya2VyCiAgLy8gd2hlbiB0aGV5IG92ZXJsYXAgKHRoZXkgbWF5IG5lc3QsIGJ1dCBub3QgcGFydGlhbGx5IG92ZXJsYXApLgogIHZhciBuZXh0TWFya2VySWQgPSAwOwoKICB2YXIgVGV4dE1hcmtlciA9IGZ1bmN0aW9uKGRvYywgdHlwZSkgewogICAgdGhpcy5saW5lcyA9IFtdOwogICAgdGhpcy50eXBlID0gdHlwZTsKICAgIHRoaXMuZG9jID0gZG9jOwogICAgdGhpcy5pZCA9ICsrbmV4dE1hcmtlcklkOwogIH07CgogIC8vIENsZWFyIHRoZSBtYXJrZXIuCiAgVGV4dE1hcmtlci5wcm90b3R5cGUuY2xlYXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciB0aGlzJDEgPSB0aGlzOwoKICAgIGlmICh0aGlzLmV4cGxpY2l0bHlDbGVhcmVkKSB7IHJldHVybiB9CiAgICB2YXIgY20gPSB0aGlzLmRvYy5jbSwgd2l0aE9wID0gY20gJiYgIWNtLmN1ck9wOwogICAgaWYgKHdpdGhPcCkgeyBzdGFydE9wZXJhdGlvbihjbSk7IH0KICAgIGlmIChoYXNIYW5kbGVyKHRoaXMsICJjbGVhciIpKSB7CiAgICAgIHZhciBmb3VuZCA9IHRoaXMuZmluZCgpOwogICAgICBpZiAoZm91bmQpIHsgc2lnbmFsTGF0ZXIodGhpcywgImNsZWFyIiwgZm91bmQuZnJvbSwgZm91bmQudG8pOyB9CiAgICB9CiAgICB2YXIgbWluID0gbnVsbCwgbWF4ID0gbnVsbDsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5saW5lcy5sZW5ndGg7ICsraSkgewogICAgICB2YXIgbGluZSA9IHRoaXMkMS5saW5lc1tpXTsKICAgICAgdmFyIHNwYW4gPSBnZXRNYXJrZWRTcGFuRm9yKGxpbmUubWFya2VkU3BhbnMsIHRoaXMkMSk7CiAgICAgIGlmIChjbSAmJiAhdGhpcyQxLmNvbGxhcHNlZCkgeyByZWdMaW5lQ2hhbmdlKGNtLCBsaW5lTm8obGluZSksICJ0ZXh0Iik7IH0KICAgICAgZWxzZSBpZiAoY20pIHsKICAgICAgICBpZiAoc3Bhbi50byAhPSBudWxsKSB7IG1heCA9IGxpbmVObyhsaW5lKTsgfQogICAgICAgIGlmIChzcGFuLmZyb20gIT0gbnVsbCkgeyBtaW4gPSBsaW5lTm8obGluZSk7IH0KICAgICAgfQogICAgICBsaW5lLm1hcmtlZFNwYW5zID0gcmVtb3ZlTWFya2VkU3BhbihsaW5lLm1hcmtlZFNwYW5zLCBzcGFuKTsKICAgICAgaWYgKHNwYW4uZnJvbSA9PSBudWxsICYmIHRoaXMkMS5jb2xsYXBzZWQgJiYgIWxpbmVJc0hpZGRlbih0aGlzJDEuZG9jLCBsaW5lKSAmJiBjbSkKICAgICAgICB7IHVwZGF0ZUxpbmVIZWlnaHQobGluZSwgdGV4dEhlaWdodChjbS5kaXNwbGF5KSk7IH0KICAgIH0KICAgIGlmIChjbSAmJiB0aGlzLmNvbGxhcHNlZCAmJiAhY20ub3B0aW9ucy5saW5lV3JhcHBpbmcpIHsgZm9yICh2YXIgaSQxID0gMDsgaSQxIDwgdGhpcy5saW5lcy5sZW5ndGg7ICsraSQxKSB7CiAgICAgIHZhciB2aXN1YWwgPSB2aXN1YWxMaW5lKHRoaXMkMS5saW5lc1tpJDFdKSwgbGVuID0gbGluZUxlbmd0aCh2aXN1YWwpOwogICAgICBpZiAobGVuID4gY20uZGlzcGxheS5tYXhMaW5lTGVuZ3RoKSB7CiAgICAgICAgY20uZGlzcGxheS5tYXhMaW5lID0gdmlzdWFsOwogICAgICAgIGNtLmRpc3BsYXkubWF4TGluZUxlbmd0aCA9IGxlbjsKICAgICAgICBjbS5kaXNwbGF5Lm1heExpbmVDaGFuZ2VkID0gdHJ1ZTsKICAgICAgfQogICAgfSB9CgogICAgaWYgKG1pbiAhPSBudWxsICYmIGNtICYmIHRoaXMuY29sbGFwc2VkKSB7IHJlZ0NoYW5nZShjbSwgbWluLCBtYXggKyAxKTsgfQogICAgdGhpcy5saW5lcy5sZW5ndGggPSAwOwogICAgdGhpcy5leHBsaWNpdGx5Q2xlYXJlZCA9IHRydWU7CiAgICBpZiAodGhpcy5hdG9taWMgJiYgdGhpcy5kb2MuY2FudEVkaXQpIHsKICAgICAgdGhpcy5kb2MuY2FudEVkaXQgPSBmYWxzZTsKICAgICAgaWYgKGNtKSB7IHJlQ2hlY2tTZWxlY3Rpb24oY20uZG9jKTsgfQogICAgfQogICAgaWYgKGNtKSB7IHNpZ25hbExhdGVyKGNtLCAibWFya2VyQ2xlYXJlZCIsIGNtLCB0aGlzLCBtaW4sIG1heCk7IH0KICAgIGlmICh3aXRoT3ApIHsgZW5kT3BlcmF0aW9uKGNtKTsgfQogICAgaWYgKHRoaXMucGFyZW50KSB7IHRoaXMucGFyZW50LmNsZWFyKCk7IH0KICB9OwoKICAvLyBGaW5kIHRoZSBwb3NpdGlvbiBvZiB0aGUgbWFya2VyIGluIHRoZSBkb2N1bWVudC4gUmV0dXJucyBhIHtmcm9tLAogIC8vIHRvfSBvYmplY3QgYnkgZGVmYXVsdC4gU2lkZSBjYW4gYmUgcGFzc2VkIHRvIGdldCBhIHNwZWNpZmljIHNpZGUKICAvLyAtLSAwIChib3RoKSwgLTEgKGxlZnQpLCBvciAxIChyaWdodCkuIFdoZW4gbGluZU9iaiBpcyB0cnVlLCB0aGUKICAvLyBQb3Mgb2JqZWN0cyByZXR1cm5lZCBjb250YWluIGEgbGluZSBvYmplY3QsIHJhdGhlciB0aGFuIGEgbGluZQogIC8vIG51bWJlciAodXNlZCB0byBwcmV2ZW50IGxvb2tpbmcgdXAgdGhlIHNhbWUgbGluZSB0d2ljZSkuCiAgVGV4dE1hcmtlci5wcm90b3R5cGUuZmluZCA9IGZ1bmN0aW9uIChzaWRlLCBsaW5lT2JqKSB7CiAgICAgIHZhciB0aGlzJDEgPSB0aGlzOwoKICAgIGlmIChzaWRlID09IG51bGwgJiYgdGhpcy50eXBlID09ICJib29rbWFyayIpIHsgc2lkZSA9IDE7IH0KICAgIHZhciBmcm9tLCB0bzsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5saW5lcy5sZW5ndGg7ICsraSkgewogICAgICB2YXIgbGluZSA9IHRoaXMkMS5saW5lc1tpXTsKICAgICAgdmFyIHNwYW4gPSBnZXRNYXJrZWRTcGFuRm9yKGxpbmUubWFya2VkU3BhbnMsIHRoaXMkMSk7CiAgICAgIGlmIChzcGFuLmZyb20gIT0gbnVsbCkgewogICAgICAgIGZyb20gPSBQb3MobGluZU9iaiA/IGxpbmUgOiBsaW5lTm8obGluZSksIHNwYW4uZnJvbSk7CiAgICAgICAgaWYgKHNpZGUgPT0gLTEpIHsgcmV0dXJuIGZyb20gfQogICAgICB9CiAgICAgIGlmIChzcGFuLnRvICE9IG51bGwpIHsKICAgICAgICB0byA9IFBvcyhsaW5lT2JqID8gbGluZSA6IGxpbmVObyhsaW5lKSwgc3Bhbi50byk7CiAgICAgICAgaWYgKHNpZGUgPT0gMSkgeyByZXR1cm4gdG8gfQogICAgICB9CiAgICB9CiAgICByZXR1cm4gZnJvbSAmJiB7ZnJvbTogZnJvbSwgdG86IHRvfQogIH07CgogIC8vIFNpZ25hbHMgdGhhdCB0aGUgbWFya2VyJ3Mgd2lkZ2V0IGNoYW5nZWQsIGFuZCBzdXJyb3VuZGluZyBsYXlvdXQKICAvLyBzaG91bGQgYmUgcmVjb21wdXRlZC4KICBUZXh0TWFya2VyLnByb3RvdHlwZS5jaGFuZ2VkID0gZnVuY3Rpb24gKCkgewogICAgICB2YXIgdGhpcyQxID0gdGhpczsKCiAgICB2YXIgcG9zID0gdGhpcy5maW5kKC0xLCB0cnVlKSwgd2lkZ2V0ID0gdGhpcywgY20gPSB0aGlzLmRvYy5jbTsKICAgIGlmICghcG9zIHx8ICFjbSkgeyByZXR1cm4gfQogICAgcnVuSW5PcChjbSwgZnVuY3Rpb24gKCkgewogICAgICB2YXIgbGluZSA9IHBvcy5saW5lLCBsaW5lTiA9IGxpbmVObyhwb3MubGluZSk7CiAgICAgIHZhciB2aWV3ID0gZmluZFZpZXdGb3JMaW5lKGNtLCBsaW5lTik7CiAgICAgIGlmICh2aWV3KSB7CiAgICAgICAgY2xlYXJMaW5lTWVhc3VyZW1lbnRDYWNoZUZvcih2aWV3KTsKICAgICAgICBjbS5jdXJPcC5zZWxlY3Rpb25DaGFuZ2VkID0gY20uY3VyT3AuZm9yY2VVcGRhdGUgPSB0cnVlOwogICAgICB9CiAgICAgIGNtLmN1ck9wLnVwZGF0ZU1heExpbmUgPSB0cnVlOwogICAgICBpZiAoIWxpbmVJc0hpZGRlbih3aWRnZXQuZG9jLCBsaW5lKSAmJiB3aWRnZXQuaGVpZ2h0ICE9IG51bGwpIHsKICAgICAgICB2YXIgb2xkSGVpZ2h0ID0gd2lkZ2V0LmhlaWdodDsKICAgICAgICB3aWRnZXQuaGVpZ2h0ID0gbnVsbDsKICAgICAgICB2YXIgZEhlaWdodCA9IHdpZGdldEhlaWdodCh3aWRnZXQpIC0gb2xkSGVpZ2h0OwogICAgICAgIGlmIChkSGVpZ2h0KQogICAgICAgICAgeyB1cGRhdGVMaW5lSGVpZ2h0KGxpbmUsIGxpbmUuaGVpZ2h0ICsgZEhlaWdodCk7IH0KICAgICAgfQogICAgICBzaWduYWxMYXRlcihjbSwgIm1hcmtlckNoYW5nZWQiLCBjbSwgdGhpcyQxKTsKICAgIH0pOwogIH07CgogIFRleHRNYXJrZXIucHJvdG90eXBlLmF0dGFjaExpbmUgPSBmdW5jdGlvbiAobGluZSkgewogICAgaWYgKCF0aGlzLmxpbmVzLmxlbmd0aCAmJiB0aGlzLmRvYy5jbSkgewogICAgICB2YXIgb3AgPSB0aGlzLmRvYy5jbS5jdXJPcDsKICAgICAgaWYgKCFvcC5tYXliZUhpZGRlbk1hcmtlcnMgfHwgaW5kZXhPZihvcC5tYXliZUhpZGRlbk1hcmtlcnMsIHRoaXMpID09IC0xKQogICAgICAgIHsgKG9wLm1heWJlVW5oaWRkZW5NYXJrZXJzIHx8IChvcC5tYXliZVVuaGlkZGVuTWFya2VycyA9IFtdKSkucHVzaCh0aGlzKTsgfQogICAgfQogICAgdGhpcy5saW5lcy5wdXNoKGxpbmUpOwogIH07CgogIFRleHRNYXJrZXIucHJvdG90eXBlLmRldGFjaExpbmUgPSBmdW5jdGlvbiAobGluZSkgewogICAgdGhpcy5saW5lcy5zcGxpY2UoaW5kZXhPZih0aGlzLmxpbmVzLCBsaW5lKSwgMSk7CiAgICBpZiAoIXRoaXMubGluZXMubGVuZ3RoICYmIHRoaXMuZG9jLmNtKSB7CiAgICAgIHZhciBvcCA9IHRoaXMuZG9jLmNtLmN1ck9wCiAgICAgIDsob3AubWF5YmVIaWRkZW5NYXJrZXJzIHx8IChvcC5tYXliZUhpZGRlbk1hcmtlcnMgPSBbXSkpLnB1c2godGhpcyk7CiAgICB9CiAgfTsKICBldmVudE1peGluKFRleHRNYXJrZXIpOwoKICAvLyBDcmVhdGUgYSBtYXJrZXIsIHdpcmUgaXQgdXAgdG8gdGhlIHJpZ2h0IGxpbmVzLCBhbmQKICBmdW5jdGlvbiBtYXJrVGV4dChkb2MsIGZyb20sIHRvLCBvcHRpb25zLCB0eXBlKSB7CiAgICAvLyBTaGFyZWQgbWFya2VycyAoYWNyb3NzIGxpbmtlZCBkb2N1bWVudHMpIGFyZSBoYW5kbGVkIHNlcGFyYXRlbHkKICAgIC8vIChtYXJrVGV4dFNoYXJlZCB3aWxsIGNhbGwgb3V0IHRvIHRoaXMgYWdhaW4sIG9uY2UgcGVyCiAgICAvLyBkb2N1bWVudCkuCiAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLnNoYXJlZCkgeyByZXR1cm4gbWFya1RleHRTaGFyZWQoZG9jLCBmcm9tLCB0bywgb3B0aW9ucywgdHlwZSkgfQogICAgLy8gRW5zdXJlIHdlIGFyZSBpbiBhbiBvcGVyYXRpb24uCiAgICBpZiAoZG9jLmNtICYmICFkb2MuY20uY3VyT3ApIHsgcmV0dXJuIG9wZXJhdGlvbihkb2MuY20sIG1hcmtUZXh0KShkb2MsIGZyb20sIHRvLCBvcHRpb25zLCB0eXBlKSB9CgogICAgdmFyIG1hcmtlciA9IG5ldyBUZXh0TWFya2VyKGRvYywgdHlwZSksIGRpZmYgPSBjbXAoZnJvbSwgdG8pOwogICAgaWYgKG9wdGlvbnMpIHsgY29weU9iaihvcHRpb25zLCBtYXJrZXIsIGZhbHNlKTsgfQogICAgLy8gRG9uJ3QgY29ubmVjdCBlbXB0eSBtYXJrZXJzIHVubGVzcyBjbGVhcldoZW5FbXB0eSBpcyBmYWxzZQogICAgaWYgKGRpZmYgPiAwIHx8IGRpZmYgPT0gMCAmJiBtYXJrZXIuY2xlYXJXaGVuRW1wdHkgIT09IGZhbHNlKQogICAgICB7IHJldHVybiBtYXJrZXIgfQogICAgaWYgKG1hcmtlci5yZXBsYWNlZFdpdGgpIHsKICAgICAgLy8gU2hvd2luZyB1cCBhcyBhIHdpZGdldCBpbXBsaWVzIGNvbGxhcHNlZCAod2lkZ2V0IHJlcGxhY2VzIHRleHQpCiAgICAgIG1hcmtlci5jb2xsYXBzZWQgPSB0cnVlOwogICAgICBtYXJrZXIud2lkZ2V0Tm9kZSA9IGVsdFAoInNwYW4iLCBbbWFya2VyLnJlcGxhY2VkV2l0aF0sICJDb2RlTWlycm9yLXdpZGdldCIpOwogICAgICBpZiAoIW9wdGlvbnMuaGFuZGxlTW91c2VFdmVudHMpIHsgbWFya2VyLndpZGdldE5vZGUuc2V0QXR0cmlidXRlKCJjbS1pZ25vcmUtZXZlbnRzIiwgInRydWUiKTsgfQogICAgICBpZiAob3B0aW9ucy5pbnNlcnRMZWZ0KSB7IG1hcmtlci53aWRnZXROb2RlLmluc2VydExlZnQgPSB0cnVlOyB9CiAgICB9CiAgICBpZiAobWFya2VyLmNvbGxhcHNlZCkgewogICAgICBpZiAoY29uZmxpY3RpbmdDb2xsYXBzZWRSYW5nZShkb2MsIGZyb20ubGluZSwgZnJvbSwgdG8sIG1hcmtlcikgfHwKICAgICAgICAgIGZyb20ubGluZSAhPSB0by5saW5lICYmIGNvbmZsaWN0aW5nQ29sbGFwc2VkUmFuZ2UoZG9jLCB0by5saW5lLCBmcm9tLCB0bywgbWFya2VyKSkKICAgICAgICB7IHRocm93IG5ldyBFcnJvcigiSW5zZXJ0aW5nIGNvbGxhcHNlZCBtYXJrZXIgcGFydGlhbGx5IG92ZXJsYXBwaW5nIGFuIGV4aXN0aW5nIG9uZSIpIH0KICAgICAgc2VlQ29sbGFwc2VkU3BhbnMoKTsKICAgIH0KCiAgICBpZiAobWFya2VyLmFkZFRvSGlzdG9yeSkKICAgICAgeyBhZGRDaGFuZ2VUb0hpc3RvcnkoZG9jLCB7ZnJvbTogZnJvbSwgdG86IHRvLCBvcmlnaW46ICJtYXJrVGV4dCJ9LCBkb2Muc2VsLCBOYU4pOyB9CgogICAgdmFyIGN1ckxpbmUgPSBmcm9tLmxpbmUsIGNtID0gZG9jLmNtLCB1cGRhdGVNYXhMaW5lOwogICAgZG9jLml0ZXIoY3VyTGluZSwgdG8ubGluZSArIDEsIGZ1bmN0aW9uIChsaW5lKSB7CiAgICAgIGlmIChjbSAmJiBtYXJrZXIuY29sbGFwc2VkICYmICFjbS5vcHRpb25zLmxpbmVXcmFwcGluZyAmJiB2aXN1YWxMaW5lKGxpbmUpID09IGNtLmRpc3BsYXkubWF4TGluZSkKICAgICAgICB7IHVwZGF0ZU1heExpbmUgPSB0cnVlOyB9CiAgICAgIGlmIChtYXJrZXIuY29sbGFwc2VkICYmIGN1ckxpbmUgIT0gZnJvbS5saW5lKSB7IHVwZGF0ZUxpbmVIZWlnaHQobGluZSwgMCk7IH0KICAgICAgYWRkTWFya2VkU3BhbihsaW5lLCBuZXcgTWFya2VkU3BhbihtYXJrZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VyTGluZSA9PSBmcm9tLmxpbmUgPyBmcm9tLmNoIDogbnVsbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJMaW5lID09IHRvLmxpbmUgPyB0by5jaCA6IG51bGwpKTsKICAgICAgKytjdXJMaW5lOwogICAgfSk7CiAgICAvLyBsaW5lSXNIaWRkZW4gZGVwZW5kcyBvbiB0aGUgcHJlc2VuY2Ugb2YgdGhlIHNwYW5zLCBzbyBuZWVkcyBhIHNlY29uZCBwYXNzCiAgICBpZiAobWFya2VyLmNvbGxhcHNlZCkgeyBkb2MuaXRlcihmcm9tLmxpbmUsIHRvLmxpbmUgKyAxLCBmdW5jdGlvbiAobGluZSkgewogICAgICBpZiAobGluZUlzSGlkZGVuKGRvYywgbGluZSkpIHsgdXBkYXRlTGluZUhlaWdodChsaW5lLCAwKTsgfQogICAgfSk7IH0KCiAgICBpZiAobWFya2VyLmNsZWFyT25FbnRlcikgeyBvbihtYXJrZXIsICJiZWZvcmVDdXJzb3JFbnRlciIsIGZ1bmN0aW9uICgpIHsgcmV0dXJuIG1hcmtlci5jbGVhcigpOyB9KTsgfQoKICAgIGlmIChtYXJrZXIucmVhZE9ubHkpIHsKICAgICAgc2VlUmVhZE9ubHlTcGFucygpOwogICAgICBpZiAoZG9jLmhpc3RvcnkuZG9uZS5sZW5ndGggfHwgZG9jLmhpc3RvcnkudW5kb25lLmxlbmd0aCkKICAgICAgICB7IGRvYy5jbGVhckhpc3RvcnkoKTsgfQogICAgfQogICAgaWYgKG1hcmtlci5jb2xsYXBzZWQpIHsKICAgICAgbWFya2VyLmlkID0gKytuZXh0TWFya2VySWQ7CiAgICAgIG1hcmtlci5hdG9taWMgPSB0cnVlOwogICAgfQogICAgaWYgKGNtKSB7CiAgICAgIC8vIFN5bmMgZWRpdG9yIHN0YXRlCiAgICAgIGlmICh1cGRhdGVNYXhMaW5lKSB7IGNtLmN1ck9wLnVwZGF0ZU1heExpbmUgPSB0cnVlOyB9CiAgICAgIGlmIChtYXJrZXIuY29sbGFwc2VkKQogICAgICAgIHsgcmVnQ2hhbmdlKGNtLCBmcm9tLmxpbmUsIHRvLmxpbmUgKyAxKTsgfQogICAgICBlbHNlIGlmIChtYXJrZXIuY2xhc3NOYW1lIHx8IG1hcmtlci5zdGFydFN0eWxlIHx8IG1hcmtlci5lbmRTdHlsZSB8fCBtYXJrZXIuY3NzIHx8CiAgICAgICAgICAgICAgIG1hcmtlci5hdHRyaWJ1dGVzIHx8IG1hcmtlci50aXRsZSkKICAgICAgICB7IGZvciAodmFyIGkgPSBmcm9tLmxpbmU7IGkgPD0gdG8ubGluZTsgaSsrKSB7IHJlZ0xpbmVDaGFuZ2UoY20sIGksICJ0ZXh0Iik7IH0gfQogICAgICBpZiAobWFya2VyLmF0b21pYykgeyByZUNoZWNrU2VsZWN0aW9uKGNtLmRvYyk7IH0KICAgICAgc2lnbmFsTGF0ZXIoY20sICJtYXJrZXJBZGRlZCIsIGNtLCBtYXJrZXIpOwogICAgfQogICAgcmV0dXJuIG1hcmtlcgogIH0KCiAgLy8gU0hBUkVEIFRFWFRNQVJLRVJTCgogIC8vIEEgc2hhcmVkIG1hcmtlciBzcGFucyBtdWx0aXBsZSBsaW5rZWQgZG9jdW1lbnRzLiBJdCBpcwogIC8vIGltcGxlbWVudGVkIGFzIGEgbWV0YS1tYXJrZXItb2JqZWN0IGNvbnRyb2xsaW5nIG11bHRpcGxlIG5vcm1hbAogIC8vIG1hcmtlcnMuCiAgdmFyIFNoYXJlZFRleHRNYXJrZXIgPSBmdW5jdGlvbihtYXJrZXJzLCBwcmltYXJ5KSB7CiAgICB2YXIgdGhpcyQxID0gdGhpczsKCiAgICB0aGlzLm1hcmtlcnMgPSBtYXJrZXJzOwogICAgdGhpcy5wcmltYXJ5ID0gcHJpbWFyeTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbWFya2Vycy5sZW5ndGg7ICsraSkKICAgICAgeyBtYXJrZXJzW2ldLnBhcmVudCA9IHRoaXMkMTsgfQogIH07CgogIFNoYXJlZFRleHRNYXJrZXIucHJvdG90eXBlLmNsZWFyID0gZnVuY3Rpb24gKCkgewogICAgICB2YXIgdGhpcyQxID0gdGhpczsKCiAgICBpZiAodGhpcy5leHBsaWNpdGx5Q2xlYXJlZCkgeyByZXR1cm4gfQogICAgdGhpcy5leHBsaWNpdGx5Q2xlYXJlZCA9IHRydWU7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMubWFya2Vycy5sZW5ndGg7ICsraSkKICAgICAgeyB0aGlzJDEubWFya2Vyc1tpXS5jbGVhcigpOyB9CiAgICBzaWduYWxMYXRlcih0aGlzLCAiY2xlYXIiKTsKICB9OwoKICBTaGFyZWRUZXh0TWFya2VyLnByb3RvdHlwZS5maW5kID0gZnVuY3Rpb24gKHNpZGUsIGxpbmVPYmopIHsKICAgIHJldHVybiB0aGlzLnByaW1hcnkuZmluZChzaWRlLCBsaW5lT2JqKQogIH07CiAgZXZlbnRNaXhpbihTaGFyZWRUZXh0TWFya2VyKTsKCiAgZnVuY3Rpb24gbWFya1RleHRTaGFyZWQoZG9jLCBmcm9tLCB0bywgb3B0aW9ucywgdHlwZSkgewogICAgb3B0aW9ucyA9IGNvcHlPYmoob3B0aW9ucyk7CiAgICBvcHRpb25zLnNoYXJlZCA9IGZhbHNlOwogICAgdmFyIG1hcmtlcnMgPSBbbWFya1RleHQoZG9jLCBmcm9tLCB0bywgb3B0aW9ucywgdHlwZSldLCBwcmltYXJ5ID0gbWFya2Vyc1swXTsKICAgIHZhciB3aWRnZXQgPSBvcHRpb25zLndpZGdldE5vZGU7CiAgICBsaW5rZWREb2NzKGRvYywgZnVuY3Rpb24gKGRvYykgewogICAgICBpZiAod2lkZ2V0KSB7IG9wdGlvbnMud2lkZ2V0Tm9kZSA9IHdpZGdldC5jbG9uZU5vZGUodHJ1ZSk7IH0KICAgICAgbWFya2Vycy5wdXNoKG1hcmtUZXh0KGRvYywgY2xpcFBvcyhkb2MsIGZyb20pLCBjbGlwUG9zKGRvYywgdG8pLCBvcHRpb25zLCB0eXBlKSk7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZG9jLmxpbmtlZC5sZW5ndGg7ICsraSkKICAgICAgICB7IGlmIChkb2MubGlua2VkW2ldLmlzUGFyZW50KSB7IHJldHVybiB9IH0KICAgICAgcHJpbWFyeSA9IGxzdChtYXJrZXJzKTsKICAgIH0pOwogICAgcmV0dXJuIG5ldyBTaGFyZWRUZXh0TWFya2VyKG1hcmtlcnMsIHByaW1hcnkpCiAgfQoKICBmdW5jdGlvbiBmaW5kU2hhcmVkTWFya2Vycyhkb2MpIHsKICAgIHJldHVybiBkb2MuZmluZE1hcmtzKFBvcyhkb2MuZmlyc3QsIDApLCBkb2MuY2xpcFBvcyhQb3MoZG9jLmxhc3RMaW5lKCkpKSwgZnVuY3Rpb24gKG0pIHsgcmV0dXJuIG0ucGFyZW50OyB9KQogIH0KCiAgZnVuY3Rpb24gY29weVNoYXJlZE1hcmtlcnMoZG9jLCBtYXJrZXJzKSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IG1hcmtlcnMubGVuZ3RoOyBpKyspIHsKICAgICAgdmFyIG1hcmtlciA9IG1hcmtlcnNbaV0sIHBvcyA9IG1hcmtlci5maW5kKCk7CiAgICAgIHZhciBtRnJvbSA9IGRvYy5jbGlwUG9zKHBvcy5mcm9tKSwgbVRvID0gZG9jLmNsaXBQb3MocG9zLnRvKTsKICAgICAgaWYgKGNtcChtRnJvbSwgbVRvKSkgewogICAgICAgIHZhciBzdWJNYXJrID0gbWFya1RleHQoZG9jLCBtRnJvbSwgbVRvLCBtYXJrZXIucHJpbWFyeSwgbWFya2VyLnByaW1hcnkudHlwZSk7CiAgICAgICAgbWFya2VyLm1hcmtlcnMucHVzaChzdWJNYXJrKTsKICAgICAgICBzdWJNYXJrLnBhcmVudCA9IG1hcmtlcjsKICAgICAgfQogICAgfQogIH0KCiAgZnVuY3Rpb24gZGV0YWNoU2hhcmVkTWFya2VycyhtYXJrZXJzKSB7CiAgICB2YXIgbG9vcCA9IGZ1bmN0aW9uICggaSApIHsKICAgICAgdmFyIG1hcmtlciA9IG1hcmtlcnNbaV0sIGxpbmtlZCA9IFttYXJrZXIucHJpbWFyeS5kb2NdOwogICAgICBsaW5rZWREb2NzKG1hcmtlci5wcmltYXJ5LmRvYywgZnVuY3Rpb24gKGQpIHsgcmV0dXJuIGxpbmtlZC5wdXNoKGQpOyB9KTsKICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBtYXJrZXIubWFya2Vycy5sZW5ndGg7IGorKykgewogICAgICAgIHZhciBzdWJNYXJrZXIgPSBtYXJrZXIubWFya2Vyc1tqXTsKICAgICAgICBpZiAoaW5kZXhPZihsaW5rZWQsIHN1Yk1hcmtlci5kb2MpID09IC0xKSB7CiAgICAgICAgICBzdWJNYXJrZXIucGFyZW50ID0gbnVsbDsKICAgICAgICAgIG1hcmtlci5tYXJrZXJzLnNwbGljZShqLS0sIDEpOwogICAgICAgIH0KICAgICAgfQogICAgfTsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IG1hcmtlcnMubGVuZ3RoOyBpKyspIGxvb3AoIGkgKTsKICB9CgogIHZhciBuZXh0RG9jSWQgPSAwOwogIHZhciBEb2MgPSBmdW5jdGlvbih0ZXh0LCBtb2RlLCBmaXJzdExpbmUsIGxpbmVTZXAsIGRpcmVjdGlvbikgewogICAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIERvYykpIHsgcmV0dXJuIG5ldyBEb2ModGV4dCwgbW9kZSwgZmlyc3RMaW5lLCBsaW5lU2VwLCBkaXJlY3Rpb24pIH0KICAgIGlmIChmaXJzdExpbmUgPT0gbnVsbCkgeyBmaXJzdExpbmUgPSAwOyB9CgogICAgQnJhbmNoQ2h1bmsuY2FsbCh0aGlzLCBbbmV3IExlYWZDaHVuayhbbmV3IExpbmUoIiIsIG51bGwpXSldKTsKICAgIHRoaXMuZmlyc3QgPSBmaXJzdExpbmU7CiAgICB0aGlzLnNjcm9sbFRvcCA9IHRoaXMuc2Nyb2xsTGVmdCA9IDA7CiAgICB0aGlzLmNhbnRFZGl0ID0gZmFsc2U7CiAgICB0aGlzLmNsZWFuR2VuZXJhdGlvbiA9IDE7CiAgICB0aGlzLm1vZGVGcm9udGllciA9IHRoaXMuaGlnaGxpZ2h0RnJvbnRpZXIgPSBmaXJzdExpbmU7CiAgICB2YXIgc3RhcnQgPSBQb3MoZmlyc3RMaW5lLCAwKTsKICAgIHRoaXMuc2VsID0gc2ltcGxlU2VsZWN0aW9uKHN0YXJ0KTsKICAgIHRoaXMuaGlzdG9yeSA9IG5ldyBIaXN0b3J5KG51bGwpOwogICAgdGhpcy5pZCA9ICsrbmV4dERvY0lkOwogICAgdGhpcy5tb2RlT3B0aW9uID0gbW9kZTsKICAgIHRoaXMubGluZVNlcCA9IGxpbmVTZXA7CiAgICB0aGlzLmRpcmVjdGlvbiA9IChkaXJlY3Rpb24gPT0gInJ0bCIpID8gInJ0bCIgOiAibHRyIjsKICAgIHRoaXMuZXh0ZW5kID0gZmFsc2U7CgogICAgaWYgKHR5cGVvZiB0ZXh0ID09ICJzdHJpbmciKSB7IHRleHQgPSB0aGlzLnNwbGl0TGluZXModGV4dCk7IH0KICAgIHVwZGF0ZURvYyh0aGlzLCB7ZnJvbTogc3RhcnQsIHRvOiBzdGFydCwgdGV4dDogdGV4dH0pOwogICAgc2V0U2VsZWN0aW9uKHRoaXMsIHNpbXBsZVNlbGVjdGlvbihzdGFydCksIHNlbF9kb250U2Nyb2xsKTsKICB9OwoKICBEb2MucHJvdG90eXBlID0gY3JlYXRlT2JqKEJyYW5jaENodW5rLnByb3RvdHlwZSwgewogICAgY29uc3RydWN0b3I6IERvYywKICAgIC8vIEl0ZXJhdGUgb3ZlciB0aGUgZG9jdW1lbnQuIFN1cHBvcnRzIHR3byBmb3JtcyAtLSB3aXRoIG9ubHkgb25lCiAgICAvLyBhcmd1bWVudCwgaXQgY2FsbHMgdGhhdCBmb3IgZWFjaCBsaW5lIGluIHRoZSBkb2N1bWVudC4gV2l0aAogICAgLy8gdGhyZWUsIGl0IGl0ZXJhdGVzIG92ZXIgdGhlIHJhbmdlIGdpdmVuIGJ5IHRoZSBmaXJzdCB0d28gKHdpdGgKICAgIC8vIHRoZSBzZWNvbmQgYmVpbmcgbm9uLWluY2x1c2l2ZSkuCiAgICBpdGVyOiBmdW5jdGlvbihmcm9tLCB0bywgb3ApIHsKICAgICAgaWYgKG9wKSB7IHRoaXMuaXRlck4oZnJvbSAtIHRoaXMuZmlyc3QsIHRvIC0gZnJvbSwgb3ApOyB9CiAgICAgIGVsc2UgeyB0aGlzLml0ZXJOKHRoaXMuZmlyc3QsIHRoaXMuZmlyc3QgKyB0aGlzLnNpemUsIGZyb20pOyB9CiAgICB9LAoKICAgIC8vIE5vbi1wdWJsaWMgaW50ZXJmYWNlIGZvciBhZGRpbmcgYW5kIHJlbW92aW5nIGxpbmVzLgogICAgaW5zZXJ0OiBmdW5jdGlvbihhdCwgbGluZXMpIHsKICAgICAgdmFyIGhlaWdodCA9IDA7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGluZXMubGVuZ3RoOyArK2kpIHsgaGVpZ2h0ICs9IGxpbmVzW2ldLmhlaWdodDsgfQogICAgICB0aGlzLmluc2VydElubmVyKGF0IC0gdGhpcy5maXJzdCwgbGluZXMsIGhlaWdodCk7CiAgICB9LAogICAgcmVtb3ZlOiBmdW5jdGlvbihhdCwgbikgeyB0aGlzLnJlbW92ZUlubmVyKGF0IC0gdGhpcy5maXJzdCwgbik7IH0sCgogICAgLy8gRnJvbSBoZXJlLCB0aGUgbWV0aG9kcyBhcmUgcGFydCBvZiB0aGUgcHVibGljIGludGVyZmFjZS4gTW9zdAogICAgLy8gYXJlIGFsc28gYXZhaWxhYmxlIGZyb20gQ29kZU1pcnJvciAoZWRpdG9yKSBpbnN0YW5jZXMuCgogICAgZ2V0VmFsdWU6IGZ1bmN0aW9uKGxpbmVTZXApIHsKICAgICAgdmFyIGxpbmVzID0gZ2V0TGluZXModGhpcywgdGhpcy5maXJzdCwgdGhpcy5maXJzdCArIHRoaXMuc2l6ZSk7CiAgICAgIGlmIChsaW5lU2VwID09PSBmYWxzZSkgeyByZXR1cm4gbGluZXMgfQogICAgICByZXR1cm4gbGluZXMuam9pbihsaW5lU2VwIHx8IHRoaXMubGluZVNlcGFyYXRvcigpKQogICAgfSwKICAgIHNldFZhbHVlOiBkb2NNZXRob2RPcChmdW5jdGlvbihjb2RlKSB7CiAgICAgIHZhciB0b3AgPSBQb3ModGhpcy5maXJzdCwgMCksIGxhc3QgPSB0aGlzLmZpcnN0ICsgdGhpcy5zaXplIC0gMTsKICAgICAgbWFrZUNoYW5nZSh0aGlzLCB7ZnJvbTogdG9wLCB0bzogUG9zKGxhc3QsIGdldExpbmUodGhpcywgbGFzdCkudGV4dC5sZW5ndGgpLAogICAgICAgICAgICAgICAgICAgICAgICB0ZXh0OiB0aGlzLnNwbGl0TGluZXMoY29kZSksIG9yaWdpbjogInNldFZhbHVlIiwgZnVsbDogdHJ1ZX0sIHRydWUpOwogICAgICBpZiAodGhpcy5jbSkgeyBzY3JvbGxUb0Nvb3Jkcyh0aGlzLmNtLCAwLCAwKTsgfQogICAgICBzZXRTZWxlY3Rpb24odGhpcywgc2ltcGxlU2VsZWN0aW9uKHRvcCksIHNlbF9kb250U2Nyb2xsKTsKICAgIH0pLAogICAgcmVwbGFjZVJhbmdlOiBmdW5jdGlvbihjb2RlLCBmcm9tLCB0bywgb3JpZ2luKSB7CiAgICAgIGZyb20gPSBjbGlwUG9zKHRoaXMsIGZyb20pOwogICAgICB0byA9IHRvID8gY2xpcFBvcyh0aGlzLCB0bykgOiBmcm9tOwogICAgICByZXBsYWNlUmFuZ2UodGhpcywgY29kZSwgZnJvbSwgdG8sIG9yaWdpbik7CiAgICB9LAogICAgZ2V0UmFuZ2U6IGZ1bmN0aW9uKGZyb20sIHRvLCBsaW5lU2VwKSB7CiAgICAgIHZhciBsaW5lcyA9IGdldEJldHdlZW4odGhpcywgY2xpcFBvcyh0aGlzLCBmcm9tKSwgY2xpcFBvcyh0aGlzLCB0bykpOwogICAgICBpZiAobGluZVNlcCA9PT0gZmFsc2UpIHsgcmV0dXJuIGxpbmVzIH0KICAgICAgcmV0dXJuIGxpbmVzLmpvaW4obGluZVNlcCB8fCB0aGlzLmxpbmVTZXBhcmF0b3IoKSkKICAgIH0sCgogICAgZ2V0TGluZTogZnVuY3Rpb24obGluZSkge3ZhciBsID0gdGhpcy5nZXRMaW5lSGFuZGxlKGxpbmUpOyByZXR1cm4gbCAmJiBsLnRleHR9LAoKICAgIGdldExpbmVIYW5kbGU6IGZ1bmN0aW9uKGxpbmUpIHtpZiAoaXNMaW5lKHRoaXMsIGxpbmUpKSB7IHJldHVybiBnZXRMaW5lKHRoaXMsIGxpbmUpIH19LAogICAgZ2V0TGluZU51bWJlcjogZnVuY3Rpb24obGluZSkge3JldHVybiBsaW5lTm8obGluZSl9LAoKICAgIGdldExpbmVIYW5kbGVWaXN1YWxTdGFydDogZnVuY3Rpb24obGluZSkgewogICAgICBpZiAodHlwZW9mIGxpbmUgPT0gIm51bWJlciIpIHsgbGluZSA9IGdldExpbmUodGhpcywgbGluZSk7IH0KICAgICAgcmV0dXJuIHZpc3VhbExpbmUobGluZSkKICAgIH0sCgogICAgbGluZUNvdW50OiBmdW5jdGlvbigpIHtyZXR1cm4gdGhpcy5zaXplfSwKICAgIGZpcnN0TGluZTogZnVuY3Rpb24oKSB7cmV0dXJuIHRoaXMuZmlyc3R9LAogICAgbGFzdExpbmU6IGZ1bmN0aW9uKCkge3JldHVybiB0aGlzLmZpcnN0ICsgdGhpcy5zaXplIC0gMX0sCgogICAgY2xpcFBvczogZnVuY3Rpb24ocG9zKSB7cmV0dXJuIGNsaXBQb3ModGhpcywgcG9zKX0sCgogICAgZ2V0Q3Vyc29yOiBmdW5jdGlvbihzdGFydCkgewogICAgICB2YXIgcmFuZ2UkJDEgPSB0aGlzLnNlbC5wcmltYXJ5KCksIHBvczsKICAgICAgaWYgKHN0YXJ0ID09IG51bGwgfHwgc3RhcnQgPT0gImhlYWQiKSB7IHBvcyA9IHJhbmdlJCQxLmhlYWQ7IH0KICAgICAgZWxzZSBpZiAoc3RhcnQgPT0gImFuY2hvciIpIHsgcG9zID0gcmFuZ2UkJDEuYW5jaG9yOyB9CiAgICAgIGVsc2UgaWYgKHN0YXJ0ID09ICJlbmQiIHx8IHN0YXJ0ID09ICJ0byIgfHwgc3RhcnQgPT09IGZhbHNlKSB7IHBvcyA9IHJhbmdlJCQxLnRvKCk7IH0KICAgICAgZWxzZSB7IHBvcyA9IHJhbmdlJCQxLmZyb20oKTsgfQogICAgICByZXR1cm4gcG9zCiAgICB9LAogICAgbGlzdFNlbGVjdGlvbnM6IGZ1bmN0aW9uKCkgeyByZXR1cm4gdGhpcy5zZWwucmFuZ2VzIH0sCiAgICBzb21ldGhpbmdTZWxlY3RlZDogZnVuY3Rpb24oKSB7cmV0dXJuIHRoaXMuc2VsLnNvbWV0aGluZ1NlbGVjdGVkKCl9LAoKICAgIHNldEN1cnNvcjogZG9jTWV0aG9kT3AoZnVuY3Rpb24obGluZSwgY2gsIG9wdGlvbnMpIHsKICAgICAgc2V0U2ltcGxlU2VsZWN0aW9uKHRoaXMsIGNsaXBQb3ModGhpcywgdHlwZW9mIGxpbmUgPT0gIm51bWJlciIgPyBQb3MobGluZSwgY2ggfHwgMCkgOiBsaW5lKSwgbnVsbCwgb3B0aW9ucyk7CiAgICB9KSwKICAgIHNldFNlbGVjdGlvbjogZG9jTWV0aG9kT3AoZnVuY3Rpb24oYW5jaG9yLCBoZWFkLCBvcHRpb25zKSB7CiAgICAgIHNldFNpbXBsZVNlbGVjdGlvbih0aGlzLCBjbGlwUG9zKHRoaXMsIGFuY2hvciksIGNsaXBQb3ModGhpcywgaGVhZCB8fCBhbmNob3IpLCBvcHRpb25zKTsKICAgIH0pLAogICAgZXh0ZW5kU2VsZWN0aW9uOiBkb2NNZXRob2RPcChmdW5jdGlvbihoZWFkLCBvdGhlciwgb3B0aW9ucykgewogICAgICBleHRlbmRTZWxlY3Rpb24odGhpcywgY2xpcFBvcyh0aGlzLCBoZWFkKSwgb3RoZXIgJiYgY2xpcFBvcyh0aGlzLCBvdGhlciksIG9wdGlvbnMpOwogICAgfSksCiAgICBleHRlbmRTZWxlY3Rpb25zOiBkb2NNZXRob2RPcChmdW5jdGlvbihoZWFkcywgb3B0aW9ucykgewogICAgICBleHRlbmRTZWxlY3Rpb25zKHRoaXMsIGNsaXBQb3NBcnJheSh0aGlzLCBoZWFkcyksIG9wdGlvbnMpOwogICAgfSksCiAgICBleHRlbmRTZWxlY3Rpb25zQnk6IGRvY01ldGhvZE9wKGZ1bmN0aW9uKGYsIG9wdGlvbnMpIHsKICAgICAgdmFyIGhlYWRzID0gbWFwKHRoaXMuc2VsLnJhbmdlcywgZik7CiAgICAgIGV4dGVuZFNlbGVjdGlvbnModGhpcywgY2xpcFBvc0FycmF5KHRoaXMsIGhlYWRzKSwgb3B0aW9ucyk7CiAgICB9KSwKICAgIHNldFNlbGVjdGlvbnM6IGRvY01ldGhvZE9wKGZ1bmN0aW9uKHJhbmdlcywgcHJpbWFyeSwgb3B0aW9ucykgewogICAgICB2YXIgdGhpcyQxID0gdGhpczsKCiAgICAgIGlmICghcmFuZ2VzLmxlbmd0aCkgeyByZXR1cm4gfQogICAgICB2YXIgb3V0ID0gW107CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmFuZ2VzLmxlbmd0aDsgaSsrKQogICAgICAgIHsgb3V0W2ldID0gbmV3IFJhbmdlKGNsaXBQb3ModGhpcyQxLCByYW5nZXNbaV0uYW5jaG9yKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xpcFBvcyh0aGlzJDEsIHJhbmdlc1tpXS5oZWFkKSk7IH0KICAgICAgaWYgKHByaW1hcnkgPT0gbnVsbCkgeyBwcmltYXJ5ID0gTWF0aC5taW4ocmFuZ2VzLmxlbmd0aCAtIDEsIHRoaXMuc2VsLnByaW1JbmRleCk7IH0KICAgICAgc2V0U2VsZWN0aW9uKHRoaXMsIG5vcm1hbGl6ZVNlbGVjdGlvbih0aGlzLmNtLCBvdXQsIHByaW1hcnkpLCBvcHRpb25zKTsKICAgIH0pLAogICAgYWRkU2VsZWN0aW9uOiBkb2NNZXRob2RPcChmdW5jdGlvbihhbmNob3IsIGhlYWQsIG9wdGlvbnMpIHsKICAgICAgdmFyIHJhbmdlcyA9IHRoaXMuc2VsLnJhbmdlcy5zbGljZSgwKTsKICAgICAgcmFuZ2VzLnB1c2gobmV3IFJhbmdlKGNsaXBQb3ModGhpcywgYW5jaG9yKSwgY2xpcFBvcyh0aGlzLCBoZWFkIHx8IGFuY2hvcikpKTsKICAgICAgc2V0U2VsZWN0aW9uKHRoaXMsIG5vcm1hbGl6ZVNlbGVjdGlvbih0aGlzLmNtLCByYW5nZXMsIHJhbmdlcy5sZW5ndGggLSAxKSwgb3B0aW9ucyk7CiAgICB9KSwKCiAgICBnZXRTZWxlY3Rpb246IGZ1bmN0aW9uKGxpbmVTZXApIHsKICAgICAgdmFyIHRoaXMkMSA9IHRoaXM7CgogICAgICB2YXIgcmFuZ2VzID0gdGhpcy5zZWwucmFuZ2VzLCBsaW5lczsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByYW5nZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIgc2VsID0gZ2V0QmV0d2Vlbih0aGlzJDEsIHJhbmdlc1tpXS5mcm9tKCksIHJhbmdlc1tpXS50bygpKTsKICAgICAgICBsaW5lcyA9IGxpbmVzID8gbGluZXMuY29uY2F0KHNlbCkgOiBzZWw7CiAgICAgIH0KICAgICAgaWYgKGxpbmVTZXAgPT09IGZhbHNlKSB7IHJldHVybiBsaW5lcyB9CiAgICAgIGVsc2UgeyByZXR1cm4gbGluZXMuam9pbihsaW5lU2VwIHx8IHRoaXMubGluZVNlcGFyYXRvcigpKSB9CiAgICB9LAogICAgZ2V0U2VsZWN0aW9uczogZnVuY3Rpb24obGluZVNlcCkgewogICAgICB2YXIgdGhpcyQxID0gdGhpczsKCiAgICAgIHZhciBwYXJ0cyA9IFtdLCByYW5nZXMgPSB0aGlzLnNlbC5yYW5nZXM7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmFuZ2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIHNlbCA9IGdldEJldHdlZW4odGhpcyQxLCByYW5nZXNbaV0uZnJvbSgpLCByYW5nZXNbaV0udG8oKSk7CiAgICAgICAgaWYgKGxpbmVTZXAgIT09IGZhbHNlKSB7IHNlbCA9IHNlbC5qb2luKGxpbmVTZXAgfHwgdGhpcyQxLmxpbmVTZXBhcmF0b3IoKSk7IH0KICAgICAgICBwYXJ0c1tpXSA9IHNlbDsKICAgICAgfQogICAgICByZXR1cm4gcGFydHMKICAgIH0sCiAgICByZXBsYWNlU2VsZWN0aW9uOiBmdW5jdGlvbihjb2RlLCBjb2xsYXBzZSwgb3JpZ2luKSB7CiAgICAgIHZhciBkdXAgPSBbXTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLnNlbC5yYW5nZXMubGVuZ3RoOyBpKyspCiAgICAgICAgeyBkdXBbaV0gPSBjb2RlOyB9CiAgICAgIHRoaXMucmVwbGFjZVNlbGVjdGlvbnMoZHVwLCBjb2xsYXBzZSwgb3JpZ2luIHx8ICIraW5wdXQiKTsKICAgIH0sCiAgICByZXBsYWNlU2VsZWN0aW9uczogZG9jTWV0aG9kT3AoZnVuY3Rpb24oY29kZSwgY29sbGFwc2UsIG9yaWdpbikgewogICAgICB2YXIgdGhpcyQxID0gdGhpczsKCiAgICAgIHZhciBjaGFuZ2VzID0gW10sIHNlbCA9IHRoaXMuc2VsOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNlbC5yYW5nZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIgcmFuZ2UkJDEgPSBzZWwucmFuZ2VzW2ldOwogICAgICAgIGNoYW5nZXNbaV0gPSB7ZnJvbTogcmFuZ2UkJDEuZnJvbSgpLCB0bzogcmFuZ2UkJDEudG8oKSwgdGV4dDogdGhpcyQxLnNwbGl0TGluZXMoY29kZVtpXSksIG9yaWdpbjogb3JpZ2lufTsKICAgICAgfQogICAgICB2YXIgbmV3U2VsID0gY29sbGFwc2UgJiYgY29sbGFwc2UgIT0gImVuZCIgJiYgY29tcHV0ZVJlcGxhY2VkU2VsKHRoaXMsIGNoYW5nZXMsIGNvbGxhcHNlKTsKICAgICAgZm9yICh2YXIgaSQxID0gY2hhbmdlcy5sZW5ndGggLSAxOyBpJDEgPj0gMDsgaSQxLS0pCiAgICAgICAgeyBtYWtlQ2hhbmdlKHRoaXMkMSwgY2hhbmdlc1tpJDFdKTsgfQogICAgICBpZiAobmV3U2VsKSB7IHNldFNlbGVjdGlvblJlcGxhY2VIaXN0b3J5KHRoaXMsIG5ld1NlbCk7IH0KICAgICAgZWxzZSBpZiAodGhpcy5jbSkgeyBlbnN1cmVDdXJzb3JWaXNpYmxlKHRoaXMuY20pOyB9CiAgICB9KSwKICAgIHVuZG86IGRvY01ldGhvZE9wKGZ1bmN0aW9uKCkge21ha2VDaGFuZ2VGcm9tSGlzdG9yeSh0aGlzLCAidW5kbyIpO30pLAogICAgcmVkbzogZG9jTWV0aG9kT3AoZnVuY3Rpb24oKSB7bWFrZUNoYW5nZUZyb21IaXN0b3J5KHRoaXMsICJyZWRvIik7fSksCiAgICB1bmRvU2VsZWN0aW9uOiBkb2NNZXRob2RPcChmdW5jdGlvbigpIHttYWtlQ2hhbmdlRnJvbUhpc3RvcnkodGhpcywgInVuZG8iLCB0cnVlKTt9KSwKICAgIHJlZG9TZWxlY3Rpb246IGRvY01ldGhvZE9wKGZ1bmN0aW9uKCkge21ha2VDaGFuZ2VGcm9tSGlzdG9yeSh0aGlzLCAicmVkbyIsIHRydWUpO30pLAoKICAgIHNldEV4dGVuZGluZzogZnVuY3Rpb24odmFsKSB7dGhpcy5leHRlbmQgPSB2YWw7fSwKICAgIGdldEV4dGVuZGluZzogZnVuY3Rpb24oKSB7cmV0dXJuIHRoaXMuZXh0ZW5kfSwKCiAgICBoaXN0b3J5U2l6ZTogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBoaXN0ID0gdGhpcy5oaXN0b3J5LCBkb25lID0gMCwgdW5kb25lID0gMDsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBoaXN0LmRvbmUubGVuZ3RoOyBpKyspIHsgaWYgKCFoaXN0LmRvbmVbaV0ucmFuZ2VzKSB7ICsrZG9uZTsgfSB9CiAgICAgIGZvciAodmFyIGkkMSA9IDA7IGkkMSA8IGhpc3QudW5kb25lLmxlbmd0aDsgaSQxKyspIHsgaWYgKCFoaXN0LnVuZG9uZVtpJDFdLnJhbmdlcykgeyArK3VuZG9uZTsgfSB9CiAgICAgIHJldHVybiB7dW5kbzogZG9uZSwgcmVkbzogdW5kb25lfQogICAgfSwKICAgIGNsZWFySGlzdG9yeTogZnVuY3Rpb24oKSB7dGhpcy5oaXN0b3J5ID0gbmV3IEhpc3RvcnkodGhpcy5oaXN0b3J5Lm1heEdlbmVyYXRpb24pO30sCgogICAgbWFya0NsZWFuOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5jbGVhbkdlbmVyYXRpb24gPSB0aGlzLmNoYW5nZUdlbmVyYXRpb24odHJ1ZSk7CiAgICB9LAogICAgY2hhbmdlR2VuZXJhdGlvbjogZnVuY3Rpb24oZm9yY2VTcGxpdCkgewogICAgICBpZiAoZm9yY2VTcGxpdCkKICAgICAgICB7IHRoaXMuaGlzdG9yeS5sYXN0T3AgPSB0aGlzLmhpc3RvcnkubGFzdFNlbE9wID0gdGhpcy5oaXN0b3J5Lmxhc3RPcmlnaW4gPSBudWxsOyB9CiAgICAgIHJldHVybiB0aGlzLmhpc3RvcnkuZ2VuZXJhdGlvbgogICAgfSwKICAgIGlzQ2xlYW46IGZ1bmN0aW9uIChnZW4pIHsKICAgICAgcmV0dXJuIHRoaXMuaGlzdG9yeS5nZW5lcmF0aW9uID09IChnZW4gfHwgdGhpcy5jbGVhbkdlbmVyYXRpb24pCiAgICB9LAoKICAgIGdldEhpc3Rvcnk6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4ge2RvbmU6IGNvcHlIaXN0b3J5QXJyYXkodGhpcy5oaXN0b3J5LmRvbmUpLAogICAgICAgICAgICAgIHVuZG9uZTogY29weUhpc3RvcnlBcnJheSh0aGlzLmhpc3RvcnkudW5kb25lKX0KICAgIH0sCiAgICBzZXRIaXN0b3J5OiBmdW5jdGlvbihoaXN0RGF0YSkgewogICAgICB2YXIgaGlzdCA9IHRoaXMuaGlzdG9yeSA9IG5ldyBIaXN0b3J5KHRoaXMuaGlzdG9yeS5tYXhHZW5lcmF0aW9uKTsKICAgICAgaGlzdC5kb25lID0gY29weUhpc3RvcnlBcnJheShoaXN0RGF0YS5kb25lLnNsaWNlKDApLCBudWxsLCB0cnVlKTsKICAgICAgaGlzdC51bmRvbmUgPSBjb3B5SGlzdG9yeUFycmF5KGhpc3REYXRhLnVuZG9uZS5zbGljZSgwKSwgbnVsbCwgdHJ1ZSk7CiAgICB9LAoKICAgIHNldEd1dHRlck1hcmtlcjogZG9jTWV0aG9kT3AoZnVuY3Rpb24obGluZSwgZ3V0dGVySUQsIHZhbHVlKSB7CiAgICAgIHJldHVybiBjaGFuZ2VMaW5lKHRoaXMsIGxpbmUsICJndXR0ZXIiLCBmdW5jdGlvbiAobGluZSkgewogICAgICAgIHZhciBtYXJrZXJzID0gbGluZS5ndXR0ZXJNYXJrZXJzIHx8IChsaW5lLmd1dHRlck1hcmtlcnMgPSB7fSk7CiAgICAgICAgbWFya2Vyc1tndXR0ZXJJRF0gPSB2YWx1ZTsKICAgICAgICBpZiAoIXZhbHVlICYmIGlzRW1wdHkobWFya2VycykpIHsgbGluZS5ndXR0ZXJNYXJrZXJzID0gbnVsbDsgfQogICAgICAgIHJldHVybiB0cnVlCiAgICAgIH0pCiAgICB9KSwKCiAgICBjbGVhckd1dHRlcjogZG9jTWV0aG9kT3AoZnVuY3Rpb24oZ3V0dGVySUQpIHsKICAgICAgdmFyIHRoaXMkMSA9IHRoaXM7CgogICAgICB0aGlzLml0ZXIoZnVuY3Rpb24gKGxpbmUpIHsKICAgICAgICBpZiAobGluZS5ndXR0ZXJNYXJrZXJzICYmIGxpbmUuZ3V0dGVyTWFya2Vyc1tndXR0ZXJJRF0pIHsKICAgICAgICAgIGNoYW5nZUxpbmUodGhpcyQxLCBsaW5lLCAiZ3V0dGVyIiwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICBsaW5lLmd1dHRlck1hcmtlcnNbZ3V0dGVySURdID0gbnVsbDsKICAgICAgICAgICAgaWYgKGlzRW1wdHkobGluZS5ndXR0ZXJNYXJrZXJzKSkgeyBsaW5lLmd1dHRlck1hcmtlcnMgPSBudWxsOyB9CiAgICAgICAgICAgIHJldHVybiB0cnVlCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSksCgogICAgbGluZUluZm86IGZ1bmN0aW9uKGxpbmUpIHsKICAgICAgdmFyIG47CiAgICAgIGlmICh0eXBlb2YgbGluZSA9PSAibnVtYmVyIikgewogICAgICAgIGlmICghaXNMaW5lKHRoaXMsIGxpbmUpKSB7IHJldHVybiBudWxsIH0KICAgICAgICBuID0gbGluZTsKICAgICAgICBsaW5lID0gZ2V0TGluZSh0aGlzLCBsaW5lKTsKICAgICAgICBpZiAoIWxpbmUpIHsgcmV0dXJuIG51bGwgfQogICAgICB9IGVsc2UgewogICAgICAgIG4gPSBsaW5lTm8obGluZSk7CiAgICAgICAgaWYgKG4gPT0gbnVsbCkgeyByZXR1cm4gbnVsbCB9CiAgICAgIH0KICAgICAgcmV0dXJuIHtsaW5lOiBuLCBoYW5kbGU6IGxpbmUsIHRleHQ6IGxpbmUudGV4dCwgZ3V0dGVyTWFya2VyczogbGluZS5ndXR0ZXJNYXJrZXJzLAogICAgICAgICAgICAgIHRleHRDbGFzczogbGluZS50ZXh0Q2xhc3MsIGJnQ2xhc3M6IGxpbmUuYmdDbGFzcywgd3JhcENsYXNzOiBsaW5lLndyYXBDbGFzcywKICAgICAgICAgICAgICB3aWRnZXRzOiBsaW5lLndpZGdldHN9CiAgICB9LAoKICAgIGFkZExpbmVDbGFzczogZG9jTWV0aG9kT3AoZnVuY3Rpb24oaGFuZGxlLCB3aGVyZSwgY2xzKSB7CiAgICAgIHJldHVybiBjaGFuZ2VMaW5lKHRoaXMsIGhhbmRsZSwgd2hlcmUgPT0gImd1dHRlciIgPyAiZ3V0dGVyIiA6ICJjbGFzcyIsIGZ1bmN0aW9uIChsaW5lKSB7CiAgICAgICAgdmFyIHByb3AgPSB3aGVyZSA9PSAidGV4dCIgPyAidGV4dENsYXNzIgogICAgICAgICAgICAgICAgIDogd2hlcmUgPT0gImJhY2tncm91bmQiID8gImJnQ2xhc3MiCiAgICAgICAgICAgICAgICAgOiB3aGVyZSA9PSAiZ3V0dGVyIiA/ICJndXR0ZXJDbGFzcyIgOiAid3JhcENsYXNzIjsKICAgICAgICBpZiAoIWxpbmVbcHJvcF0pIHsgbGluZVtwcm9wXSA9IGNsczsgfQogICAgICAgIGVsc2UgaWYgKGNsYXNzVGVzdChjbHMpLnRlc3QobGluZVtwcm9wXSkpIHsgcmV0dXJuIGZhbHNlIH0KICAgICAgICBlbHNlIHsgbGluZVtwcm9wXSArPSAiICIgKyBjbHM7IH0KICAgICAgICByZXR1cm4gdHJ1ZQogICAgICB9KQogICAgfSksCiAgICByZW1vdmVMaW5lQ2xhc3M6IGRvY01ldGhvZE9wKGZ1bmN0aW9uKGhhbmRsZSwgd2hlcmUsIGNscykgewogICAgICByZXR1cm4gY2hhbmdlTGluZSh0aGlzLCBoYW5kbGUsIHdoZXJlID09ICJndXR0ZXIiID8gImd1dHRlciIgOiAiY2xhc3MiLCBmdW5jdGlvbiAobGluZSkgewogICAgICAgIHZhciBwcm9wID0gd2hlcmUgPT0gInRleHQiID8gInRleHRDbGFzcyIKICAgICAgICAgICAgICAgICA6IHdoZXJlID09ICJiYWNrZ3JvdW5kIiA/ICJiZ0NsYXNzIgogICAgICAgICAgICAgICAgIDogd2hlcmUgPT0gImd1dHRlciIgPyAiZ3V0dGVyQ2xhc3MiIDogIndyYXBDbGFzcyI7CiAgICAgICAgdmFyIGN1ciA9IGxpbmVbcHJvcF07CiAgICAgICAgaWYgKCFjdXIpIHsgcmV0dXJuIGZhbHNlIH0KICAgICAgICBlbHNlIGlmIChjbHMgPT0gbnVsbCkgeyBsaW5lW3Byb3BdID0gbnVsbDsgfQogICAgICAgIGVsc2UgewogICAgICAgICAgdmFyIGZvdW5kID0gY3VyLm1hdGNoKGNsYXNzVGVzdChjbHMpKTsKICAgICAgICAgIGlmICghZm91bmQpIHsgcmV0dXJuIGZhbHNlIH0KICAgICAgICAgIHZhciBlbmQgPSBmb3VuZC5pbmRleCArIGZvdW5kWzBdLmxlbmd0aDsKICAgICAgICAgIGxpbmVbcHJvcF0gPSBjdXIuc2xpY2UoMCwgZm91bmQuaW5kZXgpICsgKCFmb3VuZC5pbmRleCB8fCBlbmQgPT0gY3VyLmxlbmd0aCA/ICIiIDogIiAiKSArIGN1ci5zbGljZShlbmQpIHx8IG51bGw7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0cnVlCiAgICAgIH0pCiAgICB9KSwKCiAgICBhZGRMaW5lV2lkZ2V0OiBkb2NNZXRob2RPcChmdW5jdGlvbihoYW5kbGUsIG5vZGUsIG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIGFkZExpbmVXaWRnZXQodGhpcywgaGFuZGxlLCBub2RlLCBvcHRpb25zKQogICAgfSksCiAgICByZW1vdmVMaW5lV2lkZ2V0OiBmdW5jdGlvbih3aWRnZXQpIHsgd2lkZ2V0LmNsZWFyKCk7IH0sCgogICAgbWFya1RleHQ6IGZ1bmN0aW9uKGZyb20sIHRvLCBvcHRpb25zKSB7CiAgICAgIHJldHVybiBtYXJrVGV4dCh0aGlzLCBjbGlwUG9zKHRoaXMsIGZyb20pLCBjbGlwUG9zKHRoaXMsIHRvKSwgb3B0aW9ucywgb3B0aW9ucyAmJiBvcHRpb25zLnR5cGUgfHwgInJhbmdlIikKICAgIH0sCiAgICBzZXRCb29rbWFyazogZnVuY3Rpb24ocG9zLCBvcHRpb25zKSB7CiAgICAgIHZhciByZWFsT3B0cyA9IHtyZXBsYWNlZFdpdGg6IG9wdGlvbnMgJiYgKG9wdGlvbnMubm9kZVR5cGUgPT0gbnVsbCA/IG9wdGlvbnMud2lkZ2V0IDogb3B0aW9ucyksCiAgICAgICAgICAgICAgICAgICAgICBpbnNlcnRMZWZ0OiBvcHRpb25zICYmIG9wdGlvbnMuaW5zZXJ0TGVmdCwKICAgICAgICAgICAgICAgICAgICAgIGNsZWFyV2hlbkVtcHR5OiBmYWxzZSwgc2hhcmVkOiBvcHRpb25zICYmIG9wdGlvbnMuc2hhcmVkLAogICAgICAgICAgICAgICAgICAgICAgaGFuZGxlTW91c2VFdmVudHM6IG9wdGlvbnMgJiYgb3B0aW9ucy5oYW5kbGVNb3VzZUV2ZW50c307CiAgICAgIHBvcyA9IGNsaXBQb3ModGhpcywgcG9zKTsKICAgICAgcmV0dXJuIG1hcmtUZXh0KHRoaXMsIHBvcywgcG9zLCByZWFsT3B0cywgImJvb2ttYXJrIikKICAgIH0sCiAgICBmaW5kTWFya3NBdDogZnVuY3Rpb24ocG9zKSB7CiAgICAgIHBvcyA9IGNsaXBQb3ModGhpcywgcG9zKTsKICAgICAgdmFyIG1hcmtlcnMgPSBbXSwgc3BhbnMgPSBnZXRMaW5lKHRoaXMsIHBvcy5saW5lKS5tYXJrZWRTcGFuczsKICAgICAgaWYgKHNwYW5zKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgc3BhbnMubGVuZ3RoOyArK2kpIHsKICAgICAgICB2YXIgc3BhbiA9IHNwYW5zW2ldOwogICAgICAgIGlmICgoc3Bhbi5mcm9tID09IG51bGwgfHwgc3Bhbi5mcm9tIDw9IHBvcy5jaCkgJiYKICAgICAgICAgICAgKHNwYW4udG8gPT0gbnVsbCB8fCBzcGFuLnRvID49IHBvcy5jaCkpCiAgICAgICAgICB7IG1hcmtlcnMucHVzaChzcGFuLm1hcmtlci5wYXJlbnQgfHwgc3Bhbi5tYXJrZXIpOyB9CiAgICAgIH0gfQogICAgICByZXR1cm4gbWFya2VycwogICAgfSwKICAgIGZpbmRNYXJrczogZnVuY3Rpb24oZnJvbSwgdG8sIGZpbHRlcikgewogICAgICBmcm9tID0gY2xpcFBvcyh0aGlzLCBmcm9tKTsgdG8gPSBjbGlwUG9zKHRoaXMsIHRvKTsKICAgICAgdmFyIGZvdW5kID0gW10sIGxpbmVObyQkMSA9IGZyb20ubGluZTsKICAgICAgdGhpcy5pdGVyKGZyb20ubGluZSwgdG8ubGluZSArIDEsIGZ1bmN0aW9uIChsaW5lKSB7CiAgICAgICAgdmFyIHNwYW5zID0gbGluZS5tYXJrZWRTcGFuczsKICAgICAgICBpZiAoc3BhbnMpIHsgZm9yICh2YXIgaSA9IDA7IGkgPCBzcGFucy5sZW5ndGg7IGkrKykgewogICAgICAgICAgdmFyIHNwYW4gPSBzcGFuc1tpXTsKICAgICAgICAgIGlmICghKHNwYW4udG8gIT0gbnVsbCAmJiBsaW5lTm8kJDEgPT0gZnJvbS5saW5lICYmIGZyb20uY2ggPj0gc3Bhbi50byB8fAogICAgICAgICAgICAgICAgc3Bhbi5mcm9tID09IG51bGwgJiYgbGluZU5vJCQxICE9IGZyb20ubGluZSB8fAogICAgICAgICAgICAgICAgc3Bhbi5mcm9tICE9IG51bGwgJiYgbGluZU5vJCQxID09IHRvLmxpbmUgJiYgc3Bhbi5mcm9tID49IHRvLmNoKSAmJgogICAgICAgICAgICAgICghZmlsdGVyIHx8IGZpbHRlcihzcGFuLm1hcmtlcikpKQogICAgICAgICAgICB7IGZvdW5kLnB1c2goc3Bhbi5tYXJrZXIucGFyZW50IHx8IHNwYW4ubWFya2VyKTsgfQogICAgICAgIH0gfQogICAgICAgICsrbGluZU5vJCQxOwogICAgICB9KTsKICAgICAgcmV0dXJuIGZvdW5kCiAgICB9LAogICAgZ2V0QWxsTWFya3M6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgbWFya2VycyA9IFtdOwogICAgICB0aGlzLml0ZXIoZnVuY3Rpb24gKGxpbmUpIHsKICAgICAgICB2YXIgc3BzID0gbGluZS5tYXJrZWRTcGFuczsKICAgICAgICBpZiAoc3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgc3BzLmxlbmd0aDsgKytpKQogICAgICAgICAgeyBpZiAoc3BzW2ldLmZyb20gIT0gbnVsbCkgeyBtYXJrZXJzLnB1c2goc3BzW2ldLm1hcmtlcik7IH0gfSB9CiAgICAgIH0pOwogICAgICByZXR1cm4gbWFya2VycwogICAgfSwKCiAgICBwb3NGcm9tSW5kZXg6IGZ1bmN0aW9uKG9mZikgewogICAgICB2YXIgY2gsIGxpbmVObyQkMSA9IHRoaXMuZmlyc3QsIHNlcFNpemUgPSB0aGlzLmxpbmVTZXBhcmF0b3IoKS5sZW5ndGg7CiAgICAgIHRoaXMuaXRlcihmdW5jdGlvbiAobGluZSkgewogICAgICAgIHZhciBzeiA9IGxpbmUudGV4dC5sZW5ndGggKyBzZXBTaXplOwogICAgICAgIGlmIChzeiA+IG9mZikgeyBjaCA9IG9mZjsgcmV0dXJuIHRydWUgfQogICAgICAgIG9mZiAtPSBzejsKICAgICAgICArK2xpbmVObyQkMTsKICAgICAgfSk7CiAgICAgIHJldHVybiBjbGlwUG9zKHRoaXMsIFBvcyhsaW5lTm8kJDEsIGNoKSkKICAgIH0sCiAgICBpbmRleEZyb21Qb3M6IGZ1bmN0aW9uIChjb29yZHMpIHsKICAgICAgY29vcmRzID0gY2xpcFBvcyh0aGlzLCBjb29yZHMpOwogICAgICB2YXIgaW5kZXggPSBjb29yZHMuY2g7CiAgICAgIGlmIChjb29yZHMubGluZSA8IHRoaXMuZmlyc3QgfHwgY29vcmRzLmNoIDwgMCkgeyByZXR1cm4gMCB9CiAgICAgIHZhciBzZXBTaXplID0gdGhpcy5saW5lU2VwYXJhdG9yKCkubGVuZ3RoOwogICAgICB0aGlzLml0ZXIodGhpcy5maXJzdCwgY29vcmRzLmxpbmUsIGZ1bmN0aW9uIChsaW5lKSB7IC8vIGl0ZXIgYWJvcnRzIHdoZW4gY2FsbGJhY2sgcmV0dXJucyBhIHRydXRoeSB2YWx1ZQogICAgICAgIGluZGV4ICs9IGxpbmUudGV4dC5sZW5ndGggKyBzZXBTaXplOwogICAgICB9KTsKICAgICAgcmV0dXJuIGluZGV4CiAgICB9LAoKICAgIGNvcHk6IGZ1bmN0aW9uKGNvcHlIaXN0b3J5KSB7CiAgICAgIHZhciBkb2MgPSBuZXcgRG9jKGdldExpbmVzKHRoaXMsIHRoaXMuZmlyc3QsIHRoaXMuZmlyc3QgKyB0aGlzLnNpemUpLAogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1vZGVPcHRpb24sIHRoaXMuZmlyc3QsIHRoaXMubGluZVNlcCwgdGhpcy5kaXJlY3Rpb24pOwogICAgICBkb2Muc2Nyb2xsVG9wID0gdGhpcy5zY3JvbGxUb3A7IGRvYy5zY3JvbGxMZWZ0ID0gdGhpcy5zY3JvbGxMZWZ0OwogICAgICBkb2Muc2VsID0gdGhpcy5zZWw7CiAgICAgIGRvYy5leHRlbmQgPSBmYWxzZTsKICAgICAgaWYgKGNvcHlIaXN0b3J5KSB7CiAgICAgICAgZG9jLmhpc3RvcnkudW5kb0RlcHRoID0gdGhpcy5oaXN0b3J5LnVuZG9EZXB0aDsKICAgICAgICBkb2Muc2V0SGlzdG9yeSh0aGlzLmdldEhpc3RvcnkoKSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGRvYwogICAgfSwKCiAgICBsaW5rZWREb2M6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgaWYgKCFvcHRpb25zKSB7IG9wdGlvbnMgPSB7fTsgfQogICAgICB2YXIgZnJvbSA9IHRoaXMuZmlyc3QsIHRvID0gdGhpcy5maXJzdCArIHRoaXMuc2l6ZTsKICAgICAgaWYgKG9wdGlvbnMuZnJvbSAhPSBudWxsICYmIG9wdGlvbnMuZnJvbSA+IGZyb20pIHsgZnJvbSA9IG9wdGlvbnMuZnJvbTsgfQogICAgICBpZiAob3B0aW9ucy50byAhPSBudWxsICYmIG9wdGlvbnMudG8gPCB0bykgeyB0byA9IG9wdGlvbnMudG87IH0KICAgICAgdmFyIGNvcHkgPSBuZXcgRG9jKGdldExpbmVzKHRoaXMsIGZyb20sIHRvKSwgb3B0aW9ucy5tb2RlIHx8IHRoaXMubW9kZU9wdGlvbiwgZnJvbSwgdGhpcy5saW5lU2VwLCB0aGlzLmRpcmVjdGlvbik7CiAgICAgIGlmIChvcHRpb25zLnNoYXJlZEhpc3QpIHsgY29weS5oaXN0b3J5ID0gdGhpcy5oaXN0b3J5CiAgICAgIDsgfSh0aGlzLmxpbmtlZCB8fCAodGhpcy5saW5rZWQgPSBbXSkpLnB1c2goe2RvYzogY29weSwgc2hhcmVkSGlzdDogb3B0aW9ucy5zaGFyZWRIaXN0fSk7CiAgICAgIGNvcHkubGlua2VkID0gW3tkb2M6IHRoaXMsIGlzUGFyZW50OiB0cnVlLCBzaGFyZWRIaXN0OiBvcHRpb25zLnNoYXJlZEhpc3R9XTsKICAgICAgY29weVNoYXJlZE1hcmtlcnMoY29weSwgZmluZFNoYXJlZE1hcmtlcnModGhpcykpOwogICAgICByZXR1cm4gY29weQogICAgfSwKICAgIHVubGlua0RvYzogZnVuY3Rpb24ob3RoZXIpIHsKICAgICAgdmFyIHRoaXMkMSA9IHRoaXM7CgogICAgICBpZiAob3RoZXIgaW5zdGFuY2VvZiBDb2RlTWlycm9yKSB7IG90aGVyID0gb3RoZXIuZG9jOyB9CiAgICAgIGlmICh0aGlzLmxpbmtlZCkgeyBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMubGlua2VkLmxlbmd0aDsgKytpKSB7CiAgICAgICAgdmFyIGxpbmsgPSB0aGlzJDEubGlua2VkW2ldOwogICAgICAgIGlmIChsaW5rLmRvYyAhPSBvdGhlcikgeyBjb250aW51ZSB9CiAgICAgICAgdGhpcyQxLmxpbmtlZC5zcGxpY2UoaSwgMSk7CiAgICAgICAgb3RoZXIudW5saW5rRG9jKHRoaXMkMSk7CiAgICAgICAgZGV0YWNoU2hhcmVkTWFya2VycyhmaW5kU2hhcmVkTWFya2Vycyh0aGlzJDEpKTsKICAgICAgICBicmVhawogICAgICB9IH0KICAgICAgLy8gSWYgdGhlIGhpc3RvcmllcyB3ZXJlIHNoYXJlZCwgc3BsaXQgdGhlbSBhZ2FpbgogICAgICBpZiAob3RoZXIuaGlzdG9yeSA9PSB0aGlzLmhpc3RvcnkpIHsKICAgICAgICB2YXIgc3BsaXRJZHMgPSBbb3RoZXIuaWRdOwogICAgICAgIGxpbmtlZERvY3Mob3RoZXIsIGZ1bmN0aW9uIChkb2MpIHsgcmV0dXJuIHNwbGl0SWRzLnB1c2goZG9jLmlkKTsgfSwgdHJ1ZSk7CiAgICAgICAgb3RoZXIuaGlzdG9yeSA9IG5ldyBIaXN0b3J5KG51bGwpOwogICAgICAgIG90aGVyLmhpc3RvcnkuZG9uZSA9IGNvcHlIaXN0b3J5QXJyYXkodGhpcy5oaXN0b3J5LmRvbmUsIHNwbGl0SWRzKTsKICAgICAgICBvdGhlci5oaXN0b3J5LnVuZG9uZSA9IGNvcHlIaXN0b3J5QXJyYXkodGhpcy5oaXN0b3J5LnVuZG9uZSwgc3BsaXRJZHMpOwogICAgICB9CiAgICB9LAogICAgaXRlckxpbmtlZERvY3M6IGZ1bmN0aW9uKGYpIHtsaW5rZWREb2NzKHRoaXMsIGYpO30sCgogICAgZ2V0TW9kZTogZnVuY3Rpb24oKSB7cmV0dXJuIHRoaXMubW9kZX0sCiAgICBnZXRFZGl0b3I6IGZ1bmN0aW9uKCkge3JldHVybiB0aGlzLmNtfSwKCiAgICBzcGxpdExpbmVzOiBmdW5jdGlvbihzdHIpIHsKICAgICAgaWYgKHRoaXMubGluZVNlcCkgeyByZXR1cm4gc3RyLnNwbGl0KHRoaXMubGluZVNlcCkgfQogICAgICByZXR1cm4gc3BsaXRMaW5lc0F1dG8oc3RyKQogICAgfSwKICAgIGxpbmVTZXBhcmF0b3I6IGZ1bmN0aW9uKCkgeyByZXR1cm4gdGhpcy5saW5lU2VwIHx8ICJcbiIgfSwKCiAgICBzZXREaXJlY3Rpb246IGRvY01ldGhvZE9wKGZ1bmN0aW9uIChkaXIpIHsKICAgICAgaWYgKGRpciAhPSAicnRsIikgeyBkaXIgPSAibHRyIjsgfQogICAgICBpZiAoZGlyID09IHRoaXMuZGlyZWN0aW9uKSB7IHJldHVybiB9CiAgICAgIHRoaXMuZGlyZWN0aW9uID0gZGlyOwogICAgICB0aGlzLml0ZXIoZnVuY3Rpb24gKGxpbmUpIHsgcmV0dXJuIGxpbmUub3JkZXIgPSBudWxsOyB9KTsKICAgICAgaWYgKHRoaXMuY20pIHsgZGlyZWN0aW9uQ2hhbmdlZCh0aGlzLmNtKTsgfQogICAgfSkKICB9KTsKCiAgLy8gUHVibGljIGFsaWFzLgogIERvYy5wcm90b3R5cGUuZWFjaExpbmUgPSBEb2MucHJvdG90eXBlLml0ZXI7CgogIC8vIEtsdWRnZSB0byB3b3JrIGFyb3VuZCBzdHJhbmdlIElFIGJlaGF2aW9yIHdoZXJlIGl0J2xsIHNvbWV0aW1lcwogIC8vIHJlLWZpcmUgYSBzZXJpZXMgb2YgZHJhZy1yZWxhdGVkIGV2ZW50cyByaWdodCBhZnRlciB0aGUgZHJvcCAoIzE1NTEpCiAgdmFyIGxhc3REcm9wID0gMDsKCiAgZnVuY3Rpb24gb25Ecm9wKGUpIHsKICAgIHZhciBjbSA9IHRoaXM7CiAgICBjbGVhckRyYWdDdXJzb3IoY20pOwogICAgaWYgKHNpZ25hbERPTUV2ZW50KGNtLCBlKSB8fCBldmVudEluV2lkZ2V0KGNtLmRpc3BsYXksIGUpKQogICAgICB7IHJldHVybiB9CiAgICBlX3ByZXZlbnREZWZhdWx0KGUpOwogICAgaWYgKGllKSB7IGxhc3REcm9wID0gK25ldyBEYXRlOyB9CiAgICB2YXIgcG9zID0gcG9zRnJvbU1vdXNlKGNtLCBlLCB0cnVlKSwgZmlsZXMgPSBlLmRhdGFUcmFuc2Zlci5maWxlczsKICAgIGlmICghcG9zIHx8IGNtLmlzUmVhZE9ubHkoKSkgeyByZXR1cm4gfQogICAgLy8gTWlnaHQgYmUgYSBmaWxlIGRyb3AsIGluIHdoaWNoIGNhc2Ugd2Ugc2ltcGx5IGV4dHJhY3QgdGhlIHRleHQKICAgIC8vIGFuZCBpbnNlcnQgaXQuCiAgICBpZiAoZmlsZXMgJiYgZmlsZXMubGVuZ3RoICYmIHdpbmRvdy5GaWxlUmVhZGVyICYmIHdpbmRvdy5GaWxlKSB7CiAgICAgIHZhciBuID0gZmlsZXMubGVuZ3RoLCB0ZXh0ID0gQXJyYXkobiksIHJlYWQgPSAwOwogICAgICB2YXIgbG9hZEZpbGUgPSBmdW5jdGlvbiAoZmlsZSwgaSkgewogICAgICAgIGlmIChjbS5vcHRpb25zLmFsbG93RHJvcEZpbGVUeXBlcyAmJgogICAgICAgICAgICBpbmRleE9mKGNtLm9wdGlvbnMuYWxsb3dEcm9wRmlsZVR5cGVzLCBmaWxlLnR5cGUpID09IC0xKQogICAgICAgICAgeyByZXR1cm4gfQoKICAgICAgICB2YXIgcmVhZGVyID0gbmV3IEZpbGVSZWFkZXI7CiAgICAgICAgcmVhZGVyLm9ubG9hZCA9IG9wZXJhdGlvbihjbSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgdmFyIGNvbnRlbnQgPSByZWFkZXIucmVzdWx0OwogICAgICAgICAgaWYgKC9bXHgwMC1ceDA4XHgwZS1ceDFmXXsyfS8udGVzdChjb250ZW50KSkgeyBjb250ZW50ID0gIiI7IH0KICAgICAgICAgIHRleHRbaV0gPSBjb250ZW50OwogICAgICAgICAgaWYgKCsrcmVhZCA9PSBuKSB7CiAgICAgICAgICAgIHBvcyA9IGNsaXBQb3MoY20uZG9jLCBwb3MpOwogICAgICAgICAgICB2YXIgY2hhbmdlID0ge2Zyb206IHBvcywgdG86IHBvcywKICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0OiBjbS5kb2Muc3BsaXRMaW5lcyh0ZXh0LmpvaW4oY20uZG9jLmxpbmVTZXBhcmF0b3IoKSkpLAogICAgICAgICAgICAgICAgICAgICAgICAgIG9yaWdpbjogInBhc3RlIn07CiAgICAgICAgICAgIG1ha2VDaGFuZ2UoY20uZG9jLCBjaGFuZ2UpOwogICAgICAgICAgICBzZXRTZWxlY3Rpb25SZXBsYWNlSGlzdG9yeShjbS5kb2MsIHNpbXBsZVNlbGVjdGlvbihwb3MsIGNoYW5nZUVuZChjaGFuZ2UpKSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgcmVhZGVyLnJlYWRBc1RleHQoZmlsZSk7CiAgICAgIH07CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbjsgKytpKSB7IGxvYWRGaWxlKGZpbGVzW2ldLCBpKTsgfQogICAgfSBlbHNlIHsgLy8gTm9ybWFsIGRyb3AKICAgICAgLy8gRG9uJ3QgZG8gYSByZXBsYWNlIGlmIHRoZSBkcm9wIGhhcHBlbmVkIGluc2lkZSBvZiB0aGUgc2VsZWN0ZWQgdGV4dC4KICAgICAgaWYgKGNtLnN0YXRlLmRyYWdnaW5nVGV4dCAmJiBjbS5kb2Muc2VsLmNvbnRhaW5zKHBvcykgPiAtMSkgewogICAgICAgIGNtLnN0YXRlLmRyYWdnaW5nVGV4dChlKTsKICAgICAgICAvLyBFbnN1cmUgdGhlIGVkaXRvciBpcyByZS1mb2N1c2VkCiAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7IHJldHVybiBjbS5kaXNwbGF5LmlucHV0LmZvY3VzKCk7IH0sIDIwKTsKICAgICAgICByZXR1cm4KICAgICAgfQogICAgICB0cnkgewogICAgICAgIHZhciB0ZXh0JDEgPSBlLmRhdGFUcmFuc2Zlci5nZXREYXRhKCJUZXh0Iik7CiAgICAgICAgaWYgKHRleHQkMSkgewogICAgICAgICAgdmFyIHNlbGVjdGVkOwogICAgICAgICAgaWYgKGNtLnN0YXRlLmRyYWdnaW5nVGV4dCAmJiAhY20uc3RhdGUuZHJhZ2dpbmdUZXh0LmNvcHkpCiAgICAgICAgICAgIHsgc2VsZWN0ZWQgPSBjbS5saXN0U2VsZWN0aW9ucygpOyB9CiAgICAgICAgICBzZXRTZWxlY3Rpb25Ob1VuZG8oY20uZG9jLCBzaW1wbGVTZWxlY3Rpb24ocG9zLCBwb3MpKTsKICAgICAgICAgIGlmIChzZWxlY3RlZCkgeyBmb3IgKHZhciBpJDEgPSAwOyBpJDEgPCBzZWxlY3RlZC5sZW5ndGg7ICsraSQxKQogICAgICAgICAgICB7IHJlcGxhY2VSYW5nZShjbS5kb2MsICIiLCBzZWxlY3RlZFtpJDFdLmFuY2hvciwgc2VsZWN0ZWRbaSQxXS5oZWFkLCAiZHJhZyIpOyB9IH0KICAgICAgICAgIGNtLnJlcGxhY2VTZWxlY3Rpb24odGV4dCQxLCAiYXJvdW5kIiwgInBhc3RlIik7CiAgICAgICAgICBjbS5kaXNwbGF5LmlucHV0LmZvY3VzKCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGNhdGNoKGUpe30KICAgIH0KICB9CgogIGZ1bmN0aW9uIG9uRHJhZ1N0YXJ0KGNtLCBlKSB7CiAgICBpZiAoaWUgJiYgKCFjbS5zdGF0ZS5kcmFnZ2luZ1RleHQgfHwgK25ldyBEYXRlIC0gbGFzdERyb3AgPCAxMDApKSB7IGVfc3RvcChlKTsgcmV0dXJuIH0KICAgIGlmIChzaWduYWxET01FdmVudChjbSwgZSkgfHwgZXZlbnRJbldpZGdldChjbS5kaXNwbGF5LCBlKSkgeyByZXR1cm4gfQoKICAgIGUuZGF0YVRyYW5zZmVyLnNldERhdGEoIlRleHQiLCBjbS5nZXRTZWxlY3Rpb24oKSk7CiAgICBlLmRhdGFUcmFuc2Zlci5lZmZlY3RBbGxvd2VkID0gImNvcHlNb3ZlIjsKCiAgICAvLyBVc2UgZHVtbXkgaW1hZ2UgaW5zdGVhZCBvZiBkZWZhdWx0IGJyb3dzZXJzIGltYWdlLgogICAgLy8gUmVjZW50IFNhZmFyaSAofjYuMC4yKSBoYXZlIGEgdGVuZGVuY3kgdG8gc2VnZmF1bHQgd2hlbiB0aGlzIGhhcHBlbnMsIHNvIHdlIGRvbid0IGRvIGl0IHRoZXJlLgogICAgaWYgKGUuZGF0YVRyYW5zZmVyLnNldERyYWdJbWFnZSAmJiAhc2FmYXJpKSB7CiAgICAgIHZhciBpbWcgPSBlbHQoImltZyIsIG51bGwsIG51bGwsICJwb3NpdGlvbjogZml4ZWQ7IGxlZnQ6IDA7IHRvcDogMDsiKTsKICAgICAgaW1nLnNyYyA9ICJkYXRhOmltYWdlL2dpZjtiYXNlNjQsUjBsR09EbGhBUUFCQUFBQUFDSDVCQUVLQUFFQUxBQUFBQUFCQUFFQUFBSUNUQUVBT3c9PSI7CiAgICAgIGlmIChwcmVzdG8pIHsKICAgICAgICBpbWcud2lkdGggPSBpbWcuaGVpZ2h0ID0gMTsKICAgICAgICBjbS5kaXNwbGF5LndyYXBwZXIuYXBwZW5kQ2hpbGQoaW1nKTsKICAgICAgICAvLyBGb3JjZSBhIHJlbGF5b3V0LCBvciBPcGVyYSB3b24ndCB1c2Ugb3VyIGltYWdlIGZvciBzb21lIG9ic2N1cmUgcmVhc29uCiAgICAgICAgaW1nLl90b3AgPSBpbWcub2Zmc2V0VG9wOwogICAgICB9CiAgICAgIGUuZGF0YVRyYW5zZmVyLnNldERyYWdJbWFnZShpbWcsIDAsIDApOwogICAgICBpZiAocHJlc3RvKSB7IGltZy5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGltZyk7IH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIG9uRHJhZ092ZXIoY20sIGUpIHsKICAgIHZhciBwb3MgPSBwb3NGcm9tTW91c2UoY20sIGUpOwogICAgaWYgKCFwb3MpIHsgcmV0dXJuIH0KICAgIHZhciBmcmFnID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOwogICAgZHJhd1NlbGVjdGlvbkN1cnNvcihjbSwgcG9zLCBmcmFnKTsKICAgIGlmICghY20uZGlzcGxheS5kcmFnQ3Vyc29yKSB7CiAgICAgIGNtLmRpc3BsYXkuZHJhZ0N1cnNvciA9IGVsdCgiZGl2IiwgbnVsbCwgIkNvZGVNaXJyb3ItY3Vyc29ycyBDb2RlTWlycm9yLWRyYWdjdXJzb3JzIik7CiAgICAgIGNtLmRpc3BsYXkubGluZVNwYWNlLmluc2VydEJlZm9yZShjbS5kaXNwbGF5LmRyYWdDdXJzb3IsIGNtLmRpc3BsYXkuY3Vyc29yRGl2KTsKICAgIH0KICAgIHJlbW92ZUNoaWxkcmVuQW5kQWRkKGNtLmRpc3BsYXkuZHJhZ0N1cnNvciwgZnJhZyk7CiAgfQoKICBmdW5jdGlvbiBjbGVhckRyYWdDdXJzb3IoY20pIHsKICAgIGlmIChjbS5kaXNwbGF5LmRyYWdDdXJzb3IpIHsKICAgICAgY20uZGlzcGxheS5saW5lU3BhY2UucmVtb3ZlQ2hpbGQoY20uZGlzcGxheS5kcmFnQ3Vyc29yKTsKICAgICAgY20uZGlzcGxheS5kcmFnQ3Vyc29yID0gbnVsbDsKICAgIH0KICB9CgogIC8vIFRoZXNlIG11c3QgYmUgaGFuZGxlZCBjYXJlZnVsbHksIGJlY2F1c2UgbmFpdmVseSByZWdpc3RlcmluZyBhCiAgLy8gaGFuZGxlciBmb3IgZWFjaCBlZGl0b3Igd2lsbCBjYXVzZSB0aGUgZWRpdG9ycyB0byBuZXZlciBiZQogIC8vIGdhcmJhZ2UgY29sbGVjdGVkLgoKICBmdW5jdGlvbiBmb3JFYWNoQ29kZU1pcnJvcihmKSB7CiAgICBpZiAoIWRvY3VtZW50LmdldEVsZW1lbnRzQnlDbGFzc05hbWUpIHsgcmV0dXJuIH0KICAgIHZhciBieUNsYXNzID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgiQ29kZU1pcnJvciIpLCBlZGl0b3JzID0gW107CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGJ5Q2xhc3MubGVuZ3RoOyBpKyspIHsKICAgICAgdmFyIGNtID0gYnlDbGFzc1tpXS5Db2RlTWlycm9yOwogICAgICBpZiAoY20pIHsgZWRpdG9ycy5wdXNoKGNtKTsgfQogICAgfQogICAgaWYgKGVkaXRvcnMubGVuZ3RoKSB7IGVkaXRvcnNbMF0ub3BlcmF0aW9uKGZ1bmN0aW9uICgpIHsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBlZGl0b3JzLmxlbmd0aDsgaSsrKSB7IGYoZWRpdG9yc1tpXSk7IH0KICAgIH0pOyB9CiAgfQoKICB2YXIgZ2xvYmFsc1JlZ2lzdGVyZWQgPSBmYWxzZTsKICBmdW5jdGlvbiBlbnN1cmVHbG9iYWxIYW5kbGVycygpIHsKICAgIGlmIChnbG9iYWxzUmVnaXN0ZXJlZCkgeyByZXR1cm4gfQogICAgcmVnaXN0ZXJHbG9iYWxIYW5kbGVycygpOwogICAgZ2xvYmFsc1JlZ2lzdGVyZWQgPSB0cnVlOwogIH0KICBmdW5jdGlvbiByZWdpc3Rlckdsb2JhbEhhbmRsZXJzKCkgewogICAgLy8gV2hlbiB0aGUgd2luZG93IHJlc2l6ZXMsIHdlIG5lZWQgdG8gcmVmcmVzaCBhY3RpdmUgZWRpdG9ycy4KICAgIHZhciByZXNpemVUaW1lcjsKICAgIG9uKHdpbmRvdywgInJlc2l6ZSIsIGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKHJlc2l6ZVRpbWVyID09IG51bGwpIHsgcmVzaXplVGltZXIgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICByZXNpemVUaW1lciA9IG51bGw7CiAgICAgICAgZm9yRWFjaENvZGVNaXJyb3Iob25SZXNpemUpOwogICAgICB9LCAxMDApOyB9CiAgICB9KTsKICAgIC8vIFdoZW4gdGhlIHdpbmRvdyBsb3NlcyBmb2N1cywgd2Ugd2FudCB0byBzaG93IHRoZSBlZGl0b3IgYXMgYmx1cnJlZAogICAgb24od2luZG93LCAiYmx1ciIsIGZ1bmN0aW9uICgpIHsgcmV0dXJuIGZvckVhY2hDb2RlTWlycm9yKG9uQmx1cik7IH0pOwogIH0KICAvLyBDYWxsZWQgd2hlbiB0aGUgd2luZG93IHJlc2l6ZXMKICBmdW5jdGlvbiBvblJlc2l6ZShjbSkgewogICAgdmFyIGQgPSBjbS5kaXNwbGF5OwogICAgLy8gTWlnaHQgYmUgYSB0ZXh0IHNjYWxpbmcgb3BlcmF0aW9uLCBjbGVhciBzaXplIGNhY2hlcy4KICAgIGQuY2FjaGVkQ2hhcldpZHRoID0gZC5jYWNoZWRUZXh0SGVpZ2h0ID0gZC5jYWNoZWRQYWRkaW5nSCA9IG51bGw7CiAgICBkLnNjcm9sbGJhcnNDbGlwcGVkID0gZmFsc2U7CiAgICBjbS5zZXRTaXplKCk7CiAgfQoKICB2YXIga2V5TmFtZXMgPSB7CiAgICAzOiAiUGF1c2UiLCA4OiAiQmFja3NwYWNlIiwgOTogIlRhYiIsIDEzOiAiRW50ZXIiLCAxNjogIlNoaWZ0IiwgMTc6ICJDdHJsIiwgMTg6ICJBbHQiLAogICAgMTk6ICJQYXVzZSIsIDIwOiAiQ2Fwc0xvY2siLCAyNzogIkVzYyIsIDMyOiAiU3BhY2UiLCAzMzogIlBhZ2VVcCIsIDM0OiAiUGFnZURvd24iLCAzNTogIkVuZCIsCiAgICAzNjogIkhvbWUiLCAzNzogIkxlZnQiLCAzODogIlVwIiwgMzk6ICJSaWdodCIsIDQwOiAiRG93biIsIDQ0OiAiUHJpbnRTY3JuIiwgNDU6ICJJbnNlcnQiLAogICAgNDY6ICJEZWxldGUiLCA1OTogIjsiLCA2MTogIj0iLCA5MTogIk1vZCIsIDkyOiAiTW9kIiwgOTM6ICJNb2QiLAogICAgMTA2OiAiKiIsIDEwNzogIj0iLCAxMDk6ICItIiwgMTEwOiAiLiIsIDExMTogIi8iLCAxNDU6ICJTY3JvbGxMb2NrIiwKICAgIDE3MzogIi0iLCAxODY6ICI7IiwgMTg3OiAiPSIsIDE4ODogIiwiLCAxODk6ICItIiwgMTkwOiAiLiIsIDE5MTogIi8iLCAxOTI6ICJgIiwgMjE5OiAiWyIsIDIyMDogIlxcIiwKICAgIDIyMTogIl0iLCAyMjI6ICInIiwgNjMyMzI6ICJVcCIsIDYzMjMzOiAiRG93biIsIDYzMjM0OiAiTGVmdCIsIDYzMjM1OiAiUmlnaHQiLCA2MzI3MjogIkRlbGV0ZSIsCiAgICA2MzI3MzogIkhvbWUiLCA2MzI3NTogIkVuZCIsIDYzMjc2OiAiUGFnZVVwIiwgNjMyNzc6ICJQYWdlRG93biIsIDYzMzAyOiAiSW5zZXJ0IgogIH07CgogIC8vIE51bWJlciBrZXlzCiAgZm9yICh2YXIgaSA9IDA7IGkgPCAxMDsgaSsrKSB7IGtleU5hbWVzW2kgKyA0OF0gPSBrZXlOYW1lc1tpICsgOTZdID0gU3RyaW5nKGkpOyB9CiAgLy8gQWxwaGFiZXRpYyBrZXlzCiAgZm9yICh2YXIgaSQxID0gNjU7IGkkMSA8PSA5MDsgaSQxKyspIHsga2V5TmFtZXNbaSQxXSA9IFN0cmluZy5mcm9tQ2hhckNvZGUoaSQxKTsgfQogIC8vIEZ1bmN0aW9uIGtleXMKICBmb3IgKHZhciBpJDIgPSAxOyBpJDIgPD0gMTI7IGkkMisrKSB7IGtleU5hbWVzW2kkMiArIDExMV0gPSBrZXlOYW1lc1tpJDIgKyA2MzIzNV0gPSAiRiIgKyBpJDI7IH0KCiAgdmFyIGtleU1hcCA9IHt9OwoKICBrZXlNYXAuYmFzaWMgPSB7CiAgICAiTGVmdCI6ICJnb0NoYXJMZWZ0IiwgIlJpZ2h0IjogImdvQ2hhclJpZ2h0IiwgIlVwIjogImdvTGluZVVwIiwgIkRvd24iOiAiZ29MaW5lRG93biIsCiAgICAiRW5kIjogImdvTGluZUVuZCIsICJIb21lIjogImdvTGluZVN0YXJ0U21hcnQiLCAiUGFnZVVwIjogImdvUGFnZVVwIiwgIlBhZ2VEb3duIjogImdvUGFnZURvd24iLAogICAgIkRlbGV0ZSI6ICJkZWxDaGFyQWZ0ZXIiLCAiQmFja3NwYWNlIjogImRlbENoYXJCZWZvcmUiLCAiU2hpZnQtQmFja3NwYWNlIjogImRlbENoYXJCZWZvcmUiLAogICAgIlRhYiI6ICJkZWZhdWx0VGFiIiwgIlNoaWZ0LVRhYiI6ICJpbmRlbnRBdXRvIiwKICAgICJFbnRlciI6ICJuZXdsaW5lQW5kSW5kZW50IiwgIkluc2VydCI6ICJ0b2dnbGVPdmVyd3JpdGUiLAogICAgIkVzYyI6ICJzaW5nbGVTZWxlY3Rpb24iCiAgfTsKICAvLyBOb3RlIHRoYXQgdGhlIHNhdmUgYW5kIGZpbmQtcmVsYXRlZCBjb21tYW5kcyBhcmVuJ3QgZGVmaW5lZCBieQogIC8vIGRlZmF1bHQuIFVzZXIgY29kZSBvciBhZGRvbnMgY2FuIGRlZmluZSB0aGVtLiBVbmtub3duIGNvbW1hbmRzCiAgLy8gYXJlIHNpbXBseSBpZ25vcmVkLgogIGtleU1hcC5wY0RlZmF1bHQgPSB7CiAgICAiQ3RybC1BIjogInNlbGVjdEFsbCIsICJDdHJsLUQiOiAiZGVsZXRlTGluZSIsICJDdHJsLVoiOiAidW5kbyIsICJTaGlmdC1DdHJsLVoiOiAicmVkbyIsICJDdHJsLVkiOiAicmVkbyIsCiAgICAiQ3RybC1Ib21lIjogImdvRG9jU3RhcnQiLCAiQ3RybC1FbmQiOiAiZ29Eb2NFbmQiLCAiQ3RybC1VcCI6ICJnb0xpbmVVcCIsICJDdHJsLURvd24iOiAiZ29MaW5lRG93biIsCiAgICAiQ3RybC1MZWZ0IjogImdvR3JvdXBMZWZ0IiwgIkN0cmwtUmlnaHQiOiAiZ29Hcm91cFJpZ2h0IiwgIkFsdC1MZWZ0IjogImdvTGluZVN0YXJ0IiwgIkFsdC1SaWdodCI6ICJnb0xpbmVFbmQiLAogICAgIkN0cmwtQmFja3NwYWNlIjogImRlbEdyb3VwQmVmb3JlIiwgIkN0cmwtRGVsZXRlIjogImRlbEdyb3VwQWZ0ZXIiLCAiQ3RybC1TIjogInNhdmUiLCAiQ3RybC1GIjogImZpbmQiLAogICAgIkN0cmwtRyI6ICJmaW5kTmV4dCIsICJTaGlmdC1DdHJsLUciOiAiZmluZFByZXYiLCAiU2hpZnQtQ3RybC1GIjogInJlcGxhY2UiLCAiU2hpZnQtQ3RybC1SIjogInJlcGxhY2VBbGwiLAogICAgIkN0cmwtWyI6ICJpbmRlbnRMZXNzIiwgIkN0cmwtXSI6ICJpbmRlbnRNb3JlIiwKICAgICJDdHJsLVUiOiAidW5kb1NlbGVjdGlvbiIsICJTaGlmdC1DdHJsLVUiOiAicmVkb1NlbGVjdGlvbiIsICJBbHQtVSI6ICJyZWRvU2VsZWN0aW9uIiwKICAgICJmYWxsdGhyb3VnaCI6ICJiYXNpYyIKICB9OwogIC8vIFZlcnkgYmFzaWMgcmVhZGxpbmUvZW1hY3Mtc3R5bGUgYmluZGluZ3MsIHdoaWNoIGFyZSBzdGFuZGFyZCBvbiBNYWMuCiAga2V5TWFwLmVtYWNzeSA9IHsKICAgICJDdHJsLUYiOiAiZ29DaGFyUmlnaHQiLCAiQ3RybC1CIjogImdvQ2hhckxlZnQiLCAiQ3RybC1QIjogImdvTGluZVVwIiwgIkN0cmwtTiI6ICJnb0xpbmVEb3duIiwKICAgICJBbHQtRiI6ICJnb1dvcmRSaWdodCIsICJBbHQtQiI6ICJnb1dvcmRMZWZ0IiwgIkN0cmwtQSI6ICJnb0xpbmVTdGFydCIsICJDdHJsLUUiOiAiZ29MaW5lRW5kIiwKICAgICJDdHJsLVYiOiAiZ29QYWdlRG93biIsICJTaGlmdC1DdHJsLVYiOiAiZ29QYWdlVXAiLCAiQ3RybC1EIjogImRlbENoYXJBZnRlciIsICJDdHJsLUgiOiAiZGVsQ2hhckJlZm9yZSIsCiAgICAiQWx0LUQiOiAiZGVsV29yZEFmdGVyIiwgIkFsdC1CYWNrc3BhY2UiOiAiZGVsV29yZEJlZm9yZSIsICJDdHJsLUsiOiAia2lsbExpbmUiLCAiQ3RybC1UIjogInRyYW5zcG9zZUNoYXJzIiwKICAgICJDdHJsLU8iOiAib3BlbkxpbmUiCiAgfTsKICBrZXlNYXAubWFjRGVmYXVsdCA9IHsKICAgICJDbWQtQSI6ICJzZWxlY3RBbGwiLCAiQ21kLUQiOiAiZGVsZXRlTGluZSIsICJDbWQtWiI6ICJ1bmRvIiwgIlNoaWZ0LUNtZC1aIjogInJlZG8iLCAiQ21kLVkiOiAicmVkbyIsCiAgICAiQ21kLUhvbWUiOiAiZ29Eb2NTdGFydCIsICJDbWQtVXAiOiAiZ29Eb2NTdGFydCIsICJDbWQtRW5kIjogImdvRG9jRW5kIiwgIkNtZC1Eb3duIjogImdvRG9jRW5kIiwgIkFsdC1MZWZ0IjogImdvR3JvdXBMZWZ0IiwKICAgICJBbHQtUmlnaHQiOiAiZ29Hcm91cFJpZ2h0IiwgIkNtZC1MZWZ0IjogImdvTGluZUxlZnQiLCAiQ21kLVJpZ2h0IjogImdvTGluZVJpZ2h0IiwgIkFsdC1CYWNrc3BhY2UiOiAiZGVsR3JvdXBCZWZvcmUiLAogICAgIkN0cmwtQWx0LUJhY2tzcGFjZSI6ICJkZWxHcm91cEFmdGVyIiwgIkFsdC1EZWxldGUiOiAiZGVsR3JvdXBBZnRlciIsICJDbWQtUyI6ICJzYXZlIiwgIkNtZC1GIjogImZpbmQiLAogICAgIkNtZC1HIjogImZpbmROZXh0IiwgIlNoaWZ0LUNtZC1HIjogImZpbmRQcmV2IiwgIkNtZC1BbHQtRiI6ICJyZXBsYWNlIiwgIlNoaWZ0LUNtZC1BbHQtRiI6ICJyZXBsYWNlQWxsIiwKICAgICJDbWQtWyI6ICJpbmRlbnRMZXNzIiwgIkNtZC1dIjogImluZGVudE1vcmUiLCAiQ21kLUJhY2tzcGFjZSI6ICJkZWxXcmFwcGVkTGluZUxlZnQiLCAiQ21kLURlbGV0ZSI6ICJkZWxXcmFwcGVkTGluZVJpZ2h0IiwKICAgICJDbWQtVSI6ICJ1bmRvU2VsZWN0aW9uIiwgIlNoaWZ0LUNtZC1VIjogInJlZG9TZWxlY3Rpb24iLCAiQ3RybC1VcCI6ICJnb0RvY1N0YXJ0IiwgIkN0cmwtRG93biI6ICJnb0RvY0VuZCIsCiAgICAiZmFsbHRocm91Z2giOiBbImJhc2ljIiwgImVtYWNzeSJdCiAgfTsKICBrZXlNYXBbImRlZmF1bHQiXSA9IG1hYyA/IGtleU1hcC5tYWNEZWZhdWx0IDoga2V5TWFwLnBjRGVmYXVsdDsKCiAgLy8gS0VZTUFQIERJU1BBVENICgogIGZ1bmN0aW9uIG5vcm1hbGl6ZUtleU5hbWUobmFtZSkgewogICAgdmFyIHBhcnRzID0gbmFtZS5zcGxpdCgvLSg/ISQpLyk7CiAgICBuYW1lID0gcGFydHNbcGFydHMubGVuZ3RoIC0gMV07CiAgICB2YXIgYWx0LCBjdHJsLCBzaGlmdCwgY21kOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwYXJ0cy5sZW5ndGggLSAxOyBpKyspIHsKICAgICAgdmFyIG1vZCA9IHBhcnRzW2ldOwogICAgICBpZiAoL14oY21kfG1ldGF8bSkkL2kudGVzdChtb2QpKSB7IGNtZCA9IHRydWU7IH0KICAgICAgZWxzZSBpZiAoL15hKGx0KT8kL2kudGVzdChtb2QpKSB7IGFsdCA9IHRydWU7IH0KICAgICAgZWxzZSBpZiAoL14oY3xjdHJsfGNvbnRyb2wpJC9pLnRlc3QobW9kKSkgeyBjdHJsID0gdHJ1ZTsgfQogICAgICBlbHNlIGlmICgvXnMoaGlmdCk/JC9pLnRlc3QobW9kKSkgeyBzaGlmdCA9IHRydWU7IH0KICAgICAgZWxzZSB7IHRocm93IG5ldyBFcnJvcigiVW5yZWNvZ25pemVkIG1vZGlmaWVyIG5hbWU6ICIgKyBtb2QpIH0KICAgIH0KICAgIGlmIChhbHQpIHsgbmFtZSA9ICJBbHQtIiArIG5hbWU7IH0KICAgIGlmIChjdHJsKSB7IG5hbWUgPSAiQ3RybC0iICsgbmFtZTsgfQogICAgaWYgKGNtZCkgeyBuYW1lID0gIkNtZC0iICsgbmFtZTsgfQogICAgaWYgKHNoaWZ0KSB7IG5hbWUgPSAiU2hpZnQtIiArIG5hbWU7IH0KICAgIHJldHVybiBuYW1lCiAgfQoKICAvLyBUaGlzIGlzIGEga2x1ZGdlIHRvIGtlZXAga2V5bWFwcyBtb3N0bHkgd29ya2luZyBhcyByYXcgb2JqZWN0cwogIC8vIChiYWNrd2FyZHMgY29tcGF0aWJpbGl0eSkgd2hpbGUgYXQgdGhlIHNhbWUgdGltZSBzdXBwb3J0IGZlYXR1cmVzCiAgLy8gbGlrZSBub3JtYWxpemF0aW9uIGFuZCBtdWx0aS1zdHJva2Uga2V5IGJpbmRpbmdzLiBJdCBjb21waWxlcyBhCiAgLy8gbmV3IG5vcm1hbGl6ZWQga2V5bWFwLCBhbmQgdGhlbiB1cGRhdGVzIHRoZSBvbGQgb2JqZWN0IHRvIHJlZmxlY3QKICAvLyB0aGlzLgogIGZ1bmN0aW9uIG5vcm1hbGl6ZUtleU1hcChrZXltYXApIHsKICAgIHZhciBjb3B5ID0ge307CiAgICBmb3IgKHZhciBrZXluYW1lIGluIGtleW1hcCkgeyBpZiAoa2V5bWFwLmhhc093blByb3BlcnR5KGtleW5hbWUpKSB7CiAgICAgIHZhciB2YWx1ZSA9IGtleW1hcFtrZXluYW1lXTsKICAgICAgaWYgKC9eKG5hbWV8ZmFsbHRocm91Z2h8KGRlfGF0KXRhY2gpJC8udGVzdChrZXluYW1lKSkgeyBjb250aW51ZSB9CiAgICAgIGlmICh2YWx1ZSA9PSAiLi4uIikgeyBkZWxldGUga2V5bWFwW2tleW5hbWVdOyBjb250aW51ZSB9CgogICAgICB2YXIga2V5cyA9IG1hcChrZXluYW1lLnNwbGl0KCIgIiksIG5vcm1hbGl6ZUtleU5hbWUpOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIgdmFsID0gKHZvaWQgMCksIG5hbWUgPSAodm9pZCAwKTsKICAgICAgICBpZiAoaSA9PSBrZXlzLmxlbmd0aCAtIDEpIHsKICAgICAgICAgIG5hbWUgPSBrZXlzLmpvaW4oIiAiKTsKICAgICAgICAgIHZhbCA9IHZhbHVlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBuYW1lID0ga2V5cy5zbGljZSgwLCBpICsgMSkuam9pbigiICIpOwogICAgICAgICAgdmFsID0gIi4uLiI7CiAgICAgICAgfQogICAgICAgIHZhciBwcmV2ID0gY29weVtuYW1lXTsKICAgICAgICBpZiAoIXByZXYpIHsgY29weVtuYW1lXSA9IHZhbDsgfQogICAgICAgIGVsc2UgaWYgKHByZXYgIT0gdmFsKSB7IHRocm93IG5ldyBFcnJvcigiSW5jb25zaXN0ZW50IGJpbmRpbmdzIGZvciAiICsgbmFtZSkgfQogICAgICB9CiAgICAgIGRlbGV0ZSBrZXltYXBba2V5bmFtZV07CiAgICB9IH0KICAgIGZvciAodmFyIHByb3AgaW4gY29weSkgeyBrZXltYXBbcHJvcF0gPSBjb3B5W3Byb3BdOyB9CiAgICByZXR1cm4ga2V5bWFwCiAgfQoKICBmdW5jdGlvbiBsb29rdXBLZXkoa2V5LCBtYXAkJDEsIGhhbmRsZSwgY29udGV4dCkgewogICAgbWFwJCQxID0gZ2V0S2V5TWFwKG1hcCQkMSk7CiAgICB2YXIgZm91bmQgPSBtYXAkJDEuY2FsbCA/IG1hcCQkMS5jYWxsKGtleSwgY29udGV4dCkgOiBtYXAkJDFba2V5XTsKICAgIGlmIChmb3VuZCA9PT0gZmFsc2UpIHsgcmV0dXJuICJub3RoaW5nIiB9CiAgICBpZiAoZm91bmQgPT09ICIuLi4iKSB7IHJldHVybiAibXVsdGkiIH0KICAgIGlmIChmb3VuZCAhPSBudWxsICYmIGhhbmRsZShmb3VuZCkpIHsgcmV0dXJuICJoYW5kbGVkIiB9CgogICAgaWYgKG1hcCQkMS5mYWxsdGhyb3VnaCkgewogICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG1hcCQkMS5mYWxsdGhyb3VnaCkgIT0gIltvYmplY3QgQXJyYXldIikKICAgICAgICB7IHJldHVybiBsb29rdXBLZXkoa2V5LCBtYXAkJDEuZmFsbHRocm91Z2gsIGhhbmRsZSwgY29udGV4dCkgfQogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG1hcCQkMS5mYWxsdGhyb3VnaC5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciByZXN1bHQgPSBsb29rdXBLZXkoa2V5LCBtYXAkJDEuZmFsbHRocm91Z2hbaV0sIGhhbmRsZSwgY29udGV4dCk7CiAgICAgICAgaWYgKHJlc3VsdCkgeyByZXR1cm4gcmVzdWx0IH0KICAgICAgfQogICAgfQogIH0KCiAgLy8gTW9kaWZpZXIga2V5IHByZXNzZXMgZG9uJ3QgY291bnQgYXMgJ3JlYWwnIGtleSBwcmVzc2VzIGZvciB0aGUKICAvLyBwdXJwb3NlIG9mIGtleW1hcCBmYWxsdGhyb3VnaC4KICBmdW5jdGlvbiBpc01vZGlmaWVyS2V5KHZhbHVlKSB7CiAgICB2YXIgbmFtZSA9IHR5cGVvZiB2YWx1ZSA9PSAic3RyaW5nIiA/IHZhbHVlIDoga2V5TmFtZXNbdmFsdWUua2V5Q29kZV07CiAgICByZXR1cm4gbmFtZSA9PSAiQ3RybCIgfHwgbmFtZSA9PSAiQWx0IiB8fCBuYW1lID09ICJTaGlmdCIgfHwgbmFtZSA9PSAiTW9kIgogIH0KCiAgZnVuY3Rpb24gYWRkTW9kaWZpZXJOYW1lcyhuYW1lLCBldmVudCwgbm9TaGlmdCkgewogICAgdmFyIGJhc2UgPSBuYW1lOwogICAgaWYgKGV2ZW50LmFsdEtleSAmJiBiYXNlICE9ICJBbHQiKSB7IG5hbWUgPSAiQWx0LSIgKyBuYW1lOyB9CiAgICBpZiAoKGZsaXBDdHJsQ21kID8gZXZlbnQubWV0YUtleSA6IGV2ZW50LmN0cmxLZXkpICYmIGJhc2UgIT0gIkN0cmwiKSB7IG5hbWUgPSAiQ3RybC0iICsgbmFtZTsgfQogICAgaWYgKChmbGlwQ3RybENtZCA/IGV2ZW50LmN0cmxLZXkgOiBldmVudC5tZXRhS2V5KSAmJiBiYXNlICE9ICJDbWQiKSB7IG5hbWUgPSAiQ21kLSIgKyBuYW1lOyB9CiAgICBpZiAoIW5vU2hpZnQgJiYgZXZlbnQuc2hpZnRLZXkgJiYgYmFzZSAhPSAiU2hpZnQiKSB7IG5hbWUgPSAiU2hpZnQtIiArIG5hbWU7IH0KICAgIHJldHVybiBuYW1lCiAgfQoKICAvLyBMb29rIHVwIHRoZSBuYW1lIG9mIGEga2V5IGFzIGluZGljYXRlZCBieSBhbiBldmVudCBvYmplY3QuCiAgZnVuY3Rpb24ga2V5TmFtZShldmVudCwgbm9TaGlmdCkgewogICAgaWYgKHByZXN0byAmJiBldmVudC5rZXlDb2RlID09IDM0ICYmIGV2ZW50WyJjaGFyIl0pIHsgcmV0dXJuIGZhbHNlIH0KICAgIHZhciBuYW1lID0ga2V5TmFtZXNbZXZlbnQua2V5Q29kZV07CiAgICBpZiAobmFtZSA9PSBudWxsIHx8IGV2ZW50LmFsdEdyYXBoS2V5KSB7IHJldHVybiBmYWxzZSB9CiAgICAvLyBDdHJsLVNjcm9sbExvY2sgaGFzIGtleUNvZGUgMywgc2FtZSBhcyBDdHJsLVBhdXNlLAogICAgLy8gc28gd2UnbGwgdXNlIGV2ZW50LmNvZGUgd2hlbiBhdmFpbGFibGUgKENocm9tZSA0OCssIEZGIDM4KywgU2FmYXJpIDEwLjErKQogICAgaWYgKGV2ZW50LmtleUNvZGUgPT0gMyAmJiBldmVudC5jb2RlKSB7IG5hbWUgPSBldmVudC5jb2RlOyB9CiAgICByZXR1cm4gYWRkTW9kaWZpZXJOYW1lcyhuYW1lLCBldmVudCwgbm9TaGlmdCkKICB9CgogIGZ1bmN0aW9uIGdldEtleU1hcCh2YWwpIHsKICAgIHJldHVybiB0eXBlb2YgdmFsID09ICJzdHJpbmciID8ga2V5TWFwW3ZhbF0gOiB2YWwKICB9CgogIC8vIEhlbHBlciBmb3IgZGVsZXRpbmcgdGV4dCBuZWFyIHRoZSBzZWxlY3Rpb24ocyksIHVzZWQgdG8gaW1wbGVtZW50CiAgLy8gYmFja3NwYWNlLCBkZWxldGUsIGFuZCBzaW1pbGFyIGZ1bmN0aW9uYWxpdHkuCiAgZnVuY3Rpb24gZGVsZXRlTmVhclNlbGVjdGlvbihjbSwgY29tcHV0ZSkgewogICAgdmFyIHJhbmdlcyA9IGNtLmRvYy5zZWwucmFuZ2VzLCBraWxsID0gW107CiAgICAvLyBCdWlsZCB1cCBhIHNldCBvZiByYW5nZXMgdG8ga2lsbCBmaXJzdCwgbWVyZ2luZyBvdmVybGFwcGluZwogICAgLy8gcmFuZ2VzLgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCByYW5nZXMubGVuZ3RoOyBpKyspIHsKICAgICAgdmFyIHRvS2lsbCA9IGNvbXB1dGUocmFuZ2VzW2ldKTsKICAgICAgd2hpbGUgKGtpbGwubGVuZ3RoICYmIGNtcCh0b0tpbGwuZnJvbSwgbHN0KGtpbGwpLnRvKSA8PSAwKSB7CiAgICAgICAgdmFyIHJlcGxhY2VkID0ga2lsbC5wb3AoKTsKICAgICAgICBpZiAoY21wKHJlcGxhY2VkLmZyb20sIHRvS2lsbC5mcm9tKSA8IDApIHsKICAgICAgICAgIHRvS2lsbC5mcm9tID0gcmVwbGFjZWQuZnJvbTsKICAgICAgICAgIGJyZWFrCiAgICAgICAgfQogICAgICB9CiAgICAgIGtpbGwucHVzaCh0b0tpbGwpOwogICAgfQogICAgLy8gTmV4dCwgcmVtb3ZlIHRob3NlIGFjdHVhbCByYW5nZXMuCiAgICBydW5Jbk9wKGNtLCBmdW5jdGlvbiAoKSB7CiAgICAgIGZvciAodmFyIGkgPSBraWxsLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKQogICAgICAgIHsgcmVwbGFjZVJhbmdlKGNtLmRvYywgIiIsIGtpbGxbaV0uZnJvbSwga2lsbFtpXS50bywgIitkZWxldGUiKTsgfQogICAgICBlbnN1cmVDdXJzb3JWaXNpYmxlKGNtKTsKICAgIH0pOwogIH0KCiAgZnVuY3Rpb24gbW92ZUNoYXJMb2dpY2FsbHkobGluZSwgY2gsIGRpcikgewogICAgdmFyIHRhcmdldCA9IHNraXBFeHRlbmRpbmdDaGFycyhsaW5lLnRleHQsIGNoICsgZGlyLCBkaXIpOwogICAgcmV0dXJuIHRhcmdldCA8IDAgfHwgdGFyZ2V0ID4gbGluZS50ZXh0Lmxlbmd0aCA/IG51bGwgOiB0YXJnZXQKICB9CgogIGZ1bmN0aW9uIG1vdmVMb2dpY2FsbHkobGluZSwgc3RhcnQsIGRpcikgewogICAgdmFyIGNoID0gbW92ZUNoYXJMb2dpY2FsbHkobGluZSwgc3RhcnQuY2gsIGRpcik7CiAgICByZXR1cm4gY2ggPT0gbnVsbCA/IG51bGwgOiBuZXcgUG9zKHN0YXJ0LmxpbmUsIGNoLCBkaXIgPCAwID8gImFmdGVyIiA6ICJiZWZvcmUiKQogIH0KCiAgZnVuY3Rpb24gZW5kT2ZMaW5lKHZpc3VhbGx5LCBjbSwgbGluZU9iaiwgbGluZU5vLCBkaXIpIHsKICAgIGlmICh2aXN1YWxseSkgewogICAgICB2YXIgb3JkZXIgPSBnZXRPcmRlcihsaW5lT2JqLCBjbS5kb2MuZGlyZWN0aW9uKTsKICAgICAgaWYgKG9yZGVyKSB7CiAgICAgICAgdmFyIHBhcnQgPSBkaXIgPCAwID8gbHN0KG9yZGVyKSA6IG9yZGVyWzBdOwogICAgICAgIHZhciBtb3ZlSW5TdG9yYWdlT3JkZXIgPSAoZGlyIDwgMCkgPT0gKHBhcnQubGV2ZWwgPT0gMSk7CiAgICAgICAgdmFyIHN0aWNreSA9IG1vdmVJblN0b3JhZ2VPcmRlciA/ICJhZnRlciIgOiAiYmVmb3JlIjsKICAgICAgICB2YXIgY2g7CiAgICAgICAgLy8gV2l0aCBhIHdyYXBwZWQgcnRsIGNodW5rIChwb3NzaWJseSBzcGFubmluZyBtdWx0aXBsZSBiaWRpIHBhcnRzKSwKICAgICAgICAvLyBpdCBjb3VsZCBiZSB0aGF0IHRoZSBsYXN0IGJpZGkgcGFydCBpcyBub3Qgb24gdGhlIGxhc3QgdmlzdWFsIGxpbmUsCiAgICAgICAgLy8gc2luY2UgdmlzdWFsIGxpbmVzIGNvbnRhaW4gY29udGVudCBvcmRlci1jb25zZWN1dGl2ZSBjaHVua3MuCiAgICAgICAgLy8gVGh1cywgaW4gcnRsLCB3ZSBhcmUgbG9va2luZyBmb3IgdGhlIGZpcnN0IChjb250ZW50LW9yZGVyKSBjaGFyYWN0ZXIKICAgICAgICAvLyBpbiB0aGUgcnRsIGNodW5rIHRoYXQgaXMgb24gdGhlIGxhc3QgbGluZSAodGhhdCBpcywgdGhlIHNhbWUgbGluZQogICAgICAgIC8vIGFzIHRoZSBsYXN0IChjb250ZW50LW9yZGVyKSBjaGFyYWN0ZXIpLgogICAgICAgIGlmIChwYXJ0LmxldmVsID4gMCB8fCBjbS5kb2MuZGlyZWN0aW9uID09ICJydGwiKSB7CiAgICAgICAgICB2YXIgcHJlcCA9IHByZXBhcmVNZWFzdXJlRm9yTGluZShjbSwgbGluZU9iaik7CiAgICAgICAgICBjaCA9IGRpciA8IDAgPyBsaW5lT2JqLnRleHQubGVuZ3RoIC0gMSA6IDA7CiAgICAgICAgICB2YXIgdGFyZ2V0VG9wID0gbWVhc3VyZUNoYXJQcmVwYXJlZChjbSwgcHJlcCwgY2gpLnRvcDsKICAgICAgICAgIGNoID0gZmluZEZpcnN0KGZ1bmN0aW9uIChjaCkgeyByZXR1cm4gbWVhc3VyZUNoYXJQcmVwYXJlZChjbSwgcHJlcCwgY2gpLnRvcCA9PSB0YXJnZXRUb3A7IH0sIChkaXIgPCAwKSA9PSAocGFydC5sZXZlbCA9PSAxKSA/IHBhcnQuZnJvbSA6IHBhcnQudG8gLSAxLCBjaCk7CiAgICAgICAgICBpZiAoc3RpY2t5ID09ICJiZWZvcmUiKSB7IGNoID0gbW92ZUNoYXJMb2dpY2FsbHkobGluZU9iaiwgY2gsIDEpOyB9CiAgICAgICAgfSBlbHNlIHsgY2ggPSBkaXIgPCAwID8gcGFydC50byA6IHBhcnQuZnJvbTsgfQogICAgICAgIHJldHVybiBuZXcgUG9zKGxpbmVObywgY2gsIHN0aWNreSkKICAgICAgfQogICAgfQogICAgcmV0dXJuIG5ldyBQb3MobGluZU5vLCBkaXIgPCAwID8gbGluZU9iai50ZXh0Lmxlbmd0aCA6IDAsIGRpciA8IDAgPyAiYmVmb3JlIiA6ICJhZnRlciIpCiAgfQoKICBmdW5jdGlvbiBtb3ZlVmlzdWFsbHkoY20sIGxpbmUsIHN0YXJ0LCBkaXIpIHsKICAgIHZhciBiaWRpID0gZ2V0T3JkZXIobGluZSwgY20uZG9jLmRpcmVjdGlvbik7CiAgICBpZiAoIWJpZGkpIHsgcmV0dXJuIG1vdmVMb2dpY2FsbHkobGluZSwgc3RhcnQsIGRpcikgfQogICAgaWYgKHN0YXJ0LmNoID49IGxpbmUudGV4dC5sZW5ndGgpIHsKICAgICAgc3RhcnQuY2ggPSBsaW5lLnRleHQubGVuZ3RoOwogICAgICBzdGFydC5zdGlja3kgPSAiYmVmb3JlIjsKICAgIH0gZWxzZSBpZiAoc3RhcnQuY2ggPD0gMCkgewogICAgICBzdGFydC5jaCA9IDA7CiAgICAgIHN0YXJ0LnN0aWNreSA9ICJhZnRlciI7CiAgICB9CiAgICB2YXIgcGFydFBvcyA9IGdldEJpZGlQYXJ0QXQoYmlkaSwgc3RhcnQuY2gsIHN0YXJ0LnN0aWNreSksIHBhcnQgPSBiaWRpW3BhcnRQb3NdOwogICAgaWYgKGNtLmRvYy5kaXJlY3Rpb24gPT0gImx0ciIgJiYgcGFydC5sZXZlbCAlIDIgPT0gMCAmJiAoZGlyID4gMCA/IHBhcnQudG8gPiBzdGFydC5jaCA6IHBhcnQuZnJvbSA8IHN0YXJ0LmNoKSkgewogICAgICAvLyBDYXNlIDE6IFdlIG1vdmUgd2l0aGluIGFuIGx0ciBwYXJ0IGluIGFuIGx0ciBlZGl0b3IuIEV2ZW4gd2l0aCB3cmFwcGVkIGxpbmVzLAogICAgICAvLyBub3RoaW5nIGludGVyZXN0aW5nIGhhcHBlbnMuCiAgICAgIHJldHVybiBtb3ZlTG9naWNhbGx5KGxpbmUsIHN0YXJ0LCBkaXIpCiAgICB9CgogICAgdmFyIG12ID0gZnVuY3Rpb24gKHBvcywgZGlyKSB7IHJldHVybiBtb3ZlQ2hhckxvZ2ljYWxseShsaW5lLCBwb3MgaW5zdGFuY2VvZiBQb3MgPyBwb3MuY2ggOiBwb3MsIGRpcik7IH07CiAgICB2YXIgcHJlcDsKICAgIHZhciBnZXRXcmFwcGVkTGluZUV4dGVudCA9IGZ1bmN0aW9uIChjaCkgewogICAgICBpZiAoIWNtLm9wdGlvbnMubGluZVdyYXBwaW5nKSB7IHJldHVybiB7YmVnaW46IDAsIGVuZDogbGluZS50ZXh0Lmxlbmd0aH0gfQogICAgICBwcmVwID0gcHJlcCB8fCBwcmVwYXJlTWVhc3VyZUZvckxpbmUoY20sIGxpbmUpOwogICAgICByZXR1cm4gd3JhcHBlZExpbmVFeHRlbnRDaGFyKGNtLCBsaW5lLCBwcmVwLCBjaCkKICAgIH07CiAgICB2YXIgd3JhcHBlZExpbmVFeHRlbnQgPSBnZXRXcmFwcGVkTGluZUV4dGVudChzdGFydC5zdGlja3kgPT0gImJlZm9yZSIgPyBtdihzdGFydCwgLTEpIDogc3RhcnQuY2gpOwoKICAgIGlmIChjbS5kb2MuZGlyZWN0aW9uID09ICJydGwiIHx8IHBhcnQubGV2ZWwgPT0gMSkgewogICAgICB2YXIgbW92ZUluU3RvcmFnZU9yZGVyID0gKHBhcnQubGV2ZWwgPT0gMSkgPT0gKGRpciA8IDApOwogICAgICB2YXIgY2ggPSBtdihzdGFydCwgbW92ZUluU3RvcmFnZU9yZGVyID8gMSA6IC0xKTsKICAgICAgaWYgKGNoICE9IG51bGwgJiYgKCFtb3ZlSW5TdG9yYWdlT3JkZXIgPyBjaCA+PSBwYXJ0LmZyb20gJiYgY2ggPj0gd3JhcHBlZExpbmVFeHRlbnQuYmVnaW4gOiBjaCA8PSBwYXJ0LnRvICYmIGNoIDw9IHdyYXBwZWRMaW5lRXh0ZW50LmVuZCkpIHsKICAgICAgICAvLyBDYXNlIDI6IFdlIG1vdmUgd2l0aGluIGFuIHJ0bCBwYXJ0IG9yIGluIGFuIHJ0bCBlZGl0b3Igb24gdGhlIHNhbWUgdmlzdWFsIGxpbmUKICAgICAgICB2YXIgc3RpY2t5ID0gbW92ZUluU3RvcmFnZU9yZGVyID8gImJlZm9yZSIgOiAiYWZ0ZXIiOwogICAgICAgIHJldHVybiBuZXcgUG9zKHN0YXJ0LmxpbmUsIGNoLCBzdGlja3kpCiAgICAgIH0KICAgIH0KCiAgICAvLyBDYXNlIDM6IENvdWxkIG5vdCBtb3ZlIHdpdGhpbiB0aGlzIGJpZGkgcGFydCBpbiB0aGlzIHZpc3VhbCBsaW5lLCBzbyBsZWF2ZQogICAgLy8gdGhlIGN1cnJlbnQgYmlkaSBwYXJ0CgogICAgdmFyIHNlYXJjaEluVmlzdWFsTGluZSA9IGZ1bmN0aW9uIChwYXJ0UG9zLCBkaXIsIHdyYXBwZWRMaW5lRXh0ZW50KSB7CiAgICAgIHZhciBnZXRSZXMgPSBmdW5jdGlvbiAoY2gsIG1vdmVJblN0b3JhZ2VPcmRlcikgeyByZXR1cm4gbW92ZUluU3RvcmFnZU9yZGVyCiAgICAgICAgPyBuZXcgUG9zKHN0YXJ0LmxpbmUsIG12KGNoLCAxKSwgImJlZm9yZSIpCiAgICAgICAgOiBuZXcgUG9zKHN0YXJ0LmxpbmUsIGNoLCAiYWZ0ZXIiKTsgfTsKCiAgICAgIGZvciAoOyBwYXJ0UG9zID49IDAgJiYgcGFydFBvcyA8IGJpZGkubGVuZ3RoOyBwYXJ0UG9zICs9IGRpcikgewogICAgICAgIHZhciBwYXJ0ID0gYmlkaVtwYXJ0UG9zXTsKICAgICAgICB2YXIgbW92ZUluU3RvcmFnZU9yZGVyID0gKGRpciA+IDApID09IChwYXJ0LmxldmVsICE9IDEpOwogICAgICAgIHZhciBjaCA9IG1vdmVJblN0b3JhZ2VPcmRlciA/IHdyYXBwZWRMaW5lRXh0ZW50LmJlZ2luIDogbXYod3JhcHBlZExpbmVFeHRlbnQuZW5kLCAtMSk7CiAgICAgICAgaWYgKHBhcnQuZnJvbSA8PSBjaCAmJiBjaCA8IHBhcnQudG8pIHsgcmV0dXJuIGdldFJlcyhjaCwgbW92ZUluU3RvcmFnZU9yZGVyKSB9CiAgICAgICAgY2ggPSBtb3ZlSW5TdG9yYWdlT3JkZXIgPyBwYXJ0LmZyb20gOiBtdihwYXJ0LnRvLCAtMSk7CiAgICAgICAgaWYgKHdyYXBwZWRMaW5lRXh0ZW50LmJlZ2luIDw9IGNoICYmIGNoIDwgd3JhcHBlZExpbmVFeHRlbnQuZW5kKSB7IHJldHVybiBnZXRSZXMoY2gsIG1vdmVJblN0b3JhZ2VPcmRlcikgfQogICAgICB9CiAgICB9OwoKICAgIC8vIENhc2UgM2E6IExvb2sgZm9yIG90aGVyIGJpZGkgcGFydHMgb24gdGhlIHNhbWUgdmlzdWFsIGxpbmUKICAgIHZhciByZXMgPSBzZWFyY2hJblZpc3VhbExpbmUocGFydFBvcyArIGRpciwgZGlyLCB3cmFwcGVkTGluZUV4dGVudCk7CiAgICBpZiAocmVzKSB7IHJldHVybiByZXMgfQoKICAgIC8vIENhc2UgM2I6IExvb2sgZm9yIG90aGVyIGJpZGkgcGFydHMgb24gdGhlIG5leHQgdmlzdWFsIGxpbmUKICAgIHZhciBuZXh0Q2ggPSBkaXIgPiAwID8gd3JhcHBlZExpbmVFeHRlbnQuZW5kIDogbXYod3JhcHBlZExpbmVFeHRlbnQuYmVnaW4sIC0xKTsKICAgIGlmIChuZXh0Q2ggIT0gbnVsbCAmJiAhKGRpciA+IDAgJiYgbmV4dENoID09IGxpbmUudGV4dC5sZW5ndGgpKSB7CiAgICAgIHJlcyA9IHNlYXJjaEluVmlzdWFsTGluZShkaXIgPiAwID8gMCA6IGJpZGkubGVuZ3RoIC0gMSwgZGlyLCBnZXRXcmFwcGVkTGluZUV4dGVudChuZXh0Q2gpKTsKICAgICAgaWYgKHJlcykgeyByZXR1cm4gcmVzIH0KICAgIH0KCiAgICAvLyBDYXNlIDQ6IE5vd2hlcmUgdG8gbW92ZQogICAgcmV0dXJuIG51bGwKICB9CgogIC8vIENvbW1hbmRzIGFyZSBwYXJhbWV0ZXItbGVzcyBhY3Rpb25zIHRoYXQgY2FuIGJlIHBlcmZvcm1lZCBvbiBhbgogIC8vIGVkaXRvciwgbW9zdGx5IHVzZWQgZm9yIGtleWJpbmRpbmdzLgogIHZhciBjb21tYW5kcyA9IHsKICAgIHNlbGVjdEFsbDogc2VsZWN0QWxsLAogICAgc2luZ2xlU2VsZWN0aW9uOiBmdW5jdGlvbiAoY20pIHsgcmV0dXJuIGNtLnNldFNlbGVjdGlvbihjbS5nZXRDdXJzb3IoImFuY2hvciIpLCBjbS5nZXRDdXJzb3IoImhlYWQiKSwgc2VsX2RvbnRTY3JvbGwpOyB9LAogICAga2lsbExpbmU6IGZ1bmN0aW9uIChjbSkgeyByZXR1cm4gZGVsZXRlTmVhclNlbGVjdGlvbihjbSwgZnVuY3Rpb24gKHJhbmdlKSB7CiAgICAgIGlmIChyYW5nZS5lbXB0eSgpKSB7CiAgICAgICAgdmFyIGxlbiA9IGdldExpbmUoY20uZG9jLCByYW5nZS5oZWFkLmxpbmUpLnRleHQubGVuZ3RoOwogICAgICAgIGlmIChyYW5nZS5oZWFkLmNoID09IGxlbiAmJiByYW5nZS5oZWFkLmxpbmUgPCBjbS5sYXN0TGluZSgpKQogICAgICAgICAgeyByZXR1cm4ge2Zyb206IHJhbmdlLmhlYWQsIHRvOiBQb3MocmFuZ2UuaGVhZC5saW5lICsgMSwgMCl9IH0KICAgICAgICBlbHNlCiAgICAgICAgICB7IHJldHVybiB7ZnJvbTogcmFuZ2UuaGVhZCwgdG86IFBvcyhyYW5nZS5oZWFkLmxpbmUsIGxlbil9IH0KICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4ge2Zyb206IHJhbmdlLmZyb20oKSwgdG86IHJhbmdlLnRvKCl9CiAgICAgIH0KICAgIH0pOyB9LAogICAgZGVsZXRlTGluZTogZnVuY3Rpb24gKGNtKSB7IHJldHVybiBkZWxldGVOZWFyU2VsZWN0aW9uKGNtLCBmdW5jdGlvbiAocmFuZ2UpIHsgcmV0dXJuICh7CiAgICAgIGZyb206IFBvcyhyYW5nZS5mcm9tKCkubGluZSwgMCksCiAgICAgIHRvOiBjbGlwUG9zKGNtLmRvYywgUG9zKHJhbmdlLnRvKCkubGluZSArIDEsIDApKQogICAgfSk7IH0pOyB9LAogICAgZGVsTGluZUxlZnQ6IGZ1bmN0aW9uIChjbSkgeyByZXR1cm4gZGVsZXRlTmVhclNlbGVjdGlvbihjbSwgZnVuY3Rpb24gKHJhbmdlKSB7IHJldHVybiAoewogICAgICBmcm9tOiBQb3MocmFuZ2UuZnJvbSgpLmxpbmUsIDApLCB0bzogcmFuZ2UuZnJvbSgpCiAgICB9KTsgfSk7IH0sCiAgICBkZWxXcmFwcGVkTGluZUxlZnQ6IGZ1bmN0aW9uIChjbSkgeyByZXR1cm4gZGVsZXRlTmVhclNlbGVjdGlvbihjbSwgZnVuY3Rpb24gKHJhbmdlKSB7CiAgICAgIHZhciB0b3AgPSBjbS5jaGFyQ29vcmRzKHJhbmdlLmhlYWQsICJkaXYiKS50b3AgKyA1OwogICAgICB2YXIgbGVmdFBvcyA9IGNtLmNvb3Jkc0NoYXIoe2xlZnQ6IDAsIHRvcDogdG9wfSwgImRpdiIpOwogICAgICByZXR1cm4ge2Zyb206IGxlZnRQb3MsIHRvOiByYW5nZS5mcm9tKCl9CiAgICB9KTsgfSwKICAgIGRlbFdyYXBwZWRMaW5lUmlnaHQ6IGZ1bmN0aW9uIChjbSkgeyByZXR1cm4gZGVsZXRlTmVhclNlbGVjdGlvbihjbSwgZnVuY3Rpb24gKHJhbmdlKSB7CiAgICAgIHZhciB0b3AgPSBjbS5jaGFyQ29vcmRzKHJhbmdlLmhlYWQsICJkaXYiKS50b3AgKyA1OwogICAgICB2YXIgcmlnaHRQb3MgPSBjbS5jb29yZHNDaGFyKHtsZWZ0OiBjbS5kaXNwbGF5LmxpbmVEaXYub2Zmc2V0V2lkdGggKyAxMDAsIHRvcDogdG9wfSwgImRpdiIpOwogICAgICByZXR1cm4ge2Zyb206IHJhbmdlLmZyb20oKSwgdG86IHJpZ2h0UG9zIH0KICAgIH0pOyB9LAogICAgdW5kbzogZnVuY3Rpb24gKGNtKSB7IHJldHVybiBjbS51bmRvKCk7IH0sCiAgICByZWRvOiBmdW5jdGlvbiAoY20pIHsgcmV0dXJuIGNtLnJlZG8oKTsgfSwKICAgIHVuZG9TZWxlY3Rpb246IGZ1bmN0aW9uIChjbSkgeyByZXR1cm4gY20udW5kb1NlbGVjdGlvbigpOyB9LAogICAgcmVkb1NlbGVjdGlvbjogZnVuY3Rpb24gKGNtKSB7IHJldHVybiBjbS5yZWRvU2VsZWN0aW9uKCk7IH0sCiAgICBnb0RvY1N0YXJ0OiBmdW5jdGlvbiAoY20pIHsgcmV0dXJuIGNtLmV4dGVuZFNlbGVjdGlvbihQb3MoY20uZmlyc3RMaW5lKCksIDApKTsgfSwKICAgIGdvRG9jRW5kOiBmdW5jdGlvbiAoY20pIHsgcmV0dXJuIGNtLmV4dGVuZFNlbGVjdGlvbihQb3MoY20ubGFzdExpbmUoKSkpOyB9LAogICAgZ29MaW5lU3RhcnQ6IGZ1bmN0aW9uIChjbSkgeyByZXR1cm4gY20uZXh0ZW5kU2VsZWN0aW9uc0J5KGZ1bmN0aW9uIChyYW5nZSkgeyByZXR1cm4gbGluZVN0YXJ0KGNtLCByYW5nZS5oZWFkLmxpbmUpOyB9LAogICAgICB7b3JpZ2luOiAiK21vdmUiLCBiaWFzOiAxfQogICAgKTsgfSwKICAgIGdvTGluZVN0YXJ0U21hcnQ6IGZ1bmN0aW9uIChjbSkgeyByZXR1cm4gY20uZXh0ZW5kU2VsZWN0aW9uc0J5KGZ1bmN0aW9uIChyYW5nZSkgeyByZXR1cm4gbGluZVN0YXJ0U21hcnQoY20sIHJhbmdlLmhlYWQpOyB9LAogICAgICB7b3JpZ2luOiAiK21vdmUiLCBiaWFzOiAxfQogICAgKTsgfSwKICAgIGdvTGluZUVuZDogZnVuY3Rpb24gKGNtKSB7IHJldHVybiBjbS5leHRlbmRTZWxlY3Rpb25zQnkoZnVuY3Rpb24gKHJhbmdlKSB7IHJldHVybiBsaW5lRW5kKGNtLCByYW5nZS5oZWFkLmxpbmUpOyB9LAogICAgICB7b3JpZ2luOiAiK21vdmUiLCBiaWFzOiAtMX0KICAgICk7IH0sCiAgICBnb0xpbmVSaWdodDogZnVuY3Rpb24gKGNtKSB7IHJldHVybiBjbS5leHRlbmRTZWxlY3Rpb25zQnkoZnVuY3Rpb24gKHJhbmdlKSB7CiAgICAgIHZhciB0b3AgPSBjbS5jdXJzb3JDb29yZHMocmFuZ2UuaGVhZCwgImRpdiIpLnRvcCArIDU7CiAgICAgIHJldHVybiBjbS5jb29yZHNDaGFyKHtsZWZ0OiBjbS5kaXNwbGF5LmxpbmVEaXYub2Zmc2V0V2lkdGggKyAxMDAsIHRvcDogdG9wfSwgImRpdiIpCiAgICB9LCBzZWxfbW92ZSk7IH0sCiAgICBnb0xpbmVMZWZ0OiBmdW5jdGlvbiAoY20pIHsgcmV0dXJuIGNtLmV4dGVuZFNlbGVjdGlvbnNCeShmdW5jdGlvbiAocmFuZ2UpIHsKICAgICAgdmFyIHRvcCA9IGNtLmN1cnNvckNvb3JkcyhyYW5nZS5oZWFkLCAiZGl2IikudG9wICsgNTsKICAgICAgcmV0dXJuIGNtLmNvb3Jkc0NoYXIoe2xlZnQ6IDAsIHRvcDogdG9wfSwgImRpdiIpCiAgICB9LCBzZWxfbW92ZSk7IH0sCiAgICBnb0xpbmVMZWZ0U21hcnQ6IGZ1bmN0aW9uIChjbSkgeyByZXR1cm4gY20uZXh0ZW5kU2VsZWN0aW9uc0J5KGZ1bmN0aW9uIChyYW5nZSkgewogICAgICB2YXIgdG9wID0gY20uY3Vyc29yQ29vcmRzKHJhbmdlLmhlYWQsICJkaXYiKS50b3AgKyA1OwogICAgICB2YXIgcG9zID0gY20uY29vcmRzQ2hhcih7bGVmdDogMCwgdG9wOiB0b3B9LCAiZGl2Iik7CiAgICAgIGlmIChwb3MuY2ggPCBjbS5nZXRMaW5lKHBvcy5saW5lKS5zZWFyY2goL1xTLykpIHsgcmV0dXJuIGxpbmVTdGFydFNtYXJ0KGNtLCByYW5nZS5oZWFkKSB9CiAgICAgIHJldHVybiBwb3MKICAgIH0sIHNlbF9tb3ZlKTsgfSwKICAgIGdvTGluZVVwOiBmdW5jdGlvbiAoY20pIHsgcmV0dXJuIGNtLm1vdmVWKC0xLCAibGluZSIpOyB9LAogICAgZ29MaW5lRG93bjogZnVuY3Rpb24gKGNtKSB7IHJldHVybiBjbS5tb3ZlVigxLCAibGluZSIpOyB9LAogICAgZ29QYWdlVXA6IGZ1bmN0aW9uIChjbSkgeyByZXR1cm4gY20ubW92ZVYoLTEsICJwYWdlIik7IH0sCiAgICBnb1BhZ2VEb3duOiBmdW5jdGlvbiAoY20pIHsgcmV0dXJuIGNtLm1vdmVWKDEsICJwYWdlIik7IH0sCiAgICBnb0NoYXJMZWZ0OiBmdW5jdGlvbiAoY20pIHsgcmV0dXJuIGNtLm1vdmVIKC0xLCAiY2hhciIpOyB9LAogICAgZ29DaGFyUmlnaHQ6IGZ1bmN0aW9uIChjbSkgeyByZXR1cm4gY20ubW92ZUgoMSwgImNoYXIiKTsgfSwKICAgIGdvQ29sdW1uTGVmdDogZnVuY3Rpb24gKGNtKSB7IHJldHVybiBjbS5tb3ZlSCgtMSwgImNvbHVtbiIpOyB9LAogICAgZ29Db2x1bW5SaWdodDogZnVuY3Rpb24gKGNtKSB7IHJldHVybiBjbS5tb3ZlSCgxLCAiY29sdW1uIik7IH0sCiAgICBnb1dvcmRMZWZ0OiBmdW5jdGlvbiAoY20pIHsgcmV0dXJuIGNtLm1vdmVIKC0xLCAid29yZCIpOyB9LAogICAgZ29Hcm91cFJpZ2h0OiBmdW5jdGlvbiAoY20pIHsgcmV0dXJuIGNtLm1vdmVIKDEsICJncm91cCIpOyB9LAogICAgZ29Hcm91cExlZnQ6IGZ1bmN0aW9uIChjbSkgeyByZXR1cm4gY20ubW92ZUgoLTEsICJncm91cCIpOyB9LAogICAgZ29Xb3JkUmlnaHQ6IGZ1bmN0aW9uIChjbSkgeyByZXR1cm4gY20ubW92ZUgoMSwgIndvcmQiKTsgfSwKICAgIGRlbENoYXJCZWZvcmU6IGZ1bmN0aW9uIChjbSkgeyByZXR1cm4gY20uZGVsZXRlSCgtMSwgImNoYXIiKTsgfSwKICAgIGRlbENoYXJBZnRlcjogZnVuY3Rpb24gKGNtKSB7IHJldHVybiBjbS5kZWxldGVIKDEsICJjaGFyIik7IH0sCiAgICBkZWxXb3JkQmVmb3JlOiBmdW5jdGlvbiAoY20pIHsgcmV0dXJuIGNtLmRlbGV0ZUgoLTEsICJ3b3JkIik7IH0sCiAgICBkZWxXb3JkQWZ0ZXI6IGZ1bmN0aW9uIChjbSkgeyByZXR1cm4gY20uZGVsZXRlSCgxLCAid29yZCIpOyB9LAogICAgZGVsR3JvdXBCZWZvcmU6IGZ1bmN0aW9uIChjbSkgeyByZXR1cm4gY20uZGVsZXRlSCgtMSwgImdyb3VwIik7IH0sCiAgICBkZWxHcm91cEFmdGVyOiBmdW5jdGlvbiAoY20pIHsgcmV0dXJuIGNtLmRlbGV0ZUgoMSwgImdyb3VwIik7IH0sCiAgICBpbmRlbnRBdXRvOiBmdW5jdGlvbiAoY20pIHsgcmV0dXJuIGNtLmluZGVudFNlbGVjdGlvbigic21hcnQiKTsgfSwKICAgIGluZGVudE1vcmU6IGZ1bmN0aW9uIChjbSkgeyByZXR1cm4gY20uaW5kZW50U2VsZWN0aW9uKCJhZGQiKTsgfSwKICAgIGluZGVudExlc3M6IGZ1bmN0aW9uIChjbSkgeyByZXR1cm4gY20uaW5kZW50U2VsZWN0aW9uKCJzdWJ0cmFjdCIpOyB9LAogICAgaW5zZXJ0VGFiOiBmdW5jdGlvbiAoY20pIHsgcmV0dXJuIGNtLnJlcGxhY2VTZWxlY3Rpb24oIlx0Iik7IH0sCiAgICBpbnNlcnRTb2Z0VGFiOiBmdW5jdGlvbiAoY20pIHsKICAgICAgdmFyIHNwYWNlcyA9IFtdLCByYW5nZXMgPSBjbS5saXN0U2VsZWN0aW9ucygpLCB0YWJTaXplID0gY20ub3B0aW9ucy50YWJTaXplOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJhbmdlcy5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciBwb3MgPSByYW5nZXNbaV0uZnJvbSgpOwogICAgICAgIHZhciBjb2wgPSBjb3VudENvbHVtbihjbS5nZXRMaW5lKHBvcy5saW5lKSwgcG9zLmNoLCB0YWJTaXplKTsKICAgICAgICBzcGFjZXMucHVzaChzcGFjZVN0cih0YWJTaXplIC0gY29sICUgdGFiU2l6ZSkpOwogICAgICB9CiAgICAgIGNtLnJlcGxhY2VTZWxlY3Rpb25zKHNwYWNlcyk7CiAgICB9LAogICAgZGVmYXVsdFRhYjogZnVuY3Rpb24gKGNtKSB7CiAgICAgIGlmIChjbS5zb21ldGhpbmdTZWxlY3RlZCgpKSB7IGNtLmluZGVudFNlbGVjdGlvbigiYWRkIik7IH0KICAgICAgZWxzZSB7IGNtLmV4ZWNDb21tYW5kKCJpbnNlcnRUYWIiKTsgfQogICAgfSwKICAgIC8vIFN3YXAgdGhlIHR3byBjaGFycyBsZWZ0IGFuZCByaWdodCBvZiBlYWNoIHNlbGVjdGlvbidzIGhlYWQuCiAgICAvLyBNb3ZlIGN1cnNvciBiZWhpbmQgdGhlIHR3byBzd2FwcGVkIGNoYXJhY3RlcnMgYWZ0ZXJ3YXJkcy4KICAgIC8vCiAgICAvLyBEb2Vzbid0IGNvbnNpZGVyIGxpbmUgZmVlZHMgYSBjaGFyYWN0ZXIuCiAgICAvLyBEb2Vzbid0IHNjYW4gbW9yZSB0aGFuIG9uZSBsaW5lIGFib3ZlIHRvIGZpbmQgYSBjaGFyYWN0ZXIuCiAgICAvLyBEb2Vzbid0IGRvIGFueXRoaW5nIG9uIGFuIGVtcHR5IGxpbmUuCiAgICAvLyBEb2Vzbid0IGRvIGFueXRoaW5nIHdpdGggbm9uLWVtcHR5IHNlbGVjdGlvbnMuCiAgICB0cmFuc3Bvc2VDaGFyczogZnVuY3Rpb24gKGNtKSB7IHJldHVybiBydW5Jbk9wKGNtLCBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciByYW5nZXMgPSBjbS5saXN0U2VsZWN0aW9ucygpLCBuZXdTZWwgPSBbXTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByYW5nZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAoIXJhbmdlc1tpXS5lbXB0eSgpKSB7IGNvbnRpbnVlIH0KICAgICAgICB2YXIgY3VyID0gcmFuZ2VzW2ldLmhlYWQsIGxpbmUgPSBnZXRMaW5lKGNtLmRvYywgY3VyLmxpbmUpLnRleHQ7CiAgICAgICAgaWYgKGxpbmUpIHsKICAgICAgICAgIGlmIChjdXIuY2ggPT0gbGluZS5sZW5ndGgpIHsgY3VyID0gbmV3IFBvcyhjdXIubGluZSwgY3VyLmNoIC0gMSk7IH0KICAgICAgICAgIGlmIChjdXIuY2ggPiAwKSB7CiAgICAgICAgICAgIGN1ciA9IG5ldyBQb3MoY3VyLmxpbmUsIGN1ci5jaCArIDEpOwogICAgICAgICAgICBjbS5yZXBsYWNlUmFuZ2UobGluZS5jaGFyQXQoY3VyLmNoIC0gMSkgKyBsaW5lLmNoYXJBdChjdXIuY2ggLSAyKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIFBvcyhjdXIubGluZSwgY3VyLmNoIC0gMiksIGN1ciwgIit0cmFuc3Bvc2UiKTsKICAgICAgICAgIH0gZWxzZSBpZiAoY3VyLmxpbmUgPiBjbS5kb2MuZmlyc3QpIHsKICAgICAgICAgICAgdmFyIHByZXYgPSBnZXRMaW5lKGNtLmRvYywgY3VyLmxpbmUgLSAxKS50ZXh0OwogICAgICAgICAgICBpZiAocHJldikgewogICAgICAgICAgICAgIGN1ciA9IG5ldyBQb3MoY3VyLmxpbmUsIDEpOwogICAgICAgICAgICAgIGNtLnJlcGxhY2VSYW5nZShsaW5lLmNoYXJBdCgwKSArIGNtLmRvYy5saW5lU2VwYXJhdG9yKCkgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmV2LmNoYXJBdChwcmV2Lmxlbmd0aCAtIDEpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBQb3MoY3VyLmxpbmUgLSAxLCBwcmV2Lmxlbmd0aCAtIDEpLCBjdXIsICIrdHJhbnNwb3NlIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgbmV3U2VsLnB1c2gobmV3IFJhbmdlKGN1ciwgY3VyKSk7CiAgICAgIH0KICAgICAgY20uc2V0U2VsZWN0aW9ucyhuZXdTZWwpOwogICAgfSk7IH0sCiAgICBuZXdsaW5lQW5kSW5kZW50OiBmdW5jdGlvbiAoY20pIHsgcmV0dXJuIHJ1bkluT3AoY20sIGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIHNlbHMgPSBjbS5saXN0U2VsZWN0aW9ucygpOwogICAgICBmb3IgKHZhciBpID0gc2Vscy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkKICAgICAgICB7IGNtLnJlcGxhY2VSYW5nZShjbS5kb2MubGluZVNlcGFyYXRvcigpLCBzZWxzW2ldLmFuY2hvciwgc2Vsc1tpXS5oZWFkLCAiK2lucHV0Iik7IH0KICAgICAgc2VscyA9IGNtLmxpc3RTZWxlY3Rpb25zKCk7CiAgICAgIGZvciAodmFyIGkkMSA9IDA7IGkkMSA8IHNlbHMubGVuZ3RoOyBpJDErKykKICAgICAgICB7IGNtLmluZGVudExpbmUoc2Vsc1tpJDFdLmZyb20oKS5saW5lLCBudWxsLCB0cnVlKTsgfQogICAgICBlbnN1cmVDdXJzb3JWaXNpYmxlKGNtKTsKICAgIH0pOyB9LAogICAgb3BlbkxpbmU6IGZ1bmN0aW9uIChjbSkgeyByZXR1cm4gY20ucmVwbGFjZVNlbGVjdGlvbigiXG4iLCAic3RhcnQiKTsgfSwKICAgIHRvZ2dsZU92ZXJ3cml0ZTogZnVuY3Rpb24gKGNtKSB7IHJldHVybiBjbS50b2dnbGVPdmVyd3JpdGUoKTsgfQogIH07CgoKICBmdW5jdGlvbiBsaW5lU3RhcnQoY20sIGxpbmVOKSB7CiAgICB2YXIgbGluZSA9IGdldExpbmUoY20uZG9jLCBsaW5lTik7CiAgICB2YXIgdmlzdWFsID0gdmlzdWFsTGluZShsaW5lKTsKICAgIGlmICh2aXN1YWwgIT0gbGluZSkgeyBsaW5lTiA9IGxpbmVObyh2aXN1YWwpOyB9CiAgICByZXR1cm4gZW5kT2ZMaW5lKHRydWUsIGNtLCB2aXN1YWwsIGxpbmVOLCAxKQogIH0KICBmdW5jdGlvbiBsaW5lRW5kKGNtLCBsaW5lTikgewogICAgdmFyIGxpbmUgPSBnZXRMaW5lKGNtLmRvYywgbGluZU4pOwogICAgdmFyIHZpc3VhbCA9IHZpc3VhbExpbmVFbmQobGluZSk7CiAgICBpZiAodmlzdWFsICE9IGxpbmUpIHsgbGluZU4gPSBsaW5lTm8odmlzdWFsKTsgfQogICAgcmV0dXJuIGVuZE9mTGluZSh0cnVlLCBjbSwgbGluZSwgbGluZU4sIC0xKQogIH0KICBmdW5jdGlvbiBsaW5lU3RhcnRTbWFydChjbSwgcG9zKSB7CiAgICB2YXIgc3RhcnQgPSBsaW5lU3RhcnQoY20sIHBvcy5saW5lKTsKICAgIHZhciBsaW5lID0gZ2V0TGluZShjbS5kb2MsIHN0YXJ0LmxpbmUpOwogICAgdmFyIG9yZGVyID0gZ2V0T3JkZXIobGluZSwgY20uZG9jLmRpcmVjdGlvbik7CiAgICBpZiAoIW9yZGVyIHx8IG9yZGVyWzBdLmxldmVsID09IDApIHsKICAgICAgdmFyIGZpcnN0Tm9uV1MgPSBNYXRoLm1heCgwLCBsaW5lLnRleHQuc2VhcmNoKC9cUy8pKTsKICAgICAgdmFyIGluV1MgPSBwb3MubGluZSA9PSBzdGFydC5saW5lICYmIHBvcy5jaCA8PSBmaXJzdE5vbldTICYmIHBvcy5jaDsKICAgICAgcmV0dXJuIFBvcyhzdGFydC5saW5lLCBpbldTID8gMCA6IGZpcnN0Tm9uV1MsIHN0YXJ0LnN0aWNreSkKICAgIH0KICAgIHJldHVybiBzdGFydAogIH0KCiAgLy8gUnVuIGEgaGFuZGxlciB0aGF0IHdhcyBib3VuZCB0byBhIGtleS4KICBmdW5jdGlvbiBkb0hhbmRsZUJpbmRpbmcoY20sIGJvdW5kLCBkcm9wU2hpZnQpIHsKICAgIGlmICh0eXBlb2YgYm91bmQgPT0gInN0cmluZyIpIHsKICAgICAgYm91bmQgPSBjb21tYW5kc1tib3VuZF07CiAgICAgIGlmICghYm91bmQpIHsgcmV0dXJuIGZhbHNlIH0KICAgIH0KICAgIC8vIEVuc3VyZSBwcmV2aW91cyBpbnB1dCBoYXMgYmVlbiByZWFkLCBzbyB0aGF0IHRoZSBoYW5kbGVyIHNlZXMgYQogICAgLy8gY29uc2lzdGVudCB2aWV3IG9mIHRoZSBkb2N1bWVudAogICAgY20uZGlzcGxheS5pbnB1dC5lbnN1cmVQb2xsZWQoKTsKICAgIHZhciBwcmV2U2hpZnQgPSBjbS5kaXNwbGF5LnNoaWZ0LCBkb25lID0gZmFsc2U7CiAgICB0cnkgewogICAgICBpZiAoY20uaXNSZWFkT25seSgpKSB7IGNtLnN0YXRlLnN1cHByZXNzRWRpdHMgPSB0cnVlOyB9CiAgICAgIGlmIChkcm9wU2hpZnQpIHsgY20uZGlzcGxheS5zaGlmdCA9IGZhbHNlOyB9CiAgICAgIGRvbmUgPSBib3VuZChjbSkgIT0gUGFzczsKICAgIH0gZmluYWxseSB7CiAgICAgIGNtLmRpc3BsYXkuc2hpZnQgPSBwcmV2U2hpZnQ7CiAgICAgIGNtLnN0YXRlLnN1cHByZXNzRWRpdHMgPSBmYWxzZTsKICAgIH0KICAgIHJldHVybiBkb25lCiAgfQoKICBmdW5jdGlvbiBsb29rdXBLZXlGb3JFZGl0b3IoY20sIG5hbWUsIGhhbmRsZSkgewogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjbS5zdGF0ZS5rZXlNYXBzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciByZXN1bHQgPSBsb29rdXBLZXkobmFtZSwgY20uc3RhdGUua2V5TWFwc1tpXSwgaGFuZGxlLCBjbSk7CiAgICAgIGlmIChyZXN1bHQpIHsgcmV0dXJuIHJlc3VsdCB9CiAgICB9CiAgICByZXR1cm4gKGNtLm9wdGlvbnMuZXh0cmFLZXlzICYmIGxvb2t1cEtleShuYW1lLCBjbS5vcHRpb25zLmV4dHJhS2V5cywgaGFuZGxlLCBjbSkpCiAgICAgIHx8IGxvb2t1cEtleShuYW1lLCBjbS5vcHRpb25zLmtleU1hcCwgaGFuZGxlLCBjbSkKICB9CgogIC8vIE5vdGUgdGhhdCwgZGVzcGl0ZSB0aGUgbmFtZSwgdGhpcyBmdW5jdGlvbiBpcyBhbHNvIHVzZWQgdG8gY2hlY2sKICAvLyBmb3IgYm91bmQgbW91c2UgY2xpY2tzLgoKICB2YXIgc3RvcFNlcSA9IG5ldyBEZWxheWVkOwoKICBmdW5jdGlvbiBkaXNwYXRjaEtleShjbSwgbmFtZSwgZSwgaGFuZGxlKSB7CiAgICB2YXIgc2VxID0gY20uc3RhdGUua2V5U2VxOwogICAgaWYgKHNlcSkgewogICAgICBpZiAoaXNNb2RpZmllcktleShuYW1lKSkgeyByZXR1cm4gImhhbmRsZWQiIH0KICAgICAgaWYgKC9cJyQvLnRlc3QobmFtZSkpCiAgICAgICAgeyBjbS5zdGF0ZS5rZXlTZXEgPSBudWxsOyB9CiAgICAgIGVsc2UKICAgICAgICB7IHN0b3BTZXEuc2V0KDUwLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpZiAoY20uc3RhdGUua2V5U2VxID09IHNlcSkgewogICAgICAgICAgICBjbS5zdGF0ZS5rZXlTZXEgPSBudWxsOwogICAgICAgICAgICBjbS5kaXNwbGF5LmlucHV0LnJlc2V0KCk7CiAgICAgICAgICB9CiAgICAgICAgfSk7IH0KICAgICAgaWYgKGRpc3BhdGNoS2V5SW5uZXIoY20sIHNlcSArICIgIiArIG5hbWUsIGUsIGhhbmRsZSkpIHsgcmV0dXJuIHRydWUgfQogICAgfQogICAgcmV0dXJuIGRpc3BhdGNoS2V5SW5uZXIoY20sIG5hbWUsIGUsIGhhbmRsZSkKICB9CgogIGZ1bmN0aW9uIGRpc3BhdGNoS2V5SW5uZXIoY20sIG5hbWUsIGUsIGhhbmRsZSkgewogICAgdmFyIHJlc3VsdCA9IGxvb2t1cEtleUZvckVkaXRvcihjbSwgbmFtZSwgaGFuZGxlKTsKCiAgICBpZiAocmVzdWx0ID09ICJtdWx0aSIpCiAgICAgIHsgY20uc3RhdGUua2V5U2VxID0gbmFtZTsgfQogICAgaWYgKHJlc3VsdCA9PSAiaGFuZGxlZCIpCiAgICAgIHsgc2lnbmFsTGF0ZXIoY20sICJrZXlIYW5kbGVkIiwgY20sIG5hbWUsIGUpOyB9CgogICAgaWYgKHJlc3VsdCA9PSAiaGFuZGxlZCIgfHwgcmVzdWx0ID09ICJtdWx0aSIpIHsKICAgICAgZV9wcmV2ZW50RGVmYXVsdChlKTsKICAgICAgcmVzdGFydEJsaW5rKGNtKTsKICAgIH0KCiAgICByZXR1cm4gISFyZXN1bHQKICB9CgogIC8vIEhhbmRsZSBhIGtleSBmcm9tIHRoZSBrZXlkb3duIGV2ZW50LgogIGZ1bmN0aW9uIGhhbmRsZUtleUJpbmRpbmcoY20sIGUpIHsKICAgIHZhciBuYW1lID0ga2V5TmFtZShlLCB0cnVlKTsKICAgIGlmICghbmFtZSkgeyByZXR1cm4gZmFsc2UgfQoKICAgIGlmIChlLnNoaWZ0S2V5ICYmICFjbS5zdGF0ZS5rZXlTZXEpIHsKICAgICAgLy8gRmlyc3QgdHJ5IHRvIHJlc29sdmUgZnVsbCBuYW1lIChpbmNsdWRpbmcgJ1NoaWZ0LScpLiBGYWlsaW5nCiAgICAgIC8vIHRoYXQsIHNlZSBpZiB0aGVyZSBpcyBhIGN1cnNvci1tb3Rpb24gY29tbWFuZCAoc3RhcnRpbmcgd2l0aAogICAgICAvLyAnZ28nKSBib3VuZCB0byB0aGUga2V5bmFtZSB3aXRob3V0ICdTaGlmdC0nLgogICAgICByZXR1cm4gZGlzcGF0Y2hLZXkoY20sICJTaGlmdC0iICsgbmFtZSwgZSwgZnVuY3Rpb24gKGIpIHsgcmV0dXJuIGRvSGFuZGxlQmluZGluZyhjbSwgYiwgdHJ1ZSk7IH0pCiAgICAgICAgICB8fCBkaXNwYXRjaEtleShjbSwgbmFtZSwgZSwgZnVuY3Rpb24gKGIpIHsKICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBiID09ICJzdHJpbmciID8gL15nb1tBLVpdLy50ZXN0KGIpIDogYi5tb3Rpb24pCiAgICAgICAgICAgICAgICAgeyByZXR1cm4gZG9IYW5kbGVCaW5kaW5nKGNtLCBiKSB9CiAgICAgICAgICAgICB9KQogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGRpc3BhdGNoS2V5KGNtLCBuYW1lLCBlLCBmdW5jdGlvbiAoYikgeyByZXR1cm4gZG9IYW5kbGVCaW5kaW5nKGNtLCBiKTsgfSkKICAgIH0KICB9CgogIC8vIEhhbmRsZSBhIGtleSBmcm9tIHRoZSBrZXlwcmVzcyBldmVudAogIGZ1bmN0aW9uIGhhbmRsZUNoYXJCaW5kaW5nKGNtLCBlLCBjaCkgewogICAgcmV0dXJuIGRpc3BhdGNoS2V5KGNtLCAiJyIgKyBjaCArICInIiwgZSwgZnVuY3Rpb24gKGIpIHsgcmV0dXJuIGRvSGFuZGxlQmluZGluZyhjbSwgYiwgdHJ1ZSk7IH0pCiAgfQoKICB2YXIgbGFzdFN0b3BwZWRLZXkgPSBudWxsOwogIGZ1bmN0aW9uIG9uS2V5RG93bihlKSB7CiAgICB2YXIgY20gPSB0aGlzOwogICAgY20uY3VyT3AuZm9jdXMgPSBhY3RpdmVFbHQoKTsKICAgIGlmIChzaWduYWxET01FdmVudChjbSwgZSkpIHsgcmV0dXJuIH0KICAgIC8vIElFIGRvZXMgc3RyYW5nZSB0aGluZ3Mgd2l0aCBlc2NhcGUuCiAgICBpZiAoaWUgJiYgaWVfdmVyc2lvbiA8IDExICYmIGUua2V5Q29kZSA9PSAyNykgeyBlLnJldHVyblZhbHVlID0gZmFsc2U7IH0KICAgIHZhciBjb2RlID0gZS5rZXlDb2RlOwogICAgY20uZGlzcGxheS5zaGlmdCA9IGNvZGUgPT0gMTYgfHwgZS5zaGlmdEtleTsKICAgIHZhciBoYW5kbGVkID0gaGFuZGxlS2V5QmluZGluZyhjbSwgZSk7CiAgICBpZiAocHJlc3RvKSB7CiAgICAgIGxhc3RTdG9wcGVkS2V5ID0gaGFuZGxlZCA/IGNvZGUgOiBudWxsOwogICAgICAvLyBPcGVyYSBoYXMgbm8gY3V0IGV2ZW50Li4uIHdlIHRyeSB0byBhdCBsZWFzdCBjYXRjaCB0aGUga2V5IGNvbWJvCiAgICAgIGlmICghaGFuZGxlZCAmJiBjb2RlID09IDg4ICYmICFoYXNDb3B5RXZlbnQgJiYgKG1hYyA/IGUubWV0YUtleSA6IGUuY3RybEtleSkpCiAgICAgICAgeyBjbS5yZXBsYWNlU2VsZWN0aW9uKCIiLCBudWxsLCAiY3V0Iik7IH0KICAgIH0KCiAgICAvLyBUdXJuIG1vdXNlIGludG8gY3Jvc3NoYWlyIHdoZW4gQWx0IGlzIGhlbGQgb24gTWFjLgogICAgaWYgKGNvZGUgPT0gMTggJiYgIS9cYkNvZGVNaXJyb3ItY3Jvc3NoYWlyXGIvLnRlc3QoY20uZGlzcGxheS5saW5lRGl2LmNsYXNzTmFtZSkpCiAgICAgIHsgc2hvd0Nyb3NzSGFpcihjbSk7IH0KICB9CgogIGZ1bmN0aW9uIHNob3dDcm9zc0hhaXIoY20pIHsKICAgIHZhciBsaW5lRGl2ID0gY20uZGlzcGxheS5saW5lRGl2OwogICAgYWRkQ2xhc3MobGluZURpdiwgIkNvZGVNaXJyb3ItY3Jvc3NoYWlyIik7CgogICAgZnVuY3Rpb24gdXAoZSkgewogICAgICBpZiAoZS5rZXlDb2RlID09IDE4IHx8ICFlLmFsdEtleSkgewogICAgICAgIHJtQ2xhc3MobGluZURpdiwgIkNvZGVNaXJyb3ItY3Jvc3NoYWlyIik7CiAgICAgICAgb2ZmKGRvY3VtZW50LCAia2V5dXAiLCB1cCk7CiAgICAgICAgb2ZmKGRvY3VtZW50LCAibW91c2VvdmVyIiwgdXApOwogICAgICB9CiAgICB9CiAgICBvbihkb2N1bWVudCwgImtleXVwIiwgdXApOwogICAgb24oZG9jdW1lbnQsICJtb3VzZW92ZXIiLCB1cCk7CiAgfQoKICBmdW5jdGlvbiBvbktleVVwKGUpIHsKICAgIGlmIChlLmtleUNvZGUgPT0gMTYpIHsgdGhpcy5kb2Muc2VsLnNoaWZ0ID0gZmFsc2U7IH0KICAgIHNpZ25hbERPTUV2ZW50KHRoaXMsIGUpOwogIH0KCiAgZnVuY3Rpb24gb25LZXlQcmVzcyhlKSB7CiAgICB2YXIgY20gPSB0aGlzOwogICAgaWYgKGV2ZW50SW5XaWRnZXQoY20uZGlzcGxheSwgZSkgfHwgc2lnbmFsRE9NRXZlbnQoY20sIGUpIHx8IGUuY3RybEtleSAmJiAhZS5hbHRLZXkgfHwgbWFjICYmIGUubWV0YUtleSkgeyByZXR1cm4gfQogICAgdmFyIGtleUNvZGUgPSBlLmtleUNvZGUsIGNoYXJDb2RlID0gZS5jaGFyQ29kZTsKICAgIGlmIChwcmVzdG8gJiYga2V5Q29kZSA9PSBsYXN0U3RvcHBlZEtleSkge2xhc3RTdG9wcGVkS2V5ID0gbnVsbDsgZV9wcmV2ZW50RGVmYXVsdChlKTsgcmV0dXJufQogICAgaWYgKChwcmVzdG8gJiYgKCFlLndoaWNoIHx8IGUud2hpY2ggPCAxMCkpICYmIGhhbmRsZUtleUJpbmRpbmcoY20sIGUpKSB7IHJldHVybiB9CiAgICB2YXIgY2ggPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGNoYXJDb2RlID09IG51bGwgPyBrZXlDb2RlIDogY2hhckNvZGUpOwogICAgLy8gU29tZSBicm93c2VycyBmaXJlIGtleXByZXNzIGV2ZW50cyBmb3IgYmFja3NwYWNlCiAgICBpZiAoY2ggPT0gIlx4MDgiKSB7IHJldHVybiB9CiAgICBpZiAoaGFuZGxlQ2hhckJpbmRpbmcoY20sIGUsIGNoKSkgeyByZXR1cm4gfQogICAgY20uZGlzcGxheS5pbnB1dC5vbktleVByZXNzKGUpOwogIH0KCiAgdmFyIERPVUJMRUNMSUNLX0RFTEFZID0gNDAwOwoKICB2YXIgUGFzdENsaWNrID0gZnVuY3Rpb24odGltZSwgcG9zLCBidXR0b24pIHsKICAgIHRoaXMudGltZSA9IHRpbWU7CiAgICB0aGlzLnBvcyA9IHBvczsKICAgIHRoaXMuYnV0dG9uID0gYnV0dG9uOwogIH07CgogIFBhc3RDbGljay5wcm90b3R5cGUuY29tcGFyZSA9IGZ1bmN0aW9uICh0aW1lLCBwb3MsIGJ1dHRvbikgewogICAgcmV0dXJuIHRoaXMudGltZSArIERPVUJMRUNMSUNLX0RFTEFZID4gdGltZSAmJgogICAgICBjbXAocG9zLCB0aGlzLnBvcykgPT0gMCAmJiBidXR0b24gPT0gdGhpcy5idXR0b24KICB9OwoKICB2YXIgbGFzdENsaWNrLCBsYXN0RG91YmxlQ2xpY2s7CiAgZnVuY3Rpb24gY2xpY2tSZXBlYXQocG9zLCBidXR0b24pIHsKICAgIHZhciBub3cgPSArbmV3IERhdGU7CiAgICBpZiAobGFzdERvdWJsZUNsaWNrICYmIGxhc3REb3VibGVDbGljay5jb21wYXJlKG5vdywgcG9zLCBidXR0b24pKSB7CiAgICAgIGxhc3RDbGljayA9IGxhc3REb3VibGVDbGljayA9IG51bGw7CiAgICAgIHJldHVybiAidHJpcGxlIgogICAgfSBlbHNlIGlmIChsYXN0Q2xpY2sgJiYgbGFzdENsaWNrLmNvbXBhcmUobm93LCBwb3MsIGJ1dHRvbikpIHsKICAgICAgbGFzdERvdWJsZUNsaWNrID0gbmV3IFBhc3RDbGljayhub3csIHBvcywgYnV0dG9uKTsKICAgICAgbGFzdENsaWNrID0gbnVsbDsKICAgICAgcmV0dXJuICJkb3VibGUiCiAgICB9IGVsc2UgewogICAgICBsYXN0Q2xpY2sgPSBuZXcgUGFzdENsaWNrKG5vdywgcG9zLCBidXR0b24pOwogICAgICBsYXN0RG91YmxlQ2xpY2sgPSBudWxsOwogICAgICByZXR1cm4gInNpbmdsZSIKICAgIH0KICB9CgogIC8vIEEgbW91c2UgZG93biBjYW4gYmUgYSBzaW5nbGUgY2xpY2ssIGRvdWJsZSBjbGljaywgdHJpcGxlIGNsaWNrLAogIC8vIHN0YXJ0IG9mIHNlbGVjdGlvbiBkcmFnLCBzdGFydCBvZiB0ZXh0IGRyYWcsIG5ldyBjdXJzb3IKICAvLyAoY3RybC1jbGljayksIHJlY3RhbmdsZSBkcmFnIChhbHQtZHJhZyksIG9yIHh3aW4KICAvLyBtaWRkbGUtY2xpY2stcGFzdGUuIE9yIGl0IG1pZ2h0IGJlIGEgY2xpY2sgb24gc29tZXRoaW5nIHdlIHNob3VsZAogIC8vIG5vdCBpbnRlcmZlcmUgd2l0aCwgc3VjaCBhcyBhIHNjcm9sbGJhciBvciB3aWRnZXQuCiAgZnVuY3Rpb24gb25Nb3VzZURvd24oZSkgewogICAgdmFyIGNtID0gdGhpcywgZGlzcGxheSA9IGNtLmRpc3BsYXk7CiAgICBpZiAoc2lnbmFsRE9NRXZlbnQoY20sIGUpIHx8IGRpc3BsYXkuYWN0aXZlVG91Y2ggJiYgZGlzcGxheS5pbnB1dC5zdXBwb3J0c1RvdWNoKCkpIHsgcmV0dXJuIH0KICAgIGRpc3BsYXkuaW5wdXQuZW5zdXJlUG9sbGVkKCk7CiAgICBkaXNwbGF5LnNoaWZ0ID0gZS5zaGlmdEtleTsKCiAgICBpZiAoZXZlbnRJbldpZGdldChkaXNwbGF5LCBlKSkgewogICAgICBpZiAoIXdlYmtpdCkgewogICAgICAgIC8vIEJyaWVmbHkgdHVybiBvZmYgZHJhZ2dhYmlsaXR5LCB0byBhbGxvdyB3aWRnZXRzIHRvIGRvCiAgICAgICAgLy8gbm9ybWFsIGRyYWdnaW5nIHRoaW5ncy4KICAgICAgICBkaXNwbGF5LnNjcm9sbGVyLmRyYWdnYWJsZSA9IGZhbHNlOwogICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgeyByZXR1cm4gZGlzcGxheS5zY3JvbGxlci5kcmFnZ2FibGUgPSB0cnVlOyB9LCAxMDApOwogICAgICB9CiAgICAgIHJldHVybgogICAgfQogICAgaWYgKGNsaWNrSW5HdXR0ZXIoY20sIGUpKSB7IHJldHVybiB9CiAgICB2YXIgcG9zID0gcG9zRnJvbU1vdXNlKGNtLCBlKSwgYnV0dG9uID0gZV9idXR0b24oZSksIHJlcGVhdCA9IHBvcyA/IGNsaWNrUmVwZWF0KHBvcywgYnV0dG9uKSA6ICJzaW5nbGUiOwogICAgd2luZG93LmZvY3VzKCk7CgogICAgLy8gIzMyNjE6IG1ha2Ugc3VyZSwgdGhhdCB3ZSdyZSBub3Qgc3RhcnRpbmcgYSBzZWNvbmQgc2VsZWN0aW9uCiAgICBpZiAoYnV0dG9uID09IDEgJiYgY20uc3RhdGUuc2VsZWN0aW5nVGV4dCkKICAgICAgeyBjbS5zdGF0ZS5zZWxlY3RpbmdUZXh0KGUpOyB9CgogICAgaWYgKHBvcyAmJiBoYW5kbGVNYXBwZWRCdXR0b24oY20sIGJ1dHRvbiwgcG9zLCByZXBlYXQsIGUpKSB7IHJldHVybiB9CgogICAgaWYgKGJ1dHRvbiA9PSAxKSB7CiAgICAgIGlmIChwb3MpIHsgbGVmdEJ1dHRvbkRvd24oY20sIHBvcywgcmVwZWF0LCBlKTsgfQogICAgICBlbHNlIGlmIChlX3RhcmdldChlKSA9PSBkaXNwbGF5LnNjcm9sbGVyKSB7IGVfcHJldmVudERlZmF1bHQoZSk7IH0KICAgIH0gZWxzZSBpZiAoYnV0dG9uID09IDIpIHsKICAgICAgaWYgKHBvcykgeyBleHRlbmRTZWxlY3Rpb24oY20uZG9jLCBwb3MpOyB9CiAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgeyByZXR1cm4gZGlzcGxheS5pbnB1dC5mb2N1cygpOyB9LCAyMCk7CiAgICB9IGVsc2UgaWYgKGJ1dHRvbiA9PSAzKSB7CiAgICAgIGlmIChjYXB0dXJlUmlnaHRDbGljaykgeyBjbS5kaXNwbGF5LmlucHV0Lm9uQ29udGV4dE1lbnUoZSk7IH0KICAgICAgZWxzZSB7IGRlbGF5Qmx1ckV2ZW50KGNtKTsgfQogICAgfQogIH0KCiAgZnVuY3Rpb24gaGFuZGxlTWFwcGVkQnV0dG9uKGNtLCBidXR0b24sIHBvcywgcmVwZWF0LCBldmVudCkgewogICAgdmFyIG5hbWUgPSAiQ2xpY2siOwogICAgaWYgKHJlcGVhdCA9PSAiZG91YmxlIikgeyBuYW1lID0gIkRvdWJsZSIgKyBuYW1lOyB9CiAgICBlbHNlIGlmIChyZXBlYXQgPT0gInRyaXBsZSIpIHsgbmFtZSA9ICJUcmlwbGUiICsgbmFtZTsgfQogICAgbmFtZSA9IChidXR0b24gPT0gMSA/ICJMZWZ0IiA6IGJ1dHRvbiA9PSAyID8gIk1pZGRsZSIgOiAiUmlnaHQiKSArIG5hbWU7CgogICAgcmV0dXJuIGRpc3BhdGNoS2V5KGNtLCAgYWRkTW9kaWZpZXJOYW1lcyhuYW1lLCBldmVudCksIGV2ZW50LCBmdW5jdGlvbiAoYm91bmQpIHsKICAgICAgaWYgKHR5cGVvZiBib3VuZCA9PSAic3RyaW5nIikgeyBib3VuZCA9IGNvbW1hbmRzW2JvdW5kXTsgfQogICAgICBpZiAoIWJvdW5kKSB7IHJldHVybiBmYWxzZSB9CiAgICAgIHZhciBkb25lID0gZmFsc2U7CiAgICAgIHRyeSB7CiAgICAgICAgaWYgKGNtLmlzUmVhZE9ubHkoKSkgeyBjbS5zdGF0ZS5zdXBwcmVzc0VkaXRzID0gdHJ1ZTsgfQogICAgICAgIGRvbmUgPSBib3VuZChjbSwgcG9zKSAhPSBQYXNzOwogICAgICB9IGZpbmFsbHkgewogICAgICAgIGNtLnN0YXRlLnN1cHByZXNzRWRpdHMgPSBmYWxzZTsKICAgICAgfQogICAgICByZXR1cm4gZG9uZQogICAgfSkKICB9CgogIGZ1bmN0aW9uIGNvbmZpZ3VyZU1vdXNlKGNtLCByZXBlYXQsIGV2ZW50KSB7CiAgICB2YXIgb3B0aW9uID0gY20uZ2V0T3B0aW9uKCJjb25maWd1cmVNb3VzZSIpOwogICAgdmFyIHZhbHVlID0gb3B0aW9uID8gb3B0aW9uKGNtLCByZXBlYXQsIGV2ZW50KSA6IHt9OwogICAgaWYgKHZhbHVlLnVuaXQgPT0gbnVsbCkgewogICAgICB2YXIgcmVjdCA9IGNocm9tZU9TID8gZXZlbnQuc2hpZnRLZXkgJiYgZXZlbnQubWV0YUtleSA6IGV2ZW50LmFsdEtleTsKICAgICAgdmFsdWUudW5pdCA9IHJlY3QgPyAicmVjdGFuZ2xlIiA6IHJlcGVhdCA9PSAic2luZ2xlIiA/ICJjaGFyIiA6IHJlcGVhdCA9PSAiZG91YmxlIiA/ICJ3b3JkIiA6ICJsaW5lIjsKICAgIH0KICAgIGlmICh2YWx1ZS5leHRlbmQgPT0gbnVsbCB8fCBjbS5kb2MuZXh0ZW5kKSB7IHZhbHVlLmV4dGVuZCA9IGNtLmRvYy5leHRlbmQgfHwgZXZlbnQuc2hpZnRLZXk7IH0KICAgIGlmICh2YWx1ZS5hZGROZXcgPT0gbnVsbCkgeyB2YWx1ZS5hZGROZXcgPSBtYWMgPyBldmVudC5tZXRhS2V5IDogZXZlbnQuY3RybEtleTsgfQogICAgaWYgKHZhbHVlLm1vdmVPbkRyYWcgPT0gbnVsbCkgeyB2YWx1ZS5tb3ZlT25EcmFnID0gIShtYWMgPyBldmVudC5hbHRLZXkgOiBldmVudC5jdHJsS2V5KTsgfQogICAgcmV0dXJuIHZhbHVlCiAgfQoKICBmdW5jdGlvbiBsZWZ0QnV0dG9uRG93bihjbSwgcG9zLCByZXBlYXQsIGV2ZW50KSB7CiAgICBpZiAoaWUpIHsgc2V0VGltZW91dChiaW5kKGVuc3VyZUZvY3VzLCBjbSksIDApOyB9CiAgICBlbHNlIHsgY20uY3VyT3AuZm9jdXMgPSBhY3RpdmVFbHQoKTsgfQoKICAgIHZhciBiZWhhdmlvciA9IGNvbmZpZ3VyZU1vdXNlKGNtLCByZXBlYXQsIGV2ZW50KTsKCiAgICB2YXIgc2VsID0gY20uZG9jLnNlbCwgY29udGFpbmVkOwogICAgaWYgKGNtLm9wdGlvbnMuZHJhZ0Ryb3AgJiYgZHJhZ0FuZERyb3AgJiYgIWNtLmlzUmVhZE9ubHkoKSAmJgogICAgICAgIHJlcGVhdCA9PSAic2luZ2xlIiAmJiAoY29udGFpbmVkID0gc2VsLmNvbnRhaW5zKHBvcykpID4gLTEgJiYKICAgICAgICAoY21wKChjb250YWluZWQgPSBzZWwucmFuZ2VzW2NvbnRhaW5lZF0pLmZyb20oKSwgcG9zKSA8IDAgfHwgcG9zLnhSZWwgPiAwKSAmJgogICAgICAgIChjbXAoY29udGFpbmVkLnRvKCksIHBvcykgPiAwIHx8IHBvcy54UmVsIDwgMCkpCiAgICAgIHsgbGVmdEJ1dHRvblN0YXJ0RHJhZyhjbSwgZXZlbnQsIHBvcywgYmVoYXZpb3IpOyB9CiAgICBlbHNlCiAgICAgIHsgbGVmdEJ1dHRvblNlbGVjdChjbSwgZXZlbnQsIHBvcywgYmVoYXZpb3IpOyB9CiAgfQoKICAvLyBTdGFydCBhIHRleHQgZHJhZy4gV2hlbiBpdCBlbmRzLCBzZWUgaWYgYW55IGRyYWdnaW5nIGFjdHVhbGx5CiAgLy8gaGFwcGVuLCBhbmQgdHJlYXQgYXMgYSBjbGljayBpZiBpdCBkaWRuJ3QuCiAgZnVuY3Rpb24gbGVmdEJ1dHRvblN0YXJ0RHJhZyhjbSwgZXZlbnQsIHBvcywgYmVoYXZpb3IpIHsKICAgIHZhciBkaXNwbGF5ID0gY20uZGlzcGxheSwgbW92ZWQgPSBmYWxzZTsKICAgIHZhciBkcmFnRW5kID0gb3BlcmF0aW9uKGNtLCBmdW5jdGlvbiAoZSkgewogICAgICBpZiAod2Via2l0KSB7IGRpc3BsYXkuc2Nyb2xsZXIuZHJhZ2dhYmxlID0gZmFsc2U7IH0KICAgICAgY20uc3RhdGUuZHJhZ2dpbmdUZXh0ID0gZmFsc2U7CiAgICAgIG9mZihkaXNwbGF5LndyYXBwZXIub3duZXJEb2N1bWVudCwgIm1vdXNldXAiLCBkcmFnRW5kKTsKICAgICAgb2ZmKGRpc3BsYXkud3JhcHBlci5vd25lckRvY3VtZW50LCAibW91c2Vtb3ZlIiwgbW91c2VNb3ZlKTsKICAgICAgb2ZmKGRpc3BsYXkuc2Nyb2xsZXIsICJkcmFnc3RhcnQiLCBkcmFnU3RhcnQpOwogICAgICBvZmYoZGlzcGxheS5zY3JvbGxlciwgImRyb3AiLCBkcmFnRW5kKTsKICAgICAgaWYgKCFtb3ZlZCkgewogICAgICAgIGVfcHJldmVudERlZmF1bHQoZSk7CiAgICAgICAgaWYgKCFiZWhhdmlvci5hZGROZXcpCiAgICAgICAgICB7IGV4dGVuZFNlbGVjdGlvbihjbS5kb2MsIHBvcywgbnVsbCwgbnVsbCwgYmVoYXZpb3IuZXh0ZW5kKTsgfQogICAgICAgIC8vIFdvcmsgYXJvdW5kIHVuZXhwbGFpbmFibGUgZm9jdXMgcHJvYmxlbSBpbiBJRTkgKCMyMTI3KSBhbmQgQ2hyb21lICgjMzA4MSkKICAgICAgICBpZiAod2Via2l0IHx8IGllICYmIGllX3ZlcnNpb24gPT0gOSkKICAgICAgICAgIHsgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7ZGlzcGxheS53cmFwcGVyLm93bmVyRG9jdW1lbnQuYm9keS5mb2N1cygpOyBkaXNwbGF5LmlucHV0LmZvY3VzKCk7fSwgMjApOyB9CiAgICAgICAgZWxzZQogICAgICAgICAgeyBkaXNwbGF5LmlucHV0LmZvY3VzKCk7IH0KICAgICAgfQogICAgfSk7CiAgICB2YXIgbW91c2VNb3ZlID0gZnVuY3Rpb24oZTIpIHsKICAgICAgbW92ZWQgPSBtb3ZlZCB8fCBNYXRoLmFicyhldmVudC5jbGllbnRYIC0gZTIuY2xpZW50WCkgKyBNYXRoLmFicyhldmVudC5jbGllbnRZIC0gZTIuY2xpZW50WSkgPj0gMTA7CiAgICB9OwogICAgdmFyIGRyYWdTdGFydCA9IGZ1bmN0aW9uICgpIHsgcmV0dXJuIG1vdmVkID0gdHJ1ZTsgfTsKICAgIC8vIExldCB0aGUgZHJhZyBoYW5kbGVyIGhhbmRsZSB0aGlzLgogICAgaWYgKHdlYmtpdCkgeyBkaXNwbGF5LnNjcm9sbGVyLmRyYWdnYWJsZSA9IHRydWU7IH0KICAgIGNtLnN0YXRlLmRyYWdnaW5nVGV4dCA9IGRyYWdFbmQ7CiAgICBkcmFnRW5kLmNvcHkgPSAhYmVoYXZpb3IubW92ZU9uRHJhZzsKICAgIC8vIElFJ3MgYXBwcm9hY2ggdG8gZHJhZ2dhYmxlCiAgICBpZiAoZGlzcGxheS5zY3JvbGxlci5kcmFnRHJvcCkgeyBkaXNwbGF5LnNjcm9sbGVyLmRyYWdEcm9wKCk7IH0KICAgIG9uKGRpc3BsYXkud3JhcHBlci5vd25lckRvY3VtZW50LCAibW91c2V1cCIsIGRyYWdFbmQpOwogICAgb24oZGlzcGxheS53cmFwcGVyLm93bmVyRG9jdW1lbnQsICJtb3VzZW1vdmUiLCBtb3VzZU1vdmUpOwogICAgb24oZGlzcGxheS5zY3JvbGxlciwgImRyYWdzdGFydCIsIGRyYWdTdGFydCk7CiAgICBvbihkaXNwbGF5LnNjcm9sbGVyLCAiZHJvcCIsIGRyYWdFbmQpOwoKICAgIGRlbGF5Qmx1ckV2ZW50KGNtKTsKICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgeyByZXR1cm4gZGlzcGxheS5pbnB1dC5mb2N1cygpOyB9LCAyMCk7CiAgfQoKICBmdW5jdGlvbiByYW5nZUZvclVuaXQoY20sIHBvcywgdW5pdCkgewogICAgaWYgKHVuaXQgPT0gImNoYXIiKSB7IHJldHVybiBuZXcgUmFuZ2UocG9zLCBwb3MpIH0KICAgIGlmICh1bml0ID09ICJ3b3JkIikgeyByZXR1cm4gY20uZmluZFdvcmRBdChwb3MpIH0KICAgIGlmICh1bml0ID09ICJsaW5lIikgeyByZXR1cm4gbmV3IFJhbmdlKFBvcyhwb3MubGluZSwgMCksIGNsaXBQb3MoY20uZG9jLCBQb3MocG9zLmxpbmUgKyAxLCAwKSkpIH0KICAgIHZhciByZXN1bHQgPSB1bml0KGNtLCBwb3MpOwogICAgcmV0dXJuIG5ldyBSYW5nZShyZXN1bHQuZnJvbSwgcmVzdWx0LnRvKQogIH0KCiAgLy8gTm9ybWFsIHNlbGVjdGlvbiwgYXMgb3Bwb3NlZCB0byB0ZXh0IGRyYWdnaW5nLgogIGZ1bmN0aW9uIGxlZnRCdXR0b25TZWxlY3QoY20sIGV2ZW50LCBzdGFydCwgYmVoYXZpb3IpIHsKICAgIHZhciBkaXNwbGF5ID0gY20uZGlzcGxheSwgZG9jID0gY20uZG9jOwogICAgZV9wcmV2ZW50RGVmYXVsdChldmVudCk7CgogICAgdmFyIG91clJhbmdlLCBvdXJJbmRleCwgc3RhcnRTZWwgPSBkb2Muc2VsLCByYW5nZXMgPSBzdGFydFNlbC5yYW5nZXM7CiAgICBpZiAoYmVoYXZpb3IuYWRkTmV3ICYmICFiZWhhdmlvci5leHRlbmQpIHsKICAgICAgb3VySW5kZXggPSBkb2Muc2VsLmNvbnRhaW5zKHN0YXJ0KTsKICAgICAgaWYgKG91ckluZGV4ID4gLTEpCiAgICAgICAgeyBvdXJSYW5nZSA9IHJhbmdlc1tvdXJJbmRleF07IH0KICAgICAgZWxzZQogICAgICAgIHsgb3VyUmFuZ2UgPSBuZXcgUmFuZ2Uoc3RhcnQsIHN0YXJ0KTsgfQogICAgfSBlbHNlIHsKICAgICAgb3VyUmFuZ2UgPSBkb2Muc2VsLnByaW1hcnkoKTsKICAgICAgb3VySW5kZXggPSBkb2Muc2VsLnByaW1JbmRleDsKICAgIH0KCiAgICBpZiAoYmVoYXZpb3IudW5pdCA9PSAicmVjdGFuZ2xlIikgewogICAgICBpZiAoIWJlaGF2aW9yLmFkZE5ldykgeyBvdXJSYW5nZSA9IG5ldyBSYW5nZShzdGFydCwgc3RhcnQpOyB9CiAgICAgIHN0YXJ0ID0gcG9zRnJvbU1vdXNlKGNtLCBldmVudCwgdHJ1ZSwgdHJ1ZSk7CiAgICAgIG91ckluZGV4ID0gLTE7CiAgICB9IGVsc2UgewogICAgICB2YXIgcmFuZ2UkJDEgPSByYW5nZUZvclVuaXQoY20sIHN0YXJ0LCBiZWhhdmlvci51bml0KTsKICAgICAgaWYgKGJlaGF2aW9yLmV4dGVuZCkKICAgICAgICB7IG91clJhbmdlID0gZXh0ZW5kUmFuZ2Uob3VyUmFuZ2UsIHJhbmdlJCQxLmFuY2hvciwgcmFuZ2UkJDEuaGVhZCwgYmVoYXZpb3IuZXh0ZW5kKTsgfQogICAgICBlbHNlCiAgICAgICAgeyBvdXJSYW5nZSA9IHJhbmdlJCQxOyB9CiAgICB9CgogICAgaWYgKCFiZWhhdmlvci5hZGROZXcpIHsKICAgICAgb3VySW5kZXggPSAwOwogICAgICBzZXRTZWxlY3Rpb24oZG9jLCBuZXcgU2VsZWN0aW9uKFtvdXJSYW5nZV0sIDApLCBzZWxfbW91c2UpOwogICAgICBzdGFydFNlbCA9IGRvYy5zZWw7CiAgICB9IGVsc2UgaWYgKG91ckluZGV4ID09IC0xKSB7CiAgICAgIG91ckluZGV4ID0gcmFuZ2VzLmxlbmd0aDsKICAgICAgc2V0U2VsZWN0aW9uKGRvYywgbm9ybWFsaXplU2VsZWN0aW9uKGNtLCByYW5nZXMuY29uY2F0KFtvdXJSYW5nZV0pLCBvdXJJbmRleCksCiAgICAgICAgICAgICAgICAgICB7c2Nyb2xsOiBmYWxzZSwgb3JpZ2luOiAiKm1vdXNlIn0pOwogICAgfSBlbHNlIGlmIChyYW5nZXMubGVuZ3RoID4gMSAmJiByYW5nZXNbb3VySW5kZXhdLmVtcHR5KCkgJiYgYmVoYXZpb3IudW5pdCA9PSAiY2hhciIgJiYgIWJlaGF2aW9yLmV4dGVuZCkgewogICAgICBzZXRTZWxlY3Rpb24oZG9jLCBub3JtYWxpemVTZWxlY3Rpb24oY20sIHJhbmdlcy5zbGljZSgwLCBvdXJJbmRleCkuY29uY2F0KHJhbmdlcy5zbGljZShvdXJJbmRleCArIDEpKSwgMCksCiAgICAgICAgICAgICAgICAgICB7c2Nyb2xsOiBmYWxzZSwgb3JpZ2luOiAiKm1vdXNlIn0pOwogICAgICBzdGFydFNlbCA9IGRvYy5zZWw7CiAgICB9IGVsc2UgewogICAgICByZXBsYWNlT25lU2VsZWN0aW9uKGRvYywgb3VySW5kZXgsIG91clJhbmdlLCBzZWxfbW91c2UpOwogICAgfQoKICAgIHZhciBsYXN0UG9zID0gc3RhcnQ7CiAgICBmdW5jdGlvbiBleHRlbmRUbyhwb3MpIHsKICAgICAgaWYgKGNtcChsYXN0UG9zLCBwb3MpID09IDApIHsgcmV0dXJuIH0KICAgICAgbGFzdFBvcyA9IHBvczsKCiAgICAgIGlmIChiZWhhdmlvci51bml0ID09ICJyZWN0YW5nbGUiKSB7CiAgICAgICAgdmFyIHJhbmdlcyA9IFtdLCB0YWJTaXplID0gY20ub3B0aW9ucy50YWJTaXplOwogICAgICAgIHZhciBzdGFydENvbCA9IGNvdW50Q29sdW1uKGdldExpbmUoZG9jLCBzdGFydC5saW5lKS50ZXh0LCBzdGFydC5jaCwgdGFiU2l6ZSk7CiAgICAgICAgdmFyIHBvc0NvbCA9IGNvdW50Q29sdW1uKGdldExpbmUoZG9jLCBwb3MubGluZSkudGV4dCwgcG9zLmNoLCB0YWJTaXplKTsKICAgICAgICB2YXIgbGVmdCA9IE1hdGgubWluKHN0YXJ0Q29sLCBwb3NDb2wpLCByaWdodCA9IE1hdGgubWF4KHN0YXJ0Q29sLCBwb3NDb2wpOwogICAgICAgIGZvciAodmFyIGxpbmUgPSBNYXRoLm1pbihzdGFydC5saW5lLCBwb3MubGluZSksIGVuZCA9IE1hdGgubWluKGNtLmxhc3RMaW5lKCksIE1hdGgubWF4KHN0YXJ0LmxpbmUsIHBvcy5saW5lKSk7CiAgICAgICAgICAgICBsaW5lIDw9IGVuZDsgbGluZSsrKSB7CiAgICAgICAgICB2YXIgdGV4dCA9IGdldExpbmUoZG9jLCBsaW5lKS50ZXh0LCBsZWZ0UG9zID0gZmluZENvbHVtbih0ZXh0LCBsZWZ0LCB0YWJTaXplKTsKICAgICAgICAgIGlmIChsZWZ0ID09IHJpZ2h0KQogICAgICAgICAgICB7IHJhbmdlcy5wdXNoKG5ldyBSYW5nZShQb3MobGluZSwgbGVmdFBvcyksIFBvcyhsaW5lLCBsZWZ0UG9zKSkpOyB9CiAgICAgICAgICBlbHNlIGlmICh0ZXh0Lmxlbmd0aCA+IGxlZnRQb3MpCiAgICAgICAgICAgIHsgcmFuZ2VzLnB1c2gobmV3IFJhbmdlKFBvcyhsaW5lLCBsZWZ0UG9zKSwgUG9zKGxpbmUsIGZpbmRDb2x1bW4odGV4dCwgcmlnaHQsIHRhYlNpemUpKSkpOyB9CiAgICAgICAgfQogICAgICAgIGlmICghcmFuZ2VzLmxlbmd0aCkgeyByYW5nZXMucHVzaChuZXcgUmFuZ2Uoc3RhcnQsIHN0YXJ0KSk7IH0KICAgICAgICBzZXRTZWxlY3Rpb24oZG9jLCBub3JtYWxpemVTZWxlY3Rpb24oY20sIHN0YXJ0U2VsLnJhbmdlcy5zbGljZSgwLCBvdXJJbmRleCkuY29uY2F0KHJhbmdlcyksIG91ckluZGV4KSwKICAgICAgICAgICAgICAgICAgICAge29yaWdpbjogIiptb3VzZSIsIHNjcm9sbDogZmFsc2V9KTsKICAgICAgICBjbS5zY3JvbGxJbnRvVmlldyhwb3MpOwogICAgICB9IGVsc2UgewogICAgICAgIHZhciBvbGRSYW5nZSA9IG91clJhbmdlOwogICAgICAgIHZhciByYW5nZSQkMSA9IHJhbmdlRm9yVW5pdChjbSwgcG9zLCBiZWhhdmlvci51bml0KTsKICAgICAgICB2YXIgYW5jaG9yID0gb2xkUmFuZ2UuYW5jaG9yLCBoZWFkOwogICAgICAgIGlmIChjbXAocmFuZ2UkJDEuYW5jaG9yLCBhbmNob3IpID4gMCkgewogICAgICAgICAgaGVhZCA9IHJhbmdlJCQxLmhlYWQ7CiAgICAgICAgICBhbmNob3IgPSBtaW5Qb3Mob2xkUmFuZ2UuZnJvbSgpLCByYW5nZSQkMS5hbmNob3IpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBoZWFkID0gcmFuZ2UkJDEuYW5jaG9yOwogICAgICAgICAgYW5jaG9yID0gbWF4UG9zKG9sZFJhbmdlLnRvKCksIHJhbmdlJCQxLmhlYWQpOwogICAgICAgIH0KICAgICAgICB2YXIgcmFuZ2VzJDEgPSBzdGFydFNlbC5yYW5nZXMuc2xpY2UoMCk7CiAgICAgICAgcmFuZ2VzJDFbb3VySW5kZXhdID0gYmlkaVNpbXBsaWZ5KGNtLCBuZXcgUmFuZ2UoY2xpcFBvcyhkb2MsIGFuY2hvciksIGhlYWQpKTsKICAgICAgICBzZXRTZWxlY3Rpb24oZG9jLCBub3JtYWxpemVTZWxlY3Rpb24oY20sIHJhbmdlcyQxLCBvdXJJbmRleCksIHNlbF9tb3VzZSk7CiAgICAgIH0KICAgIH0KCiAgICB2YXIgZWRpdG9yU2l6ZSA9IGRpc3BsYXkud3JhcHBlci5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgIC8vIFVzZWQgdG8gZW5zdXJlIHRpbWVvdXQgcmUtdHJpZXMgZG9uJ3QgZmlyZSB3aGVuIGFub3RoZXIgZXh0ZW5kCiAgICAvLyBoYXBwZW5lZCBpbiB0aGUgbWVhbnRpbWUgKGNsZWFyVGltZW91dCBpc24ndCByZWxpYWJsZSAtLSBhdAogICAgLy8gbGVhc3Qgb24gQ2hyb21lLCB0aGUgdGltZW91dHMgc3RpbGwgaGFwcGVuIGV2ZW4gd2hlbiBjbGVhcmVkLAogICAgLy8gaWYgdGhlIGNsZWFyIGhhcHBlbnMgYWZ0ZXIgdGhlaXIgc2NoZWR1bGVkIGZpcmluZyB0aW1lKS4KICAgIHZhciBjb3VudGVyID0gMDsKCiAgICBmdW5jdGlvbiBleHRlbmQoZSkgewogICAgICB2YXIgY3VyQ291bnQgPSArK2NvdW50ZXI7CiAgICAgIHZhciBjdXIgPSBwb3NGcm9tTW91c2UoY20sIGUsIHRydWUsIGJlaGF2aW9yLnVuaXQgPT0gInJlY3RhbmdsZSIpOwogICAgICBpZiAoIWN1cikgeyByZXR1cm4gfQogICAgICBpZiAoY21wKGN1ciwgbGFzdFBvcykgIT0gMCkgewogICAgICAgIGNtLmN1ck9wLmZvY3VzID0gYWN0aXZlRWx0KCk7CiAgICAgICAgZXh0ZW5kVG8oY3VyKTsKICAgICAgICB2YXIgdmlzaWJsZSA9IHZpc2libGVMaW5lcyhkaXNwbGF5LCBkb2MpOwogICAgICAgIGlmIChjdXIubGluZSA+PSB2aXNpYmxlLnRvIHx8IGN1ci5saW5lIDwgdmlzaWJsZS5mcm9tKQogICAgICAgICAgeyBzZXRUaW1lb3V0KG9wZXJhdGlvbihjbSwgZnVuY3Rpb24gKCkge2lmIChjb3VudGVyID09IGN1ckNvdW50KSB7IGV4dGVuZChlKTsgfX0pLCAxNTApOyB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIG91dHNpZGUgPSBlLmNsaWVudFkgPCBlZGl0b3JTaXplLnRvcCA/IC0yMCA6IGUuY2xpZW50WSA+IGVkaXRvclNpemUuYm90dG9tID8gMjAgOiAwOwogICAgICAgIGlmIChvdXRzaWRlKSB7IHNldFRpbWVvdXQob3BlcmF0aW9uKGNtLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpZiAoY291bnRlciAhPSBjdXJDb3VudCkgeyByZXR1cm4gfQogICAgICAgICAgZGlzcGxheS5zY3JvbGxlci5zY3JvbGxUb3AgKz0gb3V0c2lkZTsKICAgICAgICAgIGV4dGVuZChlKTsKICAgICAgICB9KSwgNTApOyB9CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBkb25lKGUpIHsKICAgICAgY20uc3RhdGUuc2VsZWN0aW5nVGV4dCA9IGZhbHNlOwogICAgICBjb3VudGVyID0gSW5maW5pdHk7CiAgICAgIC8vIElmIGUgaXMgbnVsbCBvciB1bmRlZmluZWQgd2UgaW50ZXJwcmV0IHRoaXMgYXMgc29tZW9uZSB0cnlpbmcKICAgICAgLy8gdG8gZXhwbGljaXRseSBjYW5jZWwgdGhlIHNlbGVjdGlvbiByYXRoZXIgdGhhbiB0aGUgdXNlcgogICAgICAvLyBsZXR0aW5nIGdvIG9mIHRoZSBtb3VzZSBidXR0b24uCiAgICAgIGlmIChlKSB7CiAgICAgICAgZV9wcmV2ZW50RGVmYXVsdChlKTsKICAgICAgICBkaXNwbGF5LmlucHV0LmZvY3VzKCk7CiAgICAgIH0KICAgICAgb2ZmKGRpc3BsYXkud3JhcHBlci5vd25lckRvY3VtZW50LCAibW91c2Vtb3ZlIiwgbW92ZSk7CiAgICAgIG9mZihkaXNwbGF5LndyYXBwZXIub3duZXJEb2N1bWVudCwgIm1vdXNldXAiLCB1cCk7CiAgICAgIGRvYy5oaXN0b3J5Lmxhc3RTZWxPcmlnaW4gPSBudWxsOwogICAgfQoKICAgIHZhciBtb3ZlID0gb3BlcmF0aW9uKGNtLCBmdW5jdGlvbiAoZSkgewogICAgICBpZiAoZS5idXR0b25zID09PSAwIHx8ICFlX2J1dHRvbihlKSkgeyBkb25lKGUpOyB9CiAgICAgIGVsc2UgeyBleHRlbmQoZSk7IH0KICAgIH0pOwogICAgdmFyIHVwID0gb3BlcmF0aW9uKGNtLCBkb25lKTsKICAgIGNtLnN0YXRlLnNlbGVjdGluZ1RleHQgPSB1cDsKICAgIG9uKGRpc3BsYXkud3JhcHBlci5vd25lckRvY3VtZW50LCAibW91c2Vtb3ZlIiwgbW92ZSk7CiAgICBvbihkaXNwbGF5LndyYXBwZXIub3duZXJEb2N1bWVudCwgIm1vdXNldXAiLCB1cCk7CiAgfQoKICAvLyBVc2VkIHdoZW4gbW91c2Utc2VsZWN0aW5nIHRvIGFkanVzdCB0aGUgYW5jaG9yIHRvIHRoZSBwcm9wZXIgc2lkZQogIC8vIG9mIGEgYmlkaSBqdW1wIGRlcGVuZGluZyBvbiB0aGUgdmlzdWFsIHBvc2l0aW9uIG9mIHRoZSBoZWFkLgogIGZ1bmN0aW9uIGJpZGlTaW1wbGlmeShjbSwgcmFuZ2UkJDEpIHsKICAgIHZhciBhbmNob3IgPSByYW5nZSQkMS5hbmNob3I7CiAgICB2YXIgaGVhZCA9IHJhbmdlJCQxLmhlYWQ7CiAgICB2YXIgYW5jaG9yTGluZSA9IGdldExpbmUoY20uZG9jLCBhbmNob3IubGluZSk7CiAgICBpZiAoY21wKGFuY2hvciwgaGVhZCkgPT0gMCAmJiBhbmNob3Iuc3RpY2t5ID09IGhlYWQuc3RpY2t5KSB7IHJldHVybiByYW5nZSQkMSB9CiAgICB2YXIgb3JkZXIgPSBnZXRPcmRlcihhbmNob3JMaW5lKTsKICAgIGlmICghb3JkZXIpIHsgcmV0dXJuIHJhbmdlJCQxIH0KICAgIHZhciBpbmRleCA9IGdldEJpZGlQYXJ0QXQob3JkZXIsIGFuY2hvci5jaCwgYW5jaG9yLnN0aWNreSksIHBhcnQgPSBvcmRlcltpbmRleF07CiAgICBpZiAocGFydC5mcm9tICE9IGFuY2hvci5jaCAmJiBwYXJ0LnRvICE9IGFuY2hvci5jaCkgeyByZXR1cm4gcmFuZ2UkJDEgfQogICAgdmFyIGJvdW5kYXJ5ID0gaW5kZXggKyAoKHBhcnQuZnJvbSA9PSBhbmNob3IuY2gpID09IChwYXJ0LmxldmVsICE9IDEpID8gMCA6IDEpOwogICAgaWYgKGJvdW5kYXJ5ID09IDAgfHwgYm91bmRhcnkgPT0gb3JkZXIubGVuZ3RoKSB7IHJldHVybiByYW5nZSQkMSB9CgogICAgLy8gQ29tcHV0ZSB0aGUgcmVsYXRpdmUgdmlzdWFsIHBvc2l0aW9uIG9mIHRoZSBoZWFkIGNvbXBhcmVkIHRvIHRoZQogICAgLy8gYW5jaG9yICg8MCBpcyB0byB0aGUgbGVmdCwgPjAgdG8gdGhlIHJpZ2h0KQogICAgdmFyIGxlZnRTaWRlOwogICAgaWYgKGhlYWQubGluZSAhPSBhbmNob3IubGluZSkgewogICAgICBsZWZ0U2lkZSA9IChoZWFkLmxpbmUgLSBhbmNob3IubGluZSkgKiAoY20uZG9jLmRpcmVjdGlvbiA9PSAibHRyIiA/IDEgOiAtMSkgPiAwOwogICAgfSBlbHNlIHsKICAgICAgdmFyIGhlYWRJbmRleCA9IGdldEJpZGlQYXJ0QXQob3JkZXIsIGhlYWQuY2gsIGhlYWQuc3RpY2t5KTsKICAgICAgdmFyIGRpciA9IGhlYWRJbmRleCAtIGluZGV4IHx8IChoZWFkLmNoIC0gYW5jaG9yLmNoKSAqIChwYXJ0LmxldmVsID09IDEgPyAtMSA6IDEpOwogICAgICBpZiAoaGVhZEluZGV4ID09IGJvdW5kYXJ5IC0gMSB8fCBoZWFkSW5kZXggPT0gYm91bmRhcnkpCiAgICAgICAgeyBsZWZ0U2lkZSA9IGRpciA8IDA7IH0KICAgICAgZWxzZQogICAgICAgIHsgbGVmdFNpZGUgPSBkaXIgPiAwOyB9CiAgICB9CgogICAgdmFyIHVzZVBhcnQgPSBvcmRlcltib3VuZGFyeSArIChsZWZ0U2lkZSA/IC0xIDogMCldOwogICAgdmFyIGZyb20gPSBsZWZ0U2lkZSA9PSAodXNlUGFydC5sZXZlbCA9PSAxKTsKICAgIHZhciBjaCA9IGZyb20gPyB1c2VQYXJ0LmZyb20gOiB1c2VQYXJ0LnRvLCBzdGlja3kgPSBmcm9tID8gImFmdGVyIiA6ICJiZWZvcmUiOwogICAgcmV0dXJuIGFuY2hvci5jaCA9PSBjaCAmJiBhbmNob3Iuc3RpY2t5ID09IHN0aWNreSA/IHJhbmdlJCQxIDogbmV3IFJhbmdlKG5ldyBQb3MoYW5jaG9yLmxpbmUsIGNoLCBzdGlja3kpLCBoZWFkKQogIH0KCgogIC8vIERldGVybWluZXMgd2hldGhlciBhbiBldmVudCBoYXBwZW5lZCBpbiB0aGUgZ3V0dGVyLCBhbmQgZmlyZXMgdGhlCiAgLy8gaGFuZGxlcnMgZm9yIHRoZSBjb3JyZXNwb25kaW5nIGV2ZW50LgogIGZ1bmN0aW9uIGd1dHRlckV2ZW50KGNtLCBlLCB0eXBlLCBwcmV2ZW50KSB7CiAgICB2YXIgbVgsIG1ZOwogICAgaWYgKGUudG91Y2hlcykgewogICAgICBtWCA9IGUudG91Y2hlc1swXS5jbGllbnRYOwogICAgICBtWSA9IGUudG91Y2hlc1swXS5jbGllbnRZOwogICAgfSBlbHNlIHsKICAgICAgdHJ5IHsgbVggPSBlLmNsaWVudFg7IG1ZID0gZS5jbGllbnRZOyB9CiAgICAgIGNhdGNoKGUpIHsgcmV0dXJuIGZhbHNlIH0KICAgIH0KICAgIGlmIChtWCA+PSBNYXRoLmZsb29yKGNtLmRpc3BsYXkuZ3V0dGVycy5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS5yaWdodCkpIHsgcmV0dXJuIGZhbHNlIH0KICAgIGlmIChwcmV2ZW50KSB7IGVfcHJldmVudERlZmF1bHQoZSk7IH0KCiAgICB2YXIgZGlzcGxheSA9IGNtLmRpc3BsYXk7CiAgICB2YXIgbGluZUJveCA9IGRpc3BsYXkubGluZURpdi5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKCiAgICBpZiAobVkgPiBsaW5lQm94LmJvdHRvbSB8fCAhaGFzSGFuZGxlcihjbSwgdHlwZSkpIHsgcmV0dXJuIGVfZGVmYXVsdFByZXZlbnRlZChlKSB9CiAgICBtWSAtPSBsaW5lQm94LnRvcCAtIGRpc3BsYXkudmlld09mZnNldDsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNtLmRpc3BsYXkuZ3V0dGVyU3BlY3MubGVuZ3RoOyArK2kpIHsKICAgICAgdmFyIGcgPSBkaXNwbGF5Lmd1dHRlcnMuY2hpbGROb2Rlc1tpXTsKICAgICAgaWYgKGcgJiYgZy5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS5yaWdodCA+PSBtWCkgewogICAgICAgIHZhciBsaW5lID0gbGluZUF0SGVpZ2h0KGNtLmRvYywgbVkpOwogICAgICAgIHZhciBndXR0ZXIgPSBjbS5kaXNwbGF5Lmd1dHRlclNwZWNzW2ldOwogICAgICAgIHNpZ25hbChjbSwgdHlwZSwgY20sIGxpbmUsIGd1dHRlci5jbGFzc05hbWUsIGUpOwogICAgICAgIHJldHVybiBlX2RlZmF1bHRQcmV2ZW50ZWQoZSkKICAgICAgfQogICAgfQogIH0KCiAgZnVuY3Rpb24gY2xpY2tJbkd1dHRlcihjbSwgZSkgewogICAgcmV0dXJuIGd1dHRlckV2ZW50KGNtLCBlLCAiZ3V0dGVyQ2xpY2siLCB0cnVlKQogIH0KCiAgLy8gQ09OVEVYVCBNRU5VIEhBTkRMSU5HCgogIC8vIFRvIG1ha2UgdGhlIGNvbnRleHQgbWVudSB3b3JrLCB3ZSBuZWVkIHRvIGJyaWVmbHkgdW5oaWRlIHRoZQogIC8vIHRleHRhcmVhIChtYWtpbmcgaXQgYXMgdW5vYnRydXNpdmUgYXMgcG9zc2libGUpIHRvIGxldCB0aGUKICAvLyByaWdodC1jbGljayB0YWtlIGVmZmVjdCBvbiBpdC4KICBmdW5jdGlvbiBvbkNvbnRleHRNZW51KGNtLCBlKSB7CiAgICBpZiAoZXZlbnRJbldpZGdldChjbS5kaXNwbGF5LCBlKSB8fCBjb250ZXh0TWVudUluR3V0dGVyKGNtLCBlKSkgeyByZXR1cm4gfQogICAgaWYgKHNpZ25hbERPTUV2ZW50KGNtLCBlLCAiY29udGV4dG1lbnUiKSkgeyByZXR1cm4gfQogICAgaWYgKCFjYXB0dXJlUmlnaHRDbGljaykgeyBjbS5kaXNwbGF5LmlucHV0Lm9uQ29udGV4dE1lbnUoZSk7IH0KICB9CgogIGZ1bmN0aW9uIGNvbnRleHRNZW51SW5HdXR0ZXIoY20sIGUpIHsKICAgIGlmICghaGFzSGFuZGxlcihjbSwgImd1dHRlckNvbnRleHRNZW51IikpIHsgcmV0dXJuIGZhbHNlIH0KICAgIHJldHVybiBndXR0ZXJFdmVudChjbSwgZSwgImd1dHRlckNvbnRleHRNZW51IiwgZmFsc2UpCiAgfQoKICBmdW5jdGlvbiB0aGVtZUNoYW5nZWQoY20pIHsKICAgIGNtLmRpc3BsYXkud3JhcHBlci5jbGFzc05hbWUgPSBjbS5kaXNwbGF5LndyYXBwZXIuY2xhc3NOYW1lLnJlcGxhY2UoL1xzKmNtLXMtXFMrL2csICIiKSArCiAgICAgIGNtLm9wdGlvbnMudGhlbWUucmVwbGFjZSgvKF58XHMpXHMqL2csICIgY20tcy0iKTsKICAgIGNsZWFyQ2FjaGVzKGNtKTsKICB9CgogIHZhciBJbml0ID0ge3RvU3RyaW5nOiBmdW5jdGlvbigpe3JldHVybiAiQ29kZU1pcnJvci5Jbml0In19OwoKICB2YXIgZGVmYXVsdHMgPSB7fTsKICB2YXIgb3B0aW9uSGFuZGxlcnMgPSB7fTsKCiAgZnVuY3Rpb24gZGVmaW5lT3B0aW9ucyhDb2RlTWlycm9yKSB7CiAgICB2YXIgb3B0aW9uSGFuZGxlcnMgPSBDb2RlTWlycm9yLm9wdGlvbkhhbmRsZXJzOwoKICAgIGZ1bmN0aW9uIG9wdGlvbihuYW1lLCBkZWZsdCwgaGFuZGxlLCBub3RPbkluaXQpIHsKICAgICAgQ29kZU1pcnJvci5kZWZhdWx0c1tuYW1lXSA9IGRlZmx0OwogICAgICBpZiAoaGFuZGxlKSB7IG9wdGlvbkhhbmRsZXJzW25hbWVdID0KICAgICAgICBub3RPbkluaXQgPyBmdW5jdGlvbiAoY20sIHZhbCwgb2xkKSB7aWYgKG9sZCAhPSBJbml0KSB7IGhhbmRsZShjbSwgdmFsLCBvbGQpOyB9fSA6IGhhbmRsZTsgfQogICAgfQoKICAgIENvZGVNaXJyb3IuZGVmaW5lT3B0aW9uID0gb3B0aW9uOwoKICAgIC8vIFBhc3NlZCB0byBvcHRpb24gaGFuZGxlcnMgd2hlbiB0aGVyZSBpcyBubyBvbGQgdmFsdWUuCiAgICBDb2RlTWlycm9yLkluaXQgPSBJbml0OwoKICAgIC8vIFRoZXNlIHR3byBhcmUsIG9uIGluaXQsIGNhbGxlZCBmcm9tIHRoZSBjb25zdHJ1Y3RvciBiZWNhdXNlIHRoZXkKICAgIC8vIGhhdmUgdG8gYmUgaW5pdGlhbGl6ZWQgYmVmb3JlIHRoZSBlZGl0b3IgY2FuIHN0YXJ0IGF0IGFsbC4KICAgIG9wdGlvbigidmFsdWUiLCAiIiwgZnVuY3Rpb24gKGNtLCB2YWwpIHsgcmV0dXJuIGNtLnNldFZhbHVlKHZhbCk7IH0sIHRydWUpOwogICAgb3B0aW9uKCJtb2RlIiwgbnVsbCwgZnVuY3Rpb24gKGNtLCB2YWwpIHsKICAgICAgY20uZG9jLm1vZGVPcHRpb24gPSB2YWw7CiAgICAgIGxvYWRNb2RlKGNtKTsKICAgIH0sIHRydWUpOwoKICAgIG9wdGlvbigiaW5kZW50VW5pdCIsIDIsIGxvYWRNb2RlLCB0cnVlKTsKICAgIG9wdGlvbigiaW5kZW50V2l0aFRhYnMiLCBmYWxzZSk7CiAgICBvcHRpb24oInNtYXJ0SW5kZW50IiwgdHJ1ZSk7CiAgICBvcHRpb24oInRhYlNpemUiLCA0LCBmdW5jdGlvbiAoY20pIHsKICAgICAgcmVzZXRNb2RlU3RhdGUoY20pOwogICAgICBjbGVhckNhY2hlcyhjbSk7CiAgICAgIHJlZ0NoYW5nZShjbSk7CiAgICB9LCB0cnVlKTsKCiAgICBvcHRpb24oImxpbmVTZXBhcmF0b3IiLCBudWxsLCBmdW5jdGlvbiAoY20sIHZhbCkgewogICAgICBjbS5kb2MubGluZVNlcCA9IHZhbDsKICAgICAgaWYgKCF2YWwpIHsgcmV0dXJuIH0KICAgICAgdmFyIG5ld0JyZWFrcyA9IFtdLCBsaW5lTm8gPSBjbS5kb2MuZmlyc3Q7CiAgICAgIGNtLmRvYy5pdGVyKGZ1bmN0aW9uIChsaW5lKSB7CiAgICAgICAgZm9yICh2YXIgcG9zID0gMDs7KSB7CiAgICAgICAgICB2YXIgZm91bmQgPSBsaW5lLnRleHQuaW5kZXhPZih2YWwsIHBvcyk7CiAgICAgICAgICBpZiAoZm91bmQgPT0gLTEpIHsgYnJlYWsgfQogICAgICAgICAgcG9zID0gZm91bmQgKyB2YWwubGVuZ3RoOwogICAgICAgICAgbmV3QnJlYWtzLnB1c2goUG9zKGxpbmVObywgZm91bmQpKTsKICAgICAgICB9CiAgICAgICAgbGluZU5vKys7CiAgICAgIH0pOwogICAgICBmb3IgKHZhciBpID0gbmV3QnJlYWtzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKQogICAgICAgIHsgcmVwbGFjZVJhbmdlKGNtLmRvYywgdmFsLCBuZXdCcmVha3NbaV0sIFBvcyhuZXdCcmVha3NbaV0ubGluZSwgbmV3QnJlYWtzW2ldLmNoICsgdmFsLmxlbmd0aCkpOyB9CiAgICB9KTsKICAgIG9wdGlvbigic3BlY2lhbENoYXJzIiwgL1tcdTAwMDAtXHUwMDFmXHUwMDdmLVx1MDA5Zlx1MDBhZFx1MDYxY1x1MjAwYi1cdTIwMGZcdTIwMjhcdTIwMjlcdWZlZmZcdWZmZjktXHVmZmZjXS9nLCBmdW5jdGlvbiAoY20sIHZhbCwgb2xkKSB7CiAgICAgIGNtLnN0YXRlLnNwZWNpYWxDaGFycyA9IG5ldyBSZWdFeHAodmFsLnNvdXJjZSArICh2YWwudGVzdCgiXHQiKSA/ICIiIDogInxcdCIpLCAiZyIpOwogICAgICBpZiAob2xkICE9IEluaXQpIHsgY20ucmVmcmVzaCgpOyB9CiAgICB9KTsKICAgIG9wdGlvbigic3BlY2lhbENoYXJQbGFjZWhvbGRlciIsIGRlZmF1bHRTcGVjaWFsQ2hhclBsYWNlaG9sZGVyLCBmdW5jdGlvbiAoY20pIHsgcmV0dXJuIGNtLnJlZnJlc2goKTsgfSwgdHJ1ZSk7CiAgICBvcHRpb24oImVsZWN0cmljQ2hhcnMiLCB0cnVlKTsKICAgIG9wdGlvbigiaW5wdXRTdHlsZSIsIG1vYmlsZSA/ICJjb250ZW50ZWRpdGFibGUiIDogInRleHRhcmVhIiwgZnVuY3Rpb24gKCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoImlucHV0U3R5bGUgY2FuIG5vdCAoeWV0KSBiZSBjaGFuZ2VkIGluIGEgcnVubmluZyBlZGl0b3IiKSAvLyBGSVhNRQogICAgfSwgdHJ1ZSk7CiAgICBvcHRpb24oInNwZWxsY2hlY2siLCBmYWxzZSwgZnVuY3Rpb24gKGNtLCB2YWwpIHsgcmV0dXJuIGNtLmdldElucHV0RmllbGQoKS5zcGVsbGNoZWNrID0gdmFsOyB9LCB0cnVlKTsKICAgIG9wdGlvbigiYXV0b2NvcnJlY3QiLCBmYWxzZSwgZnVuY3Rpb24gKGNtLCB2YWwpIHsgcmV0dXJuIGNtLmdldElucHV0RmllbGQoKS5hdXRvY29ycmVjdCA9IHZhbDsgfSwgdHJ1ZSk7CiAgICBvcHRpb24oImF1dG9jYXBpdGFsaXplIiwgZmFsc2UsIGZ1bmN0aW9uIChjbSwgdmFsKSB7IHJldHVybiBjbS5nZXRJbnB1dEZpZWxkKCkuYXV0b2NhcGl0YWxpemUgPSB2YWw7IH0sIHRydWUpOwogICAgb3B0aW9uKCJydGxNb3ZlVmlzdWFsbHkiLCAhd2luZG93cyk7CiAgICBvcHRpb24oIndob2xlTGluZVVwZGF0ZUJlZm9yZSIsIHRydWUpOwoKICAgIG9wdGlvbigidGhlbWUiLCAiZGVmYXVsdCIsIGZ1bmN0aW9uIChjbSkgewogICAgICB0aGVtZUNoYW5nZWQoY20pOwogICAgICB1cGRhdGVHdXR0ZXJzKGNtKTsKICAgIH0sIHRydWUpOwogICAgb3B0aW9uKCJrZXlNYXAiLCAiZGVmYXVsdCIsIGZ1bmN0aW9uIChjbSwgdmFsLCBvbGQpIHsKICAgICAgdmFyIG5leHQgPSBnZXRLZXlNYXAodmFsKTsKICAgICAgdmFyIHByZXYgPSBvbGQgIT0gSW5pdCAmJiBnZXRLZXlNYXAob2xkKTsKICAgICAgaWYgKHByZXYgJiYgcHJldi5kZXRhY2gpIHsgcHJldi5kZXRhY2goY20sIG5leHQpOyB9CiAgICAgIGlmIChuZXh0LmF0dGFjaCkgeyBuZXh0LmF0dGFjaChjbSwgcHJldiB8fCBudWxsKTsgfQogICAgfSk7CiAgICBvcHRpb24oImV4dHJhS2V5cyIsIG51bGwpOwogICAgb3B0aW9uKCJjb25maWd1cmVNb3VzZSIsIG51bGwpOwoKICAgIG9wdGlvbigibGluZVdyYXBwaW5nIiwgZmFsc2UsIHdyYXBwaW5nQ2hhbmdlZCwgdHJ1ZSk7CiAgICBvcHRpb24oImd1dHRlcnMiLCBbXSwgZnVuY3Rpb24gKGNtLCB2YWwpIHsKICAgICAgY20uZGlzcGxheS5ndXR0ZXJTcGVjcyA9IGdldEd1dHRlcnModmFsLCBjbS5vcHRpb25zLmxpbmVOdW1iZXJzKTsKICAgICAgdXBkYXRlR3V0dGVycyhjbSk7CiAgICB9LCB0cnVlKTsKICAgIG9wdGlvbigiZml4ZWRHdXR0ZXIiLCB0cnVlLCBmdW5jdGlvbiAoY20sIHZhbCkgewogICAgICBjbS5kaXNwbGF5Lmd1dHRlcnMuc3R5bGUubGVmdCA9IHZhbCA/IGNvbXBlbnNhdGVGb3JIU2Nyb2xsKGNtLmRpc3BsYXkpICsgInB4IiA6ICIwIjsKICAgICAgY20ucmVmcmVzaCgpOwogICAgfSwgdHJ1ZSk7CiAgICBvcHRpb24oImNvdmVyR3V0dGVyTmV4dFRvU2Nyb2xsYmFyIiwgZmFsc2UsIGZ1bmN0aW9uIChjbSkgeyByZXR1cm4gdXBkYXRlU2Nyb2xsYmFycyhjbSk7IH0sIHRydWUpOwogICAgb3B0aW9uKCJzY3JvbGxiYXJTdHlsZSIsICJuYXRpdmUiLCBmdW5jdGlvbiAoY20pIHsKICAgICAgaW5pdFNjcm9sbGJhcnMoY20pOwogICAgICB1cGRhdGVTY3JvbGxiYXJzKGNtKTsKICAgICAgY20uZGlzcGxheS5zY3JvbGxiYXJzLnNldFNjcm9sbFRvcChjbS5kb2Muc2Nyb2xsVG9wKTsKICAgICAgY20uZGlzcGxheS5zY3JvbGxiYXJzLnNldFNjcm9sbExlZnQoY20uZG9jLnNjcm9sbExlZnQpOwogICAgfSwgdHJ1ZSk7CiAgICBvcHRpb24oImxpbmVOdW1iZXJzIiwgZmFsc2UsIGZ1bmN0aW9uIChjbSwgdmFsKSB7CiAgICAgIGNtLmRpc3BsYXkuZ3V0dGVyU3BlY3MgPSBnZXRHdXR0ZXJzKGNtLm9wdGlvbnMuZ3V0dGVycywgdmFsKTsKICAgICAgdXBkYXRlR3V0dGVycyhjbSk7CiAgICB9LCB0cnVlKTsKICAgIG9wdGlvbigiZmlyc3RMaW5lTnVtYmVyIiwgMSwgdXBkYXRlR3V0dGVycywgdHJ1ZSk7CiAgICBvcHRpb24oImxpbmVOdW1iZXJGb3JtYXR0ZXIiLCBmdW5jdGlvbiAoaW50ZWdlcikgeyByZXR1cm4gaW50ZWdlcjsgfSwgdXBkYXRlR3V0dGVycywgdHJ1ZSk7CiAgICBvcHRpb24oInNob3dDdXJzb3JXaGVuU2VsZWN0aW5nIiwgZmFsc2UsIHVwZGF0ZVNlbGVjdGlvbiwgdHJ1ZSk7CgogICAgb3B0aW9uKCJyZXNldFNlbGVjdGlvbk9uQ29udGV4dE1lbnUiLCB0cnVlKTsKICAgIG9wdGlvbigibGluZVdpc2VDb3B5Q3V0IiwgdHJ1ZSk7CiAgICBvcHRpb24oInBhc3RlTGluZXNQZXJTZWxlY3Rpb24iLCB0cnVlKTsKICAgIG9wdGlvbigic2VsZWN0aW9uc01heVRvdWNoIiwgZmFsc2UpOwoKICAgIG9wdGlvbigicmVhZE9ubHkiLCBmYWxzZSwgZnVuY3Rpb24gKGNtLCB2YWwpIHsKICAgICAgaWYgKHZhbCA9PSAibm9jdXJzb3IiKSB7CiAgICAgICAgb25CbHVyKGNtKTsKICAgICAgICBjbS5kaXNwbGF5LmlucHV0LmJsdXIoKTsKICAgICAgfQogICAgICBjbS5kaXNwbGF5LmlucHV0LnJlYWRPbmx5Q2hhbmdlZCh2YWwpOwogICAgfSk7CiAgICBvcHRpb24oImRpc2FibGVJbnB1dCIsIGZhbHNlLCBmdW5jdGlvbiAoY20sIHZhbCkge2lmICghdmFsKSB7IGNtLmRpc3BsYXkuaW5wdXQucmVzZXQoKTsgfX0sIHRydWUpOwogICAgb3B0aW9uKCJkcmFnRHJvcCIsIHRydWUsIGRyYWdEcm9wQ2hhbmdlZCk7CiAgICBvcHRpb24oImFsbG93RHJvcEZpbGVUeXBlcyIsIG51bGwpOwoKICAgIG9wdGlvbigiY3Vyc29yQmxpbmtSYXRlIiwgNTMwKTsKICAgIG9wdGlvbigiY3Vyc29yU2Nyb2xsTWFyZ2luIiwgMCk7CiAgICBvcHRpb24oImN1cnNvckhlaWdodCIsIDEsIHVwZGF0ZVNlbGVjdGlvbiwgdHJ1ZSk7CiAgICBvcHRpb24oInNpbmdsZUN1cnNvckhlaWdodFBlckxpbmUiLCB0cnVlLCB1cGRhdGVTZWxlY3Rpb24sIHRydWUpOwogICAgb3B0aW9uKCJ3b3JrVGltZSIsIDEwMCk7CiAgICBvcHRpb24oIndvcmtEZWxheSIsIDEwMCk7CiAgICBvcHRpb24oImZsYXR0ZW5TcGFucyIsIHRydWUsIHJlc2V0TW9kZVN0YXRlLCB0cnVlKTsKICAgIG9wdGlvbigiYWRkTW9kZUNsYXNzIiwgZmFsc2UsIHJlc2V0TW9kZVN0YXRlLCB0cnVlKTsKICAgIG9wdGlvbigicG9sbEludGVydmFsIiwgMTAwKTsKICAgIG9wdGlvbigidW5kb0RlcHRoIiwgMjAwLCBmdW5jdGlvbiAoY20sIHZhbCkgeyByZXR1cm4gY20uZG9jLmhpc3RvcnkudW5kb0RlcHRoID0gdmFsOyB9KTsKICAgIG9wdGlvbigiaGlzdG9yeUV2ZW50RGVsYXkiLCAxMjUwKTsKICAgIG9wdGlvbigidmlld3BvcnRNYXJnaW4iLCAxMCwgZnVuY3Rpb24gKGNtKSB7IHJldHVybiBjbS5yZWZyZXNoKCk7IH0sIHRydWUpOwogICAgb3B0aW9uKCJtYXhIaWdobGlnaHRMZW5ndGgiLCAxMDAwMCwgcmVzZXRNb2RlU3RhdGUsIHRydWUpOwogICAgb3B0aW9uKCJtb3ZlSW5wdXRXaXRoQ3Vyc29yIiwgdHJ1ZSwgZnVuY3Rpb24gKGNtLCB2YWwpIHsKICAgICAgaWYgKCF2YWwpIHsgY20uZGlzcGxheS5pbnB1dC5yZXNldFBvc2l0aW9uKCk7IH0KICAgIH0pOwoKICAgIG9wdGlvbigidGFiaW5kZXgiLCBudWxsLCBmdW5jdGlvbiAoY20sIHZhbCkgeyByZXR1cm4gY20uZGlzcGxheS5pbnB1dC5nZXRGaWVsZCgpLnRhYkluZGV4ID0gdmFsIHx8ICIiOyB9KTsKICAgIG9wdGlvbigiYXV0b2ZvY3VzIiwgbnVsbCk7CiAgICBvcHRpb24oImRpcmVjdGlvbiIsICJsdHIiLCBmdW5jdGlvbiAoY20sIHZhbCkgeyByZXR1cm4gY20uZG9jLnNldERpcmVjdGlvbih2YWwpOyB9LCB0cnVlKTsKICAgIG9wdGlvbigicGhyYXNlcyIsIG51bGwpOwogIH0KCiAgZnVuY3Rpb24gZHJhZ0Ryb3BDaGFuZ2VkKGNtLCB2YWx1ZSwgb2xkKSB7CiAgICB2YXIgd2FzT24gPSBvbGQgJiYgb2xkICE9IEluaXQ7CiAgICBpZiAoIXZhbHVlICE9ICF3YXNPbikgewogICAgICB2YXIgZnVuY3MgPSBjbS5kaXNwbGF5LmRyYWdGdW5jdGlvbnM7CiAgICAgIHZhciB0b2dnbGUgPSB2YWx1ZSA/IG9uIDogb2ZmOwogICAgICB0b2dnbGUoY20uZGlzcGxheS5zY3JvbGxlciwgImRyYWdzdGFydCIsIGZ1bmNzLnN0YXJ0KTsKICAgICAgdG9nZ2xlKGNtLmRpc3BsYXkuc2Nyb2xsZXIsICJkcmFnZW50ZXIiLCBmdW5jcy5lbnRlcik7CiAgICAgIHRvZ2dsZShjbS5kaXNwbGF5LnNjcm9sbGVyLCAiZHJhZ292ZXIiLCBmdW5jcy5vdmVyKTsKICAgICAgdG9nZ2xlKGNtLmRpc3BsYXkuc2Nyb2xsZXIsICJkcmFnbGVhdmUiLCBmdW5jcy5sZWF2ZSk7CiAgICAgIHRvZ2dsZShjbS5kaXNwbGF5LnNjcm9sbGVyLCAiZHJvcCIsIGZ1bmNzLmRyb3ApOwogICAgfQogIH0KCiAgZnVuY3Rpb24gd3JhcHBpbmdDaGFuZ2VkKGNtKSB7CiAgICBpZiAoY20ub3B0aW9ucy5saW5lV3JhcHBpbmcpIHsKICAgICAgYWRkQ2xhc3MoY20uZGlzcGxheS53cmFwcGVyLCAiQ29kZU1pcnJvci13cmFwIik7CiAgICAgIGNtLmRpc3BsYXkuc2l6ZXIuc3R5bGUubWluV2lkdGggPSAiIjsKICAgICAgY20uZGlzcGxheS5zaXplcldpZHRoID0gbnVsbDsKICAgIH0gZWxzZSB7CiAgICAgIHJtQ2xhc3MoY20uZGlzcGxheS53cmFwcGVyLCAiQ29kZU1pcnJvci13cmFwIik7CiAgICAgIGZpbmRNYXhMaW5lKGNtKTsKICAgIH0KICAgIGVzdGltYXRlTGluZUhlaWdodHMoY20pOwogICAgcmVnQ2hhbmdlKGNtKTsKICAgIGNsZWFyQ2FjaGVzKGNtKTsKICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgeyByZXR1cm4gdXBkYXRlU2Nyb2xsYmFycyhjbSk7IH0sIDEwMCk7CiAgfQoKICAvLyBBIENvZGVNaXJyb3IgaW5zdGFuY2UgcmVwcmVzZW50cyBhbiBlZGl0b3IuIFRoaXMgaXMgdGhlIG9iamVjdAogIC8vIHRoYXQgdXNlciBjb2RlIGlzIHVzdWFsbHkgZGVhbGluZyB3aXRoLgoKICBmdW5jdGlvbiBDb2RlTWlycm9yKHBsYWNlLCBvcHRpb25zKSB7CiAgICB2YXIgdGhpcyQxID0gdGhpczsKCiAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgQ29kZU1pcnJvcikpIHsgcmV0dXJuIG5ldyBDb2RlTWlycm9yKHBsYWNlLCBvcHRpb25zKSB9CgogICAgdGhpcy5vcHRpb25zID0gb3B0aW9ucyA9IG9wdGlvbnMgPyBjb3B5T2JqKG9wdGlvbnMpIDoge307CiAgICAvLyBEZXRlcm1pbmUgZWZmZWN0aXZlIG9wdGlvbnMgYmFzZWQgb24gZ2l2ZW4gdmFsdWVzIGFuZCBkZWZhdWx0cy4KICAgIGNvcHlPYmooZGVmYXVsdHMsIG9wdGlvbnMsIGZhbHNlKTsKCiAgICB2YXIgZG9jID0gb3B0aW9ucy52YWx1ZTsKICAgIGlmICh0eXBlb2YgZG9jID09ICJzdHJpbmciKSB7IGRvYyA9IG5ldyBEb2MoZG9jLCBvcHRpb25zLm1vZGUsIG51bGwsIG9wdGlvbnMubGluZVNlcGFyYXRvciwgb3B0aW9ucy5kaXJlY3Rpb24pOyB9CiAgICBlbHNlIGlmIChvcHRpb25zLm1vZGUpIHsgZG9jLm1vZGVPcHRpb24gPSBvcHRpb25zLm1vZGU7IH0KICAgIHRoaXMuZG9jID0gZG9jOwoKICAgIHZhciBpbnB1dCA9IG5ldyBDb2RlTWlycm9yLmlucHV0U3R5bGVzW29wdGlvbnMuaW5wdXRTdHlsZV0odGhpcyk7CiAgICB2YXIgZGlzcGxheSA9IHRoaXMuZGlzcGxheSA9IG5ldyBEaXNwbGF5KHBsYWNlLCBkb2MsIGlucHV0LCBvcHRpb25zKTsKICAgIGRpc3BsYXkud3JhcHBlci5Db2RlTWlycm9yID0gdGhpczsKICAgIHRoZW1lQ2hhbmdlZCh0aGlzKTsKICAgIGlmIChvcHRpb25zLmxpbmVXcmFwcGluZykKICAgICAgeyB0aGlzLmRpc3BsYXkud3JhcHBlci5jbGFzc05hbWUgKz0gIiBDb2RlTWlycm9yLXdyYXAiOyB9CiAgICBpbml0U2Nyb2xsYmFycyh0aGlzKTsKCiAgICB0aGlzLnN0YXRlID0gewogICAgICBrZXlNYXBzOiBbXSwgIC8vIHN0b3JlcyBtYXBzIGFkZGVkIGJ5IGFkZEtleU1hcAogICAgICBvdmVybGF5czogW10sIC8vIGhpZ2hsaWdodGluZyBvdmVybGF5cywgYXMgYWRkZWQgYnkgYWRkT3ZlcmxheQogICAgICBtb2RlR2VuOiAwLCAgIC8vIGJ1bXBlZCB3aGVuIG1vZGUvb3ZlcmxheSBjaGFuZ2VzLCB1c2VkIHRvIGludmFsaWRhdGUgaGlnaGxpZ2h0aW5nIGluZm8KICAgICAgb3ZlcndyaXRlOiBmYWxzZSwKICAgICAgZGVsYXlpbmdCbHVyRXZlbnQ6IGZhbHNlLAogICAgICBmb2N1c2VkOiBmYWxzZSwKICAgICAgc3VwcHJlc3NFZGl0czogZmFsc2UsIC8vIHVzZWQgdG8gZGlzYWJsZSBlZGl0aW5nIGR1cmluZyBrZXkgaGFuZGxlcnMgd2hlbiBpbiByZWFkT25seSBtb2RlCiAgICAgIHBhc3RlSW5jb21pbmc6IC0xLCBjdXRJbmNvbWluZzogLTEsIC8vIGhlbHAgcmVjb2duaXplIHBhc3RlL2N1dCBlZGl0cyBpbiBpbnB1dC5wb2xsCiAgICAgIHNlbGVjdGluZ1RleHQ6IGZhbHNlLAogICAgICBkcmFnZ2luZ1RleHQ6IGZhbHNlLAogICAgICBoaWdobGlnaHQ6IG5ldyBEZWxheWVkKCksIC8vIHN0b3JlcyBoaWdobGlnaHQgd29ya2VyIHRpbWVvdXQKICAgICAga2V5U2VxOiBudWxsLCAgLy8gVW5maW5pc2hlZCBrZXkgc2VxdWVuY2UKICAgICAgc3BlY2lhbENoYXJzOiBudWxsCiAgICB9OwoKICAgIGlmIChvcHRpb25zLmF1dG9mb2N1cyAmJiAhbW9iaWxlKSB7IGRpc3BsYXkuaW5wdXQuZm9jdXMoKTsgfQoKICAgIC8vIE92ZXJyaWRlIG1hZ2ljIHRleHRhcmVhIGNvbnRlbnQgcmVzdG9yZSB0aGF0IElFIHNvbWV0aW1lcyBkb2VzCiAgICAvLyBvbiBvdXIgaGlkZGVuIHRleHRhcmVhIG9uIHJlbG9hZAogICAgaWYgKGllICYmIGllX3ZlcnNpb24gPCAxMSkgeyBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsgcmV0dXJuIHRoaXMkMS5kaXNwbGF5LmlucHV0LnJlc2V0KHRydWUpOyB9LCAyMCk7IH0KCiAgICByZWdpc3RlckV2ZW50SGFuZGxlcnModGhpcyk7CiAgICBlbnN1cmVHbG9iYWxIYW5kbGVycygpOwoKICAgIHN0YXJ0T3BlcmF0aW9uKHRoaXMpOwogICAgdGhpcy5jdXJPcC5mb3JjZVVwZGF0ZSA9IHRydWU7CiAgICBhdHRhY2hEb2ModGhpcywgZG9jKTsKCiAgICBpZiAoKG9wdGlvbnMuYXV0b2ZvY3VzICYmICFtb2JpbGUpIHx8IHRoaXMuaGFzRm9jdXMoKSkKICAgICAgeyBzZXRUaW1lb3V0KGJpbmQob25Gb2N1cywgdGhpcyksIDIwKTsgfQogICAgZWxzZQogICAgICB7IG9uQmx1cih0aGlzKTsgfQoKICAgIGZvciAodmFyIG9wdCBpbiBvcHRpb25IYW5kbGVycykgeyBpZiAob3B0aW9uSGFuZGxlcnMuaGFzT3duUHJvcGVydHkob3B0KSkKICAgICAgeyBvcHRpb25IYW5kbGVyc1tvcHRdKHRoaXMkMSwgb3B0aW9uc1tvcHRdLCBJbml0KTsgfSB9CiAgICBtYXliZVVwZGF0ZUxpbmVOdW1iZXJXaWR0aCh0aGlzKTsKICAgIGlmIChvcHRpb25zLmZpbmlzaEluaXQpIHsgb3B0aW9ucy5maW5pc2hJbml0KHRoaXMpOyB9CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGluaXRIb29rcy5sZW5ndGg7ICsraSkgeyBpbml0SG9va3NbaV0odGhpcyQxKTsgfQogICAgZW5kT3BlcmF0aW9uKHRoaXMpOwogICAgLy8gU3VwcHJlc3Mgb3B0aW1pemVsZWdpYmlsaXR5IGluIFdlYmtpdCwgc2luY2UgaXQgYnJlYWtzIHRleHQKICAgIC8vIG1lYXN1cmluZyBvbiBsaW5lIHdyYXBwaW5nIGJvdW5kYXJpZXMuCiAgICBpZiAod2Via2l0ICYmIG9wdGlvbnMubGluZVdyYXBwaW5nICYmCiAgICAgICAgZ2V0Q29tcHV0ZWRTdHlsZShkaXNwbGF5LmxpbmVEaXYpLnRleHRSZW5kZXJpbmcgPT0gIm9wdGltaXplbGVnaWJpbGl0eSIpCiAgICAgIHsgZGlzcGxheS5saW5lRGl2LnN0eWxlLnRleHRSZW5kZXJpbmcgPSAiYXV0byI7IH0KICB9CgogIC8vIFRoZSBkZWZhdWx0IGNvbmZpZ3VyYXRpb24gb3B0aW9ucy4KICBDb2RlTWlycm9yLmRlZmF1bHRzID0gZGVmYXVsdHM7CiAgLy8gRnVuY3Rpb25zIHRvIHJ1biB3aGVuIG9wdGlvbnMgYXJlIGNoYW5nZWQuCiAgQ29kZU1pcnJvci5vcHRpb25IYW5kbGVycyA9IG9wdGlvbkhhbmRsZXJzOwoKICAvLyBBdHRhY2ggdGhlIG5lY2Vzc2FyeSBldmVudCBoYW5kbGVycyB3aGVuIGluaXRpYWxpemluZyB0aGUgZWRpdG9yCiAgZnVuY3Rpb24gcmVnaXN0ZXJFdmVudEhhbmRsZXJzKGNtKSB7CiAgICB2YXIgZCA9IGNtLmRpc3BsYXk7CiAgICBvbihkLnNjcm9sbGVyLCAibW91c2Vkb3duIiwgb3BlcmF0aW9uKGNtLCBvbk1vdXNlRG93bikpOwogICAgLy8gT2xkZXIgSUUncyB3aWxsIG5vdCBmaXJlIGEgc2Vjb25kIG1vdXNlZG93biBmb3IgYSBkb3VibGUgY2xpY2sKICAgIGlmIChpZSAmJiBpZV92ZXJzaW9uIDwgMTEpCiAgICAgIHsgb24oZC5zY3JvbGxlciwgImRibGNsaWNrIiwgb3BlcmF0aW9uKGNtLCBmdW5jdGlvbiAoZSkgewogICAgICAgIGlmIChzaWduYWxET01FdmVudChjbSwgZSkpIHsgcmV0dXJuIH0KICAgICAgICB2YXIgcG9zID0gcG9zRnJvbU1vdXNlKGNtLCBlKTsKICAgICAgICBpZiAoIXBvcyB8fCBjbGlja0luR3V0dGVyKGNtLCBlKSB8fCBldmVudEluV2lkZ2V0KGNtLmRpc3BsYXksIGUpKSB7IHJldHVybiB9CiAgICAgICAgZV9wcmV2ZW50RGVmYXVsdChlKTsKICAgICAgICB2YXIgd29yZCA9IGNtLmZpbmRXb3JkQXQocG9zKTsKICAgICAgICBleHRlbmRTZWxlY3Rpb24oY20uZG9jLCB3b3JkLmFuY2hvciwgd29yZC5oZWFkKTsKICAgICAgfSkpOyB9CiAgICBlbHNlCiAgICAgIHsgb24oZC5zY3JvbGxlciwgImRibGNsaWNrIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIHNpZ25hbERPTUV2ZW50KGNtLCBlKSB8fCBlX3ByZXZlbnREZWZhdWx0KGUpOyB9KTsgfQogICAgLy8gU29tZSBicm93c2VycyBmaXJlIGNvbnRleHRtZW51ICphZnRlciogb3BlbmluZyB0aGUgbWVudSwgYXQKICAgIC8vIHdoaWNoIHBvaW50IHdlIGNhbid0IG1lc3Mgd2l0aCBpdCBhbnltb3JlLiBDb250ZXh0IG1lbnUgaXMKICAgIC8vIGhhbmRsZWQgaW4gb25Nb3VzZURvd24gZm9yIHRoZXNlIGJyb3dzZXJzLgogICAgb24oZC5zY3JvbGxlciwgImNvbnRleHRtZW51IiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIG9uQ29udGV4dE1lbnUoY20sIGUpOyB9KTsKCiAgICAvLyBVc2VkIHRvIHN1cHByZXNzIG1vdXNlIGV2ZW50IGhhbmRsaW5nIHdoZW4gYSB0b3VjaCBoYXBwZW5zCiAgICB2YXIgdG91Y2hGaW5pc2hlZCwgcHJldlRvdWNoID0ge2VuZDogMH07CiAgICBmdW5jdGlvbiBmaW5pc2hUb3VjaCgpIHsKICAgICAgaWYgKGQuYWN0aXZlVG91Y2gpIHsKICAgICAgICB0b3VjaEZpbmlzaGVkID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7IHJldHVybiBkLmFjdGl2ZVRvdWNoID0gbnVsbDsgfSwgMTAwMCk7CiAgICAgICAgcHJldlRvdWNoID0gZC5hY3RpdmVUb3VjaDsKICAgICAgICBwcmV2VG91Y2guZW5kID0gK25ldyBEYXRlOwogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBpc01vdXNlTGlrZVRvdWNoRXZlbnQoZSkgewogICAgICBpZiAoZS50b3VjaGVzLmxlbmd0aCAhPSAxKSB7IHJldHVybiBmYWxzZSB9CiAgICAgIHZhciB0b3VjaCA9IGUudG91Y2hlc1swXTsKICAgICAgcmV0dXJuIHRvdWNoLnJhZGl1c1ggPD0gMSAmJiB0b3VjaC5yYWRpdXNZIDw9IDEKICAgIH0KICAgIGZ1bmN0aW9uIGZhckF3YXkodG91Y2gsIG90aGVyKSB7CiAgICAgIGlmIChvdGhlci5sZWZ0ID09IG51bGwpIHsgcmV0dXJuIHRydWUgfQogICAgICB2YXIgZHggPSBvdGhlci5sZWZ0IC0gdG91Y2gubGVmdCwgZHkgPSBvdGhlci50b3AgLSB0b3VjaC50b3A7CiAgICAgIHJldHVybiBkeCAqIGR4ICsgZHkgKiBkeSA+IDIwICogMjAKICAgIH0KICAgIG9uKGQuc2Nyb2xsZXIsICJ0b3VjaHN0YXJ0IiwgZnVuY3Rpb24gKGUpIHsKICAgICAgaWYgKCFzaWduYWxET01FdmVudChjbSwgZSkgJiYgIWlzTW91c2VMaWtlVG91Y2hFdmVudChlKSAmJiAhY2xpY2tJbkd1dHRlcihjbSwgZSkpIHsKICAgICAgICBkLmlucHV0LmVuc3VyZVBvbGxlZCgpOwogICAgICAgIGNsZWFyVGltZW91dCh0b3VjaEZpbmlzaGVkKTsKICAgICAgICB2YXIgbm93ID0gK25ldyBEYXRlOwogICAgICAgIGQuYWN0aXZlVG91Y2ggPSB7c3RhcnQ6IG5vdywgbW92ZWQ6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICAgcHJldjogbm93IC0gcHJldlRvdWNoLmVuZCA8PSAzMDAgPyBwcmV2VG91Y2ggOiBudWxsfTsKICAgICAgICBpZiAoZS50b3VjaGVzLmxlbmd0aCA9PSAxKSB7CiAgICAgICAgICBkLmFjdGl2ZVRvdWNoLmxlZnQgPSBlLnRvdWNoZXNbMF0ucGFnZVg7CiAgICAgICAgICBkLmFjdGl2ZVRvdWNoLnRvcCA9IGUudG91Y2hlc1swXS5wYWdlWTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogICAgb24oZC5zY3JvbGxlciwgInRvdWNobW92ZSIsIGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKGQuYWN0aXZlVG91Y2gpIHsgZC5hY3RpdmVUb3VjaC5tb3ZlZCA9IHRydWU7IH0KICAgIH0pOwogICAgb24oZC5zY3JvbGxlciwgInRvdWNoZW5kIiwgZnVuY3Rpb24gKGUpIHsKICAgICAgdmFyIHRvdWNoID0gZC5hY3RpdmVUb3VjaDsKICAgICAgaWYgKHRvdWNoICYmICFldmVudEluV2lkZ2V0KGQsIGUpICYmIHRvdWNoLmxlZnQgIT0gbnVsbCAmJgogICAgICAgICAgIXRvdWNoLm1vdmVkICYmIG5ldyBEYXRlIC0gdG91Y2guc3RhcnQgPCAzMDApIHsKICAgICAgICB2YXIgcG9zID0gY20uY29vcmRzQ2hhcihkLmFjdGl2ZVRvdWNoLCAicGFnZSIpLCByYW5nZTsKICAgICAgICBpZiAoIXRvdWNoLnByZXYgfHwgZmFyQXdheSh0b3VjaCwgdG91Y2gucHJldikpIC8vIFNpbmdsZSB0YXAKICAgICAgICAgIHsgcmFuZ2UgPSBuZXcgUmFuZ2UocG9zLCBwb3MpOyB9CiAgICAgICAgZWxzZSBpZiAoIXRvdWNoLnByZXYucHJldiB8fCBmYXJBd2F5KHRvdWNoLCB0b3VjaC5wcmV2LnByZXYpKSAvLyBEb3VibGUgdGFwCiAgICAgICAgICB7IHJhbmdlID0gY20uZmluZFdvcmRBdChwb3MpOyB9CiAgICAgICAgZWxzZSAvLyBUcmlwbGUgdGFwCiAgICAgICAgICB7IHJhbmdlID0gbmV3IFJhbmdlKFBvcyhwb3MubGluZSwgMCksIGNsaXBQb3MoY20uZG9jLCBQb3MocG9zLmxpbmUgKyAxLCAwKSkpOyB9CiAgICAgICAgY20uc2V0U2VsZWN0aW9uKHJhbmdlLmFuY2hvciwgcmFuZ2UuaGVhZCk7CiAgICAgICAgY20uZm9jdXMoKTsKICAgICAgICBlX3ByZXZlbnREZWZhdWx0KGUpOwogICAgICB9CiAgICAgIGZpbmlzaFRvdWNoKCk7CiAgICB9KTsKICAgIG9uKGQuc2Nyb2xsZXIsICJ0b3VjaGNhbmNlbCIsIGZpbmlzaFRvdWNoKTsKCiAgICAvLyBTeW5jIHNjcm9sbGluZyBiZXR3ZWVuIGZha2Ugc2Nyb2xsYmFycyBhbmQgcmVhbCBzY3JvbGxhYmxlCiAgICAvLyBhcmVhLCBlbnN1cmUgdmlld3BvcnQgaXMgdXBkYXRlZCB3aGVuIHNjcm9sbGluZy4KICAgIG9uKGQuc2Nyb2xsZXIsICJzY3JvbGwiLCBmdW5jdGlvbiAoKSB7CiAgICAgIGlmIChkLnNjcm9sbGVyLmNsaWVudEhlaWdodCkgewogICAgICAgIHVwZGF0ZVNjcm9sbFRvcChjbSwgZC5zY3JvbGxlci5zY3JvbGxUb3ApOwogICAgICAgIHNldFNjcm9sbExlZnQoY20sIGQuc2Nyb2xsZXIuc2Nyb2xsTGVmdCwgdHJ1ZSk7CiAgICAgICAgc2lnbmFsKGNtLCAic2Nyb2xsIiwgY20pOwogICAgICB9CiAgICB9KTsKCiAgICAvLyBMaXN0ZW4gdG8gd2hlZWwgZXZlbnRzIGluIG9yZGVyIHRvIHRyeSBhbmQgdXBkYXRlIHRoZSB2aWV3cG9ydCBvbiB0aW1lLgogICAgb24oZC5zY3JvbGxlciwgIm1vdXNld2hlZWwiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gb25TY3JvbGxXaGVlbChjbSwgZSk7IH0pOwogICAgb24oZC5zY3JvbGxlciwgIkRPTU1vdXNlU2Nyb2xsIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIG9uU2Nyb2xsV2hlZWwoY20sIGUpOyB9KTsKCiAgICAvLyBQcmV2ZW50IHdyYXBwZXIgZnJvbSBldmVyIHNjcm9sbGluZwogICAgb24oZC53cmFwcGVyLCAic2Nyb2xsIiwgZnVuY3Rpb24gKCkgeyByZXR1cm4gZC53cmFwcGVyLnNjcm9sbFRvcCA9IGQud3JhcHBlci5zY3JvbGxMZWZ0ID0gMDsgfSk7CgogICAgZC5kcmFnRnVuY3Rpb25zID0gewogICAgICBlbnRlcjogZnVuY3Rpb24gKGUpIHtpZiAoIXNpZ25hbERPTUV2ZW50KGNtLCBlKSkgeyBlX3N0b3AoZSk7IH19LAogICAgICBvdmVyOiBmdW5jdGlvbiAoZSkge2lmICghc2lnbmFsRE9NRXZlbnQoY20sIGUpKSB7IG9uRHJhZ092ZXIoY20sIGUpOyBlX3N0b3AoZSk7IH19LAogICAgICBzdGFydDogZnVuY3Rpb24gKGUpIHsgcmV0dXJuIG9uRHJhZ1N0YXJ0KGNtLCBlKTsgfSwKICAgICAgZHJvcDogb3BlcmF0aW9uKGNtLCBvbkRyb3ApLAogICAgICBsZWF2ZTogZnVuY3Rpb24gKGUpIHtpZiAoIXNpZ25hbERPTUV2ZW50KGNtLCBlKSkgeyBjbGVhckRyYWdDdXJzb3IoY20pOyB9fQogICAgfTsKCiAgICB2YXIgaW5wID0gZC5pbnB1dC5nZXRGaWVsZCgpOwogICAgb24oaW5wLCAia2V5dXAiLCBmdW5jdGlvbiAoZSkgeyByZXR1cm4gb25LZXlVcC5jYWxsKGNtLCBlKTsgfSk7CiAgICBvbihpbnAsICJrZXlkb3duIiwgb3BlcmF0aW9uKGNtLCBvbktleURvd24pKTsKICAgIG9uKGlucCwgImtleXByZXNzIiwgb3BlcmF0aW9uKGNtLCBvbktleVByZXNzKSk7CiAgICBvbihpbnAsICJmb2N1cyIsIGZ1bmN0aW9uIChlKSB7IHJldHVybiBvbkZvY3VzKGNtLCBlKTsgfSk7CiAgICBvbihpbnAsICJibHVyIiwgZnVuY3Rpb24gKGUpIHsgcmV0dXJuIG9uQmx1cihjbSwgZSk7IH0pOwogIH0KCiAgdmFyIGluaXRIb29rcyA9IFtdOwogIENvZGVNaXJyb3IuZGVmaW5lSW5pdEhvb2sgPSBmdW5jdGlvbiAoZikgeyByZXR1cm4gaW5pdEhvb2tzLnB1c2goZik7IH07CgogIC8vIEluZGVudCB0aGUgZ2l2ZW4gbGluZS4gVGhlIGhvdyBwYXJhbWV0ZXIgY2FuIGJlICJzbWFydCIsCiAgLy8gImFkZCIvbnVsbCwgInN1YnRyYWN0Iiwgb3IgInByZXYiLiBXaGVuIGFnZ3Jlc3NpdmUgaXMgZmFsc2UKICAvLyAodHlwaWNhbGx5IHNldCB0byB0cnVlIGZvciBmb3JjZWQgc2luZ2xlLWxpbmUgaW5kZW50cyksIGVtcHR5CiAgLy8gbGluZXMgYXJlIG5vdCBpbmRlbnRlZCwgYW5kIHBsYWNlcyB3aGVyZSB0aGUgbW9kZSByZXR1cm5zIFBhc3MKICAvLyBhcmUgbGVmdCBhbG9uZS4KICBmdW5jdGlvbiBpbmRlbnRMaW5lKGNtLCBuLCBob3csIGFnZ3Jlc3NpdmUpIHsKICAgIHZhciBkb2MgPSBjbS5kb2MsIHN0YXRlOwogICAgaWYgKGhvdyA9PSBudWxsKSB7IGhvdyA9ICJhZGQiOyB9CiAgICBpZiAoaG93ID09ICJzbWFydCIpIHsKICAgICAgLy8gRmFsbCBiYWNrIHRvICJwcmV2IiB3aGVuIHRoZSBtb2RlIGRvZXNuJ3QgaGF2ZSBhbiBpbmRlbnRhdGlvbgogICAgICAvLyBtZXRob2QuCiAgICAgIGlmICghZG9jLm1vZGUuaW5kZW50KSB7IGhvdyA9ICJwcmV2IjsgfQogICAgICBlbHNlIHsgc3RhdGUgPSBnZXRDb250ZXh0QmVmb3JlKGNtLCBuKS5zdGF0ZTsgfQogICAgfQoKICAgIHZhciB0YWJTaXplID0gY20ub3B0aW9ucy50YWJTaXplOwogICAgdmFyIGxpbmUgPSBnZXRMaW5lKGRvYywgbiksIGN1clNwYWNlID0gY291bnRDb2x1bW4obGluZS50ZXh0LCBudWxsLCB0YWJTaXplKTsKICAgIGlmIChsaW5lLnN0YXRlQWZ0ZXIpIHsgbGluZS5zdGF0ZUFmdGVyID0gbnVsbDsgfQogICAgdmFyIGN1clNwYWNlU3RyaW5nID0gbGluZS50ZXh0Lm1hdGNoKC9eXHMqLylbMF0sIGluZGVudGF0aW9uOwogICAgaWYgKCFhZ2dyZXNzaXZlICYmICEvXFMvLnRlc3QobGluZS50ZXh0KSkgewogICAgICBpbmRlbnRhdGlvbiA9IDA7CiAgICAgIGhvdyA9ICJub3QiOwogICAgfSBlbHNlIGlmIChob3cgPT0gInNtYXJ0IikgewogICAgICBpbmRlbnRhdGlvbiA9IGRvYy5tb2RlLmluZGVudChzdGF0ZSwgbGluZS50ZXh0LnNsaWNlKGN1clNwYWNlU3RyaW5nLmxlbmd0aCksIGxpbmUudGV4dCk7CiAgICAgIGlmIChpbmRlbnRhdGlvbiA9PSBQYXNzIHx8IGluZGVudGF0aW9uID4gMTUwKSB7CiAgICAgICAgaWYgKCFhZ2dyZXNzaXZlKSB7IHJldHVybiB9CiAgICAgICAgaG93ID0gInByZXYiOwogICAgICB9CiAgICB9CiAgICBpZiAoaG93ID09ICJwcmV2IikgewogICAgICBpZiAobiA+IGRvYy5maXJzdCkgeyBpbmRlbnRhdGlvbiA9IGNvdW50Q29sdW1uKGdldExpbmUoZG9jLCBuLTEpLnRleHQsIG51bGwsIHRhYlNpemUpOyB9CiAgICAgIGVsc2UgeyBpbmRlbnRhdGlvbiA9IDA7IH0KICAgIH0gZWxzZSBpZiAoaG93ID09ICJhZGQiKSB7CiAgICAgIGluZGVudGF0aW9uID0gY3VyU3BhY2UgKyBjbS5vcHRpb25zLmluZGVudFVuaXQ7CiAgICB9IGVsc2UgaWYgKGhvdyA9PSAic3VidHJhY3QiKSB7CiAgICAgIGluZGVudGF0aW9uID0gY3VyU3BhY2UgLSBjbS5vcHRpb25zLmluZGVudFVuaXQ7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiBob3cgPT0gIm51bWJlciIpIHsKICAgICAgaW5kZW50YXRpb24gPSBjdXJTcGFjZSArIGhvdzsKICAgIH0KICAgIGluZGVudGF0aW9uID0gTWF0aC5tYXgoMCwgaW5kZW50YXRpb24pOwoKICAgIHZhciBpbmRlbnRTdHJpbmcgPSAiIiwgcG9zID0gMDsKICAgIGlmIChjbS5vcHRpb25zLmluZGVudFdpdGhUYWJzKQogICAgICB7IGZvciAodmFyIGkgPSBNYXRoLmZsb29yKGluZGVudGF0aW9uIC8gdGFiU2l6ZSk7IGk7IC0taSkge3BvcyArPSB0YWJTaXplOyBpbmRlbnRTdHJpbmcgKz0gIlx0Ijt9IH0KICAgIGlmIChwb3MgPCBpbmRlbnRhdGlvbikgeyBpbmRlbnRTdHJpbmcgKz0gc3BhY2VTdHIoaW5kZW50YXRpb24gLSBwb3MpOyB9CgogICAgaWYgKGluZGVudFN0cmluZyAhPSBjdXJTcGFjZVN0cmluZykgewogICAgICByZXBsYWNlUmFuZ2UoZG9jLCBpbmRlbnRTdHJpbmcsIFBvcyhuLCAwKSwgUG9zKG4sIGN1clNwYWNlU3RyaW5nLmxlbmd0aCksICIraW5wdXQiKTsKICAgICAgbGluZS5zdGF0ZUFmdGVyID0gbnVsbDsKICAgICAgcmV0dXJuIHRydWUKICAgIH0gZWxzZSB7CiAgICAgIC8vIEVuc3VyZSB0aGF0LCBpZiB0aGUgY3Vyc29yIHdhcyBpbiB0aGUgd2hpdGVzcGFjZSBhdCB0aGUgc3RhcnQKICAgICAgLy8gb2YgdGhlIGxpbmUsIGl0IGlzIG1vdmVkIHRvIHRoZSBlbmQgb2YgdGhhdCBzcGFjZS4KICAgICAgZm9yICh2YXIgaSQxID0gMDsgaSQxIDwgZG9jLnNlbC5yYW5nZXMubGVuZ3RoOyBpJDErKykgewogICAgICAgIHZhciByYW5nZSA9IGRvYy5zZWwucmFuZ2VzW2kkMV07CiAgICAgICAgaWYgKHJhbmdlLmhlYWQubGluZSA9PSBuICYmIHJhbmdlLmhlYWQuY2ggPCBjdXJTcGFjZVN0cmluZy5sZW5ndGgpIHsKICAgICAgICAgIHZhciBwb3MkMSA9IFBvcyhuLCBjdXJTcGFjZVN0cmluZy5sZW5ndGgpOwogICAgICAgICAgcmVwbGFjZU9uZVNlbGVjdGlvbihkb2MsIGkkMSwgbmV3IFJhbmdlKHBvcyQxLCBwb3MkMSkpOwogICAgICAgICAgYnJlYWsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CgogIC8vIFRoaXMgd2lsbCBiZSBzZXQgdG8gYSB7bGluZVdpc2U6IGJvb2wsIHRleHQ6IFtzdHJpbmddfSBvYmplY3QsIHNvCiAgLy8gdGhhdCwgd2hlbiBwYXN0aW5nLCB3ZSBrbm93IHdoYXQga2luZCBvZiBzZWxlY3Rpb25zIHRoZSBjb3BpZWQKICAvLyB0ZXh0IHdhcyBtYWRlIG91dCBvZi4KICB2YXIgbGFzdENvcGllZCA9IG51bGw7CgogIGZ1bmN0aW9uIHNldExhc3RDb3BpZWQobmV3TGFzdENvcGllZCkgewogICAgbGFzdENvcGllZCA9IG5ld0xhc3RDb3BpZWQ7CiAgfQoKICBmdW5jdGlvbiBhcHBseVRleHRJbnB1dChjbSwgaW5zZXJ0ZWQsIGRlbGV0ZWQsIHNlbCwgb3JpZ2luKSB7CiAgICB2YXIgZG9jID0gY20uZG9jOwogICAgY20uZGlzcGxheS5zaGlmdCA9IGZhbHNlOwogICAgaWYgKCFzZWwpIHsgc2VsID0gZG9jLnNlbDsgfQoKICAgIHZhciByZWNlbnQgPSArbmV3IERhdGUgLSAyMDA7CiAgICB2YXIgcGFzdGUgPSBvcmlnaW4gPT0gInBhc3RlIiB8fCBjbS5zdGF0ZS5wYXN0ZUluY29taW5nID4gcmVjZW50OwogICAgdmFyIHRleHRMaW5lcyA9IHNwbGl0TGluZXNBdXRvKGluc2VydGVkKSwgbXVsdGlQYXN0ZSA9IG51bGw7CiAgICAvLyBXaGVuIHBhc3RpbmcgTiBsaW5lcyBpbnRvIE4gc2VsZWN0aW9ucywgaW5zZXJ0IG9uZSBsaW5lIHBlciBzZWxlY3Rpb24KICAgIGlmIChwYXN0ZSAmJiBzZWwucmFuZ2VzLmxlbmd0aCA+IDEpIHsKICAgICAgaWYgKGxhc3RDb3BpZWQgJiYgbGFzdENvcGllZC50ZXh0LmpvaW4oIlxuIikgPT0gaW5zZXJ0ZWQpIHsKICAgICAgICBpZiAoc2VsLnJhbmdlcy5sZW5ndGggJSBsYXN0Q29waWVkLnRleHQubGVuZ3RoID09IDApIHsKICAgICAgICAgIG11bHRpUGFzdGUgPSBbXTsKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGFzdENvcGllZC50ZXh0Lmxlbmd0aDsgaSsrKQogICAgICAgICAgICB7IG11bHRpUGFzdGUucHVzaChkb2Muc3BsaXRMaW5lcyhsYXN0Q29waWVkLnRleHRbaV0pKTsgfQogICAgICAgIH0KICAgICAgfSBlbHNlIGlmICh0ZXh0TGluZXMubGVuZ3RoID09IHNlbC5yYW5nZXMubGVuZ3RoICYmIGNtLm9wdGlvbnMucGFzdGVMaW5lc1BlclNlbGVjdGlvbikgewogICAgICAgIG11bHRpUGFzdGUgPSBtYXAodGV4dExpbmVzLCBmdW5jdGlvbiAobCkgeyByZXR1cm4gW2xdOyB9KTsKICAgICAgfQogICAgfQoKICAgIHZhciB1cGRhdGVJbnB1dCA9IGNtLmN1ck9wLnVwZGF0ZUlucHV0OwogICAgLy8gTm9ybWFsIGJlaGF2aW9yIGlzIHRvIGluc2VydCB0aGUgbmV3IHRleHQgaW50byBldmVyeSBzZWxlY3Rpb24KICAgIGZvciAodmFyIGkkMSA9IHNlbC5yYW5nZXMubGVuZ3RoIC0gMTsgaSQxID49IDA7IGkkMS0tKSB7CiAgICAgIHZhciByYW5nZSQkMSA9IHNlbC5yYW5nZXNbaSQxXTsKICAgICAgdmFyIGZyb20gPSByYW5nZSQkMS5mcm9tKCksIHRvID0gcmFuZ2UkJDEudG8oKTsKICAgICAgaWYgKHJhbmdlJCQxLmVtcHR5KCkpIHsKICAgICAgICBpZiAoZGVsZXRlZCAmJiBkZWxldGVkID4gMCkgLy8gSGFuZGxlIGRlbGV0aW9uCiAgICAgICAgICB7IGZyb20gPSBQb3MoZnJvbS5saW5lLCBmcm9tLmNoIC0gZGVsZXRlZCk7IH0KICAgICAgICBlbHNlIGlmIChjbS5zdGF0ZS5vdmVyd3JpdGUgJiYgIXBhc3RlKSAvLyBIYW5kbGUgb3ZlcndyaXRlCiAgICAgICAgICB7IHRvID0gUG9zKHRvLmxpbmUsIE1hdGgubWluKGdldExpbmUoZG9jLCB0by5saW5lKS50ZXh0Lmxlbmd0aCwgdG8uY2ggKyBsc3QodGV4dExpbmVzKS5sZW5ndGgpKTsgfQogICAgICAgIGVsc2UgaWYgKHBhc3RlICYmIGxhc3RDb3BpZWQgJiYgbGFzdENvcGllZC5saW5lV2lzZSAmJiBsYXN0Q29waWVkLnRleHQuam9pbigiXG4iKSA9PSBpbnNlcnRlZCkKICAgICAgICAgIHsgZnJvbSA9IHRvID0gUG9zKGZyb20ubGluZSwgMCk7IH0KICAgICAgfQogICAgICB2YXIgY2hhbmdlRXZlbnQgPSB7ZnJvbTogZnJvbSwgdG86IHRvLCB0ZXh0OiBtdWx0aVBhc3RlID8gbXVsdGlQYXN0ZVtpJDEgJSBtdWx0aVBhc3RlLmxlbmd0aF0gOiB0ZXh0TGluZXMsCiAgICAgICAgICAgICAgICAgICAgICAgICBvcmlnaW46IG9yaWdpbiB8fCAocGFzdGUgPyAicGFzdGUiIDogY20uc3RhdGUuY3V0SW5jb21pbmcgPiByZWNlbnQgPyAiY3V0IiA6ICIraW5wdXQiKX07CiAgICAgIG1ha2VDaGFuZ2UoY20uZG9jLCBjaGFuZ2VFdmVudCk7CiAgICAgIHNpZ25hbExhdGVyKGNtLCAiaW5wdXRSZWFkIiwgY20sIGNoYW5nZUV2ZW50KTsKICAgIH0KICAgIGlmIChpbnNlcnRlZCAmJiAhcGFzdGUpCiAgICAgIHsgdHJpZ2dlckVsZWN0cmljKGNtLCBpbnNlcnRlZCk7IH0KCiAgICBlbnN1cmVDdXJzb3JWaXNpYmxlKGNtKTsKICAgIGlmIChjbS5jdXJPcC51cGRhdGVJbnB1dCA8IDIpIHsgY20uY3VyT3AudXBkYXRlSW5wdXQgPSB1cGRhdGVJbnB1dDsgfQogICAgY20uY3VyT3AudHlwaW5nID0gdHJ1ZTsKICAgIGNtLnN0YXRlLnBhc3RlSW5jb21pbmcgPSBjbS5zdGF0ZS5jdXRJbmNvbWluZyA9IC0xOwogIH0KCiAgZnVuY3Rpb24gaGFuZGxlUGFzdGUoZSwgY20pIHsKICAgIHZhciBwYXN0ZWQgPSBlLmNsaXBib2FyZERhdGEgJiYgZS5jbGlwYm9hcmREYXRhLmdldERhdGEoIlRleHQiKTsKICAgIGlmIChwYXN0ZWQpIHsKICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICBpZiAoIWNtLmlzUmVhZE9ubHkoKSAmJiAhY20ub3B0aW9ucy5kaXNhYmxlSW5wdXQpCiAgICAgICAgeyBydW5Jbk9wKGNtLCBmdW5jdGlvbiAoKSB7IHJldHVybiBhcHBseVRleHRJbnB1dChjbSwgcGFzdGVkLCAwLCBudWxsLCAicGFzdGUiKTsgfSk7IH0KICAgICAgcmV0dXJuIHRydWUKICAgIH0KICB9CgogIGZ1bmN0aW9uIHRyaWdnZXJFbGVjdHJpYyhjbSwgaW5zZXJ0ZWQpIHsKICAgIC8vIFdoZW4gYW4gJ2VsZWN0cmljJyBjaGFyYWN0ZXIgaXMgaW5zZXJ0ZWQsIGltbWVkaWF0ZWx5IHRyaWdnZXIgYSByZWluZGVudAogICAgaWYgKCFjbS5vcHRpb25zLmVsZWN0cmljQ2hhcnMgfHwgIWNtLm9wdGlvbnMuc21hcnRJbmRlbnQpIHsgcmV0dXJuIH0KICAgIHZhciBzZWwgPSBjbS5kb2Muc2VsOwoKICAgIGZvciAodmFyIGkgPSBzZWwucmFuZ2VzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgIHZhciByYW5nZSQkMSA9IHNlbC5yYW5nZXNbaV07CiAgICAgIGlmIChyYW5nZSQkMS5oZWFkLmNoID4gMTAwIHx8IChpICYmIHNlbC5yYW5nZXNbaSAtIDFdLmhlYWQubGluZSA9PSByYW5nZSQkMS5oZWFkLmxpbmUpKSB7IGNvbnRpbnVlIH0KICAgICAgdmFyIG1vZGUgPSBjbS5nZXRNb2RlQXQocmFuZ2UkJDEuaGVhZCk7CiAgICAgIHZhciBpbmRlbnRlZCA9IGZhbHNlOwogICAgICBpZiAobW9kZS5lbGVjdHJpY0NoYXJzKSB7CiAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBtb2RlLmVsZWN0cmljQ2hhcnMubGVuZ3RoOyBqKyspCiAgICAgICAgICB7IGlmIChpbnNlcnRlZC5pbmRleE9mKG1vZGUuZWxlY3RyaWNDaGFycy5jaGFyQXQoaikpID4gLTEpIHsKICAgICAgICAgICAgaW5kZW50ZWQgPSBpbmRlbnRMaW5lKGNtLCByYW5nZSQkMS5oZWFkLmxpbmUsICJzbWFydCIpOwogICAgICAgICAgICBicmVhawogICAgICAgICAgfSB9CiAgICAgIH0gZWxzZSBpZiAobW9kZS5lbGVjdHJpY0lucHV0KSB7CiAgICAgICAgaWYgKG1vZGUuZWxlY3RyaWNJbnB1dC50ZXN0KGdldExpbmUoY20uZG9jLCByYW5nZSQkMS5oZWFkLmxpbmUpLnRleHQuc2xpY2UoMCwgcmFuZ2UkJDEuaGVhZC5jaCkpKQogICAgICAgICAgeyBpbmRlbnRlZCA9IGluZGVudExpbmUoY20sIHJhbmdlJCQxLmhlYWQubGluZSwgInNtYXJ0Iik7IH0KICAgICAgfQogICAgICBpZiAoaW5kZW50ZWQpIHsgc2lnbmFsTGF0ZXIoY20sICJlbGVjdHJpY0lucHV0IiwgY20sIHJhbmdlJCQxLmhlYWQubGluZSk7IH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIGNvcHlhYmxlUmFuZ2VzKGNtKSB7CiAgICB2YXIgdGV4dCA9IFtdLCByYW5nZXMgPSBbXTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY20uZG9jLnNlbC5yYW5nZXMubGVuZ3RoOyBpKyspIHsKICAgICAgdmFyIGxpbmUgPSBjbS5kb2Muc2VsLnJhbmdlc1tpXS5oZWFkLmxpbmU7CiAgICAgIHZhciBsaW5lUmFuZ2UgPSB7YW5jaG9yOiBQb3MobGluZSwgMCksIGhlYWQ6IFBvcyhsaW5lICsgMSwgMCl9OwogICAgICByYW5nZXMucHVzaChsaW5lUmFuZ2UpOwogICAgICB0ZXh0LnB1c2goY20uZ2V0UmFuZ2UobGluZVJhbmdlLmFuY2hvciwgbGluZVJhbmdlLmhlYWQpKTsKICAgIH0KICAgIHJldHVybiB7dGV4dDogdGV4dCwgcmFuZ2VzOiByYW5nZXN9CiAgfQoKICBmdW5jdGlvbiBkaXNhYmxlQnJvd3Nlck1hZ2ljKGZpZWxkLCBzcGVsbGNoZWNrLCBhdXRvY29ycmVjdCwgYXV0b2NhcGl0YWxpemUpIHsKICAgIGZpZWxkLnNldEF0dHJpYnV0ZSgiYXV0b2NvcnJlY3QiLCBhdXRvY29ycmVjdCA/ICIiIDogIm9mZiIpOwogICAgZmllbGQuc2V0QXR0cmlidXRlKCJhdXRvY2FwaXRhbGl6ZSIsIGF1dG9jYXBpdGFsaXplID8gIiIgOiAib2ZmIik7CiAgICBmaWVsZC5zZXRBdHRyaWJ1dGUoInNwZWxsY2hlY2siLCAhIXNwZWxsY2hlY2spOwogIH0KCiAgZnVuY3Rpb24gaGlkZGVuVGV4dGFyZWEoKSB7CiAgICB2YXIgdGUgPSBlbHQoInRleHRhcmVhIiwgbnVsbCwgbnVsbCwgInBvc2l0aW9uOiBhYnNvbHV0ZTsgYm90dG9tOiAtMWVtOyBwYWRkaW5nOiAwOyB3aWR0aDogMXB4OyBoZWlnaHQ6IDFlbTsgb3V0bGluZTogbm9uZSIpOwogICAgdmFyIGRpdiA9IGVsdCgiZGl2IiwgW3RlXSwgbnVsbCwgIm92ZXJmbG93OiBoaWRkZW47IHBvc2l0aW9uOiByZWxhdGl2ZTsgd2lkdGg6IDNweDsgaGVpZ2h0OiAwcHg7Iik7CiAgICAvLyBUaGUgdGV4dGFyZWEgaXMga2VwdCBwb3NpdGlvbmVkIG5lYXIgdGhlIGN1cnNvciB0byBwcmV2ZW50IHRoZQogICAgLy8gZmFjdCB0aGF0IGl0J2xsIGJlIHNjcm9sbGVkIGludG8gdmlldyBvbiBpbnB1dCBmcm9tIHNjcm9sbGluZwogICAgLy8gb3VyIGZha2UgY3Vyc29yIG91dCBvZiB2aWV3LiBPbiB3ZWJraXQsIHdoZW4gd3JhcD1vZmYsIHBhc3RlIGlzCiAgICAvLyB2ZXJ5IHNsb3cuIFNvIG1ha2UgdGhlIGFyZWEgd2lkZSBpbnN0ZWFkLgogICAgaWYgKHdlYmtpdCkgeyB0ZS5zdHlsZS53aWR0aCA9ICIxMDAwcHgiOyB9CiAgICBlbHNlIHsgdGUuc2V0QXR0cmlidXRlKCJ3cmFwIiwgIm9mZiIpOyB9CiAgICAvLyBJZiBib3JkZXI6IDA7IC0tIGlPUyBmYWlscyB0byBvcGVuIGtleWJvYXJkIChpc3N1ZSAjMTI4NykKICAgIGlmIChpb3MpIHsgdGUuc3R5bGUuYm9yZGVyID0gIjFweCBzb2xpZCBibGFjayI7IH0KICAgIGRpc2FibGVCcm93c2VyTWFnaWModGUpOwogICAgcmV0dXJuIGRpdgogIH0KCiAgLy8gVGhlIHB1YmxpY2x5IHZpc2libGUgQVBJLiBOb3RlIHRoYXQgbWV0aG9kT3AoZikgbWVhbnMKICAvLyAnd3JhcCBmIGluIGFuIG9wZXJhdGlvbiwgcGVyZm9ybWVkIG9uIGl0cyBgdGhpc2AgcGFyYW1ldGVyJy4KCiAgLy8gVGhpcyBpcyBub3QgdGhlIGNvbXBsZXRlIHNldCBvZiBlZGl0b3IgbWV0aG9kcy4gTW9zdCBvZiB0aGUKICAvLyBtZXRob2RzIGRlZmluZWQgb24gdGhlIERvYyB0eXBlIGFyZSBhbHNvIGluamVjdGVkIGludG8KICAvLyBDb2RlTWlycm9yLnByb3RvdHlwZSwgZm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5IGFuZAogIC8vIGNvbnZlbmllbmNlLgoKICBmdW5jdGlvbiBhZGRFZGl0b3JNZXRob2RzKENvZGVNaXJyb3IpIHsKICAgIHZhciBvcHRpb25IYW5kbGVycyA9IENvZGVNaXJyb3Iub3B0aW9uSGFuZGxlcnM7CgogICAgdmFyIGhlbHBlcnMgPSBDb2RlTWlycm9yLmhlbHBlcnMgPSB7fTsKCiAgICBDb2RlTWlycm9yLnByb3RvdHlwZSA9IHsKICAgICAgY29uc3RydWN0b3I6IENvZGVNaXJyb3IsCiAgICAgIGZvY3VzOiBmdW5jdGlvbigpe3dpbmRvdy5mb2N1cygpOyB0aGlzLmRpc3BsYXkuaW5wdXQuZm9jdXMoKTt9LAoKICAgICAgc2V0T3B0aW9uOiBmdW5jdGlvbihvcHRpb24sIHZhbHVlKSB7CiAgICAgICAgdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsIG9sZCA9IG9wdGlvbnNbb3B0aW9uXTsKICAgICAgICBpZiAob3B0aW9uc1tvcHRpb25dID09IHZhbHVlICYmIG9wdGlvbiAhPSAibW9kZSIpIHsgcmV0dXJuIH0KICAgICAgICBvcHRpb25zW29wdGlvbl0gPSB2YWx1ZTsKICAgICAgICBpZiAob3B0aW9uSGFuZGxlcnMuaGFzT3duUHJvcGVydHkob3B0aW9uKSkKICAgICAgICAgIHsgb3BlcmF0aW9uKHRoaXMsIG9wdGlvbkhhbmRsZXJzW29wdGlvbl0pKHRoaXMsIHZhbHVlLCBvbGQpOyB9CiAgICAgICAgc2lnbmFsKHRoaXMsICJvcHRpb25DaGFuZ2UiLCB0aGlzLCBvcHRpb24pOwogICAgICB9LAoKICAgICAgZ2V0T3B0aW9uOiBmdW5jdGlvbihvcHRpb24pIHtyZXR1cm4gdGhpcy5vcHRpb25zW29wdGlvbl19LAogICAgICBnZXREb2M6IGZ1bmN0aW9uKCkge3JldHVybiB0aGlzLmRvY30sCgogICAgICBhZGRLZXlNYXA6IGZ1bmN0aW9uKG1hcCQkMSwgYm90dG9tKSB7CiAgICAgICAgdGhpcy5zdGF0ZS5rZXlNYXBzW2JvdHRvbSA/ICJwdXNoIiA6ICJ1bnNoaWZ0Il0oZ2V0S2V5TWFwKG1hcCQkMSkpOwogICAgICB9LAogICAgICByZW1vdmVLZXlNYXA6IGZ1bmN0aW9uKG1hcCQkMSkgewogICAgICAgIHZhciBtYXBzID0gdGhpcy5zdGF0ZS5rZXlNYXBzOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbWFwcy5sZW5ndGg7ICsraSkKICAgICAgICAgIHsgaWYgKG1hcHNbaV0gPT0gbWFwJCQxIHx8IG1hcHNbaV0ubmFtZSA9PSBtYXAkJDEpIHsKICAgICAgICAgICAgbWFwcy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgIHJldHVybiB0cnVlCiAgICAgICAgICB9IH0KICAgICAgfSwKCiAgICAgIGFkZE92ZXJsYXk6IG1ldGhvZE9wKGZ1bmN0aW9uKHNwZWMsIG9wdGlvbnMpIHsKICAgICAgICB2YXIgbW9kZSA9IHNwZWMudG9rZW4gPyBzcGVjIDogQ29kZU1pcnJvci5nZXRNb2RlKHRoaXMub3B0aW9ucywgc3BlYyk7CiAgICAgICAgaWYgKG1vZGUuc3RhcnRTdGF0ZSkgeyB0aHJvdyBuZXcgRXJyb3IoIk92ZXJsYXlzIG1heSBub3QgYmUgc3RhdGVmdWwuIikgfQogICAgICAgIGluc2VydFNvcnRlZCh0aGlzLnN0YXRlLm92ZXJsYXlzLAogICAgICAgICAgICAgICAgICAgICB7bW9kZTogbW9kZSwgbW9kZVNwZWM6IHNwZWMsIG9wYXF1ZTogb3B0aW9ucyAmJiBvcHRpb25zLm9wYXF1ZSwKICAgICAgICAgICAgICAgICAgICAgIHByaW9yaXR5OiAob3B0aW9ucyAmJiBvcHRpb25zLnByaW9yaXR5KSB8fCAwfSwKICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKG92ZXJsYXkpIHsgcmV0dXJuIG92ZXJsYXkucHJpb3JpdHk7IH0pOwogICAgICAgIHRoaXMuc3RhdGUubW9kZUdlbisrOwogICAgICAgIHJlZ0NoYW5nZSh0aGlzKTsKICAgICAgfSksCiAgICAgIHJlbW92ZU92ZXJsYXk6IG1ldGhvZE9wKGZ1bmN0aW9uKHNwZWMpIHsKICAgICAgICB2YXIgdGhpcyQxID0gdGhpczsKCiAgICAgICAgdmFyIG92ZXJsYXlzID0gdGhpcy5zdGF0ZS5vdmVybGF5czsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG92ZXJsYXlzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICB2YXIgY3VyID0gb3ZlcmxheXNbaV0ubW9kZVNwZWM7CiAgICAgICAgICBpZiAoY3VyID09IHNwZWMgfHwgdHlwZW9mIHNwZWMgPT0gInN0cmluZyIgJiYgY3VyLm5hbWUgPT0gc3BlYykgewogICAgICAgICAgICBvdmVybGF5cy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgIHRoaXMkMS5zdGF0ZS5tb2RlR2VuKys7CiAgICAgICAgICAgIHJlZ0NoYW5nZSh0aGlzJDEpOwogICAgICAgICAgICByZXR1cm4KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pLAoKICAgICAgaW5kZW50TGluZTogbWV0aG9kT3AoZnVuY3Rpb24obiwgZGlyLCBhZ2dyZXNzaXZlKSB7CiAgICAgICAgaWYgKHR5cGVvZiBkaXIgIT0gInN0cmluZyIgJiYgdHlwZW9mIGRpciAhPSAibnVtYmVyIikgewogICAgICAgICAgaWYgKGRpciA9PSBudWxsKSB7IGRpciA9IHRoaXMub3B0aW9ucy5zbWFydEluZGVudCA/ICJzbWFydCIgOiAicHJldiI7IH0KICAgICAgICAgIGVsc2UgeyBkaXIgPSBkaXIgPyAiYWRkIiA6ICJzdWJ0cmFjdCI7IH0KICAgICAgICB9CiAgICAgICAgaWYgKGlzTGluZSh0aGlzLmRvYywgbikpIHsgaW5kZW50TGluZSh0aGlzLCBuLCBkaXIsIGFnZ3Jlc3NpdmUpOyB9CiAgICAgIH0pLAogICAgICBpbmRlbnRTZWxlY3Rpb246IG1ldGhvZE9wKGZ1bmN0aW9uKGhvdykgewogICAgICAgIHZhciB0aGlzJDEgPSB0aGlzOwoKICAgICAgICB2YXIgcmFuZ2VzID0gdGhpcy5kb2Muc2VsLnJhbmdlcywgZW5kID0gLTE7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByYW5nZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHZhciByYW5nZSQkMSA9IHJhbmdlc1tpXTsKICAgICAgICAgIGlmICghcmFuZ2UkJDEuZW1wdHkoKSkgewogICAgICAgICAgICB2YXIgZnJvbSA9IHJhbmdlJCQxLmZyb20oKSwgdG8gPSByYW5nZSQkMS50bygpOwogICAgICAgICAgICB2YXIgc3RhcnQgPSBNYXRoLm1heChlbmQsIGZyb20ubGluZSk7CiAgICAgICAgICAgIGVuZCA9IE1hdGgubWluKHRoaXMkMS5sYXN0TGluZSgpLCB0by5saW5lIC0gKHRvLmNoID8gMCA6IDEpKSArIDE7CiAgICAgICAgICAgIGZvciAodmFyIGogPSBzdGFydDsgaiA8IGVuZDsgKytqKQogICAgICAgICAgICAgIHsgaW5kZW50TGluZSh0aGlzJDEsIGosIGhvdyk7IH0KICAgICAgICAgICAgdmFyIG5ld1JhbmdlcyA9IHRoaXMkMS5kb2Muc2VsLnJhbmdlczsKICAgICAgICAgICAgaWYgKGZyb20uY2ggPT0gMCAmJiByYW5nZXMubGVuZ3RoID09IG5ld1Jhbmdlcy5sZW5ndGggJiYgbmV3UmFuZ2VzW2ldLmZyb20oKS5jaCA+IDApCiAgICAgICAgICAgICAgeyByZXBsYWNlT25lU2VsZWN0aW9uKHRoaXMkMS5kb2MsIGksIG5ldyBSYW5nZShmcm9tLCBuZXdSYW5nZXNbaV0udG8oKSksIHNlbF9kb250U2Nyb2xsKTsgfQogICAgICAgICAgfSBlbHNlIGlmIChyYW5nZSQkMS5oZWFkLmxpbmUgPiBlbmQpIHsKICAgICAgICAgICAgaW5kZW50TGluZSh0aGlzJDEsIHJhbmdlJCQxLmhlYWQubGluZSwgaG93LCB0cnVlKTsKICAgICAgICAgICAgZW5kID0gcmFuZ2UkJDEuaGVhZC5saW5lOwogICAgICAgICAgICBpZiAoaSA9PSB0aGlzJDEuZG9jLnNlbC5wcmltSW5kZXgpIHsgZW5zdXJlQ3Vyc29yVmlzaWJsZSh0aGlzJDEpOyB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KSwKCiAgICAgIC8vIEZldGNoIHRoZSBwYXJzZXIgdG9rZW4gZm9yIGEgZ2l2ZW4gY2hhcmFjdGVyLiBVc2VmdWwgZm9yIGhhY2tzCiAgICAgIC8vIHRoYXQgd2FudCB0byBpbnNwZWN0IHRoZSBtb2RlIHN0YXRlIChzYXksIGZvciBjb21wbGV0aW9uKS4KICAgICAgZ2V0VG9rZW5BdDogZnVuY3Rpb24ocG9zLCBwcmVjaXNlKSB7CiAgICAgICAgcmV0dXJuIHRha2VUb2tlbih0aGlzLCBwb3MsIHByZWNpc2UpCiAgICAgIH0sCgogICAgICBnZXRMaW5lVG9rZW5zOiBmdW5jdGlvbihsaW5lLCBwcmVjaXNlKSB7CiAgICAgICAgcmV0dXJuIHRha2VUb2tlbih0aGlzLCBQb3MobGluZSksIHByZWNpc2UsIHRydWUpCiAgICAgIH0sCgogICAgICBnZXRUb2tlblR5cGVBdDogZnVuY3Rpb24ocG9zKSB7CiAgICAgICAgcG9zID0gY2xpcFBvcyh0aGlzLmRvYywgcG9zKTsKICAgICAgICB2YXIgc3R5bGVzID0gZ2V0TGluZVN0eWxlcyh0aGlzLCBnZXRMaW5lKHRoaXMuZG9jLCBwb3MubGluZSkpOwogICAgICAgIHZhciBiZWZvcmUgPSAwLCBhZnRlciA9IChzdHlsZXMubGVuZ3RoIC0gMSkgLyAyLCBjaCA9IHBvcy5jaDsKICAgICAgICB2YXIgdHlwZTsKICAgICAgICBpZiAoY2ggPT0gMCkgeyB0eXBlID0gc3R5bGVzWzJdOyB9CiAgICAgICAgZWxzZSB7IGZvciAoOzspIHsKICAgICAgICAgIHZhciBtaWQgPSAoYmVmb3JlICsgYWZ0ZXIpID4+IDE7CiAgICAgICAgICBpZiAoKG1pZCA/IHN0eWxlc1ttaWQgKiAyIC0gMV0gOiAwKSA+PSBjaCkgeyBhZnRlciA9IG1pZDsgfQogICAgICAgICAgZWxzZSBpZiAoc3R5bGVzW21pZCAqIDIgKyAxXSA8IGNoKSB7IGJlZm9yZSA9IG1pZCArIDE7IH0KICAgICAgICAgIGVsc2UgeyB0eXBlID0gc3R5bGVzW21pZCAqIDIgKyAyXTsgYnJlYWsgfQogICAgICAgIH0gfQogICAgICAgIHZhciBjdXQgPSB0eXBlID8gdHlwZS5pbmRleE9mKCJvdmVybGF5ICIpIDogLTE7CiAgICAgICAgcmV0dXJuIGN1dCA8IDAgPyB0eXBlIDogY3V0ID09IDAgPyBudWxsIDogdHlwZS5zbGljZSgwLCBjdXQgLSAxKQogICAgICB9LAoKICAgICAgZ2V0TW9kZUF0OiBmdW5jdGlvbihwb3MpIHsKICAgICAgICB2YXIgbW9kZSA9IHRoaXMuZG9jLm1vZGU7CiAgICAgICAgaWYgKCFtb2RlLmlubmVyTW9kZSkgeyByZXR1cm4gbW9kZSB9CiAgICAgICAgcmV0dXJuIENvZGVNaXJyb3IuaW5uZXJNb2RlKG1vZGUsIHRoaXMuZ2V0VG9rZW5BdChwb3MpLnN0YXRlKS5tb2RlCiAgICAgIH0sCgogICAgICBnZXRIZWxwZXI6IGZ1bmN0aW9uKHBvcywgdHlwZSkgewogICAgICAgIHJldHVybiB0aGlzLmdldEhlbHBlcnMocG9zLCB0eXBlKVswXQogICAgICB9LAoKICAgICAgZ2V0SGVscGVyczogZnVuY3Rpb24ocG9zLCB0eXBlKSB7CiAgICAgICAgdmFyIHRoaXMkMSA9IHRoaXM7CgogICAgICAgIHZhciBmb3VuZCA9IFtdOwogICAgICAgIGlmICghaGVscGVycy5oYXNPd25Qcm9wZXJ0eSh0eXBlKSkgeyByZXR1cm4gZm91bmQgfQogICAgICAgIHZhciBoZWxwID0gaGVscGVyc1t0eXBlXSwgbW9kZSA9IHRoaXMuZ2V0TW9kZUF0KHBvcyk7CiAgICAgICAgaWYgKHR5cGVvZiBtb2RlW3R5cGVdID09ICJzdHJpbmciKSB7CiAgICAgICAgICBpZiAoaGVscFttb2RlW3R5cGVdXSkgeyBmb3VuZC5wdXNoKGhlbHBbbW9kZVt0eXBlXV0pOyB9CiAgICAgICAgfSBlbHNlIGlmIChtb2RlW3R5cGVdKSB7CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG1vZGVbdHlwZV0ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFyIHZhbCA9IGhlbHBbbW9kZVt0eXBlXVtpXV07CiAgICAgICAgICAgIGlmICh2YWwpIHsgZm91bmQucHVzaCh2YWwpOyB9CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChtb2RlLmhlbHBlclR5cGUgJiYgaGVscFttb2RlLmhlbHBlclR5cGVdKSB7CiAgICAgICAgICBmb3VuZC5wdXNoKGhlbHBbbW9kZS5oZWxwZXJUeXBlXSk7CiAgICAgICAgfSBlbHNlIGlmIChoZWxwW21vZGUubmFtZV0pIHsKICAgICAgICAgIGZvdW5kLnB1c2goaGVscFttb2RlLm5hbWVdKTsKICAgICAgICB9CiAgICAgICAgZm9yICh2YXIgaSQxID0gMDsgaSQxIDwgaGVscC5fZ2xvYmFsLmxlbmd0aDsgaSQxKyspIHsKICAgICAgICAgIHZhciBjdXIgPSBoZWxwLl9nbG9iYWxbaSQxXTsKICAgICAgICAgIGlmIChjdXIucHJlZChtb2RlLCB0aGlzJDEpICYmIGluZGV4T2YoZm91bmQsIGN1ci52YWwpID09IC0xKQogICAgICAgICAgICB7IGZvdW5kLnB1c2goY3VyLnZhbCk7IH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZvdW5kCiAgICAgIH0sCgogICAgICBnZXRTdGF0ZUFmdGVyOiBmdW5jdGlvbihsaW5lLCBwcmVjaXNlKSB7CiAgICAgICAgdmFyIGRvYyA9IHRoaXMuZG9jOwogICAgICAgIGxpbmUgPSBjbGlwTGluZShkb2MsIGxpbmUgPT0gbnVsbCA/IGRvYy5maXJzdCArIGRvYy5zaXplIC0gMTogbGluZSk7CiAgICAgICAgcmV0dXJuIGdldENvbnRleHRCZWZvcmUodGhpcywgbGluZSArIDEsIHByZWNpc2UpLnN0YXRlCiAgICAgIH0sCgogICAgICBjdXJzb3JDb29yZHM6IGZ1bmN0aW9uKHN0YXJ0LCBtb2RlKSB7CiAgICAgICAgdmFyIHBvcywgcmFuZ2UkJDEgPSB0aGlzLmRvYy5zZWwucHJpbWFyeSgpOwogICAgICAgIGlmIChzdGFydCA9PSBudWxsKSB7IHBvcyA9IHJhbmdlJCQxLmhlYWQ7IH0KICAgICAgICBlbHNlIGlmICh0eXBlb2Ygc3RhcnQgPT0gIm9iamVjdCIpIHsgcG9zID0gY2xpcFBvcyh0aGlzLmRvYywgc3RhcnQpOyB9CiAgICAgICAgZWxzZSB7IHBvcyA9IHN0YXJ0ID8gcmFuZ2UkJDEuZnJvbSgpIDogcmFuZ2UkJDEudG8oKTsgfQogICAgICAgIHJldHVybiBjdXJzb3JDb29yZHModGhpcywgcG9zLCBtb2RlIHx8ICJwYWdlIikKICAgICAgfSwKCiAgICAgIGNoYXJDb29yZHM6IGZ1bmN0aW9uKHBvcywgbW9kZSkgewogICAgICAgIHJldHVybiBjaGFyQ29vcmRzKHRoaXMsIGNsaXBQb3ModGhpcy5kb2MsIHBvcyksIG1vZGUgfHwgInBhZ2UiKQogICAgICB9LAoKICAgICAgY29vcmRzQ2hhcjogZnVuY3Rpb24oY29vcmRzLCBtb2RlKSB7CiAgICAgICAgY29vcmRzID0gZnJvbUNvb3JkU3lzdGVtKHRoaXMsIGNvb3JkcywgbW9kZSB8fCAicGFnZSIpOwogICAgICAgIHJldHVybiBjb29yZHNDaGFyKHRoaXMsIGNvb3Jkcy5sZWZ0LCBjb29yZHMudG9wKQogICAgICB9LAoKICAgICAgbGluZUF0SGVpZ2h0OiBmdW5jdGlvbihoZWlnaHQsIG1vZGUpIHsKICAgICAgICBoZWlnaHQgPSBmcm9tQ29vcmRTeXN0ZW0odGhpcywge3RvcDogaGVpZ2h0LCBsZWZ0OiAwfSwgbW9kZSB8fCAicGFnZSIpLnRvcDsKICAgICAgICByZXR1cm4gbGluZUF0SGVpZ2h0KHRoaXMuZG9jLCBoZWlnaHQgKyB0aGlzLmRpc3BsYXkudmlld09mZnNldCkKICAgICAgfSwKICAgICAgaGVpZ2h0QXRMaW5lOiBmdW5jdGlvbihsaW5lLCBtb2RlLCBpbmNsdWRlV2lkZ2V0cykgewogICAgICAgIHZhciBlbmQgPSBmYWxzZSwgbGluZU9iajsKICAgICAgICBpZiAodHlwZW9mIGxpbmUgPT0gIm51bWJlciIpIHsKICAgICAgICAgIHZhciBsYXN0ID0gdGhpcy5kb2MuZmlyc3QgKyB0aGlzLmRvYy5zaXplIC0gMTsKICAgICAgICAgIGlmIChsaW5lIDwgdGhpcy5kb2MuZmlyc3QpIHsgbGluZSA9IHRoaXMuZG9jLmZpcnN0OyB9CiAgICAgICAgICBlbHNlIGlmIChsaW5lID4gbGFzdCkgeyBsaW5lID0gbGFzdDsgZW5kID0gdHJ1ZTsgfQogICAgICAgICAgbGluZU9iaiA9IGdldExpbmUodGhpcy5kb2MsIGxpbmUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBsaW5lT2JqID0gbGluZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGludG9Db29yZFN5c3RlbSh0aGlzLCBsaW5lT2JqLCB7dG9wOiAwLCBsZWZ0OiAwfSwgbW9kZSB8fCAicGFnZSIsIGluY2x1ZGVXaWRnZXRzIHx8IGVuZCkudG9wICsKICAgICAgICAgIChlbmQgPyB0aGlzLmRvYy5oZWlnaHQgLSBoZWlnaHRBdExpbmUobGluZU9iaikgOiAwKQogICAgICB9LAoKICAgICAgZGVmYXVsdFRleHRIZWlnaHQ6IGZ1bmN0aW9uKCkgeyByZXR1cm4gdGV4dEhlaWdodCh0aGlzLmRpc3BsYXkpIH0sCiAgICAgIGRlZmF1bHRDaGFyV2lkdGg6IGZ1bmN0aW9uKCkgeyByZXR1cm4gY2hhcldpZHRoKHRoaXMuZGlzcGxheSkgfSwKCiAgICAgIGdldFZpZXdwb3J0OiBmdW5jdGlvbigpIHsgcmV0dXJuIHtmcm9tOiB0aGlzLmRpc3BsYXkudmlld0Zyb20sIHRvOiB0aGlzLmRpc3BsYXkudmlld1RvfX0sCgogICAgICBhZGRXaWRnZXQ6IGZ1bmN0aW9uKHBvcywgbm9kZSwgc2Nyb2xsLCB2ZXJ0LCBob3JpeikgewogICAgICAgIHZhciBkaXNwbGF5ID0gdGhpcy5kaXNwbGF5OwogICAgICAgIHBvcyA9IGN1cnNvckNvb3Jkcyh0aGlzLCBjbGlwUG9zKHRoaXMuZG9jLCBwb3MpKTsKICAgICAgICB2YXIgdG9wID0gcG9zLmJvdHRvbSwgbGVmdCA9IHBvcy5sZWZ0OwogICAgICAgIG5vZGUuc3R5bGUucG9zaXRpb24gPSAiYWJzb2x1dGUiOwogICAgICAgIG5vZGUuc2V0QXR0cmlidXRlKCJjbS1pZ25vcmUtZXZlbnRzIiwgInRydWUiKTsKICAgICAgICB0aGlzLmRpc3BsYXkuaW5wdXQuc2V0VW5lZGl0YWJsZShub2RlKTsKICAgICAgICBkaXNwbGF5LnNpemVyLmFwcGVuZENoaWxkKG5vZGUpOwogICAgICAgIGlmICh2ZXJ0ID09ICJvdmVyIikgewogICAgICAgICAgdG9wID0gcG9zLnRvcDsKICAgICAgICB9IGVsc2UgaWYgKHZlcnQgPT0gImFib3ZlIiB8fCB2ZXJ0ID09ICJuZWFyIikgewogICAgICAgICAgdmFyIHZzcGFjZSA9IE1hdGgubWF4KGRpc3BsYXkud3JhcHBlci5jbGllbnRIZWlnaHQsIHRoaXMuZG9jLmhlaWdodCksCiAgICAgICAgICBoc3BhY2UgPSBNYXRoLm1heChkaXNwbGF5LnNpemVyLmNsaWVudFdpZHRoLCBkaXNwbGF5LmxpbmVTcGFjZS5jbGllbnRXaWR0aCk7CiAgICAgICAgICAvLyBEZWZhdWx0IHRvIHBvc2l0aW9uaW5nIGFib3ZlIChpZiBzcGVjaWZpZWQgYW5kIHBvc3NpYmxlKTsgb3RoZXJ3aXNlIGRlZmF1bHQgdG8gcG9zaXRpb25pbmcgYmVsb3cKICAgICAgICAgIGlmICgodmVydCA9PSAnYWJvdmUnIHx8IHBvcy5ib3R0b20gKyBub2RlLm9mZnNldEhlaWdodCA+IHZzcGFjZSkgJiYgcG9zLnRvcCA+IG5vZGUub2Zmc2V0SGVpZ2h0KQogICAgICAgICAgICB7IHRvcCA9IHBvcy50b3AgLSBub2RlLm9mZnNldEhlaWdodDsgfQogICAgICAgICAgZWxzZSBpZiAocG9zLmJvdHRvbSArIG5vZGUub2Zmc2V0SGVpZ2h0IDw9IHZzcGFjZSkKICAgICAgICAgICAgeyB0b3AgPSBwb3MuYm90dG9tOyB9CiAgICAgICAgICBpZiAobGVmdCArIG5vZGUub2Zmc2V0V2lkdGggPiBoc3BhY2UpCiAgICAgICAgICAgIHsgbGVmdCA9IGhzcGFjZSAtIG5vZGUub2Zmc2V0V2lkdGg7IH0KICAgICAgICB9CiAgICAgICAgbm9kZS5zdHlsZS50b3AgPSB0b3AgKyAicHgiOwogICAgICAgIG5vZGUuc3R5bGUubGVmdCA9IG5vZGUuc3R5bGUucmlnaHQgPSAiIjsKICAgICAgICBpZiAoaG9yaXogPT0gInJpZ2h0IikgewogICAgICAgICAgbGVmdCA9IGRpc3BsYXkuc2l6ZXIuY2xpZW50V2lkdGggLSBub2RlLm9mZnNldFdpZHRoOwogICAgICAgICAgbm9kZS5zdHlsZS5yaWdodCA9ICIwcHgiOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAoaG9yaXogPT0gImxlZnQiKSB7IGxlZnQgPSAwOyB9CiAgICAgICAgICBlbHNlIGlmIChob3JpeiA9PSAibWlkZGxlIikgeyBsZWZ0ID0gKGRpc3BsYXkuc2l6ZXIuY2xpZW50V2lkdGggLSBub2RlLm9mZnNldFdpZHRoKSAvIDI7IH0KICAgICAgICAgIG5vZGUuc3R5bGUubGVmdCA9IGxlZnQgKyAicHgiOwogICAgICAgIH0KICAgICAgICBpZiAoc2Nyb2xsKQogICAgICAgICAgeyBzY3JvbGxJbnRvVmlldyh0aGlzLCB7bGVmdDogbGVmdCwgdG9wOiB0b3AsIHJpZ2h0OiBsZWZ0ICsgbm9kZS5vZmZzZXRXaWR0aCwgYm90dG9tOiB0b3AgKyBub2RlLm9mZnNldEhlaWdodH0pOyB9CiAgICAgIH0sCgogICAgICB0cmlnZ2VyT25LZXlEb3duOiBtZXRob2RPcChvbktleURvd24pLAogICAgICB0cmlnZ2VyT25LZXlQcmVzczogbWV0aG9kT3Aob25LZXlQcmVzcyksCiAgICAgIHRyaWdnZXJPbktleVVwOiBvbktleVVwLAogICAgICB0cmlnZ2VyT25Nb3VzZURvd246IG1ldGhvZE9wKG9uTW91c2VEb3duKSwKCiAgICAgIGV4ZWNDb21tYW5kOiBmdW5jdGlvbihjbWQpIHsKICAgICAgICBpZiAoY29tbWFuZHMuaGFzT3duUHJvcGVydHkoY21kKSkKICAgICAgICAgIHsgcmV0dXJuIGNvbW1hbmRzW2NtZF0uY2FsbChudWxsLCB0aGlzKSB9CiAgICAgIH0sCgogICAgICB0cmlnZ2VyRWxlY3RyaWM6IG1ldGhvZE9wKGZ1bmN0aW9uKHRleHQpIHsgdHJpZ2dlckVsZWN0cmljKHRoaXMsIHRleHQpOyB9KSwKCiAgICAgIGZpbmRQb3NIOiBmdW5jdGlvbihmcm9tLCBhbW91bnQsIHVuaXQsIHZpc3VhbGx5KSB7CiAgICAgICAgdmFyIHRoaXMkMSA9IHRoaXM7CgogICAgICAgIHZhciBkaXIgPSAxOwogICAgICAgIGlmIChhbW91bnQgPCAwKSB7IGRpciA9IC0xOyBhbW91bnQgPSAtYW1vdW50OyB9CiAgICAgICAgdmFyIGN1ciA9IGNsaXBQb3ModGhpcy5kb2MsIGZyb20pOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYW1vdW50OyArK2kpIHsKICAgICAgICAgIGN1ciA9IGZpbmRQb3NIKHRoaXMkMS5kb2MsIGN1ciwgZGlyLCB1bml0LCB2aXN1YWxseSk7CiAgICAgICAgICBpZiAoY3VyLmhpdFNpZGUpIHsgYnJlYWsgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gY3VyCiAgICAgIH0sCgogICAgICBtb3ZlSDogbWV0aG9kT3AoZnVuY3Rpb24oZGlyLCB1bml0KSB7CiAgICAgICAgdmFyIHRoaXMkMSA9IHRoaXM7CgogICAgICAgIHRoaXMuZXh0ZW5kU2VsZWN0aW9uc0J5KGZ1bmN0aW9uIChyYW5nZSQkMSkgewogICAgICAgICAgaWYgKHRoaXMkMS5kaXNwbGF5LnNoaWZ0IHx8IHRoaXMkMS5kb2MuZXh0ZW5kIHx8IHJhbmdlJCQxLmVtcHR5KCkpCiAgICAgICAgICAgIHsgcmV0dXJuIGZpbmRQb3NIKHRoaXMkMS5kb2MsIHJhbmdlJCQxLmhlYWQsIGRpciwgdW5pdCwgdGhpcyQxLm9wdGlvbnMucnRsTW92ZVZpc3VhbGx5KSB9CiAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsgcmV0dXJuIGRpciA8IDAgPyByYW5nZSQkMS5mcm9tKCkgOiByYW5nZSQkMS50bygpIH0KICAgICAgICB9LCBzZWxfbW92ZSk7CiAgICAgIH0pLAoKICAgICAgZGVsZXRlSDogbWV0aG9kT3AoZnVuY3Rpb24oZGlyLCB1bml0KSB7CiAgICAgICAgdmFyIHNlbCA9IHRoaXMuZG9jLnNlbCwgZG9jID0gdGhpcy5kb2M7CiAgICAgICAgaWYgKHNlbC5zb21ldGhpbmdTZWxlY3RlZCgpKQogICAgICAgICAgeyBkb2MucmVwbGFjZVNlbGVjdGlvbigiIiwgbnVsbCwgIitkZWxldGUiKTsgfQogICAgICAgIGVsc2UKICAgICAgICAgIHsgZGVsZXRlTmVhclNlbGVjdGlvbih0aGlzLCBmdW5jdGlvbiAocmFuZ2UkJDEpIHsKICAgICAgICAgICAgdmFyIG90aGVyID0gZmluZFBvc0goZG9jLCByYW5nZSQkMS5oZWFkLCBkaXIsIHVuaXQsIGZhbHNlKTsKICAgICAgICAgICAgcmV0dXJuIGRpciA8IDAgPyB7ZnJvbTogb3RoZXIsIHRvOiByYW5nZSQkMS5oZWFkfSA6IHtmcm9tOiByYW5nZSQkMS5oZWFkLCB0bzogb3RoZXJ9CiAgICAgICAgICB9KTsgfQogICAgICB9KSwKCiAgICAgIGZpbmRQb3NWOiBmdW5jdGlvbihmcm9tLCBhbW91bnQsIHVuaXQsIGdvYWxDb2x1bW4pIHsKICAgICAgICB2YXIgdGhpcyQxID0gdGhpczsKCiAgICAgICAgdmFyIGRpciA9IDEsIHggPSBnb2FsQ29sdW1uOwogICAgICAgIGlmIChhbW91bnQgPCAwKSB7IGRpciA9IC0xOyBhbW91bnQgPSAtYW1vdW50OyB9CiAgICAgICAgdmFyIGN1ciA9IGNsaXBQb3ModGhpcy5kb2MsIGZyb20pOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYW1vdW50OyArK2kpIHsKICAgICAgICAgIHZhciBjb29yZHMgPSBjdXJzb3JDb29yZHModGhpcyQxLCBjdXIsICJkaXYiKTsKICAgICAgICAgIGlmICh4ID09IG51bGwpIHsgeCA9IGNvb3Jkcy5sZWZ0OyB9CiAgICAgICAgICBlbHNlIHsgY29vcmRzLmxlZnQgPSB4OyB9CiAgICAgICAgICBjdXIgPSBmaW5kUG9zVih0aGlzJDEsIGNvb3JkcywgZGlyLCB1bml0KTsKICAgICAgICAgIGlmIChjdXIuaGl0U2lkZSkgeyBicmVhayB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBjdXIKICAgICAgfSwKCiAgICAgIG1vdmVWOiBtZXRob2RPcChmdW5jdGlvbihkaXIsIHVuaXQpIHsKICAgICAgICB2YXIgdGhpcyQxID0gdGhpczsKCiAgICAgICAgdmFyIGRvYyA9IHRoaXMuZG9jLCBnb2FscyA9IFtdOwogICAgICAgIHZhciBjb2xsYXBzZSA9ICF0aGlzLmRpc3BsYXkuc2hpZnQgJiYgIWRvYy5leHRlbmQgJiYgZG9jLnNlbC5zb21ldGhpbmdTZWxlY3RlZCgpOwogICAgICAgIGRvYy5leHRlbmRTZWxlY3Rpb25zQnkoZnVuY3Rpb24gKHJhbmdlJCQxKSB7CiAgICAgICAgICBpZiAoY29sbGFwc2UpCiAgICAgICAgICAgIHsgcmV0dXJuIGRpciA8IDAgPyByYW5nZSQkMS5mcm9tKCkgOiByYW5nZSQkMS50bygpIH0KICAgICAgICAgIHZhciBoZWFkUG9zID0gY3Vyc29yQ29vcmRzKHRoaXMkMSwgcmFuZ2UkJDEuaGVhZCwgImRpdiIpOwogICAgICAgICAgaWYgKHJhbmdlJCQxLmdvYWxDb2x1bW4gIT0gbnVsbCkgeyBoZWFkUG9zLmxlZnQgPSByYW5nZSQkMS5nb2FsQ29sdW1uOyB9CiAgICAgICAgICBnb2Fscy5wdXNoKGhlYWRQb3MubGVmdCk7CiAgICAgICAgICB2YXIgcG9zID0gZmluZFBvc1YodGhpcyQxLCBoZWFkUG9zLCBkaXIsIHVuaXQpOwogICAgICAgICAgaWYgKHVuaXQgPT0gInBhZ2UiICYmIHJhbmdlJCQxID09IGRvYy5zZWwucHJpbWFyeSgpKQogICAgICAgICAgICB7IGFkZFRvU2Nyb2xsVG9wKHRoaXMkMSwgY2hhckNvb3Jkcyh0aGlzJDEsIHBvcywgImRpdiIpLnRvcCAtIGhlYWRQb3MudG9wKTsgfQogICAgICAgICAgcmV0dXJuIHBvcwogICAgICAgIH0sIHNlbF9tb3ZlKTsKICAgICAgICBpZiAoZ29hbHMubGVuZ3RoKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgZG9jLnNlbC5yYW5nZXMubGVuZ3RoOyBpKyspCiAgICAgICAgICB7IGRvYy5zZWwucmFuZ2VzW2ldLmdvYWxDb2x1bW4gPSBnb2Fsc1tpXTsgfSB9CiAgICAgIH0pLAoKICAgICAgLy8gRmluZCB0aGUgd29yZCBhdCB0aGUgZ2l2ZW4gcG9zaXRpb24gKGFzIHJldHVybmVkIGJ5IGNvb3Jkc0NoYXIpLgogICAgICBmaW5kV29yZEF0OiBmdW5jdGlvbihwb3MpIHsKICAgICAgICB2YXIgZG9jID0gdGhpcy5kb2MsIGxpbmUgPSBnZXRMaW5lKGRvYywgcG9zLmxpbmUpLnRleHQ7CiAgICAgICAgdmFyIHN0YXJ0ID0gcG9zLmNoLCBlbmQgPSBwb3MuY2g7CiAgICAgICAgaWYgKGxpbmUpIHsKICAgICAgICAgIHZhciBoZWxwZXIgPSB0aGlzLmdldEhlbHBlcihwb3MsICJ3b3JkQ2hhcnMiKTsKICAgICAgICAgIGlmICgocG9zLnN0aWNreSA9PSAiYmVmb3JlIiB8fCBlbmQgPT0gbGluZS5sZW5ndGgpICYmIHN0YXJ0KSB7IC0tc3RhcnQ7IH0gZWxzZSB7ICsrZW5kOyB9CiAgICAgICAgICB2YXIgc3RhcnRDaGFyID0gbGluZS5jaGFyQXQoc3RhcnQpOwogICAgICAgICAgdmFyIGNoZWNrID0gaXNXb3JkQ2hhcihzdGFydENoYXIsIGhlbHBlcikKICAgICAgICAgICAgPyBmdW5jdGlvbiAoY2gpIHsgcmV0dXJuIGlzV29yZENoYXIoY2gsIGhlbHBlcik7IH0KICAgICAgICAgICAgOiAvXHMvLnRlc3Qoc3RhcnRDaGFyKSA/IGZ1bmN0aW9uIChjaCkgeyByZXR1cm4gL1xzLy50ZXN0KGNoKTsgfQogICAgICAgICAgICA6IGZ1bmN0aW9uIChjaCkgeyByZXR1cm4gKCEvXHMvLnRlc3QoY2gpICYmICFpc1dvcmRDaGFyKGNoKSk7IH07CiAgICAgICAgICB3aGlsZSAoc3RhcnQgPiAwICYmIGNoZWNrKGxpbmUuY2hhckF0KHN0YXJ0IC0gMSkpKSB7IC0tc3RhcnQ7IH0KICAgICAgICAgIHdoaWxlIChlbmQgPCBsaW5lLmxlbmd0aCAmJiBjaGVjayhsaW5lLmNoYXJBdChlbmQpKSkgeyArK2VuZDsgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IFJhbmdlKFBvcyhwb3MubGluZSwgc3RhcnQpLCBQb3MocG9zLmxpbmUsIGVuZCkpCiAgICAgIH0sCgogICAgICB0b2dnbGVPdmVyd3JpdGU6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgaWYgKHZhbHVlICE9IG51bGwgJiYgdmFsdWUgPT0gdGhpcy5zdGF0ZS5vdmVyd3JpdGUpIHsgcmV0dXJuIH0KICAgICAgICBpZiAodGhpcy5zdGF0ZS5vdmVyd3JpdGUgPSAhdGhpcy5zdGF0ZS5vdmVyd3JpdGUpCiAgICAgICAgICB7IGFkZENsYXNzKHRoaXMuZGlzcGxheS5jdXJzb3JEaXYsICJDb2RlTWlycm9yLW92ZXJ3cml0ZSIpOyB9CiAgICAgICAgZWxzZQogICAgICAgICAgeyBybUNsYXNzKHRoaXMuZGlzcGxheS5jdXJzb3JEaXYsICJDb2RlTWlycm9yLW92ZXJ3cml0ZSIpOyB9CgogICAgICAgIHNpZ25hbCh0aGlzLCAib3ZlcndyaXRlVG9nZ2xlIiwgdGhpcywgdGhpcy5zdGF0ZS5vdmVyd3JpdGUpOwogICAgICB9LAogICAgICBoYXNGb2N1czogZnVuY3Rpb24oKSB7IHJldHVybiB0aGlzLmRpc3BsYXkuaW5wdXQuZ2V0RmllbGQoKSA9PSBhY3RpdmVFbHQoKSB9LAogICAgICBpc1JlYWRPbmx5OiBmdW5jdGlvbigpIHsgcmV0dXJuICEhKHRoaXMub3B0aW9ucy5yZWFkT25seSB8fCB0aGlzLmRvYy5jYW50RWRpdCkgfSwKCiAgICAgIHNjcm9sbFRvOiBtZXRob2RPcChmdW5jdGlvbiAoeCwgeSkgeyBzY3JvbGxUb0Nvb3Jkcyh0aGlzLCB4LCB5KTsgfSksCiAgICAgIGdldFNjcm9sbEluZm86IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBzY3JvbGxlciA9IHRoaXMuZGlzcGxheS5zY3JvbGxlcjsKICAgICAgICByZXR1cm4ge2xlZnQ6IHNjcm9sbGVyLnNjcm9sbExlZnQsIHRvcDogc2Nyb2xsZXIuc2Nyb2xsVG9wLAogICAgICAgICAgICAgICAgaGVpZ2h0OiBzY3JvbGxlci5zY3JvbGxIZWlnaHQgLSBzY3JvbGxHYXAodGhpcykgLSB0aGlzLmRpc3BsYXkuYmFySGVpZ2h0LAogICAgICAgICAgICAgICAgd2lkdGg6IHNjcm9sbGVyLnNjcm9sbFdpZHRoIC0gc2Nyb2xsR2FwKHRoaXMpIC0gdGhpcy5kaXNwbGF5LmJhcldpZHRoLAogICAgICAgICAgICAgICAgY2xpZW50SGVpZ2h0OiBkaXNwbGF5SGVpZ2h0KHRoaXMpLCBjbGllbnRXaWR0aDogZGlzcGxheVdpZHRoKHRoaXMpfQogICAgICB9LAoKICAgICAgc2Nyb2xsSW50b1ZpZXc6IG1ldGhvZE9wKGZ1bmN0aW9uKHJhbmdlJCQxLCBtYXJnaW4pIHsKICAgICAgICBpZiAocmFuZ2UkJDEgPT0gbnVsbCkgewogICAgICAgICAgcmFuZ2UkJDEgPSB7ZnJvbTogdGhpcy5kb2Muc2VsLnByaW1hcnkoKS5oZWFkLCB0bzogbnVsbH07CiAgICAgICAgICBpZiAobWFyZ2luID09IG51bGwpIHsgbWFyZ2luID0gdGhpcy5vcHRpb25zLmN1cnNvclNjcm9sbE1hcmdpbjsgfQogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHJhbmdlJCQxID09ICJudW1iZXIiKSB7CiAgICAgICAgICByYW5nZSQkMSA9IHtmcm9tOiBQb3MocmFuZ2UkJDEsIDApLCB0bzogbnVsbH07CiAgICAgICAgfSBlbHNlIGlmIChyYW5nZSQkMS5mcm9tID09IG51bGwpIHsKICAgICAgICAgIHJhbmdlJCQxID0ge2Zyb206IHJhbmdlJCQxLCB0bzogbnVsbH07CiAgICAgICAgfQogICAgICAgIGlmICghcmFuZ2UkJDEudG8pIHsgcmFuZ2UkJDEudG8gPSByYW5nZSQkMS5mcm9tOyB9CiAgICAgICAgcmFuZ2UkJDEubWFyZ2luID0gbWFyZ2luIHx8IDA7CgogICAgICAgIGlmIChyYW5nZSQkMS5mcm9tLmxpbmUgIT0gbnVsbCkgewogICAgICAgICAgc2Nyb2xsVG9SYW5nZSh0aGlzLCByYW5nZSQkMSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHNjcm9sbFRvQ29vcmRzUmFuZ2UodGhpcywgcmFuZ2UkJDEuZnJvbSwgcmFuZ2UkJDEudG8sIHJhbmdlJCQxLm1hcmdpbik7CiAgICAgICAgfQogICAgICB9KSwKCiAgICAgIHNldFNpemU6IG1ldGhvZE9wKGZ1bmN0aW9uKHdpZHRoLCBoZWlnaHQpIHsKICAgICAgICB2YXIgdGhpcyQxID0gdGhpczsKCiAgICAgICAgdmFyIGludGVycHJldCA9IGZ1bmN0aW9uICh2YWwpIHsgcmV0dXJuIHR5cGVvZiB2YWwgPT0gIm51bWJlciIgfHwgL15cZCskLy50ZXN0KFN0cmluZyh2YWwpKSA/IHZhbCArICJweCIgOiB2YWw7IH07CiAgICAgICAgaWYgKHdpZHRoICE9IG51bGwpIHsgdGhpcy5kaXNwbGF5LndyYXBwZXIuc3R5bGUud2lkdGggPSBpbnRlcnByZXQod2lkdGgpOyB9CiAgICAgICAgaWYgKGhlaWdodCAhPSBudWxsKSB7IHRoaXMuZGlzcGxheS53cmFwcGVyLnN0eWxlLmhlaWdodCA9IGludGVycHJldChoZWlnaHQpOyB9CiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5saW5lV3JhcHBpbmcpIHsgY2xlYXJMaW5lTWVhc3VyZW1lbnRDYWNoZSh0aGlzKTsgfQogICAgICAgIHZhciBsaW5lTm8kJDEgPSB0aGlzLmRpc3BsYXkudmlld0Zyb207CiAgICAgICAgdGhpcy5kb2MuaXRlcihsaW5lTm8kJDEsIHRoaXMuZGlzcGxheS52aWV3VG8sIGZ1bmN0aW9uIChsaW5lKSB7CiAgICAgICAgICBpZiAobGluZS53aWRnZXRzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgbGluZS53aWRnZXRzLmxlbmd0aDsgaSsrKQogICAgICAgICAgICB7IGlmIChsaW5lLndpZGdldHNbaV0ubm9IU2Nyb2xsKSB7IHJlZ0xpbmVDaGFuZ2UodGhpcyQxLCBsaW5lTm8kJDEsICJ3aWRnZXQiKTsgYnJlYWsgfSB9IH0KICAgICAgICAgICsrbGluZU5vJCQxOwogICAgICAgIH0pOwogICAgICAgIHRoaXMuY3VyT3AuZm9yY2VVcGRhdGUgPSB0cnVlOwogICAgICAgIHNpZ25hbCh0aGlzLCAicmVmcmVzaCIsIHRoaXMpOwogICAgICB9KSwKCiAgICAgIG9wZXJhdGlvbjogZnVuY3Rpb24oZil7cmV0dXJuIHJ1bkluT3AodGhpcywgZil9LAogICAgICBzdGFydE9wZXJhdGlvbjogZnVuY3Rpb24oKXtyZXR1cm4gc3RhcnRPcGVyYXRpb24odGhpcyl9LAogICAgICBlbmRPcGVyYXRpb246IGZ1bmN0aW9uKCl7cmV0dXJuIGVuZE9wZXJhdGlvbih0aGlzKX0sCgogICAgICByZWZyZXNoOiBtZXRob2RPcChmdW5jdGlvbigpIHsKICAgICAgICB2YXIgb2xkSGVpZ2h0ID0gdGhpcy5kaXNwbGF5LmNhY2hlZFRleHRIZWlnaHQ7CiAgICAgICAgcmVnQ2hhbmdlKHRoaXMpOwogICAgICAgIHRoaXMuY3VyT3AuZm9yY2VVcGRhdGUgPSB0cnVlOwogICAgICAgIGNsZWFyQ2FjaGVzKHRoaXMpOwogICAgICAgIHNjcm9sbFRvQ29vcmRzKHRoaXMsIHRoaXMuZG9jLnNjcm9sbExlZnQsIHRoaXMuZG9jLnNjcm9sbFRvcCk7CiAgICAgICAgdXBkYXRlR3V0dGVyU3BhY2UodGhpcy5kaXNwbGF5KTsKICAgICAgICBpZiAob2xkSGVpZ2h0ID09IG51bGwgfHwgTWF0aC5hYnMob2xkSGVpZ2h0IC0gdGV4dEhlaWdodCh0aGlzLmRpc3BsYXkpKSA+IC41KQogICAgICAgICAgeyBlc3RpbWF0ZUxpbmVIZWlnaHRzKHRoaXMpOyB9CiAgICAgICAgc2lnbmFsKHRoaXMsICJyZWZyZXNoIiwgdGhpcyk7CiAgICAgIH0pLAoKICAgICAgc3dhcERvYzogbWV0aG9kT3AoZnVuY3Rpb24oZG9jKSB7CiAgICAgICAgdmFyIG9sZCA9IHRoaXMuZG9jOwogICAgICAgIG9sZC5jbSA9IG51bGw7CiAgICAgICAgLy8gQ2FuY2VsIHRoZSBjdXJyZW50IHRleHQgc2VsZWN0aW9uIGlmIGFueSAoIzU4MjEpCiAgICAgICAgaWYgKHRoaXMuc3RhdGUuc2VsZWN0aW5nVGV4dCkgeyB0aGlzLnN0YXRlLnNlbGVjdGluZ1RleHQoKTsgfQogICAgICAgIGF0dGFjaERvYyh0aGlzLCBkb2MpOwogICAgICAgIGNsZWFyQ2FjaGVzKHRoaXMpOwogICAgICAgIHRoaXMuZGlzcGxheS5pbnB1dC5yZXNldCgpOwogICAgICAgIHNjcm9sbFRvQ29vcmRzKHRoaXMsIGRvYy5zY3JvbGxMZWZ0LCBkb2Muc2Nyb2xsVG9wKTsKICAgICAgICB0aGlzLmN1ck9wLmZvcmNlU2Nyb2xsID0gdHJ1ZTsKICAgICAgICBzaWduYWxMYXRlcih0aGlzLCAic3dhcERvYyIsIHRoaXMsIG9sZCk7CiAgICAgICAgcmV0dXJuIG9sZAogICAgICB9KSwKCiAgICAgIHBocmFzZTogZnVuY3Rpb24ocGhyYXNlVGV4dCkgewogICAgICAgIHZhciBwaHJhc2VzID0gdGhpcy5vcHRpb25zLnBocmFzZXM7CiAgICAgICAgcmV0dXJuIHBocmFzZXMgJiYgT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHBocmFzZXMsIHBocmFzZVRleHQpID8gcGhyYXNlc1twaHJhc2VUZXh0XSA6IHBocmFzZVRleHQKICAgICAgfSwKCiAgICAgIGdldElucHV0RmllbGQ6IGZ1bmN0aW9uKCl7cmV0dXJuIHRoaXMuZGlzcGxheS5pbnB1dC5nZXRGaWVsZCgpfSwKICAgICAgZ2V0V3JhcHBlckVsZW1lbnQ6IGZ1bmN0aW9uKCl7cmV0dXJuIHRoaXMuZGlzcGxheS53cmFwcGVyfSwKICAgICAgZ2V0U2Nyb2xsZXJFbGVtZW50OiBmdW5jdGlvbigpe3JldHVybiB0aGlzLmRpc3BsYXkuc2Nyb2xsZXJ9LAogICAgICBnZXRHdXR0ZXJFbGVtZW50OiBmdW5jdGlvbigpe3JldHVybiB0aGlzLmRpc3BsYXkuZ3V0dGVyc30KICAgIH07CiAgICBldmVudE1peGluKENvZGVNaXJyb3IpOwoKICAgIENvZGVNaXJyb3IucmVnaXN0ZXJIZWxwZXIgPSBmdW5jdGlvbih0eXBlLCBuYW1lLCB2YWx1ZSkgewogICAgICBpZiAoIWhlbHBlcnMuaGFzT3duUHJvcGVydHkodHlwZSkpIHsgaGVscGVyc1t0eXBlXSA9IENvZGVNaXJyb3JbdHlwZV0gPSB7X2dsb2JhbDogW119OyB9CiAgICAgIGhlbHBlcnNbdHlwZV1bbmFtZV0gPSB2YWx1ZTsKICAgIH07CiAgICBDb2RlTWlycm9yLnJlZ2lzdGVyR2xvYmFsSGVscGVyID0gZnVuY3Rpb24odHlwZSwgbmFtZSwgcHJlZGljYXRlLCB2YWx1ZSkgewogICAgICBDb2RlTWlycm9yLnJlZ2lzdGVySGVscGVyKHR5cGUsIG5hbWUsIHZhbHVlKTsKICAgICAgaGVscGVyc1t0eXBlXS5fZ2xvYmFsLnB1c2goe3ByZWQ6IHByZWRpY2F0ZSwgdmFsOiB2YWx1ZX0pOwogICAgfTsKICB9CgogIC8vIFVzZWQgZm9yIGhvcml6b250YWwgcmVsYXRpdmUgbW90aW9uLiBEaXIgaXMgLTEgb3IgMSAobGVmdCBvcgogIC8vIHJpZ2h0KSwgdW5pdCBjYW4gYmUgImNoYXIiLCAiY29sdW1uIiAobGlrZSBjaGFyLCBidXQgZG9lc24ndAogIC8vIGNyb3NzIGxpbmUgYm91bmRhcmllcyksICJ3b3JkIiAoYWNyb3NzIG5leHQgd29yZCksIG9yICJncm91cCIgKHRvCiAgLy8gdGhlIHN0YXJ0IG9mIG5leHQgZ3JvdXAgb2Ygd29yZCBvciBub24td29yZC1ub24td2hpdGVzcGFjZQogIC8vIGNoYXJzKS4gVGhlIHZpc3VhbGx5IHBhcmFtIGNvbnRyb2xzIHdoZXRoZXIsIGluIHJpZ2h0LXRvLWxlZnQKICAvLyB0ZXh0LCBkaXJlY3Rpb24gMSBtZWFucyB0byBtb3ZlIHRvd2FyZHMgdGhlIG5leHQgaW5kZXggaW4gdGhlCiAgLy8gc3RyaW5nLCBvciB0b3dhcmRzIHRoZSBjaGFyYWN0ZXIgdG8gdGhlIHJpZ2h0IG9mIHRoZSBjdXJyZW50CiAgLy8gcG9zaXRpb24uIFRoZSByZXN1bHRpbmcgcG9zaXRpb24gd2lsbCBoYXZlIGEgaGl0U2lkZT10cnVlCiAgLy8gcHJvcGVydHkgaWYgaXQgcmVhY2hlZCB0aGUgZW5kIG9mIHRoZSBkb2N1bWVudC4KICBmdW5jdGlvbiBmaW5kUG9zSChkb2MsIHBvcywgZGlyLCB1bml0LCB2aXN1YWxseSkgewogICAgdmFyIG9sZFBvcyA9IHBvczsKICAgIHZhciBvcmlnRGlyID0gZGlyOwogICAgdmFyIGxpbmVPYmogPSBnZXRMaW5lKGRvYywgcG9zLmxpbmUpOwogICAgZnVuY3Rpb24gZmluZE5leHRMaW5lKCkgewogICAgICB2YXIgbCA9IHBvcy5saW5lICsgZGlyOwogICAgICBpZiAobCA8IGRvYy5maXJzdCB8fCBsID49IGRvYy5maXJzdCArIGRvYy5zaXplKSB7IHJldHVybiBmYWxzZSB9CiAgICAgIHBvcyA9IG5ldyBQb3MobCwgcG9zLmNoLCBwb3Muc3RpY2t5KTsKICAgICAgcmV0dXJuIGxpbmVPYmogPSBnZXRMaW5lKGRvYywgbCkKICAgIH0KICAgIGZ1bmN0aW9uIG1vdmVPbmNlKGJvdW5kVG9MaW5lKSB7CiAgICAgIHZhciBuZXh0OwogICAgICBpZiAodmlzdWFsbHkpIHsKICAgICAgICBuZXh0ID0gbW92ZVZpc3VhbGx5KGRvYy5jbSwgbGluZU9iaiwgcG9zLCBkaXIpOwogICAgICB9IGVsc2UgewogICAgICAgIG5leHQgPSBtb3ZlTG9naWNhbGx5KGxpbmVPYmosIHBvcywgZGlyKTsKICAgICAgfQogICAgICBpZiAobmV4dCA9PSBudWxsKSB7CiAgICAgICAgaWYgKCFib3VuZFRvTGluZSAmJiBmaW5kTmV4dExpbmUoKSkKICAgICAgICAgIHsgcG9zID0gZW5kT2ZMaW5lKHZpc3VhbGx5LCBkb2MuY20sIGxpbmVPYmosIHBvcy5saW5lLCBkaXIpOyB9CiAgICAgICAgZWxzZQogICAgICAgICAgeyByZXR1cm4gZmFsc2UgfQogICAgICB9IGVsc2UgewogICAgICAgIHBvcyA9IG5leHQ7CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWUKICAgIH0KCiAgICBpZiAodW5pdCA9PSAiY2hhciIpIHsKICAgICAgbW92ZU9uY2UoKTsKICAgIH0gZWxzZSBpZiAodW5pdCA9PSAiY29sdW1uIikgewogICAgICBtb3ZlT25jZSh0cnVlKTsKICAgIH0gZWxzZSBpZiAodW5pdCA9PSAid29yZCIgfHwgdW5pdCA9PSAiZ3JvdXAiKSB7CiAgICAgIHZhciBzYXdUeXBlID0gbnVsbCwgZ3JvdXAgPSB1bml0ID09ICJncm91cCI7CiAgICAgIHZhciBoZWxwZXIgPSBkb2MuY20gJiYgZG9jLmNtLmdldEhlbHBlcihwb3MsICJ3b3JkQ2hhcnMiKTsKICAgICAgZm9yICh2YXIgZmlyc3QgPSB0cnVlOzsgZmlyc3QgPSBmYWxzZSkgewogICAgICAgIGlmIChkaXIgPCAwICYmICFtb3ZlT25jZSghZmlyc3QpKSB7IGJyZWFrIH0KICAgICAgICB2YXIgY3VyID0gbGluZU9iai50ZXh0LmNoYXJBdChwb3MuY2gpIHx8ICJcbiI7CiAgICAgICAgdmFyIHR5cGUgPSBpc1dvcmRDaGFyKGN1ciwgaGVscGVyKSA/ICJ3IgogICAgICAgICAgOiBncm91cCAmJiBjdXIgPT0gIlxuIiA/ICJuIgogICAgICAgICAgOiAhZ3JvdXAgfHwgL1xzLy50ZXN0KGN1cikgPyBudWxsCiAgICAgICAgICA6ICJwIjsKICAgICAgICBpZiAoZ3JvdXAgJiYgIWZpcnN0ICYmICF0eXBlKSB7IHR5cGUgPSAicyI7IH0KICAgICAgICBpZiAoc2F3VHlwZSAmJiBzYXdUeXBlICE9IHR5cGUpIHsKICAgICAgICAgIGlmIChkaXIgPCAwKSB7ZGlyID0gMTsgbW92ZU9uY2UoKTsgcG9zLnN0aWNreSA9ICJhZnRlciI7fQogICAgICAgICAgYnJlYWsKICAgICAgICB9CgogICAgICAgIGlmICh0eXBlKSB7IHNhd1R5cGUgPSB0eXBlOyB9CiAgICAgICAgaWYgKGRpciA+IDAgJiYgIW1vdmVPbmNlKCFmaXJzdCkpIHsgYnJlYWsgfQogICAgICB9CiAgICB9CiAgICB2YXIgcmVzdWx0ID0gc2tpcEF0b21pYyhkb2MsIHBvcywgb2xkUG9zLCBvcmlnRGlyLCB0cnVlKTsKICAgIGlmIChlcXVhbEN1cnNvclBvcyhvbGRQb3MsIHJlc3VsdCkpIHsgcmVzdWx0LmhpdFNpZGUgPSB0cnVlOyB9CiAgICByZXR1cm4gcmVzdWx0CiAgfQoKICAvLyBGb3IgcmVsYXRpdmUgdmVydGljYWwgbW92ZW1lbnQuIERpciBtYXkgYmUgLTEgb3IgMS4gVW5pdCBjYW4gYmUKICAvLyAicGFnZSIgb3IgImxpbmUiLiBUaGUgcmVzdWx0aW5nIHBvc2l0aW9uIHdpbGwgaGF2ZSBhIGhpdFNpZGU9dHJ1ZQogIC8vIHByb3BlcnR5IGlmIGl0IHJlYWNoZWQgdGhlIGVuZCBvZiB0aGUgZG9jdW1lbnQuCiAgZnVuY3Rpb24gZmluZFBvc1YoY20sIHBvcywgZGlyLCB1bml0KSB7CiAgICB2YXIgZG9jID0gY20uZG9jLCB4ID0gcG9zLmxlZnQsIHk7CiAgICBpZiAodW5pdCA9PSAicGFnZSIpIHsKICAgICAgdmFyIHBhZ2VTaXplID0gTWF0aC5taW4oY20uZGlzcGxheS53cmFwcGVyLmNsaWVudEhlaWdodCwgd2luZG93LmlubmVySGVpZ2h0IHx8IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jbGllbnRIZWlnaHQpOwogICAgICB2YXIgbW92ZUFtb3VudCA9IE1hdGgubWF4KHBhZ2VTaXplIC0gLjUgKiB0ZXh0SGVpZ2h0KGNtLmRpc3BsYXkpLCAzKTsKICAgICAgeSA9IChkaXIgPiAwID8gcG9zLmJvdHRvbSA6IHBvcy50b3ApICsgZGlyICogbW92ZUFtb3VudDsKCiAgICB9IGVsc2UgaWYgKHVuaXQgPT0gImxpbmUiKSB7CiAgICAgIHkgPSBkaXIgPiAwID8gcG9zLmJvdHRvbSArIDMgOiBwb3MudG9wIC0gMzsKICAgIH0KICAgIHZhciB0YXJnZXQ7CiAgICBmb3IgKDs7KSB7CiAgICAgIHRhcmdldCA9IGNvb3Jkc0NoYXIoY20sIHgsIHkpOwogICAgICBpZiAoIXRhcmdldC5vdXRzaWRlKSB7IGJyZWFrIH0KICAgICAgaWYgKGRpciA8IDAgPyB5IDw9IDAgOiB5ID49IGRvYy5oZWlnaHQpIHsgdGFyZ2V0LmhpdFNpZGUgPSB0cnVlOyBicmVhayB9CiAgICAgIHkgKz0gZGlyICogNTsKICAgIH0KICAgIHJldHVybiB0YXJnZXQKICB9CgogIC8vIENPTlRFTlRFRElUQUJMRSBJTlBVVCBTVFlMRQoKICB2YXIgQ29udGVudEVkaXRhYmxlSW5wdXQgPSBmdW5jdGlvbihjbSkgewogICAgdGhpcy5jbSA9IGNtOwogICAgdGhpcy5sYXN0QW5jaG9yTm9kZSA9IHRoaXMubGFzdEFuY2hvck9mZnNldCA9IHRoaXMubGFzdEZvY3VzTm9kZSA9IHRoaXMubGFzdEZvY3VzT2Zmc2V0ID0gbnVsbDsKICAgIHRoaXMucG9sbGluZyA9IG5ldyBEZWxheWVkKCk7CiAgICB0aGlzLmNvbXBvc2luZyA9IG51bGw7CiAgICB0aGlzLmdyYWNlUGVyaW9kID0gZmFsc2U7CiAgICB0aGlzLnJlYWRET01UaW1lb3V0ID0gbnVsbDsKICB9OwoKICBDb250ZW50RWRpdGFibGVJbnB1dC5wcm90b3R5cGUuaW5pdCA9IGZ1bmN0aW9uIChkaXNwbGF5KSB7CiAgICAgIHZhciB0aGlzJDEgPSB0aGlzOwoKICAgIHZhciBpbnB1dCA9IHRoaXMsIGNtID0gaW5wdXQuY207CiAgICB2YXIgZGl2ID0gaW5wdXQuZGl2ID0gZGlzcGxheS5saW5lRGl2OwogICAgZGlzYWJsZUJyb3dzZXJNYWdpYyhkaXYsIGNtLm9wdGlvbnMuc3BlbGxjaGVjaywgY20ub3B0aW9ucy5hdXRvY29ycmVjdCwgY20ub3B0aW9ucy5hdXRvY2FwaXRhbGl6ZSk7CgogICAgb24oZGl2LCAicGFzdGUiLCBmdW5jdGlvbiAoZSkgewogICAgICBpZiAoc2lnbmFsRE9NRXZlbnQoY20sIGUpIHx8IGhhbmRsZVBhc3RlKGUsIGNtKSkgeyByZXR1cm4gfQogICAgICAvLyBJRSBkb2Vzbid0IGZpcmUgaW5wdXQgZXZlbnRzLCBzbyB3ZSBzY2hlZHVsZSBhIHJlYWQgZm9yIHRoZSBwYXN0ZWQgY29udGVudCBpbiB0aGlzIHdheQogICAgICBpZiAoaWVfdmVyc2lvbiA8PSAxMSkgeyBzZXRUaW1lb3V0KG9wZXJhdGlvbihjbSwgZnVuY3Rpb24gKCkgeyByZXR1cm4gdGhpcyQxLnVwZGF0ZUZyb21ET00oKTsgfSksIDIwKTsgfQogICAgfSk7CgogICAgb24oZGl2LCAiY29tcG9zaXRpb25zdGFydCIsIGZ1bmN0aW9uIChlKSB7CiAgICAgIHRoaXMkMS5jb21wb3NpbmcgPSB7ZGF0YTogZS5kYXRhLCBkb25lOiBmYWxzZX07CiAgICB9KTsKICAgIG9uKGRpdiwgImNvbXBvc2l0aW9udXBkYXRlIiwgZnVuY3Rpb24gKGUpIHsKICAgICAgaWYgKCF0aGlzJDEuY29tcG9zaW5nKSB7IHRoaXMkMS5jb21wb3NpbmcgPSB7ZGF0YTogZS5kYXRhLCBkb25lOiBmYWxzZX07IH0KICAgIH0pOwogICAgb24oZGl2LCAiY29tcG9zaXRpb25lbmQiLCBmdW5jdGlvbiAoZSkgewogICAgICBpZiAodGhpcyQxLmNvbXBvc2luZykgewogICAgICAgIGlmIChlLmRhdGEgIT0gdGhpcyQxLmNvbXBvc2luZy5kYXRhKSB7IHRoaXMkMS5yZWFkRnJvbURPTVNvb24oKTsgfQogICAgICAgIHRoaXMkMS5jb21wb3NpbmcuZG9uZSA9IHRydWU7CiAgICAgIH0KICAgIH0pOwoKICAgIG9uKGRpdiwgInRvdWNoc3RhcnQiLCBmdW5jdGlvbiAoKSB7IHJldHVybiBpbnB1dC5mb3JjZUNvbXBvc2l0aW9uRW5kKCk7IH0pOwoKICAgIG9uKGRpdiwgImlucHV0IiwgZnVuY3Rpb24gKCkgewogICAgICBpZiAoIXRoaXMkMS5jb21wb3NpbmcpIHsgdGhpcyQxLnJlYWRGcm9tRE9NU29vbigpOyB9CiAgICB9KTsKCiAgICBmdW5jdGlvbiBvbkNvcHlDdXQoZSkgewogICAgICBpZiAoc2lnbmFsRE9NRXZlbnQoY20sIGUpKSB7IHJldHVybiB9CiAgICAgIGlmIChjbS5zb21ldGhpbmdTZWxlY3RlZCgpKSB7CiAgICAgICAgc2V0TGFzdENvcGllZCh7bGluZVdpc2U6IGZhbHNlLCB0ZXh0OiBjbS5nZXRTZWxlY3Rpb25zKCl9KTsKICAgICAgICBpZiAoZS50eXBlID09ICJjdXQiKSB7IGNtLnJlcGxhY2VTZWxlY3Rpb24oIiIsIG51bGwsICJjdXQiKTsgfQogICAgICB9IGVsc2UgaWYgKCFjbS5vcHRpb25zLmxpbmVXaXNlQ29weUN1dCkgewogICAgICAgIHJldHVybgogICAgICB9IGVsc2UgewogICAgICAgIHZhciByYW5nZXMgPSBjb3B5YWJsZVJhbmdlcyhjbSk7CiAgICAgICAgc2V0TGFzdENvcGllZCh7bGluZVdpc2U6IHRydWUsIHRleHQ6IHJhbmdlcy50ZXh0fSk7CiAgICAgICAgaWYgKGUudHlwZSA9PSAiY3V0IikgewogICAgICAgICAgY20ub3BlcmF0aW9uKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgY20uc2V0U2VsZWN0aW9ucyhyYW5nZXMucmFuZ2VzLCAwLCBzZWxfZG9udFNjcm9sbCk7CiAgICAgICAgICAgIGNtLnJlcGxhY2VTZWxlY3Rpb24oIiIsIG51bGwsICJjdXQiKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoZS5jbGlwYm9hcmREYXRhKSB7CiAgICAgICAgZS5jbGlwYm9hcmREYXRhLmNsZWFyRGF0YSgpOwogICAgICAgIHZhciBjb250ZW50ID0gbGFzdENvcGllZC50ZXh0LmpvaW4oIlxuIik7CiAgICAgICAgLy8gaU9TIGV4cG9zZXMgdGhlIGNsaXBib2FyZCBBUEksIGJ1dCBzZWVtcyB0byBkaXNjYXJkIGNvbnRlbnQgaW5zZXJ0ZWQgaW50byBpdAogICAgICAgIGUuY2xpcGJvYXJkRGF0YS5zZXREYXRhKCJUZXh0IiwgY29udGVudCk7CiAgICAgICAgaWYgKGUuY2xpcGJvYXJkRGF0YS5nZXREYXRhKCJUZXh0IikgPT0gY29udGVudCkgewogICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgcmV0dXJuCiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIE9sZC1mYXNoaW9uZWQgYnJpZWZseS1mb2N1cy1hLXRleHRhcmVhIGhhY2sKICAgICAgdmFyIGtsdWRnZSA9IGhpZGRlblRleHRhcmVhKCksIHRlID0ga2x1ZGdlLmZpcnN0Q2hpbGQ7CiAgICAgIGNtLmRpc3BsYXkubGluZVNwYWNlLmluc2VydEJlZm9yZShrbHVkZ2UsIGNtLmRpc3BsYXkubGluZVNwYWNlLmZpcnN0Q2hpbGQpOwogICAgICB0ZS52YWx1ZSA9IGxhc3RDb3BpZWQudGV4dC5qb2luKCJcbiIpOwogICAgICB2YXIgaGFkRm9jdXMgPSBkb2N1bWVudC5hY3RpdmVFbGVtZW50OwogICAgICBzZWxlY3RJbnB1dCh0ZSk7CiAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgIGNtLmRpc3BsYXkubGluZVNwYWNlLnJlbW92ZUNoaWxkKGtsdWRnZSk7CiAgICAgICAgaGFkRm9jdXMuZm9jdXMoKTsKICAgICAgICBpZiAoaGFkRm9jdXMgPT0gZGl2KSB7IGlucHV0LnNob3dQcmltYXJ5U2VsZWN0aW9uKCk7IH0KICAgICAgfSwgNTApOwogICAgfQogICAgb24oZGl2LCAiY29weSIsIG9uQ29weUN1dCk7CiAgICBvbihkaXYsICJjdXQiLCBvbkNvcHlDdXQpOwogIH07CgogIENvbnRlbnRFZGl0YWJsZUlucHV0LnByb3RvdHlwZS5wcmVwYXJlU2VsZWN0aW9uID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHJlc3VsdCA9IHByZXBhcmVTZWxlY3Rpb24odGhpcy5jbSwgZmFsc2UpOwogICAgcmVzdWx0LmZvY3VzID0gdGhpcy5jbS5zdGF0ZS5mb2N1c2VkOwogICAgcmV0dXJuIHJlc3VsdAogIH07CgogIENvbnRlbnRFZGl0YWJsZUlucHV0LnByb3RvdHlwZS5zaG93U2VsZWN0aW9uID0gZnVuY3Rpb24gKGluZm8sIHRha2VGb2N1cykgewogICAgaWYgKCFpbmZvIHx8ICF0aGlzLmNtLmRpc3BsYXkudmlldy5sZW5ndGgpIHsgcmV0dXJuIH0KICAgIGlmIChpbmZvLmZvY3VzIHx8IHRha2VGb2N1cykgeyB0aGlzLnNob3dQcmltYXJ5U2VsZWN0aW9uKCk7IH0KICAgIHRoaXMuc2hvd011bHRpcGxlU2VsZWN0aW9ucyhpbmZvKTsKICB9OwoKICBDb250ZW50RWRpdGFibGVJbnB1dC5wcm90b3R5cGUuZ2V0U2VsZWN0aW9uID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuY20uZGlzcGxheS53cmFwcGVyLm93bmVyRG9jdW1lbnQuZ2V0U2VsZWN0aW9uKCkKICB9OwoKICBDb250ZW50RWRpdGFibGVJbnB1dC5wcm90b3R5cGUuc2hvd1ByaW1hcnlTZWxlY3Rpb24gPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsID0gdGhpcy5nZXRTZWxlY3Rpb24oKSwgY20gPSB0aGlzLmNtLCBwcmltID0gY20uZG9jLnNlbC5wcmltYXJ5KCk7CiAgICB2YXIgZnJvbSA9IHByaW0uZnJvbSgpLCB0byA9IHByaW0udG8oKTsKCiAgICBpZiAoY20uZGlzcGxheS52aWV3VG8gPT0gY20uZGlzcGxheS52aWV3RnJvbSB8fCBmcm9tLmxpbmUgPj0gY20uZGlzcGxheS52aWV3VG8gfHwgdG8ubGluZSA8IGNtLmRpc3BsYXkudmlld0Zyb20pIHsKICAgICAgc2VsLnJlbW92ZUFsbFJhbmdlcygpOwogICAgICByZXR1cm4KICAgIH0KCiAgICB2YXIgY3VyQW5jaG9yID0gZG9tVG9Qb3MoY20sIHNlbC5hbmNob3JOb2RlLCBzZWwuYW5jaG9yT2Zmc2V0KTsKICAgIHZhciBjdXJGb2N1cyA9IGRvbVRvUG9zKGNtLCBzZWwuZm9jdXNOb2RlLCBzZWwuZm9jdXNPZmZzZXQpOwogICAgaWYgKGN1ckFuY2hvciAmJiAhY3VyQW5jaG9yLmJhZCAmJiBjdXJGb2N1cyAmJiAhY3VyRm9jdXMuYmFkICYmCiAgICAgICAgY21wKG1pblBvcyhjdXJBbmNob3IsIGN1ckZvY3VzKSwgZnJvbSkgPT0gMCAmJgogICAgICAgIGNtcChtYXhQb3MoY3VyQW5jaG9yLCBjdXJGb2N1cyksIHRvKSA9PSAwKQogICAgICB7IHJldHVybiB9CgogICAgdmFyIHZpZXcgPSBjbS5kaXNwbGF5LnZpZXc7CiAgICB2YXIgc3RhcnQgPSAoZnJvbS5saW5lID49IGNtLmRpc3BsYXkudmlld0Zyb20gJiYgcG9zVG9ET00oY20sIGZyb20pKSB8fAogICAgICAgIHtub2RlOiB2aWV3WzBdLm1lYXN1cmUubWFwWzJdLCBvZmZzZXQ6IDB9OwogICAgdmFyIGVuZCA9IHRvLmxpbmUgPCBjbS5kaXNwbGF5LnZpZXdUbyAmJiBwb3NUb0RPTShjbSwgdG8pOwogICAgaWYgKCFlbmQpIHsKICAgICAgdmFyIG1lYXN1cmUgPSB2aWV3W3ZpZXcubGVuZ3RoIC0gMV0ubWVhc3VyZTsKICAgICAgdmFyIG1hcCQkMSA9IG1lYXN1cmUubWFwcyA/IG1lYXN1cmUubWFwc1ttZWFzdXJlLm1hcHMubGVuZ3RoIC0gMV0gOiBtZWFzdXJlLm1hcDsKICAgICAgZW5kID0ge25vZGU6IG1hcCQkMVttYXAkJDEubGVuZ3RoIC0gMV0sIG9mZnNldDogbWFwJCQxW21hcCQkMS5sZW5ndGggLSAyXSAtIG1hcCQkMVttYXAkJDEubGVuZ3RoIC0gM119OwogICAgfQoKICAgIGlmICghc3RhcnQgfHwgIWVuZCkgewogICAgICBzZWwucmVtb3ZlQWxsUmFuZ2VzKCk7CiAgICAgIHJldHVybgogICAgfQoKICAgIHZhciBvbGQgPSBzZWwucmFuZ2VDb3VudCAmJiBzZWwuZ2V0UmFuZ2VBdCgwKSwgcm5nOwogICAgdHJ5IHsgcm5nID0gcmFuZ2Uoc3RhcnQubm9kZSwgc3RhcnQub2Zmc2V0LCBlbmQub2Zmc2V0LCBlbmQubm9kZSk7IH0KICAgIGNhdGNoKGUpIHt9IC8vIE91ciBtb2RlbCBvZiB0aGUgRE9NIG1pZ2h0IGJlIG91dGRhdGVkLCBpbiB3aGljaCBjYXNlIHRoZSByYW5nZSB3ZSB0cnkgdG8gc2V0IGNhbiBiZSBpbXBvc3NpYmxlCiAgICBpZiAocm5nKSB7CiAgICAgIGlmICghZ2Vja28gJiYgY20uc3RhdGUuZm9jdXNlZCkgewogICAgICAgIHNlbC5jb2xsYXBzZShzdGFydC5ub2RlLCBzdGFydC5vZmZzZXQpOwogICAgICAgIGlmICghcm5nLmNvbGxhcHNlZCkgewogICAgICAgICAgc2VsLnJlbW92ZUFsbFJhbmdlcygpOwogICAgICAgICAgc2VsLmFkZFJhbmdlKHJuZyk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHNlbC5yZW1vdmVBbGxSYW5nZXMoKTsKICAgICAgICBzZWwuYWRkUmFuZ2Uocm5nKTsKICAgICAgfQogICAgICBpZiAob2xkICYmIHNlbC5hbmNob3JOb2RlID09IG51bGwpIHsgc2VsLmFkZFJhbmdlKG9sZCk7IH0KICAgICAgZWxzZSBpZiAoZ2Vja28pIHsgdGhpcy5zdGFydEdyYWNlUGVyaW9kKCk7IH0KICAgIH0KICAgIHRoaXMucmVtZW1iZXJTZWxlY3Rpb24oKTsKICB9OwoKICBDb250ZW50RWRpdGFibGVJbnB1dC5wcm90b3R5cGUuc3RhcnRHcmFjZVBlcmlvZCA9IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIHRoaXMkMSA9IHRoaXM7CgogICAgY2xlYXJUaW1lb3V0KHRoaXMuZ3JhY2VQZXJpb2QpOwogICAgdGhpcy5ncmFjZVBlcmlvZCA9IHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICB0aGlzJDEuZ3JhY2VQZXJpb2QgPSBmYWxzZTsKICAgICAgaWYgKHRoaXMkMS5zZWxlY3Rpb25DaGFuZ2VkKCkpCiAgICAgICAgeyB0aGlzJDEuY20ub3BlcmF0aW9uKGZ1bmN0aW9uICgpIHsgcmV0dXJuIHRoaXMkMS5jbS5jdXJPcC5zZWxlY3Rpb25DaGFuZ2VkID0gdHJ1ZTsgfSk7IH0KICAgIH0sIDIwKTsKICB9OwoKICBDb250ZW50RWRpdGFibGVJbnB1dC5wcm90b3R5cGUuc2hvd011bHRpcGxlU2VsZWN0aW9ucyA9IGZ1bmN0aW9uIChpbmZvKSB7CiAgICByZW1vdmVDaGlsZHJlbkFuZEFkZCh0aGlzLmNtLmRpc3BsYXkuY3Vyc29yRGl2LCBpbmZvLmN1cnNvcnMpOwogICAgcmVtb3ZlQ2hpbGRyZW5BbmRBZGQodGhpcy5jbS5kaXNwbGF5LnNlbGVjdGlvbkRpdiwgaW5mby5zZWxlY3Rpb24pOwogIH07CgogIENvbnRlbnRFZGl0YWJsZUlucHV0LnByb3RvdHlwZS5yZW1lbWJlclNlbGVjdGlvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWwgPSB0aGlzLmdldFNlbGVjdGlvbigpOwogICAgdGhpcy5sYXN0QW5jaG9yTm9kZSA9IHNlbC5hbmNob3JOb2RlOyB0aGlzLmxhc3RBbmNob3JPZmZzZXQgPSBzZWwuYW5jaG9yT2Zmc2V0OwogICAgdGhpcy5sYXN0Rm9jdXNOb2RlID0gc2VsLmZvY3VzTm9kZTsgdGhpcy5sYXN0Rm9jdXNPZmZzZXQgPSBzZWwuZm9jdXNPZmZzZXQ7CiAgfTsKCiAgQ29udGVudEVkaXRhYmxlSW5wdXQucHJvdG90eXBlLnNlbGVjdGlvbkluRWRpdG9yID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbCA9IHRoaXMuZ2V0U2VsZWN0aW9uKCk7CiAgICBpZiAoIXNlbC5yYW5nZUNvdW50KSB7IHJldHVybiBmYWxzZSB9CiAgICB2YXIgbm9kZSA9IHNlbC5nZXRSYW5nZUF0KDApLmNvbW1vbkFuY2VzdG9yQ29udGFpbmVyOwogICAgcmV0dXJuIGNvbnRhaW5zKHRoaXMuZGl2LCBub2RlKQogIH07CgogIENvbnRlbnRFZGl0YWJsZUlucHV0LnByb3RvdHlwZS5mb2N1cyA9IGZ1bmN0aW9uICgpIHsKICAgIGlmICh0aGlzLmNtLm9wdGlvbnMucmVhZE9ubHkgIT0gIm5vY3Vyc29yIikgewogICAgICBpZiAoIXRoaXMuc2VsZWN0aW9uSW5FZGl0b3IoKSkKICAgICAgICB7IHRoaXMuc2hvd1NlbGVjdGlvbih0aGlzLnByZXBhcmVTZWxlY3Rpb24oKSwgdHJ1ZSk7IH0KICAgICAgdGhpcy5kaXYuZm9jdXMoKTsKICAgIH0KICB9OwogIENvbnRlbnRFZGl0YWJsZUlucHV0LnByb3RvdHlwZS5ibHVyID0gZnVuY3Rpb24gKCkgeyB0aGlzLmRpdi5ibHVyKCk7IH07CiAgQ29udGVudEVkaXRhYmxlSW5wdXQucHJvdG90eXBlLmdldEZpZWxkID0gZnVuY3Rpb24gKCkgeyByZXR1cm4gdGhpcy5kaXYgfTsKCiAgQ29udGVudEVkaXRhYmxlSW5wdXQucHJvdG90eXBlLnN1cHBvcnRzVG91Y2ggPSBmdW5jdGlvbiAoKSB7IHJldHVybiB0cnVlIH07CgogIENvbnRlbnRFZGl0YWJsZUlucHV0LnByb3RvdHlwZS5yZWNlaXZlZEZvY3VzID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGlucHV0ID0gdGhpczsKICAgIGlmICh0aGlzLnNlbGVjdGlvbkluRWRpdG9yKCkpCiAgICAgIHsgdGhpcy5wb2xsU2VsZWN0aW9uKCk7IH0KICAgIGVsc2UKICAgICAgeyBydW5Jbk9wKHRoaXMuY20sIGZ1bmN0aW9uICgpIHsgcmV0dXJuIGlucHV0LmNtLmN1ck9wLnNlbGVjdGlvbkNoYW5nZWQgPSB0cnVlOyB9KTsgfQoKICAgIGZ1bmN0aW9uIHBvbGwoKSB7CiAgICAgIGlmIChpbnB1dC5jbS5zdGF0ZS5mb2N1c2VkKSB7CiAgICAgICAgaW5wdXQucG9sbFNlbGVjdGlvbigpOwogICAgICAgIGlucHV0LnBvbGxpbmcuc2V0KGlucHV0LmNtLm9wdGlvbnMucG9sbEludGVydmFsLCBwb2xsKTsKICAgICAgfQogICAgfQogICAgdGhpcy5wb2xsaW5nLnNldCh0aGlzLmNtLm9wdGlvbnMucG9sbEludGVydmFsLCBwb2xsKTsKICB9OwoKICBDb250ZW50RWRpdGFibGVJbnB1dC5wcm90b3R5cGUuc2VsZWN0aW9uQ2hhbmdlZCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWwgPSB0aGlzLmdldFNlbGVjdGlvbigpOwogICAgcmV0dXJuIHNlbC5hbmNob3JOb2RlICE9IHRoaXMubGFzdEFuY2hvck5vZGUgfHwgc2VsLmFuY2hvck9mZnNldCAhPSB0aGlzLmxhc3RBbmNob3JPZmZzZXQgfHwKICAgICAgc2VsLmZvY3VzTm9kZSAhPSB0aGlzLmxhc3RGb2N1c05vZGUgfHwgc2VsLmZvY3VzT2Zmc2V0ICE9IHRoaXMubGFzdEZvY3VzT2Zmc2V0CiAgfTsKCiAgQ29udGVudEVkaXRhYmxlSW5wdXQucHJvdG90eXBlLnBvbGxTZWxlY3Rpb24gPSBmdW5jdGlvbiAoKSB7CiAgICBpZiAodGhpcy5yZWFkRE9NVGltZW91dCAhPSBudWxsIHx8IHRoaXMuZ3JhY2VQZXJpb2QgfHwgIXRoaXMuc2VsZWN0aW9uQ2hhbmdlZCgpKSB7IHJldHVybiB9CiAgICB2YXIgc2VsID0gdGhpcy5nZXRTZWxlY3Rpb24oKSwgY20gPSB0aGlzLmNtOwogICAgLy8gT24gQW5kcm9pZCBDaHJvbWUgKHZlcnNpb24gNTYsIGF0IGxlYXN0KSwgYmFja3NwYWNpbmcgaW50byBhbgogICAgLy8gdW5lZGl0YWJsZSBibG9jayBlbGVtZW50IHdpbGwgcHV0IHRoZSBjdXJzb3IgaW4gdGhhdCBlbGVtZW50LAogICAgLy8gYW5kIHRoZW4sIGJlY2F1c2UgaXQncyBub3QgZWRpdGFibGUsIGhpZGUgdGhlIHZpcnR1YWwga2V5Ym9hcmQuCiAgICAvLyBCZWNhdXNlIEFuZHJvaWQgZG9lc24ndCBhbGxvdyB1cyB0byBhY3R1YWxseSBkZXRlY3QgYmFja3NwYWNlCiAgICAvLyBwcmVzc2VzIGluIGEgc2FuZSB3YXksIHRoaXMgY29kZSBjaGVja3MgZm9yIHdoZW4gdGhhdCBoYXBwZW5zCiAgICAvLyBhbmQgc2ltdWxhdGVzIGEgYmFja3NwYWNlIHByZXNzIGluIHRoaXMgY2FzZS4KICAgIGlmIChhbmRyb2lkICYmIGNocm9tZSAmJiB0aGlzLmNtLmRpc3BsYXkuZ3V0dGVyU3BlY3MubGVuZ3RoICYmIGlzSW5HdXR0ZXIoc2VsLmFuY2hvck5vZGUpKSB7CiAgICAgIHRoaXMuY20udHJpZ2dlck9uS2V5RG93bih7dHlwZTogImtleWRvd24iLCBrZXlDb2RlOiA4LCBwcmV2ZW50RGVmYXVsdDogTWF0aC5hYnN9KTsKICAgICAgdGhpcy5ibHVyKCk7CiAgICAgIHRoaXMuZm9jdXMoKTsKICAgICAgcmV0dXJuCiAgICB9CiAgICBpZiAodGhpcy5jb21wb3NpbmcpIHsgcmV0dXJuIH0KICAgIHRoaXMucmVtZW1iZXJTZWxlY3Rpb24oKTsKICAgIHZhciBhbmNob3IgPSBkb21Ub1BvcyhjbSwgc2VsLmFuY2hvck5vZGUsIHNlbC5hbmNob3JPZmZzZXQpOwogICAgdmFyIGhlYWQgPSBkb21Ub1BvcyhjbSwgc2VsLmZvY3VzTm9kZSwgc2VsLmZvY3VzT2Zmc2V0KTsKICAgIGlmIChhbmNob3IgJiYgaGVhZCkgeyBydW5Jbk9wKGNtLCBmdW5jdGlvbiAoKSB7CiAgICAgIHNldFNlbGVjdGlvbihjbS5kb2MsIHNpbXBsZVNlbGVjdGlvbihhbmNob3IsIGhlYWQpLCBzZWxfZG9udFNjcm9sbCk7CiAgICAgIGlmIChhbmNob3IuYmFkIHx8IGhlYWQuYmFkKSB7IGNtLmN1ck9wLnNlbGVjdGlvbkNoYW5nZWQgPSB0cnVlOyB9CiAgICB9KTsgfQogIH07CgogIENvbnRlbnRFZGl0YWJsZUlucHV0LnByb3RvdHlwZS5wb2xsQ29udGVudCA9IGZ1bmN0aW9uICgpIHsKICAgIGlmICh0aGlzLnJlYWRET01UaW1lb3V0ICE9IG51bGwpIHsKICAgICAgY2xlYXJUaW1lb3V0KHRoaXMucmVhZERPTVRpbWVvdXQpOwogICAgICB0aGlzLnJlYWRET01UaW1lb3V0ID0gbnVsbDsKICAgIH0KCiAgICB2YXIgY20gPSB0aGlzLmNtLCBkaXNwbGF5ID0gY20uZGlzcGxheSwgc2VsID0gY20uZG9jLnNlbC5wcmltYXJ5KCk7CiAgICB2YXIgZnJvbSA9IHNlbC5mcm9tKCksIHRvID0gc2VsLnRvKCk7CiAgICBpZiAoZnJvbS5jaCA9PSAwICYmIGZyb20ubGluZSA+IGNtLmZpcnN0TGluZSgpKQogICAgICB7IGZyb20gPSBQb3MoZnJvbS5saW5lIC0gMSwgZ2V0TGluZShjbS5kb2MsIGZyb20ubGluZSAtIDEpLmxlbmd0aCk7IH0KICAgIGlmICh0by5jaCA9PSBnZXRMaW5lKGNtLmRvYywgdG8ubGluZSkudGV4dC5sZW5ndGggJiYgdG8ubGluZSA8IGNtLmxhc3RMaW5lKCkpCiAgICAgIHsgdG8gPSBQb3ModG8ubGluZSArIDEsIDApOyB9CiAgICBpZiAoZnJvbS5saW5lIDwgZGlzcGxheS52aWV3RnJvbSB8fCB0by5saW5lID4gZGlzcGxheS52aWV3VG8gLSAxKSB7IHJldHVybiBmYWxzZSB9CgogICAgdmFyIGZyb21JbmRleCwgZnJvbUxpbmUsIGZyb21Ob2RlOwogICAgaWYgKGZyb20ubGluZSA9PSBkaXNwbGF5LnZpZXdGcm9tIHx8IChmcm9tSW5kZXggPSBmaW5kVmlld0luZGV4KGNtLCBmcm9tLmxpbmUpKSA9PSAwKSB7CiAgICAgIGZyb21MaW5lID0gbGluZU5vKGRpc3BsYXkudmlld1swXS5saW5lKTsKICAgICAgZnJvbU5vZGUgPSBkaXNwbGF5LnZpZXdbMF0ubm9kZTsKICAgIH0gZWxzZSB7CiAgICAgIGZyb21MaW5lID0gbGluZU5vKGRpc3BsYXkudmlld1tmcm9tSW5kZXhdLmxpbmUpOwogICAgICBmcm9tTm9kZSA9IGRpc3BsYXkudmlld1tmcm9tSW5kZXggLSAxXS5ub2RlLm5leHRTaWJsaW5nOwogICAgfQogICAgdmFyIHRvSW5kZXggPSBmaW5kVmlld0luZGV4KGNtLCB0by5saW5lKTsKICAgIHZhciB0b0xpbmUsIHRvTm9kZTsKICAgIGlmICh0b0luZGV4ID09IGRpc3BsYXkudmlldy5sZW5ndGggLSAxKSB7CiAgICAgIHRvTGluZSA9IGRpc3BsYXkudmlld1RvIC0gMTsKICAgICAgdG9Ob2RlID0gZGlzcGxheS5saW5lRGl2Lmxhc3RDaGlsZDsKICAgIH0gZWxzZSB7CiAgICAgIHRvTGluZSA9IGxpbmVObyhkaXNwbGF5LnZpZXdbdG9JbmRleCArIDFdLmxpbmUpIC0gMTsKICAgICAgdG9Ob2RlID0gZGlzcGxheS52aWV3W3RvSW5kZXggKyAxXS5ub2RlLnByZXZpb3VzU2libGluZzsKICAgIH0KCiAgICBpZiAoIWZyb21Ob2RlKSB7IHJldHVybiBmYWxzZSB9CiAgICB2YXIgbmV3VGV4dCA9IGNtLmRvYy5zcGxpdExpbmVzKGRvbVRleHRCZXR3ZWVuKGNtLCBmcm9tTm9kZSwgdG9Ob2RlLCBmcm9tTGluZSwgdG9MaW5lKSk7CiAgICB2YXIgb2xkVGV4dCA9IGdldEJldHdlZW4oY20uZG9jLCBQb3MoZnJvbUxpbmUsIDApLCBQb3ModG9MaW5lLCBnZXRMaW5lKGNtLmRvYywgdG9MaW5lKS50ZXh0Lmxlbmd0aCkpOwogICAgd2hpbGUgKG5ld1RleHQubGVuZ3RoID4gMSAmJiBvbGRUZXh0Lmxlbmd0aCA+IDEpIHsKICAgICAgaWYgKGxzdChuZXdUZXh0KSA9PSBsc3Qob2xkVGV4dCkpIHsgbmV3VGV4dC5wb3AoKTsgb2xkVGV4dC5wb3AoKTsgdG9MaW5lLS07IH0KICAgICAgZWxzZSBpZiAobmV3VGV4dFswXSA9PSBvbGRUZXh0WzBdKSB7IG5ld1RleHQuc2hpZnQoKTsgb2xkVGV4dC5zaGlmdCgpOyBmcm9tTGluZSsrOyB9CiAgICAgIGVsc2UgeyBicmVhayB9CiAgICB9CgogICAgdmFyIGN1dEZyb250ID0gMCwgY3V0RW5kID0gMDsKICAgIHZhciBuZXdUb3AgPSBuZXdUZXh0WzBdLCBvbGRUb3AgPSBvbGRUZXh0WzBdLCBtYXhDdXRGcm9udCA9IE1hdGgubWluKG5ld1RvcC5sZW5ndGgsIG9sZFRvcC5sZW5ndGgpOwogICAgd2hpbGUgKGN1dEZyb250IDwgbWF4Q3V0RnJvbnQgJiYgbmV3VG9wLmNoYXJDb2RlQXQoY3V0RnJvbnQpID09IG9sZFRvcC5jaGFyQ29kZUF0KGN1dEZyb250KSkKICAgICAgeyArK2N1dEZyb250OyB9CiAgICB2YXIgbmV3Qm90ID0gbHN0KG5ld1RleHQpLCBvbGRCb3QgPSBsc3Qob2xkVGV4dCk7CiAgICB2YXIgbWF4Q3V0RW5kID0gTWF0aC5taW4obmV3Qm90Lmxlbmd0aCAtIChuZXdUZXh0Lmxlbmd0aCA9PSAxID8gY3V0RnJvbnQgOiAwKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbGRCb3QubGVuZ3RoIC0gKG9sZFRleHQubGVuZ3RoID09IDEgPyBjdXRGcm9udCA6IDApKTsKICAgIHdoaWxlIChjdXRFbmQgPCBtYXhDdXRFbmQgJiYKICAgICAgICAgICBuZXdCb3QuY2hhckNvZGVBdChuZXdCb3QubGVuZ3RoIC0gY3V0RW5kIC0gMSkgPT0gb2xkQm90LmNoYXJDb2RlQXQob2xkQm90Lmxlbmd0aCAtIGN1dEVuZCAtIDEpKQogICAgICB7ICsrY3V0RW5kOyB9CiAgICAvLyBUcnkgdG8gbW92ZSBzdGFydCBvZiBjaGFuZ2UgdG8gc3RhcnQgb2Ygc2VsZWN0aW9uIGlmIGFtYmlndW91cwogICAgaWYgKG5ld1RleHQubGVuZ3RoID09IDEgJiYgb2xkVGV4dC5sZW5ndGggPT0gMSAmJiBmcm9tTGluZSA9PSBmcm9tLmxpbmUpIHsKICAgICAgd2hpbGUgKGN1dEZyb250ICYmIGN1dEZyb250ID4gZnJvbS5jaCAmJgogICAgICAgICAgICAgbmV3Qm90LmNoYXJDb2RlQXQobmV3Qm90Lmxlbmd0aCAtIGN1dEVuZCAtIDEpID09IG9sZEJvdC5jaGFyQ29kZUF0KG9sZEJvdC5sZW5ndGggLSBjdXRFbmQgLSAxKSkgewogICAgICAgIGN1dEZyb250LS07CiAgICAgICAgY3V0RW5kKys7CiAgICAgIH0KICAgIH0KCiAgICBuZXdUZXh0W25ld1RleHQubGVuZ3RoIC0gMV0gPSBuZXdCb3Quc2xpY2UoMCwgbmV3Qm90Lmxlbmd0aCAtIGN1dEVuZCkucmVwbGFjZSgvXlx1MjAwYisvLCAiIik7CiAgICBuZXdUZXh0WzBdID0gbmV3VGV4dFswXS5zbGljZShjdXRGcm9udCkucmVwbGFjZSgvXHUyMDBiKyQvLCAiIik7CgogICAgdmFyIGNoRnJvbSA9IFBvcyhmcm9tTGluZSwgY3V0RnJvbnQpOwogICAgdmFyIGNoVG8gPSBQb3ModG9MaW5lLCBvbGRUZXh0Lmxlbmd0aCA/IGxzdChvbGRUZXh0KS5sZW5ndGggLSBjdXRFbmQgOiAwKTsKICAgIGlmIChuZXdUZXh0Lmxlbmd0aCA+IDEgfHwgbmV3VGV4dFswXSB8fCBjbXAoY2hGcm9tLCBjaFRvKSkgewogICAgICByZXBsYWNlUmFuZ2UoY20uZG9jLCBuZXdUZXh0LCBjaEZyb20sIGNoVG8sICIraW5wdXQiKTsKICAgICAgcmV0dXJuIHRydWUKICAgIH0KICB9OwoKICBDb250ZW50RWRpdGFibGVJbnB1dC5wcm90b3R5cGUuZW5zdXJlUG9sbGVkID0gZnVuY3Rpb24gKCkgewogICAgdGhpcy5mb3JjZUNvbXBvc2l0aW9uRW5kKCk7CiAgfTsKICBDb250ZW50RWRpdGFibGVJbnB1dC5wcm90b3R5cGUucmVzZXQgPSBmdW5jdGlvbiAoKSB7CiAgICB0aGlzLmZvcmNlQ29tcG9zaXRpb25FbmQoKTsKICB9OwogIENvbnRlbnRFZGl0YWJsZUlucHV0LnByb3RvdHlwZS5mb3JjZUNvbXBvc2l0aW9uRW5kID0gZnVuY3Rpb24gKCkgewogICAgaWYgKCF0aGlzLmNvbXBvc2luZykgeyByZXR1cm4gfQogICAgY2xlYXJUaW1lb3V0KHRoaXMucmVhZERPTVRpbWVvdXQpOwogICAgdGhpcy5jb21wb3NpbmcgPSBudWxsOwogICAgdGhpcy51cGRhdGVGcm9tRE9NKCk7CiAgICB0aGlzLmRpdi5ibHVyKCk7CiAgICB0aGlzLmRpdi5mb2N1cygpOwogIH07CiAgQ29udGVudEVkaXRhYmxlSW5wdXQucHJvdG90eXBlLnJlYWRGcm9tRE9NU29vbiA9IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIHRoaXMkMSA9IHRoaXM7CgogICAgaWYgKHRoaXMucmVhZERPTVRpbWVvdXQgIT0gbnVsbCkgeyByZXR1cm4gfQogICAgdGhpcy5yZWFkRE9NVGltZW91dCA9IHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICB0aGlzJDEucmVhZERPTVRpbWVvdXQgPSBudWxsOwogICAgICBpZiAodGhpcyQxLmNvbXBvc2luZykgewogICAgICAgIGlmICh0aGlzJDEuY29tcG9zaW5nLmRvbmUpIHsgdGhpcyQxLmNvbXBvc2luZyA9IG51bGw7IH0KICAgICAgICBlbHNlIHsgcmV0dXJuIH0KICAgICAgfQogICAgICB0aGlzJDEudXBkYXRlRnJvbURPTSgpOwogICAgfSwgODApOwogIH07CgogIENvbnRlbnRFZGl0YWJsZUlucHV0LnByb3RvdHlwZS51cGRhdGVGcm9tRE9NID0gZnVuY3Rpb24gKCkgewogICAgICB2YXIgdGhpcyQxID0gdGhpczsKCiAgICBpZiAodGhpcy5jbS5pc1JlYWRPbmx5KCkgfHwgIXRoaXMucG9sbENvbnRlbnQoKSkKICAgICAgeyBydW5Jbk9wKHRoaXMuY20sIGZ1bmN0aW9uICgpIHsgcmV0dXJuIHJlZ0NoYW5nZSh0aGlzJDEuY20pOyB9KTsgfQogIH07CgogIENvbnRlbnRFZGl0YWJsZUlucHV0LnByb3RvdHlwZS5zZXRVbmVkaXRhYmxlID0gZnVuY3Rpb24gKG5vZGUpIHsKICAgIG5vZGUuY29udGVudEVkaXRhYmxlID0gImZhbHNlIjsKICB9OwoKICBDb250ZW50RWRpdGFibGVJbnB1dC5wcm90b3R5cGUub25LZXlQcmVzcyA9IGZ1bmN0aW9uIChlKSB7CiAgICBpZiAoZS5jaGFyQ29kZSA9PSAwIHx8IHRoaXMuY29tcG9zaW5nKSB7IHJldHVybiB9CiAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICBpZiAoIXRoaXMuY20uaXNSZWFkT25seSgpKQogICAgICB7IG9wZXJhdGlvbih0aGlzLmNtLCBhcHBseVRleHRJbnB1dCkodGhpcy5jbSwgU3RyaW5nLmZyb21DaGFyQ29kZShlLmNoYXJDb2RlID09IG51bGwgPyBlLmtleUNvZGUgOiBlLmNoYXJDb2RlKSwgMCk7IH0KICB9OwoKICBDb250ZW50RWRpdGFibGVJbnB1dC5wcm90b3R5cGUucmVhZE9ubHlDaGFuZ2VkID0gZnVuY3Rpb24gKHZhbCkgewogICAgdGhpcy5kaXYuY29udGVudEVkaXRhYmxlID0gU3RyaW5nKHZhbCAhPSAibm9jdXJzb3IiKTsKICB9OwoKICBDb250ZW50RWRpdGFibGVJbnB1dC5wcm90b3R5cGUub25Db250ZXh0TWVudSA9IGZ1bmN0aW9uICgpIHt9OwogIENvbnRlbnRFZGl0YWJsZUlucHV0LnByb3RvdHlwZS5yZXNldFBvc2l0aW9uID0gZnVuY3Rpb24gKCkge307CgogIENvbnRlbnRFZGl0YWJsZUlucHV0LnByb3RvdHlwZS5uZWVkc0NvbnRlbnRBdHRyaWJ1dGUgPSB0cnVlOwoKICBmdW5jdGlvbiBwb3NUb0RPTShjbSwgcG9zKSB7CiAgICB2YXIgdmlldyA9IGZpbmRWaWV3Rm9yTGluZShjbSwgcG9zLmxpbmUpOwogICAgaWYgKCF2aWV3IHx8IHZpZXcuaGlkZGVuKSB7IHJldHVybiBudWxsIH0KICAgIHZhciBsaW5lID0gZ2V0TGluZShjbS5kb2MsIHBvcy5saW5lKTsKICAgIHZhciBpbmZvID0gbWFwRnJvbUxpbmVWaWV3KHZpZXcsIGxpbmUsIHBvcy5saW5lKTsKCiAgICB2YXIgb3JkZXIgPSBnZXRPcmRlcihsaW5lLCBjbS5kb2MuZGlyZWN0aW9uKSwgc2lkZSA9ICJsZWZ0IjsKICAgIGlmIChvcmRlcikgewogICAgICB2YXIgcGFydFBvcyA9IGdldEJpZGlQYXJ0QXQob3JkZXIsIHBvcy5jaCk7CiAgICAgIHNpZGUgPSBwYXJ0UG9zICUgMiA/ICJyaWdodCIgOiAibGVmdCI7CiAgICB9CiAgICB2YXIgcmVzdWx0ID0gbm9kZUFuZE9mZnNldEluTGluZU1hcChpbmZvLm1hcCwgcG9zLmNoLCBzaWRlKTsKICAgIHJlc3VsdC5vZmZzZXQgPSByZXN1bHQuY29sbGFwc2UgPT0gInJpZ2h0IiA/IHJlc3VsdC5lbmQgOiByZXN1bHQuc3RhcnQ7CiAgICByZXR1cm4gcmVzdWx0CiAgfQoKICBmdW5jdGlvbiBpc0luR3V0dGVyKG5vZGUpIHsKICAgIGZvciAodmFyIHNjYW4gPSBub2RlOyBzY2FuOyBzY2FuID0gc2Nhbi5wYXJlbnROb2RlKQogICAgICB7IGlmICgvQ29kZU1pcnJvci1ndXR0ZXItd3JhcHBlci8udGVzdChzY2FuLmNsYXNzTmFtZSkpIHsgcmV0dXJuIHRydWUgfSB9CiAgICByZXR1cm4gZmFsc2UKICB9CgogIGZ1bmN0aW9uIGJhZFBvcyhwb3MsIGJhZCkgeyBpZiAoYmFkKSB7IHBvcy5iYWQgPSB0cnVlOyB9IHJldHVybiBwb3MgfQoKICBmdW5jdGlvbiBkb21UZXh0QmV0d2VlbihjbSwgZnJvbSwgdG8sIGZyb21MaW5lLCB0b0xpbmUpIHsKICAgIHZhciB0ZXh0ID0gIiIsIGNsb3NpbmcgPSBmYWxzZSwgbGluZVNlcCA9IGNtLmRvYy5saW5lU2VwYXJhdG9yKCksIGV4dHJhTGluZWJyZWFrID0gZmFsc2U7CiAgICBmdW5jdGlvbiByZWNvZ25pemVNYXJrZXIoaWQpIHsgcmV0dXJuIGZ1bmN0aW9uIChtYXJrZXIpIHsgcmV0dXJuIG1hcmtlci5pZCA9PSBpZDsgfSB9CiAgICBmdW5jdGlvbiBjbG9zZSgpIHsKICAgICAgaWYgKGNsb3NpbmcpIHsKICAgICAgICB0ZXh0ICs9IGxpbmVTZXA7CiAgICAgICAgaWYgKGV4dHJhTGluZWJyZWFrKSB7IHRleHQgKz0gbGluZVNlcDsgfQogICAgICAgIGNsb3NpbmcgPSBleHRyYUxpbmVicmVhayA9IGZhbHNlOwogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBhZGRUZXh0KHN0cikgewogICAgICBpZiAoc3RyKSB7CiAgICAgICAgY2xvc2UoKTsKICAgICAgICB0ZXh0ICs9IHN0cjsKICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gd2Fsayhub2RlKSB7CiAgICAgIGlmIChub2RlLm5vZGVUeXBlID09IDEpIHsKICAgICAgICB2YXIgY21UZXh0ID0gbm9kZS5nZXRBdHRyaWJ1dGUoImNtLXRleHQiKTsKICAgICAgICBpZiAoY21UZXh0KSB7CiAgICAgICAgICBhZGRUZXh0KGNtVGV4dCk7CiAgICAgICAgICByZXR1cm4KICAgICAgICB9CiAgICAgICAgdmFyIG1hcmtlcklEID0gbm9kZS5nZXRBdHRyaWJ1dGUoImNtLW1hcmtlciIpLCByYW5nZSQkMTsKICAgICAgICBpZiAobWFya2VySUQpIHsKICAgICAgICAgIHZhciBmb3VuZCA9IGNtLmZpbmRNYXJrcyhQb3MoZnJvbUxpbmUsIDApLCBQb3ModG9MaW5lICsgMSwgMCksIHJlY29nbml6ZU1hcmtlcigrbWFya2VySUQpKTsKICAgICAgICAgIGlmIChmb3VuZC5sZW5ndGggJiYgKHJhbmdlJCQxID0gZm91bmRbMF0uZmluZCgwKSkpCiAgICAgICAgICAgIHsgYWRkVGV4dChnZXRCZXR3ZWVuKGNtLmRvYywgcmFuZ2UkJDEuZnJvbSwgcmFuZ2UkJDEudG8pLmpvaW4obGluZVNlcCkpOyB9CiAgICAgICAgICByZXR1cm4KICAgICAgICB9CiAgICAgICAgaWYgKG5vZGUuZ2V0QXR0cmlidXRlKCJjb250ZW50ZWRpdGFibGUiKSA9PSAiZmFsc2UiKSB7IHJldHVybiB9CiAgICAgICAgdmFyIGlzQmxvY2sgPSAvXihwcmV8ZGl2fHB8bGl8dGFibGV8YnIpJC9pLnRlc3Qobm9kZS5ub2RlTmFtZSk7CiAgICAgICAgaWYgKCEvXmJyJC9pLnRlc3Qobm9kZS5ub2RlTmFtZSkgJiYgbm9kZS50ZXh0Q29udGVudC5sZW5ndGggPT0gMCkgeyByZXR1cm4gfQoKICAgICAgICBpZiAoaXNCbG9jaykgeyBjbG9zZSgpOyB9CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBub2RlLmNoaWxkTm9kZXMubGVuZ3RoOyBpKyspCiAgICAgICAgICB7IHdhbGsobm9kZS5jaGlsZE5vZGVzW2ldKTsgfQoKICAgICAgICBpZiAoL14ocHJlfHApJC9pLnRlc3Qobm9kZS5ub2RlTmFtZSkpIHsgZXh0cmFMaW5lYnJlYWsgPSB0cnVlOyB9CiAgICAgICAgaWYgKGlzQmxvY2spIHsgY2xvc2luZyA9IHRydWU7IH0KICAgICAgfSBlbHNlIGlmIChub2RlLm5vZGVUeXBlID09IDMpIHsKICAgICAgICBhZGRUZXh0KG5vZGUubm9kZVZhbHVlLnJlcGxhY2UoL1x1MjAwYi9nLCAiIikucmVwbGFjZSgvXHUwMGEwL2csICIgIikpOwogICAgICB9CiAgICB9CiAgICBmb3IgKDs7KSB7CiAgICAgIHdhbGsoZnJvbSk7CiAgICAgIGlmIChmcm9tID09IHRvKSB7IGJyZWFrIH0KICAgICAgZnJvbSA9IGZyb20ubmV4dFNpYmxpbmc7CiAgICAgIGV4dHJhTGluZWJyZWFrID0gZmFsc2U7CiAgICB9CiAgICByZXR1cm4gdGV4dAogIH0KCiAgZnVuY3Rpb24gZG9tVG9Qb3MoY20sIG5vZGUsIG9mZnNldCkgewogICAgdmFyIGxpbmVOb2RlOwogICAgaWYgKG5vZGUgPT0gY20uZGlzcGxheS5saW5lRGl2KSB7CiAgICAgIGxpbmVOb2RlID0gY20uZGlzcGxheS5saW5lRGl2LmNoaWxkTm9kZXNbb2Zmc2V0XTsKICAgICAgaWYgKCFsaW5lTm9kZSkgeyByZXR1cm4gYmFkUG9zKGNtLmNsaXBQb3MoUG9zKGNtLmRpc3BsYXkudmlld1RvIC0gMSkpLCB0cnVlKSB9CiAgICAgIG5vZGUgPSBudWxsOyBvZmZzZXQgPSAwOwogICAgfSBlbHNlIHsKICAgICAgZm9yIChsaW5lTm9kZSA9IG5vZGU7OyBsaW5lTm9kZSA9IGxpbmVOb2RlLnBhcmVudE5vZGUpIHsKICAgICAgICBpZiAoIWxpbmVOb2RlIHx8IGxpbmVOb2RlID09IGNtLmRpc3BsYXkubGluZURpdikgeyByZXR1cm4gbnVsbCB9CiAgICAgICAgaWYgKGxpbmVOb2RlLnBhcmVudE5vZGUgJiYgbGluZU5vZGUucGFyZW50Tm9kZSA9PSBjbS5kaXNwbGF5LmxpbmVEaXYpIHsgYnJlYWsgfQogICAgICB9CiAgICB9CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNtLmRpc3BsYXkudmlldy5sZW5ndGg7IGkrKykgewogICAgICB2YXIgbGluZVZpZXcgPSBjbS5kaXNwbGF5LnZpZXdbaV07CiAgICAgIGlmIChsaW5lVmlldy5ub2RlID09IGxpbmVOb2RlKQogICAgICAgIHsgcmV0dXJuIGxvY2F0ZU5vZGVJbkxpbmVWaWV3KGxpbmVWaWV3LCBub2RlLCBvZmZzZXQpIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIGxvY2F0ZU5vZGVJbkxpbmVWaWV3KGxpbmVWaWV3LCBub2RlLCBvZmZzZXQpIHsKICAgIHZhciB3cmFwcGVyID0gbGluZVZpZXcudGV4dC5maXJzdENoaWxkLCBiYWQgPSBmYWxzZTsKICAgIGlmICghbm9kZSB8fCAhY29udGFpbnMod3JhcHBlciwgbm9kZSkpIHsgcmV0dXJuIGJhZFBvcyhQb3MobGluZU5vKGxpbmVWaWV3LmxpbmUpLCAwKSwgdHJ1ZSkgfQogICAgaWYgKG5vZGUgPT0gd3JhcHBlcikgewogICAgICBiYWQgPSB0cnVlOwogICAgICBub2RlID0gd3JhcHBlci5jaGlsZE5vZGVzW29mZnNldF07CiAgICAgIG9mZnNldCA9IDA7CiAgICAgIGlmICghbm9kZSkgewogICAgICAgIHZhciBsaW5lID0gbGluZVZpZXcucmVzdCA/IGxzdChsaW5lVmlldy5yZXN0KSA6IGxpbmVWaWV3LmxpbmU7CiAgICAgICAgcmV0dXJuIGJhZFBvcyhQb3MobGluZU5vKGxpbmUpLCBsaW5lLnRleHQubGVuZ3RoKSwgYmFkKQogICAgICB9CiAgICB9CgogICAgdmFyIHRleHROb2RlID0gbm9kZS5ub2RlVHlwZSA9PSAzID8gbm9kZSA6IG51bGwsIHRvcE5vZGUgPSBub2RlOwogICAgaWYgKCF0ZXh0Tm9kZSAmJiBub2RlLmNoaWxkTm9kZXMubGVuZ3RoID09IDEgJiYgbm9kZS5maXJzdENoaWxkLm5vZGVUeXBlID09IDMpIHsKICAgICAgdGV4dE5vZGUgPSBub2RlLmZpcnN0Q2hpbGQ7CiAgICAgIGlmIChvZmZzZXQpIHsgb2Zmc2V0ID0gdGV4dE5vZGUubm9kZVZhbHVlLmxlbmd0aDsgfQogICAgfQogICAgd2hpbGUgKHRvcE5vZGUucGFyZW50Tm9kZSAhPSB3cmFwcGVyKSB7IHRvcE5vZGUgPSB0b3BOb2RlLnBhcmVudE5vZGU7IH0KICAgIHZhciBtZWFzdXJlID0gbGluZVZpZXcubWVhc3VyZSwgbWFwcyA9IG1lYXN1cmUubWFwczsKCiAgICBmdW5jdGlvbiBmaW5kKHRleHROb2RlLCB0b3BOb2RlLCBvZmZzZXQpIHsKICAgICAgZm9yICh2YXIgaSA9IC0xOyBpIDwgKG1hcHMgPyBtYXBzLmxlbmd0aCA6IDApOyBpKyspIHsKICAgICAgICB2YXIgbWFwJCQxID0gaSA8IDAgPyBtZWFzdXJlLm1hcCA6IG1hcHNbaV07CiAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBtYXAkJDEubGVuZ3RoOyBqICs9IDMpIHsKICAgICAgICAgIHZhciBjdXJOb2RlID0gbWFwJCQxW2ogKyAyXTsKICAgICAgICAgIGlmIChjdXJOb2RlID09IHRleHROb2RlIHx8IGN1ck5vZGUgPT0gdG9wTm9kZSkgewogICAgICAgICAgICB2YXIgbGluZSA9IGxpbmVObyhpIDwgMCA/IGxpbmVWaWV3LmxpbmUgOiBsaW5lVmlldy5yZXN0W2ldKTsKICAgICAgICAgICAgdmFyIGNoID0gbWFwJCQxW2pdICsgb2Zmc2V0OwogICAgICAgICAgICBpZiAob2Zmc2V0IDwgMCB8fCBjdXJOb2RlICE9IHRleHROb2RlKSB7IGNoID0gbWFwJCQxW2ogKyAob2Zmc2V0ID8gMSA6IDApXTsgfQogICAgICAgICAgICByZXR1cm4gUG9zKGxpbmUsIGNoKQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogICAgdmFyIGZvdW5kID0gZmluZCh0ZXh0Tm9kZSwgdG9wTm9kZSwgb2Zmc2V0KTsKICAgIGlmIChmb3VuZCkgeyByZXR1cm4gYmFkUG9zKGZvdW5kLCBiYWQpIH0KCiAgICAvLyBGSVhNRSB0aGlzIGlzIGFsbCByZWFsbHkgc2hha3kuIG1pZ2h0IGhhbmRsZSB0aGUgZmV3IGNhc2VzIGl0IG5lZWRzIHRvIGhhbmRsZSwgYnV0IGxpa2VseSB0byBjYXVzZSBwcm9ibGVtcwogICAgZm9yICh2YXIgYWZ0ZXIgPSB0b3BOb2RlLm5leHRTaWJsaW5nLCBkaXN0ID0gdGV4dE5vZGUgPyB0ZXh0Tm9kZS5ub2RlVmFsdWUubGVuZ3RoIC0gb2Zmc2V0IDogMDsgYWZ0ZXI7IGFmdGVyID0gYWZ0ZXIubmV4dFNpYmxpbmcpIHsKICAgICAgZm91bmQgPSBmaW5kKGFmdGVyLCBhZnRlci5maXJzdENoaWxkLCAwKTsKICAgICAgaWYgKGZvdW5kKQogICAgICAgIHsgcmV0dXJuIGJhZFBvcyhQb3MoZm91bmQubGluZSwgZm91bmQuY2ggLSBkaXN0KSwgYmFkKSB9CiAgICAgIGVsc2UKICAgICAgICB7IGRpc3QgKz0gYWZ0ZXIudGV4dENvbnRlbnQubGVuZ3RoOyB9CiAgICB9CiAgICBmb3IgKHZhciBiZWZvcmUgPSB0b3BOb2RlLnByZXZpb3VzU2libGluZywgZGlzdCQxID0gb2Zmc2V0OyBiZWZvcmU7IGJlZm9yZSA9IGJlZm9yZS5wcmV2aW91c1NpYmxpbmcpIHsKICAgICAgZm91bmQgPSBmaW5kKGJlZm9yZSwgYmVmb3JlLmZpcnN0Q2hpbGQsIC0xKTsKICAgICAgaWYgKGZvdW5kKQogICAgICAgIHsgcmV0dXJuIGJhZFBvcyhQb3MoZm91bmQubGluZSwgZm91bmQuY2ggKyBkaXN0JDEpLCBiYWQpIH0KICAgICAgZWxzZQogICAgICAgIHsgZGlzdCQxICs9IGJlZm9yZS50ZXh0Q29udGVudC5sZW5ndGg7IH0KICAgIH0KICB9CgogIC8vIFRFWFRBUkVBIElOUFVUIFNUWUxFCgogIHZhciBUZXh0YXJlYUlucHV0ID0gZnVuY3Rpb24oY20pIHsKICAgIHRoaXMuY20gPSBjbTsKICAgIC8vIFNlZSBpbnB1dC5wb2xsIGFuZCBpbnB1dC5yZXNldAogICAgdGhpcy5wcmV2SW5wdXQgPSAiIjsKCiAgICAvLyBGbGFnIHRoYXQgaW5kaWNhdGVzIHdoZXRoZXIgd2UgZXhwZWN0IGlucHV0IHRvIGFwcGVhciByZWFsIHNvb24KICAgIC8vIG5vdyAoYWZ0ZXIgc29tZSBldmVudCBsaWtlICdrZXlwcmVzcycgb3IgJ2lucHV0JykgYW5kIGFyZQogICAgLy8gcG9sbGluZyBpbnRlbnNpdmVseS4KICAgIHRoaXMucG9sbGluZ0Zhc3QgPSBmYWxzZTsKICAgIC8vIFNlbGYtcmVzZXR0aW5nIHRpbWVvdXQgZm9yIHRoZSBwb2xsZXIKICAgIHRoaXMucG9sbGluZyA9IG5ldyBEZWxheWVkKCk7CiAgICAvLyBVc2VkIHRvIHdvcmsgYXJvdW5kIElFIGlzc3VlIHdpdGggc2VsZWN0aW9uIGJlaW5nIGZvcmdvdHRlbiB3aGVuIGZvY3VzIG1vdmVzIGF3YXkgZnJvbSB0ZXh0YXJlYQogICAgdGhpcy5oYXNTZWxlY3Rpb24gPSBmYWxzZTsKICAgIHRoaXMuY29tcG9zaW5nID0gbnVsbDsKICB9OwoKICBUZXh0YXJlYUlucHV0LnByb3RvdHlwZS5pbml0ID0gZnVuY3Rpb24gKGRpc3BsYXkpIHsKICAgICAgdmFyIHRoaXMkMSA9IHRoaXM7CgogICAgdmFyIGlucHV0ID0gdGhpcywgY20gPSB0aGlzLmNtOwogICAgdGhpcy5jcmVhdGVGaWVsZChkaXNwbGF5KTsKICAgIHZhciB0ZSA9IHRoaXMudGV4dGFyZWE7CgogICAgZGlzcGxheS53cmFwcGVyLmluc2VydEJlZm9yZSh0aGlzLndyYXBwZXIsIGRpc3BsYXkud3JhcHBlci5maXJzdENoaWxkKTsKCiAgICAvLyBOZWVkZWQgdG8gaGlkZSBiaWcgYmx1ZSBibGlua2luZyBjdXJzb3Igb24gTW9iaWxlIFNhZmFyaSAoZG9lc24ndCBzZWVtIHRvIHdvcmsgaW4gaU9TIDggYW55bW9yZSkKICAgIGlmIChpb3MpIHsgdGUuc3R5bGUud2lkdGggPSAiMHB4IjsgfQoKICAgIG9uKHRlLCAiaW5wdXQiLCBmdW5jdGlvbiAoKSB7CiAgICAgIGlmIChpZSAmJiBpZV92ZXJzaW9uID49IDkgJiYgdGhpcyQxLmhhc1NlbGVjdGlvbikgeyB0aGlzJDEuaGFzU2VsZWN0aW9uID0gbnVsbDsgfQogICAgICBpbnB1dC5wb2xsKCk7CiAgICB9KTsKCiAgICBvbih0ZSwgInBhc3RlIiwgZnVuY3Rpb24gKGUpIHsKICAgICAgaWYgKHNpZ25hbERPTUV2ZW50KGNtLCBlKSB8fCBoYW5kbGVQYXN0ZShlLCBjbSkpIHsgcmV0dXJuIH0KCiAgICAgIGNtLnN0YXRlLnBhc3RlSW5jb21pbmcgPSArbmV3IERhdGU7CiAgICAgIGlucHV0LmZhc3RQb2xsKCk7CiAgICB9KTsKCiAgICBmdW5jdGlvbiBwcmVwYXJlQ29weUN1dChlKSB7CiAgICAgIGlmIChzaWduYWxET01FdmVudChjbSwgZSkpIHsgcmV0dXJuIH0KICAgICAgaWYgKGNtLnNvbWV0aGluZ1NlbGVjdGVkKCkpIHsKICAgICAgICBzZXRMYXN0Q29waWVkKHtsaW5lV2lzZTogZmFsc2UsIHRleHQ6IGNtLmdldFNlbGVjdGlvbnMoKX0pOwogICAgICB9IGVsc2UgaWYgKCFjbS5vcHRpb25zLmxpbmVXaXNlQ29weUN1dCkgewogICAgICAgIHJldHVybgogICAgICB9IGVsc2UgewogICAgICAgIHZhciByYW5nZXMgPSBjb3B5YWJsZVJhbmdlcyhjbSk7CiAgICAgICAgc2V0TGFzdENvcGllZCh7bGluZVdpc2U6IHRydWUsIHRleHQ6IHJhbmdlcy50ZXh0fSk7CiAgICAgICAgaWYgKGUudHlwZSA9PSAiY3V0IikgewogICAgICAgICAgY20uc2V0U2VsZWN0aW9ucyhyYW5nZXMucmFuZ2VzLCBudWxsLCBzZWxfZG9udFNjcm9sbCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlucHV0LnByZXZJbnB1dCA9ICIiOwogICAgICAgICAgdGUudmFsdWUgPSByYW5nZXMudGV4dC5qb2luKCJcbiIpOwogICAgICAgICAgc2VsZWN0SW5wdXQodGUpOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoZS50eXBlID09ICJjdXQiKSB7IGNtLnN0YXRlLmN1dEluY29taW5nID0gK25ldyBEYXRlOyB9CiAgICB9CiAgICBvbih0ZSwgImN1dCIsIHByZXBhcmVDb3B5Q3V0KTsKICAgIG9uKHRlLCAiY29weSIsIHByZXBhcmVDb3B5Q3V0KTsKCiAgICBvbihkaXNwbGF5LnNjcm9sbGVyLCAicGFzdGUiLCBmdW5jdGlvbiAoZSkgewogICAgICBpZiAoZXZlbnRJbldpZGdldChkaXNwbGF5LCBlKSB8fCBzaWduYWxET01FdmVudChjbSwgZSkpIHsgcmV0dXJuIH0KICAgICAgaWYgKCF0ZS5kaXNwYXRjaEV2ZW50KSB7CiAgICAgICAgY20uc3RhdGUucGFzdGVJbmNvbWluZyA9ICtuZXcgRGF0ZTsKICAgICAgICBpbnB1dC5mb2N1cygpOwogICAgICAgIHJldHVybgogICAgICB9CgogICAgICAvLyBQYXNzIHRoZSBgcGFzdGVgIGV2ZW50IHRvIHRoZSB0ZXh0YXJlYSBzbyBpdCdzIGhhbmRsZWQgYnkgaXRzIGV2ZW50IGxpc3RlbmVyLgogICAgICB2YXIgZXZlbnQgPSBuZXcgRXZlbnQoInBhc3RlIik7CiAgICAgIGV2ZW50LmNsaXBib2FyZERhdGEgPSBlLmNsaXBib2FyZERhdGE7CiAgICAgIHRlLmRpc3BhdGNoRXZlbnQoZXZlbnQpOwogICAgfSk7CgogICAgLy8gUHJldmVudCBub3JtYWwgc2VsZWN0aW9uIGluIHRoZSBlZGl0b3IgKHdlIGhhbmRsZSBvdXIgb3duKQogICAgb24oZGlzcGxheS5saW5lU3BhY2UsICJzZWxlY3RzdGFydCIsIGZ1bmN0aW9uIChlKSB7CiAgICAgIGlmICghZXZlbnRJbldpZGdldChkaXNwbGF5LCBlKSkgeyBlX3ByZXZlbnREZWZhdWx0KGUpOyB9CiAgICB9KTsKCiAgICBvbih0ZSwgImNvbXBvc2l0aW9uc3RhcnQiLCBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBzdGFydCA9IGNtLmdldEN1cnNvcigiZnJvbSIpOwogICAgICBpZiAoaW5wdXQuY29tcG9zaW5nKSB7IGlucHV0LmNvbXBvc2luZy5yYW5nZS5jbGVhcigpOyB9CiAgICAgIGlucHV0LmNvbXBvc2luZyA9IHsKICAgICAgICBzdGFydDogc3RhcnQsCiAgICAgICAgcmFuZ2U6IGNtLm1hcmtUZXh0KHN0YXJ0LCBjbS5nZXRDdXJzb3IoInRvIiksIHtjbGFzc05hbWU6ICJDb2RlTWlycm9yLWNvbXBvc2luZyJ9KQogICAgICB9OwogICAgfSk7CiAgICBvbih0ZSwgImNvbXBvc2l0aW9uZW5kIiwgZnVuY3Rpb24gKCkgewogICAgICBpZiAoaW5wdXQuY29tcG9zaW5nKSB7CiAgICAgICAgaW5wdXQucG9sbCgpOwogICAgICAgIGlucHV0LmNvbXBvc2luZy5yYW5nZS5jbGVhcigpOwogICAgICAgIGlucHV0LmNvbXBvc2luZyA9IG51bGw7CiAgICAgIH0KICAgIH0pOwogIH07CgogIFRleHRhcmVhSW5wdXQucHJvdG90eXBlLmNyZWF0ZUZpZWxkID0gZnVuY3Rpb24gKF9kaXNwbGF5KSB7CiAgICAvLyBXcmFwcyBhbmQgaGlkZXMgaW5wdXQgdGV4dGFyZWEKICAgIHRoaXMud3JhcHBlciA9IGhpZGRlblRleHRhcmVhKCk7CiAgICAvLyBUaGUgc2VtaWhpZGRlbiB0ZXh0YXJlYSB0aGF0IGlzIGZvY3VzZWQgd2hlbiB0aGUgZWRpdG9yIGlzCiAgICAvLyBmb2N1c2VkLCBhbmQgcmVjZWl2ZXMgaW5wdXQuCiAgICB0aGlzLnRleHRhcmVhID0gdGhpcy53cmFwcGVyLmZpcnN0Q2hpbGQ7CiAgfTsKCiAgVGV4dGFyZWFJbnB1dC5wcm90b3R5cGUucHJlcGFyZVNlbGVjdGlvbiA9IGZ1bmN0aW9uICgpIHsKICAgIC8vIFJlZHJhdyB0aGUgc2VsZWN0aW9uIGFuZC9vciBjdXJzb3IKICAgIHZhciBjbSA9IHRoaXMuY20sIGRpc3BsYXkgPSBjbS5kaXNwbGF5LCBkb2MgPSBjbS5kb2M7CiAgICB2YXIgcmVzdWx0ID0gcHJlcGFyZVNlbGVjdGlvbihjbSk7CgogICAgLy8gTW92ZSB0aGUgaGlkZGVuIHRleHRhcmVhIG5lYXIgdGhlIGN1cnNvciB0byBwcmV2ZW50IHNjcm9sbGluZyBhcnRpZmFjdHMKICAgIGlmIChjbS5vcHRpb25zLm1vdmVJbnB1dFdpdGhDdXJzb3IpIHsKICAgICAgdmFyIGhlYWRQb3MgPSBjdXJzb3JDb29yZHMoY20sIGRvYy5zZWwucHJpbWFyeSgpLmhlYWQsICJkaXYiKTsKICAgICAgdmFyIHdyYXBPZmYgPSBkaXNwbGF5LndyYXBwZXIuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCksIGxpbmVPZmYgPSBkaXNwbGF5LmxpbmVEaXYuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICAgIHJlc3VsdC50ZVRvcCA9IE1hdGgubWF4KDAsIE1hdGgubWluKGRpc3BsYXkud3JhcHBlci5jbGllbnRIZWlnaHQgLSAxMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVhZFBvcy50b3AgKyBsaW5lT2ZmLnRvcCAtIHdyYXBPZmYudG9wKSk7CiAgICAgIHJlc3VsdC50ZUxlZnQgPSBNYXRoLm1heCgwLCBNYXRoLm1pbihkaXNwbGF5LndyYXBwZXIuY2xpZW50V2lkdGggLSAxMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhlYWRQb3MubGVmdCArIGxpbmVPZmYubGVmdCAtIHdyYXBPZmYubGVmdCkpOwogICAgfQoKICAgIHJldHVybiByZXN1bHQKICB9OwoKICBUZXh0YXJlYUlucHV0LnByb3RvdHlwZS5zaG93U2VsZWN0aW9uID0gZnVuY3Rpb24gKGRyYXduKSB7CiAgICB2YXIgY20gPSB0aGlzLmNtLCBkaXNwbGF5ID0gY20uZGlzcGxheTsKICAgIHJlbW92ZUNoaWxkcmVuQW5kQWRkKGRpc3BsYXkuY3Vyc29yRGl2LCBkcmF3bi5jdXJzb3JzKTsKICAgIHJlbW92ZUNoaWxkcmVuQW5kQWRkKGRpc3BsYXkuc2VsZWN0aW9uRGl2LCBkcmF3bi5zZWxlY3Rpb24pOwogICAgaWYgKGRyYXduLnRlVG9wICE9IG51bGwpIHsKICAgICAgdGhpcy53cmFwcGVyLnN0eWxlLnRvcCA9IGRyYXduLnRlVG9wICsgInB4IjsKICAgICAgdGhpcy53cmFwcGVyLnN0eWxlLmxlZnQgPSBkcmF3bi50ZUxlZnQgKyAicHgiOwogICAgfQogIH07CgogIC8vIFJlc2V0IHRoZSBpbnB1dCB0byBjb3JyZXNwb25kIHRvIHRoZSBzZWxlY3Rpb24gKG9yIHRvIGJlIGVtcHR5LAogIC8vIHdoZW4gbm90IHR5cGluZyBhbmQgbm90aGluZyBpcyBzZWxlY3RlZCkKICBUZXh0YXJlYUlucHV0LnByb3RvdHlwZS5yZXNldCA9IGZ1bmN0aW9uICh0eXBpbmcpIHsKICAgIGlmICh0aGlzLmNvbnRleHRNZW51UGVuZGluZyB8fCB0aGlzLmNvbXBvc2luZykgeyByZXR1cm4gfQogICAgdmFyIGNtID0gdGhpcy5jbTsKICAgIGlmIChjbS5zb21ldGhpbmdTZWxlY3RlZCgpKSB7CiAgICAgIHRoaXMucHJldklucHV0ID0gIiI7CiAgICAgIHZhciBjb250ZW50ID0gY20uZ2V0U2VsZWN0aW9uKCk7CiAgICAgIHRoaXMudGV4dGFyZWEudmFsdWUgPSBjb250ZW50OwogICAgICBpZiAoY20uc3RhdGUuZm9jdXNlZCkgeyBzZWxlY3RJbnB1dCh0aGlzLnRleHRhcmVhKTsgfQogICAgICBpZiAoaWUgJiYgaWVfdmVyc2lvbiA+PSA5KSB7IHRoaXMuaGFzU2VsZWN0aW9uID0gY29udGVudDsgfQogICAgfSBlbHNlIGlmICghdHlwaW5nKSB7CiAgICAgIHRoaXMucHJldklucHV0ID0gdGhpcy50ZXh0YXJlYS52YWx1ZSA9ICIiOwogICAgICBpZiAoaWUgJiYgaWVfdmVyc2lvbiA+PSA5KSB7IHRoaXMuaGFzU2VsZWN0aW9uID0gbnVsbDsgfQogICAgfQogIH07CgogIFRleHRhcmVhSW5wdXQucHJvdG90eXBlLmdldEZpZWxkID0gZnVuY3Rpb24gKCkgeyByZXR1cm4gdGhpcy50ZXh0YXJlYSB9OwoKICBUZXh0YXJlYUlucHV0LnByb3RvdHlwZS5zdXBwb3J0c1RvdWNoID0gZnVuY3Rpb24gKCkgeyByZXR1cm4gZmFsc2UgfTsKCiAgVGV4dGFyZWFJbnB1dC5wcm90b3R5cGUuZm9jdXMgPSBmdW5jdGlvbiAoKSB7CiAgICBpZiAodGhpcy5jbS5vcHRpb25zLnJlYWRPbmx5ICE9ICJub2N1cnNvciIgJiYgKCFtb2JpbGUgfHwgYWN0aXZlRWx0KCkgIT0gdGhpcy50ZXh0YXJlYSkpIHsKICAgICAgdHJ5IHsgdGhpcy50ZXh0YXJlYS5mb2N1cygpOyB9CiAgICAgIGNhdGNoIChlKSB7fSAvLyBJRTggd2lsbCB0aHJvdyBpZiB0aGUgdGV4dGFyZWEgaXMgZGlzcGxheTogbm9uZSBvciBub3QgaW4gRE9NCiAgICB9CiAgfTsKCiAgVGV4dGFyZWFJbnB1dC5wcm90b3R5cGUuYmx1ciA9IGZ1bmN0aW9uICgpIHsgdGhpcy50ZXh0YXJlYS5ibHVyKCk7IH07CgogIFRleHRhcmVhSW5wdXQucHJvdG90eXBlLnJlc2V0UG9zaXRpb24gPSBmdW5jdGlvbiAoKSB7CiAgICB0aGlzLndyYXBwZXIuc3R5bGUudG9wID0gdGhpcy53cmFwcGVyLnN0eWxlLmxlZnQgPSAwOwogIH07CgogIFRleHRhcmVhSW5wdXQucHJvdG90eXBlLnJlY2VpdmVkRm9jdXMgPSBmdW5jdGlvbiAoKSB7IHRoaXMuc2xvd1BvbGwoKTsgfTsKCiAgLy8gUG9sbCBmb3IgaW5wdXQgY2hhbmdlcywgdXNpbmcgdGhlIG5vcm1hbCByYXRlIG9mIHBvbGxpbmcuIFRoaXMKICAvLyBydW5zIGFzIGxvbmcgYXMgdGhlIGVkaXRvciBpcyBmb2N1c2VkLgogIFRleHRhcmVhSW5wdXQucHJvdG90eXBlLnNsb3dQb2xsID0gZnVuY3Rpb24gKCkgewogICAgICB2YXIgdGhpcyQxID0gdGhpczsKCiAgICBpZiAodGhpcy5wb2xsaW5nRmFzdCkgeyByZXR1cm4gfQogICAgdGhpcy5wb2xsaW5nLnNldCh0aGlzLmNtLm9wdGlvbnMucG9sbEludGVydmFsLCBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMkMS5wb2xsKCk7CiAgICAgIGlmICh0aGlzJDEuY20uc3RhdGUuZm9jdXNlZCkgeyB0aGlzJDEuc2xvd1BvbGwoKTsgfQogICAgfSk7CiAgfTsKCiAgLy8gV2hlbiBhbiBldmVudCBoYXMganVzdCBjb21lIGluIHRoYXQgaXMgbGlrZWx5IHRvIGFkZCBvciBjaGFuZ2UKICAvLyBzb21ldGhpbmcgaW4gdGhlIGlucHV0IHRleHRhcmVhLCB3ZSBwb2xsIGZhc3RlciwgdG8gZW5zdXJlIHRoYXQKICAvLyB0aGUgY2hhbmdlIGFwcGVhcnMgb24gdGhlIHNjcmVlbiBxdWlja2x5LgogIFRleHRhcmVhSW5wdXQucHJvdG90eXBlLmZhc3RQb2xsID0gZnVuY3Rpb24gKCkgewogICAgdmFyIG1pc3NlZCA9IGZhbHNlLCBpbnB1dCA9IHRoaXM7CiAgICBpbnB1dC5wb2xsaW5nRmFzdCA9IHRydWU7CiAgICBmdW5jdGlvbiBwKCkgewogICAgICB2YXIgY2hhbmdlZCA9IGlucHV0LnBvbGwoKTsKICAgICAgaWYgKCFjaGFuZ2VkICYmICFtaXNzZWQpIHttaXNzZWQgPSB0cnVlOyBpbnB1dC5wb2xsaW5nLnNldCg2MCwgcCk7fQogICAgICBlbHNlIHtpbnB1dC5wb2xsaW5nRmFzdCA9IGZhbHNlOyBpbnB1dC5zbG93UG9sbCgpO30KICAgIH0KICAgIGlucHV0LnBvbGxpbmcuc2V0KDIwLCBwKTsKICB9OwoKICAvLyBSZWFkIGlucHV0IGZyb20gdGhlIHRleHRhcmVhLCBhbmQgdXBkYXRlIHRoZSBkb2N1bWVudCB0byBtYXRjaC4KICAvLyBXaGVuIHNvbWV0aGluZyBpcyBzZWxlY3RlZCwgaXQgaXMgcHJlc2VudCBpbiB0aGUgdGV4dGFyZWEsIGFuZAogIC8vIHNlbGVjdGVkICh1bmxlc3MgaXQgaXMgaHVnZSwgaW4gd2hpY2ggY2FzZSBhIHBsYWNlaG9sZGVyIGlzCiAgLy8gdXNlZCkuIFdoZW4gbm90aGluZyBpcyBzZWxlY3RlZCwgdGhlIGN1cnNvciBzaXRzIGFmdGVyIHByZXZpb3VzbHkKICAvLyBzZWVuIHRleHQgKGNhbiBiZSBlbXB0eSksIHdoaWNoIGlzIHN0b3JlZCBpbiBwcmV2SW5wdXQgKHdlIG11c3QKICAvLyBub3QgcmVzZXQgdGhlIHRleHRhcmVhIHdoZW4gdHlwaW5nLCBiZWNhdXNlIHRoYXQgYnJlYWtzIElNRSkuCiAgVGV4dGFyZWFJbnB1dC5wcm90b3R5cGUucG9sbCA9IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIHRoaXMkMSA9IHRoaXM7CgogICAgdmFyIGNtID0gdGhpcy5jbSwgaW5wdXQgPSB0aGlzLnRleHRhcmVhLCBwcmV2SW5wdXQgPSB0aGlzLnByZXZJbnB1dDsKICAgIC8vIFNpbmNlIHRoaXMgaXMgY2FsbGVkIGEgKmxvdCosIHRyeSB0byBiYWlsIG91dCBhcyBjaGVhcGx5IGFzCiAgICAvLyBwb3NzaWJsZSB3aGVuIGl0IGlzIGNsZWFyIHRoYXQgbm90aGluZyBoYXBwZW5lZC4gaGFzU2VsZWN0aW9uCiAgICAvLyB3aWxsIGJlIHRoZSBjYXNlIHdoZW4gdGhlcmUgaXMgYSBsb3Qgb2YgdGV4dCBpbiB0aGUgdGV4dGFyZWEsCiAgICAvLyBpbiB3aGljaCBjYXNlIHJlYWRpbmcgaXRzIHZhbHVlIHdvdWxkIGJlIGV4cGVuc2l2ZS4KICAgIGlmICh0aGlzLmNvbnRleHRNZW51UGVuZGluZyB8fCAhY20uc3RhdGUuZm9jdXNlZCB8fAogICAgICAgIChoYXNTZWxlY3Rpb24oaW5wdXQpICYmICFwcmV2SW5wdXQgJiYgIXRoaXMuY29tcG9zaW5nKSB8fAogICAgICAgIGNtLmlzUmVhZE9ubHkoKSB8fCBjbS5vcHRpb25zLmRpc2FibGVJbnB1dCB8fCBjbS5zdGF0ZS5rZXlTZXEpCiAgICAgIHsgcmV0dXJuIGZhbHNlIH0KCiAgICB2YXIgdGV4dCA9IGlucHV0LnZhbHVlOwogICAgLy8gSWYgbm90aGluZyBjaGFuZ2VkLCBiYWlsLgogICAgaWYgKHRleHQgPT0gcHJldklucHV0ICYmICFjbS5zb21ldGhpbmdTZWxlY3RlZCgpKSB7IHJldHVybiBmYWxzZSB9CiAgICAvLyBXb3JrIGFyb3VuZCBub25zZW5zaWNhbCBzZWxlY3Rpb24gcmVzZXR0aW5nIGluIElFOS8xMCwgYW5kCiAgICAvLyBpbmV4cGxpY2FibGUgYXBwZWFyYW5jZSBvZiBwcml2YXRlIGFyZWEgdW5pY29kZSBjaGFyYWN0ZXJzIG9uCiAgICAvLyBzb21lIGtleSBjb21ib3MgaW4gTWFjICgjMjY4OSkuCiAgICBpZiAoaWUgJiYgaWVfdmVyc2lvbiA+PSA5ICYmIHRoaXMuaGFzU2VsZWN0aW9uID09PSB0ZXh0IHx8CiAgICAgICAgbWFjICYmIC9bXHVmNzAwLVx1ZjdmZl0vLnRlc3QodGV4dCkpIHsKICAgICAgY20uZGlzcGxheS5pbnB1dC5yZXNldCgpOwogICAgICByZXR1cm4gZmFsc2UKICAgIH0KCiAgICBpZiAoY20uZG9jLnNlbCA9PSBjbS5kaXNwbGF5LnNlbEZvckNvbnRleHRNZW51KSB7CiAgICAgIHZhciBmaXJzdCA9IHRleHQuY2hhckNvZGVBdCgwKTsKICAgICAgaWYgKGZpcnN0ID09IDB4MjAwYiAmJiAhcHJldklucHV0KSB7IHByZXZJbnB1dCA9ICJcdTIwMGIiOyB9CiAgICAgIGlmIChmaXJzdCA9PSAweDIxZGEpIHsgdGhpcy5yZXNldCgpOyByZXR1cm4gdGhpcy5jbS5leGVjQ29tbWFuZCgidW5kbyIpIH0KICAgIH0KICAgIC8vIEZpbmQgdGhlIHBhcnQgb2YgdGhlIGlucHV0IHRoYXQgaXMgYWN0dWFsbHkgbmV3CiAgICB2YXIgc2FtZSA9IDAsIGwgPSBNYXRoLm1pbihwcmV2SW5wdXQubGVuZ3RoLCB0ZXh0Lmxlbmd0aCk7CiAgICB3aGlsZSAoc2FtZSA8IGwgJiYgcHJldklucHV0LmNoYXJDb2RlQXQoc2FtZSkgPT0gdGV4dC5jaGFyQ29kZUF0KHNhbWUpKSB7ICsrc2FtZTsgfQoKICAgIHJ1bkluT3AoY20sIGZ1bmN0aW9uICgpIHsKICAgICAgYXBwbHlUZXh0SW5wdXQoY20sIHRleHQuc2xpY2Uoc2FtZSksIHByZXZJbnB1dC5sZW5ndGggLSBzYW1lLAogICAgICAgICAgICAgICAgICAgICBudWxsLCB0aGlzJDEuY29tcG9zaW5nID8gIipjb21wb3NlIiA6IG51bGwpOwoKICAgICAgLy8gRG9uJ3QgbGVhdmUgbG9uZyB0ZXh0IGluIHRoZSB0ZXh0YXJlYSwgc2luY2UgaXQgbWFrZXMgZnVydGhlciBwb2xsaW5nIHNsb3cKICAgICAgaWYgKHRleHQubGVuZ3RoID4gMTAwMCB8fCB0ZXh0LmluZGV4T2YoIlxuIikgPiAtMSkgeyBpbnB1dC52YWx1ZSA9IHRoaXMkMS5wcmV2SW5wdXQgPSAiIjsgfQogICAgICBlbHNlIHsgdGhpcyQxLnByZXZJbnB1dCA9IHRleHQ7IH0KCiAgICAgIGlmICh0aGlzJDEuY29tcG9zaW5nKSB7CiAgICAgICAgdGhpcyQxLmNvbXBvc2luZy5yYW5nZS5jbGVhcigpOwogICAgICAgIHRoaXMkMS5jb21wb3NpbmcucmFuZ2UgPSBjbS5tYXJrVGV4dCh0aGlzJDEuY29tcG9zaW5nLnN0YXJ0LCBjbS5nZXRDdXJzb3IoInRvIiksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7Y2xhc3NOYW1lOiAiQ29kZU1pcnJvci1jb21wb3NpbmcifSk7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIHRydWUKICB9OwoKICBUZXh0YXJlYUlucHV0LnByb3RvdHlwZS5lbnN1cmVQb2xsZWQgPSBmdW5jdGlvbiAoKSB7CiAgICBpZiAodGhpcy5wb2xsaW5nRmFzdCAmJiB0aGlzLnBvbGwoKSkgeyB0aGlzLnBvbGxpbmdGYXN0ID0gZmFsc2U7IH0KICB9OwoKICBUZXh0YXJlYUlucHV0LnByb3RvdHlwZS5vbktleVByZXNzID0gZnVuY3Rpb24gKCkgewogICAgaWYgKGllICYmIGllX3ZlcnNpb24gPj0gOSkgeyB0aGlzLmhhc1NlbGVjdGlvbiA9IG51bGw7IH0KICAgIHRoaXMuZmFzdFBvbGwoKTsKICB9OwoKICBUZXh0YXJlYUlucHV0LnByb3RvdHlwZS5vbkNvbnRleHRNZW51ID0gZnVuY3Rpb24gKGUpIHsKICAgIHZhciBpbnB1dCA9IHRoaXMsIGNtID0gaW5wdXQuY20sIGRpc3BsYXkgPSBjbS5kaXNwbGF5LCB0ZSA9IGlucHV0LnRleHRhcmVhOwogICAgaWYgKGlucHV0LmNvbnRleHRNZW51UGVuZGluZykgeyBpbnB1dC5jb250ZXh0TWVudVBlbmRpbmcoKTsgfQogICAgdmFyIHBvcyA9IHBvc0Zyb21Nb3VzZShjbSwgZSksIHNjcm9sbFBvcyA9IGRpc3BsYXkuc2Nyb2xsZXIuc2Nyb2xsVG9wOwogICAgaWYgKCFwb3MgfHwgcHJlc3RvKSB7IHJldHVybiB9IC8vIE9wZXJhIGlzIGRpZmZpY3VsdC4KCiAgICAvLyBSZXNldCB0aGUgY3VycmVudCB0ZXh0IHNlbGVjdGlvbiBvbmx5IGlmIHRoZSBjbGljayBpcyBkb25lIG91dHNpZGUgb2YgdGhlIHNlbGVjdGlvbgogICAgLy8gYW5kICdyZXNldFNlbGVjdGlvbk9uQ29udGV4dE1lbnUnIG9wdGlvbiBpcyB0cnVlLgogICAgdmFyIHJlc2V0ID0gY20ub3B0aW9ucy5yZXNldFNlbGVjdGlvbk9uQ29udGV4dE1lbnU7CiAgICBpZiAocmVzZXQgJiYgY20uZG9jLnNlbC5jb250YWlucyhwb3MpID09IC0xKQogICAgICB7IG9wZXJhdGlvbihjbSwgc2V0U2VsZWN0aW9uKShjbS5kb2MsIHNpbXBsZVNlbGVjdGlvbihwb3MpLCBzZWxfZG9udFNjcm9sbCk7IH0KCiAgICB2YXIgb2xkQ1NTID0gdGUuc3R5bGUuY3NzVGV4dCwgb2xkV3JhcHBlckNTUyA9IGlucHV0LndyYXBwZXIuc3R5bGUuY3NzVGV4dDsKICAgIHZhciB3cmFwcGVyQm94ID0gaW5wdXQud3JhcHBlci5vZmZzZXRQYXJlbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICBpbnB1dC53cmFwcGVyLnN0eWxlLmNzc1RleHQgPSAicG9zaXRpb246IHN0YXRpYyI7CiAgICB0ZS5zdHlsZS5jc3NUZXh0ID0gInBvc2l0aW9uOiBhYnNvbHV0ZTsgd2lkdGg6IDMwcHg7IGhlaWdodDogMzBweDtcbiAgICAgIHRvcDogIiArIChlLmNsaWVudFkgLSB3cmFwcGVyQm94LnRvcCAtIDUpICsgInB4OyBsZWZ0OiAiICsgKGUuY2xpZW50WCAtIHdyYXBwZXJCb3gubGVmdCAtIDUpICsgInB4O1xuICAgICAgei1pbmRleDogMTAwMDsgYmFja2dyb3VuZDogIiArIChpZSA/ICJyZ2JhKDI1NSwgMjU1LCAyNTUsIC4wNSkiIDogInRyYW5zcGFyZW50IikgKyAiO1xuICAgICAgb3V0bGluZTogbm9uZTsgYm9yZGVyLXdpZHRoOiAwOyBvdXRsaW5lOiBub25lOyBvdmVyZmxvdzogaGlkZGVuOyBvcGFjaXR5OiAuMDU7IGZpbHRlcjogYWxwaGEob3BhY2l0eT01KTsiOwogICAgdmFyIG9sZFNjcm9sbFk7CiAgICBpZiAod2Via2l0KSB7IG9sZFNjcm9sbFkgPSB3aW5kb3cuc2Nyb2xsWTsgfSAvLyBXb3JrIGFyb3VuZCBDaHJvbWUgaXNzdWUgKCMyNzEyKQogICAgZGlzcGxheS5pbnB1dC5mb2N1cygpOwogICAgaWYgKHdlYmtpdCkgeyB3aW5kb3cuc2Nyb2xsVG8obnVsbCwgb2xkU2Nyb2xsWSk7IH0KICAgIGRpc3BsYXkuaW5wdXQucmVzZXQoKTsKICAgIC8vIEFkZHMgIlNlbGVjdCBhbGwiIHRvIGNvbnRleHQgbWVudSBpbiBGRgogICAgaWYgKCFjbS5zb21ldGhpbmdTZWxlY3RlZCgpKSB7IHRlLnZhbHVlID0gaW5wdXQucHJldklucHV0ID0gIiAiOyB9CiAgICBpbnB1dC5jb250ZXh0TWVudVBlbmRpbmcgPSByZWhpZGU7CiAgICBkaXNwbGF5LnNlbEZvckNvbnRleHRNZW51ID0gY20uZG9jLnNlbDsKICAgIGNsZWFyVGltZW91dChkaXNwbGF5LmRldGVjdGluZ1NlbGVjdEFsbCk7CgogICAgLy8gU2VsZWN0LWFsbCB3aWxsIGJlIGdyZXllZCBvdXQgaWYgdGhlcmUncyBub3RoaW5nIHRvIHNlbGVjdCwgc28KICAgIC8vIHRoaXMgYWRkcyBhIHplcm8td2lkdGggc3BhY2Ugc28gdGhhdCB3ZSBjYW4gbGF0ZXIgY2hlY2sgd2hldGhlcgogICAgLy8gaXQgZ290IHNlbGVjdGVkLgogICAgZnVuY3Rpb24gcHJlcGFyZVNlbGVjdEFsbEhhY2soKSB7CiAgICAgIGlmICh0ZS5zZWxlY3Rpb25TdGFydCAhPSBudWxsKSB7CiAgICAgICAgdmFyIHNlbGVjdGVkID0gY20uc29tZXRoaW5nU2VsZWN0ZWQoKTsKICAgICAgICB2YXIgZXh0dmFsID0gIlx1MjAwYiIgKyAoc2VsZWN0ZWQgPyB0ZS52YWx1ZSA6ICIiKTsKICAgICAgICB0ZS52YWx1ZSA9ICJcdTIxZGEiOyAvLyBVc2VkIHRvIGNhdGNoIGNvbnRleHQtbWVudSB1bmRvCiAgICAgICAgdGUudmFsdWUgPSBleHR2YWw7CiAgICAgICAgaW5wdXQucHJldklucHV0ID0gc2VsZWN0ZWQgPyAiIiA6ICJcdTIwMGIiOwogICAgICAgIHRlLnNlbGVjdGlvblN0YXJ0ID0gMTsgdGUuc2VsZWN0aW9uRW5kID0gZXh0dmFsLmxlbmd0aDsKICAgICAgICAvLyBSZS1zZXQgdGhpcywgaW4gY2FzZSBzb21lIG90aGVyIGhhbmRsZXIgdG91Y2hlZCB0aGUKICAgICAgICAvLyBzZWxlY3Rpb24gaW4gdGhlIG1lYW50aW1lLgogICAgICAgIGRpc3BsYXkuc2VsRm9yQ29udGV4dE1lbnUgPSBjbS5kb2Muc2VsOwogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiByZWhpZGUoKSB7CiAgICAgIGlmIChpbnB1dC5jb250ZXh0TWVudVBlbmRpbmcgIT0gcmVoaWRlKSB7IHJldHVybiB9CiAgICAgIGlucHV0LmNvbnRleHRNZW51UGVuZGluZyA9IGZhbHNlOwogICAgICBpbnB1dC53cmFwcGVyLnN0eWxlLmNzc1RleHQgPSBvbGRXcmFwcGVyQ1NTOwogICAgICB0ZS5zdHlsZS5jc3NUZXh0ID0gb2xkQ1NTOwogICAgICBpZiAoaWUgJiYgaWVfdmVyc2lvbiA8IDkpIHsgZGlzcGxheS5zY3JvbGxiYXJzLnNldFNjcm9sbFRvcChkaXNwbGF5LnNjcm9sbGVyLnNjcm9sbFRvcCA9IHNjcm9sbFBvcyk7IH0KCiAgICAgIC8vIFRyeSB0byBkZXRlY3QgdGhlIHVzZXIgY2hvb3Npbmcgc2VsZWN0LWFsbAogICAgICBpZiAodGUuc2VsZWN0aW9uU3RhcnQgIT0gbnVsbCkgewogICAgICAgIGlmICghaWUgfHwgKGllICYmIGllX3ZlcnNpb24gPCA5KSkgeyBwcmVwYXJlU2VsZWN0QWxsSGFjaygpOyB9CiAgICAgICAgdmFyIGkgPSAwLCBwb2xsID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgaWYgKGRpc3BsYXkuc2VsRm9yQ29udGV4dE1lbnUgPT0gY20uZG9jLnNlbCAmJiB0ZS5zZWxlY3Rpb25TdGFydCA9PSAwICYmCiAgICAgICAgICAgICAgdGUuc2VsZWN0aW9uRW5kID4gMCAmJiBpbnB1dC5wcmV2SW5wdXQgPT0gIlx1MjAwYiIpIHsKICAgICAgICAgICAgb3BlcmF0aW9uKGNtLCBzZWxlY3RBbGwpKGNtKTsKICAgICAgICAgIH0gZWxzZSBpZiAoaSsrIDwgMTApIHsKICAgICAgICAgICAgZGlzcGxheS5kZXRlY3RpbmdTZWxlY3RBbGwgPSBzZXRUaW1lb3V0KHBvbGwsIDUwMCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBkaXNwbGF5LnNlbEZvckNvbnRleHRNZW51ID0gbnVsbDsKICAgICAgICAgICAgZGlzcGxheS5pbnB1dC5yZXNldCgpOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgZGlzcGxheS5kZXRlY3RpbmdTZWxlY3RBbGwgPSBzZXRUaW1lb3V0KHBvbGwsIDIwMCk7CiAgICAgIH0KICAgIH0KCiAgICBpZiAoaWUgJiYgaWVfdmVyc2lvbiA+PSA5KSB7IHByZXBhcmVTZWxlY3RBbGxIYWNrKCk7IH0KICAgIGlmIChjYXB0dXJlUmlnaHRDbGljaykgewogICAgICBlX3N0b3AoZSk7CiAgICAgIHZhciBtb3VzZXVwID0gZnVuY3Rpb24gKCkgewogICAgICAgIG9mZih3aW5kb3csICJtb3VzZXVwIiwgbW91c2V1cCk7CiAgICAgICAgc2V0VGltZW91dChyZWhpZGUsIDIwKTsKICAgICAgfTsKICAgICAgb24od2luZG93LCAibW91c2V1cCIsIG1vdXNldXApOwogICAgfSBlbHNlIHsKICAgICAgc2V0VGltZW91dChyZWhpZGUsIDUwKTsKICAgIH0KICB9OwoKICBUZXh0YXJlYUlucHV0LnByb3RvdHlwZS5yZWFkT25seUNoYW5nZWQgPSBmdW5jdGlvbiAodmFsKSB7CiAgICBpZiAoIXZhbCkgeyB0aGlzLnJlc2V0KCk7IH0KICAgIHRoaXMudGV4dGFyZWEuZGlzYWJsZWQgPSB2YWwgPT0gIm5vY3Vyc29yIjsKICB9OwoKICBUZXh0YXJlYUlucHV0LnByb3RvdHlwZS5zZXRVbmVkaXRhYmxlID0gZnVuY3Rpb24gKCkge307CgogIFRleHRhcmVhSW5wdXQucHJvdG90eXBlLm5lZWRzQ29udGVudEF0dHJpYnV0ZSA9IGZhbHNlOwoKICBmdW5jdGlvbiBmcm9tVGV4dEFyZWEodGV4dGFyZWEsIG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBvcHRpb25zID8gY29weU9iaihvcHRpb25zKSA6IHt9OwogICAgb3B0aW9ucy52YWx1ZSA9IHRleHRhcmVhLnZhbHVlOwogICAgaWYgKCFvcHRpb25zLnRhYmluZGV4ICYmIHRleHRhcmVhLnRhYkluZGV4KQogICAgICB7IG9wdGlvbnMudGFiaW5kZXggPSB0ZXh0YXJlYS50YWJJbmRleDsgfQogICAgaWYgKCFvcHRpb25zLnBsYWNlaG9sZGVyICYmIHRleHRhcmVhLnBsYWNlaG9sZGVyKQogICAgICB7IG9wdGlvbnMucGxhY2Vob2xkZXIgPSB0ZXh0YXJlYS5wbGFjZWhvbGRlcjsgfQogICAgLy8gU2V0IGF1dG9mb2N1cyB0byB0cnVlIGlmIHRoaXMgdGV4dGFyZWEgaXMgZm9jdXNlZCwgb3IgaWYgaXQgaGFzCiAgICAvLyBhdXRvZm9jdXMgYW5kIG5vIG90aGVyIGVsZW1lbnQgaXMgZm9jdXNlZC4KICAgIGlmIChvcHRpb25zLmF1dG9mb2N1cyA9PSBudWxsKSB7CiAgICAgIHZhciBoYXNGb2N1cyA9IGFjdGl2ZUVsdCgpOwogICAgICBvcHRpb25zLmF1dG9mb2N1cyA9IGhhc0ZvY3VzID09IHRleHRhcmVhIHx8CiAgICAgICAgdGV4dGFyZWEuZ2V0QXR0cmlidXRlKCJhdXRvZm9jdXMiKSAhPSBudWxsICYmIGhhc0ZvY3VzID09IGRvY3VtZW50LmJvZHk7CiAgICB9CgogICAgZnVuY3Rpb24gc2F2ZSgpIHt0ZXh0YXJlYS52YWx1ZSA9IGNtLmdldFZhbHVlKCk7fQoKICAgIHZhciByZWFsU3VibWl0OwogICAgaWYgKHRleHRhcmVhLmZvcm0pIHsKICAgICAgb24odGV4dGFyZWEuZm9ybSwgInN1Ym1pdCIsIHNhdmUpOwogICAgICAvLyBEZXBsb3JhYmxlIGhhY2sgdG8gbWFrZSB0aGUgc3VibWl0IG1ldGhvZCBkbyB0aGUgcmlnaHQgdGhpbmcuCiAgICAgIGlmICghb3B0aW9ucy5sZWF2ZVN1Ym1pdE1ldGhvZEFsb25lKSB7CiAgICAgICAgdmFyIGZvcm0gPSB0ZXh0YXJlYS5mb3JtOwogICAgICAgIHJlYWxTdWJtaXQgPSBmb3JtLnN1Ym1pdDsKICAgICAgICB0cnkgewogICAgICAgICAgdmFyIHdyYXBwZWRTdWJtaXQgPSBmb3JtLnN1Ym1pdCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgc2F2ZSgpOwogICAgICAgICAgICBmb3JtLnN1Ym1pdCA9IHJlYWxTdWJtaXQ7CiAgICAgICAgICAgIGZvcm0uc3VibWl0KCk7CiAgICAgICAgICAgIGZvcm0uc3VibWl0ID0gd3JhcHBlZFN1Ym1pdDsKICAgICAgICAgIH07CiAgICAgICAgfSBjYXRjaChlKSB7fQogICAgICB9CiAgICB9CgogICAgb3B0aW9ucy5maW5pc2hJbml0ID0gZnVuY3Rpb24gKGNtKSB7CiAgICAgIGNtLnNhdmUgPSBzYXZlOwogICAgICBjbS5nZXRUZXh0QXJlYSA9IGZ1bmN0aW9uICgpIHsgcmV0dXJuIHRleHRhcmVhOyB9OwogICAgICBjbS50b1RleHRBcmVhID0gZnVuY3Rpb24gKCkgewogICAgICAgIGNtLnRvVGV4dEFyZWEgPSBpc05hTjsgLy8gUHJldmVudCB0aGlzIGZyb20gYmVpbmcgcmFuIHR3aWNlCiAgICAgICAgc2F2ZSgpOwogICAgICAgIHRleHRhcmVhLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoY20uZ2V0V3JhcHBlckVsZW1lbnQoKSk7CiAgICAgICAgdGV4dGFyZWEuc3R5bGUuZGlzcGxheSA9ICIiOwogICAgICAgIGlmICh0ZXh0YXJlYS5mb3JtKSB7CiAgICAgICAgICBvZmYodGV4dGFyZWEuZm9ybSwgInN1Ym1pdCIsIHNhdmUpOwogICAgICAgICAgaWYgKHR5cGVvZiB0ZXh0YXJlYS5mb3JtLnN1Ym1pdCA9PSAiZnVuY3Rpb24iKQogICAgICAgICAgICB7IHRleHRhcmVhLmZvcm0uc3VibWl0ID0gcmVhbFN1Ym1pdDsgfQogICAgICAgIH0KICAgICAgfTsKICAgIH07CgogICAgdGV4dGFyZWEuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICAgIHZhciBjbSA9IENvZGVNaXJyb3IoZnVuY3Rpb24gKG5vZGUpIHsgcmV0dXJuIHRleHRhcmVhLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKG5vZGUsIHRleHRhcmVhLm5leHRTaWJsaW5nKTsgfSwKICAgICAgb3B0aW9ucyk7CiAgICByZXR1cm4gY20KICB9CgogIGZ1bmN0aW9uIGFkZExlZ2FjeVByb3BzKENvZGVNaXJyb3IpIHsKICAgIENvZGVNaXJyb3Iub2ZmID0gb2ZmOwogICAgQ29kZU1pcnJvci5vbiA9IG9uOwogICAgQ29kZU1pcnJvci53aGVlbEV2ZW50UGl4ZWxzID0gd2hlZWxFdmVudFBpeGVsczsKICAgIENvZGVNaXJyb3IuRG9jID0gRG9jOwogICAgQ29kZU1pcnJvci5zcGxpdExpbmVzID0gc3BsaXRMaW5lc0F1dG87CiAgICBDb2RlTWlycm9yLmNvdW50Q29sdW1uID0gY291bnRDb2x1bW47CiAgICBDb2RlTWlycm9yLmZpbmRDb2x1bW4gPSBmaW5kQ29sdW1uOwogICAgQ29kZU1pcnJvci5pc1dvcmRDaGFyID0gaXNXb3JkQ2hhckJhc2ljOwogICAgQ29kZU1pcnJvci5QYXNzID0gUGFzczsKICAgIENvZGVNaXJyb3Iuc2lnbmFsID0gc2lnbmFsOwogICAgQ29kZU1pcnJvci5MaW5lID0gTGluZTsKICAgIENvZGVNaXJyb3IuY2hhbmdlRW5kID0gY2hhbmdlRW5kOwogICAgQ29kZU1pcnJvci5zY3JvbGxiYXJNb2RlbCA9IHNjcm9sbGJhck1vZGVsOwogICAgQ29kZU1pcnJvci5Qb3MgPSBQb3M7CiAgICBDb2RlTWlycm9yLmNtcFBvcyA9IGNtcDsKICAgIENvZGVNaXJyb3IubW9kZXMgPSBtb2RlczsKICAgIENvZGVNaXJyb3IubWltZU1vZGVzID0gbWltZU1vZGVzOwogICAgQ29kZU1pcnJvci5yZXNvbHZlTW9kZSA9IHJlc29sdmVNb2RlOwogICAgQ29kZU1pcnJvci5nZXRNb2RlID0gZ2V0TW9kZTsKICAgIENvZGVNaXJyb3IubW9kZUV4dGVuc2lvbnMgPSBtb2RlRXh0ZW5zaW9uczsKICAgIENvZGVNaXJyb3IuZXh0ZW5kTW9kZSA9IGV4dGVuZE1vZGU7CiAgICBDb2RlTWlycm9yLmNvcHlTdGF0ZSA9IGNvcHlTdGF0ZTsKICAgIENvZGVNaXJyb3Iuc3RhcnRTdGF0ZSA9IHN0YXJ0U3RhdGU7CiAgICBDb2RlTWlycm9yLmlubmVyTW9kZSA9IGlubmVyTW9kZTsKICAgIENvZGVNaXJyb3IuY29tbWFuZHMgPSBjb21tYW5kczsKICAgIENvZGVNaXJyb3Iua2V5TWFwID0ga2V5TWFwOwogICAgQ29kZU1pcnJvci5rZXlOYW1lID0ga2V5TmFtZTsKICAgIENvZGVNaXJyb3IuaXNNb2RpZmllcktleSA9IGlzTW9kaWZpZXJLZXk7CiAgICBDb2RlTWlycm9yLmxvb2t1cEtleSA9IGxvb2t1cEtleTsKICAgIENvZGVNaXJyb3Iubm9ybWFsaXplS2V5TWFwID0gbm9ybWFsaXplS2V5TWFwOwogICAgQ29kZU1pcnJvci5TdHJpbmdTdHJlYW0gPSBTdHJpbmdTdHJlYW07CiAgICBDb2RlTWlycm9yLlNoYXJlZFRleHRNYXJrZXIgPSBTaGFyZWRUZXh0TWFya2VyOwogICAgQ29kZU1pcnJvci5UZXh0TWFya2VyID0gVGV4dE1hcmtlcjsKICAgIENvZGVNaXJyb3IuTGluZVdpZGdldCA9IExpbmVXaWRnZXQ7CiAgICBDb2RlTWlycm9yLmVfcHJldmVudERlZmF1bHQgPSBlX3ByZXZlbnREZWZhdWx0OwogICAgQ29kZU1pcnJvci5lX3N0b3BQcm9wYWdhdGlvbiA9IGVfc3RvcFByb3BhZ2F0aW9uOwogICAgQ29kZU1pcnJvci5lX3N0b3AgPSBlX3N0b3A7CiAgICBDb2RlTWlycm9yLmFkZENsYXNzID0gYWRkQ2xhc3M7CiAgICBDb2RlTWlycm9yLmNvbnRhaW5zID0gY29udGFpbnM7CiAgICBDb2RlTWlycm9yLnJtQ2xhc3MgPSBybUNsYXNzOwogICAgQ29kZU1pcnJvci5rZXlOYW1lcyA9IGtleU5hbWVzOwogIH0KCiAgLy8gRURJVE9SIENPTlNUUlVDVE9SCgogIGRlZmluZU9wdGlvbnMoQ29kZU1pcnJvcik7CgogIGFkZEVkaXRvck1ldGhvZHMoQ29kZU1pcnJvcik7CgogIC8vIFNldCB1cCBtZXRob2RzIG9uIENvZGVNaXJyb3IncyBwcm90b3R5cGUgdG8gcmVkaXJlY3QgdG8gdGhlIGVkaXRvcidzIGRvY3VtZW50LgogIHZhciBkb250RGVsZWdhdGUgPSAiaXRlciBpbnNlcnQgcmVtb3ZlIGNvcHkgZ2V0RWRpdG9yIGNvbnN0cnVjdG9yIi5zcGxpdCgiICIpOwogIGZvciAodmFyIHByb3AgaW4gRG9jLnByb3RvdHlwZSkgeyBpZiAoRG9jLnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eShwcm9wKSAmJiBpbmRleE9mKGRvbnREZWxlZ2F0ZSwgcHJvcCkgPCAwKQogICAgeyBDb2RlTWlycm9yLnByb3RvdHlwZVtwcm9wXSA9IChmdW5jdGlvbihtZXRob2QpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkge3JldHVybiBtZXRob2QuYXBwbHkodGhpcy5kb2MsIGFyZ3VtZW50cyl9CiAgICB9KShEb2MucHJvdG90eXBlW3Byb3BdKTsgfSB9CgogIGV2ZW50TWl4aW4oRG9jKTsKICBDb2RlTWlycm9yLmlucHV0U3R5bGVzID0geyJ0ZXh0YXJlYSI6IFRleHRhcmVhSW5wdXQsICJjb250ZW50ZWRpdGFibGUiOiBDb250ZW50RWRpdGFibGVJbnB1dH07CgogIC8vIEV4dHJhIGFyZ3VtZW50cyBhcmUgc3RvcmVkIGFzIHRoZSBtb2RlJ3MgZGVwZW5kZW5jaWVzLCB3aGljaCBpcwogIC8vIHVzZWQgYnkgKGxlZ2FjeSkgbWVjaGFuaXNtcyBsaWtlIGxvYWRtb2RlLmpzIHRvIGF1dG9tYXRpY2FsbHkKICAvLyBsb2FkIGEgbW9kZS4gKFByZWZlcnJlZCBtZWNoYW5pc20gaXMgdGhlIHJlcXVpcmUvZGVmaW5lIGNhbGxzLikKICBDb2RlTWlycm9yLmRlZmluZU1vZGUgPSBmdW5jdGlvbihuYW1lLyosIG1vZGUsIOKApiovKSB7CiAgICBpZiAoIUNvZGVNaXJyb3IuZGVmYXVsdHMubW9kZSAmJiBuYW1lICE9ICJudWxsIikgeyBDb2RlTWlycm9yLmRlZmF1bHRzLm1vZGUgPSBuYW1lOyB9CiAgICBkZWZpbmVNb2RlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfTsKCiAgQ29kZU1pcnJvci5kZWZpbmVNSU1FID0gZGVmaW5lTUlNRTsKCiAgLy8gTWluaW1hbCBkZWZhdWx0IG1vZGUuCiAgQ29kZU1pcnJvci5kZWZpbmVNb2RlKCJudWxsIiwgZnVuY3Rpb24gKCkgeyByZXR1cm4gKHt0b2tlbjogZnVuY3Rpb24gKHN0cmVhbSkgeyByZXR1cm4gc3RyZWFtLnNraXBUb0VuZCgpOyB9fSk7IH0pOwogIENvZGVNaXJyb3IuZGVmaW5lTUlNRSgidGV4dC9wbGFpbiIsICJudWxsIik7CgogIC8vIEVYVEVOU0lPTlMKCiAgQ29kZU1pcnJvci5kZWZpbmVFeHRlbnNpb24gPSBmdW5jdGlvbiAobmFtZSwgZnVuYykgewogICAgQ29kZU1pcnJvci5wcm90b3R5cGVbbmFtZV0gPSBmdW5jOwogIH07CiAgQ29kZU1pcnJvci5kZWZpbmVEb2NFeHRlbnNpb24gPSBmdW5jdGlvbiAobmFtZSwgZnVuYykgewogICAgRG9jLnByb3RvdHlwZVtuYW1lXSA9IGZ1bmM7CiAgfTsKCiAgQ29kZU1pcnJvci5mcm9tVGV4dEFyZWEgPSBmcm9tVGV4dEFyZWE7CgogIGFkZExlZ2FjeVByb3BzKENvZGVNaXJyb3IpOwoKICBDb2RlTWlycm9yLnZlcnNpb24gPSAiNS40OC40IjsKCiAgcmV0dXJuIENvZGVNaXJyb3I7Cgp9KSkpOwo=","codemirror/codemirror-extensions.js":"Ly8gY29kZW1pcnJvci1leHRlbnNpb25zLmpzLgovLyBDb3B5cmlnaHQgMjAxOC0yMDIwIGJ5IEFudGhvbnkgVy4gSHVyc2gKLy8gTUlUIExpY2Vuc2UuCgoKQml3YVNjaGVtZS5kZWZpbmVfbGliZnVuYygic2V0LWNtLWVkaXRvci10ZXh0ISIsIDIsIDIsIGZ1bmN0aW9uKGFyLGludHApewogIC8vIFNldCB0aGUgdGV4dCBmb3IgdGhlIENvZGVNaXJyb3IgZWRpdG9yIG5hbWVkIGluIGFyWzBdIHRvIHRoZSB0ZXh0IGluIGFyWzFdCiAgICBCaXdhU2NoZW1lLmFzc2VydF9zdHJpbmcoYXJbMF0pOwogICAgQml3YVNjaGVtZS5hc3NlcnRfc3RyaW5nKGFyWzFdKTsKICAgIGxldCBlZGl0b3IgPSBjbV9lZGl0b3JzW2FyWzBdXTsKICAgIGlmKGVkaXRvciAhPT0gdW5kZWZpbmVkKXsKICAgICAgbGV0IHJlc3VsdCA9IGVkaXRvci5zZXRWYWx1ZShhclsxXSk7CiAgICAgIGVkaXRvci5mb2N1cygpOwogICAgICBlZGl0b3IucmVmcmVzaCgpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgZWxzZXsKICAgICAgY29uc29sZS5sb2coInNldC1jbS1lZGl0b3ItdGV4dCE6IE5vIGVkaXRvciBjb3JyZXNwb25kaW5nIHRvICIgKyBhclswXSk7CiAgICAgIHJldHVybiBudWxsOwogICAgfQp9KQoKQml3YVNjaGVtZS5kZWZpbmVfbGliZnVuYygiY20tZWRpdG9yLXNob3ciLDEsMSxmdW5jdGlvbihhcixpbnRwKXsKICAvLyBNYWtlcyB0aGUgQ29kZU1pcnJvciBlZGl0b3Igc3BlY2lmZWQgaW4gYXJbMF0gdmlzaWJsZSBieSBzaG93aW5nIGl0cyB3cmFwcGVyIGVsZW1lbnQuCiAgQml3YVNjaGVtZS5hc3NlcnRfc3RyaW5nKGFyWzBdKTsKICBsZXQgZWRpdG9yID0gY21fZWRpdG9yc1thclswXV07CiAgaWYoZWRpdG9yICE9PSB1bmRlZmluZWQpewogICAgJChlZGl0b3IuZ2V0V3JhcHBlckVsZW1lbnQoKSkuc2hvdygpOwogICAgcmV0dXJuIHRydWU7CiAgfQogIHJldHVybiBmYWxzZTsKfSk7CgpCaXdhU2NoZW1lLmRlZmluZV9saWJmdW5jKCJjbS1lZGl0b3ItaGlkZSIsMSwxLGZ1bmN0aW9uKGFyLGludHApewogIC8vIEhpZGVzIHRoZSBDb2RlTWlycm9yIGVkaXRvciBzcGVjaWZlZCBpbiBhclswXSBieSBoaWRpbmcgaXRzIHdyYXBwZXIgZWxlbWVudC4KICBCaXdhU2NoZW1lLmFzc2VydF9zdHJpbmcoYXJbMF0pOwogIGxldCBlZGl0b3IgPSBjbV9lZGl0b3JzW2FyWzBdXTsKICBpZihlZGl0b3IgIT09IHVuZGVmaW5lZCl7CiAgICAkKGVkaXRvci5nZXRXcmFwcGVyRWxlbWVudCgpKS5oaWRlKCk7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgcmV0dXJuIGZhbHNlOwp9KTsKCkJpd2FTY2hlbWUuZGVmaW5lX2xpYmZ1bmMoImNtLWVkaXRvci1oaWRlLWFsbCIsMCwwLGZ1bmN0aW9uKGFyLGludHApewogIC8vIEhpZGVzIGFsbCBhY3RpdmUgQ29kZU1pcnJvciBlZGl0b3JzLgogIGxldCBlZGl0b3JzID0gT2JqZWN0LmtleXMoY21fZWRpdG9ycyk7CiAgZm9yKHZhciBpID0gMDsgaSA8IGVkaXRvcnMubGVuZ3RoOyBpKyspewogICAgJChjbV9lZGl0b3JzW2VkaXRvcnNbaV1dLmdldFdyYXBwZXJFbGVtZW50KCkpLmhpZGUoKTsKICB9CiAgcmV0dXJuIHRydWU7Cn0pOwpCaXdhU2NoZW1lLmRlZmluZV9saWJmdW5jKCJjbS1lZGl0b3ItZ2V0LWN1cnJlbnQtc3ltYm9sIiwxLDEsZnVuY3Rpb24oYXIsaW50cCl7CiAgLy8gVHJpZXMgdG8gZ2V0IHRoZSBTY2hlbWUgc3ltYm9sIGF0IHRoZSBjdXJzb3IgZm9yIHRoZSBDb2RlTWlycm9yIGVkaXRvciBzcGVjaWZpZWQgaW4gYXJbMF0uIFNvbWV3aGF0IGhldXJpc3RpYywgYnV0IHVzdWFsbHkgd29ya3MuCiAgQml3YVNjaGVtZS5hc3NlcnRfc3RyaW5nKGFyWzBdKTsKICBsZXQgZWRpdG9yID0gY21fZWRpdG9yc1thclswXV07CiAgbGV0IHJlc3VsdCA9ICIiOwogIGlmKGVkaXRvciAhPT0gdW5kZWZpbmVkKXsKICAgIGVkaXRvci5mb2N1cygpOwogICAgbGV0IGRvYyA9IGVkaXRvci5nZXREb2MoKTsKICAgIGxldCBjdXJzb3IgPSBkb2MuZ2V0Q3Vyc29yKCk7CiAgICBsZXQgdGV4dCA9IGVkaXRvci5nZXRWYWx1ZSgpOwogICAgbGV0IHNlbGVjdGlvbiA9IGRvYy5nZXRTZWxlY3Rpb24oKTsKICAgIGxldCBleHByOwogICAgaWYoc2VsZWN0aW9uLmxlbmd0aCA+IDApewogICAgICBsZXQgZXhwciA9IHNlbGVjdGlvbjsKICAgIH0KICAgIGVsc2V7CiAgICAgIGxldCBpbmRleCA9IGRvYy5pbmRleEZyb21Qb3MoY3Vyc29yKTsKICAgICAgbGV0IHByZWNlZGluZyA9IHRleHQuc3Vic3RyaW5nKDAsaW5kZXgpOwogICAgICBsZXQgc3RhcnQgPSBpbmRleDsKICAgICAgd2hpbGUoc3RhcnQgPiAwKXsKICAgICAgICBpZigodGV4dC5jaGFyQXQoc3RhcnQpID09PSAiKCIpIHx8ICh0ZXh0LmNoYXJBdChzdGFydCkgPT09ICIgIikgIHx8ICh0ZXh0LmNoYXJBdChzdGFydCkgPT09ICJcbiIpKXsKICAgICAgICAgICAgc3RhcnQgPSBzdGFydCArIDE7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgZWxzZXsKICAgICAgICAgICAgc3RhcnQgPSBzdGFydCAtIDE7CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgbGV0IGVuZCA9IGluZGV4OwogICAgICB3aGlsZShlbmQgPCB0ZXh0Lmxlbmd0aCl7CiAgICAgICAgaWYoKHRleHQuY2hhckF0KGVuZCkgPT09ICIpIikgfHwgKHRleHQuY2hhckF0KGVuZCkgPT09ICIgIikgfHwgKHRleHQuY2hhckF0KGVuZCkgPT09ICJcbiIpKXsKICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgfQogICAgICAgICAgZWxzZXsKICAgICAgICAgICAgZW5kID0gZW5kICsgMTsKICAgICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdGV4dC5zdWJzdHJpbmcoc3RhcnQsZW5kKTsKICAgIH0KICB9Cn0pCgpGcm9ua2Vuc3RlZW4uZ2V0UHJvY2VkdXJlQXRDdXJzb3IgPSBmdW5jdGlvbihlZGl0b3JuYW1lKXsKICBsZXQgZWRpdG9yID0gY21fZWRpdG9yc1tlZGl0b3JuYW1lXTsKICBpZihlZGl0b3IgIT09IHVuZGVmaW5lZCl7CiAgICBlZGl0b3IuZm9jdXMoKTsKICAgIGxldCBkb2MgPSBlZGl0b3IuZ2V0RG9jKCk7CiAgICBsZXQgY3Vyc29yID0gZG9jLmdldEN1cnNvcigpOwogICAgbGV0IHRleHQgPSBlZGl0b3IuZ2V0VmFsdWUoKTsKICAgIGxldCBzZWxlY3Rpb24gPSBkb2MuZ2V0U2VsZWN0aW9uKCk7CiAgICBpZihzZWxlY3Rpb24ubGVuZ3RoIDw9IDApewogICAgICBsZXQgaW5kZXggPSBkb2MuaW5kZXhGcm9tUG9zKGN1cnNvcik7CiAgICAgIGxldCBwcmVjZWRpbmcgPSB0ZXh0LnN1YnN0cmluZygwLGluZGV4KTsKICAgICAgaWYoKHRleHQuY2hhckF0KGluZGV4KSA9PT0gIiAiKSB8fCAodGV4dC5jaGFyQXQoaW5kZXgpID09PSAiXG4iKSl7CiAgICAgICAgaW5kZXggPSBpbmRleCAtIDE7CiAgICAgIH0KICAgICAgbGV0IHN0YXJ0ID0gaW5kZXg7CiAgICAgIHdoaWxlKHN0YXJ0ID49IDApewogICAgICAgIGlmKCh0ZXh0LmNoYXJBdChzdGFydCkgPT09ICIoIikgfHwgKHRleHQuY2hhckF0KHN0YXJ0KSA9PT0gIiAiKSAgfHwgKHRleHQuY2hhckF0KHN0YXJ0KSA9PT0gIlxuIikpewogICAgICAgICAgICBzdGFydCA9IHN0YXJ0ICsgMTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlewogICAgICAgICAgICBzdGFydCA9IHN0YXJ0IC0gMTsKICAgICAgICAgIH0KICAgICAgfQogICAgICBsZXQgZW5kID0gaW5kZXg7CiAgICAgIHdoaWxlKGVuZCA8IHRleHQubGVuZ3RoKXsKICAgICAgICBpZigodGV4dC5jaGFyQXQoZW5kKSA9PT0gIikiKSB8fCAodGV4dC5jaGFyQXQoZW5kKSA9PT0gIiAiKSB8fCAodGV4dC5jaGFyQXQoZW5kKSA9PT0gIlxuIikpewogICAgICAgICAgICBicmVhazsKCiAgICAgICAgICB9CiAgICAgICAgICBlbHNlewogICAgICAgICAgICBlbmQgPSBlbmQgKyAxOwogICAgICAgICAgfQogICAgICB9CiAgICAgIHNlbGVjdGlvbiA9IHRleHQuc3Vic3RyaW5nKHN0YXJ0LGVuZCk7CiAgICB9CiAgICByZXR1cm4gc2VsZWN0aW9uLnRyaW0oKTsKfQogIHJldHVybiBmYWxzZTsKfQpCaXdhU2NoZW1lLmRlZmluZV9saWJmdW5jKCJjbS1lZGl0b3ItZ2V0LXByb2NlZHVyZS1hdC1jdXJzb3IiLDEsMSxmdW5jdGlvbihhcixpbnRwKXsKICAvLyBMb29rIHVwIHRoZSBzZWxlY3RlZCBTY2hlbWUgcHJvY2VkdXJlIG5hbWUgb3IgdGhlIHByb2NlZHVyZSBuYW1lIGJlZm9yZSB0aGUgY3Vyc29yIGluIHRoZSBkb2N1bWVudGF0aW9uLgogIEJpd2FTY2hlbWUuYXNzZXJ0X3N0cmluZyhhclswXSk7CiAgICBsZXQgc2VsZWN0aW9uID0gRnJvbmtlbnN0ZWVuLmdldFByb2NlZHVyZUF0Q3Vyc29yKGFyWzBdKQogICAgaWYoc2VsZWN0aW9uLmxlbmd0aCA+IDApewogICAgICByZXR1cm4gc2VsZWN0aW9uOwogICAgfQogICAgcmV0dXJuIGZhbHNlOwp9KTsKCgoKQml3YVNjaGVtZS5kZWZpbmVfbGliZnVuYygiY20tZWRpdG9yLWV2YWwtanMtc2VsZWN0aW9uISIsMSwxLGZ1bmN0aW9uKGFyLGludHApewogIC8vIFRyaWVzIHRvIGV2YWx1YXRlIHRoZSBKYXZhU2NyaXB0IGV4cHJlc3Npb24gZm91bmQgYmVmb3JlIHRoZSBjdXJyZW50IGN1cnNvciBwb3NpdGlvbiBpbiB0aGUgQ29kZU1pcnJvciBlZGl0b3Igc3BlY2lmaWVkIGluIGFyWzBdLgogIEJpd2FTY2hlbWUuYXNzZXJ0X3N0cmluZyhhclswXSk7CiAgbGV0IGVkaXRvciA9IGNtX2VkaXRvcnNbYXJbMF1dOwogIGxldCByZXN1bHQgPSAiIjsKICBpZihlZGl0b3IgIT09IHVuZGVmaW5lZCl7CiAgICBlZGl0b3IuZm9jdXMoKTsKICAgIGxldCBkb2MgPSBlZGl0b3IuZ2V0RG9jKCk7CiAgICBsZXQgY3Vyc29yID0gZG9jLmdldEN1cnNvcigpOwogICAgbGV0IHRleHQgPSBlZGl0b3IuZ2V0VmFsdWUoKTsKICAgIGxldCBzZWxlY3Rpb24gPSBkb2MuZ2V0U2VsZWN0aW9uKCk7CiAgICBpZihzZWxlY3Rpb24ubGVuZ3RoID4gMCl7CiAgICAgIHRyeXsKICAgICAgICBjb25zb2xlLmxvZygiZXZhbHVhdGluZyAiICsgc2VsZWN0aW9uKQogICAgICAgIHJlc3VsdCA9ICIgLy8iICsgZXZhbChzZWxlY3Rpb24pOwogICAgICB9CiAgICAgIGNhdGNoKGVycil7CiAgICAgICAgcmVzdWx0ID0gIi8vICIgKyBlcnIubWVzc2FnZTsKICAgICAgfQogICAgfQogICAgZWxzZSB7CiAgICAgIHJlc3VsdCA9ICAiIC8vIChub3RoaW5nIHNlbGVjdGVkKSI7CiAgICB9CiAgICBkb2MucmVwbGFjZVNlbGVjdGlvbihkb2MuZ2V0U2VsZWN0aW9uKCkgKyByZXN1bHQpOwogIH0KICBlbHNlIHsKICAgIGNvbnNvbGUubG9nKCJjbS1lZGl0b3ItZXZhbC1qcy1zZWxlY3Rpb24hOiAobm8gZWRpdG9yKSIpOwogIH0KfSkKCkJpd2FTY2hlbWUuZGVmaW5lX2xpYmZ1bmMoImNtLWVkaXRvci1ldmFsLXNlbGVjdGlvbi1vci1leHByLWJlZm9yZS1jdXJzb3IhIiwxLDEsZnVuY3Rpb24oYXIsaW50cCl7CiAgLy8gVHJpZXMgdG8gZXZhbHVhdGUgdGhlIFNjaGVtZSBleHByZXNzaW9uIGZvdW5kIGJlZm9yZSB0aGUgY3VycmVudCBjdXJzb3IgcG9zaXRpb24gaW4gdGhlIENvZGVNaXJyb3IgZWRpdG9yIHNwZWNpZmllZCBpbiBhclswXS4KICBCaXdhU2NoZW1lLmFzc2VydF9zdHJpbmcoYXJbMF0pOwogIGxldCBlZGl0b3IgPSBjbV9lZGl0b3JzW2FyWzBdXTsKICBsZXQgcmVzdWx0ID0gIiI7CiAgaWYoZWRpdG9yICE9PSB1bmRlZmluZWQpewogICAgZWRpdG9yLmZvY3VzKCk7CiAgICBsZXQgZG9jID0gZWRpdG9yLmdldERvYygpOwogICAgbGV0IGN1cnNvciA9IGRvYy5nZXRDdXJzb3IoKTsKICAgIGxldCB0ZXh0ID0gZWRpdG9yLmdldFZhbHVlKCk7CiAgICBsZXQgc2VsZWN0aW9uID0gZG9jLmdldFNlbGVjdGlvbigpOwogICAgbGV0IGV4cHI7CiAgICBpZihzZWxlY3Rpb24ubGVuZ3RoID4gMCl7CiAgICAgIGxldCBleHByID0gc2VsZWN0aW9uOwogICAgfQogICAgZWxzZXsKICAgICAgbGV0IGluZGV4ID0gZG9jLmluZGV4RnJvbVBvcyhjdXJzb3IpOwogICAgICBsZXQgcHJlY2VkaW5nID0gdGV4dC5zdWJzdHJpbmcoMCxpbmRleCk7CiAgICAgIHNlbGVjdGlvbiA9ICIiOwogICAgICBsZXQgbGFzdGNoYXIgPSB0ZXh0LmNoYXJBdChwcmVjZWRpbmcubGVuZ3RoIC0gMSk7CiAgICAgIGlmKGxhc3RjaGFyID09PSAiKSIpewogICAgICAgIHNlbGVjdGlvbiA9IEZyb25rZW5zdGVlbi5ldmFsX2V4dHJhY3Rfc2V4cChwcmVjZWRpbmcpOwogICAgICB9CiAgICAgIGVsc2UgaWYobGFzdGNoYXIgPT09ICJcIiIpewogICAgICAgIHNlbGVjdGlvbiA9IEZyb25rZW5zdGVlbi5ldmFsX2V4dHJhY3Rfc3RyaW5nKHByZWNlZGluZykKICAgICAgfQogICAgICBlbHNlIHsKICAgICAgICBzZWxlY3Rpb24gPSBGcm9ua2Vuc3RlZW4uZXZhbF9leHRyYWN0X2F0b20ocHJlY2VkaW5nKQogICAgICB9CiAgICB9CiAgICBpZihzZWxlY3Rpb24gPT09IG51bGwpewogICAgICByZXN1bHQgPSAiIDsgTm8gYmFsYW5jZWQgZXhwcmVzc2lvbiBmb3VuZCBwcmVjZWRpbmcgY3Vyc29yLiIKICAgIH0KICAgIGVsc2V7CiAgICAgIHJlc3VsdCA9ICIgOyB2YWx1ZTogICIgKyBzY2hlbWVfaW50ZXJwcmV0ZXIuZXZhbHVhdGUoc2VsZWN0aW9uKSArIEZyb25rZW5zdGVlbi5DdW11bGF0aXZlRXJyb3JzLmpvaW4oIlxuIik7CiAgICAgIEZyb25rZW5zdGVlbi5DdW11bGF0aXZlRXJyb3JzID0gW107CiAgICB9CiAgICBkb2MucmVwbGFjZVNlbGVjdGlvbihkb2MuZ2V0U2VsZWN0aW9uKCkgKyByZXN1bHQpOwogICAgcmV0dXJuIHRydWU7CgogIH0KICBlbHNlewogICAgY29uc29sZS5sb2coImNtLWVkaXRvci1leHByLWJlZm9yZS1jdXJzb3I6IE5vIGVkaXRvciBjb3JyZXNwb25kaW5nIHRvICIgKyBhclswXSk7CiAgICByZXR1cm4gZmFsc2U7CiAgfQp9KTsKCiAgQml3YVNjaGVtZS5kZWZpbmVfbGliZnVuYygiY20tZXZhbC1lZGl0b3ItYnVmZmVyISIsMSwxLGZ1bmN0aW9uKGFyLGludHApewogICAgLy8gRXZhbHVhdGVzIHRoZSBlbnRpcmUgYnVmZmVyIGZyb20gdGhlIENvZGVNaXJyb3IgZWRpdG9yIHNwZWNpZmllZCBpbiBhclswXSBhcyBTY2hlbWUgY29kZS4KICAgIEJpd2FTY2hlbWUuYXNzZXJ0X3N0cmluZyhhclswXSk7CiAgICBsZXQgZWRpdG9yID0gY21fZWRpdG9yc1thclswXV07CiAgICBsZXQgcmVzdWx0ID0gIiI7CiAgICBpZihlZGl0b3IgIT09IHVuZGVmaW5lZCl7CiAgICAgIGVkaXRvci5mb2N1cygpOwogICAgICBsZXQgZG9jID0gZWRpdG9yLmdldERvYygpOwogICAgICBsZXQgY3Vyc29yID0gZG9jLmdldEN1cnNvcigpOwogICAgICBsZXQgdGV4dCA9IGVkaXRvci5nZXRWYWx1ZSgpOwogICAgICByZXN1bHQgPSAiIDsgdmFsdWU6ICIgKyBzY2hlbWVfaW50ZXJwcmV0ZXIuZXZhbHVhdGUodGV4dCkgKyBGcm9ua2Vuc3RlZW4uQ3VtdWxhdGl2ZUVycm9ycy5qb2luKCJcbiIpOwogICAgICBGcm9ua2Vuc3RlZW4uQ3VtdWxhdGl2ZUVycm9ycyA9IFtdOwogICAgICBlZGl0b3Iuc2V0VmFsdWUodGV4dCArIHJlc3VsdCk7CiAgICAgIHJldHVybiB0cnVlOwoKICAgIH0KICAgIGVsc2V7CiAgICAgIGNvbnNvbGUubG9nKCJjbS1ldmFsLWVkaXRvci1idWZmZXIhOiBObyBlZGl0b3IgY29ycmVzcG9uZGluZyB0byAiICsgYXJbMF0pOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9Cgp9KTsKCgpCaXdhU2NoZW1lLmRlZmluZV9saWJmdW5jKCJjbS1lZGl0b3ItdW5kbyEiLCAxLCAxLCBmdW5jdGlvbihhcixpbnRwKXsKICAvLyBVbmRvZXMgbGFzdCBlZGl0aW5nIG9wZXJhdGlvbiBpbiB0aGUgQ29kZU1pcnJvciBlZGl0b3Igc3BlY2lmZWQgaW4gYXJbMF0uCiAgQml3YVNjaGVtZS5hc3NlcnRfc3RyaW5nKGFyWzBdKTsKICBsZXQgZWRpdG9yID0gY21fZWRpdG9yc1thclswXV07CiAgaWYoZWRpdG9yICE9PSB1bmRlZmluZWQpewogICAgcmV0dXJuIGVkaXRvci51bmRvKCk7CiAgfQogIGVsc2V7CiAgICBjb25zb2xlLmxvZygiY20tZWRpdG9yLXVuZG8hOiBObyBlZGl0b3IgY29ycmVzcG9uZGluZyB0byAiICsgYXJbMF0pOwogICAgcmV0dXJuIG51bGw7CiAgfQp9KQpCaXdhU2NoZW1lLmRlZmluZV9saWJmdW5jKCJjbS1lZGl0b3ItcmVkbyEiLCAxLCAxLCBmdW5jdGlvbihhcixpbnRwKXsKICAvLyBSZWRvZXMgbGFzdCBlZGl0aW5nIG9wZXJhdGlvbiBpbiB0aGUgQ29kZU1pcnJvciBlZGl0b3Igc3BlY2lmZWQgaW4gYXJbMF0uCiAgQml3YVNjaGVtZS5hc3NlcnRfc3RyaW5nKGFyWzBdKTsKICBsZXQgZWRpdG9yID0gY21fZWRpdG9yc1thclswXV07CiAgaWYoZWRpdG9yICE9PSB1bmRlZmluZWQpewogICAgcmV0dXJuIGVkaXRvci5yZWRvKCk7CiAgfQogIGVsc2V7CiAgICBjb25zb2xlLmxvZygiY20tZWRpdG9yLXJlZG8hOiBObyBlZGl0b3IgY29ycmVzcG9uZGluZyB0byAiICsgYXJbMF0pOwogICAgcmV0dXJuIG51bGw7CiAgfQp9KQpCaXdhU2NoZW1lLmRlZmluZV9saWJmdW5jKCJpcy1jbS1lZGl0b3ItY2xlYW4/IiwgMSwgMSwgZnVuY3Rpb24oYXIsaW50cCl7CiAgLy8gUmV0dXJucyB0cnVlIGlmIHRoZSBDb2RlTWlycm9yIGVkaXRvciBzcGVjaWZlZCBpbiBhclswXSBpcyAiY2xlYW4iIChpLmUuLCBoYXNuJ3QgY2hhbmdlcyBzaW5jZSB0aGUgbGFzdCB0aW1lIGl0IHdhcyBtYXJrZWQgYXMgY2xlYW4pLiBVc2VkIHRvIGRldGVybWluZSBpZiBhbiBlZGl0b3IgbmVlZHMgdG8gYmUgc2F2ZWQuCiAgQml3YVNjaGVtZS5hc3NlcnRfc3RyaW5nKGFyWzBdKTsKICBsZXQgZWRpdG9yID0gY21fZWRpdG9yc1thclswXV07CiAgaWYoZWRpdG9yICE9PSB1bmRlZmluZWQpewogICAgcmV0dXJuIGVkaXRvci5nZXREb2MoKS5pc0NsZWFuKCk7CiAgfQogIGVsc2V7CiAgICBjb25zb2xlLmxvZygiaXMtY20tZWRpdG9yLWNsZWFuPzogTm8gZWRpdG9yIGNvcnJlc3BvbmRpbmcgdG8gIiArIGFyWzBdKTsKICAgIHJldHVybiBmYWxzZTsKICB9Cgp9KQoKQml3YVNjaGVtZS5kZWZpbmVfbGliZnVuYygic2V0LWNtLWVkaXRvci1jbGVhbiEiLCAxLCAxLCBmdW5jdGlvbihhcixpbnRwKXsKICAvLyBTZXRzIHRoZSBDb2RlTWlycm9yIGVkaXRvciBzcGVjaWZlZCBpbiBhclswXSBhcyAiY2xlYW4iLgogIEJpd2FTY2hlbWUuYXNzZXJ0X3N0cmluZyhhclswXSk7CiAgbGV0IGVkaXRvciA9IGNtX2VkaXRvcnNbYXJbMF1dOwogIGlmKGVkaXRvciAhPT0gdW5kZWZpbmVkKXsKICAgIHJldHVybiBlZGl0b3IuZ2V0RG9jKCkubWFya0NsZWFuKCk7CiAgfQogIGVsc2V7CiAgICBjb25zb2xlLmxvZygic2V0LWNtLWVkaXRvci1jbGVhbiE6IE5vIGVkaXRvciBjb3JyZXNwb25kaW5nIHRvICIgKyBhclswXSk7CiAgICByZXR1cm4gZmFsc2U7CiAgfQp9KQoKQml3YVNjaGVtZS5kZWZpbmVfbGliZnVuYygiZ2V0LWNtLWVkaXRvci10ZXh0IiwgMSwgMSwgZnVuY3Rpb24oYXIsaW50cCl7CiAgQml3YVNjaGVtZS5hc3NlcnRfc3RyaW5nKGFyWzBdKTsKICBsZXQgZWRpdG9yID0gY21fZWRpdG9yc1thclswXV07CiAgaWYoZWRpdG9yICE9PSB1bmRlZmluZWQpewogICAgcmV0dXJuIGVkaXRvci5nZXRWYWx1ZSgpOwogIH0KICBlbHNlewogICAgY29uc29sZS5sb2coImdldC1jbS1lZGl0b3ItdGV4dDogTm8gZWRpdG9yIGNvcnJlc3BvbmRpbmcgdG8gIiArIGFyWzBdKTsKICAgIHJldHVybiBudWxsOwogIH0KfSkKCkJpd2FTY2hlbWUuZGVmaW5lX2xpYmZ1bmMoImZvY3VzLWNtLWVkaXRvci1jb21wb25lbnQhIiwgMSwgMSwgZnVuY3Rpb24oYXIsaW50cCl7CiAgQml3YVNjaGVtZS5hc3NlcnRfc3RyaW5nKGFyWzBdKTsKICBsZXQgZWRpdG9yID0gY21fZWRpdG9yc1thclswXV07CiAgaWYoZWRpdG9yICE9PSB1bmRlZmluZWQpewogICAgcmV0dXJuIGVkaXRvci5mb2N1cygpOwogIH0KICBlbHNlewogICAgY29uc29sZS5sb2coImZvY3VzLWNtLWVkaXRvci1jb21wb25lbnQhOiBObyBlZGl0b3IgY29ycmVzcG9uZGluZyB0byAiICsgYXJbMF0pOwogICAgcmV0dXJuIG51bGw7CiAgfQp9KQoKQml3YVNjaGVtZS5kZWZpbmVfbGliZnVuYygicmVmcmVzaC1jbS1lZGl0b3ItY29tcG9uZW50ISIsIDEsIDEsIGZ1bmN0aW9uKGFyLGludHApewogIGxldCBlZGl0b3IgPSBjbV9lZGl0b3JzW2FyWzBdXTsKICBpZihlZGl0b3IgIT09IHVuZGVmaW5lZCl7CiAgICByZXR1cm4gZWRpdG9yLnJlZnJlc2goKTsKICB9CiAgZWxzZXsKICAgIGNvbnNvbGUubG9nKCJyZWZyZXNoLWNtLWVkaXRvci1jb21wb25lbnQhOiBObyBlZGl0b3IgY29ycmVzcG9uZGluZyB0byAiICsgYXJbMF0pOwogICAgcmV0dXJuIG51bGw7CiAgfQp9KQoKQml3YVNjaGVtZS5kZWZpbmVfbGliZnVuYygiZGVzdHJveS1jbS1lZGl0b3IhIiwgMSwgMSwgZnVuY3Rpb24oYXIsaW50cCl7CiAgQml3YVNjaGVtZS5hc3NlcnRfc3RyaW5nKGFyWzBdKTsKICBsZXQgZWRpdG9yID0gY21fZWRpdG9yc1thclswXV07CiAgaWYoZWRpdG9yICE9PSB1bmRlZmluZWQpewogICAgZGVsZXRlIGNtX2VkaXRvcnNbYXJbMF1dOwogICAgcmV0dXJuIGVkaXRvci50b1RleHRBcmVhKCk7CgogIH0KICBlbHNlewogICAgY29uc29sZS5sb2coImRlc3Ryb3ktY20tZWRpdG9yITogTm8gZWRpdG9yIGNvcnJlc3BvbmRpbmcgdG8gIiArIGFyWzBdKTsKICAgIHJldHVybiBudWxsOwogIH0KfSkKCmxldCBjbV9lZGl0b3JzID0ge307CgpmdW5jdGlvbiBmb2N1c0ZpbmQoKXsKICBjb25zb2xlLmxvZygiZmluZCIpCiAgc2NoZW1lX2ludGVycHJldGVyLmV2YWx1YXRlKCIoZm9jdXMtZmluZCkiKTsKICByZXR1cm4gdHJ1ZTsKfQoKLy8gUmV0dXJucyBhIHZlY3RvciBvZiB0aGUgaWRzIG9mIHRoZSB0ZXh0YXJlYXMgYXNzb2NpYXRlZCB3aXRoIGVhY2ggYWN0aXZlIENvZGVNaXJyb3IgZWRpdG9yLgpCaXdhU2NoZW1lLmRlZmluZV9saWJmdW5jKCJnZXQtY20tZWRpdG9yLWlkcyIsMSwxLGZ1bmN0aW9uKGFyLGludHApewogIHJldHVybiBPYmplY3Qua2V5cyhjbV9lZGl0b3JzKTsKfSk7CgoKQml3YVNjaGVtZS5kZWZpbmVfbGliZnVuYygiaW5pdC1jbS1lZGl0b3IhIiwgMiwgMiwgZnVuY3Rpb24oYXIsaW50cCl7CiAgLy8gQ29udmVydCB0aGUgdGV4dGFyZWEgaW4gYXJbMF0gdG8gYSBDb2RlTWlycm9yIHRleHQgZWRpdG9yLgogIEJpd2FTY2hlbWUuYXNzZXJ0X3N0cmluZyhhclswXSk7CiAgQml3YVNjaGVtZS5hc3NlcnRfc3RyaW5nKGFyWzFdKTsKICBsZXQgYWN0aXZlQ01FZGl0b3IgPSBDb2RlTWlycm9yLmZyb21UZXh0QXJlYSgkKGFyWzBdKVswXSwKICAgewogICAgICAgbWF0Y2hCcmFja2V0czogdHJ1ZSwKICAgICAgIGF1dG9DbG9zZUJyYWNrZXRzOiB0cnVlLAogICAgICAgbGluZVdyYXBwaW5nOnRydWUsCiAgICAgICB2aWV3cG9ydE1hcmdpbjpJbmZpbml0eSwKICAgICAgIGF1dG9Gb2N1czp0cnVlLAogICAgICAgbGluZU51bWJlcnM6dHJ1ZSwKICAgICAgIG1vZGU6YXJbMV0sCiAgICAgICBleHRyYUtleXM6IHsKICAgICAgICAgIkFsdC1GIjogImZvY3VzRmluZCIKICAgICAgICAgfQogICB9ICk7CiAgYWN0aXZlQ01FZGl0b3IuZm9jdXMoKTsKICAvL2FjdGl2ZUNNRWRpdG9yLnNldFNpemUoIjUwZW0iLCI3NXZoIik7CiAgc2V0VGltZW91dChmdW5jdGlvbigpewogICAgYWN0aXZlQ01FZGl0b3IucmVmcmVzaCgpOwogIH0sMSkKCiAgLy9hY3RpdmVFZGl0b3Iuc2V0U2l6ZSgiMTAwJSIsIjUwZW0iKTsKICAvL2xhc3RDTUVkaXRvciA9IGFjdGl2ZUNNRWRpdG9yOwogIGNtX2VkaXRvcnNbYXJbMF1dID0gYWN0aXZlQ01FZGl0b3I7CiAgcmV0dXJuIGFjdGl2ZUNNRWRpdG9yOwp9KQoKCmNsYXNzIENNRWRpdG9yRHJpdmVyIHsKICAgIGNvbnN0cnVjdG9yKCl7CiAgICAgIHRoaXMuY29kZUxhbmd1YWdlID0gIm1hcmtkb3duIjsKICAgIH0KICAgIGdldFRleHQoZWRpdG9ybmFtZSl7CiAgICAgIGxldCBlZGl0b3IgPSBjbV9lZGl0b3JzW2VkaXRvcm5hbWVdOwogICAgICBpZihlZGl0b3IgPT09IHVuZGVmaW5lZCl7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQogICAgICByZXR1cm4gZWRpdG9yLmdldERvYygpLmdldFZhbHVlKCk7CiAgICB9CiAgICBzZXRUZXh0KGVkaXRvcm5hbWUsdmFsdWUpewogICAgICBsZXQgZWRpdG9yID0gY21fZWRpdG9yc1tlZGl0b3JuYW1lXTsKICAgICAgaWYoZWRpdG9yID09PSB1bmRlZmluZWQpewogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KICAgICAgZWRpdG9yLmdldERvYygpLnNldFZhbHVlKHZhbHVlKTsKICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpewogICAgICAgIGVkaXRvci5yZWZyZXNoKCk7CiAgICAgIH0sMSkKICAgIH0KICAgIHNldEN1cnNvclBvc2l0aW9uKGVkaXRvcm5hbWUsbGluZSxjb2x1bW4pewogICAgICBsZXQgZWRpdG9yID0gY21fZWRpdG9yc1tlZGl0b3JuYW1lXTsKICAgICAgaWYoZWRpdG9yID09PSB1bmRlZmluZWQpewogICAgICAgIGNvbnNvbGUubG9nKCJObyBlZGl0b3IgZm91bmQgZm9yICIgKyBlZGl0b3JuYW1lKQogICAgICB9CiAgICAgIGVkaXRvci5nZXREb2MoKS5zZXRDdXJzb3IobGluZSxjb2x1bW4pCiAgICB9CiAgICBzY3JvbGxUb0xpbmUoZWRpdG9ybmFtZSxsaW5lKXsKICAgICAgbGV0IGVkaXRvciA9IGNtX2VkaXRvcnNbZWRpdG9ybmFtZV07CiAgICAgIGlmKGVkaXRvciA9PT0gdW5kZWZpbmVkKXsKICAgICAgICBjb25zb2xlLmxvZygiTm8gZWRpdG9yIGZvdW5kIGZvciAiICsgZWRpdG9ybmFtZSk7CiAgICAgICAgcmV0dXJuOwoKICAgICAgfQogICAgICB2YXIgaCA9IGVkaXRvci5nZXRTY3JvbGxJbmZvKCkuY2xpZW50SGVpZ2h0OwogICAgICB2YXIgY29vcmRzID0gZWRpdG9yLmNoYXJDb29yZHMoe2xpbmU6IGxpbmUgLSAxLCBjaDogMH0sICJsb2NhbCIpOwogICAgICBlZGl0b3Iuc2Nyb2xsVG8obnVsbCwgY29vcmRzLnRvcCk7CgogICAgfQogICAgZXNjYXBlUmVnRXhwKHMpewogICAgICAgIHJldHVybiBzLnJlcGxhY2UoL1stL1xcXiQqKz8uKCl8W1xde31dL2csICdcXCQmJykKICAgIH0KICAgIHNldENvZGVMYW5ndWFnZShuZXdsYW5ndWFnZSl7CiAgICAgIHRoaXMuY29kZUxhbmd1YWdlID0gbmV3bGFuZ3VhZ2U7CiAgICB9CiAgICBnZXRTZWxlY3Rpb24oZWRpdG9ybmFtZSl7CiAgICAgIGxldCBlZGl0b3IgPSBjbV9lZGl0b3JzW2VkaXRvcm5hbWVdOwogICAgICBpZihlZGl0b3IgIT09IHVuZGVmaW5lZCl7CiAgICAgICAgcmV0dXJuIGVkaXRvci5nZXRTZWxlY3Rpb24oKTsKICAgICAgfQogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIHNldFNlbGVjdGlvbihlZGl0b3JuYW1lLHN0YXJ0LGVuZCl7CiAgICAgIGxldCBlZGl0b3IgPSBjbV9lZGl0b3JzW2VkaXRvcm5hbWVdOwogICAgICBpZihlZGl0b3IgIT09IHVuZGVmaW5lZCl7CiAgICAgICAgcmV0dXJuIGVkaXRvci5zZXRTZWxlY3Rpb24oKTsKICAgICAgfQogICAgICByZXR1cm4gbnVsbDsKICAgIH0KCiAgICByZXBsYWNlU2VsZWN0ZWRUZXh0KGVkaXRvcm5hbWUsdGV4dCxtb2RlKXsKICAgICAgbGV0IGVkaXRvciA9IGNtX2VkaXRvcnNbZWRpdG9ybmFtZV07CiAgICAgIGlmKGVkaXRvciAhPT0gdW5kZWZpbmVkKXsKICAgICAgICByZXR1cm4gZWRpdG9yLnJlcGxhY2VTZWxlY3Rpb24odGV4dCxtb2RlKTsKICAgICAgfQogICAgICByZXR1cm4gbnVsbDsKCiAgICB9CiAgICBzdXJyb3VuZFNlbGVjdGVkVGV4dChlZGl0b3JuYW1lLHByZWFtYmxlLHBvc3RhbWJsZSxtb2RlKXsKICAgICAgbGV0IGVkaXRvciA9IGNtX2VkaXRvcnNbZWRpdG9ybmFtZV07CiAgICAgIGlmKGVkaXRvciAhPT0gdW5kZWZpbmVkKXsKICAgICAgICByZXR1cm4gZWRpdG9yLnJlcGxhY2VTZWxlY3Rpb24ocHJlYW1ibGUgKyBlZGl0b3IuZ2V0U2VsZWN0aW9uKCkgKyBwb3N0YW1ibGUsbW9kZSk7CiAgICAgIH0KICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICBzZXRGZW5jZShlZGl0b3JuYW1lLHByZWFtYmxlLHBvc3RhbWJsZSl7CiAgICAgIGxldCBlZGl0b3IgPSBjbV9lZGl0b3JzW2VkaXRvcm5hbWVdOwogICAgICBpZihlZGl0b3IgPT09IHVuZGVmaW5lZCl7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQoKICAgICAgICB2YXIgc2VsdGV4dCA9IHRoaXMuZ2V0U2VsZWN0aW9uKGVkaXRvcm5hbWUpOwogICAgICAgIGlmKHNlbHRleHQubGVuZ3RoID09PSAwKXsKICAgICAgICAgIGFsZXJ0KCJObyB0ZXh0IHNlbGVjdGVkLiIpCiAgICAgICAgICByZXR1cm47CiAgICAgICAgfTsKICAgICAgICB2YXIgcmVzdHJpbmcgPSAiXiIgKyB0aGlzLmVzY2FwZVJlZ0V4cChwcmVhbWJsZSkgKyAiLioiICsgdGhpcy5lc2NhcGVSZWdFeHAocG9zdGFtYmxlKSArICIkIjsKICAgICAgICB2YXIgZmVuY3JlID0gbmV3IFJlZ0V4cChyZXN0cmluZyk7CiAgICAgICAgdmFyIGZlbmNlbGVuZ3RoID0gcHJlYW1ibGUubGVuZ3RoICsgcG9zdGFtYmxlLmxlbmd0aDsKICAgICAgICBpZihzZWx0ZXh0Lm1hdGNoKGZlbmNyZSkpewogICAgICAgICAgdGhpcy5yZXBsYWNlU2VsZWN0ZWRUZXh0KGVkaXRvcm5hbWUsc2VsdGV4dC5zdWJzdHJpbmcocHJlYW1ibGUubGVuZ3RoLCBzZWx0ZXh0Lmxlbmd0aCAtIHBvc3RhbWJsZS5sZW5ndGgpLCJhcm91bmQiKTsKICAgICAgICAgICBlZGl0b3IuZm9jdXMoKTsKICAgICAgICB9CiAgICAgICAgZWxzZXsKICAgICAgICAgICAgdGhpcy5zdXJyb3VuZFNlbGVjdGVkVGV4dChlZGl0b3JuYW1lLHByZWFtYmxlLHBvc3RhbWJsZSwiYXJvdW5kIik7CiAgICAgICAgICAgIGVkaXRvci5mb2N1cygpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICBzZXRMaW5lUHJlZml4KGVkaXRvcm5hbWUscHJlZml4KXsKICAgICAgbGV0IGVkaXRvciA9IGNtX2VkaXRvcnNbZWRpdG9ybmFtZV07CiAgICAgIGlmKGVkaXRvciA9PT0gdW5kZWZpbmVkKXsKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICB9CiAgICAgICAgdmFyIHJlc3RyaW5nID0gdGhpcy5lc2NhcGVSZWdFeHAocHJlZml4KQogICAgICAgIHZhciBwcmVmcmUgPSBuZXcgUmVnRXhwKCJeIiArIHJlc3RyaW5nKTsKICAgICAgICB2YXIgc3RhcnQgPSBlZGl0b3IuZ2V0Q3Vyc29yKCJmcm9tIikKICAgICAgICB2YXIgc3RhcnRMaW5lID0gc3RhcnQubGluZTsKICAgICAgICB2YXIgc3RhcnRDaCA9IHN0YXJ0LmNoOwogICAgICAgIHZhciBlbmQgPSBlZGl0b3IuZ2V0Q3Vyc29yKCJ0byIpOwogICAgICAgIHZhciBlbmRDaCA9IGVuZC5jaDsKICAgICAgICB2YXIgbGluZUFyciA9IGVkaXRvci5nZXRWYWx1ZSgpLnNwbGl0KCJcbiIpOwogICAgICAgIHZhciB3b3JraW5nTGluZSA9IGxpbmVBcnJbc3RhcnRMaW5lXTsKICAgICAgICB2YXIgcHJlZml4RGVsdGE7CiAgICAgICAgaWYod29ya2luZ0xpbmUubWF0Y2gocHJlZnJlKSl7CiAgICAgICAgICAgd29ya2luZ0xpbmUgPSB3b3JraW5nTGluZS5yZXBsYWNlKHByZWZyZSwiIik7CiAgICAgICAgICAgICBwcmVmaXhEZWx0YSA9IC1wcmVmaXgubGVuZ3RoCiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgICB3b3JraW5nTGluZSA9IHByZWZpeCArIHdvcmtpbmdMaW5lCiAgICAgICAgICAgIHByZWZpeERlbHRhID0gcHJlZml4Lmxlbmd0aDsKICAgICAgICB9CiAgICAgICAgbGluZUFycltzdGFydExpbmVdID0gd29ya2luZ0xpbmUKICAgICAgICBlZGl0b3Iuc2V0VmFsdWUobGluZUFyci5qb2luKCJcbiIpKTsKICAgICAgICBlZGl0b3Iuc2V0U2VsZWN0aW9uKHtsaW5lOnN0YXJ0TGluZSwgY2g6MH0se2xpbmU6c3RhcnRMaW5lLGNoOmVuZENoICsgcHJlZml4RGVsdGF9KQogICAgICAgIGVkaXRvci5mb2N1cygpOwogICAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgc2V0TGluZVN1ZmZpeChlZGl0b3JuYW1lLHN1ZmZpeCl7CiAgICAgIGxldCBlZGl0b3IgPSBjbV9lZGl0b3JzW2VkaXRvcm5hbWVdOwogICAgICBpZihlZGl0b3IgPT09IHVuZGVmaW5lZCl7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQogICAgICAgIHZhciByZXN0cmluZyA9IHRoaXMuZXNjYXBlUmVnRXhwKHN1ZmZpeCkgKyAiLioiCiAgICAgICAgdmFyIHN1ZmZyZSA9IG5ldyBSZWdFeHAocmVzdHJpbmcgKyAiJCIpOwogICAgICAgIHZhciBzZWxlY3RlZExpbmUgPSBlZGl0b3IuZ2V0Q3Vyc29yKCJmcm9tIikubGluZTsKICAgICAgICB2YXIgbGluZUFyciA9IGVkaXRvci5nZXRWYWx1ZSgpLnNwbGl0KCJcbiIpOwogICAgICAgIHZhciB3b3JraW5nTGluZSA9IGxpbmVBcnJbc2VsZWN0ZWRMaW5lXQogICAgICAgIGlmKHdvcmtpbmdMaW5lLm1hdGNoKHN1ZmZyZSkpewogICAgICAgICAgIHdvcmtpbmdMaW5lID0gd29ya2luZ0xpbmUucmVwbGFjZShzdWZmcmUsIiIpCiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgICB3b3JraW5nTGluZSA9IHdvcmtpbmdMaW5lICsgc3VmZml4CiAgICAgICAgfQogICAgICAgIGxpbmVBcnJbc2VsZWN0ZWRMaW5lXSA9IHdvcmtpbmdMaW5lCiAgICAgICAgZWRpdG9yLnNldFZhbHVlKGxpbmVBcnIuam9pbigiXG4iKSk7CiAgICAgICAgZWRpdG9yLmZvY3VzKCk7CiAgICB9CiAgICBzZXRJdGFsaWMoZWRpdG9ybmFtZSl7CiAgICAgICAgdGhpcy5zZXRGZW5jZShlZGl0b3JuYW1lLCIqIiwiKiIpOwogICAgfQogICAgc2V0Qm9sZChlZGl0b3JuYW1lKXsKICAgICAgICB0aGlzLnNldEZlbmNlKGVkaXRvcm5hbWUsIioqIiwiKioiKTsKICAgIH0KICAgIHNldFN1cGVyc2NyaXB0KGVkaXRvcm5hbWUpewogICAgICAgIHRoaXMuc2V0RmVuY2UoZWRpdG9ybmFtZSwiXiIsIl4iKTsKICAgIH0KICAgIHNldFN1YnNjcmlwdChlZGl0b3JuYW1lKXsKICAgICAgICB0aGlzLnNldEZlbmNlKGVkaXRvcm5hbWUsIn4iLCJ+Iik7CiAgICB9CiAgICBzZXRTdHJpa2VvdXQoZWRpdG9ybmFtZSl7CiAgICAgICAgdGhpcy5zZXRGZW5jZShlZGl0b3JuYW1lLCJ+fiIsIn5+Iik7CiAgICB9CiAgICBzZXROb3RlKGVkaXRvcm5hbWUpewogICAgICAgIHRoaXMuc2V0RmVuY2UoZWRpdG9ybmFtZSwie3t7IiwifX19Iik7CiAgICB9CiAgICBzZXRNYXRoKGVkaXRvcm5hbWUpewogICAgICB0aGlzLnNldEZlbmNlKGVkaXRvcm5hbWUsIiQkIiwiJCQiKTsKICAgIH0KICAgIG11bHRpbGluZUZlbmNlKGVkaXRvcm5hbWUscHJlZml4LHN1ZmZpeCl7CiAgICAgIGxldCBlZGl0b3IgPSBjbV9lZGl0b3JzW2VkaXRvcm5hbWVdOwogICAgICAgIHZhciBzZWwgPSB0aGlzLmdldFNlbGVjdGlvbihlZGl0b3JuYW1lKTsKICAgICAgLy8gIHZhciB2YWwgPSBlZGl0b3IuZ2V0VmFsdWUoKTsKICAgICAgICB2YXIgZmVuY2VyZSA9IG5ldyBSZWdFeHAoIl4iICsgdGhpcy5lc2NhcGVSZWdFeHAocHJlZml4KSArICIoKC58XG4pKikiICsgdGhpcy5lc2NhcGVSZWdFeHAoc3VmZml4KSArICIkIiwibSIpOwogICAgICAgIGlmKHNlbC5tYXRjaChmZW5jZXJlKSl7CiAgICAgICAgICAgIHRoaXMucmVwbGFjZVNlbGVjdGVkVGV4dChlZGl0b3JuYW1lLCBzZWwucmVwbGFjZShmZW5jZXJlLCIkMSIpLCJhcm91bmQiKTsKICAgICAgICAgICAgZWRpdG9yLmZvY3VzKCk7CiAgICAgICAgfQogICAgICAgIGVsc2V7CiAgICAgICAgICB0aGlzLnJlcGxhY2VTZWxlY3RlZFRleHQoZWRpdG9ybmFtZSwgcHJlZml4ICsgc2VsICsgc3VmZml4LCAiYXJvdW5kIikKICAgICAgICAgICAgLy90aGlzLnNldExpbmVTdWZmaXgoZWRpdG9yLHN1ZmZpeCk7CiAgICAgICAgICAvLyAgdGhpcy5zZXRMaW5lUHJlZml4KGVkaXRvcixwcmVmaXgpOwogICAgICAgICAgICBlZGl0b3IuZm9jdXMoKTsKICAgICAgICB9CgogICAgfQogICAgc2V0QmxvY2tQcmVmaXgoZWRpdG9ybmFtZSxwcmVmaXgsaW5jcmVtZW50LCBzcGFjZSl7CiAgICAgIGxldCBlZGl0b3IgPSBjbV9lZGl0b3JzW2VkaXRvcm5hbWVdOwogICAgICBpZihlZGl0b3IgPT09IHVuZGVmaW5lZCl7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQogICAgICAgIHZhciBzZWx0ZXh0ID0gdGhpcy5nZXRTZWxlY3Rpb24oZWRpdG9ybmFtZSk7CiAgICAgICAgdmFyIGxpbmVzID0gc2VsdGV4dC5zcGxpdCgiXG4iKTsKICAgICAgICB2YXIgc2VsZWN0aW9uTGVuZ3RoID0gMDsKICAgICAgICB2YXIgcHJlZml4bWF0Y2ggPSBwcmVmaXggKyBzcGFjZTsKICAgICAgICBmb3IodmFyIGkgPSAwOyBpIDwgbGluZXMubGVuZ3RoOyBpKyspewogICAgICAgICAgaWYobGluZXNbaV0gIT09ICIiKXsKICAgICAgICAgICAgaWYobGluZXNbaV0uaW5kZXhPZihwcmVmaXhtYXRjaCkgPT09IDApewogICAgICAgICAgICAgICAgbGluZXNbaV0gPSBsaW5lc1tpXS5zdWJzdHJpbmcocHJlZml4bWF0Y2gubGVuZ3RoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlewogICAgICAgICAgICAgICAgbGluZXNbaV0gPSBwcmVmaXhtYXRjaCArIGxpbmVzW2ldOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKGluY3JlbWVudCA9PT0gdHJ1ZSl7CiAgICAgICAgICAgICAgICBwcmVmaXggPSBwcmVmaXggKyAxOwogICAgICAgICAgICAgICAgcHJlZml4bWF0Y2ggPSBwcmVmaXggKyBzcGFjZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBzZWx0ZXh0ID0gbGluZXMuam9pbigiXG4iKTsKICAgICAgICB0aGlzLnJlcGxhY2VTZWxlY3RlZFRleHQoZWRpdG9ybmFtZSxzZWx0ZXh0LCJhcm91bmQiKTsKICAgICAgICBlZGl0b3IuZm9jdXMoKTsKCiAgICB9CiAgICBzZXRCdWxsZXRlZExpc3QoZWRpdG9ybmFtZSl7CiAgICAgICAgdGhpcy5wcmVmaXhSZWdpb24oZWRpdG9ybmFtZSwiKiIsZmFsc2UsIiAiKQogICAgfQoKICAgIHNldE51bWJlcmVkTGlzdChlZGl0b3JuYW1lKXsKICAgICAgICAgdGhpcy5wcmVmaXhSZWdpb24oZWRpdG9ybmFtZSwxLHRydWUsIi4gIikKICAgIH0KICAgIHNldEJsb2NrUXVvdGUoZWRpdG9ybmFtZSl7CiAgICAgICAgIHRoaXMucHJlZml4UmVnaW9uKGVkaXRvcm5hbWUsIj4iLGZhbHNlLCIgIik7CiAgICB9CiAgICBzZXRQb2V0cnkoZWRpdG9ybmFtZSl7CiAgICAgICAgdGhpcy5wcmVmaXhSZWdpb24oZWRpdG9ybmFtZSwifCIsZmFsc2UsIiAiKTsKICAgIH0KICAgIHNldENvZGUoZWRpdG9ybmFtZSl7CiAgICAgICAgdmFyIHNlbHRleHQgPSB0aGlzLmdldFNlbGVjdGlvbihlZGl0b3JuYW1lKTsKICAgICAgICBpZihzZWx0ZXh0LmluZGV4T2YoIlxuIikgIT09IC0xKXsKICAgICAgICAgICAgdGhpcy5tdWx0aWxpbmVGZW5jZShlZGl0b3JuYW1lLCJgYGAgIiArIHRoaXMuY29kZUxhbmd1YWdlICsgIlxuIiwiXG5gYGAiKTsKICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIHRoaXMuc2V0RmVuY2UoZWRpdG9ybmFtZSwiYCIsImAiKTsKICAgICAgICB9CiAgICB9CiAgICBwcmVmaXhSZWdpb24oZWRpdG9ybmFtZSxwcmVmaXgsaW5jcmVtZW50LHNwYWNlKXsKICAgICAgICB2YXIgc2VsdGV4dCA9IHRoaXMuZ2V0U2VsZWN0aW9uKGVkaXRvcm5hbWUpOwogICAgICAgIGlmKHNlbHRleHQuaW5kZXhPZigiXG4iKSA9PT0gLTEpewogICAgICAgICAgICB0aGlzLnNldExpbmVQcmVmaXgoZWRpdG9ybmFtZSxwcmVmaXggKyBzcGFjZSk7CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgICB0aGlzLnNldEJsb2NrUHJlZml4KGVkaXRvcm5hbWUscHJlZml4LGluY3JlbWVudCxzcGFjZSk7CiAgICAgICAgfQogICAgfQogICAgc2V0Q2VudGVyKGVkaXRvcm5hbWUpewogICAgICAgIHRoaXMucHJlZml4UmVnaW9uKGVkaXRvcm5hbWUsIi0+PC0iLGZhbHNlLCIgIik7CiAgICB9CiAgICBzZXRKdXN0aWZ5KGVkaXRvcm5hbWUpewogICAgICAgIHRoaXMucHJlZml4UmVnaW9uKGVkaXRvcm5hbWUsIjwtPiIsZmFsc2UsIiAiKTsKICAgIH0KICAgIHNldEFsaWduUmlnaHQoZWRpdG9ybmFtZSl7CiAgICAgICAgdGhpcy5wcmVmaXhSZWdpb24oZWRpdG9ybmFtZSwiLT4iLGZhbHNlLCIgIik7CiAgICB9CiAgICBzZXRBbGlnbkxlZnQoZWRpdG9ybmFtZSl7CiAgICAgICAgdGhpcy5wcmVmaXhSZWdpb24oZWRpdG9ybmFtZSwiPC0iLGZhbHNlLCIgIik7CiAgICB9CiAgICBzZXRDb21tZW50KGVkaXRvcm5hbWUpewogICAgICAgIHRoaXMucHJlZml4UmVnaW9uKGVkaXRvcm5hbWUsIjsiLGZhbHNlLCIgIik7CiAgICB9CiAgICBzZXRIZWFkaW5nKGhlYWRpbmdwcmVmaXgsIGVkaXRvcm5hbWUpewogICAgICAgIHRoaXMucHJlZml4UmVnaW9uKGVkaXRvcm5hbWUsaGVhZGluZ3ByZWZpeCxmYWxzZSwiICIpOwogICAgfQogICAgZmluZChlZGl0b3JuYW1lLHRleHQsd3JhcCxpZ25vcmVDYXNlKXsKICAgICAgbGV0IGVkaXRvciA9IGNtX2VkaXRvcnNbZWRpdG9ybmFtZV07CiAgICAgIGlmKGVkaXRvciA9PT0gdW5kZWZpbmVkKXsKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICB9CiAgICAgIGxldCB1c2VyQ3Vyc29yID0gZWRpdG9yLmdldEN1cnNvcigpOwogICAgICBsZXQgc2VhcmNoQ3Vyc29yID0gZWRpdG9yLmdldFNlYXJjaEN1cnNvcih0ZXh0LHtsaW5lOnVzZXJDdXJzb3IubGluZSxjaDp1c2VyQ3Vyc29yLmNofSx7Y2FzZUZvbGQ6aWdub3JlQ2FzZX0pOwogICAgICBpZihzZWFyY2hDdXJzb3IuZmluZE5leHQoKSA9PT0gdHJ1ZSl7CiAgICAgICAgIGVkaXRvci5zZXRTZWxlY3Rpb24oc2VhcmNoQ3Vyc29yLmZyb20oKSwgc2VhcmNoQ3Vyc29yLnRvKCkpOwogICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICBpZih3cmFwID09PSB0cnVlKXsKICAgICAgICBzZWFyY2hDdXJzb3IgPSBlZGl0b3IuZ2V0U2VhcmNoQ3Vyc29yKHRleHQse2xpbmU6MCxjaDowfSx7Y2FzZUZvbGQ6aWdub3JlQ2FzZX0pOwogICAgICAgIGlmKHNlYXJjaEN1cnNvci5maW5kTmV4dCgpID09PSB0cnVlKXsKICAgICAgICAgICBlZGl0b3Iuc2V0U2VsZWN0aW9uKHNlYXJjaEN1cnNvci5mcm9tKCksIHNlYXJjaEN1cnNvci50bygpKTsKICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGZhbHNlOwoKICAgIH0KICAgIHJlcGxhY2UoZWRpdG9ybmFtZSxyZXBsYWNlbWVudCl7CiAgICAgIGxldCBlZGl0b3IgPSBjbV9lZGl0b3JzW2VkaXRvcm5hbWVdOwogICAgICBpZihlZGl0b3IgPT09IHVuZGVmaW5lZCl7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQogICAgICBlZGl0b3IucmVwbGFjZVNlbGVjdGlvbihyZXBsYWNlbWVudCwiYXJvdW5kIik7CiAgICAgIHJldHVybiB0cnVlOwogIH0KICAgIHJlcGxhY2VBbGwoZWRpdG9ybmFtZSx0ZXh0LHJlcGxhY2VtZW50LGlnbm9yZUNhc2UpewogICAgICBsZXQgZWRpdG9yID0gY21fZWRpdG9yc1tlZGl0b3JuYW1lXTsKICAgICAgaWYoZWRpdG9yID09PSB1bmRlZmluZWQpewogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KICAgICAgbGV0IHVzZXJDdXJzb3IgPSBlZGl0b3IuZ2V0Q3Vyc29yKCk7CiAgICAgIGxldCBzZWFyY2hDdXJzb3IgPSBlZGl0b3IuZ2V0U2VhcmNoQ3Vyc29yKHRleHQse2xpbmU6MCxjaDowfSx7Y2FzZUZvbGQ6aWdub3JlQ2FzZX0pOwogICAgICB3aGlsZShzZWFyY2hDdXJzb3IuZmluZE5leHQoKSA9PT0gdHJ1ZSl7CiAgICAgICAgIGVkaXRvci5zZXRTZWxlY3Rpb24oc2VhcmNoQ3Vyc29yLmZyb20oKSwgc2VhcmNoQ3Vyc29yLnRvKCkpOwogICAgICAgICBlZGl0b3IucmVwbGFjZVNlbGVjdGlvbihyZXBsYWNlbWVudCwiYXJvdW5kIik7CiAgICAgIH0KCiAgICByZXR1cm4gdHJ1ZTsKICB9Cn0KCmxldCBlZGl0RHJpdmVyID0gbmV3IENNRWRpdG9yRHJpdmVyKCk7CgpCaXdhU2NoZW1lLmRlZmluZV9saWJmdW5jKCJjbS1lZGl0b3ItZmluZCIsNCw0LCBmdW5jdGlvbihhcil7CiAgcmV0dXJuIGVkaXREcml2ZXIuZmluZChhclswXSxhclsxXSxhclsyXSxhclszXSk7Cn0pOwpCaXdhU2NoZW1lLmRlZmluZV9saWJmdW5jKCJjbS1lZGl0b3ItcmVwbGFjZS1hbGwiLDQsNCwgZnVuY3Rpb24oYXIpewogIHJldHVybiBlZGl0RHJpdmVyLnJlcGxhY2VBbGwoYXJbMF0sYXJbMV0sYXJbMl0sYXJbM10pOwp9KTsKQml3YVNjaGVtZS5kZWZpbmVfbGliZnVuYygiY20tZWRpdG9yLXJlcGxhY2UiLDIsMiwgZnVuY3Rpb24oYXIpewogIHJldHVybiBlZGl0RHJpdmVyLnJlcGxhY2UoYXJbMF0sYXJbMV0pOwp9KTsKQml3YVNjaGVtZS5kZWZpbmVfbGliZnVuYygiY20tZWRpdG9yLXJlZnJlc2giLDEsMSwgZnVuY3Rpb24oYXIpewogIHNldFRpbWVvdXQoZnVuY3Rpb24oKXsKICAgIGFyWzBdLnJlZnJlc2goKQogIH0sMjApOwp9KTsKQml3YVNjaGVtZS5kZWZpbmVfbGliZnVuYygiY20tZWRpdG9yLWdldC10ZXh0IiwxLDEsIGZ1bmN0aW9uKGFyKXsKICBjb25zb2xlLmxvZygiRWRpdG9yIGlkOiAiICsgYXJbMF0pCiAgcmV0dXJuIGVkaXREcml2ZXIuZ2V0VGV4dChhclswXSk7Cn0pOwpCaXdhU2NoZW1lLmRlZmluZV9saWJmdW5jKCJjbS1lZGl0b3Itc2V0LXRleHQiLDIsMiwgZnVuY3Rpb24oYXIpewoKICByZXR1cm4gZWRpdERyaXZlci5zZXRUZXh0KGFyWzBdLGFyWzFdKTsKfSk7CkJpd2FTY2hlbWUuZGVmaW5lX2xpYmZ1bmMoImNtLWVkaXRvci1nZXQtc2VsZWN0ZWQtdGV4dCIsMSwxLCBmdW5jdGlvbihhcil7CiAgcmV0dXJuIGVkaXREcml2ZXIuZ2V0U2VsZWN0aW9uKGFyWzBdKTsKfSk7CkJpd2FTY2hlbWUuZGVmaW5lX2xpYmZ1bmMoImNtLWVkaXRvci1kZWxldGUtc2VsZWN0ZWQtdGV4dCIsMSwxLCBmdW5jdGlvbihhcil7CiAgcmV0dXJuIGVkaXREcml2ZXIucmVwbGFjZVNlbGVjdGVkVGV4dChhclswXSwiIik7Cn0pOwpCaXdhU2NoZW1lLmRlZmluZV9saWJmdW5jKCJjbS1lZGl0b3Itc2V0LWJvbGQiLDEsMSwgZnVuY3Rpb24oYXIpewogIGVkaXREcml2ZXIuc2V0Qm9sZChhclswXSk7Cn0pOwpCaXdhU2NoZW1lLmRlZmluZV9saWJmdW5jKCJjbS1lZGl0b3Itc2V0LWN1cnNvci1wb3NpdGlvbiIsMywzLCBmdW5jdGlvbihhcil7CiAgZWRpdERyaXZlci5zZXRDdXJzb3JQb3NpdGlvbihhclswXSxhclsxXSxhclsyXSk7Cn0pOwpCaXdhU2NoZW1lLmRlZmluZV9saWJmdW5jKCJjbS1lZGl0b3Itc2Nyb2xsLXRvLWxpbmUiLDIsMiwgZnVuY3Rpb24oYXIpewogIGVkaXREcml2ZXIuc2Nyb2xsVG9MaW5lKGFyWzBdLGFyWzFdKTsKfSk7CkJpd2FTY2hlbWUuZGVmaW5lX2xpYmZ1bmMoImNtLWVkaXRvci1zZXQtaXRhbGljIiwxLDEsIGZ1bmN0aW9uKGFyKXsKICBlZGl0RHJpdmVyLnNldEl0YWxpYyhhclswXSk7Cn0pOwpCaXdhU2NoZW1lLmRlZmluZV9saWJmdW5jKCJjbS1lZGl0b3Itc2V0LXN1cGVyc2NyaXB0IiwxLDEsIGZ1bmN0aW9uKGFyKXsKICBlZGl0RHJpdmVyLnNldFN1cGVyc2NyaXB0KGFyWzBdKTsKfSk7CkJpd2FTY2hlbWUuZGVmaW5lX2xpYmZ1bmMoImNtLWVkaXRvci1zZXQtc3Vic2NyaXB0IiwxLDEsIGZ1bmN0aW9uKGFyKXsKICBlZGl0RHJpdmVyLnNldFN1YnNjcmlwdChhclswXSk7Cn0pOwpCaXdhU2NoZW1lLmRlZmluZV9saWJmdW5jKCJjbS1lZGl0b3Itc2V0LXN0cmlrZW91dCIsMSwxLCBmdW5jdGlvbihhcil7CiAgZWRpdERyaXZlci5zZXRTdHJpa2VvdXQoYXJbMF0pOwp9KTsKQml3YVNjaGVtZS5kZWZpbmVfbGliZnVuYygiY20tZWRpdG9yLXNldC1idWxsZXRlZC1saXN0IiwxLDEsIGZ1bmN0aW9uKGFyKXsKICBlZGl0RHJpdmVyLnNldEJ1bGxldGVkTGlzdChhclswXSk7Cn0pOwpCaXdhU2NoZW1lLmRlZmluZV9saWJmdW5jKCJjbS1lZGl0b3Itc2V0LW51bWJlcmVkLWxpc3QiLDEsMSwgZnVuY3Rpb24oYXIpewogIGVkaXREcml2ZXIuc2V0TnVtYmVyZWRMaXN0KGFyWzBdKTsKfSk7CkJpd2FTY2hlbWUuZGVmaW5lX2xpYmZ1bmMoImNtLWVkaXRvci1zZXQtYmxvY2stcXVvdGUiLDEsMSwgZnVuY3Rpb24oYXIpewogIGVkaXREcml2ZXIuc2V0QmxvY2tRdW90ZShhclswXSk7Cn0pOwpCaXdhU2NoZW1lLmRlZmluZV9saWJmdW5jKCJjbS1lZGl0b3Itc2V0LXBvZXRyeSIsMSwxLCBmdW5jdGlvbihhcil7CiAgZWRpdERyaXZlci5zZXRQb2V0cnkoYXJbMF0pOwp9KTsKQml3YVNjaGVtZS5kZWZpbmVfbGliZnVuYygiY20tZWRpdG9yLXNldC1jb2RlIiwxLDEsIGZ1bmN0aW9uKGFyKXsKICBlZGl0RHJpdmVyLnNldENvZGUoYXJbMF0pOwp9KTsKQml3YVNjaGVtZS5kZWZpbmVfbGliZnVuYygiY20tZWRpdG9yLXNldC1jZW50ZXIiLDEsMSwgZnVuY3Rpb24oYXIpewogIGVkaXREcml2ZXIuc2V0Q2VudGVyKGFyWzBdKTsKfSk7CkJpd2FTY2hlbWUuZGVmaW5lX2xpYmZ1bmMoImNtLWVkaXRvci1zZXQtanVzdGlmeSIsMSwxLCBmdW5jdGlvbihhcil7CiAgZWRpdERyaXZlci5zZXRKdXN0aWZ5KGFyWzBdKTsKfSk7CkJpd2FTY2hlbWUuZGVmaW5lX2xpYmZ1bmMoImNtLWVkaXRvci1zZXQtYWxpZ24tbGVmdCIsMSwxLCBmdW5jdGlvbihhcil7CiAgZWRpdERyaXZlci5zZXRBbGlnbkxlZnQoYXJbMF0pOwp9KTsKQml3YVNjaGVtZS5kZWZpbmVfbGliZnVuYygiY20tZWRpdG9yLXNldC1hbGlnbi1yaWdodCIsMSwxLCBmdW5jdGlvbihhcil7CiAgZWRpdERyaXZlci5zZXRBbGlnblJpZ2h0KGFyWzBdKTsKfSk7CkJpd2FTY2hlbWUuZGVmaW5lX2xpYmZ1bmMoImNtLWVkaXRvci1zZXQtY29tbWVudCIsMSwxLCBmdW5jdGlvbihhcil7CiAgZWRpdERyaXZlci5zZXRDb21tZW50KGFyWzBdKTsKfSk7CgpCaXdhU2NoZW1lLmRlZmluZV9saWJmdW5jKCJjbS1lZGl0b3Itc2V0LW5vdGUiLDEsMSwgZnVuY3Rpb24oYXIpewogIGVkaXREcml2ZXIuc2V0Tm90ZShhclswXSk7Cn0pOwpCaXdhU2NoZW1lLmRlZmluZV9saWJmdW5jKCJjbS1lZGl0b3Itc2V0LWhlYWRpbmciLDIsMiwgZnVuY3Rpb24oYXIpewogIGVkaXREcml2ZXIuc2V0SGVhZGluZyhhclswXSxhclsxXSk7Cn0pOwoKQml3YVNjaGVtZS5kZWZpbmVfbGliZnVuYygiY20tZWRpdG9yLXNldC1tYXRoIiwxLDEsIGZ1bmN0aW9uKGFyKXsKICBlZGl0RHJpdmVyLnNldE1hdGgoYXJbMF0pOwp9KTsKCkJpd2FTY2hlbWUuZGVmaW5lX2xpYmZ1bmMoInBhdGNoLXBvZXRyeSIsMSwxLCBmdW5jdGlvbihhcil7CiAgcmV0dXJuIGFyWzBdLnJlcGxhY2UoL15cfCAoLiopXG4vZ20sZnVuY3Rpb24obWF0Y2gsY2FwdHVyZSkgeyByZXR1cm4gY2FwdHVyZS5yZXBsYWNlKC8gL2csICImbmJzcDsiKSArICIgIFxuIiB9KTsKfSk7CgoKQ29kZU1pcnJvci5jb21tYW5kcy5maW5kID0gZnVuY3Rpb24oKXsKICBzY2hlbWVfaW50ZXJwcmV0ZXIuZXZhbHVhdGUoIiglIFwiI2NvZGUtZWRpdG9yLWZpbmQtZmllbGRcIiBcImZvY3VzXCIpIikKfQo=","codemirror/markdown.js":"Ly8gQ29kZU1pcnJvciwgY29weXJpZ2h0IChjKSBieSBNYXJpam4gSGF2ZXJiZWtlIGFuZCBvdGhlcnMKLy8gRGlzdHJpYnV0ZWQgdW5kZXIgYW4gTUlUIGxpY2Vuc2U6IGh0dHBzOi8vY29kZW1pcnJvci5uZXQvTElDRU5TRQoKKGZ1bmN0aW9uKG1vZCkgewogIGlmICh0eXBlb2YgZXhwb3J0cyA9PSAib2JqZWN0IiAmJiB0eXBlb2YgbW9kdWxlID09ICJvYmplY3QiKSAvLyBDb21tb25KUwogICAgbW9kKHJlcXVpcmUoIi4uLy4uL2xpYi9jb2RlbWlycm9yIiksIHJlcXVpcmUoIi4uL3htbC94bWwiKSwgcmVxdWlyZSgiLi4vbWV0YSIpKTsKICBlbHNlIGlmICh0eXBlb2YgZGVmaW5lID09ICJmdW5jdGlvbiIgJiYgZGVmaW5lLmFtZCkgLy8gQU1ECiAgICBkZWZpbmUoWyIuLi8uLi9saWIvY29kZW1pcnJvciIsICIuLi94bWwveG1sIiwgIi4uL21ldGEiXSwgbW9kKTsKICBlbHNlIC8vIFBsYWluIGJyb3dzZXIgZW52CiAgICBtb2QoQ29kZU1pcnJvcik7Cn0pKGZ1bmN0aW9uKENvZGVNaXJyb3IpIHsKInVzZSBzdHJpY3QiOwoKQ29kZU1pcnJvci5kZWZpbmVNb2RlKCJtYXJrZG93biIsIGZ1bmN0aW9uKGNtQ2ZnLCBtb2RlQ2ZnKSB7CgogIHZhciBodG1sTW9kZSA9IENvZGVNaXJyb3IuZ2V0TW9kZShjbUNmZywgInRleHQvaHRtbCIpOwogIHZhciBodG1sTW9kZU1pc3NpbmcgPSBodG1sTW9kZS5uYW1lID09ICJudWxsIgoKICBmdW5jdGlvbiBnZXRNb2RlKG5hbWUpIHsKICAgIGlmIChDb2RlTWlycm9yLmZpbmRNb2RlQnlOYW1lKSB7CiAgICAgIHZhciBmb3VuZCA9IENvZGVNaXJyb3IuZmluZE1vZGVCeU5hbWUobmFtZSk7CiAgICAgIGlmIChmb3VuZCkgbmFtZSA9IGZvdW5kLm1pbWUgfHwgZm91bmQubWltZXNbMF07CiAgICB9CiAgICB2YXIgbW9kZSA9IENvZGVNaXJyb3IuZ2V0TW9kZShjbUNmZywgbmFtZSk7CiAgICByZXR1cm4gbW9kZS5uYW1lID09ICJudWxsIiA/IG51bGwgOiBtb2RlOwogIH0KCiAgLy8gU2hvdWxkIGNoYXJhY3RlcnMgdGhhdCBhZmZlY3QgaGlnaGxpZ2h0aW5nIGJlIGhpZ2hsaWdodGVkIHNlcGFyYXRlPwogIC8vIERvZXMgbm90IGluY2x1ZGUgY2hhcmFjdGVycyB0aGF0IHdpbGwgYmUgb3V0cHV0IChzdWNoIGFzIGAxLmAgYW5kIGAtYCBmb3IgbGlzdHMpCiAgaWYgKG1vZGVDZmcuaGlnaGxpZ2h0Rm9ybWF0dGluZyA9PT0gdW5kZWZpbmVkKQogICAgbW9kZUNmZy5oaWdobGlnaHRGb3JtYXR0aW5nID0gZmFsc2U7CgogIC8vIE1heGltdW0gbnVtYmVyIG9mIG5lc3RlZCBibG9ja3F1b3Rlcy4gU2V0IHRvIDAgZm9yIGluZmluaXRlIG5lc3RpbmcuCiAgLy8gRXhjZXNzIGA+YCB3aWxsIGVtaXQgYGVycm9yYCB0b2tlbi4KICBpZiAobW9kZUNmZy5tYXhCbG9ja3F1b3RlRGVwdGggPT09IHVuZGVmaW5lZCkKICAgIG1vZGVDZmcubWF4QmxvY2txdW90ZURlcHRoID0gMDsKCiAgLy8gVHVybiBvbiB0YXNrIGxpc3RzPyAoIi0gWyBdICIgYW5kICItIFt4XSAiKQogIGlmIChtb2RlQ2ZnLnRhc2tMaXN0cyA9PT0gdW5kZWZpbmVkKSBtb2RlQ2ZnLnRhc2tMaXN0cyA9IGZhbHNlOwoKICAvLyBUdXJuIG9uIHN0cmlrZXRocm91Z2ggc3ludGF4CiAgaWYgKG1vZGVDZmcuc3RyaWtldGhyb3VnaCA9PT0gdW5kZWZpbmVkKQogICAgbW9kZUNmZy5zdHJpa2V0aHJvdWdoID0gZmFsc2U7CgogIGlmIChtb2RlQ2ZnLmVtb2ppID09PSB1bmRlZmluZWQpCiAgICBtb2RlQ2ZnLmVtb2ppID0gZmFsc2U7CgogIGlmIChtb2RlQ2ZnLmZlbmNlZENvZGVCbG9ja0hpZ2hsaWdodGluZyA9PT0gdW5kZWZpbmVkKQogICAgbW9kZUNmZy5mZW5jZWRDb2RlQmxvY2tIaWdobGlnaHRpbmcgPSB0cnVlOwoKICBpZiAobW9kZUNmZy54bWwgPT09IHVuZGVmaW5lZCkKICAgIG1vZGVDZmcueG1sID0gdHJ1ZTsKCiAgLy8gQWxsb3cgdG9rZW4gdHlwZXMgdG8gYmUgb3ZlcnJpZGRlbiBieSB1c2VyLXByb3ZpZGVkIHRva2VuIHR5cGVzLgogIGlmIChtb2RlQ2ZnLnRva2VuVHlwZU92ZXJyaWRlcyA9PT0gdW5kZWZpbmVkKQogICAgbW9kZUNmZy50b2tlblR5cGVPdmVycmlkZXMgPSB7fTsKCiAgdmFyIHRva2VuVHlwZXMgPSB7CiAgICBoZWFkZXI6ICJoZWFkZXIiLAogICAgY29kZTogImNvbW1lbnQiLAogICAgcXVvdGU6ICJxdW90ZSIsCiAgICBsaXN0MTogInZhcmlhYmxlLTIiLAogICAgbGlzdDI6ICJ2YXJpYWJsZS0zIiwKICAgIGxpc3QzOiAia2V5d29yZCIsCiAgICBocjogImhyIiwKICAgIGltYWdlOiAiaW1hZ2UiLAogICAgaW1hZ2VBbHRUZXh0OiAiaW1hZ2UtYWx0LXRleHQiLAogICAgaW1hZ2VNYXJrZXI6ICJpbWFnZS1tYXJrZXIiLAogICAgZm9ybWF0dGluZzogImZvcm1hdHRpbmciLAogICAgbGlua0lubGluZTogImxpbmsiLAogICAgbGlua0VtYWlsOiAibGluayIsCiAgICBsaW5rVGV4dDogImxpbmsiLAogICAgbGlua0hyZWY6ICJzdHJpbmciLAogICAgZW06ICJlbSIsCiAgICBzdHJvbmc6ICJzdHJvbmciLAogICAgc3RyaWtldGhyb3VnaDogInN0cmlrZXRocm91Z2giLAogICAgZW1vamk6ICJidWlsdGluIgogIH07CgogIGZvciAodmFyIHRva2VuVHlwZSBpbiB0b2tlblR5cGVzKSB7CiAgICBpZiAodG9rZW5UeXBlcy5oYXNPd25Qcm9wZXJ0eSh0b2tlblR5cGUpICYmIG1vZGVDZmcudG9rZW5UeXBlT3ZlcnJpZGVzW3Rva2VuVHlwZV0pIHsKICAgICAgdG9rZW5UeXBlc1t0b2tlblR5cGVdID0gbW9kZUNmZy50b2tlblR5cGVPdmVycmlkZXNbdG9rZW5UeXBlXTsKICAgIH0KICB9CgogIHZhciBoclJFID0gL14oWypcLV9dKSg/OlxzKlwxKXsyLH1ccyokLwogICwgICBsaXN0UkUgPSAvXig/OlsqXC0rXXxeWzAtOV0rKFsuKV0pKVxzKy8KICAsICAgdGFza0xpc3RSRSA9IC9eXFsoeHwgKVxdKD89XHMpL2kgLy8gTXVzdCBmb2xsb3cgbGlzdFJFCiAgLCAgIGF0eEhlYWRlclJFID0gbW9kZUNmZy5hbGxvd0F0eEhlYWRlcldpdGhvdXRTcGFjZSA/IC9eKCMrKS8gOiAvXigjKykoPzogfCQpLwogICwgICBzZXRleHRIZWFkZXJSRSA9IC9eICooPzpcPXsxLH18LXsxLH0pXHMqJC8KICAsICAgdGV4dFJFID0gL15bXiMhXFtcXSpfXFw8PmAgIicofjpdKy8KICAsICAgZmVuY2VkQ29kZVJFID0gL14ofn5+K3xgYGArKVsgXHRdKihbXHcrIy1dKilbXlxuYF0qJC8KICAsICAgbGlua0RlZlJFID0gL15ccypcW1teXF1dKz9cXTouKiQvIC8vIG5haXZlIGxpbmstZGVmaW5pdGlvbgogICwgICBwdW5jdHVhdGlvbiA9IC9bISIjJCUmJygpKissXC0uXC86Ozw9Pj9AXFtcXFxdXl9ge3x9flx4QTFceEE3XHhBQlx4QjZceEI3XHhCQlx4QkZcdTAzN0VcdTAzODdcdTA1NUEtXHUwNTVGXHUwNTg5XHUwNThBXHUwNUJFXHUwNUMwXHUwNUMzXHUwNUM2XHUwNUYzXHUwNUY0XHUwNjA5XHUwNjBBXHUwNjBDXHUwNjBEXHUwNjFCXHUwNjFFXHUwNjFGXHUwNjZBLVx1MDY2RFx1MDZENFx1MDcwMC1cdTA3MERcdTA3RjctXHUwN0Y5XHUwODMwLVx1MDgzRVx1MDg1RVx1MDk2NFx1MDk2NVx1MDk3MFx1MEFGMFx1MERGNFx1MEU0Rlx1MEU1QVx1MEU1Qlx1MEYwNC1cdTBGMTJcdTBGMTRcdTBGM0EtXHUwRjNEXHUwRjg1XHUwRkQwLVx1MEZENFx1MEZEOVx1MEZEQVx1MTA0QS1cdTEwNEZcdTEwRkJcdTEzNjAtXHUxMzY4XHUxNDAwXHUxNjZEXHUxNjZFXHUxNjlCXHUxNjlDXHUxNkVCLVx1MTZFRFx1MTczNVx1MTczNlx1MTdENC1cdTE3RDZcdTE3RDgtXHUxN0RBXHUxODAwLVx1MTgwQVx1MTk0NFx1MTk0NVx1MUExRVx1MUExRlx1MUFBMC1cdTFBQTZcdTFBQTgtXHUxQUFEXHUxQjVBLVx1MUI2MFx1MUJGQy1cdTFCRkZcdTFDM0ItXHUxQzNGXHUxQzdFXHUxQzdGXHUxQ0MwLVx1MUNDN1x1MUNEM1x1MjAxMC1cdTIwMjdcdTIwMzAtXHUyMDQzXHUyMDQ1LVx1MjA1MVx1MjA1My1cdTIwNUVcdTIwN0RcdTIwN0VcdTIwOERcdTIwOEVcdTIzMDgtXHUyMzBCXHUyMzI5XHUyMzJBXHUyNzY4LVx1Mjc3NVx1MjdDNVx1MjdDNlx1MjdFNi1cdTI3RUZcdTI5ODMtXHUyOTk4XHUyOUQ4LVx1MjlEQlx1MjlGQ1x1MjlGRFx1MkNGOS1cdTJDRkNcdTJDRkVcdTJDRkZcdTJENzBcdTJFMDAtXHUyRTJFXHUyRTMwLVx1MkU0Mlx1MzAwMS1cdTMwMDNcdTMwMDgtXHUzMDExXHUzMDE0LVx1MzAxRlx1MzAzMFx1MzAzRFx1MzBBMFx1MzBGQlx1QTRGRVx1QTRGRlx1QTYwRC1cdUE2MEZcdUE2NzNcdUE2N0VcdUE2RjItXHVBNkY3XHVBODc0LVx1QTg3N1x1QThDRVx1QThDRlx1QThGOC1cdUE4RkFcdUE4RkNcdUE5MkVcdUE5MkZcdUE5NUZcdUE5QzEtXHVBOUNEXHVBOURFXHVBOURGXHVBQTVDLVx1QUE1Rlx1QUFERVx1QUFERlx1QUFGMFx1QUFGMVx1QUJFQlx1RkQzRVx1RkQzRlx1RkUxMC1cdUZFMTlcdUZFMzAtXHVGRTUyXHVGRTU0LVx1RkU2MVx1RkU2M1x1RkU2OFx1RkU2QVx1RkU2Qlx1RkYwMS1cdUZGMDNcdUZGMDUtXHVGRjBBXHVGRjBDLVx1RkYwRlx1RkYxQVx1RkYxQlx1RkYxRlx1RkYyMFx1RkYzQi1cdUZGM0RcdUZGM0ZcdUZGNUJcdUZGNURcdUZGNUYtXHVGRjY1XXxcdUQ4MDBbXHVERDAwLVx1REQwMlx1REY5Rlx1REZEMF18XHVEODAxXHVERDZGfFx1RDgwMltcdURDNTdcdUREMUZcdUREM0ZcdURFNTAtXHVERTU4XHVERTdGXHVERUYwLVx1REVGNlx1REYzOS1cdURGM0ZcdURGOTktXHVERjlDXXxcdUQ4MDRbXHVEQzQ3LVx1REM0RFx1RENCQlx1RENCQ1x1RENCRS1cdURDQzFcdURENDAtXHVERDQzXHVERDc0XHVERDc1XHVEREM1LVx1RERDOVx1RERDRFx1REREQlx1RERERC1cdUREREZcdURFMzgtXHVERTNEXHVERUE5XXxcdUQ4MDVbXHVEQ0M2XHVEREMxLVx1REREN1x1REU0MS1cdURFNDNcdURGM0MtXHVERjNFXXxcdUQ4MDlbXHVEQzcwLVx1REM3NF18XHVEODFBW1x1REU2RVx1REU2Rlx1REVGNVx1REYzNy1cdURGM0JcdURGNDRdfFx1RDgyRlx1REM5RnxcdUQ4MzZbXHVERTg3LVx1REU4Ql0vCiAgLCAgIGV4cGFuZGVkVGFiID0gIiAgICAiIC8vIENvbW1vbk1hcmsgc3BlY2lmaWVzIHRhYiBhcyA0IHNwYWNlcwoKICBmdW5jdGlvbiBzd2l0Y2hJbmxpbmUoc3RyZWFtLCBzdGF0ZSwgZikgewogICAgc3RhdGUuZiA9IHN0YXRlLmlubGluZSA9IGY7CiAgICByZXR1cm4gZihzdHJlYW0sIHN0YXRlKTsKICB9CgogIGZ1bmN0aW9uIHN3aXRjaEJsb2NrKHN0cmVhbSwgc3RhdGUsIGYpIHsKICAgIHN0YXRlLmYgPSBzdGF0ZS5ibG9jayA9IGY7CiAgICByZXR1cm4gZihzdHJlYW0sIHN0YXRlKTsKICB9CgogIGZ1bmN0aW9uIGxpbmVJc0VtcHR5KGxpbmUpIHsKICAgIHJldHVybiAhbGluZSB8fCAhL1xTLy50ZXN0KGxpbmUuc3RyaW5nKQogIH0KCiAgLy8gQmxvY2tzCgogIGZ1bmN0aW9uIGJsYW5rTGluZShzdGF0ZSkgewogICAgLy8gUmVzZXQgbGlua1RpdGxlIHN0YXRlCiAgICBzdGF0ZS5saW5rVGl0bGUgPSBmYWxzZTsKICAgIHN0YXRlLmxpbmtIcmVmID0gZmFsc2U7CiAgICBzdGF0ZS5saW5rVGV4dCA9IGZhbHNlOwogICAgLy8gUmVzZXQgRU0gc3RhdGUKICAgIHN0YXRlLmVtID0gZmFsc2U7CiAgICAvLyBSZXNldCBTVFJPTkcgc3RhdGUKICAgIHN0YXRlLnN0cm9uZyA9IGZhbHNlOwogICAgLy8gUmVzZXQgc3RyaWtldGhyb3VnaCBzdGF0ZQogICAgc3RhdGUuc3RyaWtldGhyb3VnaCA9IGZhbHNlOwogICAgLy8gUmVzZXQgc3RhdGUucXVvdGUKICAgIHN0YXRlLnF1b3RlID0gMDsKICAgIC8vIFJlc2V0IHN0YXRlLmluZGVudGVkQ29kZQogICAgc3RhdGUuaW5kZW50ZWRDb2RlID0gZmFsc2U7CiAgICBpZiAoc3RhdGUuZiA9PSBodG1sQmxvY2spIHsKICAgICAgdmFyIGV4aXQgPSBodG1sTW9kZU1pc3NpbmcKICAgICAgaWYgKCFleGl0KSB7CiAgICAgICAgdmFyIGlubmVyID0gQ29kZU1pcnJvci5pbm5lck1vZGUoaHRtbE1vZGUsIHN0YXRlLmh0bWxTdGF0ZSkKICAgICAgICBleGl0ID0gaW5uZXIubW9kZS5uYW1lID09ICJ4bWwiICYmIGlubmVyLnN0YXRlLnRhZ1N0YXJ0ID09PSBudWxsICYmCiAgICAgICAgICAoIWlubmVyLnN0YXRlLmNvbnRleHQgJiYgaW5uZXIuc3RhdGUudG9rZW5pemUuaXNJblRleHQpCiAgICAgIH0KICAgICAgaWYgKGV4aXQpIHsKICAgICAgICBzdGF0ZS5mID0gaW5saW5lTm9ybWFsOwogICAgICAgIHN0YXRlLmJsb2NrID0gYmxvY2tOb3JtYWw7CiAgICAgICAgc3RhdGUuaHRtbFN0YXRlID0gbnVsbDsKICAgICAgfQogICAgfQogICAgLy8gUmVzZXQgc3RhdGUudHJhaWxpbmdTcGFjZQogICAgc3RhdGUudHJhaWxpbmdTcGFjZSA9IDA7CiAgICBzdGF0ZS50cmFpbGluZ1NwYWNlTmV3TGluZSA9IGZhbHNlOwogICAgLy8gTWFyayB0aGlzIGxpbmUgYXMgYmxhbmsKICAgIHN0YXRlLnByZXZMaW5lID0gc3RhdGUudGhpc0xpbmUKICAgIHN0YXRlLnRoaXNMaW5lID0ge3N0cmVhbTogbnVsbH0KICAgIHJldHVybiBudWxsOwogIH0KCiAgZnVuY3Rpb24gYmxvY2tOb3JtYWwoc3RyZWFtLCBzdGF0ZSkgewogICAgdmFyIGZpcnN0VG9rZW5PbkxpbmUgPSBzdHJlYW0uY29sdW1uKCkgPT09IHN0YXRlLmluZGVudGF0aW9uOwogICAgdmFyIHByZXZMaW5lTGluZUlzRW1wdHkgPSBsaW5lSXNFbXB0eShzdGF0ZS5wcmV2TGluZS5zdHJlYW0pOwogICAgdmFyIHByZXZMaW5lSXNJbmRlbnRlZENvZGUgPSBzdGF0ZS5pbmRlbnRlZENvZGU7CiAgICB2YXIgcHJldkxpbmVJc0hyID0gc3RhdGUucHJldkxpbmUuaHI7CiAgICB2YXIgcHJldkxpbmVJc0xpc3QgPSBzdGF0ZS5saXN0ICE9PSBmYWxzZTsKICAgIHZhciBtYXhOb25Db2RlSW5kZW50YXRpb24gPSAoc3RhdGUubGlzdFN0YWNrW3N0YXRlLmxpc3RTdGFjay5sZW5ndGggLSAxXSB8fCAwKSArIDM7CgogICAgc3RhdGUuaW5kZW50ZWRDb2RlID0gZmFsc2U7CgogICAgdmFyIGxpbmVJbmRlbnRhdGlvbiA9IHN0YXRlLmluZGVudGF0aW9uOwogICAgLy8gY29tcHV0ZSBvbmNlIHBlciBsaW5lIChvbiBmaXJzdCB0b2tlbikKICAgIGlmIChzdGF0ZS5pbmRlbnRhdGlvbkRpZmYgPT09IG51bGwpIHsKICAgICAgc3RhdGUuaW5kZW50YXRpb25EaWZmID0gc3RhdGUuaW5kZW50YXRpb247CiAgICAgIGlmIChwcmV2TGluZUlzTGlzdCkgewogICAgICAgIC8vIFJlc2V0IGlubGluZSBzdHlsZXMgd2hpY2ggc2hvdWxkbid0IHByb3BhZ2F0ZSBhcm9zcyBsaXN0IGl0ZW1zCiAgICAgICAgc3RhdGUuZW0gPSBmYWxzZTsKICAgICAgICBzdGF0ZS5zdHJvbmcgPSBmYWxzZTsKICAgICAgICBzdGF0ZS5jb2RlID0gZmFsc2U7CiAgICAgICAgc3RhdGUuc3RyaWtldGhyb3VnaCA9IGZhbHNlOwoKICAgICAgICBzdGF0ZS5saXN0ID0gbnVsbDsKICAgICAgICAvLyBXaGlsZSB0aGlzIGxpc3QgaXRlbSdzIG1hcmtlcidzIGluZGVudGF0aW9uIGlzIGxlc3MgdGhhbiB0aGUgZGVlcGVzdAogICAgICAgIC8vICBsaXN0IGl0ZW0ncyBjb250ZW50J3MgaW5kZW50YXRpb24scG9wIHRoZSBkZWVwZXN0IGxpc3QgaXRlbQogICAgICAgIC8vICBpbmRlbnRhdGlvbiBvZmYgdGhlIHN0YWNrLCBhbmQgdXBkYXRlIGJsb2NrIGluZGVudGF0aW9uIHN0YXRlCiAgICAgICAgd2hpbGUgKGxpbmVJbmRlbnRhdGlvbiA8IHN0YXRlLmxpc3RTdGFja1tzdGF0ZS5saXN0U3RhY2subGVuZ3RoIC0gMV0pIHsKICAgICAgICAgIHN0YXRlLmxpc3RTdGFjay5wb3AoKTsKICAgICAgICAgIGlmIChzdGF0ZS5saXN0U3RhY2subGVuZ3RoKSB7CiAgICAgICAgICAgIHN0YXRlLmluZGVudGF0aW9uID0gc3RhdGUubGlzdFN0YWNrW3N0YXRlLmxpc3RTdGFjay5sZW5ndGggLSAxXTsKICAgICAgICAgIC8vIGxlc3MgdGhhbiB0aGUgZmlyc3QgbGlzdCdzIGluZGVudCAtPiB0aGUgbGluZSBpcyBubyBsb25nZXIgYSBsaXN0CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzdGF0ZS5saXN0ID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChzdGF0ZS5saXN0ICE9PSBmYWxzZSkgewogICAgICAgICAgc3RhdGUuaW5kZW50YXRpb25EaWZmID0gbGluZUluZGVudGF0aW9uIC0gc3RhdGUubGlzdFN0YWNrW3N0YXRlLmxpc3RTdGFjay5sZW5ndGggLSAxXQogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIC8vIG5vdCBjb21wcmVoZW5zaXZlIChjdXJyZW50bHkgb25seSBmb3Igc2V0ZXh0IGRldGVjdGlvbiBwdXJwb3NlcykKICAgIHZhciBhbGxvd3NJbmxpbmVDb250aW51YXRpb24gPSAoCiAgICAgICAgIXByZXZMaW5lTGluZUlzRW1wdHkgJiYgIXByZXZMaW5lSXNIciAmJiAhc3RhdGUucHJldkxpbmUuaGVhZGVyICYmCiAgICAgICAgKCFwcmV2TGluZUlzTGlzdCB8fCAhcHJldkxpbmVJc0luZGVudGVkQ29kZSkgJiYKICAgICAgICAhc3RhdGUucHJldkxpbmUuZmVuY2VkQ29kZUVuZAogICAgKTsKCiAgICB2YXIgaXNIciA9IChzdGF0ZS5saXN0ID09PSBmYWxzZSB8fCBwcmV2TGluZUlzSHIgfHwgcHJldkxpbmVMaW5lSXNFbXB0eSkgJiYKICAgICAgc3RhdGUuaW5kZW50YXRpb24gPD0gbWF4Tm9uQ29kZUluZGVudGF0aW9uICYmIHN0cmVhbS5tYXRjaChoclJFKTsKCiAgICB2YXIgbWF0Y2ggPSBudWxsOwogICAgaWYgKHN0YXRlLmluZGVudGF0aW9uRGlmZiA+PSA0ICYmIChwcmV2TGluZUlzSW5kZW50ZWRDb2RlIHx8IHN0YXRlLnByZXZMaW5lLmZlbmNlZENvZGVFbmQgfHwKICAgICAgICAgc3RhdGUucHJldkxpbmUuaGVhZGVyIHx8IHByZXZMaW5lTGluZUlzRW1wdHkpKSB7CiAgICAgIHN0cmVhbS5za2lwVG9FbmQoKTsKICAgICAgc3RhdGUuaW5kZW50ZWRDb2RlID0gdHJ1ZTsKICAgICAgcmV0dXJuIHRva2VuVHlwZXMuY29kZTsKICAgIH0gZWxzZSBpZiAoc3RyZWFtLmVhdFNwYWNlKCkpIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9IGVsc2UgaWYgKGZpcnN0VG9rZW5PbkxpbmUgJiYgc3RhdGUuaW5kZW50YXRpb24gPD0gbWF4Tm9uQ29kZUluZGVudGF0aW9uICYmIChtYXRjaCA9IHN0cmVhbS5tYXRjaChhdHhIZWFkZXJSRSkpICYmIG1hdGNoWzFdLmxlbmd0aCA8PSA2KSB7CiAgICAgIHN0YXRlLnF1b3RlID0gMDsKICAgICAgc3RhdGUuaGVhZGVyID0gbWF0Y2hbMV0ubGVuZ3RoOwogICAgICBzdGF0ZS50aGlzTGluZS5oZWFkZXIgPSB0cnVlOwogICAgICBpZiAobW9kZUNmZy5oaWdobGlnaHRGb3JtYXR0aW5nKSBzdGF0ZS5mb3JtYXR0aW5nID0gImhlYWRlciI7CiAgICAgIHN0YXRlLmYgPSBzdGF0ZS5pbmxpbmU7CiAgICAgIHJldHVybiBnZXRUeXBlKHN0YXRlKTsKICAgIH0gZWxzZSBpZiAoc3RhdGUuaW5kZW50YXRpb24gPD0gbWF4Tm9uQ29kZUluZGVudGF0aW9uICYmIHN0cmVhbS5lYXQoJz4nKSkgewogICAgICBzdGF0ZS5xdW90ZSA9IGZpcnN0VG9rZW5PbkxpbmUgPyAxIDogc3RhdGUucXVvdGUgKyAxOwogICAgICBpZiAobW9kZUNmZy5oaWdobGlnaHRGb3JtYXR0aW5nKSBzdGF0ZS5mb3JtYXR0aW5nID0gInF1b3RlIjsKICAgICAgc3RyZWFtLmVhdFNwYWNlKCk7CiAgICAgIHJldHVybiBnZXRUeXBlKHN0YXRlKTsKICAgIH0gZWxzZSBpZiAoIWlzSHIgJiYgIXN0YXRlLnNldGV4dCAmJiBmaXJzdFRva2VuT25MaW5lICYmIHN0YXRlLmluZGVudGF0aW9uIDw9IG1heE5vbkNvZGVJbmRlbnRhdGlvbiAmJiAobWF0Y2ggPSBzdHJlYW0ubWF0Y2gobGlzdFJFKSkpIHsKICAgICAgdmFyIGxpc3RUeXBlID0gbWF0Y2hbMV0gPyAib2wiIDogInVsIjsKCiAgICAgIHN0YXRlLmluZGVudGF0aW9uID0gbGluZUluZGVudGF0aW9uICsgc3RyZWFtLmN1cnJlbnQoKS5sZW5ndGg7CiAgICAgIHN0YXRlLmxpc3QgPSB0cnVlOwogICAgICBzdGF0ZS5xdW90ZSA9IDA7CgogICAgICAvLyBBZGQgdGhpcyBsaXN0IGl0ZW0ncyBjb250ZW50J3MgaW5kZW50YXRpb24gdG8gdGhlIHN0YWNrCiAgICAgIHN0YXRlLmxpc3RTdGFjay5wdXNoKHN0YXRlLmluZGVudGF0aW9uKTsKCiAgICAgIGlmIChtb2RlQ2ZnLnRhc2tMaXN0cyAmJiBzdHJlYW0ubWF0Y2godGFza0xpc3RSRSwgZmFsc2UpKSB7CiAgICAgICAgc3RhdGUudGFza0xpc3QgPSB0cnVlOwogICAgICB9CiAgICAgIHN0YXRlLmYgPSBzdGF0ZS5pbmxpbmU7CiAgICAgIGlmIChtb2RlQ2ZnLmhpZ2hsaWdodEZvcm1hdHRpbmcpIHN0YXRlLmZvcm1hdHRpbmcgPSBbImxpc3QiLCAibGlzdC0iICsgbGlzdFR5cGVdOwogICAgICByZXR1cm4gZ2V0VHlwZShzdGF0ZSk7CiAgICB9IGVsc2UgaWYgKGZpcnN0VG9rZW5PbkxpbmUgJiYgc3RhdGUuaW5kZW50YXRpb24gPD0gbWF4Tm9uQ29kZUluZGVudGF0aW9uICYmIChtYXRjaCA9IHN0cmVhbS5tYXRjaChmZW5jZWRDb2RlUkUsIHRydWUpKSkgewogICAgICBzdGF0ZS5xdW90ZSA9IDA7CiAgICAgIHN0YXRlLmZlbmNlZEVuZFJFID0gbmV3IFJlZ0V4cChtYXRjaFsxXSArICIrICokIik7CiAgICAgIC8vIHRyeSBzd2l0Y2hpbmcgbW9kZQogICAgICBzdGF0ZS5sb2NhbE1vZGUgPSBtb2RlQ2ZnLmZlbmNlZENvZGVCbG9ja0hpZ2hsaWdodGluZyAmJiBnZXRNb2RlKG1hdGNoWzJdKTsKICAgICAgaWYgKHN0YXRlLmxvY2FsTW9kZSkgc3RhdGUubG9jYWxTdGF0ZSA9IENvZGVNaXJyb3Iuc3RhcnRTdGF0ZShzdGF0ZS5sb2NhbE1vZGUpOwogICAgICBzdGF0ZS5mID0gc3RhdGUuYmxvY2sgPSBsb2NhbDsKICAgICAgaWYgKG1vZGVDZmcuaGlnaGxpZ2h0Rm9ybWF0dGluZykgc3RhdGUuZm9ybWF0dGluZyA9ICJjb2RlLWJsb2NrIjsKICAgICAgc3RhdGUuY29kZSA9IC0xCiAgICAgIHJldHVybiBnZXRUeXBlKHN0YXRlKTsKICAgIC8vIFNFVEVYVCBoYXMgbG93ZXN0IGJsb2NrLXNjb3BlIHByZWNlZGVuY2UgYWZ0ZXIgSFIsIHNvIGNoZWNrIGl0IGFmdGVyCiAgICAvLyAgdGhlIG90aGVycyAoY29kZSwgYmxvY2txdW90ZSwgbGlzdC4uLikKICAgIH0gZWxzZSBpZiAoCiAgICAgIC8vIGlmIHNldGV4dCBzZXQsIGluZGljYXRlcyBsaW5lIGFmdGVyIC0tLS89PT0KICAgICAgc3RhdGUuc2V0ZXh0IHx8ICgKICAgICAgICAvLyBsaW5lIGJlZm9yZSAtLS0vPT09CiAgICAgICAgKCFhbGxvd3NJbmxpbmVDb250aW51YXRpb24gfHwgIXByZXZMaW5lSXNMaXN0KSAmJiAhc3RhdGUucXVvdGUgJiYgc3RhdGUubGlzdCA9PT0gZmFsc2UgJiYKICAgICAgICAhc3RhdGUuY29kZSAmJiAhaXNIciAmJiAhbGlua0RlZlJFLnRlc3Qoc3RyZWFtLnN0cmluZykgJiYKICAgICAgICAobWF0Y2ggPSBzdHJlYW0ubG9va0FoZWFkKDEpKSAmJiAobWF0Y2ggPSBtYXRjaC5tYXRjaChzZXRleHRIZWFkZXJSRSkpCiAgICAgICkKICAgICkgewogICAgICBpZiAoICFzdGF0ZS5zZXRleHQgKSB7CiAgICAgICAgc3RhdGUuaGVhZGVyID0gbWF0Y2hbMF0uY2hhckF0KDApID09ICc9JyA/IDEgOiAyOwogICAgICAgIHN0YXRlLnNldGV4dCA9IHN0YXRlLmhlYWRlcjsKICAgICAgfSBlbHNlIHsKICAgICAgICBzdGF0ZS5oZWFkZXIgPSBzdGF0ZS5zZXRleHQ7CiAgICAgICAgLy8gaGFzIG5vIGVmZmVjdCBvbiB0eXBlIHNvIHdlIGNhbiByZXNldCBpdCBub3cKICAgICAgICBzdGF0ZS5zZXRleHQgPSAwOwogICAgICAgIHN0cmVhbS5za2lwVG9FbmQoKTsKICAgICAgICBpZiAobW9kZUNmZy5oaWdobGlnaHRGb3JtYXR0aW5nKSBzdGF0ZS5mb3JtYXR0aW5nID0gImhlYWRlciI7CiAgICAgIH0KICAgICAgc3RhdGUudGhpc0xpbmUuaGVhZGVyID0gdHJ1ZTsKICAgICAgc3RhdGUuZiA9IHN0YXRlLmlubGluZTsKICAgICAgcmV0dXJuIGdldFR5cGUoc3RhdGUpOwogICAgfSBlbHNlIGlmIChpc0hyKSB7CiAgICAgIHN0cmVhbS5za2lwVG9FbmQoKTsKICAgICAgc3RhdGUuaHIgPSB0cnVlOwogICAgICBzdGF0ZS50aGlzTGluZS5ociA9IHRydWU7CiAgICAgIHJldHVybiB0b2tlblR5cGVzLmhyOwogICAgfSBlbHNlIGlmIChzdHJlYW0ucGVlaygpID09PSAnWycpIHsKICAgICAgcmV0dXJuIHN3aXRjaElubGluZShzdHJlYW0sIHN0YXRlLCBmb290bm90ZUxpbmspOwogICAgfQoKICAgIHJldHVybiBzd2l0Y2hJbmxpbmUoc3RyZWFtLCBzdGF0ZSwgc3RhdGUuaW5saW5lKTsKICB9CgogIGZ1bmN0aW9uIGh0bWxCbG9jayhzdHJlYW0sIHN0YXRlKSB7CiAgICB2YXIgc3R5bGUgPSBodG1sTW9kZS50b2tlbihzdHJlYW0sIHN0YXRlLmh0bWxTdGF0ZSk7CiAgICBpZiAoIWh0bWxNb2RlTWlzc2luZykgewogICAgICB2YXIgaW5uZXIgPSBDb2RlTWlycm9yLmlubmVyTW9kZShodG1sTW9kZSwgc3RhdGUuaHRtbFN0YXRlKQogICAgICBpZiAoKGlubmVyLm1vZGUubmFtZSA9PSAieG1sIiAmJiBpbm5lci5zdGF0ZS50YWdTdGFydCA9PT0gbnVsbCAmJgogICAgICAgICAgICghaW5uZXIuc3RhdGUuY29udGV4dCAmJiBpbm5lci5zdGF0ZS50b2tlbml6ZS5pc0luVGV4dCkpIHx8CiAgICAgICAgICAoc3RhdGUubWRfaW5zaWRlICYmIHN0cmVhbS5jdXJyZW50KCkuaW5kZXhPZigiPiIpID4gLTEpKSB7CiAgICAgICAgc3RhdGUuZiA9IGlubGluZU5vcm1hbDsKICAgICAgICBzdGF0ZS5ibG9jayA9IGJsb2NrTm9ybWFsOwogICAgICAgIHN0YXRlLmh0bWxTdGF0ZSA9IG51bGw7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBzdHlsZTsKICB9CgogIGZ1bmN0aW9uIGxvY2FsKHN0cmVhbSwgc3RhdGUpIHsKICAgIHZhciBjdXJyTGlzdEluZCA9IHN0YXRlLmxpc3RTdGFja1tzdGF0ZS5saXN0U3RhY2subGVuZ3RoIC0gMV0gfHwgMDsKICAgIHZhciBoYXNFeGl0ZWRMaXN0ID0gc3RhdGUuaW5kZW50YXRpb24gPCBjdXJyTGlzdEluZDsKICAgIHZhciBtYXhGZW5jZWRFbmRJbmQgPSBjdXJyTGlzdEluZCArIDM7CiAgICBpZiAoc3RhdGUuZmVuY2VkRW5kUkUgJiYgc3RhdGUuaW5kZW50YXRpb24gPD0gbWF4RmVuY2VkRW5kSW5kICYmIChoYXNFeGl0ZWRMaXN0IHx8IHN0cmVhbS5tYXRjaChzdGF0ZS5mZW5jZWRFbmRSRSkpKSB7CiAgICAgIGlmIChtb2RlQ2ZnLmhpZ2hsaWdodEZvcm1hdHRpbmcpIHN0YXRlLmZvcm1hdHRpbmcgPSAiY29kZS1ibG9jayI7CiAgICAgIHZhciByZXR1cm5UeXBlOwogICAgICBpZiAoIWhhc0V4aXRlZExpc3QpIHJldHVyblR5cGUgPSBnZXRUeXBlKHN0YXRlKQogICAgICBzdGF0ZS5sb2NhbE1vZGUgPSBzdGF0ZS5sb2NhbFN0YXRlID0gbnVsbDsKICAgICAgc3RhdGUuYmxvY2sgPSBibG9ja05vcm1hbDsKICAgICAgc3RhdGUuZiA9IGlubGluZU5vcm1hbDsKICAgICAgc3RhdGUuZmVuY2VkRW5kUkUgPSBudWxsOwogICAgICBzdGF0ZS5jb2RlID0gMAogICAgICBzdGF0ZS50aGlzTGluZS5mZW5jZWRDb2RlRW5kID0gdHJ1ZTsKICAgICAgaWYgKGhhc0V4aXRlZExpc3QpIHJldHVybiBzd2l0Y2hCbG9jayhzdHJlYW0sIHN0YXRlLCBzdGF0ZS5ibG9jayk7CiAgICAgIHJldHVybiByZXR1cm5UeXBlOwogICAgfSBlbHNlIGlmIChzdGF0ZS5sb2NhbE1vZGUpIHsKICAgICAgcmV0dXJuIHN0YXRlLmxvY2FsTW9kZS50b2tlbihzdHJlYW0sIHN0YXRlLmxvY2FsU3RhdGUpOwogICAgfSBlbHNlIHsKICAgICAgc3RyZWFtLnNraXBUb0VuZCgpOwogICAgICByZXR1cm4gdG9rZW5UeXBlcy5jb2RlOwogICAgfQogIH0KCiAgLy8gSW5saW5lCiAgZnVuY3Rpb24gZ2V0VHlwZShzdGF0ZSkgewogICAgdmFyIHN0eWxlcyA9IFtdOwoKICAgIGlmIChzdGF0ZS5mb3JtYXR0aW5nKSB7CiAgICAgIHN0eWxlcy5wdXNoKHRva2VuVHlwZXMuZm9ybWF0dGluZyk7CgogICAgICBpZiAodHlwZW9mIHN0YXRlLmZvcm1hdHRpbmcgPT09ICJzdHJpbmciKSBzdGF0ZS5mb3JtYXR0aW5nID0gW3N0YXRlLmZvcm1hdHRpbmddOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzdGF0ZS5mb3JtYXR0aW5nLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgc3R5bGVzLnB1c2godG9rZW5UeXBlcy5mb3JtYXR0aW5nICsgIi0iICsgc3RhdGUuZm9ybWF0dGluZ1tpXSk7CgogICAgICAgIGlmIChzdGF0ZS5mb3JtYXR0aW5nW2ldID09PSAiaGVhZGVyIikgewogICAgICAgICAgc3R5bGVzLnB1c2godG9rZW5UeXBlcy5mb3JtYXR0aW5nICsgIi0iICsgc3RhdGUuZm9ybWF0dGluZ1tpXSArICItIiArIHN0YXRlLmhlYWRlcik7CiAgICAgICAgfQoKICAgICAgICAvLyBBZGQgYGZvcm1hdHRpbmctcXVvdGVgIGFuZCBgZm9ybWF0dGluZy1xdW90ZS0jYCBmb3IgYmxvY2txdW90ZXMKICAgICAgICAvLyBBZGQgYGVycm9yYCBpbnN0ZWFkIGlmIHRoZSBtYXhpbXVtIGJsb2NrcXVvdGUgbmVzdGluZyBkZXB0aCBpcyBwYXNzZWQKICAgICAgICBpZiAoc3RhdGUuZm9ybWF0dGluZ1tpXSA9PT0gInF1b3RlIikgewogICAgICAgICAgaWYgKCFtb2RlQ2ZnLm1heEJsb2NrcXVvdGVEZXB0aCB8fCBtb2RlQ2ZnLm1heEJsb2NrcXVvdGVEZXB0aCA+PSBzdGF0ZS5xdW90ZSkgewogICAgICAgICAgICBzdHlsZXMucHVzaCh0b2tlblR5cGVzLmZvcm1hdHRpbmcgKyAiLSIgKyBzdGF0ZS5mb3JtYXR0aW5nW2ldICsgIi0iICsgc3RhdGUucXVvdGUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3R5bGVzLnB1c2goImVycm9yIik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgaWYgKHN0YXRlLnRhc2tPcGVuKSB7CiAgICAgIHN0eWxlcy5wdXNoKCJtZXRhIik7CiAgICAgIHJldHVybiBzdHlsZXMubGVuZ3RoID8gc3R5bGVzLmpvaW4oJyAnKSA6IG51bGw7CiAgICB9CiAgICBpZiAoc3RhdGUudGFza0Nsb3NlZCkgewogICAgICBzdHlsZXMucHVzaCgicHJvcGVydHkiKTsKICAgICAgcmV0dXJuIHN0eWxlcy5sZW5ndGggPyBzdHlsZXMuam9pbignICcpIDogbnVsbDsKICAgIH0KCiAgICBpZiAoc3RhdGUubGlua0hyZWYpIHsKICAgICAgc3R5bGVzLnB1c2godG9rZW5UeXBlcy5saW5rSHJlZiwgInVybCIpOwogICAgfSBlbHNlIHsgLy8gT25seSBhcHBseSBpbmxpbmUgc3R5bGVzIHRvIG5vbi11cmwgdGV4dAogICAgICBpZiAoc3RhdGUuc3Ryb25nKSB7IHN0eWxlcy5wdXNoKHRva2VuVHlwZXMuc3Ryb25nKTsgfQogICAgICBpZiAoc3RhdGUuZW0pIHsgc3R5bGVzLnB1c2godG9rZW5UeXBlcy5lbSk7IH0KICAgICAgaWYgKHN0YXRlLnN0cmlrZXRocm91Z2gpIHsgc3R5bGVzLnB1c2godG9rZW5UeXBlcy5zdHJpa2V0aHJvdWdoKTsgfQogICAgICBpZiAoc3RhdGUuZW1vamkpIHsgc3R5bGVzLnB1c2godG9rZW5UeXBlcy5lbW9qaSk7IH0KICAgICAgaWYgKHN0YXRlLmxpbmtUZXh0KSB7IHN0eWxlcy5wdXNoKHRva2VuVHlwZXMubGlua1RleHQpOyB9CiAgICAgIGlmIChzdGF0ZS5jb2RlKSB7IHN0eWxlcy5wdXNoKHRva2VuVHlwZXMuY29kZSk7IH0KICAgICAgaWYgKHN0YXRlLmltYWdlKSB7IHN0eWxlcy5wdXNoKHRva2VuVHlwZXMuaW1hZ2UpOyB9CiAgICAgIGlmIChzdGF0ZS5pbWFnZUFsdFRleHQpIHsgc3R5bGVzLnB1c2godG9rZW5UeXBlcy5pbWFnZUFsdFRleHQsICJsaW5rIik7IH0KICAgICAgaWYgKHN0YXRlLmltYWdlTWFya2VyKSB7IHN0eWxlcy5wdXNoKHRva2VuVHlwZXMuaW1hZ2VNYXJrZXIpOyB9CiAgICB9CgogICAgaWYgKHN0YXRlLmhlYWRlcikgeyBzdHlsZXMucHVzaCh0b2tlblR5cGVzLmhlYWRlciwgdG9rZW5UeXBlcy5oZWFkZXIgKyAiLSIgKyBzdGF0ZS5oZWFkZXIpOyB9CgogICAgaWYgKHN0YXRlLnF1b3RlKSB7CiAgICAgIHN0eWxlcy5wdXNoKHRva2VuVHlwZXMucXVvdGUpOwoKICAgICAgLy8gQWRkIGBxdW90ZS0jYCB3aGVyZSB0aGUgbWF4aW11bSBmb3IgYCNgIGlzIG1vZGVDZmcubWF4QmxvY2txdW90ZURlcHRoCiAgICAgIGlmICghbW9kZUNmZy5tYXhCbG9ja3F1b3RlRGVwdGggfHwgbW9kZUNmZy5tYXhCbG9ja3F1b3RlRGVwdGggPj0gc3RhdGUucXVvdGUpIHsKICAgICAgICBzdHlsZXMucHVzaCh0b2tlblR5cGVzLnF1b3RlICsgIi0iICsgc3RhdGUucXVvdGUpOwogICAgICB9IGVsc2UgewogICAgICAgIHN0eWxlcy5wdXNoKHRva2VuVHlwZXMucXVvdGUgKyAiLSIgKyBtb2RlQ2ZnLm1heEJsb2NrcXVvdGVEZXB0aCk7CiAgICAgIH0KICAgIH0KCiAgICBpZiAoc3RhdGUubGlzdCAhPT0gZmFsc2UpIHsKICAgICAgdmFyIGxpc3RNb2QgPSAoc3RhdGUubGlzdFN0YWNrLmxlbmd0aCAtIDEpICUgMzsKICAgICAgaWYgKCFsaXN0TW9kKSB7CiAgICAgICAgc3R5bGVzLnB1c2godG9rZW5UeXBlcy5saXN0MSk7CiAgICAgIH0gZWxzZSBpZiAobGlzdE1vZCA9PT0gMSkgewogICAgICAgIHN0eWxlcy5wdXNoKHRva2VuVHlwZXMubGlzdDIpOwogICAgICB9IGVsc2UgewogICAgICAgIHN0eWxlcy5wdXNoKHRva2VuVHlwZXMubGlzdDMpOwogICAgICB9CiAgICB9CgogICAgaWYgKHN0YXRlLnRyYWlsaW5nU3BhY2VOZXdMaW5lKSB7CiAgICAgIHN0eWxlcy5wdXNoKCJ0cmFpbGluZy1zcGFjZS1uZXctbGluZSIpOwogICAgfSBlbHNlIGlmIChzdGF0ZS50cmFpbGluZ1NwYWNlKSB7CiAgICAgIHN0eWxlcy5wdXNoKCJ0cmFpbGluZy1zcGFjZS0iICsgKHN0YXRlLnRyYWlsaW5nU3BhY2UgJSAyID8gImEiIDogImIiKSk7CiAgICB9CgogICAgcmV0dXJuIHN0eWxlcy5sZW5ndGggPyBzdHlsZXMuam9pbignICcpIDogbnVsbDsKICB9CgogIGZ1bmN0aW9uIGhhbmRsZVRleHQoc3RyZWFtLCBzdGF0ZSkgewogICAgaWYgKHN0cmVhbS5tYXRjaCh0ZXh0UkUsIHRydWUpKSB7CiAgICAgIHJldHVybiBnZXRUeXBlKHN0YXRlKTsKICAgIH0KICAgIHJldHVybiB1bmRlZmluZWQ7CiAgfQoKICBmdW5jdGlvbiBpbmxpbmVOb3JtYWwoc3RyZWFtLCBzdGF0ZSkgewogICAgdmFyIHN0eWxlID0gc3RhdGUudGV4dChzdHJlYW0sIHN0YXRlKTsKICAgIGlmICh0eXBlb2Ygc3R5bGUgIT09ICd1bmRlZmluZWQnKQogICAgICByZXR1cm4gc3R5bGU7CgogICAgaWYgKHN0YXRlLmxpc3QpIHsgLy8gTGlzdCBtYXJrZXIgKCosICssIC0sIDEuLCBldGMpCiAgICAgIHN0YXRlLmxpc3QgPSBudWxsOwogICAgICByZXR1cm4gZ2V0VHlwZShzdGF0ZSk7CiAgICB9CgogICAgaWYgKHN0YXRlLnRhc2tMaXN0KSB7CiAgICAgIHZhciB0YXNrT3BlbiA9IHN0cmVhbS5tYXRjaCh0YXNrTGlzdFJFLCB0cnVlKVsxXSA9PT0gIiAiOwogICAgICBpZiAodGFza09wZW4pIHN0YXRlLnRhc2tPcGVuID0gdHJ1ZTsKICAgICAgZWxzZSBzdGF0ZS50YXNrQ2xvc2VkID0gdHJ1ZTsKICAgICAgaWYgKG1vZGVDZmcuaGlnaGxpZ2h0Rm9ybWF0dGluZykgc3RhdGUuZm9ybWF0dGluZyA9ICJ0YXNrIjsKICAgICAgc3RhdGUudGFza0xpc3QgPSBmYWxzZTsKICAgICAgcmV0dXJuIGdldFR5cGUoc3RhdGUpOwogICAgfQoKICAgIHN0YXRlLnRhc2tPcGVuID0gZmFsc2U7CiAgICBzdGF0ZS50YXNrQ2xvc2VkID0gZmFsc2U7CgogICAgaWYgKHN0YXRlLmhlYWRlciAmJiBzdHJlYW0ubWF0Y2goL14jKyQvLCB0cnVlKSkgewogICAgICBpZiAobW9kZUNmZy5oaWdobGlnaHRGb3JtYXR0aW5nKSBzdGF0ZS5mb3JtYXR0aW5nID0gImhlYWRlciI7CiAgICAgIHJldHVybiBnZXRUeXBlKHN0YXRlKTsKICAgIH0KCiAgICB2YXIgY2ggPSBzdHJlYW0ubmV4dCgpOwoKICAgIC8vIE1hdGNoZXMgbGluayB0aXRsZXMgcHJlc2VudCBvbiBuZXh0IGxpbmUKICAgIGlmIChzdGF0ZS5saW5rVGl0bGUpIHsKICAgICAgc3RhdGUubGlua1RpdGxlID0gZmFsc2U7CiAgICAgIHZhciBtYXRjaENoID0gY2g7CiAgICAgIGlmIChjaCA9PT0gJygnKSB7CiAgICAgICAgbWF0Y2hDaCA9ICcpJzsKICAgICAgfQogICAgICBtYXRjaENoID0gKG1hdGNoQ2grJycpLnJlcGxhY2UoLyhbLj8qK15cW1xdXFwoKXt9fC1dKS9nLCAiXFwkMSIpOwogICAgICB2YXIgcmVnZXggPSAnXlxccyooPzpbXicgKyBtYXRjaENoICsgJ1xcXFxdK3xcXFxcXFxcXHxcXFxcLiknICsgbWF0Y2hDaDsKICAgICAgaWYgKHN0cmVhbS5tYXRjaChuZXcgUmVnRXhwKHJlZ2V4KSwgdHJ1ZSkpIHsKICAgICAgICByZXR1cm4gdG9rZW5UeXBlcy5saW5rSHJlZjsKICAgICAgfQogICAgfQoKICAgIC8vIElmIHRoaXMgYmxvY2sgaXMgY2hhbmdlZCwgaXQgbWF5IG5lZWQgdG8gYmUgdXBkYXRlZCBpbiBHRk0gbW9kZQogICAgaWYgKGNoID09PSAnYCcpIHsKICAgICAgdmFyIHByZXZpb3VzRm9ybWF0dGluZyA9IHN0YXRlLmZvcm1hdHRpbmc7CiAgICAgIGlmIChtb2RlQ2ZnLmhpZ2hsaWdodEZvcm1hdHRpbmcpIHN0YXRlLmZvcm1hdHRpbmcgPSAiY29kZSI7CiAgICAgIHN0cmVhbS5lYXRXaGlsZSgnYCcpOwogICAgICB2YXIgY291bnQgPSBzdHJlYW0uY3VycmVudCgpLmxlbmd0aAogICAgICBpZiAoc3RhdGUuY29kZSA9PSAwICYmICghc3RhdGUucXVvdGUgfHwgY291bnQgPT0gMSkpIHsKICAgICAgICBzdGF0ZS5jb2RlID0gY291bnQKICAgICAgICByZXR1cm4gZ2V0VHlwZShzdGF0ZSkKICAgICAgfSBlbHNlIGlmIChjb3VudCA9PSBzdGF0ZS5jb2RlKSB7IC8vIE11c3QgYmUgZXhhY3QKICAgICAgICB2YXIgdCA9IGdldFR5cGUoc3RhdGUpCiAgICAgICAgc3RhdGUuY29kZSA9IDAKICAgICAgICByZXR1cm4gdAogICAgICB9IGVsc2UgewogICAgICAgIHN0YXRlLmZvcm1hdHRpbmcgPSBwcmV2aW91c0Zvcm1hdHRpbmcKICAgICAgICByZXR1cm4gZ2V0VHlwZShzdGF0ZSkKICAgICAgfQogICAgfSBlbHNlIGlmIChzdGF0ZS5jb2RlKSB7CiAgICAgIHJldHVybiBnZXRUeXBlKHN0YXRlKTsKICAgIH0KCiAgICBpZiAoY2ggPT09ICdcXCcpIHsKICAgICAgc3RyZWFtLm5leHQoKTsKICAgICAgaWYgKG1vZGVDZmcuaGlnaGxpZ2h0Rm9ybWF0dGluZykgewogICAgICAgIHZhciB0eXBlID0gZ2V0VHlwZShzdGF0ZSk7CiAgICAgICAgdmFyIGZvcm1hdHRpbmdFc2NhcGUgPSB0b2tlblR5cGVzLmZvcm1hdHRpbmcgKyAiLWVzY2FwZSI7CiAgICAgICAgcmV0dXJuIHR5cGUgPyB0eXBlICsgIiAiICsgZm9ybWF0dGluZ0VzY2FwZSA6IGZvcm1hdHRpbmdFc2NhcGU7CiAgICAgIH0KICAgIH0KCiAgICBpZiAoY2ggPT09ICchJyAmJiBzdHJlYW0ubWF0Y2goL1xbW15cXV0qXF0gPyg/OlwofFxbKS8sIGZhbHNlKSkgewogICAgICBzdGF0ZS5pbWFnZU1hcmtlciA9IHRydWU7CiAgICAgIHN0YXRlLmltYWdlID0gdHJ1ZTsKICAgICAgaWYgKG1vZGVDZmcuaGlnaGxpZ2h0Rm9ybWF0dGluZykgc3RhdGUuZm9ybWF0dGluZyA9ICJpbWFnZSI7CiAgICAgIHJldHVybiBnZXRUeXBlKHN0YXRlKTsKICAgIH0KCiAgICBpZiAoY2ggPT09ICdbJyAmJiBzdGF0ZS5pbWFnZU1hcmtlciAmJiBzdHJlYW0ubWF0Y2goL1teXF1dKlxdKFwoLio/XCl8ID9cWy4qP1xdKS8sIGZhbHNlKSkgewogICAgICBzdGF0ZS5pbWFnZU1hcmtlciA9IGZhbHNlOwogICAgICBzdGF0ZS5pbWFnZUFsdFRleHQgPSB0cnVlCiAgICAgIGlmIChtb2RlQ2ZnLmhpZ2hsaWdodEZvcm1hdHRpbmcpIHN0YXRlLmZvcm1hdHRpbmcgPSAiaW1hZ2UiOwogICAgICByZXR1cm4gZ2V0VHlwZShzdGF0ZSk7CiAgICB9CgogICAgaWYgKGNoID09PSAnXScgJiYgc3RhdGUuaW1hZ2VBbHRUZXh0KSB7CiAgICAgIGlmIChtb2RlQ2ZnLmhpZ2hsaWdodEZvcm1hdHRpbmcpIHN0YXRlLmZvcm1hdHRpbmcgPSAiaW1hZ2UiOwogICAgICB2YXIgdHlwZSA9IGdldFR5cGUoc3RhdGUpOwogICAgICBzdGF0ZS5pbWFnZUFsdFRleHQgPSBmYWxzZTsKICAgICAgc3RhdGUuaW1hZ2UgPSBmYWxzZTsKICAgICAgc3RhdGUuaW5saW5lID0gc3RhdGUuZiA9IGxpbmtIcmVmOwogICAgICByZXR1cm4gdHlwZTsKICAgIH0KCiAgICBpZiAoY2ggPT09ICdbJyAmJiAhc3RhdGUuaW1hZ2UpIHsKICAgICAgaWYgKHN0YXRlLmxpbmtUZXh0ICYmIHN0cmVhbS5tYXRjaCgvXi4qP1xdLykpIHJldHVybiBnZXRUeXBlKHN0YXRlKQogICAgICBzdGF0ZS5saW5rVGV4dCA9IHRydWU7CiAgICAgIGlmIChtb2RlQ2ZnLmhpZ2hsaWdodEZvcm1hdHRpbmcpIHN0YXRlLmZvcm1hdHRpbmcgPSAibGluayI7CiAgICAgIHJldHVybiBnZXRUeXBlKHN0YXRlKTsKICAgIH0KCiAgICBpZiAoY2ggPT09ICddJyAmJiBzdGF0ZS5saW5rVGV4dCkgewogICAgICBpZiAobW9kZUNmZy5oaWdobGlnaHRGb3JtYXR0aW5nKSBzdGF0ZS5mb3JtYXR0aW5nID0gImxpbmsiOwogICAgICB2YXIgdHlwZSA9IGdldFR5cGUoc3RhdGUpOwogICAgICBzdGF0ZS5saW5rVGV4dCA9IGZhbHNlOwogICAgICBzdGF0ZS5pbmxpbmUgPSBzdGF0ZS5mID0gc3RyZWFtLm1hdGNoKC9cKC4qP1wpfCA/XFsuKj9cXS8sIGZhbHNlKSA/IGxpbmtIcmVmIDogaW5saW5lTm9ybWFsCiAgICAgIHJldHVybiB0eXBlOwogICAgfQoKICAgIGlmIChjaCA9PT0gJzwnICYmIHN0cmVhbS5tYXRjaCgvXihodHRwcz98ZnRwcz8pOlwvXC8oPzpbXlxcPl18XFwuKSs+LywgZmFsc2UpKSB7CiAgICAgIHN0YXRlLmYgPSBzdGF0ZS5pbmxpbmUgPSBsaW5rSW5saW5lOwogICAgICBpZiAobW9kZUNmZy5oaWdobGlnaHRGb3JtYXR0aW5nKSBzdGF0ZS5mb3JtYXR0aW5nID0gImxpbmsiOwogICAgICB2YXIgdHlwZSA9IGdldFR5cGUoc3RhdGUpOwogICAgICBpZiAodHlwZSl7CiAgICAgICAgdHlwZSArPSAiICI7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdHlwZSA9ICIiOwogICAgICB9CiAgICAgIHJldHVybiB0eXBlICsgdG9rZW5UeXBlcy5saW5rSW5saW5lOwogICAgfQoKICAgIGlmIChjaCA9PT0gJzwnICYmIHN0cmVhbS5tYXRjaCgvXltePiBcXF0rQCg/OlteXFw+XXxcXC4pKz4vLCBmYWxzZSkpIHsKICAgICAgc3RhdGUuZiA9IHN0YXRlLmlubGluZSA9IGxpbmtJbmxpbmU7CiAgICAgIGlmIChtb2RlQ2ZnLmhpZ2hsaWdodEZvcm1hdHRpbmcpIHN0YXRlLmZvcm1hdHRpbmcgPSAibGluayI7CiAgICAgIHZhciB0eXBlID0gZ2V0VHlwZShzdGF0ZSk7CiAgICAgIGlmICh0eXBlKXsKICAgICAgICB0eXBlICs9ICIgIjsKICAgICAgfSBlbHNlIHsKICAgICAgICB0eXBlID0gIiI7CiAgICAgIH0KICAgICAgcmV0dXJuIHR5cGUgKyB0b2tlblR5cGVzLmxpbmtFbWFpbDsKICAgIH0KCiAgICBpZiAobW9kZUNmZy54bWwgJiYgY2ggPT09ICc8JyAmJiBzdHJlYW0ubWF0Y2goL14oIS0tfFw/fCFcW0NEQVRBXFt8W2Etel1bYS16MC05LV0qKD86XHMrW2Etel86LlwtXSsoPzpccyo9XHMqW14+XSspPykqXHMqKD86PnwkKSkvaSwgZmFsc2UpKSB7CiAgICAgIHZhciBlbmQgPSBzdHJlYW0uc3RyaW5nLmluZGV4T2YoIj4iLCBzdHJlYW0ucG9zKTsKICAgICAgaWYgKGVuZCAhPSAtMSkgewogICAgICAgIHZhciBhdHRzID0gc3RyZWFtLnN0cmluZy5zdWJzdHJpbmcoc3RyZWFtLnN0YXJ0LCBlbmQpOwogICAgICAgIGlmICgvbWFya2Rvd25ccyo9XHMqKCd8Iil7MCwxfTEoJ3wiKXswLDF9Ly50ZXN0KGF0dHMpKSBzdGF0ZS5tZF9pbnNpZGUgPSB0cnVlOwogICAgICB9CiAgICAgIHN0cmVhbS5iYWNrVXAoMSk7CiAgICAgIHN0YXRlLmh0bWxTdGF0ZSA9IENvZGVNaXJyb3Iuc3RhcnRTdGF0ZShodG1sTW9kZSk7CiAgICAgIHJldHVybiBzd2l0Y2hCbG9jayhzdHJlYW0sIHN0YXRlLCBodG1sQmxvY2spOwogICAgfQoKICAgIGlmIChtb2RlQ2ZnLnhtbCAmJiBjaCA9PT0gJzwnICYmIHN0cmVhbS5tYXRjaCgvXlwvXHcqPz4vKSkgewogICAgICBzdGF0ZS5tZF9pbnNpZGUgPSBmYWxzZTsKICAgICAgcmV0dXJuICJ0YWciOwogICAgfSBlbHNlIGlmIChjaCA9PT0gIioiIHx8IGNoID09PSAiXyIpIHsKICAgICAgdmFyIGxlbiA9IDEsIGJlZm9yZSA9IHN0cmVhbS5wb3MgPT0gMSA/ICIgIiA6IHN0cmVhbS5zdHJpbmcuY2hhckF0KHN0cmVhbS5wb3MgLSAyKQogICAgICB3aGlsZSAobGVuIDwgMyAmJiBzdHJlYW0uZWF0KGNoKSkgbGVuKysKICAgICAgdmFyIGFmdGVyID0gc3RyZWFtLnBlZWsoKSB8fCAiICIKICAgICAgLy8gU2VlIGh0dHA6Ly9zcGVjLmNvbW1vbm1hcmsub3JnLzAuMjcvI2VtcGhhc2lzLWFuZC1zdHJvbmctZW1waGFzaXMKICAgICAgdmFyIGxlZnRGbGFua2luZyA9ICEvXHMvLnRlc3QoYWZ0ZXIpICYmICghcHVuY3R1YXRpb24udGVzdChhZnRlcikgfHwgL1xzLy50ZXN0KGJlZm9yZSkgfHwgcHVuY3R1YXRpb24udGVzdChiZWZvcmUpKQogICAgICB2YXIgcmlnaHRGbGFua2luZyA9ICEvXHMvLnRlc3QoYmVmb3JlKSAmJiAoIXB1bmN0dWF0aW9uLnRlc3QoYmVmb3JlKSB8fCAvXHMvLnRlc3QoYWZ0ZXIpIHx8IHB1bmN0dWF0aW9uLnRlc3QoYWZ0ZXIpKQogICAgICB2YXIgc2V0RW0gPSBudWxsLCBzZXRTdHJvbmcgPSBudWxsCiAgICAgIGlmIChsZW4gJSAyKSB7IC8vIEVtCiAgICAgICAgaWYgKCFzdGF0ZS5lbSAmJiBsZWZ0RmxhbmtpbmcgJiYgKGNoID09PSAiKiIgfHwgIXJpZ2h0RmxhbmtpbmcgfHwgcHVuY3R1YXRpb24udGVzdChiZWZvcmUpKSkKICAgICAgICAgIHNldEVtID0gdHJ1ZQogICAgICAgIGVsc2UgaWYgKHN0YXRlLmVtID09IGNoICYmIHJpZ2h0RmxhbmtpbmcgJiYgKGNoID09PSAiKiIgfHwgIWxlZnRGbGFua2luZyB8fCBwdW5jdHVhdGlvbi50ZXN0KGFmdGVyKSkpCiAgICAgICAgICBzZXRFbSA9IGZhbHNlCiAgICAgIH0KICAgICAgaWYgKGxlbiA+IDEpIHsgLy8gU3Ryb25nCiAgICAgICAgaWYgKCFzdGF0ZS5zdHJvbmcgJiYgbGVmdEZsYW5raW5nICYmIChjaCA9PT0gIioiIHx8ICFyaWdodEZsYW5raW5nIHx8IHB1bmN0dWF0aW9uLnRlc3QoYmVmb3JlKSkpCiAgICAgICAgICBzZXRTdHJvbmcgPSB0cnVlCiAgICAgICAgZWxzZSBpZiAoc3RhdGUuc3Ryb25nID09IGNoICYmIHJpZ2h0RmxhbmtpbmcgJiYgKGNoID09PSAiKiIgfHwgIWxlZnRGbGFua2luZyB8fCBwdW5jdHVhdGlvbi50ZXN0KGFmdGVyKSkpCiAgICAgICAgICBzZXRTdHJvbmcgPSBmYWxzZQogICAgICB9CiAgICAgIGlmIChzZXRTdHJvbmcgIT0gbnVsbCB8fCBzZXRFbSAhPSBudWxsKSB7CiAgICAgICAgaWYgKG1vZGVDZmcuaGlnaGxpZ2h0Rm9ybWF0dGluZykgc3RhdGUuZm9ybWF0dGluZyA9IHNldEVtID09IG51bGwgPyAic3Ryb25nIiA6IHNldFN0cm9uZyA9PSBudWxsID8gImVtIiA6ICJzdHJvbmcgZW0iCiAgICAgICAgaWYgKHNldEVtID09PSB0cnVlKSBzdGF0ZS5lbSA9IGNoCiAgICAgICAgaWYgKHNldFN0cm9uZyA9PT0gdHJ1ZSkgc3RhdGUuc3Ryb25nID0gY2gKICAgICAgICB2YXIgdCA9IGdldFR5cGUoc3RhdGUpCiAgICAgICAgaWYgKHNldEVtID09PSBmYWxzZSkgc3RhdGUuZW0gPSBmYWxzZQogICAgICAgIGlmIChzZXRTdHJvbmcgPT09IGZhbHNlKSBzdGF0ZS5zdHJvbmcgPSBmYWxzZQogICAgICAgIHJldHVybiB0CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoY2ggPT09ICcgJykgewogICAgICBpZiAoc3RyZWFtLmVhdCgnKicpIHx8IHN0cmVhbS5lYXQoJ18nKSkgeyAvLyBQcm9iYWJseSBzdXJyb3VuZGVkIGJ5IHNwYWNlcwogICAgICAgIGlmIChzdHJlYW0ucGVlaygpID09PSAnICcpIHsgLy8gU3Vycm91bmRlZCBieSBzcGFjZXMsIGlnbm9yZQogICAgICAgICAgcmV0dXJuIGdldFR5cGUoc3RhdGUpOwogICAgICAgIH0gZWxzZSB7IC8vIE5vdCBzdXJyb3VuZGVkIGJ5IHNwYWNlcywgYmFjayB1cCBwb2ludGVyCiAgICAgICAgICBzdHJlYW0uYmFja1VwKDEpOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGlmIChtb2RlQ2ZnLnN0cmlrZXRocm91Z2gpIHsKICAgICAgaWYgKGNoID09PSAnficgJiYgc3RyZWFtLmVhdFdoaWxlKGNoKSkgewogICAgICAgIGlmIChzdGF0ZS5zdHJpa2V0aHJvdWdoKSB7Ly8gUmVtb3ZlIHN0cmlrZXRocm91Z2gKICAgICAgICAgIGlmIChtb2RlQ2ZnLmhpZ2hsaWdodEZvcm1hdHRpbmcpIHN0YXRlLmZvcm1hdHRpbmcgPSAic3RyaWtldGhyb3VnaCI7CiAgICAgICAgICB2YXIgdCA9IGdldFR5cGUoc3RhdGUpOwogICAgICAgICAgc3RhdGUuc3RyaWtldGhyb3VnaCA9IGZhbHNlOwogICAgICAgICAgcmV0dXJuIHQ7CiAgICAgICAgfSBlbHNlIGlmIChzdHJlYW0ubWF0Y2goL15bXlxzXS8sIGZhbHNlKSkgey8vIEFkZCBzdHJpa2V0aHJvdWdoCiAgICAgICAgICBzdGF0ZS5zdHJpa2V0aHJvdWdoID0gdHJ1ZTsKICAgICAgICAgIGlmIChtb2RlQ2ZnLmhpZ2hsaWdodEZvcm1hdHRpbmcpIHN0YXRlLmZvcm1hdHRpbmcgPSAic3RyaWtldGhyb3VnaCI7CiAgICAgICAgICByZXR1cm4gZ2V0VHlwZShzdGF0ZSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKGNoID09PSAnICcpIHsKICAgICAgICBpZiAoc3RyZWFtLm1hdGNoKC9efn4vLCB0cnVlKSkgeyAvLyBQcm9iYWJseSBzdXJyb3VuZGVkIGJ5IHNwYWNlCiAgICAgICAgICBpZiAoc3RyZWFtLnBlZWsoKSA9PT0gJyAnKSB7IC8vIFN1cnJvdW5kZWQgYnkgc3BhY2VzLCBpZ25vcmUKICAgICAgICAgICAgcmV0dXJuIGdldFR5cGUoc3RhdGUpOwogICAgICAgICAgfSBlbHNlIHsgLy8gTm90IHN1cnJvdW5kZWQgYnkgc3BhY2VzLCBiYWNrIHVwIHBvaW50ZXIKICAgICAgICAgICAgc3RyZWFtLmJhY2tVcCgyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBpZiAobW9kZUNmZy5lbW9qaSAmJiBjaCA9PT0gIjoiICYmIHN0cmVhbS5tYXRjaCgvXig/OlthLXpfXGQrXVthLXpfXGQrLV0qfFwtW2Etel9cZCtdW2Etel9cZCstXSopOi8pKSB7CiAgICAgIHN0YXRlLmVtb2ppID0gdHJ1ZTsKICAgICAgaWYgKG1vZGVDZmcuaGlnaGxpZ2h0Rm9ybWF0dGluZykgc3RhdGUuZm9ybWF0dGluZyA9ICJlbW9qaSI7CiAgICAgIHZhciByZXRUeXBlID0gZ2V0VHlwZShzdGF0ZSk7CiAgICAgIHN0YXRlLmVtb2ppID0gZmFsc2U7CiAgICAgIHJldHVybiByZXRUeXBlOwogICAgfQoKICAgIGlmIChjaCA9PT0gJyAnKSB7CiAgICAgIGlmIChzdHJlYW0ubWF0Y2goL14gKyQvLCBmYWxzZSkpIHsKICAgICAgICBzdGF0ZS50cmFpbGluZ1NwYWNlKys7CiAgICAgIH0gZWxzZSBpZiAoc3RhdGUudHJhaWxpbmdTcGFjZSkgewogICAgICAgIHN0YXRlLnRyYWlsaW5nU3BhY2VOZXdMaW5lID0gdHJ1ZTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBnZXRUeXBlKHN0YXRlKTsKICB9CgogIGZ1bmN0aW9uIGxpbmtJbmxpbmUoc3RyZWFtLCBzdGF0ZSkgewogICAgdmFyIGNoID0gc3RyZWFtLm5leHQoKTsKCiAgICBpZiAoY2ggPT09ICI+IikgewogICAgICBzdGF0ZS5mID0gc3RhdGUuaW5saW5lID0gaW5saW5lTm9ybWFsOwogICAgICBpZiAobW9kZUNmZy5oaWdobGlnaHRGb3JtYXR0aW5nKSBzdGF0ZS5mb3JtYXR0aW5nID0gImxpbmsiOwogICAgICB2YXIgdHlwZSA9IGdldFR5cGUoc3RhdGUpOwogICAgICBpZiAodHlwZSl7CiAgICAgICAgdHlwZSArPSAiICI7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdHlwZSA9ICIiOwogICAgICB9CiAgICAgIHJldHVybiB0eXBlICsgdG9rZW5UeXBlcy5saW5rSW5saW5lOwogICAgfQoKICAgIHN0cmVhbS5tYXRjaCgvXltePl0rLywgdHJ1ZSk7CgogICAgcmV0dXJuIHRva2VuVHlwZXMubGlua0lubGluZTsKICB9CgogIGZ1bmN0aW9uIGxpbmtIcmVmKHN0cmVhbSwgc3RhdGUpIHsKICAgIC8vIENoZWNrIGlmIHNwYWNlLCBhbmQgcmV0dXJuIE5VTEwgaWYgc28gKHRvIGF2b2lkIG1hcmtpbmcgdGhlIHNwYWNlKQogICAgaWYoc3RyZWFtLmVhdFNwYWNlKCkpewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIHZhciBjaCA9IHN0cmVhbS5uZXh0KCk7CiAgICBpZiAoY2ggPT09ICcoJyB8fCBjaCA9PT0gJ1snKSB7CiAgICAgIHN0YXRlLmYgPSBzdGF0ZS5pbmxpbmUgPSBnZXRMaW5rSHJlZkluc2lkZShjaCA9PT0gIigiID8gIikiIDogIl0iKTsKICAgICAgaWYgKG1vZGVDZmcuaGlnaGxpZ2h0Rm9ybWF0dGluZykgc3RhdGUuZm9ybWF0dGluZyA9ICJsaW5rLXN0cmluZyI7CiAgICAgIHN0YXRlLmxpbmtIcmVmID0gdHJ1ZTsKICAgICAgcmV0dXJuIGdldFR5cGUoc3RhdGUpOwogICAgfQogICAgcmV0dXJuICdlcnJvcic7CiAgfQoKICB2YXIgbGlua1JFID0gewogICAgIikiOiAvXig/OlteXFxcKFwpXXxcXC58XCgoPzpbXlxcXChcKV18XFwuKSpcKSkqPyg/PVwpKS8sCiAgICAiXSI6IC9eKD86W15cXFxbXF1dfFxcLnxcWyg/OlteXFxcW1xdXXxcXC4pKlxdKSo/KD89XF0pLwogIH0KCiAgZnVuY3Rpb24gZ2V0TGlua0hyZWZJbnNpZGUoZW5kQ2hhcikgewogICAgcmV0dXJuIGZ1bmN0aW9uKHN0cmVhbSwgc3RhdGUpIHsKICAgICAgdmFyIGNoID0gc3RyZWFtLm5leHQoKTsKCiAgICAgIGlmIChjaCA9PT0gZW5kQ2hhcikgewogICAgICAgIHN0YXRlLmYgPSBzdGF0ZS5pbmxpbmUgPSBpbmxpbmVOb3JtYWw7CiAgICAgICAgaWYgKG1vZGVDZmcuaGlnaGxpZ2h0Rm9ybWF0dGluZykgc3RhdGUuZm9ybWF0dGluZyA9ICJsaW5rLXN0cmluZyI7CiAgICAgICAgdmFyIHJldHVyblN0YXRlID0gZ2V0VHlwZShzdGF0ZSk7CiAgICAgICAgc3RhdGUubGlua0hyZWYgPSBmYWxzZTsKICAgICAgICByZXR1cm4gcmV0dXJuU3RhdGU7CiAgICAgIH0KCiAgICAgIHN0cmVhbS5tYXRjaChsaW5rUkVbZW5kQ2hhcl0pCiAgICAgIHN0YXRlLmxpbmtIcmVmID0gdHJ1ZTsKICAgICAgcmV0dXJuIGdldFR5cGUoc3RhdGUpOwogICAgfTsKICB9CgogIGZ1bmN0aW9uIGZvb3Rub3RlTGluayhzdHJlYW0sIHN0YXRlKSB7CiAgICBpZiAoc3RyZWFtLm1hdGNoKC9eKFteXF1cXF18XFwuKSpcXTovLCBmYWxzZSkpIHsKICAgICAgc3RhdGUuZiA9IGZvb3Rub3RlTGlua0luc2lkZTsKICAgICAgc3RyZWFtLm5leHQoKTsgLy8gQ29uc3VtZSBbCiAgICAgIGlmIChtb2RlQ2ZnLmhpZ2hsaWdodEZvcm1hdHRpbmcpIHN0YXRlLmZvcm1hdHRpbmcgPSAibGluayI7CiAgICAgIHN0YXRlLmxpbmtUZXh0ID0gdHJ1ZTsKICAgICAgcmV0dXJuIGdldFR5cGUoc3RhdGUpOwogICAgfQogICAgcmV0dXJuIHN3aXRjaElubGluZShzdHJlYW0sIHN0YXRlLCBpbmxpbmVOb3JtYWwpOwogIH0KCiAgZnVuY3Rpb24gZm9vdG5vdGVMaW5rSW5zaWRlKHN0cmVhbSwgc3RhdGUpIHsKICAgIGlmIChzdHJlYW0ubWF0Y2goL15cXTovLCB0cnVlKSkgewogICAgICBzdGF0ZS5mID0gc3RhdGUuaW5saW5lID0gZm9vdG5vdGVVcmw7CiAgICAgIGlmIChtb2RlQ2ZnLmhpZ2hsaWdodEZvcm1hdHRpbmcpIHN0YXRlLmZvcm1hdHRpbmcgPSAibGluayI7CiAgICAgIHZhciByZXR1cm5UeXBlID0gZ2V0VHlwZShzdGF0ZSk7CiAgICAgIHN0YXRlLmxpbmtUZXh0ID0gZmFsc2U7CiAgICAgIHJldHVybiByZXR1cm5UeXBlOwogICAgfQoKICAgIHN0cmVhbS5tYXRjaCgvXihbXlxdXFxdfFxcLikrLywgdHJ1ZSk7CgogICAgcmV0dXJuIHRva2VuVHlwZXMubGlua1RleHQ7CiAgfQoKICBmdW5jdGlvbiBmb290bm90ZVVybChzdHJlYW0sIHN0YXRlKSB7CiAgICAvLyBDaGVjayBpZiBzcGFjZSwgYW5kIHJldHVybiBOVUxMIGlmIHNvICh0byBhdm9pZCBtYXJraW5nIHRoZSBzcGFjZSkKICAgIGlmKHN0cmVhbS5lYXRTcGFjZSgpKXsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICAvLyBNYXRjaCBVUkwKICAgIHN0cmVhbS5tYXRjaCgvXlteXHNdKy8sIHRydWUpOwogICAgLy8gQ2hlY2sgZm9yIGxpbmsgdGl0bGUKICAgIGlmIChzdHJlYW0ucGVlaygpID09PSB1bmRlZmluZWQpIHsgLy8gRW5kIG9mIGxpbmUsIHNldCBmbGFnIHRvIGNoZWNrIG5leHQgbGluZQogICAgICBzdGF0ZS5saW5rVGl0bGUgPSB0cnVlOwogICAgfSBlbHNlIHsgLy8gTW9yZSBjb250ZW50IG9uIGxpbmUsIGNoZWNrIGlmIGxpbmsgdGl0bGUKICAgICAgc3RyZWFtLm1hdGNoKC9eKD86XHMrKD86Iig/OlteIlxcXXxcXFxcfFxcLikrInwnKD86W14nXFxdfFxcXFx8XFwuKSsnfFwoKD86W14pXFxdfFxcXFx8XFwuKStcKSkpPy8sIHRydWUpOwogICAgfQogICAgc3RhdGUuZiA9IHN0YXRlLmlubGluZSA9IGlubGluZU5vcm1hbDsKICAgIHJldHVybiB0b2tlblR5cGVzLmxpbmtIcmVmICsgIiB1cmwiOwogIH0KCiAgdmFyIG1vZGUgPSB7CiAgICBzdGFydFN0YXRlOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICBmOiBibG9ja05vcm1hbCwKCiAgICAgICAgcHJldkxpbmU6IHtzdHJlYW06IG51bGx9LAogICAgICAgIHRoaXNMaW5lOiB7c3RyZWFtOiBudWxsfSwKCiAgICAgICAgYmxvY2s6IGJsb2NrTm9ybWFsLAogICAgICAgIGh0bWxTdGF0ZTogbnVsbCwKICAgICAgICBpbmRlbnRhdGlvbjogMCwKCiAgICAgICAgaW5saW5lOiBpbmxpbmVOb3JtYWwsCiAgICAgICAgdGV4dDogaGFuZGxlVGV4dCwKCiAgICAgICAgZm9ybWF0dGluZzogZmFsc2UsCiAgICAgICAgbGlua1RleHQ6IGZhbHNlLAogICAgICAgIGxpbmtIcmVmOiBmYWxzZSwKICAgICAgICBsaW5rVGl0bGU6IGZhbHNlLAogICAgICAgIGNvZGU6IDAsCiAgICAgICAgZW06IGZhbHNlLAogICAgICAgIHN0cm9uZzogZmFsc2UsCiAgICAgICAgaGVhZGVyOiAwLAogICAgICAgIHNldGV4dDogMCwKICAgICAgICBocjogZmFsc2UsCiAgICAgICAgdGFza0xpc3Q6IGZhbHNlLAogICAgICAgIGxpc3Q6IGZhbHNlLAogICAgICAgIGxpc3RTdGFjazogW10sCiAgICAgICAgcXVvdGU6IDAsCiAgICAgICAgdHJhaWxpbmdTcGFjZTogMCwKICAgICAgICB0cmFpbGluZ1NwYWNlTmV3TGluZTogZmFsc2UsCiAgICAgICAgc3RyaWtldGhyb3VnaDogZmFsc2UsCiAgICAgICAgZW1vamk6IGZhbHNlLAogICAgICAgIGZlbmNlZEVuZFJFOiBudWxsCiAgICAgIH07CiAgICB9LAoKICAgIGNvcHlTdGF0ZTogZnVuY3Rpb24ocykgewogICAgICByZXR1cm4gewogICAgICAgIGY6IHMuZiwKCiAgICAgICAgcHJldkxpbmU6IHMucHJldkxpbmUsCiAgICAgICAgdGhpc0xpbmU6IHMudGhpc0xpbmUsCgogICAgICAgIGJsb2NrOiBzLmJsb2NrLAogICAgICAgIGh0bWxTdGF0ZTogcy5odG1sU3RhdGUgJiYgQ29kZU1pcnJvci5jb3B5U3RhdGUoaHRtbE1vZGUsIHMuaHRtbFN0YXRlKSwKICAgICAgICBpbmRlbnRhdGlvbjogcy5pbmRlbnRhdGlvbiwKCiAgICAgICAgbG9jYWxNb2RlOiBzLmxvY2FsTW9kZSwKICAgICAgICBsb2NhbFN0YXRlOiBzLmxvY2FsTW9kZSA/IENvZGVNaXJyb3IuY29weVN0YXRlKHMubG9jYWxNb2RlLCBzLmxvY2FsU3RhdGUpIDogbnVsbCwKCiAgICAgICAgaW5saW5lOiBzLmlubGluZSwKICAgICAgICB0ZXh0OiBzLnRleHQsCiAgICAgICAgZm9ybWF0dGluZzogZmFsc2UsCiAgICAgICAgbGlua1RleHQ6IHMubGlua1RleHQsCiAgICAgICAgbGlua1RpdGxlOiBzLmxpbmtUaXRsZSwKICAgICAgICBsaW5rSHJlZjogcy5saW5rSHJlZiwKICAgICAgICBjb2RlOiBzLmNvZGUsCiAgICAgICAgZW06IHMuZW0sCiAgICAgICAgc3Ryb25nOiBzLnN0cm9uZywKICAgICAgICBzdHJpa2V0aHJvdWdoOiBzLnN0cmlrZXRocm91Z2gsCiAgICAgICAgZW1vamk6IHMuZW1vamksCiAgICAgICAgaGVhZGVyOiBzLmhlYWRlciwKICAgICAgICBzZXRleHQ6IHMuc2V0ZXh0LAogICAgICAgIGhyOiBzLmhyLAogICAgICAgIHRhc2tMaXN0OiBzLnRhc2tMaXN0LAogICAgICAgIGxpc3Q6IHMubGlzdCwKICAgICAgICBsaXN0U3RhY2s6IHMubGlzdFN0YWNrLnNsaWNlKDApLAogICAgICAgIHF1b3RlOiBzLnF1b3RlLAogICAgICAgIGluZGVudGVkQ29kZTogcy5pbmRlbnRlZENvZGUsCiAgICAgICAgdHJhaWxpbmdTcGFjZTogcy50cmFpbGluZ1NwYWNlLAogICAgICAgIHRyYWlsaW5nU3BhY2VOZXdMaW5lOiBzLnRyYWlsaW5nU3BhY2VOZXdMaW5lLAogICAgICAgIG1kX2luc2lkZTogcy5tZF9pbnNpZGUsCiAgICAgICAgZmVuY2VkRW5kUkU6IHMuZmVuY2VkRW5kUkUKICAgICAgfTsKICAgIH0sCgogICAgdG9rZW46IGZ1bmN0aW9uKHN0cmVhbSwgc3RhdGUpIHsKCiAgICAgIC8vIFJlc2V0IHN0YXRlLmZvcm1hdHRpbmcKICAgICAgc3RhdGUuZm9ybWF0dGluZyA9IGZhbHNlOwoKICAgICAgaWYgKHN0cmVhbSAhPSBzdGF0ZS50aGlzTGluZS5zdHJlYW0pIHsKICAgICAgICBzdGF0ZS5oZWFkZXIgPSAwOwogICAgICAgIHN0YXRlLmhyID0gZmFsc2U7CgogICAgICAgIGlmIChzdHJlYW0ubWF0Y2goL15ccyokLywgdHJ1ZSkpIHsKICAgICAgICAgIGJsYW5rTGluZShzdGF0ZSk7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CgogICAgICAgIHN0YXRlLnByZXZMaW5lID0gc3RhdGUudGhpc0xpbmUKICAgICAgICBzdGF0ZS50aGlzTGluZSA9IHtzdHJlYW06IHN0cmVhbX0KCiAgICAgICAgLy8gUmVzZXQgc3RhdGUudGFza0xpc3QKICAgICAgICBzdGF0ZS50YXNrTGlzdCA9IGZhbHNlOwoKICAgICAgICAvLyBSZXNldCBzdGF0ZS50cmFpbGluZ1NwYWNlCiAgICAgICAgc3RhdGUudHJhaWxpbmdTcGFjZSA9IDA7CiAgICAgICAgc3RhdGUudHJhaWxpbmdTcGFjZU5ld0xpbmUgPSBmYWxzZTsKCiAgICAgICAgaWYgKCFzdGF0ZS5sb2NhbFN0YXRlKSB7CiAgICAgICAgICBzdGF0ZS5mID0gc3RhdGUuYmxvY2s7CiAgICAgICAgICBpZiAoc3RhdGUuZiAhPSBodG1sQmxvY2spIHsKICAgICAgICAgICAgdmFyIGluZGVudGF0aW9uID0gc3RyZWFtLm1hdGNoKC9eXHMqLywgdHJ1ZSlbMF0ucmVwbGFjZSgvXHQvZywgZXhwYW5kZWRUYWIpLmxlbmd0aDsKICAgICAgICAgICAgc3RhdGUuaW5kZW50YXRpb24gPSBpbmRlbnRhdGlvbjsKICAgICAgICAgICAgc3RhdGUuaW5kZW50YXRpb25EaWZmID0gbnVsbDsKICAgICAgICAgICAgaWYgKGluZGVudGF0aW9uID4gMCkgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBzdGF0ZS5mKHN0cmVhbSwgc3RhdGUpOwogICAgfSwKCiAgICBpbm5lck1vZGU6IGZ1bmN0aW9uKHN0YXRlKSB7CiAgICAgIGlmIChzdGF0ZS5ibG9jayA9PSBodG1sQmxvY2spIHJldHVybiB7c3RhdGU6IHN0YXRlLmh0bWxTdGF0ZSwgbW9kZTogaHRtbE1vZGV9OwogICAgICBpZiAoc3RhdGUubG9jYWxTdGF0ZSkgcmV0dXJuIHtzdGF0ZTogc3RhdGUubG9jYWxTdGF0ZSwgbW9kZTogc3RhdGUubG9jYWxNb2RlfTsKICAgICAgcmV0dXJuIHtzdGF0ZTogc3RhdGUsIG1vZGU6IG1vZGV9OwogICAgfSwKCiAgICBpbmRlbnQ6IGZ1bmN0aW9uKHN0YXRlLCB0ZXh0QWZ0ZXIsIGxpbmUpIHsKICAgICAgaWYgKHN0YXRlLmJsb2NrID09IGh0bWxCbG9jayAmJiBodG1sTW9kZS5pbmRlbnQpIHJldHVybiBodG1sTW9kZS5pbmRlbnQoc3RhdGUuaHRtbFN0YXRlLCB0ZXh0QWZ0ZXIsIGxpbmUpCiAgICAgIGlmIChzdGF0ZS5sb2NhbFN0YXRlICYmIHN0YXRlLmxvY2FsTW9kZS5pbmRlbnQpIHJldHVybiBzdGF0ZS5sb2NhbE1vZGUuaW5kZW50KHN0YXRlLmxvY2FsU3RhdGUsIHRleHRBZnRlciwgbGluZSkKICAgICAgcmV0dXJuIENvZGVNaXJyb3IuUGFzcwogICAgfSwKCiAgICBibGFua0xpbmU6IGJsYW5rTGluZSwKCiAgICBnZXRUeXBlOiBnZXRUeXBlLAoKICAgIGJsb2NrQ29tbWVudFN0YXJ0OiAiPCEtLSIsCiAgICBibG9ja0NvbW1lbnRFbmQ6ICItLT4iLAogICAgY2xvc2VCcmFja2V0czogIigpW117fScnXCJcImBgIiwKICAgIGZvbGQ6ICJtYXJrZG93biIKICB9OwogIHJldHVybiBtb2RlOwp9LCAieG1sIik7CgpDb2RlTWlycm9yLmRlZmluZU1JTUUoInRleHQvbWFya2Rvd24iLCAibWFya2Rvd24iKTsKCkNvZGVNaXJyb3IuZGVmaW5lTUlNRSgidGV4dC94LW1hcmtkb3duIiwgIm1hcmtkb3duIik7Cgp9KTsK","codemirror/scheme.js":"Ly8gQ29kZU1pcnJvciwgY29weXJpZ2h0IChjKSBieSBNYXJpam4gSGF2ZXJiZWtlIGFuZCBvdGhlcnMKLy8gRGlzdHJpYnV0ZWQgdW5kZXIgYW4gTUlUIGxpY2Vuc2U6IGh0dHBzOi8vY29kZW1pcnJvci5uZXQvTElDRU5TRQoKLyoqCiAqIEF1dGhvcjogS29oIFppIEhhbiwgYmFzZWQgb24gaW1wbGVtZW50YXRpb24gYnkgS29oIFppIENodW4KICovCgooZnVuY3Rpb24obW9kKSB7CiAgaWYgKHR5cGVvZiBleHBvcnRzID09ICJvYmplY3QiICYmIHR5cGVvZiBtb2R1bGUgPT0gIm9iamVjdCIpIC8vIENvbW1vbkpTCiAgICBtb2QocmVxdWlyZSgiLi4vLi4vbGliL2NvZGVtaXJyb3IiKSk7CiAgZWxzZSBpZiAodHlwZW9mIGRlZmluZSA9PSAiZnVuY3Rpb24iICYmIGRlZmluZS5hbWQpIC8vIEFNRAogICAgZGVmaW5lKFsiLi4vLi4vbGliL2NvZGVtaXJyb3IiXSwgbW9kKTsKICBlbHNlIC8vIFBsYWluIGJyb3dzZXIgZW52CiAgICBtb2QoQ29kZU1pcnJvcik7Cn0pKGZ1bmN0aW9uKENvZGVNaXJyb3IpIHsKInVzZSBzdHJpY3QiOwoKQ29kZU1pcnJvci5kZWZpbmVNb2RlKCJzY2hlbWUiLCBmdW5jdGlvbiAoKSB7CiAgICB2YXIgQlVJTFRJTiA9ICJidWlsdGluIiwgQ09NTUVOVCA9ICJjb21tZW50IiwgU1RSSU5HID0gInN0cmluZyIsCiAgICAgICAgQVRPTSA9ICJhdG9tIiwgTlVNQkVSID0gIm51bWJlciIsIEJSQUNLRVQgPSAiYnJhY2tldCI7CiAgICB2YXIgSU5ERU5UX1dPUkRfU0tJUCA9IDI7CgogICAgZnVuY3Rpb24gbWFrZUtleXdvcmRzKHN0cikgewogICAgICAgIHZhciBvYmogPSB7fSwgd29yZHMgPSBzdHIuc3BsaXQoIiAiKTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHdvcmRzLmxlbmd0aDsgKytpKSBvYmpbd29yZHNbaV1dID0gdHJ1ZTsKICAgICAgICByZXR1cm4gb2JqOwogICAgfQoKICAgIHZhciBrZXl3b3JkcyA9IG1ha2VLZXl3b3JkcygizrsgY2FzZS1sYW1iZGEgY2FsbC9jYyBjbGFzcyBkZWZpbmUtY2xhc3MgZXhpdC1oYW5kbGVyIGZpZWxkIGltcG9ydCBpbmhlcml0IGluaXQtZmllbGQgaW50ZXJmYWNlIGxldCotdmFsdWVzIGxldC12YWx1ZXMgbGV0L2VjIG1peGluIG9wdC1sYW1iZGEgb3ZlcnJpZGUgcHJvdGVjdCBwcm92aWRlIHB1YmxpYyByZW5hbWUgcmVxdWlyZSByZXF1aXJlLWZvci1zeW50YXggc3ludGF4IHN5bnRheC1jYXNlIHN5bnRheC1lcnJvciB1bml0L3NpZyB1bmxlc3Mgd2hlbiB3aXRoLXN5bnRheCBhbmQgYmVnaW4gY2FsbC13aXRoLWN1cnJlbnQtY29udGludWF0aW9uIGNhbGwtd2l0aC1pbnB1dC1maWxlIGNhbGwtd2l0aC1vdXRwdXQtZmlsZSBjYXNlIGNvbmQgZGVmaW5lIGRlZmluZS1zeW50YXggZGVsYXkgZG8gZHluYW1pYy13aW5kIGVsc2UgZm9yLWVhY2ggaWYgbGFtYmRhIGxldCBsZXQqIGxldC1zeW50YXggbGV0cmVjIGxldHJlYy1zeW50YXggbWFwIG9yIHN5bnRheC1ydWxlcyBhYnMgYWNvcyBhbmdsZSBhcHBlbmQgYXBwbHkgYXNpbiBhc3NvYyBhc3NxIGFzc3YgYXRhbiBib29sZWFuPyBjYWFyIGNhZHIgY2FsbC13aXRoLWlucHV0LWZpbGUgY2FsbC13aXRoLW91dHB1dC1maWxlIGNhbGwtd2l0aC12YWx1ZXMgY2FyIGNkZGRhciBjZGRkZHIgY2RyIGNlaWxpbmcgY2hhci0+aW50ZWdlciBjaGFyLWFscGhhYmV0aWM/IGNoYXItY2k8PT8gY2hhci1jaTw/IGNoYXItY2k9PyBjaGFyLWNpPj0/IGNoYXItY2k+PyBjaGFyLWRvd25jYXNlIGNoYXItbG93ZXItY2FzZT8gY2hhci1udW1lcmljPyBjaGFyLXJlYWR5PyBjaGFyLXVwY2FzZSBjaGFyLXVwcGVyLWNhc2U/IGNoYXItd2hpdGVzcGFjZT8gY2hhcjw9PyBjaGFyPD8gY2hhcj0/IGNoYXI+PT8gY2hhcj4/IGNoYXI/IGNsb3NlLWlucHV0LXBvcnQgY2xvc2Utb3V0cHV0LXBvcnQgY29tcGxleD8gY29ucyBjb3MgY3VycmVudC1pbnB1dC1wb3J0IGN1cnJlbnQtb3V0cHV0LXBvcnQgZGVub21pbmF0b3IgZGlzcGxheSBlb2Ytb2JqZWN0PyBlcT8gZXF1YWw/IGVxdj8gZXZhbCBldmVuPyBleGFjdC0+aW5leGFjdCBleGFjdD8gZXhwIGV4cHQgI2YgZmxvb3IgZm9yY2UgZ2NkIGltYWctcGFydCBpbmV4YWN0LT5leGFjdCBpbmV4YWN0PyBpbnB1dC1wb3J0PyBpbnRlZ2VyLT5jaGFyIGludGVnZXI/IGludGVyYWN0aW9uLWVudmlyb25tZW50IGxjbSBsZW5ndGggbGlzdCBsaXN0LT5zdHJpbmcgbGlzdC0+dmVjdG9yIGxpc3QtcmVmIGxpc3QtdGFpbCBsaXN0PyBsb2FkIGxvZyBtYWduaXR1ZGUgbWFrZS1wb2xhciBtYWtlLXJlY3Rhbmd1bGFyIG1ha2Utc3RyaW5nIG1ha2UtdmVjdG9yIG1heCBtZW1iZXIgbWVtcSBtZW12IG1pbiBtb2R1bG8gbmVnYXRpdmU/IG5ld2xpbmUgbm90IG51bGwtZW52aXJvbm1lbnQgbnVsbD8gbnVtYmVyLT5zdHJpbmcgbnVtYmVyPyBudW1lcmF0b3Igb2RkPyBvcGVuLWlucHV0LWZpbGUgb3Blbi1vdXRwdXQtZmlsZSBvdXRwdXQtcG9ydD8gcGFpcj8gcGVlay1jaGFyIHBvcnQ/IHBvc2l0aXZlPyBwcm9jZWR1cmU/IHF1YXNpcXVvdGUgcXVvdGUgcXVvdGllbnQgcmF0aW9uYWw/IHJhdGlvbmFsaXplIHJlYWQgcmVhZC1jaGFyIHJlYWwtcGFydCByZWFsPyByZW1haW5kZXIgcmV2ZXJzZSByb3VuZCBzY2hlbWUtcmVwb3J0LWVudmlyb25tZW50IHNldCEgc2V0LWNhciEgc2V0LWNkciEgc2luIHNxcnQgc3RyaW5nIHN0cmluZy0+bGlzdCBzdHJpbmctPm51bWJlciBzdHJpbmctPnN5bWJvbCBzdHJpbmctYXBwZW5kIHN0cmluZy1jaTw9PyBzdHJpbmctY2k8PyBzdHJpbmctY2k9PyBzdHJpbmctY2k+PT8gc3RyaW5nLWNpPj8gc3RyaW5nLWNvcHkgc3RyaW5nLWZpbGwhIHN0cmluZy1sZW5ndGggc3RyaW5nLXJlZiBzdHJpbmctc2V0ISBzdHJpbmc8PT8gc3RyaW5nPD8gc3RyaW5nPT8gc3RyaW5nPj0/IHN0cmluZz4/IHN0cmluZz8gc3Vic3RyaW5nIHN5bWJvbC0+c3RyaW5nIHN5bWJvbD8gI3QgdGFuIHRyYW5zY3JpcHQtb2ZmIHRyYW5zY3JpcHQtb24gdHJ1bmNhdGUgdmFsdWVzIHZlY3RvciB2ZWN0b3ItPmxpc3QgdmVjdG9yLWZpbGwhIHZlY3Rvci1sZW5ndGggdmVjdG9yLXJlZiB2ZWN0b3Itc2V0ISB3aXRoLWlucHV0LWZyb20tZmlsZSB3aXRoLW91dHB1dC10by1maWxlIHdyaXRlIHdyaXRlLWNoYXIgemVybz8iKTsKICAgIHZhciBpbmRlbnRLZXlzID0gbWFrZUtleXdvcmRzKCJkZWZpbmUgbGV0IGxldHJlYyBsZXQqIGxhbWJkYSIpOwoKICAgIGZ1bmN0aW9uIHN0YXRlU3RhY2soaW5kZW50LCB0eXBlLCBwcmV2KSB7IC8vIHJlcHJlc2VudHMgYSBzdGF0ZSBzdGFjayBvYmplY3QKICAgICAgICB0aGlzLmluZGVudCA9IGluZGVudDsKICAgICAgICB0aGlzLnR5cGUgPSB0eXBlOwogICAgICAgIHRoaXMucHJldiA9IHByZXY7CiAgICB9CgogICAgZnVuY3Rpb24gcHVzaFN0YWNrKHN0YXRlLCBpbmRlbnQsIHR5cGUpIHsKICAgICAgICBzdGF0ZS5pbmRlbnRTdGFjayA9IG5ldyBzdGF0ZVN0YWNrKGluZGVudCwgdHlwZSwgc3RhdGUuaW5kZW50U3RhY2spOwogICAgfQoKICAgIGZ1bmN0aW9uIHBvcFN0YWNrKHN0YXRlKSB7CiAgICAgICAgc3RhdGUuaW5kZW50U3RhY2sgPSBzdGF0ZS5pbmRlbnRTdGFjay5wcmV2OwogICAgfQoKICAgIHZhciBiaW5hcnlNYXRjaGVyID0gbmV3IFJlZ0V4cCgvXig/OlstK11pfFstK11bMDFdKyMqKD86XC9bMDFdKyMqKT9pfFstK10/WzAxXSsjKig/OlwvWzAxXSsjKik/QFstK10/WzAxXSsjKig/OlwvWzAxXSsjKik/fFstK10/WzAxXSsjKig/OlwvWzAxXSsjKik/Wy0rXSg/OlswMV0rIyooPzpcL1swMV0rIyopPyk/aXxbLStdP1swMV0rIyooPzpcL1swMV0rIyopPykoPz1bKClcczsiXXwkKS9pKTsKICAgIHZhciBvY3RhbE1hdGNoZXIgPSBuZXcgUmVnRXhwKC9eKD86Wy0rXWl8Wy0rXVswLTddKyMqKD86XC9bMC03XSsjKik/aXxbLStdP1swLTddKyMqKD86XC9bMC03XSsjKik/QFstK10/WzAtN10rIyooPzpcL1swLTddKyMqKT98Wy0rXT9bMC03XSsjKig/OlwvWzAtN10rIyopP1stK10oPzpbMC03XSsjKig/OlwvWzAtN10rIyopPyk/aXxbLStdP1swLTddKyMqKD86XC9bMC03XSsjKik/KSg/PVsoKVxzOyJdfCQpL2kpOwogICAgdmFyIGhleE1hdGNoZXIgPSBuZXcgUmVnRXhwKC9eKD86Wy0rXWl8Wy0rXVtcZGEtZl0rIyooPzpcL1tcZGEtZl0rIyopP2l8Wy0rXT9bXGRhLWZdKyMqKD86XC9bXGRhLWZdKyMqKT9AWy0rXT9bXGRhLWZdKyMqKD86XC9bXGRhLWZdKyMqKT98Wy0rXT9bXGRhLWZdKyMqKD86XC9bXGRhLWZdKyMqKT9bLStdKD86W1xkYS1mXSsjKig/OlwvW1xkYS1mXSsjKik/KT9pfFstK10/W1xkYS1mXSsjKig/OlwvW1xkYS1mXSsjKik/KSg/PVsoKVxzOyJdfCQpL2kpOwogICAgdmFyIGRlY2ltYWxNYXRjaGVyID0gbmV3IFJlZ0V4cCgvXig/OlstK11pfFstK10oPzooPzooPzpcZCsjK1wuPyMqfFxkK1wuXGQqIyp8XC5cZCsjKnxcZCspKD86W2VzZmRsXVstK10/XGQrKT8pfFxkKyMqXC9cZCsjKilpfFstK10/KD86KD86KD86XGQrIytcLj8jKnxcZCtcLlxkKiMqfFwuXGQrIyp8XGQrKSg/Oltlc2ZkbF1bLStdP1xkKyk/KXxcZCsjKlwvXGQrIyopQFstK10/KD86KD86KD86XGQrIytcLj8jKnxcZCtcLlxkKiMqfFwuXGQrIyp8XGQrKSg/Oltlc2ZkbF1bLStdP1xkKyk/KXxcZCsjKlwvXGQrIyopfFstK10/KD86KD86KD86XGQrIytcLj8jKnxcZCtcLlxkKiMqfFwuXGQrIyp8XGQrKSg/Oltlc2ZkbF1bLStdP1xkKyk/KXxcZCsjKlwvXGQrIyopWy0rXSg/Oig/Oig/OlxkKyMrXC4/Iyp8XGQrXC5cZCojKnxcLlxkKyMqfFxkKykoPzpbZXNmZGxdWy0rXT9cZCspPyl8XGQrIypcL1xkKyMqKT9pfCg/Oig/Oig/OlxkKyMrXC4/Iyp8XGQrXC5cZCojKnxcLlxkKyMqfFxkKykoPzpbZXNmZGxdWy0rXT9cZCspPyl8XGQrIypcL1xkKyMqKSkoPz1bKClcczsiXXwkKS9pKTsKCiAgICBmdW5jdGlvbiBpc0JpbmFyeU51bWJlciAoc3RyZWFtKSB7CiAgICAgICAgcmV0dXJuIHN0cmVhbS5tYXRjaChiaW5hcnlNYXRjaGVyKTsKICAgIH0KCiAgICBmdW5jdGlvbiBpc09jdGFsTnVtYmVyIChzdHJlYW0pIHsKICAgICAgICByZXR1cm4gc3RyZWFtLm1hdGNoKG9jdGFsTWF0Y2hlcik7CiAgICB9CgogICAgZnVuY3Rpb24gaXNEZWNpbWFsTnVtYmVyIChzdHJlYW0sIGJhY2t1cCkgewogICAgICAgIGlmIChiYWNrdXAgPT09IHRydWUpIHsKICAgICAgICAgICAgc3RyZWFtLmJhY2tVcCgxKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHN0cmVhbS5tYXRjaChkZWNpbWFsTWF0Y2hlcik7CiAgICB9CgogICAgZnVuY3Rpb24gaXNIZXhOdW1iZXIgKHN0cmVhbSkgewogICAgICAgIHJldHVybiBzdHJlYW0ubWF0Y2goaGV4TWF0Y2hlcik7CiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgICBzdGFydFN0YXRlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICBpbmRlbnRTdGFjazogbnVsbCwKICAgICAgICAgICAgICAgIGluZGVudGF0aW9uOiAwLAogICAgICAgICAgICAgICAgbW9kZTogZmFsc2UsCiAgICAgICAgICAgICAgICBzRXhwckNvbW1lbnQ6IGZhbHNlLAogICAgICAgICAgICAgICAgc0V4cHJRdW90ZTogZmFsc2UKICAgICAgICAgICAgfTsKICAgICAgICB9LAoKICAgICAgICB0b2tlbjogZnVuY3Rpb24gKHN0cmVhbSwgc3RhdGUpIHsKICAgICAgICAgICAgaWYgKHN0YXRlLmluZGVudFN0YWNrID09IG51bGwgJiYgc3RyZWFtLnNvbCgpKSB7CiAgICAgICAgICAgICAgICAvLyB1cGRhdGUgaW5kZW50YXRpb24sIGJ1dCBvbmx5IGlmIGluZGVudFN0YWNrIGlzIGVtcHR5CiAgICAgICAgICAgICAgICBzdGF0ZS5pbmRlbnRhdGlvbiA9IHN0cmVhbS5pbmRlbnRhdGlvbigpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBza2lwIHNwYWNlcwogICAgICAgICAgICBpZiAoc3RyZWFtLmVhdFNwYWNlKCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByZXR1cm5UeXBlID0gbnVsbDsKCiAgICAgICAgICAgIHN3aXRjaChzdGF0ZS5tb2RlKXsKICAgICAgICAgICAgICAgIGNhc2UgInN0cmluZyI6IC8vIG11bHRpLWxpbmUgc3RyaW5nIHBhcnNpbmcgbW9kZQogICAgICAgICAgICAgICAgICAgIHZhciBuZXh0LCBlc2NhcGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKChuZXh0ID0gc3RyZWFtLm5leHQoKSkgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAobmV4dCA9PSAiXCIiICYmICFlc2NhcGVkKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZXNjYXBlZCA9ICFlc2NhcGVkICYmIG5leHQgPT0gIlxcIjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuVHlwZSA9IFNUUklORzsgLy8gY29udGludWUgb24gaW4gc2NoZW1lLXN0cmluZyBtb2RlCiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICJjb21tZW50IjogLy8gY29tbWVudCBwYXJzaW5nIG1vZGUKICAgICAgICAgICAgICAgICAgICB2YXIgbmV4dCwgbWF5YmVFbmQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB3aGlsZSAoKG5leHQgPSBzdHJlYW0ubmV4dCgpKSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZXh0ID09ICIjIiAmJiBtYXliZUVuZCkgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIG1heWJlRW5kID0gKG5leHQgPT0gInwiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuVHlwZSA9IENPTU1FTlQ7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICJzLWV4cHItY29tbWVudCI6IC8vIHMtZXhwciBjb21tZW50aW5nIG1vZGUKICAgICAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgaWYoc3RyZWFtLnBlZWsoKSA9PSAiKCIgfHwgc3RyZWFtLnBlZWsoKSA9PSAiWyIpewogICAgICAgICAgICAgICAgICAgICAgICAvLyBhY3R1YWxseSBzdGFydCBzY2hlbWUgcy1leHByIGNvbW1lbnRpbmcgbW9kZQogICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5zRXhwckNvbW1lbnQgPSAwOwogICAgICAgICAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgICAgICAgICAvLyBpZiBub3Qgd2UganVzdCBjb21tZW50IHRoZSBlbnRpcmUgb2YgdGhlIG5leHQgdG9rZW4KICAgICAgICAgICAgICAgICAgICAgICAgc3RyZWFtLmVhdFdoaWxlKC9bXlxzXChcKVxbXF1dLyk7IC8vIGVhdCBzeW1ib2wgYXRvbQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm5UeXBlID0gQ09NTUVOVDsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZGVmYXVsdDogLy8gZGVmYXVsdCBwYXJzaW5nIG1vZGUKICAgICAgICAgICAgICAgICAgICB2YXIgY2ggPSBzdHJlYW0ubmV4dCgpOwoKICAgICAgICAgICAgICAgICAgICBpZiAoY2ggPT0gIlwiIikgewogICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gInN0cmluZyI7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVyblR5cGUgPSBTVFJJTkc7CgogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY2ggPT0gIiciKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdHJlYW0ucGVlaygpID09ICIoIiB8fCBzdHJlYW0ucGVlaygpID09ICJbIil7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHN0YXRlLnNFeHByUXVvdGUgIT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5zRXhwclF1b3RlID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gLy8gZWxzZSBhbHJlYWR5IGluIGEgcXVvdGVkIGV4cHJlc3Npb24KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVyblR5cGUgPSBBVE9NOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyZWFtLmVhdFdoaWxlKC9bXHdfXC0hJCUmKitcLlwvOjw9Pj9AXF5+XS8pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuVHlwZSA9IEFUT007CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNoID09ICcjJykgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3RyZWFtLmVhdCgifCIpKSB7ICAgICAgICAgICAgICAgICAgICAvLyBNdWx0aS1saW5lIGNvbW1lbnQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSAiY29tbWVudCI7IC8vIHRvZ2dsZSB0byBjb21tZW50IG1vZGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVyblR5cGUgPSBDT01NRU5UOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0cmVhbS5lYXQoL1t0Zl0vaSkpIHsgICAgICAgICAgICAvLyAjdC8jZiAoYXRvbSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVyblR5cGUgPSBBVE9NOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0cmVhbS5lYXQoJzsnKSkgeyAgICAgICAgICAgICAgICAvLyBTLUV4cHIgY29tbWVudAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9ICJzLWV4cHItY29tbWVudCI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm5UeXBlID0gQ09NTUVOVDsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBudW1UZXN0ID0gbnVsbCwgaGFzRXhhY3RuZXNzID0gZmFsc2UsIGhhc1JhZGl4ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdHJlYW0uZWF0KC9bZWldL2kpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFzRXhhY3RuZXNzID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyZWFtLmJhY2tVcCgxKTsgICAgICAgLy8gbXVzdCBiZSByYWRpeCBzcGVjaWZpZXIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdHJlYW0ubWF0Y2goL14jYi9pKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG51bVRlc3QgPSBpc0JpbmFyeU51bWJlcjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RyZWFtLm1hdGNoKC9eI28vaSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBudW1UZXN0ID0gaXNPY3RhbE51bWJlcjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RyZWFtLm1hdGNoKC9eI3gvaSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBudW1UZXN0ID0gaXNIZXhOdW1iZXI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0cmVhbS5tYXRjaCgvXiNkL2kpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbnVtVGVzdCA9IGlzRGVjaW1hbE51bWJlcjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RyZWFtLm1hdGNoKC9eWy0rMC05Ll0vLCBmYWxzZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYXNSYWRpeCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG51bVRlc3QgPSBpc0RlY2ltYWxOdW1iZXI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyByZS1jb25zdW1lIHRoZSBpbnRpYWwgIyBpZiBhbGwgbWF0Y2hlcyBmYWlsZWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIWhhc0V4YWN0bmVzcykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0cmVhbS5lYXQoJyMnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChudW1UZXN0ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGFzUmFkaXggJiYgIWhhc0V4YWN0bmVzcykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBjb25zdW1lIG9wdGlvbmFsIGV4YWN0bmVzcyBhZnRlciByYWRpeAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJlYW0ubWF0Y2goL14jW2VpXS9pKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG51bVRlc3Qoc3RyZWFtKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuVHlwZSA9IE5VTUJFUjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoL15bLSswLTkuXS8udGVzdChjaCkgJiYgaXNEZWNpbWFsTnVtYmVyKHN0cmVhbSwgdHJ1ZSkpIHsgLy8gbWF0Y2ggbm9uLXByZWZpeGVkIG51bWJlciwgbXVzdCBiZSBkZWNpbWFsCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVyblR5cGUgPSBOVU1CRVI7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjaCA9PSAiOyIpIHsgLy8gY29tbWVudAogICAgICAgICAgICAgICAgICAgICAgICBzdHJlYW0uc2tpcFRvRW5kKCk7IC8vIHJlc3Qgb2YgdGhlIGxpbmUgaXMgYSBjb21tZW50CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVyblR5cGUgPSBDT01NRU5UOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY2ggPT0gIigiIHx8IGNoID09ICJbIikgewogICAgICAgICAgICAgICAgICAgICAgdmFyIGtleVdvcmQgPSAnJzsgdmFyIGluZGVudFRlbXAgPSBzdHJlYW0uY29sdW1uKCksIGxldHRlcjsKICAgICAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICAgIEVpdGhlcgogICAgICAgICAgICAgICAgICAgICAgICAoaW5kZW50LXdvcmQgLi4KICAgICAgICAgICAgICAgICAgICAgICAgKG5vbi1pbmRlbnQtd29yZCAuLgogICAgICAgICAgICAgICAgICAgICAgICAoO3NvbWV0aGluZyBlbHNlLCBicmFja2V0LCBldGMuCiAgICAgICAgICAgICAgICAgICAgICAgICovCgogICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAoKGxldHRlciA9IHN0cmVhbS5lYXQoL1teXHNcKFxbXDtcKVxdXS8pKSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBrZXlXb3JkICs9IGxldHRlcjsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGtleVdvcmQubGVuZ3RoID4gMCAmJiBpbmRlbnRLZXlzLnByb3BlcnR5SXNFbnVtZXJhYmxlKGtleVdvcmQpKSB7IC8vIGluZGVudC13b3JkCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcHVzaFN0YWNrKHN0YXRlLCBpbmRlbnRUZW1wICsgSU5ERU5UX1dPUkRfU0tJUCwgY2gpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgeyAvLyBub24taW5kZW50IHdvcmQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdlIGNvbnRpbnVlIGVhdGluZyB0aGUgc3BhY2VzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJlYW0uZWF0U3BhY2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdHJlYW0uZW9sKCkgfHwgc3RyZWFtLnBlZWsoKSA9PSAiOyIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBub3RoaW5nIHNpZ25pZmljYW50IGFmdGVyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2UgcmVzdGFydCBpbmRlbnRhdGlvbiAxIHNwYWNlIGFmdGVyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHVzaFN0YWNrKHN0YXRlLCBpbmRlbnRUZW1wICsgMSwgY2gpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwdXNoU3RhY2soc3RhdGUsIGluZGVudFRlbXAgKyBzdHJlYW0uY3VycmVudCgpLmxlbmd0aCwgY2gpOyAvLyBlbHNlIHdlIG1hdGNoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgc3RyZWFtLmJhY2tVcChzdHJlYW0uY3VycmVudCgpLmxlbmd0aCAtIDEpOyAvLyB1bmRvIGFsbCB0aGUgZWF0aW5nCgogICAgICAgICAgICAgICAgICAgICAgICBpZih0eXBlb2Ygc3RhdGUuc0V4cHJDb21tZW50ID09ICJudW1iZXIiKSBzdGF0ZS5zRXhwckNvbW1lbnQrKzsKICAgICAgICAgICAgICAgICAgICAgICAgaWYodHlwZW9mIHN0YXRlLnNFeHByUXVvdGUgPT0gIm51bWJlciIpIHN0YXRlLnNFeHByUXVvdGUrKzsKCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVyblR5cGUgPSBCUkFDS0VUOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY2ggPT0gIikiIHx8IGNoID09ICJdIikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm5UeXBlID0gQlJBQ0tFVDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLmluZGVudFN0YWNrICE9IG51bGwgJiYgc3RhdGUuaW5kZW50U3RhY2sudHlwZSA9PSAoY2ggPT0gIikiID8gIigiIDogIlsiKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9wU3RhY2soc3RhdGUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHR5cGVvZiBzdGF0ZS5zRXhwckNvbW1lbnQgPT0gIm51bWJlciIpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKC0tc3RhdGUuc0V4cHJDb21tZW50ID09IDApewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm5UeXBlID0gQ09NTUVOVDsgLy8gZmluYWwgY2xvc2luZyBicmFja2V0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLnNFeHByQ29tbWVudCA9IGZhbHNlOyAvLyB0dXJuIG9mZiBzLWV4cHIgY29tbWVudGluZyBtb2RlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYodHlwZW9mIHN0YXRlLnNFeHByUXVvdGUgPT0gIm51bWJlciIpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKC0tc3RhdGUuc0V4cHJRdW90ZSA9PSAwKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuVHlwZSA9IEFUT007IC8vIGZpbmFsIGNsb3NpbmcgYnJhY2tldAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5zRXhwclF1b3RlID0gZmFsc2U7IC8vIHR1cm4gb2ZmIHMtZXhwciBxdW90ZSBtb2RlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3RyZWFtLmVhdFdoaWxlKC9bXHdfXC0hJCUmKitcLlwvOjw9Pj9AXF5+XS8pOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGtleXdvcmRzICYmIGtleXdvcmRzLnByb3BlcnR5SXNFbnVtZXJhYmxlKHN0cmVhbS5jdXJyZW50KCkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm5UeXBlID0gQlVJTFRJTjsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHJldHVyblR5cGUgPSAidmFyaWFibGUiOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gKHR5cGVvZiBzdGF0ZS5zRXhwckNvbW1lbnQgPT0gIm51bWJlciIpID8gQ09NTUVOVCA6ICgodHlwZW9mIHN0YXRlLnNFeHByUXVvdGUgPT0gIm51bWJlciIpID8gQVRPTSA6IHJldHVyblR5cGUpOwogICAgICAgIH0sCgogICAgICAgIGluZGVudDogZnVuY3Rpb24gKHN0YXRlKSB7CiAgICAgICAgICAgIGlmIChzdGF0ZS5pbmRlbnRTdGFjayA9PSBudWxsKSByZXR1cm4gc3RhdGUuaW5kZW50YXRpb247CiAgICAgICAgICAgIHJldHVybiBzdGF0ZS5pbmRlbnRTdGFjay5pbmRlbnQ7CiAgICAgICAgfSwKCiAgICAgICAgY2xvc2VCcmFja2V0czoge3BhaXJzOiAiKClbXXt9XCJcIiJ9LAogICAgICAgIGxpbmVDb21tZW50OiAiOzsiCiAgICB9Owp9KTsKCkNvZGVNaXJyb3IuZGVmaW5lTUlNRSgidGV4dC94LXNjaGVtZSIsICJzY2hlbWUiKTsKCn0pOwo=","codemirror/matchbrackets.js":"Ly8gQ29kZU1pcnJvciwgY29weXJpZ2h0IChjKSBieSBNYXJpam4gSGF2ZXJiZWtlIGFuZCBvdGhlcnMKLy8gRGlzdHJpYnV0ZWQgdW5kZXIgYW4gTUlUIGxpY2Vuc2U6IGh0dHBzOi8vY29kZW1pcnJvci5uZXQvTElDRU5TRQoKKGZ1bmN0aW9uKG1vZCkgewogIGlmICh0eXBlb2YgZXhwb3J0cyA9PSAib2JqZWN0IiAmJiB0eXBlb2YgbW9kdWxlID09ICJvYmplY3QiKSAvLyBDb21tb25KUwogICAgbW9kKHJlcXVpcmUoIi4uLy4uL2xpYi9jb2RlbWlycm9yIikpOwogIGVsc2UgaWYgKHR5cGVvZiBkZWZpbmUgPT0gImZ1bmN0aW9uIiAmJiBkZWZpbmUuYW1kKSAvLyBBTUQKICAgIGRlZmluZShbIi4uLy4uL2xpYi9jb2RlbWlycm9yIl0sIG1vZCk7CiAgZWxzZSAvLyBQbGFpbiBicm93c2VyIGVudgogICAgbW9kKENvZGVNaXJyb3IpOwp9KShmdW5jdGlvbihDb2RlTWlycm9yKSB7CiAgdmFyIGllX2x0OCA9IC9NU0lFIFxkLy50ZXN0KG5hdmlnYXRvci51c2VyQWdlbnQpICYmCiAgICAoZG9jdW1lbnQuZG9jdW1lbnRNb2RlID09IG51bGwgfHwgZG9jdW1lbnQuZG9jdW1lbnRNb2RlIDwgOCk7CgogIHZhciBQb3MgPSBDb2RlTWlycm9yLlBvczsKCiAgdmFyIG1hdGNoaW5nID0geyIoIjogIik+IiwgIikiOiAiKDwiLCAiWyI6ICJdPiIsICJdIjogIls8IiwgInsiOiAifT4iLCAifSI6ICJ7PCIsICI8IjogIj4+IiwgIj4iOiAiPDwifTsKCiAgZnVuY3Rpb24gYnJhY2tldFJlZ2V4KGNvbmZpZykgewogICAgcmV0dXJuIGNvbmZpZyAmJiBjb25maWcuYnJhY2tldFJlZ2V4IHx8IC9bKCl7fVtcXV0vCiAgfQoKICBmdW5jdGlvbiBmaW5kTWF0Y2hpbmdCcmFja2V0KGNtLCB3aGVyZSwgY29uZmlnKSB7CiAgICB2YXIgbGluZSA9IGNtLmdldExpbmVIYW5kbGUod2hlcmUubGluZSksIHBvcyA9IHdoZXJlLmNoIC0gMTsKICAgIHZhciBhZnRlckN1cnNvciA9IGNvbmZpZyAmJiBjb25maWcuYWZ0ZXJDdXJzb3IKICAgIGlmIChhZnRlckN1cnNvciA9PSBudWxsKQogICAgICBhZnRlckN1cnNvciA9IC8oXnwgKWNtLWZhdC1jdXJzb3IoJHwgKS8udGVzdChjbS5nZXRXcmFwcGVyRWxlbWVudCgpLmNsYXNzTmFtZSkKICAgIHZhciByZSA9IGJyYWNrZXRSZWdleChjb25maWcpCgogICAgLy8gQSBjdXJzb3IgaXMgZGVmaW5lZCBhcyBiZXR3ZWVuIHR3byBjaGFyYWN0ZXJzLCBidXQgaW4gaW4gdmltIGNvbW1hbmQgbW9kZQogICAgLy8gKGkuZS4gbm90IGluc2VydCBtb2RlKSwgdGhlIGN1cnNvciBpcyB2aXN1YWxseSByZXByZXNlbnRlZCBhcyBhCiAgICAvLyBoaWdobGlnaHRlZCBib3ggb24gdG9wIG9mIHRoZSAybmQgY2hhcmFjdGVyLiBPdGhlcndpc2UsIHdlIGFsbG93IG1hdGNoZXMKICAgIC8vIGZyb20gYmVmb3JlIG9yIGFmdGVyIHRoZSBjdXJzb3IuCiAgICB2YXIgbWF0Y2ggPSAoIWFmdGVyQ3Vyc29yICYmIHBvcyA+PSAwICYmIHJlLnRlc3QobGluZS50ZXh0LmNoYXJBdChwb3MpKSAmJiBtYXRjaGluZ1tsaW5lLnRleHQuY2hhckF0KHBvcyldKSB8fAogICAgICAgIHJlLnRlc3QobGluZS50ZXh0LmNoYXJBdChwb3MgKyAxKSkgJiYgbWF0Y2hpbmdbbGluZS50ZXh0LmNoYXJBdCgrK3BvcyldOwogICAgaWYgKCFtYXRjaCkgcmV0dXJuIG51bGw7CiAgICB2YXIgZGlyID0gbWF0Y2guY2hhckF0KDEpID09ICI+IiA/IDEgOiAtMTsKICAgIGlmIChjb25maWcgJiYgY29uZmlnLnN0cmljdCAmJiAoZGlyID4gMCkgIT0gKHBvcyA9PSB3aGVyZS5jaCkpIHJldHVybiBudWxsOwogICAgdmFyIHN0eWxlID0gY20uZ2V0VG9rZW5UeXBlQXQoUG9zKHdoZXJlLmxpbmUsIHBvcyArIDEpKTsKCiAgICB2YXIgZm91bmQgPSBzY2FuRm9yQnJhY2tldChjbSwgUG9zKHdoZXJlLmxpbmUsIHBvcyArIChkaXIgPiAwID8gMSA6IDApKSwgZGlyLCBzdHlsZSB8fCBudWxsLCBjb25maWcpOwogICAgaWYgKGZvdW5kID09IG51bGwpIHJldHVybiBudWxsOwogICAgcmV0dXJuIHtmcm9tOiBQb3Mod2hlcmUubGluZSwgcG9zKSwgdG86IGZvdW5kICYmIGZvdW5kLnBvcywKICAgICAgICAgICAgbWF0Y2g6IGZvdW5kICYmIGZvdW5kLmNoID09IG1hdGNoLmNoYXJBdCgwKSwgZm9yd2FyZDogZGlyID4gMH07CiAgfQoKICAvLyBicmFja2V0UmVnZXggaXMgdXNlZCB0byBzcGVjaWZ5IHdoaWNoIHR5cGUgb2YgYnJhY2tldCB0byBzY2FuCiAgLy8gc2hvdWxkIGJlIGEgcmVnZXhwLCBlLmcuIC9bW1xdXS8KICAvLwogIC8vIE5vdGU6IElmICJ3aGVyZSIgaXMgb24gYW4gb3BlbiBicmFja2V0LCB0aGVuIHRoaXMgYnJhY2tldCBpcyBpZ25vcmVkLgogIC8vCiAgLy8gUmV0dXJucyBmYWxzZSB3aGVuIG5vIGJyYWNrZXQgd2FzIGZvdW5kLCBudWxsIHdoZW4gaXQgcmVhY2hlZAogIC8vIG1heFNjYW5MaW5lcyBhbmQgZ2F2ZSB1cAogIGZ1bmN0aW9uIHNjYW5Gb3JCcmFja2V0KGNtLCB3aGVyZSwgZGlyLCBzdHlsZSwgY29uZmlnKSB7CiAgICB2YXIgbWF4U2NhbkxlbiA9IChjb25maWcgJiYgY29uZmlnLm1heFNjYW5MaW5lTGVuZ3RoKSB8fCAxMDAwMDsKICAgIHZhciBtYXhTY2FuTGluZXMgPSAoY29uZmlnICYmIGNvbmZpZy5tYXhTY2FuTGluZXMpIHx8IDEwMDA7CgogICAgdmFyIHN0YWNrID0gW107CiAgICB2YXIgcmUgPSBicmFja2V0UmVnZXgoY29uZmlnKQogICAgdmFyIGxpbmVFbmQgPSBkaXIgPiAwID8gTWF0aC5taW4od2hlcmUubGluZSArIG1heFNjYW5MaW5lcywgY20ubGFzdExpbmUoKSArIDEpCiAgICAgICAgICAgICAgICAgICAgICAgICAgOiBNYXRoLm1heChjbS5maXJzdExpbmUoKSAtIDEsIHdoZXJlLmxpbmUgLSBtYXhTY2FuTGluZXMpOwogICAgZm9yICh2YXIgbGluZU5vID0gd2hlcmUubGluZTsgbGluZU5vICE9IGxpbmVFbmQ7IGxpbmVObyArPSBkaXIpIHsKICAgICAgdmFyIGxpbmUgPSBjbS5nZXRMaW5lKGxpbmVObyk7CiAgICAgIGlmICghbGluZSkgY29udGludWU7CiAgICAgIHZhciBwb3MgPSBkaXIgPiAwID8gMCA6IGxpbmUubGVuZ3RoIC0gMSwgZW5kID0gZGlyID4gMCA/IGxpbmUubGVuZ3RoIDogLTE7CiAgICAgIGlmIChsaW5lLmxlbmd0aCA+IG1heFNjYW5MZW4pIGNvbnRpbnVlOwogICAgICBpZiAobGluZU5vID09IHdoZXJlLmxpbmUpIHBvcyA9IHdoZXJlLmNoIC0gKGRpciA8IDAgPyAxIDogMCk7CiAgICAgIGZvciAoOyBwb3MgIT0gZW5kOyBwb3MgKz0gZGlyKSB7CiAgICAgICAgdmFyIGNoID0gbGluZS5jaGFyQXQocG9zKTsKICAgICAgICBpZiAocmUudGVzdChjaCkgJiYgKHN0eWxlID09PSB1bmRlZmluZWQgfHwgY20uZ2V0VG9rZW5UeXBlQXQoUG9zKGxpbmVObywgcG9zICsgMSkpID09IHN0eWxlKSkgewogICAgICAgICAgdmFyIG1hdGNoID0gbWF0Y2hpbmdbY2hdOwogICAgICAgICAgaWYgKG1hdGNoICYmIChtYXRjaC5jaGFyQXQoMSkgPT0gIj4iKSA9PSAoZGlyID4gMCkpIHN0YWNrLnB1c2goY2gpOwogICAgICAgICAgZWxzZSBpZiAoIXN0YWNrLmxlbmd0aCkgcmV0dXJuIHtwb3M6IFBvcyhsaW5lTm8sIHBvcyksIGNoOiBjaH07CiAgICAgICAgICBlbHNlIHN0YWNrLnBvcCgpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIGxpbmVObyAtIGRpciA9PSAoZGlyID4gMCA/IGNtLmxhc3RMaW5lKCkgOiBjbS5maXJzdExpbmUoKSkgPyBmYWxzZSA6IG51bGw7CiAgfQoKICBmdW5jdGlvbiBtYXRjaEJyYWNrZXRzKGNtLCBhdXRvY2xlYXIsIGNvbmZpZykgewogICAgLy8gRGlzYWJsZSBicmFjZSBtYXRjaGluZyBpbiBsb25nIGxpbmVzLCBzaW5jZSBpdCdsbCBjYXVzZSBodWdlbHkgc2xvdyB1cGRhdGVzCiAgICB2YXIgbWF4SGlnaGxpZ2h0TGVuID0gY20uc3RhdGUubWF0Y2hCcmFja2V0cy5tYXhIaWdobGlnaHRMaW5lTGVuZ3RoIHx8IDEwMDA7CiAgICB2YXIgbWFya3MgPSBbXSwgcmFuZ2VzID0gY20ubGlzdFNlbGVjdGlvbnMoKTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmFuZ2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBtYXRjaCA9IHJhbmdlc1tpXS5lbXB0eSgpICYmIGZpbmRNYXRjaGluZ0JyYWNrZXQoY20sIHJhbmdlc1tpXS5oZWFkLCBjb25maWcpOwogICAgICBpZiAobWF0Y2ggJiYgY20uZ2V0TGluZShtYXRjaC5mcm9tLmxpbmUpLmxlbmd0aCA8PSBtYXhIaWdobGlnaHRMZW4pIHsKICAgICAgICB2YXIgc3R5bGUgPSBtYXRjaC5tYXRjaCA/ICJDb2RlTWlycm9yLW1hdGNoaW5nYnJhY2tldCIgOiAiQ29kZU1pcnJvci1ub25tYXRjaGluZ2JyYWNrZXQiOwogICAgICAgIG1hcmtzLnB1c2goY20ubWFya1RleHQobWF0Y2guZnJvbSwgUG9zKG1hdGNoLmZyb20ubGluZSwgbWF0Y2guZnJvbS5jaCArIDEpLCB7Y2xhc3NOYW1lOiBzdHlsZX0pKTsKICAgICAgICBpZiAobWF0Y2gudG8gJiYgY20uZ2V0TGluZShtYXRjaC50by5saW5lKS5sZW5ndGggPD0gbWF4SGlnaGxpZ2h0TGVuKQogICAgICAgICAgbWFya3MucHVzaChjbS5tYXJrVGV4dChtYXRjaC50bywgUG9zKG1hdGNoLnRvLmxpbmUsIG1hdGNoLnRvLmNoICsgMSksIHtjbGFzc05hbWU6IHN0eWxlfSkpOwogICAgICB9CiAgICB9CgogICAgaWYgKG1hcmtzLmxlbmd0aCkgewogICAgICAvLyBLbHVkZ2UgdG8gd29yayBhcm91bmQgdGhlIElFIGJ1ZyBmcm9tIGlzc3VlICMxMTkzLCB3aGVyZSB0ZXh0CiAgICAgIC8vIGlucHV0IHN0b3BzIGdvaW5nIHRvIHRoZSB0ZXh0YXJlIHdoZXZlciB0aGlzIGZpcmVzLgogICAgICBpZiAoaWVfbHQ4ICYmIGNtLnN0YXRlLmZvY3VzZWQpIGNtLmZvY3VzKCk7CgogICAgICB2YXIgY2xlYXIgPSBmdW5jdGlvbigpIHsKICAgICAgICBjbS5vcGVyYXRpb24oZnVuY3Rpb24oKSB7CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG1hcmtzLmxlbmd0aDsgaSsrKSBtYXJrc1tpXS5jbGVhcigpOwogICAgICAgIH0pOwogICAgICB9OwogICAgICBpZiAoYXV0b2NsZWFyKSBzZXRUaW1lb3V0KGNsZWFyLCA4MDApOwogICAgICBlbHNlIHJldHVybiBjbGVhcjsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGRvTWF0Y2hCcmFja2V0cyhjbSkgewogICAgY20ub3BlcmF0aW9uKGZ1bmN0aW9uKCkgewogICAgICBpZiAoY20uc3RhdGUubWF0Y2hCcmFja2V0cy5jdXJyZW50bHlIaWdobGlnaHRlZCkgewogICAgICAgIGNtLnN0YXRlLm1hdGNoQnJhY2tldHMuY3VycmVudGx5SGlnaGxpZ2h0ZWQoKTsKICAgICAgICBjbS5zdGF0ZS5tYXRjaEJyYWNrZXRzLmN1cnJlbnRseUhpZ2hsaWdodGVkID0gbnVsbDsKICAgICAgfQogICAgICBjbS5zdGF0ZS5tYXRjaEJyYWNrZXRzLmN1cnJlbnRseUhpZ2hsaWdodGVkID0gbWF0Y2hCcmFja2V0cyhjbSwgZmFsc2UsIGNtLnN0YXRlLm1hdGNoQnJhY2tldHMpOwogICAgfSk7CiAgfQoKICBDb2RlTWlycm9yLmRlZmluZU9wdGlvbigibWF0Y2hCcmFja2V0cyIsIGZhbHNlLCBmdW5jdGlvbihjbSwgdmFsLCBvbGQpIHsKICAgIGlmIChvbGQgJiYgb2xkICE9IENvZGVNaXJyb3IuSW5pdCkgewogICAgICBjbS5vZmYoImN1cnNvckFjdGl2aXR5IiwgZG9NYXRjaEJyYWNrZXRzKTsKICAgICAgaWYgKGNtLnN0YXRlLm1hdGNoQnJhY2tldHMgJiYgY20uc3RhdGUubWF0Y2hCcmFja2V0cy5jdXJyZW50bHlIaWdobGlnaHRlZCkgewogICAgICAgIGNtLnN0YXRlLm1hdGNoQnJhY2tldHMuY3VycmVudGx5SGlnaGxpZ2h0ZWQoKTsKICAgICAgICBjbS5zdGF0ZS5tYXRjaEJyYWNrZXRzLmN1cnJlbnRseUhpZ2hsaWdodGVkID0gbnVsbDsKICAgICAgfQogICAgfQogICAgaWYgKHZhbCkgewogICAgICBjbS5zdGF0ZS5tYXRjaEJyYWNrZXRzID0gdHlwZW9mIHZhbCA9PSAib2JqZWN0IiA/IHZhbCA6IHt9OwogICAgICBjbS5vbigiY3Vyc29yQWN0aXZpdHkiLCBkb01hdGNoQnJhY2tldHMpOwogICAgfQogIH0pOwoKICBDb2RlTWlycm9yLmRlZmluZUV4dGVuc2lvbigibWF0Y2hCcmFja2V0cyIsIGZ1bmN0aW9uKCkge21hdGNoQnJhY2tldHModGhpcywgdHJ1ZSk7fSk7CiAgQ29kZU1pcnJvci5kZWZpbmVFeHRlbnNpb24oImZpbmRNYXRjaGluZ0JyYWNrZXQiLCBmdW5jdGlvbihwb3MsIGNvbmZpZywgb2xkQ29uZmlnKXsKICAgIC8vIEJhY2t3YXJkcy1jb21wYXRpYmlsaXR5IGtsdWRnZQogICAgaWYgKG9sZENvbmZpZyB8fCB0eXBlb2YgY29uZmlnID09ICJib29sZWFuIikgewogICAgICBpZiAoIW9sZENvbmZpZykgewogICAgICAgIGNvbmZpZyA9IGNvbmZpZyA/IHtzdHJpY3Q6IHRydWV9IDogbnVsbAogICAgICB9IGVsc2UgewogICAgICAgIG9sZENvbmZpZy5zdHJpY3QgPSBjb25maWcKICAgICAgICBjb25maWcgPSBvbGRDb25maWcKICAgICAgfQogICAgfQogICAgcmV0dXJuIGZpbmRNYXRjaGluZ0JyYWNrZXQodGhpcywgcG9zLCBjb25maWcpCiAgfSk7CiAgQ29kZU1pcnJvci5kZWZpbmVFeHRlbnNpb24oInNjYW5Gb3JCcmFja2V0IiwgZnVuY3Rpb24ocG9zLCBkaXIsIHN0eWxlLCBjb25maWcpewogICAgcmV0dXJuIHNjYW5Gb3JCcmFja2V0KHRoaXMsIHBvcywgZGlyLCBzdHlsZSwgY29uZmlnKTsKICB9KTsKfSk7Cg==","codemirror/javascript.js":"Ly8gQ29kZU1pcnJvciwgY29weXJpZ2h0IChjKSBieSBNYXJpam4gSGF2ZXJiZWtlIGFuZCBvdGhlcnMKLy8gRGlzdHJpYnV0ZWQgdW5kZXIgYW4gTUlUIGxpY2Vuc2U6IGh0dHBzOi8vY29kZW1pcnJvci5uZXQvTElDRU5TRQoKKGZ1bmN0aW9uKG1vZCkgewogIGlmICh0eXBlb2YgZXhwb3J0cyA9PSAib2JqZWN0IiAmJiB0eXBlb2YgbW9kdWxlID09ICJvYmplY3QiKSAvLyBDb21tb25KUwogICAgbW9kKHJlcXVpcmUoIi4uLy4uL2xpYi9jb2RlbWlycm9yIikpOwogIGVsc2UgaWYgKHR5cGVvZiBkZWZpbmUgPT0gImZ1bmN0aW9uIiAmJiBkZWZpbmUuYW1kKSAvLyBBTUQKICAgIGRlZmluZShbIi4uLy4uL2xpYi9jb2RlbWlycm9yIl0sIG1vZCk7CiAgZWxzZSAvLyBQbGFpbiBicm93c2VyIGVudgogICAgbW9kKENvZGVNaXJyb3IpOwp9KShmdW5jdGlvbihDb2RlTWlycm9yKSB7CiJ1c2Ugc3RyaWN0IjsKCkNvZGVNaXJyb3IuZGVmaW5lTW9kZSgiamF2YXNjcmlwdCIsIGZ1bmN0aW9uKGNvbmZpZywgcGFyc2VyQ29uZmlnKSB7CiAgdmFyIGluZGVudFVuaXQgPSBjb25maWcuaW5kZW50VW5pdDsKICB2YXIgc3RhdGVtZW50SW5kZW50ID0gcGFyc2VyQ29uZmlnLnN0YXRlbWVudEluZGVudDsKICB2YXIganNvbmxkTW9kZSA9IHBhcnNlckNvbmZpZy5qc29ubGQ7CiAgdmFyIGpzb25Nb2RlID0gcGFyc2VyQ29uZmlnLmpzb24gfHwganNvbmxkTW9kZTsKICB2YXIgaXNUUyA9IHBhcnNlckNvbmZpZy50eXBlc2NyaXB0OwogIHZhciB3b3JkUkUgPSBwYXJzZXJDb25maWcud29yZENoYXJhY3RlcnMgfHwgL1tcdyRceGExLVx1ZmZmZl0vOwoKICAvLyBUb2tlbml6ZXIKCiAgdmFyIGtleXdvcmRzID0gZnVuY3Rpb24oKXsKICAgIGZ1bmN0aW9uIGt3KHR5cGUpIHtyZXR1cm4ge3R5cGU6IHR5cGUsIHN0eWxlOiAia2V5d29yZCJ9O30KICAgIHZhciBBID0ga3coImtleXdvcmQgYSIpLCBCID0ga3coImtleXdvcmQgYiIpLCBDID0ga3coImtleXdvcmQgYyIpLCBEID0ga3coImtleXdvcmQgZCIpOwogICAgdmFyIG9wZXJhdG9yID0ga3coIm9wZXJhdG9yIiksIGF0b20gPSB7dHlwZTogImF0b20iLCBzdHlsZTogImF0b20ifTsKCiAgICByZXR1cm4gewogICAgICAiaWYiOiBrdygiaWYiKSwgIndoaWxlIjogQSwgIndpdGgiOiBBLCAiZWxzZSI6IEIsICJkbyI6IEIsICJ0cnkiOiBCLCAiZmluYWxseSI6IEIsCiAgICAgICJyZXR1cm4iOiBELCAiYnJlYWsiOiBELCAiY29udGludWUiOiBELCAibmV3Ijoga3coIm5ldyIpLCAiZGVsZXRlIjogQywgInZvaWQiOiBDLCAidGhyb3ciOiBDLAogICAgICAiZGVidWdnZXIiOiBrdygiZGVidWdnZXIiKSwgInZhciI6IGt3KCJ2YXIiKSwgImNvbnN0Ijoga3coInZhciIpLCAibGV0Ijoga3coInZhciIpLAogICAgICAiZnVuY3Rpb24iOiBrdygiZnVuY3Rpb24iKSwgImNhdGNoIjoga3coImNhdGNoIiksCiAgICAgICJmb3IiOiBrdygiZm9yIiksICJzd2l0Y2giOiBrdygic3dpdGNoIiksICJjYXNlIjoga3coImNhc2UiKSwgImRlZmF1bHQiOiBrdygiZGVmYXVsdCIpLAogICAgICAiaW4iOiBvcGVyYXRvciwgInR5cGVvZiI6IG9wZXJhdG9yLCAiaW5zdGFuY2VvZiI6IG9wZXJhdG9yLAogICAgICAidHJ1ZSI6IGF0b20sICJmYWxzZSI6IGF0b20sICJudWxsIjogYXRvbSwgInVuZGVmaW5lZCI6IGF0b20sICJOYU4iOiBhdG9tLCAiSW5maW5pdHkiOiBhdG9tLAogICAgICAidGhpcyI6IGt3KCJ0aGlzIiksICJjbGFzcyI6IGt3KCJjbGFzcyIpLCAic3VwZXIiOiBrdygiYXRvbSIpLAogICAgICAieWllbGQiOiBDLCAiZXhwb3J0Ijoga3coImV4cG9ydCIpLCAiaW1wb3J0Ijoga3coImltcG9ydCIpLCAiZXh0ZW5kcyI6IEMsCiAgICAgICJhd2FpdCI6IEMKICAgIH07CiAgfSgpOwoKICB2YXIgaXNPcGVyYXRvckNoYXIgPSAvWytcLSomJT08PiE/fH5eQF0vOwogIHZhciBpc0pzb25sZEtleXdvcmQgPSAvXkAoY29udGV4dHxpZHx2YWx1ZXxsYW5ndWFnZXx0eXBlfGNvbnRhaW5lcnxsaXN0fHNldHxyZXZlcnNlfGluZGV4fGJhc2V8dm9jYWJ8Z3JhcGgpIi87CgogIGZ1bmN0aW9uIHJlYWRSZWdleHAoc3RyZWFtKSB7CiAgICB2YXIgZXNjYXBlZCA9IGZhbHNlLCBuZXh0LCBpblNldCA9IGZhbHNlOwogICAgd2hpbGUgKChuZXh0ID0gc3RyZWFtLm5leHQoKSkgIT0gbnVsbCkgewogICAgICBpZiAoIWVzY2FwZWQpIHsKICAgICAgICBpZiAobmV4dCA9PSAiLyIgJiYgIWluU2V0KSByZXR1cm47CiAgICAgICAgaWYgKG5leHQgPT0gIlsiKSBpblNldCA9IHRydWU7CiAgICAgICAgZWxzZSBpZiAoaW5TZXQgJiYgbmV4dCA9PSAiXSIpIGluU2V0ID0gZmFsc2U7CiAgICAgIH0KICAgICAgZXNjYXBlZCA9ICFlc2NhcGVkICYmIG5leHQgPT0gIlxcIjsKICAgIH0KICB9CgogIC8vIFVzZWQgYXMgc2NyYXRjaCB2YXJpYWJsZXMgdG8gY29tbXVuaWNhdGUgbXVsdGlwbGUgdmFsdWVzIHdpdGhvdXQKICAvLyBjb25zaW5nIHVwIHRvbnMgb2Ygb2JqZWN0cy4KICB2YXIgdHlwZSwgY29udGVudDsKICBmdW5jdGlvbiByZXQodHAsIHN0eWxlLCBjb250KSB7CiAgICB0eXBlID0gdHA7IGNvbnRlbnQgPSBjb250OwogICAgcmV0dXJuIHN0eWxlOwogIH0KICBmdW5jdGlvbiB0b2tlbkJhc2Uoc3RyZWFtLCBzdGF0ZSkgewogICAgdmFyIGNoID0gc3RyZWFtLm5leHQoKTsKICAgIGlmIChjaCA9PSAnIicgfHwgY2ggPT0gIiciKSB7CiAgICAgIHN0YXRlLnRva2VuaXplID0gdG9rZW5TdHJpbmcoY2gpOwogICAgICByZXR1cm4gc3RhdGUudG9rZW5pemUoc3RyZWFtLCBzdGF0ZSk7CiAgICB9IGVsc2UgaWYgKGNoID09ICIuIiAmJiBzdHJlYW0ubWF0Y2goL15cZFtcZF9dKig/OltlRV1bK1wtXT9bXGRfXSspPy8pKSB7CiAgICAgIHJldHVybiByZXQoIm51bWJlciIsICJudW1iZXIiKTsKICAgIH0gZWxzZSBpZiAoY2ggPT0gIi4iICYmIHN0cmVhbS5tYXRjaCgiLi4iKSkgewogICAgICByZXR1cm4gcmV0KCJzcHJlYWQiLCAibWV0YSIpOwogICAgfSBlbHNlIGlmICgvW1xbXF17fVwoXCksO1w6XC5dLy50ZXN0KGNoKSkgewogICAgICByZXR1cm4gcmV0KGNoKTsKICAgIH0gZWxzZSBpZiAoY2ggPT0gIj0iICYmIHN0cmVhbS5lYXQoIj4iKSkgewogICAgICByZXR1cm4gcmV0KCI9PiIsICJvcGVyYXRvciIpOwogICAgfSBlbHNlIGlmIChjaCA9PSAiMCIgJiYgc3RyZWFtLm1hdGNoKC9eKD86eFtcZEEtRmEtZl9dK3xvWzAtN19dK3xiWzAxX10rKW4/LykpIHsKICAgICAgcmV0dXJuIHJldCgibnVtYmVyIiwgIm51bWJlciIpOwogICAgfSBlbHNlIGlmICgvXGQvLnRlc3QoY2gpKSB7CiAgICAgIHN0cmVhbS5tYXRjaCgvXltcZF9dKig/Om58KD86XC5bXGRfXSopPyg/OltlRV1bK1wtXT9bXGRfXSspPyk/Lyk7CiAgICAgIHJldHVybiByZXQoIm51bWJlciIsICJudW1iZXIiKTsKICAgIH0gZWxzZSBpZiAoY2ggPT0gIi8iKSB7CiAgICAgIGlmIChzdHJlYW0uZWF0KCIqIikpIHsKICAgICAgICBzdGF0ZS50b2tlbml6ZSA9IHRva2VuQ29tbWVudDsKICAgICAgICByZXR1cm4gdG9rZW5Db21tZW50KHN0cmVhbSwgc3RhdGUpOwogICAgICB9IGVsc2UgaWYgKHN0cmVhbS5lYXQoIi8iKSkgewogICAgICAgIHN0cmVhbS5za2lwVG9FbmQoKTsKICAgICAgICByZXR1cm4gcmV0KCJjb21tZW50IiwgImNvbW1lbnQiKTsKICAgICAgfSBlbHNlIGlmIChleHByZXNzaW9uQWxsb3dlZChzdHJlYW0sIHN0YXRlLCAxKSkgewogICAgICAgIHJlYWRSZWdleHAoc3RyZWFtKTsKICAgICAgICBzdHJlYW0ubWF0Y2goL15cYigoW2dpbXl1c10pKD8hW2dpbXl1c10qXDIpKStcYi8pOwogICAgICAgIHJldHVybiByZXQoInJlZ2V4cCIsICJzdHJpbmctMiIpOwogICAgICB9IGVsc2UgewogICAgICAgIHN0cmVhbS5lYXQoIj0iKTsKICAgICAgICByZXR1cm4gcmV0KCJvcGVyYXRvciIsICJvcGVyYXRvciIsIHN0cmVhbS5jdXJyZW50KCkpOwogICAgICB9CiAgICB9IGVsc2UgaWYgKGNoID09ICJgIikgewogICAgICBzdGF0ZS50b2tlbml6ZSA9IHRva2VuUXVhc2k7CiAgICAgIHJldHVybiB0b2tlblF1YXNpKHN0cmVhbSwgc3RhdGUpOwogICAgfSBlbHNlIGlmIChjaCA9PSAiIyIpIHsKICAgICAgc3RyZWFtLnNraXBUb0VuZCgpOwogICAgICByZXR1cm4gcmV0KCJlcnJvciIsICJlcnJvciIpOwogICAgfSBlbHNlIGlmIChpc09wZXJhdG9yQ2hhci50ZXN0KGNoKSkgewogICAgICBpZiAoY2ggIT0gIj4iIHx8ICFzdGF0ZS5sZXhpY2FsIHx8IHN0YXRlLmxleGljYWwudHlwZSAhPSAiPiIpIHsKICAgICAgICBpZiAoc3RyZWFtLmVhdCgiPSIpKSB7CiAgICAgICAgICBpZiAoY2ggPT0gIiEiIHx8IGNoID09ICI9Iikgc3RyZWFtLmVhdCgiPSIpCiAgICAgICAgfSBlbHNlIGlmICgvWzw+KitcLV0vLnRlc3QoY2gpKSB7CiAgICAgICAgICBzdHJlYW0uZWF0KGNoKQogICAgICAgICAgaWYgKGNoID09ICI+Iikgc3RyZWFtLmVhdChjaCkKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHJldCgib3BlcmF0b3IiLCAib3BlcmF0b3IiLCBzdHJlYW0uY3VycmVudCgpKTsKICAgIH0gZWxzZSBpZiAod29yZFJFLnRlc3QoY2gpKSB7CiAgICAgIHN0cmVhbS5lYXRXaGlsZSh3b3JkUkUpOwogICAgICB2YXIgd29yZCA9IHN0cmVhbS5jdXJyZW50KCkKICAgICAgaWYgKHN0YXRlLmxhc3RUeXBlICE9ICIuIikgewogICAgICAgIGlmIChrZXl3b3Jkcy5wcm9wZXJ0eUlzRW51bWVyYWJsZSh3b3JkKSkgewogICAgICAgICAgdmFyIGt3ID0ga2V5d29yZHNbd29yZF0KICAgICAgICAgIHJldHVybiByZXQoa3cudHlwZSwga3cuc3R5bGUsIHdvcmQpCiAgICAgICAgfQogICAgICAgIGlmICh3b3JkID09ICJhc3luYyIgJiYgc3RyZWFtLm1hdGNoKC9eKFxzfFwvXCouKj9cKlwvKSpbXFtcKFx3XS8sIGZhbHNlKSkKICAgICAgICAgIHJldHVybiByZXQoImFzeW5jIiwgImtleXdvcmQiLCB3b3JkKQogICAgICB9CiAgICAgIHJldHVybiByZXQoInZhcmlhYmxlIiwgInZhcmlhYmxlIiwgd29yZCkKICAgIH0KICB9CgogIGZ1bmN0aW9uIHRva2VuU3RyaW5nKHF1b3RlKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oc3RyZWFtLCBzdGF0ZSkgewogICAgICB2YXIgZXNjYXBlZCA9IGZhbHNlLCBuZXh0OwogICAgICBpZiAoanNvbmxkTW9kZSAmJiBzdHJlYW0ucGVlaygpID09ICJAIiAmJiBzdHJlYW0ubWF0Y2goaXNKc29ubGRLZXl3b3JkKSl7CiAgICAgICAgc3RhdGUudG9rZW5pemUgPSB0b2tlbkJhc2U7CiAgICAgICAgcmV0dXJuIHJldCgianNvbmxkLWtleXdvcmQiLCAibWV0YSIpOwogICAgICB9CiAgICAgIHdoaWxlICgobmV4dCA9IHN0cmVhbS5uZXh0KCkpICE9IG51bGwpIHsKICAgICAgICBpZiAobmV4dCA9PSBxdW90ZSAmJiAhZXNjYXBlZCkgYnJlYWs7CiAgICAgICAgZXNjYXBlZCA9ICFlc2NhcGVkICYmIG5leHQgPT0gIlxcIjsKICAgICAgfQogICAgICBpZiAoIWVzY2FwZWQpIHN0YXRlLnRva2VuaXplID0gdG9rZW5CYXNlOwogICAgICByZXR1cm4gcmV0KCJzdHJpbmciLCAic3RyaW5nIik7CiAgICB9OwogIH0KCiAgZnVuY3Rpb24gdG9rZW5Db21tZW50KHN0cmVhbSwgc3RhdGUpIHsKICAgIHZhciBtYXliZUVuZCA9IGZhbHNlLCBjaDsKICAgIHdoaWxlIChjaCA9IHN0cmVhbS5uZXh0KCkpIHsKICAgICAgaWYgKGNoID09ICIvIiAmJiBtYXliZUVuZCkgewogICAgICAgIHN0YXRlLnRva2VuaXplID0gdG9rZW5CYXNlOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICAgIG1heWJlRW5kID0gKGNoID09ICIqIik7CiAgICB9CiAgICByZXR1cm4gcmV0KCJjb21tZW50IiwgImNvbW1lbnQiKTsKICB9CgogIGZ1bmN0aW9uIHRva2VuUXVhc2koc3RyZWFtLCBzdGF0ZSkgewogICAgdmFyIGVzY2FwZWQgPSBmYWxzZSwgbmV4dDsKICAgIHdoaWxlICgobmV4dCA9IHN0cmVhbS5uZXh0KCkpICE9IG51bGwpIHsKICAgICAgaWYgKCFlc2NhcGVkICYmIChuZXh0ID09ICJgIiB8fCBuZXh0ID09ICIkIiAmJiBzdHJlYW0uZWF0KCJ7IikpKSB7CiAgICAgICAgc3RhdGUudG9rZW5pemUgPSB0b2tlbkJhc2U7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgICAgZXNjYXBlZCA9ICFlc2NhcGVkICYmIG5leHQgPT0gIlxcIjsKICAgIH0KICAgIHJldHVybiByZXQoInF1YXNpIiwgInN0cmluZy0yIiwgc3RyZWFtLmN1cnJlbnQoKSk7CiAgfQoKICB2YXIgYnJhY2tldHMgPSAiKFt7fV0pIjsKICAvLyBUaGlzIGlzIGEgY3J1ZGUgbG9va2FoZWFkIHRyaWNrIHRvIHRyeSBhbmQgbm90aWNlIHRoYXQgd2UncmUKICAvLyBwYXJzaW5nIHRoZSBhcmd1bWVudCBwYXR0ZXJucyBmb3IgYSBmYXQtYXJyb3cgZnVuY3Rpb24gYmVmb3JlIHdlCiAgLy8gYWN0dWFsbHkgaGl0IHRoZSBhcnJvdyB0b2tlbi4gSXQgb25seSB3b3JrcyBpZiB0aGUgYXJyb3cgaXMgb24KICAvLyB0aGUgc2FtZSBsaW5lIGFzIHRoZSBhcmd1bWVudHMgYW5kIHRoZXJlJ3Mgbm8gc3RyYW5nZSBub2lzZQogIC8vIChjb21tZW50cykgaW4gYmV0d2Vlbi4gRmFsbGJhY2sgaXMgdG8gb25seSBub3RpY2Ugd2hlbiB3ZSBoaXQgdGhlCiAgLy8gYXJyb3csIGFuZCBub3QgZGVjbGFyZSB0aGUgYXJndW1lbnRzIGFzIGxvY2FscyBmb3IgdGhlIGFycm93CiAgLy8gYm9keS4KICBmdW5jdGlvbiBmaW5kRmF0QXJyb3coc3RyZWFtLCBzdGF0ZSkgewogICAgaWYgKHN0YXRlLmZhdEFycm93QXQpIHN0YXRlLmZhdEFycm93QXQgPSBudWxsOwogICAgdmFyIGFycm93ID0gc3RyZWFtLnN0cmluZy5pbmRleE9mKCI9PiIsIHN0cmVhbS5zdGFydCk7CiAgICBpZiAoYXJyb3cgPCAwKSByZXR1cm47CgogICAgaWYgKGlzVFMpIHsgLy8gVHJ5IHRvIHNraXAgVHlwZVNjcmlwdCByZXR1cm4gdHlwZSBkZWNsYXJhdGlvbnMgYWZ0ZXIgdGhlIGFyZ3VtZW50cwogICAgICB2YXIgbSA9IC86XHMqKD86XHcrKD86PFtePl0qPnxcW1xdKT98XHtbXn1dKlx9KVxzKiQvLmV4ZWMoc3RyZWFtLnN0cmluZy5zbGljZShzdHJlYW0uc3RhcnQsIGFycm93KSkKICAgICAgaWYgKG0pIGFycm93ID0gbS5pbmRleAogICAgfQoKICAgIHZhciBkZXB0aCA9IDAsIHNhd1NvbWV0aGluZyA9IGZhbHNlOwogICAgZm9yICh2YXIgcG9zID0gYXJyb3cgLSAxOyBwb3MgPj0gMDsgLS1wb3MpIHsKICAgICAgdmFyIGNoID0gc3RyZWFtLnN0cmluZy5jaGFyQXQocG9zKTsKICAgICAgdmFyIGJyYWNrZXQgPSBicmFja2V0cy5pbmRleE9mKGNoKTsKICAgICAgaWYgKGJyYWNrZXQgPj0gMCAmJiBicmFja2V0IDwgMykgewogICAgICAgIGlmICghZGVwdGgpIHsgKytwb3M7IGJyZWFrOyB9CiAgICAgICAgaWYgKC0tZGVwdGggPT0gMCkgeyBpZiAoY2ggPT0gIigiKSBzYXdTb21ldGhpbmcgPSB0cnVlOyBicmVhazsgfQogICAgICB9IGVsc2UgaWYgKGJyYWNrZXQgPj0gMyAmJiBicmFja2V0IDwgNikgewogICAgICAgICsrZGVwdGg7CiAgICAgIH0gZWxzZSBpZiAod29yZFJFLnRlc3QoY2gpKSB7CiAgICAgICAgc2F3U29tZXRoaW5nID0gdHJ1ZTsKICAgICAgfSBlbHNlIGlmICgvWyInXC9gXS8udGVzdChjaCkpIHsKICAgICAgICBmb3IgKDs7IC0tcG9zKSB7CiAgICAgICAgICBpZiAocG9zID09IDApIHJldHVybgogICAgICAgICAgdmFyIG5leHQgPSBzdHJlYW0uc3RyaW5nLmNoYXJBdChwb3MgLSAxKQogICAgICAgICAgaWYgKG5leHQgPT0gY2ggJiYgc3RyZWFtLnN0cmluZy5jaGFyQXQocG9zIC0gMikgIT0gIlxcIikgeyBwb3MtLTsgYnJlYWsgfQogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChzYXdTb21ldGhpbmcgJiYgIWRlcHRoKSB7CiAgICAgICAgKytwb3M7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KICAgIGlmIChzYXdTb21ldGhpbmcgJiYgIWRlcHRoKSBzdGF0ZS5mYXRBcnJvd0F0ID0gcG9zOwogIH0KCiAgLy8gUGFyc2VyCgogIHZhciBhdG9taWNUeXBlcyA9IHsiYXRvbSI6IHRydWUsICJudW1iZXIiOiB0cnVlLCAidmFyaWFibGUiOiB0cnVlLCAic3RyaW5nIjogdHJ1ZSwgInJlZ2V4cCI6IHRydWUsICJ0aGlzIjogdHJ1ZSwgImpzb25sZC1rZXl3b3JkIjogdHJ1ZX07CgogIGZ1bmN0aW9uIEpTTGV4aWNhbChpbmRlbnRlZCwgY29sdW1uLCB0eXBlLCBhbGlnbiwgcHJldiwgaW5mbykgewogICAgdGhpcy5pbmRlbnRlZCA9IGluZGVudGVkOwogICAgdGhpcy5jb2x1bW4gPSBjb2x1bW47CiAgICB0aGlzLnR5cGUgPSB0eXBlOwogICAgdGhpcy5wcmV2ID0gcHJldjsKICAgIHRoaXMuaW5mbyA9IGluZm87CiAgICBpZiAoYWxpZ24gIT0gbnVsbCkgdGhpcy5hbGlnbiA9IGFsaWduOwogIH0KCiAgZnVuY3Rpb24gaW5TY29wZShzdGF0ZSwgdmFybmFtZSkgewogICAgZm9yICh2YXIgdiA9IHN0YXRlLmxvY2FsVmFyczsgdjsgdiA9IHYubmV4dCkKICAgICAgaWYgKHYubmFtZSA9PSB2YXJuYW1lKSByZXR1cm4gdHJ1ZTsKICAgIGZvciAodmFyIGN4ID0gc3RhdGUuY29udGV4dDsgY3g7IGN4ID0gY3gucHJldikgewogICAgICBmb3IgKHZhciB2ID0gY3gudmFyczsgdjsgdiA9IHYubmV4dCkKICAgICAgICBpZiAodi5uYW1lID09IHZhcm5hbWUpIHJldHVybiB0cnVlOwogICAgfQogIH0KCiAgZnVuY3Rpb24gcGFyc2VKUyhzdGF0ZSwgc3R5bGUsIHR5cGUsIGNvbnRlbnQsIHN0cmVhbSkgewogICAgdmFyIGNjID0gc3RhdGUuY2M7CiAgICAvLyBDb21tdW5pY2F0ZSBvdXIgY29udGV4dCB0byB0aGUgY29tYmluYXRvcnMuCiAgICAvLyAoTGVzcyB3YXN0ZWZ1bCB0aGFuIGNvbnNpbmcgdXAgYSBodW5kcmVkIGNsb3N1cmVzIG9uIGV2ZXJ5IGNhbGwuKQogICAgY3guc3RhdGUgPSBzdGF0ZTsgY3guc3RyZWFtID0gc3RyZWFtOyBjeC5tYXJrZWQgPSBudWxsLCBjeC5jYyA9IGNjOyBjeC5zdHlsZSA9IHN0eWxlOwoKICAgIGlmICghc3RhdGUubGV4aWNhbC5oYXNPd25Qcm9wZXJ0eSgiYWxpZ24iKSkKICAgICAgc3RhdGUubGV4aWNhbC5hbGlnbiA9IHRydWU7CgogICAgd2hpbGUodHJ1ZSkgewogICAgICB2YXIgY29tYmluYXRvciA9IGNjLmxlbmd0aCA/IGNjLnBvcCgpIDoganNvbk1vZGUgPyBleHByZXNzaW9uIDogc3RhdGVtZW50OwogICAgICBpZiAoY29tYmluYXRvcih0eXBlLCBjb250ZW50KSkgewogICAgICAgIHdoaWxlKGNjLmxlbmd0aCAmJiBjY1tjYy5sZW5ndGggLSAxXS5sZXgpCiAgICAgICAgICBjYy5wb3AoKSgpOwogICAgICAgIGlmIChjeC5tYXJrZWQpIHJldHVybiBjeC5tYXJrZWQ7CiAgICAgICAgaWYgKHR5cGUgPT0gInZhcmlhYmxlIiAmJiBpblNjb3BlKHN0YXRlLCBjb250ZW50KSkgcmV0dXJuICJ2YXJpYWJsZS0yIjsKICAgICAgICByZXR1cm4gc3R5bGU7CiAgICAgIH0KICAgIH0KICB9CgogIC8vIENvbWJpbmF0b3IgdXRpbHMKCiAgdmFyIGN4ID0ge3N0YXRlOiBudWxsLCBjb2x1bW46IG51bGwsIG1hcmtlZDogbnVsbCwgY2M6IG51bGx9OwogIGZ1bmN0aW9uIHBhc3MoKSB7CiAgICBmb3IgKHZhciBpID0gYXJndW1lbnRzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSBjeC5jYy5wdXNoKGFyZ3VtZW50c1tpXSk7CiAgfQogIGZ1bmN0aW9uIGNvbnQoKSB7CiAgICBwYXNzLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgZnVuY3Rpb24gaW5MaXN0KG5hbWUsIGxpc3QpIHsKICAgIGZvciAodmFyIHYgPSBsaXN0OyB2OyB2ID0gdi5uZXh0KSBpZiAodi5uYW1lID09IG5hbWUpIHJldHVybiB0cnVlCiAgICByZXR1cm4gZmFsc2U7CiAgfQogIGZ1bmN0aW9uIHJlZ2lzdGVyKHZhcm5hbWUpIHsKICAgIHZhciBzdGF0ZSA9IGN4LnN0YXRlOwogICAgY3gubWFya2VkID0gImRlZiI7CiAgICBpZiAoc3RhdGUuY29udGV4dCkgewogICAgICBpZiAoc3RhdGUubGV4aWNhbC5pbmZvID09ICJ2YXIiICYmIHN0YXRlLmNvbnRleHQgJiYgc3RhdGUuY29udGV4dC5ibG9jaykgewogICAgICAgIC8vIEZJWE1FIGZ1bmN0aW9uIGRlY2xzIGFyZSBhbHNvIG5vdCBibG9jayBzY29wZWQKICAgICAgICB2YXIgbmV3Q29udGV4dCA9IHJlZ2lzdGVyVmFyU2NvcGVkKHZhcm5hbWUsIHN0YXRlLmNvbnRleHQpCiAgICAgICAgaWYgKG5ld0NvbnRleHQgIT0gbnVsbCkgewogICAgICAgICAgc3RhdGUuY29udGV4dCA9IG5ld0NvbnRleHQKICAgICAgICAgIHJldHVybgogICAgICAgIH0KICAgICAgfSBlbHNlIGlmICghaW5MaXN0KHZhcm5hbWUsIHN0YXRlLmxvY2FsVmFycykpIHsKICAgICAgICBzdGF0ZS5sb2NhbFZhcnMgPSBuZXcgVmFyKHZhcm5hbWUsIHN0YXRlLmxvY2FsVmFycykKICAgICAgICByZXR1cm4KICAgICAgfQogICAgfQogICAgLy8gRmFsbCB0aHJvdWdoIG1lYW5zIHRoaXMgaXMgZ2xvYmFsCiAgICBpZiAocGFyc2VyQ29uZmlnLmdsb2JhbFZhcnMgJiYgIWluTGlzdCh2YXJuYW1lLCBzdGF0ZS5nbG9iYWxWYXJzKSkKICAgICAgc3RhdGUuZ2xvYmFsVmFycyA9IG5ldyBWYXIodmFybmFtZSwgc3RhdGUuZ2xvYmFsVmFycykKICB9CiAgZnVuY3Rpb24gcmVnaXN0ZXJWYXJTY29wZWQodmFybmFtZSwgY29udGV4dCkgewogICAgaWYgKCFjb250ZXh0KSB7CiAgICAgIHJldHVybiBudWxsCiAgICB9IGVsc2UgaWYgKGNvbnRleHQuYmxvY2spIHsKICAgICAgdmFyIGlubmVyID0gcmVnaXN0ZXJWYXJTY29wZWQodmFybmFtZSwgY29udGV4dC5wcmV2KQogICAgICBpZiAoIWlubmVyKSByZXR1cm4gbnVsbAogICAgICBpZiAoaW5uZXIgPT0gY29udGV4dC5wcmV2KSByZXR1cm4gY29udGV4dAogICAgICByZXR1cm4gbmV3IENvbnRleHQoaW5uZXIsIGNvbnRleHQudmFycywgdHJ1ZSkKICAgIH0gZWxzZSBpZiAoaW5MaXN0KHZhcm5hbWUsIGNvbnRleHQudmFycykpIHsKICAgICAgcmV0dXJuIGNvbnRleHQKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBuZXcgQ29udGV4dChjb250ZXh0LnByZXYsIG5ldyBWYXIodmFybmFtZSwgY29udGV4dC52YXJzKSwgZmFsc2UpCiAgICB9CiAgfQoKICBmdW5jdGlvbiBpc01vZGlmaWVyKG5hbWUpIHsKICAgIHJldHVybiBuYW1lID09ICJwdWJsaWMiIHx8IG5hbWUgPT0gInByaXZhdGUiIHx8IG5hbWUgPT0gInByb3RlY3RlZCIgfHwgbmFtZSA9PSAiYWJzdHJhY3QiIHx8IG5hbWUgPT0gInJlYWRvbmx5IgogIH0KCiAgLy8gQ29tYmluYXRvcnMKCiAgZnVuY3Rpb24gQ29udGV4dChwcmV2LCB2YXJzLCBibG9jaykgeyB0aGlzLnByZXYgPSBwcmV2OyB0aGlzLnZhcnMgPSB2YXJzOyB0aGlzLmJsb2NrID0gYmxvY2sgfQogIGZ1bmN0aW9uIFZhcihuYW1lLCBuZXh0KSB7IHRoaXMubmFtZSA9IG5hbWU7IHRoaXMubmV4dCA9IG5leHQgfQoKICB2YXIgZGVmYXVsdFZhcnMgPSBuZXcgVmFyKCJ0aGlzIiwgbmV3IFZhcigiYXJndW1lbnRzIiwgbnVsbCkpCiAgZnVuY3Rpb24gcHVzaGNvbnRleHQoKSB7CiAgICBjeC5zdGF0ZS5jb250ZXh0ID0gbmV3IENvbnRleHQoY3guc3RhdGUuY29udGV4dCwgY3guc3RhdGUubG9jYWxWYXJzLCBmYWxzZSkKICAgIGN4LnN0YXRlLmxvY2FsVmFycyA9IGRlZmF1bHRWYXJzCiAgfQogIGZ1bmN0aW9uIHB1c2hibG9ja2NvbnRleHQoKSB7CiAgICBjeC5zdGF0ZS5jb250ZXh0ID0gbmV3IENvbnRleHQoY3guc3RhdGUuY29udGV4dCwgY3guc3RhdGUubG9jYWxWYXJzLCB0cnVlKQogICAgY3guc3RhdGUubG9jYWxWYXJzID0gbnVsbAogIH0KICBmdW5jdGlvbiBwb3Bjb250ZXh0KCkgewogICAgY3guc3RhdGUubG9jYWxWYXJzID0gY3guc3RhdGUuY29udGV4dC52YXJzCiAgICBjeC5zdGF0ZS5jb250ZXh0ID0gY3guc3RhdGUuY29udGV4dC5wcmV2CiAgfQogIHBvcGNvbnRleHQubGV4ID0gdHJ1ZQogIGZ1bmN0aW9uIHB1c2hsZXgodHlwZSwgaW5mbykgewogICAgdmFyIHJlc3VsdCA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgc3RhdGUgPSBjeC5zdGF0ZSwgaW5kZW50ID0gc3RhdGUuaW5kZW50ZWQ7CiAgICAgIGlmIChzdGF0ZS5sZXhpY2FsLnR5cGUgPT0gInN0YXQiKSBpbmRlbnQgPSBzdGF0ZS5sZXhpY2FsLmluZGVudGVkOwogICAgICBlbHNlIGZvciAodmFyIG91dGVyID0gc3RhdGUubGV4aWNhbDsgb3V0ZXIgJiYgb3V0ZXIudHlwZSA9PSAiKSIgJiYgb3V0ZXIuYWxpZ247IG91dGVyID0gb3V0ZXIucHJldikKICAgICAgICBpbmRlbnQgPSBvdXRlci5pbmRlbnRlZDsKICAgICAgc3RhdGUubGV4aWNhbCA9IG5ldyBKU0xleGljYWwoaW5kZW50LCBjeC5zdHJlYW0uY29sdW1uKCksIHR5cGUsIG51bGwsIHN0YXRlLmxleGljYWwsIGluZm8pOwogICAgfTsKICAgIHJlc3VsdC5sZXggPSB0cnVlOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgZnVuY3Rpb24gcG9wbGV4KCkgewogICAgdmFyIHN0YXRlID0gY3guc3RhdGU7CiAgICBpZiAoc3RhdGUubGV4aWNhbC5wcmV2KSB7CiAgICAgIGlmIChzdGF0ZS5sZXhpY2FsLnR5cGUgPT0gIikiKQogICAgICAgIHN0YXRlLmluZGVudGVkID0gc3RhdGUubGV4aWNhbC5pbmRlbnRlZDsKICAgICAgc3RhdGUubGV4aWNhbCA9IHN0YXRlLmxleGljYWwucHJldjsKICAgIH0KICB9CiAgcG9wbGV4LmxleCA9IHRydWU7CgogIGZ1bmN0aW9uIGV4cGVjdCh3YW50ZWQpIHsKICAgIGZ1bmN0aW9uIGV4cCh0eXBlKSB7CiAgICAgIGlmICh0eXBlID09IHdhbnRlZCkgcmV0dXJuIGNvbnQoKTsKICAgICAgZWxzZSBpZiAod2FudGVkID09ICI7IiB8fCB0eXBlID09ICJ9IiB8fCB0eXBlID09ICIpIiB8fCB0eXBlID09ICJdIikgcmV0dXJuIHBhc3MoKTsKICAgICAgZWxzZSByZXR1cm4gY29udChleHApOwogICAgfTsKICAgIHJldHVybiBleHA7CiAgfQoKICBmdW5jdGlvbiBzdGF0ZW1lbnQodHlwZSwgdmFsdWUpIHsKICAgIGlmICh0eXBlID09ICJ2YXIiKSByZXR1cm4gY29udChwdXNobGV4KCJ2YXJkZWYiLCB2YWx1ZSksIHZhcmRlZiwgZXhwZWN0KCI7IiksIHBvcGxleCk7CiAgICBpZiAodHlwZSA9PSAia2V5d29yZCBhIikgcmV0dXJuIGNvbnQocHVzaGxleCgiZm9ybSIpLCBwYXJlbkV4cHIsIHN0YXRlbWVudCwgcG9wbGV4KTsKICAgIGlmICh0eXBlID09ICJrZXl3b3JkIGIiKSByZXR1cm4gY29udChwdXNobGV4KCJmb3JtIiksIHN0YXRlbWVudCwgcG9wbGV4KTsKICAgIGlmICh0eXBlID09ICJrZXl3b3JkIGQiKSByZXR1cm4gY3guc3RyZWFtLm1hdGNoKC9eXHMqJC8sIGZhbHNlKSA/IGNvbnQoKSA6IGNvbnQocHVzaGxleCgic3RhdCIpLCBtYXliZWV4cHJlc3Npb24sIGV4cGVjdCgiOyIpLCBwb3BsZXgpOwogICAgaWYgKHR5cGUgPT0gImRlYnVnZ2VyIikgcmV0dXJuIGNvbnQoZXhwZWN0KCI7IikpOwogICAgaWYgKHR5cGUgPT0gInsiKSByZXR1cm4gY29udChwdXNobGV4KCJ9IiksIHB1c2hibG9ja2NvbnRleHQsIGJsb2NrLCBwb3BsZXgsIHBvcGNvbnRleHQpOwogICAgaWYgKHR5cGUgPT0gIjsiKSByZXR1cm4gY29udCgpOwogICAgaWYgKHR5cGUgPT0gImlmIikgewogICAgICBpZiAoY3guc3RhdGUubGV4aWNhbC5pbmZvID09ICJlbHNlIiAmJiBjeC5zdGF0ZS5jY1tjeC5zdGF0ZS5jYy5sZW5ndGggLSAxXSA9PSBwb3BsZXgpCiAgICAgICAgY3guc3RhdGUuY2MucG9wKCkoKTsKICAgICAgcmV0dXJuIGNvbnQocHVzaGxleCgiZm9ybSIpLCBwYXJlbkV4cHIsIHN0YXRlbWVudCwgcG9wbGV4LCBtYXliZWVsc2UpOwogICAgfQogICAgaWYgKHR5cGUgPT0gImZ1bmN0aW9uIikgcmV0dXJuIGNvbnQoZnVuY3Rpb25kZWYpOwogICAgaWYgKHR5cGUgPT0gImZvciIpIHJldHVybiBjb250KHB1c2hsZXgoImZvcm0iKSwgZm9yc3BlYywgc3RhdGVtZW50LCBwb3BsZXgpOwogICAgaWYgKHR5cGUgPT0gImNsYXNzIiB8fCAoaXNUUyAmJiB2YWx1ZSA9PSAiaW50ZXJmYWNlIikpIHsKICAgICAgY3gubWFya2VkID0gImtleXdvcmQiCiAgICAgIHJldHVybiBjb250KHB1c2hsZXgoImZvcm0iLCB0eXBlID09ICJjbGFzcyIgPyB0eXBlIDogdmFsdWUpLCBjbGFzc05hbWUsIHBvcGxleCkKICAgIH0KICAgIGlmICh0eXBlID09ICJ2YXJpYWJsZSIpIHsKICAgICAgaWYgKGlzVFMgJiYgdmFsdWUgPT0gImRlY2xhcmUiKSB7CiAgICAgICAgY3gubWFya2VkID0gImtleXdvcmQiCiAgICAgICAgcmV0dXJuIGNvbnQoc3RhdGVtZW50KQogICAgICB9IGVsc2UgaWYgKGlzVFMgJiYgKHZhbHVlID09ICJtb2R1bGUiIHx8IHZhbHVlID09ICJlbnVtIiB8fCB2YWx1ZSA9PSAidHlwZSIpICYmIGN4LnN0cmVhbS5tYXRjaCgvXlxzKlx3LywgZmFsc2UpKSB7CiAgICAgICAgY3gubWFya2VkID0gImtleXdvcmQiCiAgICAgICAgaWYgKHZhbHVlID09ICJlbnVtIikgcmV0dXJuIGNvbnQoZW51bWRlZik7CiAgICAgICAgZWxzZSBpZiAodmFsdWUgPT0gInR5cGUiKSByZXR1cm4gY29udCh0eXBlbmFtZSwgZXhwZWN0KCJvcGVyYXRvciIpLCB0eXBlZXhwciwgZXhwZWN0KCI7IikpOwogICAgICAgIGVsc2UgcmV0dXJuIGNvbnQocHVzaGxleCgiZm9ybSIpLCBwYXR0ZXJuLCBleHBlY3QoInsiKSwgcHVzaGxleCgifSIpLCBibG9jaywgcG9wbGV4LCBwb3BsZXgpCiAgICAgIH0gZWxzZSBpZiAoaXNUUyAmJiB2YWx1ZSA9PSAibmFtZXNwYWNlIikgewogICAgICAgIGN4Lm1hcmtlZCA9ICJrZXl3b3JkIgogICAgICAgIHJldHVybiBjb250KHB1c2hsZXgoImZvcm0iKSwgZXhwcmVzc2lvbiwgc3RhdGVtZW50LCBwb3BsZXgpCiAgICAgIH0gZWxzZSBpZiAoaXNUUyAmJiB2YWx1ZSA9PSAiYWJzdHJhY3QiKSB7CiAgICAgICAgY3gubWFya2VkID0gImtleXdvcmQiCiAgICAgICAgcmV0dXJuIGNvbnQoc3RhdGVtZW50KQogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBjb250KHB1c2hsZXgoInN0YXQiKSwgbWF5YmVsYWJlbCk7CiAgICAgIH0KICAgIH0KICAgIGlmICh0eXBlID09ICJzd2l0Y2giKSByZXR1cm4gY29udChwdXNobGV4KCJmb3JtIiksIHBhcmVuRXhwciwgZXhwZWN0KCJ7IiksIHB1c2hsZXgoIn0iLCAic3dpdGNoIiksIHB1c2hibG9ja2NvbnRleHQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmxvY2ssIHBvcGxleCwgcG9wbGV4LCBwb3Bjb250ZXh0KTsKICAgIGlmICh0eXBlID09ICJjYXNlIikgcmV0dXJuIGNvbnQoZXhwcmVzc2lvbiwgZXhwZWN0KCI6IikpOwogICAgaWYgKHR5cGUgPT0gImRlZmF1bHQiKSByZXR1cm4gY29udChleHBlY3QoIjoiKSk7CiAgICBpZiAodHlwZSA9PSAiY2F0Y2giKSByZXR1cm4gY29udChwdXNobGV4KCJmb3JtIiksIHB1c2hjb250ZXh0LCBtYXliZUNhdGNoQmluZGluZywgc3RhdGVtZW50LCBwb3BsZXgsIHBvcGNvbnRleHQpOwogICAgaWYgKHR5cGUgPT0gImV4cG9ydCIpIHJldHVybiBjb250KHB1c2hsZXgoInN0YXQiKSwgYWZ0ZXJFeHBvcnQsIHBvcGxleCk7CiAgICBpZiAodHlwZSA9PSAiaW1wb3J0IikgcmV0dXJuIGNvbnQocHVzaGxleCgic3RhdCIpLCBhZnRlckltcG9ydCwgcG9wbGV4KTsKICAgIGlmICh0eXBlID09ICJhc3luYyIpIHJldHVybiBjb250KHN0YXRlbWVudCkKICAgIGlmICh2YWx1ZSA9PSAiQCIpIHJldHVybiBjb250KGV4cHJlc3Npb24sIHN0YXRlbWVudCkKICAgIHJldHVybiBwYXNzKHB1c2hsZXgoInN0YXQiKSwgZXhwcmVzc2lvbiwgZXhwZWN0KCI7IiksIHBvcGxleCk7CiAgfQogIGZ1bmN0aW9uIG1heWJlQ2F0Y2hCaW5kaW5nKHR5cGUpIHsKICAgIGlmICh0eXBlID09ICIoIikgcmV0dXJuIGNvbnQoZnVuYXJnLCBleHBlY3QoIikiKSkKICB9CiAgZnVuY3Rpb24gZXhwcmVzc2lvbih0eXBlLCB2YWx1ZSkgewogICAgcmV0dXJuIGV4cHJlc3Npb25Jbm5lcih0eXBlLCB2YWx1ZSwgZmFsc2UpOwogIH0KICBmdW5jdGlvbiBleHByZXNzaW9uTm9Db21tYSh0eXBlLCB2YWx1ZSkgewogICAgcmV0dXJuIGV4cHJlc3Npb25Jbm5lcih0eXBlLCB2YWx1ZSwgdHJ1ZSk7CiAgfQogIGZ1bmN0aW9uIHBhcmVuRXhwcih0eXBlKSB7CiAgICBpZiAodHlwZSAhPSAiKCIpIHJldHVybiBwYXNzKCkKICAgIHJldHVybiBjb250KHB1c2hsZXgoIikiKSwgZXhwcmVzc2lvbiwgZXhwZWN0KCIpIiksIHBvcGxleCkKICB9CiAgZnVuY3Rpb24gZXhwcmVzc2lvbklubmVyKHR5cGUsIHZhbHVlLCBub0NvbW1hKSB7CiAgICBpZiAoY3guc3RhdGUuZmF0QXJyb3dBdCA9PSBjeC5zdHJlYW0uc3RhcnQpIHsKICAgICAgdmFyIGJvZHkgPSBub0NvbW1hID8gYXJyb3dCb2R5Tm9Db21tYSA6IGFycm93Qm9keTsKICAgICAgaWYgKHR5cGUgPT0gIigiKSByZXR1cm4gY29udChwdXNoY29udGV4dCwgcHVzaGxleCgiKSIpLCBjb21tYXNlcChmdW5hcmcsICIpIiksIHBvcGxleCwgZXhwZWN0KCI9PiIpLCBib2R5LCBwb3Bjb250ZXh0KTsKICAgICAgZWxzZSBpZiAodHlwZSA9PSAidmFyaWFibGUiKSByZXR1cm4gcGFzcyhwdXNoY29udGV4dCwgcGF0dGVybiwgZXhwZWN0KCI9PiIpLCBib2R5LCBwb3Bjb250ZXh0KTsKICAgIH0KCiAgICB2YXIgbWF5YmVvcCA9IG5vQ29tbWEgPyBtYXliZW9wZXJhdG9yTm9Db21tYSA6IG1heWJlb3BlcmF0b3JDb21tYTsKICAgIGlmIChhdG9taWNUeXBlcy5oYXNPd25Qcm9wZXJ0eSh0eXBlKSkgcmV0dXJuIGNvbnQobWF5YmVvcCk7CiAgICBpZiAodHlwZSA9PSAiZnVuY3Rpb24iKSByZXR1cm4gY29udChmdW5jdGlvbmRlZiwgbWF5YmVvcCk7CiAgICBpZiAodHlwZSA9PSAiY2xhc3MiIHx8IChpc1RTICYmIHZhbHVlID09ICJpbnRlcmZhY2UiKSkgeyBjeC5tYXJrZWQgPSAia2V5d29yZCI7IHJldHVybiBjb250KHB1c2hsZXgoImZvcm0iKSwgY2xhc3NFeHByZXNzaW9uLCBwb3BsZXgpOyB9CiAgICBpZiAodHlwZSA9PSAia2V5d29yZCBjIiB8fCB0eXBlID09ICJhc3luYyIpIHJldHVybiBjb250KG5vQ29tbWEgPyBleHByZXNzaW9uTm9Db21tYSA6IGV4cHJlc3Npb24pOwogICAgaWYgKHR5cGUgPT0gIigiKSByZXR1cm4gY29udChwdXNobGV4KCIpIiksIG1heWJlZXhwcmVzc2lvbiwgZXhwZWN0KCIpIiksIHBvcGxleCwgbWF5YmVvcCk7CiAgICBpZiAodHlwZSA9PSAib3BlcmF0b3IiIHx8IHR5cGUgPT0gInNwcmVhZCIpIHJldHVybiBjb250KG5vQ29tbWEgPyBleHByZXNzaW9uTm9Db21tYSA6IGV4cHJlc3Npb24pOwogICAgaWYgKHR5cGUgPT0gIlsiKSByZXR1cm4gY29udChwdXNobGV4KCJdIiksIGFycmF5TGl0ZXJhbCwgcG9wbGV4LCBtYXliZW9wKTsKICAgIGlmICh0eXBlID09ICJ7IikgcmV0dXJuIGNvbnRDb21tYXNlcChvYmpwcm9wLCAifSIsIG51bGwsIG1heWJlb3ApOwogICAgaWYgKHR5cGUgPT0gInF1YXNpIikgcmV0dXJuIHBhc3MocXVhc2ksIG1heWJlb3ApOwogICAgaWYgKHR5cGUgPT0gIm5ldyIpIHJldHVybiBjb250KG1heWJlVGFyZ2V0KG5vQ29tbWEpKTsKICAgIGlmICh0eXBlID09ICJpbXBvcnQiKSByZXR1cm4gY29udChleHByZXNzaW9uKTsKICAgIHJldHVybiBjb250KCk7CiAgfQogIGZ1bmN0aW9uIG1heWJlZXhwcmVzc2lvbih0eXBlKSB7CiAgICBpZiAodHlwZS5tYXRjaCgvWztcfVwpXF0sXS8pKSByZXR1cm4gcGFzcygpOwogICAgcmV0dXJuIHBhc3MoZXhwcmVzc2lvbik7CiAgfQoKICBmdW5jdGlvbiBtYXliZW9wZXJhdG9yQ29tbWEodHlwZSwgdmFsdWUpIHsKICAgIGlmICh0eXBlID09ICIsIikgcmV0dXJuIGNvbnQoZXhwcmVzc2lvbik7CiAgICByZXR1cm4gbWF5YmVvcGVyYXRvck5vQ29tbWEodHlwZSwgdmFsdWUsIGZhbHNlKTsKICB9CiAgZnVuY3Rpb24gbWF5YmVvcGVyYXRvck5vQ29tbWEodHlwZSwgdmFsdWUsIG5vQ29tbWEpIHsKICAgIHZhciBtZSA9IG5vQ29tbWEgPT0gZmFsc2UgPyBtYXliZW9wZXJhdG9yQ29tbWEgOiBtYXliZW9wZXJhdG9yTm9Db21tYTsKICAgIHZhciBleHByID0gbm9Db21tYSA9PSBmYWxzZSA/IGV4cHJlc3Npb24gOiBleHByZXNzaW9uTm9Db21tYTsKICAgIGlmICh0eXBlID09ICI9PiIpIHJldHVybiBjb250KHB1c2hjb250ZXh0LCBub0NvbW1hID8gYXJyb3dCb2R5Tm9Db21tYSA6IGFycm93Qm9keSwgcG9wY29udGV4dCk7CiAgICBpZiAodHlwZSA9PSAib3BlcmF0b3IiKSB7CiAgICAgIGlmICgvXCtcK3wtLS8udGVzdCh2YWx1ZSkgfHwgaXNUUyAmJiB2YWx1ZSA9PSAiISIpIHJldHVybiBjb250KG1lKTsKICAgICAgaWYgKGlzVFMgJiYgdmFsdWUgPT0gIjwiICYmIGN4LnN0cmVhbS5tYXRjaCgvXihbXj5dfDwuKj8+KSo+XHMqXCgvLCBmYWxzZSkpCiAgICAgICAgcmV0dXJuIGNvbnQocHVzaGxleCgiPiIpLCBjb21tYXNlcCh0eXBlZXhwciwgIj4iKSwgcG9wbGV4LCBtZSk7CiAgICAgIGlmICh2YWx1ZSA9PSAiPyIpIHJldHVybiBjb250KGV4cHJlc3Npb24sIGV4cGVjdCgiOiIpLCBleHByKTsKICAgICAgcmV0dXJuIGNvbnQoZXhwcik7CiAgICB9CiAgICBpZiAodHlwZSA9PSAicXVhc2kiKSB7IHJldHVybiBwYXNzKHF1YXNpLCBtZSk7IH0KICAgIGlmICh0eXBlID09ICI7IikgcmV0dXJuOwogICAgaWYgKHR5cGUgPT0gIigiKSByZXR1cm4gY29udENvbW1hc2VwKGV4cHJlc3Npb25Ob0NvbW1hLCAiKSIsICJjYWxsIiwgbWUpOwogICAgaWYgKHR5cGUgPT0gIi4iKSByZXR1cm4gY29udChwcm9wZXJ0eSwgbWUpOwogICAgaWYgKHR5cGUgPT0gIlsiKSByZXR1cm4gY29udChwdXNobGV4KCJdIiksIG1heWJlZXhwcmVzc2lvbiwgZXhwZWN0KCJdIiksIHBvcGxleCwgbWUpOwogICAgaWYgKGlzVFMgJiYgdmFsdWUgPT0gImFzIikgeyBjeC5tYXJrZWQgPSAia2V5d29yZCI7IHJldHVybiBjb250KHR5cGVleHByLCBtZSkgfQogICAgaWYgKHR5cGUgPT0gInJlZ2V4cCIpIHsKICAgICAgY3guc3RhdGUubGFzdFR5cGUgPSBjeC5tYXJrZWQgPSAib3BlcmF0b3IiCiAgICAgIGN4LnN0cmVhbS5iYWNrVXAoY3guc3RyZWFtLnBvcyAtIGN4LnN0cmVhbS5zdGFydCAtIDEpCiAgICAgIHJldHVybiBjb250KGV4cHIpCiAgICB9CiAgfQogIGZ1bmN0aW9uIHF1YXNpKHR5cGUsIHZhbHVlKSB7CiAgICBpZiAodHlwZSAhPSAicXVhc2kiKSByZXR1cm4gcGFzcygpOwogICAgaWYgKHZhbHVlLnNsaWNlKHZhbHVlLmxlbmd0aCAtIDIpICE9ICIkeyIpIHJldHVybiBjb250KHF1YXNpKTsKICAgIHJldHVybiBjb250KGV4cHJlc3Npb24sIGNvbnRpbnVlUXVhc2kpOwogIH0KICBmdW5jdGlvbiBjb250aW51ZVF1YXNpKHR5cGUpIHsKICAgIGlmICh0eXBlID09ICJ9IikgewogICAgICBjeC5tYXJrZWQgPSAic3RyaW5nLTIiOwogICAgICBjeC5zdGF0ZS50b2tlbml6ZSA9IHRva2VuUXVhc2k7CiAgICAgIHJldHVybiBjb250KHF1YXNpKTsKICAgIH0KICB9CiAgZnVuY3Rpb24gYXJyb3dCb2R5KHR5cGUpIHsKICAgIGZpbmRGYXRBcnJvdyhjeC5zdHJlYW0sIGN4LnN0YXRlKTsKICAgIHJldHVybiBwYXNzKHR5cGUgPT0gInsiID8gc3RhdGVtZW50IDogZXhwcmVzc2lvbik7CiAgfQogIGZ1bmN0aW9uIGFycm93Qm9keU5vQ29tbWEodHlwZSkgewogICAgZmluZEZhdEFycm93KGN4LnN0cmVhbSwgY3guc3RhdGUpOwogICAgcmV0dXJuIHBhc3ModHlwZSA9PSAieyIgPyBzdGF0ZW1lbnQgOiBleHByZXNzaW9uTm9Db21tYSk7CiAgfQogIGZ1bmN0aW9uIG1heWJlVGFyZ2V0KG5vQ29tbWEpIHsKICAgIHJldHVybiBmdW5jdGlvbih0eXBlKSB7CiAgICAgIGlmICh0eXBlID09ICIuIikgcmV0dXJuIGNvbnQobm9Db21tYSA/IHRhcmdldE5vQ29tbWEgOiB0YXJnZXQpOwogICAgICBlbHNlIGlmICh0eXBlID09ICJ2YXJpYWJsZSIgJiYgaXNUUykgcmV0dXJuIGNvbnQobWF5YmVUeXBlQXJncywgbm9Db21tYSA/IG1heWJlb3BlcmF0b3JOb0NvbW1hIDogbWF5YmVvcGVyYXRvckNvbW1hKQogICAgICBlbHNlIHJldHVybiBwYXNzKG5vQ29tbWEgPyBleHByZXNzaW9uTm9Db21tYSA6IGV4cHJlc3Npb24pOwogICAgfTsKICB9CiAgZnVuY3Rpb24gdGFyZ2V0KF8sIHZhbHVlKSB7CiAgICBpZiAodmFsdWUgPT0gInRhcmdldCIpIHsgY3gubWFya2VkID0gImtleXdvcmQiOyByZXR1cm4gY29udChtYXliZW9wZXJhdG9yQ29tbWEpOyB9CiAgfQogIGZ1bmN0aW9uIHRhcmdldE5vQ29tbWEoXywgdmFsdWUpIHsKICAgIGlmICh2YWx1ZSA9PSAidGFyZ2V0IikgeyBjeC5tYXJrZWQgPSAia2V5d29yZCI7IHJldHVybiBjb250KG1heWJlb3BlcmF0b3JOb0NvbW1hKTsgfQogIH0KICBmdW5jdGlvbiBtYXliZWxhYmVsKHR5cGUpIHsKICAgIGlmICh0eXBlID09ICI6IikgcmV0dXJuIGNvbnQocG9wbGV4LCBzdGF0ZW1lbnQpOwogICAgcmV0dXJuIHBhc3MobWF5YmVvcGVyYXRvckNvbW1hLCBleHBlY3QoIjsiKSwgcG9wbGV4KTsKICB9CiAgZnVuY3Rpb24gcHJvcGVydHkodHlwZSkgewogICAgaWYgKHR5cGUgPT0gInZhcmlhYmxlIikge2N4Lm1hcmtlZCA9ICJwcm9wZXJ0eSI7IHJldHVybiBjb250KCk7fQogIH0KICBmdW5jdGlvbiBvYmpwcm9wKHR5cGUsIHZhbHVlKSB7CiAgICBpZiAodHlwZSA9PSAiYXN5bmMiKSB7CiAgICAgIGN4Lm1hcmtlZCA9ICJwcm9wZXJ0eSI7CiAgICAgIHJldHVybiBjb250KG9ianByb3ApOwogICAgfSBlbHNlIGlmICh0eXBlID09ICJ2YXJpYWJsZSIgfHwgY3guc3R5bGUgPT0gImtleXdvcmQiKSB7CiAgICAgIGN4Lm1hcmtlZCA9ICJwcm9wZXJ0eSI7CiAgICAgIGlmICh2YWx1ZSA9PSAiZ2V0IiB8fCB2YWx1ZSA9PSAic2V0IikgcmV0dXJuIGNvbnQoZ2V0dGVyU2V0dGVyKTsKICAgICAgdmFyIG0gLy8gV29yayBhcm91bmQgZmF0LWFycm93LWRldGVjdGlvbiBjb21wbGljYXRpb24gZm9yIGRldGVjdGluZyB0eXBlc2NyaXB0IHR5cGVkIGFycm93IHBhcmFtcwogICAgICBpZiAoaXNUUyAmJiBjeC5zdGF0ZS5mYXRBcnJvd0F0ID09IGN4LnN0cmVhbS5zdGFydCAmJiAobSA9IGN4LnN0cmVhbS5tYXRjaCgvXlxzKjpccyovLCBmYWxzZSkpKQogICAgICAgIGN4LnN0YXRlLmZhdEFycm93QXQgPSBjeC5zdHJlYW0ucG9zICsgbVswXS5sZW5ndGgKICAgICAgcmV0dXJuIGNvbnQoYWZ0ZXJwcm9wKTsKICAgIH0gZWxzZSBpZiAodHlwZSA9PSAibnVtYmVyIiB8fCB0eXBlID09ICJzdHJpbmciKSB7CiAgICAgIGN4Lm1hcmtlZCA9IGpzb25sZE1vZGUgPyAicHJvcGVydHkiIDogKGN4LnN0eWxlICsgIiBwcm9wZXJ0eSIpOwogICAgICByZXR1cm4gY29udChhZnRlcnByb3ApOwogICAgfSBlbHNlIGlmICh0eXBlID09ICJqc29ubGQta2V5d29yZCIpIHsKICAgICAgcmV0dXJuIGNvbnQoYWZ0ZXJwcm9wKTsKICAgIH0gZWxzZSBpZiAoaXNUUyAmJiBpc01vZGlmaWVyKHZhbHVlKSkgewogICAgICBjeC5tYXJrZWQgPSAia2V5d29yZCIKICAgICAgcmV0dXJuIGNvbnQob2JqcHJvcCkKICAgIH0gZWxzZSBpZiAodHlwZSA9PSAiWyIpIHsKICAgICAgcmV0dXJuIGNvbnQoZXhwcmVzc2lvbiwgbWF5YmV0eXBlLCBleHBlY3QoIl0iKSwgYWZ0ZXJwcm9wKTsKICAgIH0gZWxzZSBpZiAodHlwZSA9PSAic3ByZWFkIikgewogICAgICByZXR1cm4gY29udChleHByZXNzaW9uTm9Db21tYSwgYWZ0ZXJwcm9wKTsKICAgIH0gZWxzZSBpZiAodmFsdWUgPT0gIioiKSB7CiAgICAgIGN4Lm1hcmtlZCA9ICJrZXl3b3JkIjsKICAgICAgcmV0dXJuIGNvbnQob2JqcHJvcCk7CiAgICB9IGVsc2UgaWYgKHR5cGUgPT0gIjoiKSB7CiAgICAgIHJldHVybiBwYXNzKGFmdGVycHJvcCkKICAgIH0KICB9CiAgZnVuY3Rpb24gZ2V0dGVyU2V0dGVyKHR5cGUpIHsKICAgIGlmICh0eXBlICE9ICJ2YXJpYWJsZSIpIHJldHVybiBwYXNzKGFmdGVycHJvcCk7CiAgICBjeC5tYXJrZWQgPSAicHJvcGVydHkiOwogICAgcmV0dXJuIGNvbnQoZnVuY3Rpb25kZWYpOwogIH0KICBmdW5jdGlvbiBhZnRlcnByb3AodHlwZSkgewogICAgaWYgKHR5cGUgPT0gIjoiKSByZXR1cm4gY29udChleHByZXNzaW9uTm9Db21tYSk7CiAgICBpZiAodHlwZSA9PSAiKCIpIHJldHVybiBwYXNzKGZ1bmN0aW9uZGVmKTsKICB9CiAgZnVuY3Rpb24gY29tbWFzZXAod2hhdCwgZW5kLCBzZXApIHsKICAgIGZ1bmN0aW9uIHByb2NlZWQodHlwZSwgdmFsdWUpIHsKICAgICAgaWYgKHNlcCA/IHNlcC5pbmRleE9mKHR5cGUpID4gLTEgOiB0eXBlID09ICIsIikgewogICAgICAgIHZhciBsZXggPSBjeC5zdGF0ZS5sZXhpY2FsOwogICAgICAgIGlmIChsZXguaW5mbyA9PSAiY2FsbCIpIGxleC5wb3MgPSAobGV4LnBvcyB8fCAwKSArIDE7CiAgICAgICAgcmV0dXJuIGNvbnQoZnVuY3Rpb24odHlwZSwgdmFsdWUpIHsKICAgICAgICAgIGlmICh0eXBlID09IGVuZCB8fCB2YWx1ZSA9PSBlbmQpIHJldHVybiBwYXNzKCkKICAgICAgICAgIHJldHVybiBwYXNzKHdoYXQpCiAgICAgICAgfSwgcHJvY2VlZCk7CiAgICAgIH0KICAgICAgaWYgKHR5cGUgPT0gZW5kIHx8IHZhbHVlID09IGVuZCkgcmV0dXJuIGNvbnQoKTsKICAgICAgaWYgKHNlcCAmJiBzZXAuaW5kZXhPZigiOyIpID4gLTEpIHJldHVybiBwYXNzKHdoYXQpCiAgICAgIHJldHVybiBjb250KGV4cGVjdChlbmQpKTsKICAgIH0KICAgIHJldHVybiBmdW5jdGlvbih0eXBlLCB2YWx1ZSkgewogICAgICBpZiAodHlwZSA9PSBlbmQgfHwgdmFsdWUgPT0gZW5kKSByZXR1cm4gY29udCgpOwogICAgICByZXR1cm4gcGFzcyh3aGF0LCBwcm9jZWVkKTsKICAgIH07CiAgfQogIGZ1bmN0aW9uIGNvbnRDb21tYXNlcCh3aGF0LCBlbmQsIGluZm8pIHsKICAgIGZvciAodmFyIGkgPSAzOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKQogICAgICBjeC5jYy5wdXNoKGFyZ3VtZW50c1tpXSk7CiAgICByZXR1cm4gY29udChwdXNobGV4KGVuZCwgaW5mbyksIGNvbW1hc2VwKHdoYXQsIGVuZCksIHBvcGxleCk7CiAgfQogIGZ1bmN0aW9uIGJsb2NrKHR5cGUpIHsKICAgIGlmICh0eXBlID09ICJ9IikgcmV0dXJuIGNvbnQoKTsKICAgIHJldHVybiBwYXNzKHN0YXRlbWVudCwgYmxvY2spOwogIH0KICBmdW5jdGlvbiBtYXliZXR5cGUodHlwZSwgdmFsdWUpIHsKICAgIGlmIChpc1RTKSB7CiAgICAgIGlmICh0eXBlID09ICI6IikgcmV0dXJuIGNvbnQodHlwZWV4cHIpOwogICAgICBpZiAodmFsdWUgPT0gIj8iKSByZXR1cm4gY29udChtYXliZXR5cGUpOwogICAgfQogIH0KICBmdW5jdGlvbiBtYXliZXR5cGVPckluKHR5cGUsIHZhbHVlKSB7CiAgICBpZiAoaXNUUyAmJiAodHlwZSA9PSAiOiIgfHwgdmFsdWUgPT0gImluIikpIHJldHVybiBjb250KHR5cGVleHByKQogIH0KICBmdW5jdGlvbiBtYXliZXJldHR5cGUodHlwZSkgewogICAgaWYgKGlzVFMgJiYgdHlwZSA9PSAiOiIpIHsKICAgICAgaWYgKGN4LnN0cmVhbS5tYXRjaCgvXlxzKlx3K1xzK2lzXGIvLCBmYWxzZSkpIHJldHVybiBjb250KGV4cHJlc3Npb24sIGlzS1csIHR5cGVleHByKQogICAgICBlbHNlIHJldHVybiBjb250KHR5cGVleHByKQogICAgfQogIH0KICBmdW5jdGlvbiBpc0tXKF8sIHZhbHVlKSB7CiAgICBpZiAodmFsdWUgPT0gImlzIikgewogICAgICBjeC5tYXJrZWQgPSAia2V5d29yZCIKICAgICAgcmV0dXJuIGNvbnQoKQogICAgfQogIH0KICBmdW5jdGlvbiB0eXBlZXhwcih0eXBlLCB2YWx1ZSkgewogICAgaWYgKHZhbHVlID09ICJrZXlvZiIgfHwgdmFsdWUgPT0gInR5cGVvZiIgfHwgdmFsdWUgPT0gImluZmVyIikgewogICAgICBjeC5tYXJrZWQgPSAia2V5d29yZCIKICAgICAgcmV0dXJuIGNvbnQodmFsdWUgPT0gInR5cGVvZiIgPyBleHByZXNzaW9uTm9Db21tYSA6IHR5cGVleHByKQogICAgfQogICAgaWYgKHR5cGUgPT0gInZhcmlhYmxlIiB8fCB2YWx1ZSA9PSAidm9pZCIpIHsKICAgICAgY3gubWFya2VkID0gInR5cGUiCiAgICAgIHJldHVybiBjb250KGFmdGVyVHlwZSkKICAgIH0KICAgIGlmICh2YWx1ZSA9PSAifCIgfHwgdmFsdWUgPT0gIiYiKSByZXR1cm4gY29udCh0eXBlZXhwcikKICAgIGlmICh0eXBlID09ICJzdHJpbmciIHx8IHR5cGUgPT0gIm51bWJlciIgfHwgdHlwZSA9PSAiYXRvbSIpIHJldHVybiBjb250KGFmdGVyVHlwZSk7CiAgICBpZiAodHlwZSA9PSAiWyIpIHJldHVybiBjb250KHB1c2hsZXgoIl0iKSwgY29tbWFzZXAodHlwZWV4cHIsICJdIiwgIiwiKSwgcG9wbGV4LCBhZnRlclR5cGUpCiAgICBpZiAodHlwZSA9PSAieyIpIHJldHVybiBjb250KHB1c2hsZXgoIn0iKSwgY29tbWFzZXAodHlwZXByb3AsICJ9IiwgIiw7IiksIHBvcGxleCwgYWZ0ZXJUeXBlKQogICAgaWYgKHR5cGUgPT0gIigiKSByZXR1cm4gY29udChjb21tYXNlcCh0eXBlYXJnLCAiKSIpLCBtYXliZVJldHVyblR5cGUsIGFmdGVyVHlwZSkKICAgIGlmICh0eXBlID09ICI8IikgcmV0dXJuIGNvbnQoY29tbWFzZXAodHlwZWV4cHIsICI+IiksIHR5cGVleHByKQogIH0KICBmdW5jdGlvbiBtYXliZVJldHVyblR5cGUodHlwZSkgewogICAgaWYgKHR5cGUgPT0gIj0+IikgcmV0dXJuIGNvbnQodHlwZWV4cHIpCiAgfQogIGZ1bmN0aW9uIHR5cGVwcm9wKHR5cGUsIHZhbHVlKSB7CiAgICBpZiAodHlwZSA9PSAidmFyaWFibGUiIHx8IGN4LnN0eWxlID09ICJrZXl3b3JkIikgewogICAgICBjeC5tYXJrZWQgPSAicHJvcGVydHkiCiAgICAgIHJldHVybiBjb250KHR5cGVwcm9wKQogICAgfSBlbHNlIGlmICh2YWx1ZSA9PSAiPyIgfHwgdHlwZSA9PSAibnVtYmVyIiB8fCB0eXBlID09ICJzdHJpbmciKSB7CiAgICAgIHJldHVybiBjb250KHR5cGVwcm9wKQogICAgfSBlbHNlIGlmICh0eXBlID09ICI6IikgewogICAgICByZXR1cm4gY29udCh0eXBlZXhwcikKICAgIH0gZWxzZSBpZiAodHlwZSA9PSAiWyIpIHsKICAgICAgcmV0dXJuIGNvbnQoZXhwZWN0KCJ2YXJpYWJsZSIpLCBtYXliZXR5cGVPckluLCBleHBlY3QoIl0iKSwgdHlwZXByb3ApCiAgICB9IGVsc2UgaWYgKHR5cGUgPT0gIigiKSB7CiAgICAgIHJldHVybiBwYXNzKGZ1bmN0aW9uZGVjbCwgdHlwZXByb3ApCiAgICB9CiAgfQogIGZ1bmN0aW9uIHR5cGVhcmcodHlwZSwgdmFsdWUpIHsKICAgIGlmICh0eXBlID09ICJ2YXJpYWJsZSIgJiYgY3guc3RyZWFtLm1hdGNoKC9eXHMqWz86XS8sIGZhbHNlKSB8fCB2YWx1ZSA9PSAiPyIpIHJldHVybiBjb250KHR5cGVhcmcpCiAgICBpZiAodHlwZSA9PSAiOiIpIHJldHVybiBjb250KHR5cGVleHByKQogICAgaWYgKHR5cGUgPT0gInNwcmVhZCIpIHJldHVybiBjb250KHR5cGVhcmcpCiAgICByZXR1cm4gcGFzcyh0eXBlZXhwcikKICB9CiAgZnVuY3Rpb24gYWZ0ZXJUeXBlKHR5cGUsIHZhbHVlKSB7CiAgICBpZiAodmFsdWUgPT0gIjwiKSByZXR1cm4gY29udChwdXNobGV4KCI+IiksIGNvbW1hc2VwKHR5cGVleHByLCAiPiIpLCBwb3BsZXgsIGFmdGVyVHlwZSkKICAgIGlmICh2YWx1ZSA9PSAifCIgfHwgdHlwZSA9PSAiLiIgfHwgdmFsdWUgPT0gIiYiKSByZXR1cm4gY29udCh0eXBlZXhwcikKICAgIGlmICh0eXBlID09ICJbIikgcmV0dXJuIGNvbnQodHlwZWV4cHIsIGV4cGVjdCgiXSIpLCBhZnRlclR5cGUpCiAgICBpZiAodmFsdWUgPT0gImV4dGVuZHMiIHx8IHZhbHVlID09ICJpbXBsZW1lbnRzIikgeyBjeC5tYXJrZWQgPSAia2V5d29yZCI7IHJldHVybiBjb250KHR5cGVleHByKSB9CiAgICBpZiAodmFsdWUgPT0gIj8iKSByZXR1cm4gY29udCh0eXBlZXhwciwgZXhwZWN0KCI6IiksIHR5cGVleHByKQogIH0KICBmdW5jdGlvbiBtYXliZVR5cGVBcmdzKF8sIHZhbHVlKSB7CiAgICBpZiAodmFsdWUgPT0gIjwiKSByZXR1cm4gY29udChwdXNobGV4KCI+IiksIGNvbW1hc2VwKHR5cGVleHByLCAiPiIpLCBwb3BsZXgsIGFmdGVyVHlwZSkKICB9CiAgZnVuY3Rpb24gdHlwZXBhcmFtKCkgewogICAgcmV0dXJuIHBhc3ModHlwZWV4cHIsIG1heWJlVHlwZURlZmF1bHQpCiAgfQogIGZ1bmN0aW9uIG1heWJlVHlwZURlZmF1bHQoXywgdmFsdWUpIHsKICAgIGlmICh2YWx1ZSA9PSAiPSIpIHJldHVybiBjb250KHR5cGVleHByKQogIH0KICBmdW5jdGlvbiB2YXJkZWYoXywgdmFsdWUpIHsKICAgIGlmICh2YWx1ZSA9PSAiZW51bSIpIHtjeC5tYXJrZWQgPSAia2V5d29yZCI7IHJldHVybiBjb250KGVudW1kZWYpfQogICAgcmV0dXJuIHBhc3MocGF0dGVybiwgbWF5YmV0eXBlLCBtYXliZUFzc2lnbiwgdmFyZGVmQ29udCk7CiAgfQogIGZ1bmN0aW9uIHBhdHRlcm4odHlwZSwgdmFsdWUpIHsKICAgIGlmIChpc1RTICYmIGlzTW9kaWZpZXIodmFsdWUpKSB7IGN4Lm1hcmtlZCA9ICJrZXl3b3JkIjsgcmV0dXJuIGNvbnQocGF0dGVybikgfQogICAgaWYgKHR5cGUgPT0gInZhcmlhYmxlIikgeyByZWdpc3Rlcih2YWx1ZSk7IHJldHVybiBjb250KCk7IH0KICAgIGlmICh0eXBlID09ICJzcHJlYWQiKSByZXR1cm4gY29udChwYXR0ZXJuKTsKICAgIGlmICh0eXBlID09ICJbIikgcmV0dXJuIGNvbnRDb21tYXNlcChlbHRwYXR0ZXJuLCAiXSIpOwogICAgaWYgKHR5cGUgPT0gInsiKSByZXR1cm4gY29udENvbW1hc2VwKHByb3BwYXR0ZXJuLCAifSIpOwogIH0KICBmdW5jdGlvbiBwcm9wcGF0dGVybih0eXBlLCB2YWx1ZSkgewogICAgaWYgKHR5cGUgPT0gInZhcmlhYmxlIiAmJiAhY3guc3RyZWFtLm1hdGNoKC9eXHMqOi8sIGZhbHNlKSkgewogICAgICByZWdpc3Rlcih2YWx1ZSk7CiAgICAgIHJldHVybiBjb250KG1heWJlQXNzaWduKTsKICAgIH0KICAgIGlmICh0eXBlID09ICJ2YXJpYWJsZSIpIGN4Lm1hcmtlZCA9ICJwcm9wZXJ0eSI7CiAgICBpZiAodHlwZSA9PSAic3ByZWFkIikgcmV0dXJuIGNvbnQocGF0dGVybik7CiAgICBpZiAodHlwZSA9PSAifSIpIHJldHVybiBwYXNzKCk7CiAgICBpZiAodHlwZSA9PSAiWyIpIHJldHVybiBjb250KGV4cHJlc3Npb24sIGV4cGVjdCgnXScpLCBleHBlY3QoJzonKSwgcHJvcHBhdHRlcm4pOwogICAgcmV0dXJuIGNvbnQoZXhwZWN0KCI6IiksIHBhdHRlcm4sIG1heWJlQXNzaWduKTsKICB9CiAgZnVuY3Rpb24gZWx0cGF0dGVybigpIHsKICAgIHJldHVybiBwYXNzKHBhdHRlcm4sIG1heWJlQXNzaWduKQogIH0KICBmdW5jdGlvbiBtYXliZUFzc2lnbihfdHlwZSwgdmFsdWUpIHsKICAgIGlmICh2YWx1ZSA9PSAiPSIpIHJldHVybiBjb250KGV4cHJlc3Npb25Ob0NvbW1hKTsKICB9CiAgZnVuY3Rpb24gdmFyZGVmQ29udCh0eXBlKSB7CiAgICBpZiAodHlwZSA9PSAiLCIpIHJldHVybiBjb250KHZhcmRlZik7CiAgfQogIGZ1bmN0aW9uIG1heWJlZWxzZSh0eXBlLCB2YWx1ZSkgewogICAgaWYgKHR5cGUgPT0gImtleXdvcmQgYiIgJiYgdmFsdWUgPT0gImVsc2UiKSByZXR1cm4gY29udChwdXNobGV4KCJmb3JtIiwgImVsc2UiKSwgc3RhdGVtZW50LCBwb3BsZXgpOwogIH0KICBmdW5jdGlvbiBmb3JzcGVjKHR5cGUsIHZhbHVlKSB7CiAgICBpZiAodmFsdWUgPT0gImF3YWl0IikgcmV0dXJuIGNvbnQoZm9yc3BlYyk7CiAgICBpZiAodHlwZSA9PSAiKCIpIHJldHVybiBjb250KHB1c2hsZXgoIikiKSwgZm9yc3BlYzEsIHBvcGxleCk7CiAgfQogIGZ1bmN0aW9uIGZvcnNwZWMxKHR5cGUpIHsKICAgIGlmICh0eXBlID09ICJ2YXIiKSByZXR1cm4gY29udCh2YXJkZWYsIGZvcnNwZWMyKTsKICAgIGlmICh0eXBlID09ICJ2YXJpYWJsZSIpIHJldHVybiBjb250KGZvcnNwZWMyKTsKICAgIHJldHVybiBwYXNzKGZvcnNwZWMyKQogIH0KICBmdW5jdGlvbiBmb3JzcGVjMih0eXBlLCB2YWx1ZSkgewogICAgaWYgKHR5cGUgPT0gIikiKSByZXR1cm4gY29udCgpCiAgICBpZiAodHlwZSA9PSAiOyIpIHJldHVybiBjb250KGZvcnNwZWMyKQogICAgaWYgKHZhbHVlID09ICJpbiIgfHwgdmFsdWUgPT0gIm9mIikgeyBjeC5tYXJrZWQgPSAia2V5d29yZCI7IHJldHVybiBjb250KGV4cHJlc3Npb24sIGZvcnNwZWMyKSB9CiAgICByZXR1cm4gcGFzcyhleHByZXNzaW9uLCBmb3JzcGVjMikKICB9CiAgZnVuY3Rpb24gZnVuY3Rpb25kZWYodHlwZSwgdmFsdWUpIHsKICAgIGlmICh2YWx1ZSA9PSAiKiIpIHtjeC5tYXJrZWQgPSAia2V5d29yZCI7IHJldHVybiBjb250KGZ1bmN0aW9uZGVmKTt9CiAgICBpZiAodHlwZSA9PSAidmFyaWFibGUiKSB7cmVnaXN0ZXIodmFsdWUpOyByZXR1cm4gY29udChmdW5jdGlvbmRlZik7fQogICAgaWYgKHR5cGUgPT0gIigiKSByZXR1cm4gY29udChwdXNoY29udGV4dCwgcHVzaGxleCgiKSIpLCBjb21tYXNlcChmdW5hcmcsICIpIiksIHBvcGxleCwgbWF5YmVyZXR0eXBlLCBzdGF0ZW1lbnQsIHBvcGNvbnRleHQpOwogICAgaWYgKGlzVFMgJiYgdmFsdWUgPT0gIjwiKSByZXR1cm4gY29udChwdXNobGV4KCI+IiksIGNvbW1hc2VwKHR5cGVwYXJhbSwgIj4iKSwgcG9wbGV4LCBmdW5jdGlvbmRlZikKICB9CiAgZnVuY3Rpb24gZnVuY3Rpb25kZWNsKHR5cGUsIHZhbHVlKSB7CiAgICBpZiAodmFsdWUgPT0gIioiKSB7Y3gubWFya2VkID0gImtleXdvcmQiOyByZXR1cm4gY29udChmdW5jdGlvbmRlY2wpO30KICAgIGlmICh0eXBlID09ICJ2YXJpYWJsZSIpIHtyZWdpc3Rlcih2YWx1ZSk7IHJldHVybiBjb250KGZ1bmN0aW9uZGVjbCk7fQogICAgaWYgKHR5cGUgPT0gIigiKSByZXR1cm4gY29udChwdXNoY29udGV4dCwgcHVzaGxleCgiKSIpLCBjb21tYXNlcChmdW5hcmcsICIpIiksIHBvcGxleCwgbWF5YmVyZXR0eXBlLCBwb3Bjb250ZXh0KTsKICAgIGlmIChpc1RTICYmIHZhbHVlID09ICI8IikgcmV0dXJuIGNvbnQocHVzaGxleCgiPiIpLCBjb21tYXNlcCh0eXBlcGFyYW0sICI+IiksIHBvcGxleCwgZnVuY3Rpb25kZWNsKQogIH0KICBmdW5jdGlvbiB0eXBlbmFtZSh0eXBlLCB2YWx1ZSkgewogICAgaWYgKHR5cGUgPT0gImtleXdvcmQiIHx8IHR5cGUgPT0gInZhcmlhYmxlIikgewogICAgICBjeC5tYXJrZWQgPSAidHlwZSIKICAgICAgcmV0dXJuIGNvbnQodHlwZW5hbWUpCiAgICB9IGVsc2UgaWYgKHZhbHVlID09ICI8IikgewogICAgICByZXR1cm4gY29udChwdXNobGV4KCI+IiksIGNvbW1hc2VwKHR5cGVwYXJhbSwgIj4iKSwgcG9wbGV4KQogICAgfQogIH0KICBmdW5jdGlvbiBmdW5hcmcodHlwZSwgdmFsdWUpIHsKICAgIGlmICh2YWx1ZSA9PSAiQCIpIGNvbnQoZXhwcmVzc2lvbiwgZnVuYXJnKQogICAgaWYgKHR5cGUgPT0gInNwcmVhZCIpIHJldHVybiBjb250KGZ1bmFyZyk7CiAgICBpZiAoaXNUUyAmJiBpc01vZGlmaWVyKHZhbHVlKSkgeyBjeC5tYXJrZWQgPSAia2V5d29yZCI7IHJldHVybiBjb250KGZ1bmFyZyk7IH0KICAgIGlmIChpc1RTICYmIHR5cGUgPT0gInRoaXMiKSByZXR1cm4gY29udChtYXliZXR5cGUsIG1heWJlQXNzaWduKQogICAgcmV0dXJuIHBhc3MocGF0dGVybiwgbWF5YmV0eXBlLCBtYXliZUFzc2lnbik7CiAgfQogIGZ1bmN0aW9uIGNsYXNzRXhwcmVzc2lvbih0eXBlLCB2YWx1ZSkgewogICAgLy8gQ2xhc3MgZXhwcmVzc2lvbnMgbWF5IGhhdmUgYW4gb3B0aW9uYWwgbmFtZS4KICAgIGlmICh0eXBlID09ICJ2YXJpYWJsZSIpIHJldHVybiBjbGFzc05hbWUodHlwZSwgdmFsdWUpOwogICAgcmV0dXJuIGNsYXNzTmFtZUFmdGVyKHR5cGUsIHZhbHVlKTsKICB9CiAgZnVuY3Rpb24gY2xhc3NOYW1lKHR5cGUsIHZhbHVlKSB7CiAgICBpZiAodHlwZSA9PSAidmFyaWFibGUiKSB7cmVnaXN0ZXIodmFsdWUpOyByZXR1cm4gY29udChjbGFzc05hbWVBZnRlcik7fQogIH0KICBmdW5jdGlvbiBjbGFzc05hbWVBZnRlcih0eXBlLCB2YWx1ZSkgewogICAgaWYgKHZhbHVlID09ICI8IikgcmV0dXJuIGNvbnQocHVzaGxleCgiPiIpLCBjb21tYXNlcCh0eXBlcGFyYW0sICI+IiksIHBvcGxleCwgY2xhc3NOYW1lQWZ0ZXIpCiAgICBpZiAodmFsdWUgPT0gImV4dGVuZHMiIHx8IHZhbHVlID09ICJpbXBsZW1lbnRzIiB8fCAoaXNUUyAmJiB0eXBlID09ICIsIikpIHsKICAgICAgaWYgKHZhbHVlID09ICJpbXBsZW1lbnRzIikgY3gubWFya2VkID0gImtleXdvcmQiOwogICAgICByZXR1cm4gY29udChpc1RTID8gdHlwZWV4cHIgOiBleHByZXNzaW9uLCBjbGFzc05hbWVBZnRlcik7CiAgICB9CiAgICBpZiAodHlwZSA9PSAieyIpIHJldHVybiBjb250KHB1c2hsZXgoIn0iKSwgY2xhc3NCb2R5LCBwb3BsZXgpOwogIH0KICBmdW5jdGlvbiBjbGFzc0JvZHkodHlwZSwgdmFsdWUpIHsKICAgIGlmICh0eXBlID09ICJhc3luYyIgfHwKICAgICAgICAodHlwZSA9PSAidmFyaWFibGUiICYmCiAgICAgICAgICh2YWx1ZSA9PSAic3RhdGljIiB8fCB2YWx1ZSA9PSAiZ2V0IiB8fCB2YWx1ZSA9PSAic2V0IiB8fCAoaXNUUyAmJiBpc01vZGlmaWVyKHZhbHVlKSkpICYmCiAgICAgICAgIGN4LnN0cmVhbS5tYXRjaCgvXlxzK1tcdyRceGExLVx1ZmZmZl0vLCBmYWxzZSkpKSB7CiAgICAgIGN4Lm1hcmtlZCA9ICJrZXl3b3JkIjsKICAgICAgcmV0dXJuIGNvbnQoY2xhc3NCb2R5KTsKICAgIH0KICAgIGlmICh0eXBlID09ICJ2YXJpYWJsZSIgfHwgY3guc3R5bGUgPT0gImtleXdvcmQiKSB7CiAgICAgIGN4Lm1hcmtlZCA9ICJwcm9wZXJ0eSI7CiAgICAgIHJldHVybiBjb250KGlzVFMgPyBjbGFzc2ZpZWxkIDogZnVuY3Rpb25kZWYsIGNsYXNzQm9keSk7CiAgICB9CiAgICBpZiAodHlwZSA9PSAibnVtYmVyIiB8fCB0eXBlID09ICJzdHJpbmciKSByZXR1cm4gY29udChpc1RTID8gY2xhc3NmaWVsZCA6IGZ1bmN0aW9uZGVmLCBjbGFzc0JvZHkpOwogICAgaWYgKHR5cGUgPT0gIlsiKQogICAgICByZXR1cm4gY29udChleHByZXNzaW9uLCBtYXliZXR5cGUsIGV4cGVjdCgiXSIpLCBpc1RTID8gY2xhc3NmaWVsZCA6IGZ1bmN0aW9uZGVmLCBjbGFzc0JvZHkpCiAgICBpZiAodmFsdWUgPT0gIioiKSB7CiAgICAgIGN4Lm1hcmtlZCA9ICJrZXl3b3JkIjsKICAgICAgcmV0dXJuIGNvbnQoY2xhc3NCb2R5KTsKICAgIH0KICAgIGlmIChpc1RTICYmIHR5cGUgPT0gIigiKSByZXR1cm4gcGFzcyhmdW5jdGlvbmRlY2wsIGNsYXNzQm9keSkKICAgIGlmICh0eXBlID09ICI7IiB8fCB0eXBlID09ICIsIikgcmV0dXJuIGNvbnQoY2xhc3NCb2R5KTsKICAgIGlmICh0eXBlID09ICJ9IikgcmV0dXJuIGNvbnQoKTsKICAgIGlmICh2YWx1ZSA9PSAiQCIpIHJldHVybiBjb250KGV4cHJlc3Npb24sIGNsYXNzQm9keSkKICB9CiAgZnVuY3Rpb24gY2xhc3NmaWVsZCh0eXBlLCB2YWx1ZSkgewogICAgaWYgKHZhbHVlID09ICI/IikgcmV0dXJuIGNvbnQoY2xhc3NmaWVsZCkKICAgIGlmICh0eXBlID09ICI6IikgcmV0dXJuIGNvbnQodHlwZWV4cHIsIG1heWJlQXNzaWduKQogICAgaWYgKHZhbHVlID09ICI9IikgcmV0dXJuIGNvbnQoZXhwcmVzc2lvbk5vQ29tbWEpCiAgICB2YXIgY29udGV4dCA9IGN4LnN0YXRlLmxleGljYWwucHJldiwgaXNJbnRlcmZhY2UgPSBjb250ZXh0ICYmIGNvbnRleHQuaW5mbyA9PSAiaW50ZXJmYWNlIgogICAgcmV0dXJuIHBhc3MoaXNJbnRlcmZhY2UgPyBmdW5jdGlvbmRlY2wgOiBmdW5jdGlvbmRlZikKICB9CiAgZnVuY3Rpb24gYWZ0ZXJFeHBvcnQodHlwZSwgdmFsdWUpIHsKICAgIGlmICh2YWx1ZSA9PSAiKiIpIHsgY3gubWFya2VkID0gImtleXdvcmQiOyByZXR1cm4gY29udChtYXliZUZyb20sIGV4cGVjdCgiOyIpKTsgfQogICAgaWYgKHZhbHVlID09ICJkZWZhdWx0IikgeyBjeC5tYXJrZWQgPSAia2V5d29yZCI7IHJldHVybiBjb250KGV4cHJlc3Npb24sIGV4cGVjdCgiOyIpKTsgfQogICAgaWYgKHR5cGUgPT0gInsiKSByZXR1cm4gY29udChjb21tYXNlcChleHBvcnRGaWVsZCwgIn0iKSwgbWF5YmVGcm9tLCBleHBlY3QoIjsiKSk7CiAgICByZXR1cm4gcGFzcyhzdGF0ZW1lbnQpOwogIH0KICBmdW5jdGlvbiBleHBvcnRGaWVsZCh0eXBlLCB2YWx1ZSkgewogICAgaWYgKHZhbHVlID09ICJhcyIpIHsgY3gubWFya2VkID0gImtleXdvcmQiOyByZXR1cm4gY29udChleHBlY3QoInZhcmlhYmxlIikpOyB9CiAgICBpZiAodHlwZSA9PSAidmFyaWFibGUiKSByZXR1cm4gcGFzcyhleHByZXNzaW9uTm9Db21tYSwgZXhwb3J0RmllbGQpOwogIH0KICBmdW5jdGlvbiBhZnRlckltcG9ydCh0eXBlKSB7CiAgICBpZiAodHlwZSA9PSAic3RyaW5nIikgcmV0dXJuIGNvbnQoKTsKICAgIGlmICh0eXBlID09ICIoIikgcmV0dXJuIHBhc3MoZXhwcmVzc2lvbik7CiAgICByZXR1cm4gcGFzcyhpbXBvcnRTcGVjLCBtYXliZU1vcmVJbXBvcnRzLCBtYXliZUZyb20pOwogIH0KICBmdW5jdGlvbiBpbXBvcnRTcGVjKHR5cGUsIHZhbHVlKSB7CiAgICBpZiAodHlwZSA9PSAieyIpIHJldHVybiBjb250Q29tbWFzZXAoaW1wb3J0U3BlYywgIn0iKTsKICAgIGlmICh0eXBlID09ICJ2YXJpYWJsZSIpIHJlZ2lzdGVyKHZhbHVlKTsKICAgIGlmICh2YWx1ZSA9PSAiKiIpIGN4Lm1hcmtlZCA9ICJrZXl3b3JkIjsKICAgIHJldHVybiBjb250KG1heWJlQXMpOwogIH0KICBmdW5jdGlvbiBtYXliZU1vcmVJbXBvcnRzKHR5cGUpIHsKICAgIGlmICh0eXBlID09ICIsIikgcmV0dXJuIGNvbnQoaW1wb3J0U3BlYywgbWF5YmVNb3JlSW1wb3J0cykKICB9CiAgZnVuY3Rpb24gbWF5YmVBcyhfdHlwZSwgdmFsdWUpIHsKICAgIGlmICh2YWx1ZSA9PSAiYXMiKSB7IGN4Lm1hcmtlZCA9ICJrZXl3b3JkIjsgcmV0dXJuIGNvbnQoaW1wb3J0U3BlYyk7IH0KICB9CiAgZnVuY3Rpb24gbWF5YmVGcm9tKF90eXBlLCB2YWx1ZSkgewogICAgaWYgKHZhbHVlID09ICJmcm9tIikgeyBjeC5tYXJrZWQgPSAia2V5d29yZCI7IHJldHVybiBjb250KGV4cHJlc3Npb24pOyB9CiAgfQogIGZ1bmN0aW9uIGFycmF5TGl0ZXJhbCh0eXBlKSB7CiAgICBpZiAodHlwZSA9PSAiXSIpIHJldHVybiBjb250KCk7CiAgICByZXR1cm4gcGFzcyhjb21tYXNlcChleHByZXNzaW9uTm9Db21tYSwgIl0iKSk7CiAgfQogIGZ1bmN0aW9uIGVudW1kZWYoKSB7CiAgICByZXR1cm4gcGFzcyhwdXNobGV4KCJmb3JtIiksIHBhdHRlcm4sIGV4cGVjdCgieyIpLCBwdXNobGV4KCJ9IiksIGNvbW1hc2VwKGVudW1tZW1iZXIsICJ9IiksIHBvcGxleCwgcG9wbGV4KQogIH0KICBmdW5jdGlvbiBlbnVtbWVtYmVyKCkgewogICAgcmV0dXJuIHBhc3MocGF0dGVybiwgbWF5YmVBc3NpZ24pOwogIH0KCiAgZnVuY3Rpb24gaXNDb250aW51ZWRTdGF0ZW1lbnQoc3RhdGUsIHRleHRBZnRlcikgewogICAgcmV0dXJuIHN0YXRlLmxhc3RUeXBlID09ICJvcGVyYXRvciIgfHwgc3RhdGUubGFzdFR5cGUgPT0gIiwiIHx8CiAgICAgIGlzT3BlcmF0b3JDaGFyLnRlc3QodGV4dEFmdGVyLmNoYXJBdCgwKSkgfHwKICAgICAgL1ssLl0vLnRlc3QodGV4dEFmdGVyLmNoYXJBdCgwKSk7CiAgfQoKICBmdW5jdGlvbiBleHByZXNzaW9uQWxsb3dlZChzdHJlYW0sIHN0YXRlLCBiYWNrVXApIHsKICAgIHJldHVybiBzdGF0ZS50b2tlbml6ZSA9PSB0b2tlbkJhc2UgJiYKICAgICAgL14oPzpvcGVyYXRvcnxzb2Z8a2V5d29yZCBbYmNkXXxjYXNlfG5ld3xleHBvcnR8ZGVmYXVsdHxzcHJlYWR8W1xbe31cKCw7Ol18PT4pJC8udGVzdChzdGF0ZS5sYXN0VHlwZSkgfHwKICAgICAgKHN0YXRlLmxhc3RUeXBlID09ICJxdWFzaSIgJiYgL1x7XHMqJC8udGVzdChzdHJlYW0uc3RyaW5nLnNsaWNlKDAsIHN0cmVhbS5wb3MgLSAoYmFja1VwIHx8IDApKSkpCiAgfQoKICAvLyBJbnRlcmZhY2UKCiAgcmV0dXJuIHsKICAgIHN0YXJ0U3RhdGU6IGZ1bmN0aW9uKGJhc2Vjb2x1bW4pIHsKICAgICAgdmFyIHN0YXRlID0gewogICAgICAgIHRva2VuaXplOiB0b2tlbkJhc2UsCiAgICAgICAgbGFzdFR5cGU6ICJzb2YiLAogICAgICAgIGNjOiBbXSwKICAgICAgICBsZXhpY2FsOiBuZXcgSlNMZXhpY2FsKChiYXNlY29sdW1uIHx8IDApIC0gaW5kZW50VW5pdCwgMCwgImJsb2NrIiwgZmFsc2UpLAogICAgICAgIGxvY2FsVmFyczogcGFyc2VyQ29uZmlnLmxvY2FsVmFycywKICAgICAgICBjb250ZXh0OiBwYXJzZXJDb25maWcubG9jYWxWYXJzICYmIG5ldyBDb250ZXh0KG51bGwsIG51bGwsIGZhbHNlKSwKICAgICAgICBpbmRlbnRlZDogYmFzZWNvbHVtbiB8fCAwCiAgICAgIH07CiAgICAgIGlmIChwYXJzZXJDb25maWcuZ2xvYmFsVmFycyAmJiB0eXBlb2YgcGFyc2VyQ29uZmlnLmdsb2JhbFZhcnMgPT0gIm9iamVjdCIpCiAgICAgICAgc3RhdGUuZ2xvYmFsVmFycyA9IHBhcnNlckNvbmZpZy5nbG9iYWxWYXJzOwogICAgICByZXR1cm4gc3RhdGU7CiAgICB9LAoKICAgIHRva2VuOiBmdW5jdGlvbihzdHJlYW0sIHN0YXRlKSB7CiAgICAgIGlmIChzdHJlYW0uc29sKCkpIHsKICAgICAgICBpZiAoIXN0YXRlLmxleGljYWwuaGFzT3duUHJvcGVydHkoImFsaWduIikpCiAgICAgICAgICBzdGF0ZS5sZXhpY2FsLmFsaWduID0gZmFsc2U7CiAgICAgICAgc3RhdGUuaW5kZW50ZWQgPSBzdHJlYW0uaW5kZW50YXRpb24oKTsKICAgICAgICBmaW5kRmF0QXJyb3coc3RyZWFtLCBzdGF0ZSk7CiAgICAgIH0KICAgICAgaWYgKHN0YXRlLnRva2VuaXplICE9IHRva2VuQ29tbWVudCAmJiBzdHJlYW0uZWF0U3BhY2UoKSkgcmV0dXJuIG51bGw7CiAgICAgIHZhciBzdHlsZSA9IHN0YXRlLnRva2VuaXplKHN0cmVhbSwgc3RhdGUpOwogICAgICBpZiAodHlwZSA9PSAiY29tbWVudCIpIHJldHVybiBzdHlsZTsKICAgICAgc3RhdGUubGFzdFR5cGUgPSB0eXBlID09ICJvcGVyYXRvciIgJiYgKGNvbnRlbnQgPT0gIisrIiB8fCBjb250ZW50ID09ICItLSIpID8gImluY2RlYyIgOiB0eXBlOwogICAgICByZXR1cm4gcGFyc2VKUyhzdGF0ZSwgc3R5bGUsIHR5cGUsIGNvbnRlbnQsIHN0cmVhbSk7CiAgICB9LAoKICAgIGluZGVudDogZnVuY3Rpb24oc3RhdGUsIHRleHRBZnRlcikgewogICAgICBpZiAoc3RhdGUudG9rZW5pemUgPT0gdG9rZW5Db21tZW50KSByZXR1cm4gQ29kZU1pcnJvci5QYXNzOwogICAgICBpZiAoc3RhdGUudG9rZW5pemUgIT0gdG9rZW5CYXNlKSByZXR1cm4gMDsKICAgICAgdmFyIGZpcnN0Q2hhciA9IHRleHRBZnRlciAmJiB0ZXh0QWZ0ZXIuY2hhckF0KDApLCBsZXhpY2FsID0gc3RhdGUubGV4aWNhbCwgdG9wCiAgICAgIC8vIEtsdWRnZSB0byBwcmV2ZW50ICdtYXliZWxzZScgZnJvbSBibG9ja2luZyBsZXhpY2FsIHNjb3BlIHBvcHMKICAgICAgaWYgKCEvXlxzKmVsc2VcYi8udGVzdCh0ZXh0QWZ0ZXIpKSBmb3IgKHZhciBpID0gc3RhdGUuY2MubGVuZ3RoIC0gMTsgaSA+PSAwOyAtLWkpIHsKICAgICAgICB2YXIgYyA9IHN0YXRlLmNjW2ldOwogICAgICAgIGlmIChjID09IHBvcGxleCkgbGV4aWNhbCA9IGxleGljYWwucHJldjsKICAgICAgICBlbHNlIGlmIChjICE9IG1heWJlZWxzZSkgYnJlYWs7CiAgICAgIH0KICAgICAgd2hpbGUgKChsZXhpY2FsLnR5cGUgPT0gInN0YXQiIHx8IGxleGljYWwudHlwZSA9PSAiZm9ybSIpICYmCiAgICAgICAgICAgICAoZmlyc3RDaGFyID09ICJ9IiB8fCAoKHRvcCA9IHN0YXRlLmNjW3N0YXRlLmNjLmxlbmd0aCAtIDFdKSAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICh0b3AgPT0gbWF5YmVvcGVyYXRvckNvbW1hIHx8IHRvcCA9PSBtYXliZW9wZXJhdG9yTm9Db21tYSkgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAhL15bLFwuPStcLSo6P1tcKF0vLnRlc3QodGV4dEFmdGVyKSkpKQogICAgICAgIGxleGljYWwgPSBsZXhpY2FsLnByZXY7CiAgICAgIGlmIChzdGF0ZW1lbnRJbmRlbnQgJiYgbGV4aWNhbC50eXBlID09ICIpIiAmJiBsZXhpY2FsLnByZXYudHlwZSA9PSAic3RhdCIpCiAgICAgICAgbGV4aWNhbCA9IGxleGljYWwucHJldjsKICAgICAgdmFyIHR5cGUgPSBsZXhpY2FsLnR5cGUsIGNsb3NpbmcgPSBmaXJzdENoYXIgPT0gdHlwZTsKCiAgICAgIGlmICh0eXBlID09ICJ2YXJkZWYiKSByZXR1cm4gbGV4aWNhbC5pbmRlbnRlZCArIChzdGF0ZS5sYXN0VHlwZSA9PSAib3BlcmF0b3IiIHx8IHN0YXRlLmxhc3RUeXBlID09ICIsIiA/IGxleGljYWwuaW5mby5sZW5ndGggKyAxIDogMCk7CiAgICAgIGVsc2UgaWYgKHR5cGUgPT0gImZvcm0iICYmIGZpcnN0Q2hhciA9PSAieyIpIHJldHVybiBsZXhpY2FsLmluZGVudGVkOwogICAgICBlbHNlIGlmICh0eXBlID09ICJmb3JtIikgcmV0dXJuIGxleGljYWwuaW5kZW50ZWQgKyBpbmRlbnRVbml0OwogICAgICBlbHNlIGlmICh0eXBlID09ICJzdGF0IikKICAgICAgICByZXR1cm4gbGV4aWNhbC5pbmRlbnRlZCArIChpc0NvbnRpbnVlZFN0YXRlbWVudChzdGF0ZSwgdGV4dEFmdGVyKSA/IHN0YXRlbWVudEluZGVudCB8fCBpbmRlbnRVbml0IDogMCk7CiAgICAgIGVsc2UgaWYgKGxleGljYWwuaW5mbyA9PSAic3dpdGNoIiAmJiAhY2xvc2luZyAmJiBwYXJzZXJDb25maWcuZG91YmxlSW5kZW50U3dpdGNoICE9IGZhbHNlKQogICAgICAgIHJldHVybiBsZXhpY2FsLmluZGVudGVkICsgKC9eKD86Y2FzZXxkZWZhdWx0KVxiLy50ZXN0KHRleHRBZnRlcikgPyBpbmRlbnRVbml0IDogMiAqIGluZGVudFVuaXQpOwogICAgICBlbHNlIGlmIChsZXhpY2FsLmFsaWduKSByZXR1cm4gbGV4aWNhbC5jb2x1bW4gKyAoY2xvc2luZyA/IDAgOiAxKTsKICAgICAgZWxzZSByZXR1cm4gbGV4aWNhbC5pbmRlbnRlZCArIChjbG9zaW5nID8gMCA6IGluZGVudFVuaXQpOwogICAgfSwKCiAgICBlbGVjdHJpY0lucHV0OiAvXlxzKig/OmNhc2UgLio/OnxkZWZhdWx0Onxce3xcfSkkLywKICAgIGJsb2NrQ29tbWVudFN0YXJ0OiBqc29uTW9kZSA/IG51bGwgOiAiLyoiLAogICAgYmxvY2tDb21tZW50RW5kOiBqc29uTW9kZSA/IG51bGwgOiAiKi8iLAogICAgYmxvY2tDb21tZW50Q29udGludWU6IGpzb25Nb2RlID8gbnVsbCA6ICIgKiAiLAogICAgbGluZUNvbW1lbnQ6IGpzb25Nb2RlID8gbnVsbCA6ICIvLyIsCiAgICBmb2xkOiAiYnJhY2UiLAogICAgY2xvc2VCcmFja2V0czogIigpW117fScnXCJcImBgIiwKCiAgICBoZWxwZXJUeXBlOiBqc29uTW9kZSA/ICJqc29uIiA6ICJqYXZhc2NyaXB0IiwKICAgIGpzb25sZE1vZGU6IGpzb25sZE1vZGUsCiAgICBqc29uTW9kZToganNvbk1vZGUsCgogICAgZXhwcmVzc2lvbkFsbG93ZWQ6IGV4cHJlc3Npb25BbGxvd2VkLAoKICAgIHNraXBFeHByZXNzaW9uOiBmdW5jdGlvbihzdGF0ZSkgewogICAgICB2YXIgdG9wID0gc3RhdGUuY2Nbc3RhdGUuY2MubGVuZ3RoIC0gMV0KICAgICAgaWYgKHRvcCA9PSBleHByZXNzaW9uIHx8IHRvcCA9PSBleHByZXNzaW9uTm9Db21tYSkgc3RhdGUuY2MucG9wKCkKICAgIH0KICB9Owp9KTsKCkNvZGVNaXJyb3IucmVnaXN0ZXJIZWxwZXIoIndvcmRDaGFycyIsICJqYXZhc2NyaXB0IiwgL1tcdyRdLyk7CgpDb2RlTWlycm9yLmRlZmluZU1JTUUoInRleHQvamF2YXNjcmlwdCIsICJqYXZhc2NyaXB0Iik7CkNvZGVNaXJyb3IuZGVmaW5lTUlNRSgidGV4dC9lY21hc2NyaXB0IiwgImphdmFzY3JpcHQiKTsKQ29kZU1pcnJvci5kZWZpbmVNSU1FKCJhcHBsaWNhdGlvbi9qYXZhc2NyaXB0IiwgImphdmFzY3JpcHQiKTsKQ29kZU1pcnJvci5kZWZpbmVNSU1FKCJhcHBsaWNhdGlvbi94LWphdmFzY3JpcHQiLCAiamF2YXNjcmlwdCIpOwpDb2RlTWlycm9yLmRlZmluZU1JTUUoImFwcGxpY2F0aW9uL2VjbWFzY3JpcHQiLCAiamF2YXNjcmlwdCIpOwpDb2RlTWlycm9yLmRlZmluZU1JTUUoImFwcGxpY2F0aW9uL2pzb24iLCB7bmFtZTogImphdmFzY3JpcHQiLCBqc29uOiB0cnVlfSk7CkNvZGVNaXJyb3IuZGVmaW5lTUlNRSgiYXBwbGljYXRpb24veC1qc29uIiwge25hbWU6ICJqYXZhc2NyaXB0IiwganNvbjogdHJ1ZX0pOwpDb2RlTWlycm9yLmRlZmluZU1JTUUoImFwcGxpY2F0aW9uL2xkK2pzb24iLCB7bmFtZTogImphdmFzY3JpcHQiLCBqc29ubGQ6IHRydWV9KTsKQ29kZU1pcnJvci5kZWZpbmVNSU1FKCJ0ZXh0L3R5cGVzY3JpcHQiLCB7IG5hbWU6ICJqYXZhc2NyaXB0IiwgdHlwZXNjcmlwdDogdHJ1ZSB9KTsKQ29kZU1pcnJvci5kZWZpbmVNSU1FKCJhcHBsaWNhdGlvbi90eXBlc2NyaXB0IiwgeyBuYW1lOiAiamF2YXNjcmlwdCIsIHR5cGVzY3JpcHQ6IHRydWUgfSk7Cgp9KTsK","codemirror/xml.js":"Ly8gQ29kZU1pcnJvciwgY29weXJpZ2h0IChjKSBieSBNYXJpam4gSGF2ZXJiZWtlIGFuZCBvdGhlcnMKLy8gRGlzdHJpYnV0ZWQgdW5kZXIgYW4gTUlUIGxpY2Vuc2U6IGh0dHBzOi8vY29kZW1pcnJvci5uZXQvTElDRU5TRQoKKGZ1bmN0aW9uKG1vZCkgewogIGlmICh0eXBlb2YgZXhwb3J0cyA9PSAib2JqZWN0IiAmJiB0eXBlb2YgbW9kdWxlID09ICJvYmplY3QiKSAvLyBDb21tb25KUwogICAgbW9kKHJlcXVpcmUoIi4uLy4uL2xpYi9jb2RlbWlycm9yIikpOwogIGVsc2UgaWYgKHR5cGVvZiBkZWZpbmUgPT0gImZ1bmN0aW9uIiAmJiBkZWZpbmUuYW1kKSAvLyBBTUQKICAgIGRlZmluZShbIi4uLy4uL2xpYi9jb2RlbWlycm9yIl0sIG1vZCk7CiAgZWxzZSAvLyBQbGFpbiBicm93c2VyIGVudgogICAgbW9kKENvZGVNaXJyb3IpOwp9KShmdW5jdGlvbihDb2RlTWlycm9yKSB7CiJ1c2Ugc3RyaWN0IjsKCnZhciBodG1sQ29uZmlnID0gewogIGF1dG9TZWxmQ2xvc2VyczogeydhcmVhJzogdHJ1ZSwgJ2Jhc2UnOiB0cnVlLCAnYnInOiB0cnVlLCAnY29sJzogdHJ1ZSwgJ2NvbW1hbmQnOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICdlbWJlZCc6IHRydWUsICdmcmFtZSc6IHRydWUsICdocic6IHRydWUsICdpbWcnOiB0cnVlLCAnaW5wdXQnOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICdrZXlnZW4nOiB0cnVlLCAnbGluayc6IHRydWUsICdtZXRhJzogdHJ1ZSwgJ3BhcmFtJzogdHJ1ZSwgJ3NvdXJjZSc6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgJ3RyYWNrJzogdHJ1ZSwgJ3dicic6IHRydWUsICdtZW51aXRlbSc6IHRydWV9LAogIGltcGxpY2l0bHlDbG9zZWQ6IHsnZGQnOiB0cnVlLCAnbGknOiB0cnVlLCAnb3B0Z3JvdXAnOiB0cnVlLCAnb3B0aW9uJzogdHJ1ZSwgJ3AnOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAncnAnOiB0cnVlLCAncnQnOiB0cnVlLCAndGJvZHknOiB0cnVlLCAndGQnOiB0cnVlLCAndGZvb3QnOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAndGgnOiB0cnVlLCAndHInOiB0cnVlfSwKICBjb250ZXh0R3JhYmJlcnM6IHsKICAgICdkZCc6IHsnZGQnOiB0cnVlLCAnZHQnOiB0cnVlfSwKICAgICdkdCc6IHsnZGQnOiB0cnVlLCAnZHQnOiB0cnVlfSwKICAgICdsaSc6IHsnbGknOiB0cnVlfSwKICAgICdvcHRpb24nOiB7J29wdGlvbic6IHRydWUsICdvcHRncm91cCc6IHRydWV9LAogICAgJ29wdGdyb3VwJzogeydvcHRncm91cCc6IHRydWV9LAogICAgJ3AnOiB7J2FkZHJlc3MnOiB0cnVlLCAnYXJ0aWNsZSc6IHRydWUsICdhc2lkZSc6IHRydWUsICdibG9ja3F1b3RlJzogdHJ1ZSwgJ2Rpcic6IHRydWUsCiAgICAgICAgICAnZGl2JzogdHJ1ZSwgJ2RsJzogdHJ1ZSwgJ2ZpZWxkc2V0JzogdHJ1ZSwgJ2Zvb3Rlcic6IHRydWUsICdmb3JtJzogdHJ1ZSwKICAgICAgICAgICdoMSc6IHRydWUsICdoMic6IHRydWUsICdoMyc6IHRydWUsICdoNCc6IHRydWUsICdoNSc6IHRydWUsICdoNic6IHRydWUsCiAgICAgICAgICAnaGVhZGVyJzogdHJ1ZSwgJ2hncm91cCc6IHRydWUsICdocic6IHRydWUsICdtZW51JzogdHJ1ZSwgJ25hdic6IHRydWUsICdvbCc6IHRydWUsCiAgICAgICAgICAncCc6IHRydWUsICdwcmUnOiB0cnVlLCAnc2VjdGlvbic6IHRydWUsICd0YWJsZSc6IHRydWUsICd1bCc6IHRydWV9LAogICAgJ3JwJzogeydycCc6IHRydWUsICdydCc6IHRydWV9LAogICAgJ3J0JzogeydycCc6IHRydWUsICdydCc6IHRydWV9LAogICAgJ3Rib2R5Jzogeyd0Ym9keSc6IHRydWUsICd0Zm9vdCc6IHRydWV9LAogICAgJ3RkJzogeyd0ZCc6IHRydWUsICd0aCc6IHRydWV9LAogICAgJ3Rmb290Jzogeyd0Ym9keSc6IHRydWV9LAogICAgJ3RoJzogeyd0ZCc6IHRydWUsICd0aCc6IHRydWV9LAogICAgJ3RoZWFkJzogeyd0Ym9keSc6IHRydWUsICd0Zm9vdCc6IHRydWV9LAogICAgJ3RyJzogeyd0cic6IHRydWV9CiAgfSwKICBkb05vdEluZGVudDogeyJwcmUiOiB0cnVlfSwKICBhbGxvd1VucXVvdGVkOiB0cnVlLAogIGFsbG93TWlzc2luZzogdHJ1ZSwKICBjYXNlRm9sZDogdHJ1ZQp9Cgp2YXIgeG1sQ29uZmlnID0gewogIGF1dG9TZWxmQ2xvc2Vyczoge30sCiAgaW1wbGljaXRseUNsb3NlZDoge30sCiAgY29udGV4dEdyYWJiZXJzOiB7fSwKICBkb05vdEluZGVudDoge30sCiAgYWxsb3dVbnF1b3RlZDogZmFsc2UsCiAgYWxsb3dNaXNzaW5nOiBmYWxzZSwKICBhbGxvd01pc3NpbmdUYWdOYW1lOiBmYWxzZSwKICBjYXNlRm9sZDogZmFsc2UKfQoKQ29kZU1pcnJvci5kZWZpbmVNb2RlKCJ4bWwiLCBmdW5jdGlvbihlZGl0b3JDb25mLCBjb25maWdfKSB7CiAgdmFyIGluZGVudFVuaXQgPSBlZGl0b3JDb25mLmluZGVudFVuaXQKICB2YXIgY29uZmlnID0ge30KICB2YXIgZGVmYXVsdHMgPSBjb25maWdfLmh0bWxNb2RlID8gaHRtbENvbmZpZyA6IHhtbENvbmZpZwogIGZvciAodmFyIHByb3AgaW4gZGVmYXVsdHMpIGNvbmZpZ1twcm9wXSA9IGRlZmF1bHRzW3Byb3BdCiAgZm9yICh2YXIgcHJvcCBpbiBjb25maWdfKSBjb25maWdbcHJvcF0gPSBjb25maWdfW3Byb3BdCgogIC8vIFJldHVybiB2YXJpYWJsZXMgZm9yIHRva2VuaXplcnMKICB2YXIgdHlwZSwgc2V0U3R5bGU7CgogIGZ1bmN0aW9uIGluVGV4dChzdHJlYW0sIHN0YXRlKSB7CiAgICBmdW5jdGlvbiBjaGFpbihwYXJzZXIpIHsKICAgICAgc3RhdGUudG9rZW5pemUgPSBwYXJzZXI7CiAgICAgIHJldHVybiBwYXJzZXIoc3RyZWFtLCBzdGF0ZSk7CiAgICB9CgogICAgdmFyIGNoID0gc3RyZWFtLm5leHQoKTsKICAgIGlmIChjaCA9PSAiPCIpIHsKICAgICAgaWYgKHN0cmVhbS5lYXQoIiEiKSkgewogICAgICAgIGlmIChzdHJlYW0uZWF0KCJbIikpIHsKICAgICAgICAgIGlmIChzdHJlYW0ubWF0Y2goIkNEQVRBWyIpKSByZXR1cm4gY2hhaW4oaW5CbG9jaygiYXRvbSIsICJdXT4iKSk7CiAgICAgICAgICBlbHNlIHJldHVybiBudWxsOwogICAgICAgIH0gZWxzZSBpZiAoc3RyZWFtLm1hdGNoKCItLSIpKSB7CiAgICAgICAgICByZXR1cm4gY2hhaW4oaW5CbG9jaygiY29tbWVudCIsICItLT4iKSk7CiAgICAgICAgfSBlbHNlIGlmIChzdHJlYW0ubWF0Y2goIkRPQ1RZUEUiLCB0cnVlLCB0cnVlKSkgewogICAgICAgICAgc3RyZWFtLmVhdFdoaWxlKC9bXHdcLl9cLV0vKTsKICAgICAgICAgIHJldHVybiBjaGFpbihkb2N0eXBlKDEpKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKHN0cmVhbS5lYXQoIj8iKSkgewogICAgICAgIHN0cmVhbS5lYXRXaGlsZSgvW1x3XC5fXC1dLyk7CiAgICAgICAgc3RhdGUudG9rZW5pemUgPSBpbkJsb2NrKCJtZXRhIiwgIj8+Iik7CiAgICAgICAgcmV0dXJuICJtZXRhIjsKICAgICAgfSBlbHNlIHsKICAgICAgICB0eXBlID0gc3RyZWFtLmVhdCgiLyIpID8gImNsb3NlVGFnIiA6ICJvcGVuVGFnIjsKICAgICAgICBzdGF0ZS50b2tlbml6ZSA9IGluVGFnOwogICAgICAgIHJldHVybiAidGFnIGJyYWNrZXQiOwogICAgICB9CiAgICB9IGVsc2UgaWYgKGNoID09ICImIikgewogICAgICB2YXIgb2s7CiAgICAgIGlmIChzdHJlYW0uZWF0KCIjIikpIHsKICAgICAgICBpZiAoc3RyZWFtLmVhdCgieCIpKSB7CiAgICAgICAgICBvayA9IHN0cmVhbS5lYXRXaGlsZSgvW2EtZkEtRlxkXS8pICYmIHN0cmVhbS5lYXQoIjsiKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgb2sgPSBzdHJlYW0uZWF0V2hpbGUoL1tcZF0vKSAmJiBzdHJlYW0uZWF0KCI7Iik7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIG9rID0gc3RyZWFtLmVhdFdoaWxlKC9bXHdcLlwtOl0vKSAmJiBzdHJlYW0uZWF0KCI7Iik7CiAgICAgIH0KICAgICAgcmV0dXJuIG9rID8gImF0b20iIDogImVycm9yIjsKICAgIH0gZWxzZSB7CiAgICAgIHN0cmVhbS5lYXRXaGlsZSgvW14mPF0vKTsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgfQogIGluVGV4dC5pc0luVGV4dCA9IHRydWU7CgogIGZ1bmN0aW9uIGluVGFnKHN0cmVhbSwgc3RhdGUpIHsKICAgIHZhciBjaCA9IHN0cmVhbS5uZXh0KCk7CiAgICBpZiAoY2ggPT0gIj4iIHx8IChjaCA9PSAiLyIgJiYgc3RyZWFtLmVhdCgiPiIpKSkgewogICAgICBzdGF0ZS50b2tlbml6ZSA9IGluVGV4dDsKICAgICAgdHlwZSA9IGNoID09ICI+IiA/ICJlbmRUYWciIDogInNlbGZjbG9zZVRhZyI7CiAgICAgIHJldHVybiAidGFnIGJyYWNrZXQiOwogICAgfSBlbHNlIGlmIChjaCA9PSAiPSIpIHsKICAgICAgdHlwZSA9ICJlcXVhbHMiOwogICAgICByZXR1cm4gbnVsbDsKICAgIH0gZWxzZSBpZiAoY2ggPT0gIjwiKSB7CiAgICAgIHN0YXRlLnRva2VuaXplID0gaW5UZXh0OwogICAgICBzdGF0ZS5zdGF0ZSA9IGJhc2VTdGF0ZTsKICAgICAgc3RhdGUudGFnTmFtZSA9IHN0YXRlLnRhZ1N0YXJ0ID0gbnVsbDsKICAgICAgdmFyIG5leHQgPSBzdGF0ZS50b2tlbml6ZShzdHJlYW0sIHN0YXRlKTsKICAgICAgcmV0dXJuIG5leHQgPyBuZXh0ICsgIiB0YWcgZXJyb3IiIDogInRhZyBlcnJvciI7CiAgICB9IGVsc2UgaWYgKC9bXCdcIl0vLnRlc3QoY2gpKSB7CiAgICAgIHN0YXRlLnRva2VuaXplID0gaW5BdHRyaWJ1dGUoY2gpOwogICAgICBzdGF0ZS5zdHJpbmdTdGFydENvbCA9IHN0cmVhbS5jb2x1bW4oKTsKICAgICAgcmV0dXJuIHN0YXRlLnRva2VuaXplKHN0cmVhbSwgc3RhdGUpOwogICAgfSBlbHNlIHsKICAgICAgc3RyZWFtLm1hdGNoKC9eW15cc1x1MDBhMD08PlwiXCddKlteXHNcdTAwYTA9PD5cIlwnXC9dLyk7CiAgICAgIHJldHVybiAid29yZCI7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBpbkF0dHJpYnV0ZShxdW90ZSkgewogICAgdmFyIGNsb3N1cmUgPSBmdW5jdGlvbihzdHJlYW0sIHN0YXRlKSB7CiAgICAgIHdoaWxlICghc3RyZWFtLmVvbCgpKSB7CiAgICAgICAgaWYgKHN0cmVhbS5uZXh0KCkgPT0gcXVvdGUpIHsKICAgICAgICAgIHN0YXRlLnRva2VuaXplID0gaW5UYWc7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuICJzdHJpbmciOwogICAgfTsKICAgIGNsb3N1cmUuaXNJbkF0dHJpYnV0ZSA9IHRydWU7CiAgICByZXR1cm4gY2xvc3VyZTsKICB9CgogIGZ1bmN0aW9uIGluQmxvY2soc3R5bGUsIHRlcm1pbmF0b3IpIHsKICAgIHJldHVybiBmdW5jdGlvbihzdHJlYW0sIHN0YXRlKSB7CiAgICAgIHdoaWxlICghc3RyZWFtLmVvbCgpKSB7CiAgICAgICAgaWYgKHN0cmVhbS5tYXRjaCh0ZXJtaW5hdG9yKSkgewogICAgICAgICAgc3RhdGUudG9rZW5pemUgPSBpblRleHQ7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgc3RyZWFtLm5leHQoKTsKICAgICAgfQogICAgICByZXR1cm4gc3R5bGU7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBkb2N0eXBlKGRlcHRoKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oc3RyZWFtLCBzdGF0ZSkgewogICAgICB2YXIgY2g7CiAgICAgIHdoaWxlICgoY2ggPSBzdHJlYW0ubmV4dCgpKSAhPSBudWxsKSB7CiAgICAgICAgaWYgKGNoID09ICI8IikgewogICAgICAgICAgc3RhdGUudG9rZW5pemUgPSBkb2N0eXBlKGRlcHRoICsgMSk7CiAgICAgICAgICByZXR1cm4gc3RhdGUudG9rZW5pemUoc3RyZWFtLCBzdGF0ZSk7CiAgICAgICAgfSBlbHNlIGlmIChjaCA9PSAiPiIpIHsKICAgICAgICAgIGlmIChkZXB0aCA9PSAxKSB7CiAgICAgICAgICAgIHN0YXRlLnRva2VuaXplID0gaW5UZXh0OwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN0YXRlLnRva2VuaXplID0gZG9jdHlwZShkZXB0aCAtIDEpOwogICAgICAgICAgICByZXR1cm4gc3RhdGUudG9rZW5pemUoc3RyZWFtLCBzdGF0ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiAibWV0YSI7CiAgICB9OwogIH0KCiAgZnVuY3Rpb24gQ29udGV4dChzdGF0ZSwgdGFnTmFtZSwgc3RhcnRPZkxpbmUpIHsKICAgIHRoaXMucHJldiA9IHN0YXRlLmNvbnRleHQ7CiAgICB0aGlzLnRhZ05hbWUgPSB0YWdOYW1lOwogICAgdGhpcy5pbmRlbnQgPSBzdGF0ZS5pbmRlbnRlZDsKICAgIHRoaXMuc3RhcnRPZkxpbmUgPSBzdGFydE9mTGluZTsKICAgIGlmIChjb25maWcuZG9Ob3RJbmRlbnQuaGFzT3duUHJvcGVydHkodGFnTmFtZSkgfHwgKHN0YXRlLmNvbnRleHQgJiYgc3RhdGUuY29udGV4dC5ub0luZGVudCkpCiAgICAgIHRoaXMubm9JbmRlbnQgPSB0cnVlOwogIH0KICBmdW5jdGlvbiBwb3BDb250ZXh0KHN0YXRlKSB7CiAgICBpZiAoc3RhdGUuY29udGV4dCkgc3RhdGUuY29udGV4dCA9IHN0YXRlLmNvbnRleHQucHJldjsKICB9CiAgZnVuY3Rpb24gbWF5YmVQb3BDb250ZXh0KHN0YXRlLCBuZXh0VGFnTmFtZSkgewogICAgdmFyIHBhcmVudFRhZ05hbWU7CiAgICB3aGlsZSAodHJ1ZSkgewogICAgICBpZiAoIXN0YXRlLmNvbnRleHQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgcGFyZW50VGFnTmFtZSA9IHN0YXRlLmNvbnRleHQudGFnTmFtZTsKICAgICAgaWYgKCFjb25maWcuY29udGV4dEdyYWJiZXJzLmhhc093blByb3BlcnR5KHBhcmVudFRhZ05hbWUpIHx8CiAgICAgICAgICAhY29uZmlnLmNvbnRleHRHcmFiYmVyc1twYXJlbnRUYWdOYW1lXS5oYXNPd25Qcm9wZXJ0eShuZXh0VGFnTmFtZSkpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgcG9wQ29udGV4dChzdGF0ZSk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBiYXNlU3RhdGUodHlwZSwgc3RyZWFtLCBzdGF0ZSkgewogICAgaWYgKHR5cGUgPT0gIm9wZW5UYWciKSB7CiAgICAgIHN0YXRlLnRhZ1N0YXJ0ID0gc3RyZWFtLmNvbHVtbigpOwogICAgICByZXR1cm4gdGFnTmFtZVN0YXRlOwogICAgfSBlbHNlIGlmICh0eXBlID09ICJjbG9zZVRhZyIpIHsKICAgICAgcmV0dXJuIGNsb3NlVGFnTmFtZVN0YXRlOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGJhc2VTdGF0ZTsKICAgIH0KICB9CiAgZnVuY3Rpb24gdGFnTmFtZVN0YXRlKHR5cGUsIHN0cmVhbSwgc3RhdGUpIHsKICAgIGlmICh0eXBlID09ICJ3b3JkIikgewogICAgICBzdGF0ZS50YWdOYW1lID0gc3RyZWFtLmN1cnJlbnQoKTsKICAgICAgc2V0U3R5bGUgPSAidGFnIjsKICAgICAgcmV0dXJuIGF0dHJTdGF0ZTsKICAgIH0gZWxzZSBpZiAoY29uZmlnLmFsbG93TWlzc2luZ1RhZ05hbWUgJiYgdHlwZSA9PSAiZW5kVGFnIikgewogICAgICBzZXRTdHlsZSA9ICJ0YWcgYnJhY2tldCI7CiAgICAgIHJldHVybiBhdHRyU3RhdGUodHlwZSwgc3RyZWFtLCBzdGF0ZSk7CiAgICB9IGVsc2UgewogICAgICBzZXRTdHlsZSA9ICJlcnJvciI7CiAgICAgIHJldHVybiB0YWdOYW1lU3RhdGU7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGNsb3NlVGFnTmFtZVN0YXRlKHR5cGUsIHN0cmVhbSwgc3RhdGUpIHsKICAgIGlmICh0eXBlID09ICJ3b3JkIikgewogICAgICB2YXIgdGFnTmFtZSA9IHN0cmVhbS5jdXJyZW50KCk7CiAgICAgIGlmIChzdGF0ZS5jb250ZXh0ICYmIHN0YXRlLmNvbnRleHQudGFnTmFtZSAhPSB0YWdOYW1lICYmCiAgICAgICAgICBjb25maWcuaW1wbGljaXRseUNsb3NlZC5oYXNPd25Qcm9wZXJ0eShzdGF0ZS5jb250ZXh0LnRhZ05hbWUpKQogICAgICAgIHBvcENvbnRleHQoc3RhdGUpOwogICAgICBpZiAoKHN0YXRlLmNvbnRleHQgJiYgc3RhdGUuY29udGV4dC50YWdOYW1lID09IHRhZ05hbWUpIHx8IGNvbmZpZy5tYXRjaENsb3NpbmcgPT09IGZhbHNlKSB7CiAgICAgICAgc2V0U3R5bGUgPSAidGFnIjsKICAgICAgICByZXR1cm4gY2xvc2VTdGF0ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICBzZXRTdHlsZSA9ICJ0YWcgZXJyb3IiOwogICAgICAgIHJldHVybiBjbG9zZVN0YXRlRXJyOwogICAgICB9CiAgICB9IGVsc2UgaWYgKGNvbmZpZy5hbGxvd01pc3NpbmdUYWdOYW1lICYmIHR5cGUgPT0gImVuZFRhZyIpIHsKICAgICAgc2V0U3R5bGUgPSAidGFnIGJyYWNrZXQiOwogICAgICByZXR1cm4gY2xvc2VTdGF0ZSh0eXBlLCBzdHJlYW0sIHN0YXRlKTsKICAgIH0gZWxzZSB7CiAgICAgIHNldFN0eWxlID0gImVycm9yIjsKICAgICAgcmV0dXJuIGNsb3NlU3RhdGVFcnI7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBjbG9zZVN0YXRlKHR5cGUsIF9zdHJlYW0sIHN0YXRlKSB7CiAgICBpZiAodHlwZSAhPSAiZW5kVGFnIikgewogICAgICBzZXRTdHlsZSA9ICJlcnJvciI7CiAgICAgIHJldHVybiBjbG9zZVN0YXRlOwogICAgfQogICAgcG9wQ29udGV4dChzdGF0ZSk7CiAgICByZXR1cm4gYmFzZVN0YXRlOwogIH0KICBmdW5jdGlvbiBjbG9zZVN0YXRlRXJyKHR5cGUsIHN0cmVhbSwgc3RhdGUpIHsKICAgIHNldFN0eWxlID0gImVycm9yIjsKICAgIHJldHVybiBjbG9zZVN0YXRlKHR5cGUsIHN0cmVhbSwgc3RhdGUpOwogIH0KCiAgZnVuY3Rpb24gYXR0clN0YXRlKHR5cGUsIF9zdHJlYW0sIHN0YXRlKSB7CiAgICBpZiAodHlwZSA9PSAid29yZCIpIHsKICAgICAgc2V0U3R5bGUgPSAiYXR0cmlidXRlIjsKICAgICAgcmV0dXJuIGF0dHJFcVN0YXRlOwogICAgfSBlbHNlIGlmICh0eXBlID09ICJlbmRUYWciIHx8IHR5cGUgPT0gInNlbGZjbG9zZVRhZyIpIHsKICAgICAgdmFyIHRhZ05hbWUgPSBzdGF0ZS50YWdOYW1lLCB0YWdTdGFydCA9IHN0YXRlLnRhZ1N0YXJ0OwogICAgICBzdGF0ZS50YWdOYW1lID0gc3RhdGUudGFnU3RhcnQgPSBudWxsOwogICAgICBpZiAodHlwZSA9PSAic2VsZmNsb3NlVGFnIiB8fAogICAgICAgICAgY29uZmlnLmF1dG9TZWxmQ2xvc2Vycy5oYXNPd25Qcm9wZXJ0eSh0YWdOYW1lKSkgewogICAgICAgIG1heWJlUG9wQ29udGV4dChzdGF0ZSwgdGFnTmFtZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbWF5YmVQb3BDb250ZXh0KHN0YXRlLCB0YWdOYW1lKTsKICAgICAgICBzdGF0ZS5jb250ZXh0ID0gbmV3IENvbnRleHQoc3RhdGUsIHRhZ05hbWUsIHRhZ1N0YXJ0ID09IHN0YXRlLmluZGVudGVkKTsKICAgICAgfQogICAgICByZXR1cm4gYmFzZVN0YXRlOwogICAgfQogICAgc2V0U3R5bGUgPSAiZXJyb3IiOwogICAgcmV0dXJuIGF0dHJTdGF0ZTsKICB9CiAgZnVuY3Rpb24gYXR0ckVxU3RhdGUodHlwZSwgc3RyZWFtLCBzdGF0ZSkgewogICAgaWYgKHR5cGUgPT0gImVxdWFscyIpIHJldHVybiBhdHRyVmFsdWVTdGF0ZTsKICAgIGlmICghY29uZmlnLmFsbG93TWlzc2luZykgc2V0U3R5bGUgPSAiZXJyb3IiOwogICAgcmV0dXJuIGF0dHJTdGF0ZSh0eXBlLCBzdHJlYW0sIHN0YXRlKTsKICB9CiAgZnVuY3Rpb24gYXR0clZhbHVlU3RhdGUodHlwZSwgc3RyZWFtLCBzdGF0ZSkgewogICAgaWYgKHR5cGUgPT0gInN0cmluZyIpIHJldHVybiBhdHRyQ29udGludWVkU3RhdGU7CiAgICBpZiAodHlwZSA9PSAid29yZCIgJiYgY29uZmlnLmFsbG93VW5xdW90ZWQpIHtzZXRTdHlsZSA9ICJzdHJpbmciOyByZXR1cm4gYXR0clN0YXRlO30KICAgIHNldFN0eWxlID0gImVycm9yIjsKICAgIHJldHVybiBhdHRyU3RhdGUodHlwZSwgc3RyZWFtLCBzdGF0ZSk7CiAgfQogIGZ1bmN0aW9uIGF0dHJDb250aW51ZWRTdGF0ZSh0eXBlLCBzdHJlYW0sIHN0YXRlKSB7CiAgICBpZiAodHlwZSA9PSAic3RyaW5nIikgcmV0dXJuIGF0dHJDb250aW51ZWRTdGF0ZTsKICAgIHJldHVybiBhdHRyU3RhdGUodHlwZSwgc3RyZWFtLCBzdGF0ZSk7CiAgfQoKICByZXR1cm4gewogICAgc3RhcnRTdGF0ZTogZnVuY3Rpb24oYmFzZUluZGVudCkgewogICAgICB2YXIgc3RhdGUgPSB7dG9rZW5pemU6IGluVGV4dCwKICAgICAgICAgICAgICAgICAgIHN0YXRlOiBiYXNlU3RhdGUsCiAgICAgICAgICAgICAgICAgICBpbmRlbnRlZDogYmFzZUluZGVudCB8fCAwLAogICAgICAgICAgICAgICAgICAgdGFnTmFtZTogbnVsbCwgdGFnU3RhcnQ6IG51bGwsCiAgICAgICAgICAgICAgICAgICBjb250ZXh0OiBudWxsfQogICAgICBpZiAoYmFzZUluZGVudCAhPSBudWxsKSBzdGF0ZS5iYXNlSW5kZW50ID0gYmFzZUluZGVudAogICAgICByZXR1cm4gc3RhdGUKICAgIH0sCgogICAgdG9rZW46IGZ1bmN0aW9uKHN0cmVhbSwgc3RhdGUpIHsKICAgICAgaWYgKCFzdGF0ZS50YWdOYW1lICYmIHN0cmVhbS5zb2woKSkKICAgICAgICBzdGF0ZS5pbmRlbnRlZCA9IHN0cmVhbS5pbmRlbnRhdGlvbigpOwoKICAgICAgaWYgKHN0cmVhbS5lYXRTcGFjZSgpKSByZXR1cm4gbnVsbDsKICAgICAgdHlwZSA9IG51bGw7CiAgICAgIHZhciBzdHlsZSA9IHN0YXRlLnRva2VuaXplKHN0cmVhbSwgc3RhdGUpOwogICAgICBpZiAoKHN0eWxlIHx8IHR5cGUpICYmIHN0eWxlICE9ICJjb21tZW50IikgewogICAgICAgIHNldFN0eWxlID0gbnVsbDsKICAgICAgICBzdGF0ZS5zdGF0ZSA9IHN0YXRlLnN0YXRlKHR5cGUgfHwgc3R5bGUsIHN0cmVhbSwgc3RhdGUpOwogICAgICAgIGlmIChzZXRTdHlsZSkKICAgICAgICAgIHN0eWxlID0gc2V0U3R5bGUgPT0gImVycm9yIiA/IHN0eWxlICsgIiBlcnJvciIgOiBzZXRTdHlsZTsKICAgICAgfQogICAgICByZXR1cm4gc3R5bGU7CiAgICB9LAoKICAgIGluZGVudDogZnVuY3Rpb24oc3RhdGUsIHRleHRBZnRlciwgZnVsbExpbmUpIHsKICAgICAgdmFyIGNvbnRleHQgPSBzdGF0ZS5jb250ZXh0OwogICAgICAvLyBJbmRlbnQgbXVsdGktbGluZSBzdHJpbmdzIChlLmcuIGNzcykuCiAgICAgIGlmIChzdGF0ZS50b2tlbml6ZS5pc0luQXR0cmlidXRlKSB7CiAgICAgICAgaWYgKHN0YXRlLnRhZ1N0YXJ0ID09IHN0YXRlLmluZGVudGVkKQogICAgICAgICAgcmV0dXJuIHN0YXRlLnN0cmluZ1N0YXJ0Q29sICsgMTsKICAgICAgICBlbHNlCiAgICAgICAgICByZXR1cm4gc3RhdGUuaW5kZW50ZWQgKyBpbmRlbnRVbml0OwogICAgICB9CiAgICAgIGlmIChjb250ZXh0ICYmIGNvbnRleHQubm9JbmRlbnQpIHJldHVybiBDb2RlTWlycm9yLlBhc3M7CiAgICAgIGlmIChzdGF0ZS50b2tlbml6ZSAhPSBpblRhZyAmJiBzdGF0ZS50b2tlbml6ZSAhPSBpblRleHQpCiAgICAgICAgcmV0dXJuIGZ1bGxMaW5lID8gZnVsbExpbmUubWF0Y2goL14oXHMqKS8pWzBdLmxlbmd0aCA6IDA7CiAgICAgIC8vIEluZGVudCB0aGUgc3RhcnRzIG9mIGF0dHJpYnV0ZSBuYW1lcy4KICAgICAgaWYgKHN0YXRlLnRhZ05hbWUpIHsKICAgICAgICBpZiAoY29uZmlnLm11bHRpbGluZVRhZ0luZGVudFBhc3RUYWcgIT09IGZhbHNlKQogICAgICAgICAgcmV0dXJuIHN0YXRlLnRhZ1N0YXJ0ICsgc3RhdGUudGFnTmFtZS5sZW5ndGggKyAyOwogICAgICAgIGVsc2UKICAgICAgICAgIHJldHVybiBzdGF0ZS50YWdTdGFydCArIGluZGVudFVuaXQgKiAoY29uZmlnLm11bHRpbGluZVRhZ0luZGVudEZhY3RvciB8fCAxKTsKICAgICAgfQogICAgICBpZiAoY29uZmlnLmFsaWduQ0RBVEEgJiYgLzwhXFtDREFUQVxbLy50ZXN0KHRleHRBZnRlcikpIHJldHVybiAwOwogICAgICB2YXIgdGFnQWZ0ZXIgPSB0ZXh0QWZ0ZXIgJiYgL148KFwvKT8oW1x3XzpcLi1dKikvLmV4ZWModGV4dEFmdGVyKTsKICAgICAgaWYgKHRhZ0FmdGVyICYmIHRhZ0FmdGVyWzFdKSB7IC8vIENsb3NpbmcgdGFnIHNwb3R0ZWQKICAgICAgICB3aGlsZSAoY29udGV4dCkgewogICAgICAgICAgaWYgKGNvbnRleHQudGFnTmFtZSA9PSB0YWdBZnRlclsyXSkgewogICAgICAgICAgICBjb250ZXh0ID0gY29udGV4dC5wcmV2OwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0gZWxzZSBpZiAoY29uZmlnLmltcGxpY2l0bHlDbG9zZWQuaGFzT3duUHJvcGVydHkoY29udGV4dC50YWdOYW1lKSkgewogICAgICAgICAgICBjb250ZXh0ID0gY29udGV4dC5wcmV2OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKHRhZ0FmdGVyKSB7IC8vIE9wZW5pbmcgdGFnIHNwb3R0ZWQKICAgICAgICB3aGlsZSAoY29udGV4dCkgewogICAgICAgICAgdmFyIGdyYWJiZXJzID0gY29uZmlnLmNvbnRleHRHcmFiYmVyc1tjb250ZXh0LnRhZ05hbWVdOwogICAgICAgICAgaWYgKGdyYWJiZXJzICYmIGdyYWJiZXJzLmhhc093blByb3BlcnR5KHRhZ0FmdGVyWzJdKSkKICAgICAgICAgICAgY29udGV4dCA9IGNvbnRleHQucHJldjsKICAgICAgICAgIGVsc2UKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICAgIHdoaWxlIChjb250ZXh0ICYmIGNvbnRleHQucHJldiAmJiAhY29udGV4dC5zdGFydE9mTGluZSkKICAgICAgICBjb250ZXh0ID0gY29udGV4dC5wcmV2OwogICAgICBpZiAoY29udGV4dCkgcmV0dXJuIGNvbnRleHQuaW5kZW50ICsgaW5kZW50VW5pdDsKICAgICAgZWxzZSByZXR1cm4gc3RhdGUuYmFzZUluZGVudCB8fCAwOwogICAgfSwKCiAgICBlbGVjdHJpY0lucHV0OiAvPFwvW1xzXHc6XSs+JC8sCiAgICBibG9ja0NvbW1lbnRTdGFydDogIjwhLS0iLAogICAgYmxvY2tDb21tZW50RW5kOiAiLS0+IiwKCiAgICBjb25maWd1cmF0aW9uOiBjb25maWcuaHRtbE1vZGUgPyAiaHRtbCIgOiAieG1sIiwKICAgIGhlbHBlclR5cGU6IGNvbmZpZy5odG1sTW9kZSA/ICJodG1sIiA6ICJ4bWwiLAoKICAgIHNraXBBdHRyaWJ1dGU6IGZ1bmN0aW9uKHN0YXRlKSB7CiAgICAgIGlmIChzdGF0ZS5zdGF0ZSA9PSBhdHRyVmFsdWVTdGF0ZSkKICAgICAgICBzdGF0ZS5zdGF0ZSA9IGF0dHJTdGF0ZQogICAgfQogIH07Cn0pOwoKQ29kZU1pcnJvci5kZWZpbmVNSU1FKCJ0ZXh0L3htbCIsICJ4bWwiKTsKQ29kZU1pcnJvci5kZWZpbmVNSU1FKCJhcHBsaWNhdGlvbi94bWwiLCAieG1sIik7CmlmICghQ29kZU1pcnJvci5taW1lTW9kZXMuaGFzT3duUHJvcGVydHkoInRleHQvaHRtbCIpKQogIENvZGVNaXJyb3IuZGVmaW5lTUlNRSgidGV4dC9odG1sIiwge25hbWU6ICJ4bWwiLCBodG1sTW9kZTogdHJ1ZX0pOwoKfSk7Cg==","codemirror/css.js":"Ly8gQ29kZU1pcnJvciwgY29weXJpZ2h0IChjKSBieSBNYXJpam4gSGF2ZXJiZWtlIGFuZCBvdGhlcnMKLy8gRGlzdHJpYnV0ZWQgdW5kZXIgYW4gTUlUIGxpY2Vuc2U6IGh0dHBzOi8vY29kZW1pcnJvci5uZXQvTElDRU5TRQoKKGZ1bmN0aW9uKG1vZCkgewogIGlmICh0eXBlb2YgZXhwb3J0cyA9PSAib2JqZWN0IiAmJiB0eXBlb2YgbW9kdWxlID09ICJvYmplY3QiKSAvLyBDb21tb25KUwogICAgbW9kKHJlcXVpcmUoIi4uLy4uL2xpYi9jb2RlbWlycm9yIikpOwogIGVsc2UgaWYgKHR5cGVvZiBkZWZpbmUgPT0gImZ1bmN0aW9uIiAmJiBkZWZpbmUuYW1kKSAvLyBBTUQKICAgIGRlZmluZShbIi4uLy4uL2xpYi9jb2RlbWlycm9yIl0sIG1vZCk7CiAgZWxzZSAvLyBQbGFpbiBicm93c2VyIGVudgogICAgbW9kKENvZGVNaXJyb3IpOwp9KShmdW5jdGlvbihDb2RlTWlycm9yKSB7CiJ1c2Ugc3RyaWN0IjsKCkNvZGVNaXJyb3IuZGVmaW5lTW9kZSgiY3NzIiwgZnVuY3Rpb24oY29uZmlnLCBwYXJzZXJDb25maWcpIHsKICB2YXIgaW5saW5lID0gcGFyc2VyQ29uZmlnLmlubGluZQogIGlmICghcGFyc2VyQ29uZmlnLnByb3BlcnR5S2V5d29yZHMpIHBhcnNlckNvbmZpZyA9IENvZGVNaXJyb3IucmVzb2x2ZU1vZGUoInRleHQvY3NzIik7CgogIHZhciBpbmRlbnRVbml0ID0gY29uZmlnLmluZGVudFVuaXQsCiAgICAgIHRva2VuSG9va3MgPSBwYXJzZXJDb25maWcudG9rZW5Ib29rcywKICAgICAgZG9jdW1lbnRUeXBlcyA9IHBhcnNlckNvbmZpZy5kb2N1bWVudFR5cGVzIHx8IHt9LAogICAgICBtZWRpYVR5cGVzID0gcGFyc2VyQ29uZmlnLm1lZGlhVHlwZXMgfHwge30sCiAgICAgIG1lZGlhRmVhdHVyZXMgPSBwYXJzZXJDb25maWcubWVkaWFGZWF0dXJlcyB8fCB7fSwKICAgICAgbWVkaWFWYWx1ZUtleXdvcmRzID0gcGFyc2VyQ29uZmlnLm1lZGlhVmFsdWVLZXl3b3JkcyB8fCB7fSwKICAgICAgcHJvcGVydHlLZXl3b3JkcyA9IHBhcnNlckNvbmZpZy5wcm9wZXJ0eUtleXdvcmRzIHx8IHt9LAogICAgICBub25TdGFuZGFyZFByb3BlcnR5S2V5d29yZHMgPSBwYXJzZXJDb25maWcubm9uU3RhbmRhcmRQcm9wZXJ0eUtleXdvcmRzIHx8IHt9LAogICAgICBmb250UHJvcGVydGllcyA9IHBhcnNlckNvbmZpZy5mb250UHJvcGVydGllcyB8fCB7fSwKICAgICAgY291bnRlckRlc2NyaXB0b3JzID0gcGFyc2VyQ29uZmlnLmNvdW50ZXJEZXNjcmlwdG9ycyB8fCB7fSwKICAgICAgY29sb3JLZXl3b3JkcyA9IHBhcnNlckNvbmZpZy5jb2xvcktleXdvcmRzIHx8IHt9LAogICAgICB2YWx1ZUtleXdvcmRzID0gcGFyc2VyQ29uZmlnLnZhbHVlS2V5d29yZHMgfHwge30sCiAgICAgIGFsbG93TmVzdGVkID0gcGFyc2VyQ29uZmlnLmFsbG93TmVzdGVkLAogICAgICBsaW5lQ29tbWVudCA9IHBhcnNlckNvbmZpZy5saW5lQ29tbWVudCwKICAgICAgc3VwcG9ydHNBdENvbXBvbmVudCA9IHBhcnNlckNvbmZpZy5zdXBwb3J0c0F0Q29tcG9uZW50ID09PSB0cnVlOwoKICB2YXIgdHlwZSwgb3ZlcnJpZGU7CiAgZnVuY3Rpb24gcmV0KHN0eWxlLCB0cCkgeyB0eXBlID0gdHA7IHJldHVybiBzdHlsZTsgfQoKICAvLyBUb2tlbml6ZXJzCgogIGZ1bmN0aW9uIHRva2VuQmFzZShzdHJlYW0sIHN0YXRlKSB7CiAgICB2YXIgY2ggPSBzdHJlYW0ubmV4dCgpOwogICAgaWYgKHRva2VuSG9va3NbY2hdKSB7CiAgICAgIHZhciByZXN1bHQgPSB0b2tlbkhvb2tzW2NoXShzdHJlYW0sIHN0YXRlKTsKICAgICAgaWYgKHJlc3VsdCAhPT0gZmFsc2UpIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICBpZiAoY2ggPT0gIkAiKSB7CiAgICAgIHN0cmVhbS5lYXRXaGlsZSgvW1x3XFxcLV0vKTsKICAgICAgcmV0dXJuIHJldCgiZGVmIiwgc3RyZWFtLmN1cnJlbnQoKSk7CiAgICB9IGVsc2UgaWYgKGNoID09ICI9IiB8fCAoY2ggPT0gIn4iIHx8IGNoID09ICJ8IikgJiYgc3RyZWFtLmVhdCgiPSIpKSB7CiAgICAgIHJldHVybiByZXQobnVsbCwgImNvbXBhcmUiKTsKICAgIH0gZWxzZSBpZiAoY2ggPT0gIlwiIiB8fCBjaCA9PSAiJyIpIHsKICAgICAgc3RhdGUudG9rZW5pemUgPSB0b2tlblN0cmluZyhjaCk7CiAgICAgIHJldHVybiBzdGF0ZS50b2tlbml6ZShzdHJlYW0sIHN0YXRlKTsKICAgIH0gZWxzZSBpZiAoY2ggPT0gIiMiKSB7CiAgICAgIHN0cmVhbS5lYXRXaGlsZSgvW1x3XFxcLV0vKTsKICAgICAgcmV0dXJuIHJldCgiYXRvbSIsICJoYXNoIik7CiAgICB9IGVsc2UgaWYgKGNoID09ICIhIikgewogICAgICBzdHJlYW0ubWF0Y2goL15ccypcdyovKTsKICAgICAgcmV0dXJuIHJldCgia2V5d29yZCIsICJpbXBvcnRhbnQiKTsKICAgIH0gZWxzZSBpZiAoL1xkLy50ZXN0KGNoKSB8fCBjaCA9PSAiLiIgJiYgc3RyZWFtLmVhdCgvXGQvKSkgewogICAgICBzdHJlYW0uZWF0V2hpbGUoL1tcdy4lXS8pOwogICAgICByZXR1cm4gcmV0KCJudW1iZXIiLCAidW5pdCIpOwogICAgfSBlbHNlIGlmIChjaCA9PT0gIi0iKSB7CiAgICAgIGlmICgvW1xkLl0vLnRlc3Qoc3RyZWFtLnBlZWsoKSkpIHsKICAgICAgICBzdHJlYW0uZWF0V2hpbGUoL1tcdy4lXS8pOwogICAgICAgIHJldHVybiByZXQoIm51bWJlciIsICJ1bml0Iik7CiAgICAgIH0gZWxzZSBpZiAoc3RyZWFtLm1hdGNoKC9eLVtcd1xcXC1dKi8pKSB7CiAgICAgICAgc3RyZWFtLmVhdFdoaWxlKC9bXHdcXFwtXS8pOwogICAgICAgIGlmIChzdHJlYW0ubWF0Y2goL15ccyo6LywgZmFsc2UpKQogICAgICAgICAgcmV0dXJuIHJldCgidmFyaWFibGUtMiIsICJ2YXJpYWJsZS1kZWZpbml0aW9uIik7CiAgICAgICAgcmV0dXJuIHJldCgidmFyaWFibGUtMiIsICJ2YXJpYWJsZSIpOwogICAgICB9IGVsc2UgaWYgKHN0cmVhbS5tYXRjaCgvXlx3Ky0vKSkgewogICAgICAgIHJldHVybiByZXQoIm1ldGEiLCAibWV0YSIpOwogICAgICB9CiAgICB9IGVsc2UgaWYgKC9bLCs+KlwvXS8udGVzdChjaCkpIHsKICAgICAgcmV0dXJuIHJldChudWxsLCAic2VsZWN0LW9wIik7CiAgICB9IGVsc2UgaWYgKGNoID09ICIuIiAmJiBzdHJlYW0ubWF0Y2goL14tP1tfYS16XVtfYS16MC05LV0qL2kpKSB7CiAgICAgIHJldHVybiByZXQoInF1YWxpZmllciIsICJxdWFsaWZpZXIiKTsKICAgIH0gZWxzZSBpZiAoL1s6O3t9XFtcXVwoXCldLy50ZXN0KGNoKSkgewogICAgICByZXR1cm4gcmV0KG51bGwsIGNoKTsKICAgIH0gZWxzZSBpZiAoc3RyZWFtLm1hdGNoKC9bXHctLl0rKD89XCgpLykpIHsKICAgICAgaWYgKC9eKHVybCgtcHJlZml4KT98ZG9tYWlufHJlZ2V4cCkkLy50ZXN0KHN0cmVhbS5jdXJyZW50KCkudG9Mb3dlckNhc2UoKSkpIHsKICAgICAgICBzdGF0ZS50b2tlbml6ZSA9IHRva2VuUGFyZW50aGVzaXplZDsKICAgICAgfQogICAgICByZXR1cm4gcmV0KCJ2YXJpYWJsZSBjYWxsZWUiLCAidmFyaWFibGUiKTsKICAgIH0gZWxzZSBpZiAoL1tcd1xcXC1dLy50ZXN0KGNoKSkgewogICAgICBzdHJlYW0uZWF0V2hpbGUoL1tcd1xcXC1dLyk7CiAgICAgIHJldHVybiByZXQoInByb3BlcnR5IiwgIndvcmQiKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiByZXQobnVsbCwgbnVsbCk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiB0b2tlblN0cmluZyhxdW90ZSkgewogICAgcmV0dXJuIGZ1bmN0aW9uKHN0cmVhbSwgc3RhdGUpIHsKICAgICAgdmFyIGVzY2FwZWQgPSBmYWxzZSwgY2g7CiAgICAgIHdoaWxlICgoY2ggPSBzdHJlYW0ubmV4dCgpKSAhPSBudWxsKSB7CiAgICAgICAgaWYgKGNoID09IHF1b3RlICYmICFlc2NhcGVkKSB7CiAgICAgICAgICBpZiAocXVvdGUgPT0gIikiKSBzdHJlYW0uYmFja1VwKDEpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICAgIGVzY2FwZWQgPSAhZXNjYXBlZCAmJiBjaCA9PSAiXFwiOwogICAgICB9CiAgICAgIGlmIChjaCA9PSBxdW90ZSB8fCAhZXNjYXBlZCAmJiBxdW90ZSAhPSAiKSIpIHN0YXRlLnRva2VuaXplID0gbnVsbDsKICAgICAgcmV0dXJuIHJldCgic3RyaW5nIiwgInN0cmluZyIpOwogICAgfTsKICB9CgogIGZ1bmN0aW9uIHRva2VuUGFyZW50aGVzaXplZChzdHJlYW0sIHN0YXRlKSB7CiAgICBzdHJlYW0ubmV4dCgpOyAvLyBNdXN0IGJlICcoJwogICAgaWYgKCFzdHJlYW0ubWF0Y2goL1xzKltcIlwnKV0vLCBmYWxzZSkpCiAgICAgIHN0YXRlLnRva2VuaXplID0gdG9rZW5TdHJpbmcoIikiKTsKICAgIGVsc2UKICAgICAgc3RhdGUudG9rZW5pemUgPSBudWxsOwogICAgcmV0dXJuIHJldChudWxsLCAiKCIpOwogIH0KCiAgLy8gQ29udGV4dCBtYW5hZ2VtZW50CgogIGZ1bmN0aW9uIENvbnRleHQodHlwZSwgaW5kZW50LCBwcmV2KSB7CiAgICB0aGlzLnR5cGUgPSB0eXBlOwogICAgdGhpcy5pbmRlbnQgPSBpbmRlbnQ7CiAgICB0aGlzLnByZXYgPSBwcmV2OwogIH0KCiAgZnVuY3Rpb24gcHVzaENvbnRleHQoc3RhdGUsIHN0cmVhbSwgdHlwZSwgaW5kZW50KSB7CiAgICBzdGF0ZS5jb250ZXh0ID0gbmV3IENvbnRleHQodHlwZSwgc3RyZWFtLmluZGVudGF0aW9uKCkgKyAoaW5kZW50ID09PSBmYWxzZSA/IDAgOiBpbmRlbnRVbml0KSwgc3RhdGUuY29udGV4dCk7CiAgICByZXR1cm4gdHlwZTsKICB9CgogIGZ1bmN0aW9uIHBvcENvbnRleHQoc3RhdGUpIHsKICAgIGlmIChzdGF0ZS5jb250ZXh0LnByZXYpCiAgICAgIHN0YXRlLmNvbnRleHQgPSBzdGF0ZS5jb250ZXh0LnByZXY7CiAgICByZXR1cm4gc3RhdGUuY29udGV4dC50eXBlOwogIH0KCiAgZnVuY3Rpb24gcGFzcyh0eXBlLCBzdHJlYW0sIHN0YXRlKSB7CiAgICByZXR1cm4gc3RhdGVzW3N0YXRlLmNvbnRleHQudHlwZV0odHlwZSwgc3RyZWFtLCBzdGF0ZSk7CiAgfQogIGZ1bmN0aW9uIHBvcEFuZFBhc3ModHlwZSwgc3RyZWFtLCBzdGF0ZSwgbikgewogICAgZm9yICh2YXIgaSA9IG4gfHwgMTsgaSA+IDA7IGktLSkKICAgICAgc3RhdGUuY29udGV4dCA9IHN0YXRlLmNvbnRleHQucHJldjsKICAgIHJldHVybiBwYXNzKHR5cGUsIHN0cmVhbSwgc3RhdGUpOwogIH0KCiAgLy8gUGFyc2VyCgogIGZ1bmN0aW9uIHdvcmRBc1ZhbHVlKHN0cmVhbSkgewogICAgdmFyIHdvcmQgPSBzdHJlYW0uY3VycmVudCgpLnRvTG93ZXJDYXNlKCk7CiAgICBpZiAodmFsdWVLZXl3b3Jkcy5oYXNPd25Qcm9wZXJ0eSh3b3JkKSkKICAgICAgb3ZlcnJpZGUgPSAiYXRvbSI7CiAgICBlbHNlIGlmIChjb2xvcktleXdvcmRzLmhhc093blByb3BlcnR5KHdvcmQpKQogICAgICBvdmVycmlkZSA9ICJrZXl3b3JkIjsKICAgIGVsc2UKICAgICAgb3ZlcnJpZGUgPSAidmFyaWFibGUiOwogIH0KCiAgdmFyIHN0YXRlcyA9IHt9OwoKICBzdGF0ZXMudG9wID0gZnVuY3Rpb24odHlwZSwgc3RyZWFtLCBzdGF0ZSkgewogICAgaWYgKHR5cGUgPT0gInsiKSB7CiAgICAgIHJldHVybiBwdXNoQ29udGV4dChzdGF0ZSwgc3RyZWFtLCAiYmxvY2siKTsKICAgIH0gZWxzZSBpZiAodHlwZSA9PSAifSIgJiYgc3RhdGUuY29udGV4dC5wcmV2KSB7CiAgICAgIHJldHVybiBwb3BDb250ZXh0KHN0YXRlKTsKICAgIH0gZWxzZSBpZiAoc3VwcG9ydHNBdENvbXBvbmVudCAmJiAvQGNvbXBvbmVudC9pLnRlc3QodHlwZSkpIHsKICAgICAgcmV0dXJuIHB1c2hDb250ZXh0KHN0YXRlLCBzdHJlYW0sICJhdENvbXBvbmVudEJsb2NrIik7CiAgICB9IGVsc2UgaWYgKC9eQCgtbW96LSk/ZG9jdW1lbnQkL2kudGVzdCh0eXBlKSkgewogICAgICByZXR1cm4gcHVzaENvbnRleHQoc3RhdGUsIHN0cmVhbSwgImRvY3VtZW50VHlwZXMiKTsKICAgIH0gZWxzZSBpZiAoL15AKG1lZGlhfHN1cHBvcnRzfCgtbW96LSk/ZG9jdW1lbnR8aW1wb3J0KSQvaS50ZXN0KHR5cGUpKSB7CiAgICAgIHJldHVybiBwdXNoQ29udGV4dChzdGF0ZSwgc3RyZWFtLCAiYXRCbG9jayIpOwogICAgfSBlbHNlIGlmICgvXkAoZm9udC1mYWNlfGNvdW50ZXItc3R5bGUpL2kudGVzdCh0eXBlKSkgewogICAgICBzdGF0ZS5zdGF0ZUFyZyA9IHR5cGU7CiAgICAgIHJldHVybiAicmVzdHJpY3RlZF9hdEJsb2NrX2JlZm9yZSI7CiAgICB9IGVsc2UgaWYgKC9eQCgtKG1venxtc3xvfHdlYmtpdCktKT9rZXlmcmFtZXMkL2kudGVzdCh0eXBlKSkgewogICAgICByZXR1cm4gImtleWZyYW1lcyI7CiAgICB9IGVsc2UgaWYgKHR5cGUgJiYgdHlwZS5jaGFyQXQoMCkgPT0gIkAiKSB7CiAgICAgIHJldHVybiBwdXNoQ29udGV4dChzdGF0ZSwgc3RyZWFtLCAiYXQiKTsKICAgIH0gZWxzZSBpZiAodHlwZSA9PSAiaGFzaCIpIHsKICAgICAgb3ZlcnJpZGUgPSAiYnVpbHRpbiI7CiAgICB9IGVsc2UgaWYgKHR5cGUgPT0gIndvcmQiKSB7CiAgICAgIG92ZXJyaWRlID0gInRhZyI7CiAgICB9IGVsc2UgaWYgKHR5cGUgPT0gInZhcmlhYmxlLWRlZmluaXRpb24iKSB7CiAgICAgIHJldHVybiAibWF5YmVwcm9wIjsKICAgIH0gZWxzZSBpZiAodHlwZSA9PSAiaW50ZXJwb2xhdGlvbiIpIHsKICAgICAgcmV0dXJuIHB1c2hDb250ZXh0KHN0YXRlLCBzdHJlYW0sICJpbnRlcnBvbGF0aW9uIik7CiAgICB9IGVsc2UgaWYgKHR5cGUgPT0gIjoiKSB7CiAgICAgIHJldHVybiAicHNldWRvIjsKICAgIH0gZWxzZSBpZiAoYWxsb3dOZXN0ZWQgJiYgdHlwZSA9PSAiKCIpIHsKICAgICAgcmV0dXJuIHB1c2hDb250ZXh0KHN0YXRlLCBzdHJlYW0sICJwYXJlbnMiKTsKICAgIH0KICAgIHJldHVybiBzdGF0ZS5jb250ZXh0LnR5cGU7CiAgfTsKCiAgc3RhdGVzLmJsb2NrID0gZnVuY3Rpb24odHlwZSwgc3RyZWFtLCBzdGF0ZSkgewogICAgaWYgKHR5cGUgPT0gIndvcmQiKSB7CiAgICAgIHZhciB3b3JkID0gc3RyZWFtLmN1cnJlbnQoKS50b0xvd2VyQ2FzZSgpOwogICAgICBpZiAocHJvcGVydHlLZXl3b3Jkcy5oYXNPd25Qcm9wZXJ0eSh3b3JkKSkgewogICAgICAgIG92ZXJyaWRlID0gInByb3BlcnR5IjsKICAgICAgICByZXR1cm4gIm1heWJlcHJvcCI7CiAgICAgIH0gZWxzZSBpZiAobm9uU3RhbmRhcmRQcm9wZXJ0eUtleXdvcmRzLmhhc093blByb3BlcnR5KHdvcmQpKSB7CiAgICAgICAgb3ZlcnJpZGUgPSAic3RyaW5nLTIiOwogICAgICAgIHJldHVybiAibWF5YmVwcm9wIjsKICAgICAgfSBlbHNlIGlmIChhbGxvd05lc3RlZCkgewogICAgICAgIG92ZXJyaWRlID0gc3RyZWFtLm1hdGNoKC9eXHMqOig/OlxzfCQpLywgZmFsc2UpID8gInByb3BlcnR5IiA6ICJ0YWciOwogICAgICAgIHJldHVybiAiYmxvY2siOwogICAgICB9IGVsc2UgewogICAgICAgIG92ZXJyaWRlICs9ICIgZXJyb3IiOwogICAgICAgIHJldHVybiAibWF5YmVwcm9wIjsKICAgICAgfQogICAgfSBlbHNlIGlmICh0eXBlID09ICJtZXRhIikgewogICAgICByZXR1cm4gImJsb2NrIjsKICAgIH0gZWxzZSBpZiAoIWFsbG93TmVzdGVkICYmICh0eXBlID09ICJoYXNoIiB8fCB0eXBlID09ICJxdWFsaWZpZXIiKSkgewogICAgICBvdmVycmlkZSA9ICJlcnJvciI7CiAgICAgIHJldHVybiAiYmxvY2siOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHN0YXRlcy50b3AodHlwZSwgc3RyZWFtLCBzdGF0ZSk7CiAgICB9CiAgfTsKCiAgc3RhdGVzLm1heWJlcHJvcCA9IGZ1bmN0aW9uKHR5cGUsIHN0cmVhbSwgc3RhdGUpIHsKICAgIGlmICh0eXBlID09ICI6IikgcmV0dXJuIHB1c2hDb250ZXh0KHN0YXRlLCBzdHJlYW0sICJwcm9wIik7CiAgICByZXR1cm4gcGFzcyh0eXBlLCBzdHJlYW0sIHN0YXRlKTsKICB9OwoKICBzdGF0ZXMucHJvcCA9IGZ1bmN0aW9uKHR5cGUsIHN0cmVhbSwgc3RhdGUpIHsKICAgIGlmICh0eXBlID09ICI7IikgcmV0dXJuIHBvcENvbnRleHQoc3RhdGUpOwogICAgaWYgKHR5cGUgPT0gInsiICYmIGFsbG93TmVzdGVkKSByZXR1cm4gcHVzaENvbnRleHQoc3RhdGUsIHN0cmVhbSwgInByb3BCbG9jayIpOwogICAgaWYgKHR5cGUgPT0gIn0iIHx8IHR5cGUgPT0gInsiKSByZXR1cm4gcG9wQW5kUGFzcyh0eXBlLCBzdHJlYW0sIHN0YXRlKTsKICAgIGlmICh0eXBlID09ICIoIikgcmV0dXJuIHB1c2hDb250ZXh0KHN0YXRlLCBzdHJlYW0sICJwYXJlbnMiKTsKCiAgICBpZiAodHlwZSA9PSAiaGFzaCIgJiYgIS9eIyhbMC05YS1mQS1mXXszLDR9fFswLTlhLWZBLWZdezZ9fFswLTlhLWZBLWZdezh9KSQvLnRlc3Qoc3RyZWFtLmN1cnJlbnQoKSkpIHsKICAgICAgb3ZlcnJpZGUgKz0gIiBlcnJvciI7CiAgICB9IGVsc2UgaWYgKHR5cGUgPT0gIndvcmQiKSB7CiAgICAgIHdvcmRBc1ZhbHVlKHN0cmVhbSk7CiAgICB9IGVsc2UgaWYgKHR5cGUgPT0gImludGVycG9sYXRpb24iKSB7CiAgICAgIHJldHVybiBwdXNoQ29udGV4dChzdGF0ZSwgc3RyZWFtLCAiaW50ZXJwb2xhdGlvbiIpOwogICAgfQogICAgcmV0dXJuICJwcm9wIjsKICB9OwoKICBzdGF0ZXMucHJvcEJsb2NrID0gZnVuY3Rpb24odHlwZSwgX3N0cmVhbSwgc3RhdGUpIHsKICAgIGlmICh0eXBlID09ICJ9IikgcmV0dXJuIHBvcENvbnRleHQoc3RhdGUpOwogICAgaWYgKHR5cGUgPT0gIndvcmQiKSB7IG92ZXJyaWRlID0gInByb3BlcnR5IjsgcmV0dXJuICJtYXliZXByb3AiOyB9CiAgICByZXR1cm4gc3RhdGUuY29udGV4dC50eXBlOwogIH07CgogIHN0YXRlcy5wYXJlbnMgPSBmdW5jdGlvbih0eXBlLCBzdHJlYW0sIHN0YXRlKSB7CiAgICBpZiAodHlwZSA9PSAieyIgfHwgdHlwZSA9PSAifSIpIHJldHVybiBwb3BBbmRQYXNzKHR5cGUsIHN0cmVhbSwgc3RhdGUpOwogICAgaWYgKHR5cGUgPT0gIikiKSByZXR1cm4gcG9wQ29udGV4dChzdGF0ZSk7CiAgICBpZiAodHlwZSA9PSAiKCIpIHJldHVybiBwdXNoQ29udGV4dChzdGF0ZSwgc3RyZWFtLCAicGFyZW5zIik7CiAgICBpZiAodHlwZSA9PSAiaW50ZXJwb2xhdGlvbiIpIHJldHVybiBwdXNoQ29udGV4dChzdGF0ZSwgc3RyZWFtLCAiaW50ZXJwb2xhdGlvbiIpOwogICAgaWYgKHR5cGUgPT0gIndvcmQiKSB3b3JkQXNWYWx1ZShzdHJlYW0pOwogICAgcmV0dXJuICJwYXJlbnMiOwogIH07CgogIHN0YXRlcy5wc2V1ZG8gPSBmdW5jdGlvbih0eXBlLCBzdHJlYW0sIHN0YXRlKSB7CiAgICBpZiAodHlwZSA9PSAibWV0YSIpIHJldHVybiAicHNldWRvIjsKCiAgICBpZiAodHlwZSA9PSAid29yZCIpIHsKICAgICAgb3ZlcnJpZGUgPSAidmFyaWFibGUtMyI7CiAgICAgIHJldHVybiBzdGF0ZS5jb250ZXh0LnR5cGU7CiAgICB9CiAgICByZXR1cm4gcGFzcyh0eXBlLCBzdHJlYW0sIHN0YXRlKTsKICB9OwoKICBzdGF0ZXMuZG9jdW1lbnRUeXBlcyA9IGZ1bmN0aW9uKHR5cGUsIHN0cmVhbSwgc3RhdGUpIHsKICAgIGlmICh0eXBlID09ICJ3b3JkIiAmJiBkb2N1bWVudFR5cGVzLmhhc093blByb3BlcnR5KHN0cmVhbS5jdXJyZW50KCkpKSB7CiAgICAgIG92ZXJyaWRlID0gInRhZyI7CiAgICAgIHJldHVybiBzdGF0ZS5jb250ZXh0LnR5cGU7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gc3RhdGVzLmF0QmxvY2sodHlwZSwgc3RyZWFtLCBzdGF0ZSk7CiAgICB9CiAgfTsKCiAgc3RhdGVzLmF0QmxvY2sgPSBmdW5jdGlvbih0eXBlLCBzdHJlYW0sIHN0YXRlKSB7CiAgICBpZiAodHlwZSA9PSAiKCIpIHJldHVybiBwdXNoQ29udGV4dChzdGF0ZSwgc3RyZWFtLCAiYXRCbG9ja19wYXJlbnMiKTsKICAgIGlmICh0eXBlID09ICJ9IiB8fCB0eXBlID09ICI7IikgcmV0dXJuIHBvcEFuZFBhc3ModHlwZSwgc3RyZWFtLCBzdGF0ZSk7CiAgICBpZiAodHlwZSA9PSAieyIpIHJldHVybiBwb3BDb250ZXh0KHN0YXRlKSAmJiBwdXNoQ29udGV4dChzdGF0ZSwgc3RyZWFtLCBhbGxvd05lc3RlZCA/ICJibG9jayIgOiAidG9wIik7CgogICAgaWYgKHR5cGUgPT0gImludGVycG9sYXRpb24iKSByZXR1cm4gcHVzaENvbnRleHQoc3RhdGUsIHN0cmVhbSwgImludGVycG9sYXRpb24iKTsKCiAgICBpZiAodHlwZSA9PSAid29yZCIpIHsKICAgICAgdmFyIHdvcmQgPSBzdHJlYW0uY3VycmVudCgpLnRvTG93ZXJDYXNlKCk7CiAgICAgIGlmICh3b3JkID09ICJvbmx5IiB8fCB3b3JkID09ICJub3QiIHx8IHdvcmQgPT0gImFuZCIgfHwgd29yZCA9PSAib3IiKQogICAgICAgIG92ZXJyaWRlID0gImtleXdvcmQiOwogICAgICBlbHNlIGlmIChtZWRpYVR5cGVzLmhhc093blByb3BlcnR5KHdvcmQpKQogICAgICAgIG92ZXJyaWRlID0gImF0dHJpYnV0ZSI7CiAgICAgIGVsc2UgaWYgKG1lZGlhRmVhdHVyZXMuaGFzT3duUHJvcGVydHkod29yZCkpCiAgICAgICAgb3ZlcnJpZGUgPSAicHJvcGVydHkiOwogICAgICBlbHNlIGlmIChtZWRpYVZhbHVlS2V5d29yZHMuaGFzT3duUHJvcGVydHkod29yZCkpCiAgICAgICAgb3ZlcnJpZGUgPSAia2V5d29yZCI7CiAgICAgIGVsc2UgaWYgKHByb3BlcnR5S2V5d29yZHMuaGFzT3duUHJvcGVydHkod29yZCkpCiAgICAgICAgb3ZlcnJpZGUgPSAicHJvcGVydHkiOwogICAgICBlbHNlIGlmIChub25TdGFuZGFyZFByb3BlcnR5S2V5d29yZHMuaGFzT3duUHJvcGVydHkod29yZCkpCiAgICAgICAgb3ZlcnJpZGUgPSAic3RyaW5nLTIiOwogICAgICBlbHNlIGlmICh2YWx1ZUtleXdvcmRzLmhhc093blByb3BlcnR5KHdvcmQpKQogICAgICAgIG92ZXJyaWRlID0gImF0b20iOwogICAgICBlbHNlIGlmIChjb2xvcktleXdvcmRzLmhhc093blByb3BlcnR5KHdvcmQpKQogICAgICAgIG92ZXJyaWRlID0gImtleXdvcmQiOwogICAgICBlbHNlCiAgICAgICAgb3ZlcnJpZGUgPSAiZXJyb3IiOwogICAgfQogICAgcmV0dXJuIHN0YXRlLmNvbnRleHQudHlwZTsKICB9OwoKICBzdGF0ZXMuYXRDb21wb25lbnRCbG9jayA9IGZ1bmN0aW9uKHR5cGUsIHN0cmVhbSwgc3RhdGUpIHsKICAgIGlmICh0eXBlID09ICJ9IikKICAgICAgcmV0dXJuIHBvcEFuZFBhc3ModHlwZSwgc3RyZWFtLCBzdGF0ZSk7CiAgICBpZiAodHlwZSA9PSAieyIpCiAgICAgIHJldHVybiBwb3BDb250ZXh0KHN0YXRlKSAmJiBwdXNoQ29udGV4dChzdGF0ZSwgc3RyZWFtLCBhbGxvd05lc3RlZCA/ICJibG9jayIgOiAidG9wIiwgZmFsc2UpOwogICAgaWYgKHR5cGUgPT0gIndvcmQiKQogICAgICBvdmVycmlkZSA9ICJlcnJvciI7CiAgICByZXR1cm4gc3RhdGUuY29udGV4dC50eXBlOwogIH07CgogIHN0YXRlcy5hdEJsb2NrX3BhcmVucyA9IGZ1bmN0aW9uKHR5cGUsIHN0cmVhbSwgc3RhdGUpIHsKICAgIGlmICh0eXBlID09ICIpIikgcmV0dXJuIHBvcENvbnRleHQoc3RhdGUpOwogICAgaWYgKHR5cGUgPT0gInsiIHx8IHR5cGUgPT0gIn0iKSByZXR1cm4gcG9wQW5kUGFzcyh0eXBlLCBzdHJlYW0sIHN0YXRlLCAyKTsKICAgIHJldHVybiBzdGF0ZXMuYXRCbG9jayh0eXBlLCBzdHJlYW0sIHN0YXRlKTsKICB9OwoKICBzdGF0ZXMucmVzdHJpY3RlZF9hdEJsb2NrX2JlZm9yZSA9IGZ1bmN0aW9uKHR5cGUsIHN0cmVhbSwgc3RhdGUpIHsKICAgIGlmICh0eXBlID09ICJ7IikKICAgICAgcmV0dXJuIHB1c2hDb250ZXh0KHN0YXRlLCBzdHJlYW0sICJyZXN0cmljdGVkX2F0QmxvY2siKTsKICAgIGlmICh0eXBlID09ICJ3b3JkIiAmJiBzdGF0ZS5zdGF0ZUFyZyA9PSAiQGNvdW50ZXItc3R5bGUiKSB7CiAgICAgIG92ZXJyaWRlID0gInZhcmlhYmxlIjsKICAgICAgcmV0dXJuICJyZXN0cmljdGVkX2F0QmxvY2tfYmVmb3JlIjsKICAgIH0KICAgIHJldHVybiBwYXNzKHR5cGUsIHN0cmVhbSwgc3RhdGUpOwogIH07CgogIHN0YXRlcy5yZXN0cmljdGVkX2F0QmxvY2sgPSBmdW5jdGlvbih0eXBlLCBzdHJlYW0sIHN0YXRlKSB7CiAgICBpZiAodHlwZSA9PSAifSIpIHsKICAgICAgc3RhdGUuc3RhdGVBcmcgPSBudWxsOwogICAgICByZXR1cm4gcG9wQ29udGV4dChzdGF0ZSk7CiAgICB9CiAgICBpZiAodHlwZSA9PSAid29yZCIpIHsKICAgICAgaWYgKChzdGF0ZS5zdGF0ZUFyZyA9PSAiQGZvbnQtZmFjZSIgJiYgIWZvbnRQcm9wZXJ0aWVzLmhhc093blByb3BlcnR5KHN0cmVhbS5jdXJyZW50KCkudG9Mb3dlckNhc2UoKSkpIHx8CiAgICAgICAgICAoc3RhdGUuc3RhdGVBcmcgPT0gIkBjb3VudGVyLXN0eWxlIiAmJiAhY291bnRlckRlc2NyaXB0b3JzLmhhc093blByb3BlcnR5KHN0cmVhbS5jdXJyZW50KCkudG9Mb3dlckNhc2UoKSkpKQogICAgICAgIG92ZXJyaWRlID0gImVycm9yIjsKICAgICAgZWxzZQogICAgICAgIG92ZXJyaWRlID0gInByb3BlcnR5IjsKICAgICAgcmV0dXJuICJtYXliZXByb3AiOwogICAgfQogICAgcmV0dXJuICJyZXN0cmljdGVkX2F0QmxvY2siOwogIH07CgogIHN0YXRlcy5rZXlmcmFtZXMgPSBmdW5jdGlvbih0eXBlLCBzdHJlYW0sIHN0YXRlKSB7CiAgICBpZiAodHlwZSA9PSAid29yZCIpIHsgb3ZlcnJpZGUgPSAidmFyaWFibGUiOyByZXR1cm4gImtleWZyYW1lcyI7IH0KICAgIGlmICh0eXBlID09ICJ7IikgcmV0dXJuIHB1c2hDb250ZXh0KHN0YXRlLCBzdHJlYW0sICJ0b3AiKTsKICAgIHJldHVybiBwYXNzKHR5cGUsIHN0cmVhbSwgc3RhdGUpOwogIH07CgogIHN0YXRlcy5hdCA9IGZ1bmN0aW9uKHR5cGUsIHN0cmVhbSwgc3RhdGUpIHsKICAgIGlmICh0eXBlID09ICI7IikgcmV0dXJuIHBvcENvbnRleHQoc3RhdGUpOwogICAgaWYgKHR5cGUgPT0gInsiIHx8IHR5cGUgPT0gIn0iKSByZXR1cm4gcG9wQW5kUGFzcyh0eXBlLCBzdHJlYW0sIHN0YXRlKTsKICAgIGlmICh0eXBlID09ICJ3b3JkIikgb3ZlcnJpZGUgPSAidGFnIjsKICAgIGVsc2UgaWYgKHR5cGUgPT0gImhhc2giKSBvdmVycmlkZSA9ICJidWlsdGluIjsKICAgIHJldHVybiAiYXQiOwogIH07CgogIHN0YXRlcy5pbnRlcnBvbGF0aW9uID0gZnVuY3Rpb24odHlwZSwgc3RyZWFtLCBzdGF0ZSkgewogICAgaWYgKHR5cGUgPT0gIn0iKSByZXR1cm4gcG9wQ29udGV4dChzdGF0ZSk7CiAgICBpZiAodHlwZSA9PSAieyIgfHwgdHlwZSA9PSAiOyIpIHJldHVybiBwb3BBbmRQYXNzKHR5cGUsIHN0cmVhbSwgc3RhdGUpOwogICAgaWYgKHR5cGUgPT0gIndvcmQiKSBvdmVycmlkZSA9ICJ2YXJpYWJsZSI7CiAgICBlbHNlIGlmICh0eXBlICE9ICJ2YXJpYWJsZSIgJiYgdHlwZSAhPSAiKCIgJiYgdHlwZSAhPSAiKSIpIG92ZXJyaWRlID0gImVycm9yIjsKICAgIHJldHVybiAiaW50ZXJwb2xhdGlvbiI7CiAgfTsKCiAgcmV0dXJuIHsKICAgIHN0YXJ0U3RhdGU6IGZ1bmN0aW9uKGJhc2UpIHsKICAgICAgcmV0dXJuIHt0b2tlbml6ZTogbnVsbCwKICAgICAgICAgICAgICBzdGF0ZTogaW5saW5lID8gImJsb2NrIiA6ICJ0b3AiLAogICAgICAgICAgICAgIHN0YXRlQXJnOiBudWxsLAogICAgICAgICAgICAgIGNvbnRleHQ6IG5ldyBDb250ZXh0KGlubGluZSA/ICJibG9jayIgOiAidG9wIiwgYmFzZSB8fCAwLCBudWxsKX07CiAgICB9LAoKICAgIHRva2VuOiBmdW5jdGlvbihzdHJlYW0sIHN0YXRlKSB7CiAgICAgIGlmICghc3RhdGUudG9rZW5pemUgJiYgc3RyZWFtLmVhdFNwYWNlKCkpIHJldHVybiBudWxsOwogICAgICB2YXIgc3R5bGUgPSAoc3RhdGUudG9rZW5pemUgfHwgdG9rZW5CYXNlKShzdHJlYW0sIHN0YXRlKTsKICAgICAgaWYgKHN0eWxlICYmIHR5cGVvZiBzdHlsZSA9PSAib2JqZWN0IikgewogICAgICAgIHR5cGUgPSBzdHlsZVsxXTsKICAgICAgICBzdHlsZSA9IHN0eWxlWzBdOwogICAgICB9CiAgICAgIG92ZXJyaWRlID0gc3R5bGU7CiAgICAgIGlmICh0eXBlICE9ICJjb21tZW50IikKICAgICAgICBzdGF0ZS5zdGF0ZSA9IHN0YXRlc1tzdGF0ZS5zdGF0ZV0odHlwZSwgc3RyZWFtLCBzdGF0ZSk7CiAgICAgIHJldHVybiBvdmVycmlkZTsKICAgIH0sCgogICAgaW5kZW50OiBmdW5jdGlvbihzdGF0ZSwgdGV4dEFmdGVyKSB7CiAgICAgIHZhciBjeCA9IHN0YXRlLmNvbnRleHQsIGNoID0gdGV4dEFmdGVyICYmIHRleHRBZnRlci5jaGFyQXQoMCk7CiAgICAgIHZhciBpbmRlbnQgPSBjeC5pbmRlbnQ7CiAgICAgIGlmIChjeC50eXBlID09ICJwcm9wIiAmJiAoY2ggPT0gIn0iIHx8IGNoID09ICIpIikpIGN4ID0gY3gucHJldjsKICAgICAgaWYgKGN4LnByZXYpIHsKICAgICAgICBpZiAoY2ggPT0gIn0iICYmIChjeC50eXBlID09ICJibG9jayIgfHwgY3gudHlwZSA9PSAidG9wIiB8fAogICAgICAgICAgICAgICAgICAgICAgICAgIGN4LnR5cGUgPT0gImludGVycG9sYXRpb24iIHx8IGN4LnR5cGUgPT0gInJlc3RyaWN0ZWRfYXRCbG9jayIpKSB7CiAgICAgICAgICAvLyBSZXN1bWUgaW5kZW50YXRpb24gZnJvbSBwYXJlbnQgY29udGV4dC4KICAgICAgICAgIGN4ID0gY3gucHJldjsKICAgICAgICAgIGluZGVudCA9IGN4LmluZGVudDsKICAgICAgICB9IGVsc2UgaWYgKGNoID09ICIpIiAmJiAoY3gudHlwZSA9PSAicGFyZW5zIiB8fCBjeC50eXBlID09ICJhdEJsb2NrX3BhcmVucyIpIHx8CiAgICAgICAgICAgIGNoID09ICJ7IiAmJiAoY3gudHlwZSA9PSAiYXQiIHx8IGN4LnR5cGUgPT0gImF0QmxvY2siKSkgewogICAgICAgICAgLy8gRGVkZW50IHJlbGF0aXZlIHRvIGN1cnJlbnQgY29udGV4dC4KICAgICAgICAgIGluZGVudCA9IE1hdGgubWF4KDAsIGN4LmluZGVudCAtIGluZGVudFVuaXQpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gaW5kZW50OwogICAgfSwKCiAgICBlbGVjdHJpY0NoYXJzOiAifSIsCiAgICBibG9ja0NvbW1lbnRTdGFydDogIi8qIiwKICAgIGJsb2NrQ29tbWVudEVuZDogIiovIiwKICAgIGJsb2NrQ29tbWVudENvbnRpbnVlOiAiICogIiwKICAgIGxpbmVDb21tZW50OiBsaW5lQ29tbWVudCwKICAgIGZvbGQ6ICJicmFjZSIKICB9Owp9KTsKCiAgZnVuY3Rpb24ga2V5U2V0KGFycmF5KSB7CiAgICB2YXIga2V5cyA9IHt9OwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcnJheS5sZW5ndGg7ICsraSkgewogICAgICBrZXlzW2FycmF5W2ldLnRvTG93ZXJDYXNlKCldID0gdHJ1ZTsKICAgIH0KICAgIHJldHVybiBrZXlzOwogIH0KCiAgdmFyIGRvY3VtZW50VHlwZXNfID0gWwogICAgImRvbWFpbiIsICJyZWdleHAiLCAidXJsIiwgInVybC1wcmVmaXgiCiAgXSwgZG9jdW1lbnRUeXBlcyA9IGtleVNldChkb2N1bWVudFR5cGVzXyk7CgogIHZhciBtZWRpYVR5cGVzXyA9IFsKICAgICJhbGwiLCAiYXVyYWwiLCAiYnJhaWxsZSIsICJoYW5kaGVsZCIsICJwcmludCIsICJwcm9qZWN0aW9uIiwgInNjcmVlbiIsCiAgICAidHR5IiwgInR2IiwgImVtYm9zc2VkIgogIF0sIG1lZGlhVHlwZXMgPSBrZXlTZXQobWVkaWFUeXBlc18pOwoKICB2YXIgbWVkaWFGZWF0dXJlc18gPSBbCiAgICAid2lkdGgiLCAibWluLXdpZHRoIiwgIm1heC13aWR0aCIsICJoZWlnaHQiLCAibWluLWhlaWdodCIsICJtYXgtaGVpZ2h0IiwKICAgICJkZXZpY2Utd2lkdGgiLCAibWluLWRldmljZS13aWR0aCIsICJtYXgtZGV2aWNlLXdpZHRoIiwgImRldmljZS1oZWlnaHQiLAogICAgIm1pbi1kZXZpY2UtaGVpZ2h0IiwgIm1heC1kZXZpY2UtaGVpZ2h0IiwgImFzcGVjdC1yYXRpbyIsCiAgICAibWluLWFzcGVjdC1yYXRpbyIsICJtYXgtYXNwZWN0LXJhdGlvIiwgImRldmljZS1hc3BlY3QtcmF0aW8iLAogICAgIm1pbi1kZXZpY2UtYXNwZWN0LXJhdGlvIiwgIm1heC1kZXZpY2UtYXNwZWN0LXJhdGlvIiwgImNvbG9yIiwgIm1pbi1jb2xvciIsCiAgICAibWF4LWNvbG9yIiwgImNvbG9yLWluZGV4IiwgIm1pbi1jb2xvci1pbmRleCIsICJtYXgtY29sb3ItaW5kZXgiLAogICAgIm1vbm9jaHJvbWUiLCAibWluLW1vbm9jaHJvbWUiLCAibWF4LW1vbm9jaHJvbWUiLCAicmVzb2x1dGlvbiIsCiAgICAibWluLXJlc29sdXRpb24iLCAibWF4LXJlc29sdXRpb24iLCAic2NhbiIsICJncmlkIiwgIm9yaWVudGF0aW9uIiwKICAgICJkZXZpY2UtcGl4ZWwtcmF0aW8iLCAibWluLWRldmljZS1waXhlbC1yYXRpbyIsICJtYXgtZGV2aWNlLXBpeGVsLXJhdGlvIiwKICAgICJwb2ludGVyIiwgImFueS1wb2ludGVyIiwgImhvdmVyIiwgImFueS1ob3ZlciIKICBdLCBtZWRpYUZlYXR1cmVzID0ga2V5U2V0KG1lZGlhRmVhdHVyZXNfKTsKCiAgdmFyIG1lZGlhVmFsdWVLZXl3b3Jkc18gPSBbCiAgICAibGFuZHNjYXBlIiwgInBvcnRyYWl0IiwgIm5vbmUiLCAiY29hcnNlIiwgImZpbmUiLCAib24tZGVtYW5kIiwgImhvdmVyIiwKICAgICJpbnRlcmxhY2UiLCAicHJvZ3Jlc3NpdmUiCiAgXSwgbWVkaWFWYWx1ZUtleXdvcmRzID0ga2V5U2V0KG1lZGlhVmFsdWVLZXl3b3Jkc18pOwoKICB2YXIgcHJvcGVydHlLZXl3b3Jkc18gPSBbCiAgICAiYWxpZ24tY29udGVudCIsICJhbGlnbi1pdGVtcyIsICJhbGlnbi1zZWxmIiwgImFsaWdubWVudC1hZGp1c3QiLAogICAgImFsaWdubWVudC1iYXNlbGluZSIsICJhbmNob3ItcG9pbnQiLCAiYW5pbWF0aW9uIiwgImFuaW1hdGlvbi1kZWxheSIsCiAgICAiYW5pbWF0aW9uLWRpcmVjdGlvbiIsICJhbmltYXRpb24tZHVyYXRpb24iLCAiYW5pbWF0aW9uLWZpbGwtbW9kZSIsCiAgICAiYW5pbWF0aW9uLWl0ZXJhdGlvbi1jb3VudCIsICJhbmltYXRpb24tbmFtZSIsICJhbmltYXRpb24tcGxheS1zdGF0ZSIsCiAgICAiYW5pbWF0aW9uLXRpbWluZy1mdW5jdGlvbiIsICJhcHBlYXJhbmNlIiwgImF6aW11dGgiLCAiYmFja2ZhY2UtdmlzaWJpbGl0eSIsCiAgICAiYmFja2dyb3VuZCIsICJiYWNrZ3JvdW5kLWF0dGFjaG1lbnQiLCAiYmFja2dyb3VuZC1ibGVuZC1tb2RlIiwgImJhY2tncm91bmQtY2xpcCIsCiAgICAiYmFja2dyb3VuZC1jb2xvciIsICJiYWNrZ3JvdW5kLWltYWdlIiwgImJhY2tncm91bmQtb3JpZ2luIiwgImJhY2tncm91bmQtcG9zaXRpb24iLAogICAgImJhY2tncm91bmQtcmVwZWF0IiwgImJhY2tncm91bmQtc2l6ZSIsICJiYXNlbGluZS1zaGlmdCIsICJiaW5kaW5nIiwKICAgICJibGVlZCIsICJib29rbWFyay1sYWJlbCIsICJib29rbWFyay1sZXZlbCIsICJib29rbWFyay1zdGF0ZSIsCiAgICAiYm9va21hcmstdGFyZ2V0IiwgImJvcmRlciIsICJib3JkZXItYm90dG9tIiwgImJvcmRlci1ib3R0b20tY29sb3IiLAogICAgImJvcmRlci1ib3R0b20tbGVmdC1yYWRpdXMiLCAiYm9yZGVyLWJvdHRvbS1yaWdodC1yYWRpdXMiLAogICAgImJvcmRlci1ib3R0b20tc3R5bGUiLCAiYm9yZGVyLWJvdHRvbS13aWR0aCIsICJib3JkZXItY29sbGFwc2UiLAogICAgImJvcmRlci1jb2xvciIsICJib3JkZXItaW1hZ2UiLCAiYm9yZGVyLWltYWdlLW91dHNldCIsCiAgICAiYm9yZGVyLWltYWdlLXJlcGVhdCIsICJib3JkZXItaW1hZ2Utc2xpY2UiLCAiYm9yZGVyLWltYWdlLXNvdXJjZSIsCiAgICAiYm9yZGVyLWltYWdlLXdpZHRoIiwgImJvcmRlci1sZWZ0IiwgImJvcmRlci1sZWZ0LWNvbG9yIiwKICAgICJib3JkZXItbGVmdC1zdHlsZSIsICJib3JkZXItbGVmdC13aWR0aCIsICJib3JkZXItcmFkaXVzIiwgImJvcmRlci1yaWdodCIsCiAgICAiYm9yZGVyLXJpZ2h0LWNvbG9yIiwgImJvcmRlci1yaWdodC1zdHlsZSIsICJib3JkZXItcmlnaHQtd2lkdGgiLAogICAgImJvcmRlci1zcGFjaW5nIiwgImJvcmRlci1zdHlsZSIsICJib3JkZXItdG9wIiwgImJvcmRlci10b3AtY29sb3IiLAogICAgImJvcmRlci10b3AtbGVmdC1yYWRpdXMiLCAiYm9yZGVyLXRvcC1yaWdodC1yYWRpdXMiLCAiYm9yZGVyLXRvcC1zdHlsZSIsCiAgICAiYm9yZGVyLXRvcC13aWR0aCIsICJib3JkZXItd2lkdGgiLCAiYm90dG9tIiwgImJveC1kZWNvcmF0aW9uLWJyZWFrIiwKICAgICJib3gtc2hhZG93IiwgImJveC1zaXppbmciLCAiYnJlYWstYWZ0ZXIiLCAiYnJlYWstYmVmb3JlIiwgImJyZWFrLWluc2lkZSIsCiAgICAiY2FwdGlvbi1zaWRlIiwgImNhcmV0LWNvbG9yIiwgImNsZWFyIiwgImNsaXAiLCAiY29sb3IiLCAiY29sb3ItcHJvZmlsZSIsICJjb2x1bW4tY291bnQiLAogICAgImNvbHVtbi1maWxsIiwgImNvbHVtbi1nYXAiLCAiY29sdW1uLXJ1bGUiLCAiY29sdW1uLXJ1bGUtY29sb3IiLAogICAgImNvbHVtbi1ydWxlLXN0eWxlIiwgImNvbHVtbi1ydWxlLXdpZHRoIiwgImNvbHVtbi1zcGFuIiwgImNvbHVtbi13aWR0aCIsCiAgICAiY29sdW1ucyIsICJjb250ZW50IiwgImNvdW50ZXItaW5jcmVtZW50IiwgImNvdW50ZXItcmVzZXQiLCAiY3JvcCIsICJjdWUiLAogICAgImN1ZS1hZnRlciIsICJjdWUtYmVmb3JlIiwgImN1cnNvciIsICJkaXJlY3Rpb24iLCAiZGlzcGxheSIsCiAgICAiZG9taW5hbnQtYmFzZWxpbmUiLCAiZHJvcC1pbml0aWFsLWFmdGVyLWFkanVzdCIsCiAgICAiZHJvcC1pbml0aWFsLWFmdGVyLWFsaWduIiwgImRyb3AtaW5pdGlhbC1iZWZvcmUtYWRqdXN0IiwKICAgICJkcm9wLWluaXRpYWwtYmVmb3JlLWFsaWduIiwgImRyb3AtaW5pdGlhbC1zaXplIiwgImRyb3AtaW5pdGlhbC12YWx1ZSIsCiAgICAiZWxldmF0aW9uIiwgImVtcHR5LWNlbGxzIiwgImZpdCIsICJmaXQtcG9zaXRpb24iLCAiZmxleCIsICJmbGV4LWJhc2lzIiwKICAgICJmbGV4LWRpcmVjdGlvbiIsICJmbGV4LWZsb3ciLCAiZmxleC1ncm93IiwgImZsZXgtc2hyaW5rIiwgImZsZXgtd3JhcCIsCiAgICAiZmxvYXQiLCAiZmxvYXQtb2Zmc2V0IiwgImZsb3ctZnJvbSIsICJmbG93LWludG8iLCAiZm9udCIsICJmb250LWZlYXR1cmUtc2V0dGluZ3MiLAogICAgImZvbnQtZmFtaWx5IiwgImZvbnQta2VybmluZyIsICJmb250LWxhbmd1YWdlLW92ZXJyaWRlIiwgImZvbnQtc2l6ZSIsICJmb250LXNpemUtYWRqdXN0IiwKICAgICJmb250LXN0cmV0Y2giLCAiZm9udC1zdHlsZSIsICJmb250LXN5bnRoZXNpcyIsICJmb250LXZhcmlhbnQiLAogICAgImZvbnQtdmFyaWFudC1hbHRlcm5hdGVzIiwgImZvbnQtdmFyaWFudC1jYXBzIiwgImZvbnQtdmFyaWFudC1lYXN0LWFzaWFuIiwKICAgICJmb250LXZhcmlhbnQtbGlnYXR1cmVzIiwgImZvbnQtdmFyaWFudC1udW1lcmljIiwgImZvbnQtdmFyaWFudC1wb3NpdGlvbiIsCiAgICAiZm9udC13ZWlnaHQiLCAiZ3JpZCIsICJncmlkLWFyZWEiLCAiZ3JpZC1hdXRvLWNvbHVtbnMiLCAiZ3JpZC1hdXRvLWZsb3ciLAogICAgImdyaWQtYXV0by1yb3dzIiwgImdyaWQtY29sdW1uIiwgImdyaWQtY29sdW1uLWVuZCIsICJncmlkLWNvbHVtbi1nYXAiLAogICAgImdyaWQtY29sdW1uLXN0YXJ0IiwgImdyaWQtZ2FwIiwgImdyaWQtcm93IiwgImdyaWQtcm93LWVuZCIsICJncmlkLXJvdy1nYXAiLAogICAgImdyaWQtcm93LXN0YXJ0IiwgImdyaWQtdGVtcGxhdGUiLCAiZ3JpZC10ZW1wbGF0ZS1hcmVhcyIsICJncmlkLXRlbXBsYXRlLWNvbHVtbnMiLAogICAgImdyaWQtdGVtcGxhdGUtcm93cyIsICJoYW5naW5nLXB1bmN0dWF0aW9uIiwgImhlaWdodCIsICJoeXBoZW5zIiwKICAgICJpY29uIiwgImltYWdlLW9yaWVudGF0aW9uIiwgImltYWdlLXJlbmRlcmluZyIsICJpbWFnZS1yZXNvbHV0aW9uIiwKICAgICJpbmxpbmUtYm94LWFsaWduIiwgImp1c3RpZnktY29udGVudCIsICJqdXN0aWZ5LWl0ZW1zIiwgImp1c3RpZnktc2VsZiIsICJsZWZ0IiwgImxldHRlci1zcGFjaW5nIiwKICAgICJsaW5lLWJyZWFrIiwgImxpbmUtaGVpZ2h0IiwgImxpbmUtc3RhY2tpbmciLCAibGluZS1zdGFja2luZy1ydWJ5IiwKICAgICJsaW5lLXN0YWNraW5nLXNoaWZ0IiwgImxpbmUtc3RhY2tpbmctc3RyYXRlZ3kiLCAibGlzdC1zdHlsZSIsCiAgICAibGlzdC1zdHlsZS1pbWFnZSIsICJsaXN0LXN0eWxlLXBvc2l0aW9uIiwgImxpc3Qtc3R5bGUtdHlwZSIsICJtYXJnaW4iLAogICAgIm1hcmdpbi1ib3R0b20iLCAibWFyZ2luLWxlZnQiLCAibWFyZ2luLXJpZ2h0IiwgIm1hcmdpbi10b3AiLAogICAgIm1hcmtzIiwgIm1hcnF1ZWUtZGlyZWN0aW9uIiwgIm1hcnF1ZWUtbG9vcCIsCiAgICAibWFycXVlZS1wbGF5LWNvdW50IiwgIm1hcnF1ZWUtc3BlZWQiLCAibWFycXVlZS1zdHlsZSIsICJtYXgtaGVpZ2h0IiwKICAgICJtYXgtd2lkdGgiLCAibWluLWhlaWdodCIsICJtaW4td2lkdGgiLCAibWl4LWJsZW5kLW1vZGUiLCAibW92ZS10byIsICJuYXYtZG93biIsICJuYXYtaW5kZXgiLAogICAgIm5hdi1sZWZ0IiwgIm5hdi1yaWdodCIsICJuYXYtdXAiLCAib2JqZWN0LWZpdCIsICJvYmplY3QtcG9zaXRpb24iLAogICAgIm9wYWNpdHkiLCAib3JkZXIiLCAib3JwaGFucyIsICJvdXRsaW5lIiwKICAgICJvdXRsaW5lLWNvbG9yIiwgIm91dGxpbmUtb2Zmc2V0IiwgIm91dGxpbmUtc3R5bGUiLCAib3V0bGluZS13aWR0aCIsCiAgICAib3ZlcmZsb3ciLCAib3ZlcmZsb3ctc3R5bGUiLCAib3ZlcmZsb3ctd3JhcCIsICJvdmVyZmxvdy14IiwgIm92ZXJmbG93LXkiLAogICAgInBhZGRpbmciLCAicGFkZGluZy1ib3R0b20iLCAicGFkZGluZy1sZWZ0IiwgInBhZGRpbmctcmlnaHQiLCAicGFkZGluZy10b3AiLAogICAgInBhZ2UiLCAicGFnZS1icmVhay1hZnRlciIsICJwYWdlLWJyZWFrLWJlZm9yZSIsICJwYWdlLWJyZWFrLWluc2lkZSIsCiAgICAicGFnZS1wb2xpY3kiLCAicGF1c2UiLCAicGF1c2UtYWZ0ZXIiLCAicGF1c2UtYmVmb3JlIiwgInBlcnNwZWN0aXZlIiwKICAgICJwZXJzcGVjdGl2ZS1vcmlnaW4iLCAicGl0Y2giLCAicGl0Y2gtcmFuZ2UiLCAicGxhY2UtY29udGVudCIsICJwbGFjZS1pdGVtcyIsICJwbGFjZS1zZWxmIiwgInBsYXktZHVyaW5nIiwgInBvc2l0aW9uIiwKICAgICJwcmVzZW50YXRpb24tbGV2ZWwiLCAicHVuY3R1YXRpb24tdHJpbSIsICJxdW90ZXMiLCAicmVnaW9uLWJyZWFrLWFmdGVyIiwKICAgICJyZWdpb24tYnJlYWstYmVmb3JlIiwgInJlZ2lvbi1icmVhay1pbnNpZGUiLCAicmVnaW9uLWZyYWdtZW50IiwKICAgICJyZW5kZXJpbmctaW50ZW50IiwgInJlc2l6ZSIsICJyZXN0IiwgInJlc3QtYWZ0ZXIiLCAicmVzdC1iZWZvcmUiLCAicmljaG5lc3MiLAogICAgInJpZ2h0IiwgInJvdGF0aW9uIiwgInJvdGF0aW9uLXBvaW50IiwgInJ1YnktYWxpZ24iLCAicnVieS1vdmVyaGFuZyIsCiAgICAicnVieS1wb3NpdGlvbiIsICJydWJ5LXNwYW4iLCAic2hhcGUtaW1hZ2UtdGhyZXNob2xkIiwgInNoYXBlLWluc2lkZSIsICJzaGFwZS1tYXJnaW4iLAogICAgInNoYXBlLW91dHNpZGUiLCAic2l6ZSIsICJzcGVhayIsICJzcGVhay1hcyIsICJzcGVhay1oZWFkZXIiLAogICAgInNwZWFrLW51bWVyYWwiLCAic3BlYWstcHVuY3R1YXRpb24iLCAic3BlZWNoLXJhdGUiLCAic3RyZXNzIiwgInN0cmluZy1zZXQiLAogICAgInRhYi1zaXplIiwgInRhYmxlLWxheW91dCIsICJ0YXJnZXQiLCAidGFyZ2V0LW5hbWUiLCAidGFyZ2V0LW5ldyIsCiAgICAidGFyZ2V0LXBvc2l0aW9uIiwgInRleHQtYWxpZ24iLCAidGV4dC1hbGlnbi1sYXN0IiwgInRleHQtZGVjb3JhdGlvbiIsCiAgICAidGV4dC1kZWNvcmF0aW9uLWNvbG9yIiwgInRleHQtZGVjb3JhdGlvbi1saW5lIiwgInRleHQtZGVjb3JhdGlvbi1za2lwIiwKICAgICJ0ZXh0LWRlY29yYXRpb24tc3R5bGUiLCAidGV4dC1lbXBoYXNpcyIsICJ0ZXh0LWVtcGhhc2lzLWNvbG9yIiwKICAgICJ0ZXh0LWVtcGhhc2lzLXBvc2l0aW9uIiwgInRleHQtZW1waGFzaXMtc3R5bGUiLCAidGV4dC1oZWlnaHQiLAogICAgInRleHQtaW5kZW50IiwgInRleHQtanVzdGlmeSIsICJ0ZXh0LW91dGxpbmUiLCAidGV4dC1vdmVyZmxvdyIsICJ0ZXh0LXNoYWRvdyIsCiAgICAidGV4dC1zaXplLWFkanVzdCIsICJ0ZXh0LXNwYWNlLWNvbGxhcHNlIiwgInRleHQtdHJhbnNmb3JtIiwgInRleHQtdW5kZXJsaW5lLXBvc2l0aW9uIiwKICAgICJ0ZXh0LXdyYXAiLCAidG9wIiwgInRyYW5zZm9ybSIsICJ0cmFuc2Zvcm0tb3JpZ2luIiwgInRyYW5zZm9ybS1zdHlsZSIsCiAgICAidHJhbnNpdGlvbiIsICJ0cmFuc2l0aW9uLWRlbGF5IiwgInRyYW5zaXRpb24tZHVyYXRpb24iLAogICAgInRyYW5zaXRpb24tcHJvcGVydHkiLCAidHJhbnNpdGlvbi10aW1pbmctZnVuY3Rpb24iLCAidW5pY29kZS1iaWRpIiwKICAgICJ1c2VyLXNlbGVjdCIsICJ2ZXJ0aWNhbC1hbGlnbiIsICJ2aXNpYmlsaXR5IiwgInZvaWNlLWJhbGFuY2UiLCAidm9pY2UtZHVyYXRpb24iLAogICAgInZvaWNlLWZhbWlseSIsICJ2b2ljZS1waXRjaCIsICJ2b2ljZS1yYW5nZSIsICJ2b2ljZS1yYXRlIiwgInZvaWNlLXN0cmVzcyIsCiAgICAidm9pY2Utdm9sdW1lIiwgInZvbHVtZSIsICJ3aGl0ZS1zcGFjZSIsICJ3aWRvd3MiLCAid2lkdGgiLCAid2lsbC1jaGFuZ2UiLCAid29yZC1icmVhayIsCiAgICAid29yZC1zcGFjaW5nIiwgIndvcmQtd3JhcCIsICJ6LWluZGV4IiwKICAgIC8vIFNWRy1zcGVjaWZpYwogICAgImNsaXAtcGF0aCIsICJjbGlwLXJ1bGUiLCAibWFzayIsICJlbmFibGUtYmFja2dyb3VuZCIsICJmaWx0ZXIiLCAiZmxvb2QtY29sb3IiLAogICAgImZsb29kLW9wYWNpdHkiLCAibGlnaHRpbmctY29sb3IiLCAic3RvcC1jb2xvciIsICJzdG9wLW9wYWNpdHkiLCAicG9pbnRlci1ldmVudHMiLAogICAgImNvbG9yLWludGVycG9sYXRpb24iLCAiY29sb3ItaW50ZXJwb2xhdGlvbi1maWx0ZXJzIiwKICAgICJjb2xvci1yZW5kZXJpbmciLCAiZmlsbCIsICJmaWxsLW9wYWNpdHkiLCAiZmlsbC1ydWxlIiwgImltYWdlLXJlbmRlcmluZyIsCiAgICAibWFya2VyIiwgIm1hcmtlci1lbmQiLCAibWFya2VyLW1pZCIsICJtYXJrZXItc3RhcnQiLCAic2hhcGUtcmVuZGVyaW5nIiwgInN0cm9rZSIsCiAgICAic3Ryb2tlLWRhc2hhcnJheSIsICJzdHJva2UtZGFzaG9mZnNldCIsICJzdHJva2UtbGluZWNhcCIsICJzdHJva2UtbGluZWpvaW4iLAogICAgInN0cm9rZS1taXRlcmxpbWl0IiwgInN0cm9rZS1vcGFjaXR5IiwgInN0cm9rZS13aWR0aCIsICJ0ZXh0LXJlbmRlcmluZyIsCiAgICAiYmFzZWxpbmUtc2hpZnQiLCAiZG9taW5hbnQtYmFzZWxpbmUiLCAiZ2x5cGgtb3JpZW50YXRpb24taG9yaXpvbnRhbCIsCiAgICAiZ2x5cGgtb3JpZW50YXRpb24tdmVydGljYWwiLCAidGV4dC1hbmNob3IiLCAid3JpdGluZy1tb2RlIgogIF0sIHByb3BlcnR5S2V5d29yZHMgPSBrZXlTZXQocHJvcGVydHlLZXl3b3Jkc18pOwoKICB2YXIgbm9uU3RhbmRhcmRQcm9wZXJ0eUtleXdvcmRzXyA9IFsKICAgICJzY3JvbGxiYXItYXJyb3ctY29sb3IiLCAic2Nyb2xsYmFyLWJhc2UtY29sb3IiLCAic2Nyb2xsYmFyLWRhcmstc2hhZG93LWNvbG9yIiwKICAgICJzY3JvbGxiYXItZmFjZS1jb2xvciIsICJzY3JvbGxiYXItaGlnaGxpZ2h0LWNvbG9yIiwgInNjcm9sbGJhci1zaGFkb3ctY29sb3IiLAogICAgInNjcm9sbGJhci0zZC1saWdodC1jb2xvciIsICJzY3JvbGxiYXItdHJhY2stY29sb3IiLCAic2hhcGUtaW5zaWRlIiwKICAgICJzZWFyY2hmaWVsZC1jYW5jZWwtYnV0dG9uIiwgInNlYXJjaGZpZWxkLWRlY29yYXRpb24iLCAic2VhcmNoZmllbGQtcmVzdWx0cy1idXR0b24iLAogICAgInNlYXJjaGZpZWxkLXJlc3VsdHMtZGVjb3JhdGlvbiIsICJ6b29tIgogIF0sIG5vblN0YW5kYXJkUHJvcGVydHlLZXl3b3JkcyA9IGtleVNldChub25TdGFuZGFyZFByb3BlcnR5S2V5d29yZHNfKTsKCiAgdmFyIGZvbnRQcm9wZXJ0aWVzXyA9IFsKICAgICJmb250LWZhbWlseSIsICJzcmMiLCAidW5pY29kZS1yYW5nZSIsICJmb250LXZhcmlhbnQiLCAiZm9udC1mZWF0dXJlLXNldHRpbmdzIiwKICAgICJmb250LXN0cmV0Y2giLCAiZm9udC13ZWlnaHQiLCAiZm9udC1zdHlsZSIKICBdLCBmb250UHJvcGVydGllcyA9IGtleVNldChmb250UHJvcGVydGllc18pOwoKICB2YXIgY291bnRlckRlc2NyaXB0b3JzXyA9IFsKICAgICJhZGRpdGl2ZS1zeW1ib2xzIiwgImZhbGxiYWNrIiwgIm5lZ2F0aXZlIiwgInBhZCIsICJwcmVmaXgiLCAicmFuZ2UiLAogICAgInNwZWFrLWFzIiwgInN1ZmZpeCIsICJzeW1ib2xzIiwgInN5c3RlbSIKICBdLCBjb3VudGVyRGVzY3JpcHRvcnMgPSBrZXlTZXQoY291bnRlckRlc2NyaXB0b3JzXyk7CgogIHZhciBjb2xvcktleXdvcmRzXyA9IFsKICAgICJhbGljZWJsdWUiLCAiYW50aXF1ZXdoaXRlIiwgImFxdWEiLCAiYXF1YW1hcmluZSIsICJhenVyZSIsICJiZWlnZSIsCiAgICAiYmlzcXVlIiwgImJsYWNrIiwgImJsYW5jaGVkYWxtb25kIiwgImJsdWUiLCAiYmx1ZXZpb2xldCIsICJicm93biIsCiAgICAiYnVybHl3b29kIiwgImNhZGV0Ymx1ZSIsICJjaGFydHJldXNlIiwgImNob2NvbGF0ZSIsICJjb3JhbCIsICJjb3JuZmxvd2VyYmx1ZSIsCiAgICAiY29ybnNpbGsiLCAiY3JpbXNvbiIsICJjeWFuIiwgImRhcmtibHVlIiwgImRhcmtjeWFuIiwgImRhcmtnb2xkZW5yb2QiLAogICAgImRhcmtncmF5IiwgImRhcmtncmVlbiIsICJkYXJra2hha2kiLCAiZGFya21hZ2VudGEiLCAiZGFya29saXZlZ3JlZW4iLAogICAgImRhcmtvcmFuZ2UiLCAiZGFya29yY2hpZCIsICJkYXJrcmVkIiwgImRhcmtzYWxtb24iLCAiZGFya3NlYWdyZWVuIiwKICAgICJkYXJrc2xhdGVibHVlIiwgImRhcmtzbGF0ZWdyYXkiLCAiZGFya3R1cnF1b2lzZSIsICJkYXJrdmlvbGV0IiwKICAgICJkZWVwcGluayIsICJkZWVwc2t5Ymx1ZSIsICJkaW1ncmF5IiwgImRvZGdlcmJsdWUiLCAiZmlyZWJyaWNrIiwKICAgICJmbG9yYWx3aGl0ZSIsICJmb3Jlc3RncmVlbiIsICJmdWNoc2lhIiwgImdhaW5zYm9ybyIsICJnaG9zdHdoaXRlIiwKICAgICJnb2xkIiwgImdvbGRlbnJvZCIsICJncmF5IiwgImdyZXkiLCAiZ3JlZW4iLCAiZ3JlZW55ZWxsb3ciLCAiaG9uZXlkZXciLAogICAgImhvdHBpbmsiLCAiaW5kaWFucmVkIiwgImluZGlnbyIsICJpdm9yeSIsICJraGFraSIsICJsYXZlbmRlciIsCiAgICAibGF2ZW5kZXJibHVzaCIsICJsYXduZ3JlZW4iLCAibGVtb25jaGlmZm9uIiwgImxpZ2h0Ymx1ZSIsICJsaWdodGNvcmFsIiwKICAgICJsaWdodGN5YW4iLCAibGlnaHRnb2xkZW5yb2R5ZWxsb3ciLCAibGlnaHRncmF5IiwgImxpZ2h0Z3JlZW4iLCAibGlnaHRwaW5rIiwKICAgICJsaWdodHNhbG1vbiIsICJsaWdodHNlYWdyZWVuIiwgImxpZ2h0c2t5Ymx1ZSIsICJsaWdodHNsYXRlZ3JheSIsCiAgICAibGlnaHRzdGVlbGJsdWUiLCAibGlnaHR5ZWxsb3ciLCAibGltZSIsICJsaW1lZ3JlZW4iLCAibGluZW4iLCAibWFnZW50YSIsCiAgICAibWFyb29uIiwgIm1lZGl1bWFxdWFtYXJpbmUiLCAibWVkaXVtYmx1ZSIsICJtZWRpdW1vcmNoaWQiLCAibWVkaXVtcHVycGxlIiwKICAgICJtZWRpdW1zZWFncmVlbiIsICJtZWRpdW1zbGF0ZWJsdWUiLCAibWVkaXVtc3ByaW5nZ3JlZW4iLCAibWVkaXVtdHVycXVvaXNlIiwKICAgICJtZWRpdW12aW9sZXRyZWQiLCAibWlkbmlnaHRibHVlIiwgIm1pbnRjcmVhbSIsICJtaXN0eXJvc2UiLCAibW9jY2FzaW4iLAogICAgIm5hdmFqb3doaXRlIiwgIm5hdnkiLCAib2xkbGFjZSIsICJvbGl2ZSIsICJvbGl2ZWRyYWIiLCAib3JhbmdlIiwgIm9yYW5nZXJlZCIsCiAgICAib3JjaGlkIiwgInBhbGVnb2xkZW5yb2QiLCAicGFsZWdyZWVuIiwgInBhbGV0dXJxdW9pc2UiLCAicGFsZXZpb2xldHJlZCIsCiAgICAicGFwYXlhd2hpcCIsICJwZWFjaHB1ZmYiLCAicGVydSIsICJwaW5rIiwgInBsdW0iLCAicG93ZGVyYmx1ZSIsCiAgICAicHVycGxlIiwgInJlYmVjY2FwdXJwbGUiLCAicmVkIiwgInJvc3licm93biIsICJyb3lhbGJsdWUiLCAic2FkZGxlYnJvd24iLAogICAgInNhbG1vbiIsICJzYW5keWJyb3duIiwgInNlYWdyZWVuIiwgInNlYXNoZWxsIiwgInNpZW5uYSIsICJzaWx2ZXIiLCAic2t5Ymx1ZSIsCiAgICAic2xhdGVibHVlIiwgInNsYXRlZ3JheSIsICJzbm93IiwgInNwcmluZ2dyZWVuIiwgInN0ZWVsYmx1ZSIsICJ0YW4iLAogICAgInRlYWwiLCAidGhpc3RsZSIsICJ0b21hdG8iLCAidHVycXVvaXNlIiwgInZpb2xldCIsICJ3aGVhdCIsICJ3aGl0ZSIsCiAgICAid2hpdGVzbW9rZSIsICJ5ZWxsb3ciLCAieWVsbG93Z3JlZW4iCiAgXSwgY29sb3JLZXl3b3JkcyA9IGtleVNldChjb2xvcktleXdvcmRzXyk7CgogIHZhciB2YWx1ZUtleXdvcmRzXyA9IFsKICAgICJhYm92ZSIsICJhYnNvbHV0ZSIsICJhY3RpdmVib3JkZXIiLCAiYWRkaXRpdmUiLCAiYWN0aXZlY2FwdGlvbiIsICJhZmFyIiwKICAgICJhZnRlci13aGl0ZS1zcGFjZSIsICJhaGVhZCIsICJhbGlhcyIsICJhbGwiLCAiYWxsLXNjcm9sbCIsICJhbHBoYWJldGljIiwgImFsdGVybmF0ZSIsCiAgICAiYWx3YXlzIiwgImFtaGFyaWMiLCAiYW1oYXJpYy1hYmVnZWRlIiwgImFudGlhbGlhc2VkIiwgImFwcHdvcmtzcGFjZSIsCiAgICAiYXJhYmljLWluZGljIiwgImFybWVuaWFuIiwgImFzdGVyaXNrcyIsICJhdHRyIiwgImF1dG8iLCAiYXV0by1mbG93IiwgImF2b2lkIiwgImF2b2lkLWNvbHVtbiIsICJhdm9pZC1wYWdlIiwKICAgICJhdm9pZC1yZWdpb24iLCAiYmFja2dyb3VuZCIsICJiYWNrd2FyZHMiLCAiYmFzZWxpbmUiLCAiYmVsb3ciLCAiYmlkaS1vdmVycmlkZSIsICJiaW5hcnkiLAogICAgImJlbmdhbGkiLCAiYmxpbmsiLCAiYmxvY2siLCAiYmxvY2stYXhpcyIsICJib2xkIiwgImJvbGRlciIsICJib3JkZXIiLCAiYm9yZGVyLWJveCIsCiAgICAiYm90aCIsICJib3R0b20iLCAiYnJlYWsiLCAiYnJlYWstYWxsIiwgImJyZWFrLXdvcmQiLCAiYnVsbGV0cyIsICJidXR0b24iLCAiYnV0dG9uLWJldmVsIiwKICAgICJidXR0b25mYWNlIiwgImJ1dHRvbmhpZ2hsaWdodCIsICJidXR0b25zaGFkb3ciLCAiYnV0dG9udGV4dCIsICJjYWxjIiwgImNhbWJvZGlhbiIsCiAgICAiY2FwaXRhbGl6ZSIsICJjYXBzLWxvY2staW5kaWNhdG9yIiwgImNhcHRpb24iLCAiY2FwdGlvbnRleHQiLCAiY2FyZXQiLAogICAgImNlbGwiLCAiY2VudGVyIiwgImNoZWNrYm94IiwgImNpcmNsZSIsICJjamstZGVjaW1hbCIsICJjamstZWFydGhseS1icmFuY2giLAogICAgImNqay1oZWF2ZW5seS1zdGVtIiwgImNqay1pZGVvZ3JhcGhpYyIsICJjbGVhciIsICJjbGlwIiwgImNsb3NlLXF1b3RlIiwKICAgICJjb2wtcmVzaXplIiwgImNvbGxhcHNlIiwgImNvbG9yIiwgImNvbG9yLWJ1cm4iLCAiY29sb3ItZG9kZ2UiLCAiY29sdW1uIiwgImNvbHVtbi1yZXZlcnNlIiwKICAgICJjb21wYWN0IiwgImNvbmRlbnNlZCIsICJjb250YWluIiwgImNvbnRlbnQiLCAiY29udGVudHMiLAogICAgImNvbnRlbnQtYm94IiwgImNvbnRleHQtbWVudSIsICJjb250aW51b3VzIiwgImNvcHkiLCAiY291bnRlciIsICJjb3VudGVycyIsICJjb3ZlciIsICJjcm9wIiwKICAgICJjcm9zcyIsICJjcm9zc2hhaXIiLCAiY3VycmVudGNvbG9yIiwgImN1cnNpdmUiLCAiY3ljbGljIiwgImRhcmtlbiIsICJkYXNoZWQiLCAiZGVjaW1hbCIsCiAgICAiZGVjaW1hbC1sZWFkaW5nLXplcm8iLCAiZGVmYXVsdCIsICJkZWZhdWx0LWJ1dHRvbiIsICJkZW5zZSIsICJkZXN0aW5hdGlvbi1hdG9wIiwKICAgICJkZXN0aW5hdGlvbi1pbiIsICJkZXN0aW5hdGlvbi1vdXQiLCAiZGVzdGluYXRpb24tb3ZlciIsICJkZXZhbmFnYXJpIiwgImRpZmZlcmVuY2UiLAogICAgImRpc2MiLCAiZGlzY2FyZCIsICJkaXNjbG9zdXJlLWNsb3NlZCIsICJkaXNjbG9zdXJlLW9wZW4iLCAiZG9jdW1lbnQiLAogICAgImRvdC1kYXNoIiwgImRvdC1kb3QtZGFzaCIsCiAgICAiZG90dGVkIiwgImRvdWJsZSIsICJkb3duIiwgImUtcmVzaXplIiwgImVhc2UiLCAiZWFzZS1pbiIsICJlYXNlLWluLW91dCIsICJlYXNlLW91dCIsCiAgICAiZWxlbWVudCIsICJlbGxpcHNlIiwgImVsbGlwc2lzIiwgImVtYmVkIiwgImVuZCIsICJldGhpb3BpYyIsICJldGhpb3BpYy1hYmVnZWRlIiwKICAgICJldGhpb3BpYy1hYmVnZWRlLWFtLWV0IiwgImV0aGlvcGljLWFiZWdlZGUtZ2V6IiwgImV0aGlvcGljLWFiZWdlZGUtdGktZXIiLAogICAgImV0aGlvcGljLWFiZWdlZGUtdGktZXQiLCAiZXRoaW9waWMtaGFsZWhhbWUtYWEtZXIiLAogICAgImV0aGlvcGljLWhhbGVoYW1lLWFhLWV0IiwgImV0aGlvcGljLWhhbGVoYW1lLWFtLWV0IiwKICAgICJldGhpb3BpYy1oYWxlaGFtZS1nZXoiLCAiZXRoaW9waWMtaGFsZWhhbWUtb20tZXQiLAogICAgImV0aGlvcGljLWhhbGVoYW1lLXNpZC1ldCIsICJldGhpb3BpYy1oYWxlaGFtZS1zby1ldCIsCiAgICAiZXRoaW9waWMtaGFsZWhhbWUtdGktZXIiLCAiZXRoaW9waWMtaGFsZWhhbWUtdGktZXQiLCAiZXRoaW9waWMtaGFsZWhhbWUtdGlnIiwKICAgICJldGhpb3BpYy1udW1lcmljIiwgImV3LXJlc2l6ZSIsICJleGNsdXNpb24iLCAiZXhwYW5kZWQiLCAiZXh0ZW5kcyIsICJleHRyYS1jb25kZW5zZWQiLAogICAgImV4dHJhLWV4cGFuZGVkIiwgImZhbnRhc3kiLCAiZmFzdCIsICJmaWxsIiwgImZpeGVkIiwgImZsYXQiLCAiZmxleCIsICJmbGV4LWVuZCIsICJmbGV4LXN0YXJ0IiwgImZvb3Rub3RlcyIsCiAgICAiZm9yd2FyZHMiLCAiZnJvbSIsICJnZW9tZXRyaWNQcmVjaXNpb24iLCAiZ2VvcmdpYW4iLCAiZ3JheXRleHQiLCAiZ3JpZCIsICJncm9vdmUiLAogICAgImd1amFyYXRpIiwgImd1cm11a2hpIiwgImhhbmQiLCAiaGFuZ3VsIiwgImhhbmd1bC1jb25zb25hbnQiLCAiaGFyZC1saWdodCIsICJoZWJyZXciLAogICAgImhlbHAiLCAiaGlkZGVuIiwgImhpZGUiLCAiaGlnaGVyIiwgImhpZ2hsaWdodCIsICJoaWdobGlnaHR0ZXh0IiwKICAgICJoaXJhZ2FuYSIsICJoaXJhZ2FuYS1pcm9oYSIsICJob3Jpem9udGFsIiwgImhzbCIsICJoc2xhIiwgImh1ZSIsICJpY29uIiwgImlnbm9yZSIsCiAgICAiaW5hY3RpdmVib3JkZXIiLCAiaW5hY3RpdmVjYXB0aW9uIiwgImluYWN0aXZlY2FwdGlvbnRleHQiLCAiaW5maW5pdGUiLAogICAgImluZm9iYWNrZ3JvdW5kIiwgImluZm90ZXh0IiwgImluaGVyaXQiLCAiaW5pdGlhbCIsICJpbmxpbmUiLCAiaW5saW5lLWF4aXMiLAogICAgImlubGluZS1ibG9jayIsICJpbmxpbmUtZmxleCIsICJpbmxpbmUtZ3JpZCIsICJpbmxpbmUtdGFibGUiLCAiaW5zZXQiLCAiaW5zaWRlIiwgImludHJpbnNpYyIsICJpbnZlcnQiLAogICAgIml0YWxpYyIsICJqYXBhbmVzZS1mb3JtYWwiLCAiamFwYW5lc2UtaW5mb3JtYWwiLCAianVzdGlmeSIsICJrYW5uYWRhIiwKICAgICJrYXRha2FuYSIsICJrYXRha2FuYS1pcm9oYSIsICJrZWVwLWFsbCIsICJraG1lciIsCiAgICAia29yZWFuLWhhbmd1bC1mb3JtYWwiLCAia29yZWFuLWhhbmphLWZvcm1hbCIsICJrb3JlYW4taGFuamEtaW5mb3JtYWwiLAogICAgImxhbmRzY2FwZSIsICJsYW8iLCAibGFyZ2UiLCAibGFyZ2VyIiwgImxlZnQiLCAibGV2ZWwiLCAibGlnaHRlciIsICJsaWdodGVuIiwKICAgICJsaW5lLXRocm91Z2giLCAibGluZWFyIiwgImxpbmVhci1ncmFkaWVudCIsICJsaW5lcyIsICJsaXN0LWl0ZW0iLCAibGlzdGJveCIsICJsaXN0aXRlbSIsCiAgICAibG9jYWwiLCAibG9naWNhbCIsICJsb3VkIiwgImxvd2VyIiwgImxvd2VyLWFscGhhIiwgImxvd2VyLWFybWVuaWFuIiwKICAgICJsb3dlci1ncmVlayIsICJsb3dlci1oZXhhZGVjaW1hbCIsICJsb3dlci1sYXRpbiIsICJsb3dlci1ub3J3ZWdpYW4iLAogICAgImxvd2VyLXJvbWFuIiwgImxvd2VyY2FzZSIsICJsdHIiLCAibHVtaW5vc2l0eSIsICJtYWxheWFsYW0iLCAibWF0Y2giLCAibWF0cml4IiwgIm1hdHJpeDNkIiwKICAgICJtZWRpYS1jb250cm9scy1iYWNrZ3JvdW5kIiwgIm1lZGlhLWN1cnJlbnQtdGltZS1kaXNwbGF5IiwKICAgICJtZWRpYS1mdWxsc2NyZWVuLWJ1dHRvbiIsICJtZWRpYS1tdXRlLWJ1dHRvbiIsICJtZWRpYS1wbGF5LWJ1dHRvbiIsCiAgICAibWVkaWEtcmV0dXJuLXRvLXJlYWx0aW1lLWJ1dHRvbiIsICJtZWRpYS1yZXdpbmQtYnV0dG9uIiwKICAgICJtZWRpYS1zZWVrLWJhY2stYnV0dG9uIiwgIm1lZGlhLXNlZWstZm9yd2FyZC1idXR0b24iLCAibWVkaWEtc2xpZGVyIiwKICAgICJtZWRpYS1zbGlkZXJ0aHVtYiIsICJtZWRpYS10aW1lLXJlbWFpbmluZy1kaXNwbGF5IiwgIm1lZGlhLXZvbHVtZS1zbGlkZXIiLAogICAgIm1lZGlhLXZvbHVtZS1zbGlkZXItY29udGFpbmVyIiwgIm1lZGlhLXZvbHVtZS1zbGlkZXJ0aHVtYiIsICJtZWRpdW0iLAogICAgIm1lbnUiLCAibWVudWxpc3QiLCAibWVudWxpc3QtYnV0dG9uIiwgIm1lbnVsaXN0LXRleHQiLAogICAgIm1lbnVsaXN0LXRleHRmaWVsZCIsICJtZW51dGV4dCIsICJtZXNzYWdlLWJveCIsICJtaWRkbGUiLCAibWluLWludHJpbnNpYyIsCiAgICAibWl4IiwgIm1vbmdvbGlhbiIsICJtb25vc3BhY2UiLCAibW92ZSIsICJtdWx0aXBsZSIsICJtdWx0aXBseSIsICJteWFubWFyIiwgIm4tcmVzaXplIiwKICAgICJuYXJyb3dlciIsICJuZS1yZXNpemUiLCAibmVzdy1yZXNpemUiLCAibm8tY2xvc2UtcXVvdGUiLCAibm8tZHJvcCIsCiAgICAibm8tb3Blbi1xdW90ZSIsICJuby1yZXBlYXQiLCAibm9uZSIsICJub3JtYWwiLCAibm90LWFsbG93ZWQiLCAibm93cmFwIiwKICAgICJucy1yZXNpemUiLCAibnVtYmVycyIsICJudW1lcmljIiwgIm53LXJlc2l6ZSIsICJud3NlLXJlc2l6ZSIsICJvYmxpcXVlIiwgIm9jdGFsIiwgIm9wYWNpdHkiLCAib3Blbi1xdW90ZSIsCiAgICAib3B0aW1pemVMZWdpYmlsaXR5IiwgIm9wdGltaXplU3BlZWQiLCAib3JpeWEiLCAib3JvbW8iLCAib3V0c2V0IiwKICAgICJvdXRzaWRlIiwgIm91dHNpZGUtc2hhcGUiLCAib3ZlcmxheSIsICJvdmVybGluZSIsICJwYWRkaW5nIiwgInBhZGRpbmctYm94IiwKICAgICJwYWludGVkIiwgInBhZ2UiLCAicGF1c2VkIiwgInBlcnNpYW4iLCAicGVyc3BlY3RpdmUiLCAicGx1cy1kYXJrZXIiLCAicGx1cy1saWdodGVyIiwKICAgICJwb2ludGVyIiwgInBvbHlnb24iLCAicG9ydHJhaXQiLCAicHJlIiwgInByZS1saW5lIiwgInByZS13cmFwIiwgInByZXNlcnZlLTNkIiwKICAgICJwcm9ncmVzcyIsICJwdXNoLWJ1dHRvbiIsICJyYWRpYWwtZ3JhZGllbnQiLCAicmFkaW8iLCAicmVhZC1vbmx5IiwKICAgICJyZWFkLXdyaXRlIiwgInJlYWQtd3JpdGUtcGxhaW50ZXh0LW9ubHkiLCAicmVjdGFuZ2xlIiwgInJlZ2lvbiIsCiAgICAicmVsYXRpdmUiLCAicmVwZWF0IiwgInJlcGVhdGluZy1saW5lYXItZ3JhZGllbnQiLAogICAgInJlcGVhdGluZy1yYWRpYWwtZ3JhZGllbnQiLCAicmVwZWF0LXgiLCAicmVwZWF0LXkiLCAicmVzZXQiLCAicmV2ZXJzZSIsCiAgICAicmdiIiwgInJnYmEiLCAicmlkZ2UiLCAicmlnaHQiLCAicm90YXRlIiwgInJvdGF0ZTNkIiwgInJvdGF0ZVgiLCAicm90YXRlWSIsCiAgICAicm90YXRlWiIsICJyb3VuZCIsICJyb3ciLCAicm93LXJlc2l6ZSIsICJyb3ctcmV2ZXJzZSIsICJydGwiLCAicnVuLWluIiwgInJ1bm5pbmciLAogICAgInMtcmVzaXplIiwgInNhbnMtc2VyaWYiLCAic2F0dXJhdGlvbiIsICJzY2FsZSIsICJzY2FsZTNkIiwgInNjYWxlWCIsICJzY2FsZVkiLCAic2NhbGVaIiwgInNjcmVlbiIsCiAgICAic2Nyb2xsIiwgInNjcm9sbGJhciIsICJzY3JvbGwtcG9zaXRpb24iLCAic2UtcmVzaXplIiwgInNlYXJjaGZpZWxkIiwKICAgICJzZWFyY2hmaWVsZC1jYW5jZWwtYnV0dG9uIiwgInNlYXJjaGZpZWxkLWRlY29yYXRpb24iLAogICAgInNlYXJjaGZpZWxkLXJlc3VsdHMtYnV0dG9uIiwgInNlYXJjaGZpZWxkLXJlc3VsdHMtZGVjb3JhdGlvbiIsICJzZWxmLXN0YXJ0IiwgInNlbGYtZW5kIiwKICAgICJzZW1pLWNvbmRlbnNlZCIsICJzZW1pLWV4cGFuZGVkIiwgInNlcGFyYXRlIiwgInNlcmlmIiwgInNob3ciLCAic2lkYW1hIiwKICAgICJzaW1wLWNoaW5lc2UtZm9ybWFsIiwgInNpbXAtY2hpbmVzZS1pbmZvcm1hbCIsICJzaW5nbGUiLAogICAgInNrZXciLCAic2tld1giLCAic2tld1kiLCAic2tpcC13aGl0ZS1zcGFjZSIsICJzbGlkZSIsICJzbGlkZXItaG9yaXpvbnRhbCIsCiAgICAic2xpZGVyLXZlcnRpY2FsIiwgInNsaWRlcnRodW1iLWhvcml6b250YWwiLCAic2xpZGVydGh1bWItdmVydGljYWwiLCAic2xvdyIsCiAgICAic21hbGwiLCAic21hbGwtY2FwcyIsICJzbWFsbC1jYXB0aW9uIiwgInNtYWxsZXIiLCAic29mdC1saWdodCIsICJzb2xpZCIsICJzb21hbGkiLAogICAgInNvdXJjZS1hdG9wIiwgInNvdXJjZS1pbiIsICJzb3VyY2Utb3V0IiwgInNvdXJjZS1vdmVyIiwgInNwYWNlIiwgInNwYWNlLWFyb3VuZCIsICJzcGFjZS1iZXR3ZWVuIiwgInNwYWNlLWV2ZW5seSIsICJzcGVsbC1vdXQiLCAic3F1YXJlIiwKICAgICJzcXVhcmUtYnV0dG9uIiwgInN0YXJ0IiwgInN0YXRpYyIsICJzdGF0dXMtYmFyIiwgInN0cmV0Y2giLCAic3Ryb2tlIiwgInN1YiIsCiAgICAic3VicGl4ZWwtYW50aWFsaWFzZWQiLCAic3VwZXIiLCAic3ctcmVzaXplIiwgInN5bWJvbGljIiwgInN5bWJvbHMiLCAic3lzdGVtLXVpIiwgInRhYmxlIiwKICAgICJ0YWJsZS1jYXB0aW9uIiwgInRhYmxlLWNlbGwiLCAidGFibGUtY29sdW1uIiwgInRhYmxlLWNvbHVtbi1ncm91cCIsCiAgICAidGFibGUtZm9vdGVyLWdyb3VwIiwgInRhYmxlLWhlYWRlci1ncm91cCIsICJ0YWJsZS1yb3ciLCAidGFibGUtcm93LWdyb3VwIiwKICAgICJ0YW1pbCIsCiAgICAidGVsdWd1IiwgInRleHQiLCAidGV4dC1ib3R0b20iLCAidGV4dC10b3AiLCAidGV4dGFyZWEiLCAidGV4dGZpZWxkIiwgInRoYWkiLAogICAgInRoaWNrIiwgInRoaW4iLCAidGhyZWVkZGFya3NoYWRvdyIsICJ0aHJlZWRmYWNlIiwgInRocmVlZGhpZ2hsaWdodCIsCiAgICAidGhyZWVkbGlnaHRzaGFkb3ciLCAidGhyZWVkc2hhZG93IiwgInRpYmV0YW4iLCAidGlncmUiLCAidGlncmlueWEtZXIiLAogICAgInRpZ3JpbnlhLWVyLWFiZWdlZGUiLCAidGlncmlueWEtZXQiLCAidGlncmlueWEtZXQtYWJlZ2VkZSIsICJ0byIsICJ0b3AiLAogICAgInRyYWQtY2hpbmVzZS1mb3JtYWwiLCAidHJhZC1jaGluZXNlLWluZm9ybWFsIiwgInRyYW5zZm9ybSIsCiAgICAidHJhbnNsYXRlIiwgInRyYW5zbGF0ZTNkIiwgInRyYW5zbGF0ZVgiLCAidHJhbnNsYXRlWSIsICJ0cmFuc2xhdGVaIiwKICAgICJ0cmFuc3BhcmVudCIsICJ1bHRyYS1jb25kZW5zZWQiLCAidWx0cmEtZXhwYW5kZWQiLCAidW5kZXJsaW5lIiwgInVuc2V0IiwgInVwIiwKICAgICJ1cHBlci1hbHBoYSIsICJ1cHBlci1hcm1lbmlhbiIsICJ1cHBlci1ncmVlayIsICJ1cHBlci1oZXhhZGVjaW1hbCIsCiAgICAidXBwZXItbGF0aW4iLCAidXBwZXItbm9yd2VnaWFuIiwgInVwcGVyLXJvbWFuIiwgInVwcGVyY2FzZSIsICJ1cmR1IiwgInVybCIsCiAgICAidmFyIiwgInZlcnRpY2FsIiwgInZlcnRpY2FsLXRleHQiLCAidmlzaWJsZSIsICJ2aXNpYmxlRmlsbCIsICJ2aXNpYmxlUGFpbnRlZCIsCiAgICAidmlzaWJsZVN0cm9rZSIsICJ2aXN1YWwiLCAidy1yZXNpemUiLCAid2FpdCIsICJ3YXZlIiwgIndpZGVyIiwKICAgICJ3aW5kb3ciLCAid2luZG93ZnJhbWUiLCAid2luZG93dGV4dCIsICJ3b3JkcyIsICJ3cmFwIiwgIndyYXAtcmV2ZXJzZSIsICJ4LWxhcmdlIiwgIngtc21hbGwiLCAieG9yIiwKICAgICJ4eC1sYXJnZSIsICJ4eC1zbWFsbCIKICBdLCB2YWx1ZUtleXdvcmRzID0ga2V5U2V0KHZhbHVlS2V5d29yZHNfKTsKCiAgdmFyIGFsbFdvcmRzID0gZG9jdW1lbnRUeXBlc18uY29uY2F0KG1lZGlhVHlwZXNfKS5jb25jYXQobWVkaWFGZWF0dXJlc18pLmNvbmNhdChtZWRpYVZhbHVlS2V5d29yZHNfKQogICAgLmNvbmNhdChwcm9wZXJ0eUtleXdvcmRzXykuY29uY2F0KG5vblN0YW5kYXJkUHJvcGVydHlLZXl3b3Jkc18pLmNvbmNhdChjb2xvcktleXdvcmRzXykKICAgIC5jb25jYXQodmFsdWVLZXl3b3Jkc18pOwogIENvZGVNaXJyb3IucmVnaXN0ZXJIZWxwZXIoImhpbnRXb3JkcyIsICJjc3MiLCBhbGxXb3Jkcyk7CgogIGZ1bmN0aW9uIHRva2VuQ0NvbW1lbnQoc3RyZWFtLCBzdGF0ZSkgewogICAgdmFyIG1heWJlRW5kID0gZmFsc2UsIGNoOwogICAgd2hpbGUgKChjaCA9IHN0cmVhbS5uZXh0KCkpICE9IG51bGwpIHsKICAgICAgaWYgKG1heWJlRW5kICYmIGNoID09ICIvIikgewogICAgICAgIHN0YXRlLnRva2VuaXplID0gbnVsbDsKICAgICAgICBicmVhazsKICAgICAgfQogICAgICBtYXliZUVuZCA9IChjaCA9PSAiKiIpOwogICAgfQogICAgcmV0dXJuIFsiY29tbWVudCIsICJjb21tZW50Il07CiAgfQoKICBDb2RlTWlycm9yLmRlZmluZU1JTUUoInRleHQvY3NzIiwgewogICAgZG9jdW1lbnRUeXBlczogZG9jdW1lbnRUeXBlcywKICAgIG1lZGlhVHlwZXM6IG1lZGlhVHlwZXMsCiAgICBtZWRpYUZlYXR1cmVzOiBtZWRpYUZlYXR1cmVzLAogICAgbWVkaWFWYWx1ZUtleXdvcmRzOiBtZWRpYVZhbHVlS2V5d29yZHMsCiAgICBwcm9wZXJ0eUtleXdvcmRzOiBwcm9wZXJ0eUtleXdvcmRzLAogICAgbm9uU3RhbmRhcmRQcm9wZXJ0eUtleXdvcmRzOiBub25TdGFuZGFyZFByb3BlcnR5S2V5d29yZHMsCiAgICBmb250UHJvcGVydGllczogZm9udFByb3BlcnRpZXMsCiAgICBjb3VudGVyRGVzY3JpcHRvcnM6IGNvdW50ZXJEZXNjcmlwdG9ycywKICAgIGNvbG9yS2V5d29yZHM6IGNvbG9yS2V5d29yZHMsCiAgICB2YWx1ZUtleXdvcmRzOiB2YWx1ZUtleXdvcmRzLAogICAgdG9rZW5Ib29rczogewogICAgICAiLyI6IGZ1bmN0aW9uKHN0cmVhbSwgc3RhdGUpIHsKICAgICAgICBpZiAoIXN0cmVhbS5lYXQoIioiKSkgcmV0dXJuIGZhbHNlOwogICAgICAgIHN0YXRlLnRva2VuaXplID0gdG9rZW5DQ29tbWVudDsKICAgICAgICByZXR1cm4gdG9rZW5DQ29tbWVudChzdHJlYW0sIHN0YXRlKTsKICAgICAgfQogICAgfSwKICAgIG5hbWU6ICJjc3MiCiAgfSk7CgogIENvZGVNaXJyb3IuZGVmaW5lTUlNRSgidGV4dC94LXNjc3MiLCB7CiAgICBtZWRpYVR5cGVzOiBtZWRpYVR5cGVzLAogICAgbWVkaWFGZWF0dXJlczogbWVkaWFGZWF0dXJlcywKICAgIG1lZGlhVmFsdWVLZXl3b3JkczogbWVkaWFWYWx1ZUtleXdvcmRzLAogICAgcHJvcGVydHlLZXl3b3JkczogcHJvcGVydHlLZXl3b3JkcywKICAgIG5vblN0YW5kYXJkUHJvcGVydHlLZXl3b3Jkczogbm9uU3RhbmRhcmRQcm9wZXJ0eUtleXdvcmRzLAogICAgY29sb3JLZXl3b3JkczogY29sb3JLZXl3b3JkcywKICAgIHZhbHVlS2V5d29yZHM6IHZhbHVlS2V5d29yZHMsCiAgICBmb250UHJvcGVydGllczogZm9udFByb3BlcnRpZXMsCiAgICBhbGxvd05lc3RlZDogdHJ1ZSwKICAgIGxpbmVDb21tZW50OiAiLy8iLAogICAgdG9rZW5Ib29rczogewogICAgICAiLyI6IGZ1bmN0aW9uKHN0cmVhbSwgc3RhdGUpIHsKICAgICAgICBpZiAoc3RyZWFtLmVhdCgiLyIpKSB7CiAgICAgICAgICBzdHJlYW0uc2tpcFRvRW5kKCk7CiAgICAgICAgICByZXR1cm4gWyJjb21tZW50IiwgImNvbW1lbnQiXTsKICAgICAgICB9IGVsc2UgaWYgKHN0cmVhbS5lYXQoIioiKSkgewogICAgICAgICAgc3RhdGUudG9rZW5pemUgPSB0b2tlbkNDb21tZW50OwogICAgICAgICAgcmV0dXJuIHRva2VuQ0NvbW1lbnQoc3RyZWFtLCBzdGF0ZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiBbIm9wZXJhdG9yIiwgIm9wZXJhdG9yIl07CiAgICAgICAgfQogICAgICB9LAogICAgICAiOiI6IGZ1bmN0aW9uKHN0cmVhbSkgewogICAgICAgIGlmIChzdHJlYW0ubWF0Y2goL1xzKlx7LywgZmFsc2UpKQogICAgICAgICAgcmV0dXJuIFtudWxsLCBudWxsXQogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfSwKICAgICAgIiQiOiBmdW5jdGlvbihzdHJlYW0pIHsKICAgICAgICBzdHJlYW0ubWF0Y2goL15bXHctXSsvKTsKICAgICAgICBpZiAoc3RyZWFtLm1hdGNoKC9eXHMqOi8sIGZhbHNlKSkKICAgICAgICAgIHJldHVybiBbInZhcmlhYmxlLTIiLCAidmFyaWFibGUtZGVmaW5pdGlvbiJdOwogICAgICAgIHJldHVybiBbInZhcmlhYmxlLTIiLCAidmFyaWFibGUiXTsKICAgICAgfSwKICAgICAgIiMiOiBmdW5jdGlvbihzdHJlYW0pIHsKICAgICAgICBpZiAoIXN0cmVhbS5lYXQoInsiKSkgcmV0dXJuIGZhbHNlOwogICAgICAgIHJldHVybiBbbnVsbCwgImludGVycG9sYXRpb24iXTsKICAgICAgfQogICAgfSwKICAgIG5hbWU6ICJjc3MiLAogICAgaGVscGVyVHlwZTogInNjc3MiCiAgfSk7CgogIENvZGVNaXJyb3IuZGVmaW5lTUlNRSgidGV4dC94LWxlc3MiLCB7CiAgICBtZWRpYVR5cGVzOiBtZWRpYVR5cGVzLAogICAgbWVkaWFGZWF0dXJlczogbWVkaWFGZWF0dXJlcywKICAgIG1lZGlhVmFsdWVLZXl3b3JkczogbWVkaWFWYWx1ZUtleXdvcmRzLAogICAgcHJvcGVydHlLZXl3b3JkczogcHJvcGVydHlLZXl3b3JkcywKICAgIG5vblN0YW5kYXJkUHJvcGVydHlLZXl3b3Jkczogbm9uU3RhbmRhcmRQcm9wZXJ0eUtleXdvcmRzLAogICAgY29sb3JLZXl3b3JkczogY29sb3JLZXl3b3JkcywKICAgIHZhbHVlS2V5d29yZHM6IHZhbHVlS2V5d29yZHMsCiAgICBmb250UHJvcGVydGllczogZm9udFByb3BlcnRpZXMsCiAgICBhbGxvd05lc3RlZDogdHJ1ZSwKICAgIGxpbmVDb21tZW50OiAiLy8iLAogICAgdG9rZW5Ib29rczogewogICAgICAiLyI6IGZ1bmN0aW9uKHN0cmVhbSwgc3RhdGUpIHsKICAgICAgICBpZiAoc3RyZWFtLmVhdCgiLyIpKSB7CiAgICAgICAgICBzdHJlYW0uc2tpcFRvRW5kKCk7CiAgICAgICAgICByZXR1cm4gWyJjb21tZW50IiwgImNvbW1lbnQiXTsKICAgICAgICB9IGVsc2UgaWYgKHN0cmVhbS5lYXQoIioiKSkgewogICAgICAgICAgc3RhdGUudG9rZW5pemUgPSB0b2tlbkNDb21tZW50OwogICAgICAgICAgcmV0dXJuIHRva2VuQ0NvbW1lbnQoc3RyZWFtLCBzdGF0ZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiBbIm9wZXJhdG9yIiwgIm9wZXJhdG9yIl07CiAgICAgICAgfQogICAgICB9LAogICAgICAiQCI6IGZ1bmN0aW9uKHN0cmVhbSkgewogICAgICAgIGlmIChzdHJlYW0uZWF0KCJ7IikpIHJldHVybiBbbnVsbCwgImludGVycG9sYXRpb24iXTsKICAgICAgICBpZiAoc3RyZWFtLm1hdGNoKC9eKGNoYXJzZXR8ZG9jdW1lbnR8Zm9udC1mYWNlfGltcG9ydHwoLShtb3p8bXN8b3x3ZWJraXQpLSk/a2V5ZnJhbWVzfG1lZGlhfG5hbWVzcGFjZXxwYWdlfHN1cHBvcnRzKVxiL2ksIGZhbHNlKSkgcmV0dXJuIGZhbHNlOwogICAgICAgIHN0cmVhbS5lYXRXaGlsZSgvW1x3XFxcLV0vKTsKICAgICAgICBpZiAoc3RyZWFtLm1hdGNoKC9eXHMqOi8sIGZhbHNlKSkKICAgICAgICAgIHJldHVybiBbInZhcmlhYmxlLTIiLCAidmFyaWFibGUtZGVmaW5pdGlvbiJdOwogICAgICAgIHJldHVybiBbInZhcmlhYmxlLTIiLCAidmFyaWFibGUiXTsKICAgICAgfSwKICAgICAgIiYiOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gWyJhdG9tIiwgImF0b20iXTsKICAgICAgfQogICAgfSwKICAgIG5hbWU6ICJjc3MiLAogICAgaGVscGVyVHlwZTogImxlc3MiCiAgfSk7CgogIENvZGVNaXJyb3IuZGVmaW5lTUlNRSgidGV4dC94LWdzcyIsIHsKICAgIGRvY3VtZW50VHlwZXM6IGRvY3VtZW50VHlwZXMsCiAgICBtZWRpYVR5cGVzOiBtZWRpYVR5cGVzLAogICAgbWVkaWFGZWF0dXJlczogbWVkaWFGZWF0dXJlcywKICAgIHByb3BlcnR5S2V5d29yZHM6IHByb3BlcnR5S2V5d29yZHMsCiAgICBub25TdGFuZGFyZFByb3BlcnR5S2V5d29yZHM6IG5vblN0YW5kYXJkUHJvcGVydHlLZXl3b3JkcywKICAgIGZvbnRQcm9wZXJ0aWVzOiBmb250UHJvcGVydGllcywKICAgIGNvdW50ZXJEZXNjcmlwdG9yczogY291bnRlckRlc2NyaXB0b3JzLAogICAgY29sb3JLZXl3b3JkczogY29sb3JLZXl3b3JkcywKICAgIHZhbHVlS2V5d29yZHM6IHZhbHVlS2V5d29yZHMsCiAgICBzdXBwb3J0c0F0Q29tcG9uZW50OiB0cnVlLAogICAgdG9rZW5Ib29rczogewogICAgICAiLyI6IGZ1bmN0aW9uKHN0cmVhbSwgc3RhdGUpIHsKICAgICAgICBpZiAoIXN0cmVhbS5lYXQoIioiKSkgcmV0dXJuIGZhbHNlOwogICAgICAgIHN0YXRlLnRva2VuaXplID0gdG9rZW5DQ29tbWVudDsKICAgICAgICByZXR1cm4gdG9rZW5DQ29tbWVudChzdHJlYW0sIHN0YXRlKTsKICAgICAgfQogICAgfSwKICAgIG5hbWU6ICJjc3MiLAogICAgaGVscGVyVHlwZTogImdzcyIKICB9KTsKCn0pOwo=","codemirror/htmlmixed.js":"Ly8gQ29kZU1pcnJvciwgY29weXJpZ2h0IChjKSBieSBNYXJpam4gSGF2ZXJiZWtlIGFuZCBvdGhlcnMKLy8gRGlzdHJpYnV0ZWQgdW5kZXIgYW4gTUlUIGxpY2Vuc2U6IGh0dHBzOi8vY29kZW1pcnJvci5uZXQvTElDRU5TRQoKKGZ1bmN0aW9uKG1vZCkgewogIGlmICh0eXBlb2YgZXhwb3J0cyA9PSAib2JqZWN0IiAmJiB0eXBlb2YgbW9kdWxlID09ICJvYmplY3QiKSAvLyBDb21tb25KUwogICAgbW9kKHJlcXVpcmUoIi4uLy4uL2xpYi9jb2RlbWlycm9yIiksIHJlcXVpcmUoIi4uL3htbC94bWwiKSwgcmVxdWlyZSgiLi4vamF2YXNjcmlwdC9qYXZhc2NyaXB0IiksIHJlcXVpcmUoIi4uL2Nzcy9jc3MiKSk7CiAgZWxzZSBpZiAodHlwZW9mIGRlZmluZSA9PSAiZnVuY3Rpb24iICYmIGRlZmluZS5hbWQpIC8vIEFNRAogICAgZGVmaW5lKFsiLi4vLi4vbGliL2NvZGVtaXJyb3IiLCAiLi4veG1sL3htbCIsICIuLi9qYXZhc2NyaXB0L2phdmFzY3JpcHQiLCAiLi4vY3NzL2NzcyJdLCBtb2QpOwogIGVsc2UgLy8gUGxhaW4gYnJvd3NlciBlbnYKICAgIG1vZChDb2RlTWlycm9yKTsKfSkoZnVuY3Rpb24oQ29kZU1pcnJvcikgewogICJ1c2Ugc3RyaWN0IjsKCiAgdmFyIGRlZmF1bHRUYWdzID0gewogICAgc2NyaXB0OiBbCiAgICAgIFsibGFuZyIsIC8oamF2YXNjcmlwdHxiYWJlbCkvaSwgImphdmFzY3JpcHQiXSwKICAgICAgWyJ0eXBlIiwgL14oPzp0ZXh0fGFwcGxpY2F0aW9uKVwvKD86eC0pPyg/OmphdmF8ZWNtYSlzY3JpcHQkfF5tb2R1bGUkfF4kL2ksICJqYXZhc2NyaXB0Il0sCiAgICAgIFsidHlwZSIsIC8uLywgInRleHQvcGxhaW4iXSwKICAgICAgW251bGwsIG51bGwsICJqYXZhc2NyaXB0Il0KICAgIF0sCiAgICBzdHlsZTogIFsKICAgICAgWyJsYW5nIiwgL15jc3MkL2ksICJjc3MiXSwKICAgICAgWyJ0eXBlIiwgL14odGV4dFwvKT8oeC0pPyhzdHlsZXNoZWV0fGNzcykkL2ksICJjc3MiXSwKICAgICAgWyJ0eXBlIiwgLy4vLCAidGV4dC9wbGFpbiJdLAogICAgICBbbnVsbCwgbnVsbCwgImNzcyJdCiAgICBdCiAgfTsKCiAgZnVuY3Rpb24gbWF5YmVCYWNrdXAoc3RyZWFtLCBwYXQsIHN0eWxlKSB7CiAgICB2YXIgY3VyID0gc3RyZWFtLmN1cnJlbnQoKSwgY2xvc2UgPSBjdXIuc2VhcmNoKHBhdCk7CiAgICBpZiAoY2xvc2UgPiAtMSkgewogICAgICBzdHJlYW0uYmFja1VwKGN1ci5sZW5ndGggLSBjbG9zZSk7CiAgICB9IGVsc2UgaWYgKGN1ci5tYXRjaCgvPFwvPyQvKSkgewogICAgICBzdHJlYW0uYmFja1VwKGN1ci5sZW5ndGgpOwogICAgICBpZiAoIXN0cmVhbS5tYXRjaChwYXQsIGZhbHNlKSkgc3RyZWFtLm1hdGNoKGN1cik7CiAgICB9CiAgICByZXR1cm4gc3R5bGU7CiAgfQoKICB2YXIgYXR0clJlZ2V4cENhY2hlID0ge307CiAgZnVuY3Rpb24gZ2V0QXR0clJlZ2V4cChhdHRyKSB7CiAgICB2YXIgcmVnZXhwID0gYXR0clJlZ2V4cENhY2hlW2F0dHJdOwogICAgaWYgKHJlZ2V4cCkgcmV0dXJuIHJlZ2V4cDsKICAgIHJldHVybiBhdHRyUmVnZXhwQ2FjaGVbYXR0cl0gPSBuZXcgUmVnRXhwKCJcXHMrIiArIGF0dHIgKyAiXFxzKj1cXHMqKCd8XCIpPyhbXidcIl0rKSgnfFwiKT9cXHMqIik7CiAgfQoKICBmdW5jdGlvbiBnZXRBdHRyVmFsdWUodGV4dCwgYXR0cikgewogICAgdmFyIG1hdGNoID0gdGV4dC5tYXRjaChnZXRBdHRyUmVnZXhwKGF0dHIpKQogICAgcmV0dXJuIG1hdGNoID8gL15ccyooLio/KVxzKiQvLmV4ZWMobWF0Y2hbMl0pWzFdIDogIiIKICB9CgogIGZ1bmN0aW9uIGdldFRhZ1JlZ2V4cCh0YWdOYW1lLCBhbmNob3JlZCkgewogICAgcmV0dXJuIG5ldyBSZWdFeHAoKGFuY2hvcmVkID8gIl4iIDogIiIpICsgIjxcL1xzKiIgKyB0YWdOYW1lICsgIlxzKj4iLCAiaSIpOwogIH0KCiAgZnVuY3Rpb24gYWRkVGFncyhmcm9tLCB0bykgewogICAgZm9yICh2YXIgdGFnIGluIGZyb20pIHsKICAgICAgdmFyIGRlc3QgPSB0b1t0YWddIHx8ICh0b1t0YWddID0gW10pOwogICAgICB2YXIgc291cmNlID0gZnJvbVt0YWddOwogICAgICBmb3IgKHZhciBpID0gc291cmNlLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKQogICAgICAgIGRlc3QudW5zaGlmdChzb3VyY2VbaV0pCiAgICB9CiAgfQoKICBmdW5jdGlvbiBmaW5kTWF0Y2hpbmdNb2RlKHRhZ0luZm8sIHRhZ1RleHQpIHsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGFnSW5mby5sZW5ndGg7IGkrKykgewogICAgICB2YXIgc3BlYyA9IHRhZ0luZm9baV07CiAgICAgIGlmICghc3BlY1swXSB8fCBzcGVjWzFdLnRlc3QoZ2V0QXR0clZhbHVlKHRhZ1RleHQsIHNwZWNbMF0pKSkgcmV0dXJuIHNwZWNbMl07CiAgICB9CiAgfQoKICBDb2RlTWlycm9yLmRlZmluZU1vZGUoImh0bWxtaXhlZCIsIGZ1bmN0aW9uIChjb25maWcsIHBhcnNlckNvbmZpZykgewogICAgdmFyIGh0bWxNb2RlID0gQ29kZU1pcnJvci5nZXRNb2RlKGNvbmZpZywgewogICAgICBuYW1lOiAieG1sIiwKICAgICAgaHRtbE1vZGU6IHRydWUsCiAgICAgIG11bHRpbGluZVRhZ0luZGVudEZhY3RvcjogcGFyc2VyQ29uZmlnLm11bHRpbGluZVRhZ0luZGVudEZhY3RvciwKICAgICAgbXVsdGlsaW5lVGFnSW5kZW50UGFzdFRhZzogcGFyc2VyQ29uZmlnLm11bHRpbGluZVRhZ0luZGVudFBhc3RUYWcKICAgIH0pOwoKICAgIHZhciB0YWdzID0ge307CiAgICB2YXIgY29uZmlnVGFncyA9IHBhcnNlckNvbmZpZyAmJiBwYXJzZXJDb25maWcudGFncywgY29uZmlnU2NyaXB0ID0gcGFyc2VyQ29uZmlnICYmIHBhcnNlckNvbmZpZy5zY3JpcHRUeXBlczsKICAgIGFkZFRhZ3MoZGVmYXVsdFRhZ3MsIHRhZ3MpOwogICAgaWYgKGNvbmZpZ1RhZ3MpIGFkZFRhZ3MoY29uZmlnVGFncywgdGFncyk7CiAgICBpZiAoY29uZmlnU2NyaXB0KSBmb3IgKHZhciBpID0gY29uZmlnU2NyaXB0Lmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKQogICAgICB0YWdzLnNjcmlwdC51bnNoaWZ0KFsidHlwZSIsIGNvbmZpZ1NjcmlwdFtpXS5tYXRjaGVzLCBjb25maWdTY3JpcHRbaV0ubW9kZV0pCgogICAgZnVuY3Rpb24gaHRtbChzdHJlYW0sIHN0YXRlKSB7CiAgICAgIHZhciBzdHlsZSA9IGh0bWxNb2RlLnRva2VuKHN0cmVhbSwgc3RhdGUuaHRtbFN0YXRlKSwgdGFnID0gL1xidGFnXGIvLnRlc3Qoc3R5bGUpLCB0YWdOYW1lCiAgICAgIGlmICh0YWcgJiYgIS9bPD5cc1wvXS8udGVzdChzdHJlYW0uY3VycmVudCgpKSAmJgogICAgICAgICAgKHRhZ05hbWUgPSBzdGF0ZS5odG1sU3RhdGUudGFnTmFtZSAmJiBzdGF0ZS5odG1sU3RhdGUudGFnTmFtZS50b0xvd2VyQ2FzZSgpKSAmJgogICAgICAgICAgdGFncy5oYXNPd25Qcm9wZXJ0eSh0YWdOYW1lKSkgewogICAgICAgIHN0YXRlLmluVGFnID0gdGFnTmFtZSArICIgIgogICAgICB9IGVsc2UgaWYgKHN0YXRlLmluVGFnICYmIHRhZyAmJiAvPiQvLnRlc3Qoc3RyZWFtLmN1cnJlbnQoKSkpIHsKICAgICAgICB2YXIgaW5UYWcgPSAvXihbXFNdKykgKC4qKS8uZXhlYyhzdGF0ZS5pblRhZykKICAgICAgICBzdGF0ZS5pblRhZyA9IG51bGwKICAgICAgICB2YXIgbW9kZVNwZWMgPSBzdHJlYW0uY3VycmVudCgpID09ICI+IiAmJiBmaW5kTWF0Y2hpbmdNb2RlKHRhZ3NbaW5UYWdbMV1dLCBpblRhZ1syXSkKICAgICAgICB2YXIgbW9kZSA9IENvZGVNaXJyb3IuZ2V0TW9kZShjb25maWcsIG1vZGVTcGVjKQogICAgICAgIHZhciBlbmRUYWdBID0gZ2V0VGFnUmVnZXhwKGluVGFnWzFdLCB0cnVlKSwgZW5kVGFnID0gZ2V0VGFnUmVnZXhwKGluVGFnWzFdLCBmYWxzZSk7CiAgICAgICAgc3RhdGUudG9rZW4gPSBmdW5jdGlvbiAoc3RyZWFtLCBzdGF0ZSkgewogICAgICAgICAgaWYgKHN0cmVhbS5tYXRjaChlbmRUYWdBLCBmYWxzZSkpIHsKICAgICAgICAgICAgc3RhdGUudG9rZW4gPSBodG1sOwogICAgICAgICAgICBzdGF0ZS5sb2NhbFN0YXRlID0gc3RhdGUubG9jYWxNb2RlID0gbnVsbDsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbWF5YmVCYWNrdXAoc3RyZWFtLCBlbmRUYWcsIHN0YXRlLmxvY2FsTW9kZS50b2tlbihzdHJlYW0sIHN0YXRlLmxvY2FsU3RhdGUpKTsKICAgICAgICB9OwogICAgICAgIHN0YXRlLmxvY2FsTW9kZSA9IG1vZGU7CiAgICAgICAgc3RhdGUubG9jYWxTdGF0ZSA9IENvZGVNaXJyb3Iuc3RhcnRTdGF0ZShtb2RlLCBodG1sTW9kZS5pbmRlbnQoc3RhdGUuaHRtbFN0YXRlLCAiIiwgIiIpKTsKICAgICAgfSBlbHNlIGlmIChzdGF0ZS5pblRhZykgewogICAgICAgIHN0YXRlLmluVGFnICs9IHN0cmVhbS5jdXJyZW50KCkKICAgICAgICBpZiAoc3RyZWFtLmVvbCgpKSBzdGF0ZS5pblRhZyArPSAiICIKICAgICAgfQogICAgICByZXR1cm4gc3R5bGU7CiAgICB9OwoKICAgIHJldHVybiB7CiAgICAgIHN0YXJ0U3RhdGU6IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgc3RhdGUgPSBDb2RlTWlycm9yLnN0YXJ0U3RhdGUoaHRtbE1vZGUpOwogICAgICAgIHJldHVybiB7dG9rZW46IGh0bWwsIGluVGFnOiBudWxsLCBsb2NhbE1vZGU6IG51bGwsIGxvY2FsU3RhdGU6IG51bGwsIGh0bWxTdGF0ZTogc3RhdGV9OwogICAgICB9LAoKICAgICAgY29weVN0YXRlOiBmdW5jdGlvbiAoc3RhdGUpIHsKICAgICAgICB2YXIgbG9jYWw7CiAgICAgICAgaWYgKHN0YXRlLmxvY2FsU3RhdGUpIHsKICAgICAgICAgIGxvY2FsID0gQ29kZU1pcnJvci5jb3B5U3RhdGUoc3RhdGUubG9jYWxNb2RlLCBzdGF0ZS5sb2NhbFN0YXRlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHt0b2tlbjogc3RhdGUudG9rZW4sIGluVGFnOiBzdGF0ZS5pblRhZywKICAgICAgICAgICAgICAgIGxvY2FsTW9kZTogc3RhdGUubG9jYWxNb2RlLCBsb2NhbFN0YXRlOiBsb2NhbCwKICAgICAgICAgICAgICAgIGh0bWxTdGF0ZTogQ29kZU1pcnJvci5jb3B5U3RhdGUoaHRtbE1vZGUsIHN0YXRlLmh0bWxTdGF0ZSl9OwogICAgICB9LAoKICAgICAgdG9rZW46IGZ1bmN0aW9uIChzdHJlYW0sIHN0YXRlKSB7CiAgICAgICAgcmV0dXJuIHN0YXRlLnRva2VuKHN0cmVhbSwgc3RhdGUpOwogICAgICB9LAoKICAgICAgaW5kZW50OiBmdW5jdGlvbiAoc3RhdGUsIHRleHRBZnRlciwgbGluZSkgewogICAgICAgIGlmICghc3RhdGUubG9jYWxNb2RlIHx8IC9eXHMqPFwvLy50ZXN0KHRleHRBZnRlcikpCiAgICAgICAgICByZXR1cm4gaHRtbE1vZGUuaW5kZW50KHN0YXRlLmh0bWxTdGF0ZSwgdGV4dEFmdGVyLCBsaW5lKTsKICAgICAgICBlbHNlIGlmIChzdGF0ZS5sb2NhbE1vZGUuaW5kZW50KQogICAgICAgICAgcmV0dXJuIHN0YXRlLmxvY2FsTW9kZS5pbmRlbnQoc3RhdGUubG9jYWxTdGF0ZSwgdGV4dEFmdGVyLCBsaW5lKTsKICAgICAgICBlbHNlCiAgICAgICAgICByZXR1cm4gQ29kZU1pcnJvci5QYXNzOwogICAgICB9LAoKICAgICAgaW5uZXJNb2RlOiBmdW5jdGlvbiAoc3RhdGUpIHsKICAgICAgICByZXR1cm4ge3N0YXRlOiBzdGF0ZS5sb2NhbFN0YXRlIHx8IHN0YXRlLmh0bWxTdGF0ZSwgbW9kZTogc3RhdGUubG9jYWxNb2RlIHx8IGh0bWxNb2RlfTsKICAgICAgfQogICAgfTsKICB9LCAieG1sIiwgImphdmFzY3JpcHQiLCAiY3NzIik7CgogIENvZGVNaXJyb3IuZGVmaW5lTUlNRSgidGV4dC9odG1sIiwgImh0bWxtaXhlZCIpOwp9KTsK","codemirror/$$BALE-VERSION$$":"0.1","codemirror/$$VERSION$$":"0.0","codemirror/$$MANDATORY$$":false,"codemirror/$$LOAD_BALE$$":true,"codemirror/$$FILEMANIFEST$$":["codemirror/LICENSE-codemirror.md","codemirror/codemirror.css","codemirror/codemirror.js","codemirror/codemirror-extensions.js","codemirror/markdown.js","codemirror/scheme.js","codemirror/matchbrackets.js","codemirror/javascript.js","codemirror/xml.js","codemirror/css.js","codemirror/htmlmixed.js","codemirror/$$BALE-VERSION$$","codemirror/$$VERSION$$","codemirror/$$MANDATORY$$","codemirror/$$LOAD_BALE$$"]}