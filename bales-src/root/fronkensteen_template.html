<!DOCTYPE html>
<html>
<!-- Fronkensteen Base Template. Copyright 2019-2020 by Anthony W. Hursh. MIT License. -->
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Fronkensteen">
    <link rel="shortcut icon" id="favicon-png" type="image/png" href="data:;base64,iVBORw0KGgo=">
    <title>Fronkensteen</title>
    <style>
     body {background-color: #fffff8}
    .debugfilename{ border-bottom:1px solid grey;}
    .debugfilename:hover{ background-color:black; color:white;}
    </style>
  </head>
  <body>
  <div id="fronkensteen-wrapper">
  </div>
  <div id="fronkensteen-launch-debugger" style="display:none; z-index:50000;position:fixed;top:0;bottom:0;left:0;right:0;background-color:white;padding-left:2em;padding-right:2em;padding-top:1em;">
    <div>
      <button id="fronkensteen-debug-save" onclick="Fronkensteen.saveDebugEditorFile()">Save</button>
      <button id="fronkensteen-debug-continue" onclick="Fronkensteen.continueLaunch()">Continue</button>
      <button id="fronkensteen-debug-retry" onclick="Fronkensteen.saveAndRetryLaunch()">Save and Continue Launch</button>
       <button id="fronkensteen-debug-ignore" onclick="Fronkensteen.ignoreAndContinueLaunch()">Ignore and Continue Launch</button>
    <div id="fronkensteen-debug-error-message"></div>
    <div id="fronkensteen-debug-filename"></div>
    <div>Code:</div>
    <textarea id="fronkensteen-debug-editor" rows="20" style="width:100%;border:1px solid grey;">
    </textarea>
    <div id="fronkensteen-debug-file-list" style="height:20em;max-height:20em;overflow:auto;border:1px solid grey;">
      Debugger files
    </div>
  </div>
  <script type="text/javascript">
  // Bare-bones object.
  // Functions and data fields are added to this object by the various bale extensions.
  let Fronkensteen = {
    CumulativeErrors:[]
  };

  Fronkensteen.bytes_to_base_64 = function(buffer){
    var arr = new Uint8Array(buffer)
    let raw = '';
    for (let i = 0, l = arr.length; i < l; i++) {
      raw += String.fromCharCode(arr[i]);
    }
    return btoa(raw);
  }

</script>
  <script type="text/javascript">
    const urlParams = new URLSearchParams(window.location.search);
  </script>
  <script type="text/javascript">
$$$FILESYSTEM$$$
  </script>
  <script type="text/javascript">


  // Reopen in an app-like "chromeless" window. Not used at present.
  function openAsApp() {
    let appWindowFeatures = "menubar=no,location=no,resizable=yes,scrollbars=yes,status=no,width=" + window.width + ",height=" + window.height;
    let url = window.location.href;
    let appwindow = window.open(url, "Fronkensteen", appWindowFeatures);
    appwindow.focus();
  }

  // Fronkensteen launcher statistics.
  Fronkensteen.balesLoaded = [];
  Fronkensteen.baleErrors = [];
  Fronkensteen.balesSkipped = [];
  Fronkensteen.cssLoaded = [];
  Fronkensteen.cssErrors = [];
  Fronkensteen.jsLoaded = [];
  Fronkensteen.jsErrors = [];
  Fronkensteen.schemeLoaded = [];
  Fronkensteen.schemeErrors = [];
  Fronkensteen.logLaunchStatistics = function(){
    console.log("Bales loaded:\n" + Fronkensteen.balesLoaded.join(", ") + "\n");
    console.log("Bales skipped:\n" + Fronkensteen.balesSkipped.join(", ") + "\n")
    console.log("Bales with errors:\n" + Fronkensteen.baleErrors.join(", ") + "\n")
    console.log("CSS files loaded:\n" + Fronkensteen.cssLoaded.join(", ") + "\n")
    console.log("CSS files with errors:\n" + Fronkensteen.cssErrors.join(", ") + "\n")
    console.log("JS files loaded:\n" + Fronkensteen.jsLoaded.join(", ") + "\n")
    console.log("JS files with errors:\n" + Fronkensteen.jsErrors.join(", ") + "\n")
    console.log("Scheme files loaded:\n" + Fronkensteen.schemeLoaded.join(", ") + "\n")
    console.log("Scheme files with errors:\n" + Fronkensteen.schemeErrors.join(", ") + "\n")
    if(Fronkensteen.systemDirty === true){
      alert("You have made changes to the running system. You will need to save the workspace if you want these changes to take permanent effect.")
    }
    window.removeEventListener('error',Fronkensteen.loadErrorHandler,false);
    Fronkensteen.launchPhase = "done";
  }
  // Launch debugger state variables.
  Fronkensteen.launchPhase = "js";
  Fronkensteen.scheme_index = 0;
  Fronkensteen.bale_index = 0;
  Fronkensteen.file_index = 0;
  Fronkensteen.loadError = false;

  // Enable tabbing in the debugger text area.
  // I like four spaces. If you don't, you know what to do. :-)
  Fronkensteen.tabReplacement = "    ";
  let debug_editor = document.getElementById("fronkensteen-debug-editor");
  debug_editor.onkeydown = function(evt) {
      if (evt.keyCode === 9) {
          var val = this.value,
          start = this.selectionStart,
          end = this.selectionEnd;
          this.value = val.substring(0, start) + Fronkensteen.tabReplacement + val.substring(end);
          this.selectionStart = this.selectionEnd = start + Fronkensteen.tabReplacement.length;
          return false;
      }
  };

Fronkensteen.export_workspace = function(){
    let template = Fronkensteen.decodeText(fronkensteen_fs["root/fronkensteen_template.html"]);
    console.log("Got template.")
    let template_lines = template.split("\n");
    let result = ""
    for(var i = 0; i < template_lines.length; i++){
      let trimmed_line = template_lines[i].trim();
      if(trimmed_line === "$$$FILESYSTEM$$$"){
        console.log("Found filesystem")
        result = result + "let fronkensteen_fs = " + JSON.stringify(fronkensteen_fs) + "\n";
      }
      else{
        result = result + template_lines[i] + "\n";
      }
    }
    console.log("Creating download element")
    let element = document.createElement('a');
    var blob = new Blob([result], {type: "text/html"});
    element.href = window.URL.createObjectURL(blob);
    element.setAttribute('download', "fronkensteen.html");
    element.style.display = 'none';
    element.innerHTML = "Download";
    document.body.appendChild(element)
    element.click();
}

  Fronkensteen.loadErrorHandler = function(message, url, lineNumber) {
    Fronkensteen.loadError = true;
    console.log("Error at url: " + url + " message: " + message + "line number: " + lineNumber);
    let filename = null;
    if(Fronkensteen.currentSourceFile !== null){
       Fronkensteen.errorFileName = Fronkensteen.currentSourceFile;
       filename = Fronkensteen.currentSourceFile;
    }
      Fronkensteen.displayLaunchError(message,filename,lineNumber);
      return true;
    }
  Fronkensteen.displayLaunchError = function(message,filename,lineNumber){
    document.getElementById('fronkensteen-launch-debugger').style.display="block";
    document.getElementById("fronkensteen-debug-error-message").innerHTML = message;
    let filename_element = document.getElementById("fronkensteen-debug-filename")
    let debug_editor = document.getElementById("fronkensteen-debug-editor");
    if(filename !== null){
      Fronkensteen.debugEditorFileName = filename;
      filename_element.innerHTML = "Filename: " + filename
      debug_editor.value = Fronkensteen.decodeText(fronkensteen_fs[filename]);
    }
    else {
      filename_element.innerHTML = "Filename: n/a";
      Fronkensteen.debugEditorFileName = null;
      debug_editor.value = ""
    }
    let filenames = Object.keys(fronkensteen_fs).sort();
    let filelist = "";
    for(var i = 0; i < filenames.length; i++){
      if(filenames[i].match(/\$\$.+\$\$/) === null){ // Don't display special files
        filelist = filelist + "<div class='debugfilename'  onclick='Fronkensteen.displayLaunchError(\"\",\"" + filenames[i] + "\",0)'>" + filenames[i] + "</div>"
      }
    }
    document.getElementById("fronkensteen-debug-file-list").innerHTML = filelist;
    return true;
  };

  Fronkensteen.ignoreAndContinueLaunch = function(){
      console.log("Ignoring error, attempting to continue.");
      Fronkensteen.loadError = false;
      if(Fronkensteen.launchPhase === "js"){
        Fronkensteen.file_index = Fronkensteen.file_index + 1;
      }
      else if(Fronkensteen.launchPhase === "scheme"){
      Fronkensteen.scheme_index = Fronkensteen.scheme_index + 1;
    }
    Fronkensteen.continueLaunch();
  }

  Fronkensteen.continueLaunch = function(){
    Fronkensteen.loadError = false;
    document.getElementById('fronkensteen-launch-debugger').style.display="none";
    if(Fronkensteen.launchPhase === "js"){
      console.log("restarting at bale: " + Fronkensteen.bale_index + " file: " + Fronkensteen.file_index);
      Fronkensteen.launchSystem(Fronkensteen.bale_index,Fronkensteen.file_index);
    }
    else if(Fronkensteen.launchPhase === "scheme"){
      console.log("restarting Scheme queue at index " + Fronkensteen.scheme_index);
      Fronkensteen.execute_scheme_queue(Fronkensteen.scheme_index);
    }
    if(Fronkensteen.loadError === false){
      Fronkensteen.logLaunchStatistics();
    }
}
  Fronkensteen.saveDebugEditorFile = function(){
    if(Fronkensteen.debugEditorFileName !== null){
      console.log("Saving " + Fronkensteen.debugEditorFileName)
      let debug_editor = document.getElementById("fronkensteen-debug-editor");
      let bindata = new TextEncoder("utf-8").encode(debug_editor.value);
      fronkensteen_fs[Fronkensteen.debugEditorFileName] = Fronkensteen.bytes_to_base_64(bindata);
      Fronkensteen.systemDirty = true;
    }
  }
  Fronkensteen.saveAndRetryLaunch = function(){
      console.log("Saving and retrying.");
        Fronkensteen.saveDebugEditorFile();
        Fronkensteen.continueLaunch();
  }
  window.addEventListener('error',Fronkensteen.loadErrorHandler,false);

    // Append a style element containing CSS code from the internal
    // file system to the document head.
  Fronkensteen.addCSS = function(filename,code){
    Fronkensteen.currentSourceFile = filename;
    let style = document.createElement('style');
    style.type = 'text/css';
    style.appendChild(document.createTextNode(Fronkensteen.decodeText(code)));
    document.head.appendChild(style);
    if(Fronkensteen.loadError === false){
      Fronkensteen.cssLoaded.push(filename)
    }
    else{
      Fronkensteen.cssErrors.push(filename)
    }
    Fronkensteen.currentSourceFile = null;
  }

  // Append a script element containing JavaScript code from the internal
  // file system to the document body.
  Fronkensteen.addJS = function(filename,code){
   Fronkensteen.currentSourceFile = filename;
   let script = document.createElement('script');
    script.type = 'text/javascript';
    let jsCode = Fronkensteen.decodeText(code);
    script.appendChild(document.createTextNode(jsCode));
    document.body.appendChild(script);
    if(Fronkensteen.loadError === false){
      Fronkensteen.jsLoaded.push(filename)
    }
    else{
      Fronkensteen.jsErrors.push(filename)
    }
    Fronkensteen.currentSourceFile = null;
  }

  // Process a bale from the internal file system.
  Fronkensteen.execute_bale = function(file_manifest,start_index){
    Fronkensteen.loadError = false;
    for(var j = start_index; j < file_manifest.length; j++){
      let filename = file_manifest[j];
      if(filename.match(/\.scm$/) !== null){
        Fronkensteen.scheme_launcher.push(filename);
      }
      if(filename.match(/\.css$/) !== null){
        Fronkensteen.cssLoaded.push(filename);
        Fronkensteen.addCSS(filename,fronkensteen_fs[filename]);
      }
      if(filename.match(/\.js$/) !== null){
        Fronkensteen.jsLoaded.push(filename);
        Fronkensteen.addJS(filename,fronkensteen_fs[filename]);
      }
      if(Fronkensteen.loadError === true){
        return;
      }
      Fronkensteen.file_index = Fronkensteen.file_index + 1;
    }
    Fronkensteen.file_index = 0;
  }

  Fronkensteen.execute_scheme_queue = function(start_index){
    Fronkensteen.loadError = false;
    for(var i = start_index; i < Fronkensteen.scheme_launcher.length; i++){
      if(Fronkensteen.loadError === true){
        return;
      }
      Fronkensteen.currentSourceFile = Fronkensteen.scheme_launcher[i];
      Fronkensteen.scheme_index = i;
      var intp2 = new BiwaScheme.Interpreter(Fronkensteen.scheme_intepreter);
      intp2.evaluate("(load \"" + Fronkensteen.scheme_launcher[i] + "\")");
      if(Fronkensteen.loadError === false){
        Fronkensteen.schemeLoaded.push(Fronkensteen.scheme_launcher[i])
      }
      else{
        Fronkensteen.schemeErrors.push(Fronkensteen.scheme_launcher[i])
      }
      Fronkensteen.currentSourceFile = null;
    }
    var intp2 = new BiwaScheme.Interpreter(Fronkensteen.scheme_intepreter);
    intp2.evaluate("(rebuild-documentation)");
    console.log(Fronkensteen.CumulativeErrors.join("\n"));
    Fronkensteen.CumulativeErrors = [];

  }
  Fronkensteen.decodeText = function(code){
    var byteCharacters = atob(code);
    var array = new Uint8Array(byteCharacters.length);
    for( var i = 0; i < byteCharacters.length; i++ ) { array[i] = byteCharacters.charCodeAt(i);
    }
    return new TextDecoder("utf-8").decode(array);
  }
  Fronkensteen.scheme_launcher = [];
  Fronkensteen.scheme_intepreter = null;

  Fronkensteen.promptForHomeScreenInstall = function(){
    // Functionality for later.
    //alert("Add to Home Screen.")
  }

  // System launcher.
  // Boot up the app from the internal filesystem stored in the fronkensteen_fs object.
  Fronkensteen.launchSystem = function(start_bale_index,start_file_index){
    Fronkensteen.loadError = false;
    Fronkensteen.launchPhase = "js";
    document.getElementById("fronkensteen-wrapper").innerHTML = ""
    let bale_manifest = fronkensteen_fs["$$BALEMANIFEST$$"];
    for(var i = start_bale_index; i < bale_manifest.length; i++){
      if(Fronkensteen.loadError === true){
        return;
      }
      Fronkensteen.bale_index = i;
      if(fronkensteen_fs[bale_manifest[i] + "/" + "$$LOAD_BALE$$"] === true){
        let file_manifest_name = bale_manifest[i] + "/" + "$CODE_LOADER"
        let file_manifest = Fronkensteen.decodeText(fronkensteen_fs[file_manifest_name]).split("\n");
        if(i === start_bale_index){
            Fronkensteen.execute_bale(file_manifest,start_file_index);
        }
        else{
          Fronkensteen.execute_bale(file_manifest,0);
        }
        if(Fronkensteen.loadError === false){
          Fronkensteen.balesLoaded.push(bale_manifest[i])
        }
        else{
          Fronkensteen.baleErrors.push(bale_manifest[i])
        }
      }
      else {
        Fronkensteen.balesSkipped.push(bale_manifest[i]);
      }
    }
    if(Fronkensteen.loadError === true){
      return;
    }
    Fronkensteen.scheme_intepreter = new BiwaScheme.Interpreter(Fronkensteen.onBiwaSchemeError)
    var intp2 = new BiwaScheme.Interpreter(Fronkensteen.scheme_intepreter);
    intp2.evaluate("(define baseload load)");
    intp2 = new BiwaScheme.Interpreter(Fronkensteen.scheme_intepreter);
    intp2.evaluate("(define load hereload)");
    Fronkensteen.launchPhase = "scheme";
    Fronkensteen.execute_scheme_queue(0);
    const remote = urlParams.get('remote');
    if(remote !== null){
      if(Fronkensteen.remoteREPL !== undefined){
        Fronkensteen.remoteREPL.connect(true,null);
      }
    }

    if(Fronkensteen.loadError === false){
      Fronkensteen.logLaunchStatistics();
    }
  }

  const debug = urlParams.get('debug');
  if(debug !== null){
    console.log("displaying debugger");
    Fronkensteen.displayLaunchError("Debugger ready.",null,0)
  }
  else{
    Fronkensteen.launchSystem(0,0);
  }
//if((window.navigator.standalone !== undefined) && (window.navigator.standalone === false)){
  // iOS, not already installed to home screen.
//  Fronkensteen.promptForHomeScreenInstall(); // Add this later. Also pwa code for Android, etc.
  //Fronkensteen.launchSystem(0,0)
//}

//Fronkensteen.launchSystem(0,0);

 </script>
</body>
</html>
